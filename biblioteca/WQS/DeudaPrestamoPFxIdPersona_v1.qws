<?xml version="1.0" encoding="ISO-8859-1" standalone="yes"?>
<serviceQuery>
    <uri>vinculacion/deudaAltaTC/{IdPersona}</uri>
    <serviceDescription>Deuda Prestamos de PF por ID</serviceDescription>
    <querys>
        <query id="1" name="Prestamos" type="MULTIPLE">
            <sql>SELECT ABS(S.C1604) AS SaldoCapital,
              P.C2309 + P.C2310 AS importe,
              S.JTS_OID,
              SUC.NOMBRESUCURSAL ,
              S.CUENTA,
              S.MONEDA,
              MON.C6400 AS NomMon, 
              SUC.SUCURSAL,
              S.PRODUCTO,
              C6251 AS NomProd,
              S.OPERACION,
              S.ORDINAL
FROM SALDOS S WITH (NOLOCK) 
JOIN VW_CLIENTES_PERSONAS CP WITH (NOLOCK) ON S.C1803 = CP.CODIGOCLIENTE
JOIN SUCURSALES SUC WITH (NOLOCK) ON S.SUCURSAL = SUC.SUCURSAL
JOIN PRODUCTOS PR ON PR.C6250 = S.Producto
JOIN MONEDAS MON ON MON.C6399 = S.MONEDA
JOIN PlanPagos P ON P.C2300 = S.C1645 + 1 AND P.saldo_jts_oid = S.JTS_OID
WHERE S.C1785 = 5 AND S.C1645 &lt; (S.C1644 - 1) AND CP.TITULARIDAD='T' AND CP.NUMEROPERSONA = ?;</sql>
            <input>
                <inParameter description="IdPersona" type="LONG">IdPersona</inParameter>
            </input>
            <output>
                <level groupby="" name="creditos">
                    <outParameter description="" type="STRING">
                        <queryname>NOMBRESUCURSAL</queryname>
                        <servicename>prestamo.sucursal.descripcion</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>SUCURSAL</queryname>
                        <servicename>prestamo.sucursal.id</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>PRODUCTO</queryname>
                        <servicename>prestamo.producto.id</servicename>
                    </outParameter>
                    <outParameter description="" type="STRING">
                        <queryname>NomProd</queryname>
                        <servicename>prestamo.producto.descripcion</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>CUENTA</queryname>
                        <servicename>prestamo.cuenta</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>MONEDA</queryname>
                        <servicename>prestamo.moneda.id</servicename>
                    </outParameter>
                    <outParameter description="" type="STRING">
                        <queryname>NomMon</queryname>
                        <servicename>prestamo.moneda.descripcion</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>OPERACION</queryname>
                        <servicename>prestamo.operacion</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>ORDINAL</queryname>
                        <servicename>prestamo.ordinal</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>importe</queryname>
                        <servicename>prestamo.importe</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>SaldoCapital</queryname>
                        <servicename>prestamo.saldoCapital</servicename>
                    </outParameter>
                </level>
            </output>
        </query>
        <query id="2" name="estado" type="SIMPLE">
            <sql>IF((SELECT count(*) FROM VW_CLIENTES_PERSONAS CLI WHERE  CLI.NUMEROPERSONA = ? AND CLI.TITULARIDAD = 'T')&gt;0)
BEGIN
SELECT	CASE WHEN (select count(*) from saldos where C1785=5 and 
			tz_lock= 0 and C8748='S' and C1604&lt;0 and c1803 IN (SELECT CODIGOCLIENTE FROM VW_CLIENTES_PERSONAS WHERE  NUMEROPERSONA = ? AND TITULARIDAD = 'T')) &gt; 0 THEN 2
		ELSE
			CASE WHEN (SELECT count(*) FROM SALDOS S WITH (NOLOCK) 
				JOIN VW_CLIENTES_PERSONAS CP WITH (NOLOCK) ON S.C1803 = CP.CODIGOCLIENTE
				WHERE S.C1785 = 5 AND S.C1645 &lt; (S.C1644 - 1) AND CP.NUMEROPERSONA = ? ) &gt; 0 THEN 3
			ELSE 
				CASE WHEN (SELECT count(*) FROM VW_CLIENTES_PERSONAS CLI
						   JOIN SALDOS S ON CLI.CODIGOCLIENTE = S.C1803
						   WHERE S.C1604 &lt;&gt; 0 AND S.C1785 = 5 AND CLI.TITULARIDAD = 'T' And CLI.NUMEROPERSONA = ?) = 0 THEN 1 END END END AS NroTabla,
			
			CASE WHEN (select count(*) from saldos where C1785=5 and 
			tz_lock= 0 and C8748='S' and C1604&lt;0 and c1803 IN (SELECT CODIGOCLIENTE FROM VW_CLIENTES_PERSONAS WHERE  NUMEROPERSONA = ? AND TITULARIDAD = 'T')) &gt; 0 THEN 'Cliente con refinanciación'
			ELSE	
				CASE WHEN (SELECT count(*) FROM SALDOS S WITH (NOLOCK) 
				JOIN VW_CLIENTES_PERSONAS CP WITH (NOLOCK) ON S.C1803 = CP.CODIGOCLIENTE
				WHERE S.C1785 = 5 AND S.C1645 &lt; (S.C1644 - 1) AND CP.NUMEROPERSONA = ?  AND CP.TITULARIDAD = 'T') &gt; 0 THEN 'Cliente con asistencia crediticia'
				ELSE 
					CASE WHEN (SELECT count(*) FROM VW_CLIENTES_PERSONAS CLI
							   JOIN SALDOS S ON CLI.CODIGOCLIENTE = S.C1803
							   WHERE S.C1604 &lt;&gt; 0 AND S.C1785 = 5 AND CLI.TITULARIDAD = 'T' And CLI.NUMEROPERSONA = ?) = 0 THEN 'Cliente sin asistencia crediticia' END END END AS DescTabla
END
ELSE
BEGIN
--esta query no tiene que devolver nada pero si las cabeceras 
SELECT 0 AS 'NroTabla', '' AS 'DescTabla' WHERE 1=2
END 

</sql>
            <input>
                <inParameter description="" type="LONG">IdPersona</inParameter>
                <inParameter description="" type="LONG">IdPersona</inParameter>
                <inParameter description="" type="LONG">IdPersona</inParameter>
                <inParameter description="" type="LONG">IdPersona</inParameter>
                <inParameter description="" type="LONG">IdPersona</inParameter>
                <inParameter description="" type="LONG">IdPersona</inParameter>
                <inParameter description="" type="LONG">IdPersona</inParameter>
            </input>
            <output>
                <level groupby="" name="estado">
                    <outParameter description="" type="INTEGER">
                        <queryname>NroTabla</queryname>
                        <servicename>estado.codigo</servicename>
                    </outParameter>
                    <outParameter description="" type="STRING">
                        <queryname>DescTabla</queryname>
                        <servicename>estado.descripcion</servicename>
                    </outParameter>
                </level>
            </output>
        </query>
    </querys>
</serviceQuery>
