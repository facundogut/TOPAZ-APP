<?xml version="1.0" encoding="ISO-8859-1" standalone="yes"?>
<serviceQuery>
    <uri>/productos/pagosTC/{fecha}/{pagina}/{largoPagina}</uri>
    <serviceDescription>AD_NOVCOBROS</serviceDescription>
    <title>AD_NOVCOBROS</title>
    <querys>
        <query id="1" name="PagosAdintar" type="MULTIPLE">
            <sql>
                DECLARE
                    -- PARAMETROS
                    @fecha_param VARCHAR(20) = SUBSTRING(?, 1, 20), 
                    @pagina INT = ?, 
                    @largo_pagina INT = ?,
                    -- VARIABLES
                    @total_registros INT = 0, 
                    @resto INT = 0, 
                    @primer_registro_pag INT = 0, 
                    @ultimo_registro_pag INT = 0,
                    @offset INT = 0
                ;
                DECLARE
                -- PARAMETROS PARSEADOS
                    @fecha DATE = TRY_CONVERT(DATE, @fecha_param, 112);
                
                
                IF ( LEN(@fecha_param) != 8 OR ISNUMERIC(@fecha_param) = 0 )
                BEGIN
                    THROW 50000, 'Fecha recibida no numerica', 1;
                END
                
                IF ( @pagina &lt; 1 )
                BEGIN
                    THROW 50001, 'Pagina negativa o 0', 1;
                END
                
                IF ( @largo_pagina &lt; 1 )
                BEGIN
                    THROW 50002, 'Largo de pagina negativo o 0', 1;
                END
                
                SET @offset = (@pagina - 1) * @largo_pagina;
                
                BEGIN
                    SET @total_registros = ( 
                        SELECT COUNT(*)
                        FROM TJC_HISTORICO_PAGOS P
                        INNER JOIN TJC_MAESTRO_USUARIO U ON U.USUARIO = P.USUARIO AND U.ADMINISTRADORA = P.ADMINISTRADORA AND U.TZ_LOCK = 0 
                        INNER JOIN TJC_MAESTRO_ADMINISTRADORAS AD (NOLOCK) ON AD.COD_ADMINISTRADORA = P.ADMINISTRADORA AND AD.TZ_LOCK = 0
                        INNER JOIN USUARIOS usu (NOLOCK) ON usu.INICIALES = P.USUARIO_MOD
                        WHERE 
                            P.FECHA = @fecha AND
                            P.TZ_LOCK = 0
                    );
                    
                    SET @resto = @total_registros - @largo_pagina * (@pagina);
                    SET @primer_registro_pag = 1 + @largo_pagina * (@pagina - 1);
                    SET @ultimo_registro_pag = @largo_pagina + @largo_pagina * (@pagina - 1);
                    
                    IF (@resto &lt; 0)
                    BEGIN
                        SET @resto = 0;
                    END
                    
                    IF (@ultimo_registro_pag &gt;@total_registros )
                    BEGIN
                        SET @ultimo_registro_pag = @total_registros;
                    END 
                    
                    
                    -- SI NO HAY DATOS PARA MOSTRAR
                    IF( @pagina &gt; (SELECT dbo.ITFcantPaginas (@total_registros, @largo_pagina)) OR @total_registros = 0 )
                    BEGIN
                        SELECT 
                        @total_registros AS "paginado.totalRegistros", 
                        @pagina AS "paginado.paginaActual",
                        @primer_registro_pag AS "paginado.primerRegistroPag", 
                        @largo_pagina AS "paginado.registroPorPag", 
                        @ultimo_registro_pag AS "paginado.ultimoRegistroPag", 
                        @resto AS "paginado.siguientesRegistros",
                        (SELECT dbo.ITFcantPaginas (@total_registros, @largo_pagina)) AS "paginado.cantidadPaginas",
                        NULL AS "sucursal", 
                        NULL AS "sucursalCuenta", 
                        NULL AS "cuenta.numeroSocio", 
                        NULL AS "cuenta.administradora.codigo", 
                        NULL AS "cuenta.administradora.marca", 
                        NULL AS "importe", 
                        NULL AS "fechaAlta", 
                        NULL AS "moneda.id", 
                        NULL AS "moneda.descripcion",
                        NULL AS "auditoria.numeroAsiento", 
                        NULL AS "auditoria.usuario",
                        NULL AS "auditoria.sucursal", 
                        NULL AS "origen.codigo",
                        NULL AS "origen.descripcion"
                    END
                    ELSE
                    BEGIN
                        SELECT 
                            @total_registros AS "paginado.totalRegistros", 
                            @pagina AS "paginado.paginaActual",
                            @primer_registro_pag AS "paginado.primerRegistroPag", 
                            @largo_pagina AS "paginado.registroPorPag", 
                            @ultimo_registro_pag AS "paginado.ultimoRegistroPag",
                            @resto AS "paginado.siguientesRegistros",
                            (SELECT dbo.ITFcantPaginas (@total_registros, @largo_pagina)) AS "paginado.cantidadPaginas",
                            u.SUC_USUARIO AS "sucursal", 
                            u.SUC_CUENTA_COBRO AS "sucursalCuenta", 
                            u.USUARIO AS "cuenta.numeroSocio", 
                            a.DESCRIPCION AS "cuenta.administradora.marca", 
                            a.COD_ADMINISTRADORA AS "cuenta.administradora.codigo",
                            CASE 
                                WHEN h.PAGO_MN &gt; 0 THEN h.PAGO_MN 
                                ELSE h.PAGO_ME
                            END AS "importe",
                            h.FECHA AS "fechaAlta",
                            CASE 
                                WHEN h.PAGO_MN &gt;0 THEN 1
                                WHEN h.PAGO_ME &gt;0 THEN 2
                                ELSE 0
                            END AS "moneda.id",
                            CASE
                                WHEN h.PAGO_MN &gt; 0 THEN 'PESO'
                                WHEN h.PAGO_ME &gt;0 THEN 'DÃ“LAR ESTADOUNIDENSE'
                                ELSE ''
                            END AS "moneda.descripcion", 
                            h.ASIENTO AS "auditoria.numeroAsiento",
                            usu.INICIALES AS "auditoria.usuario",
                            usu.NROSUCURSAL AS "auditoria.sucursal",
                            h.CANAL AS "origen.codigo",
                            CASE
                                WHEN h.CANAL = 1 THEN 'Cobranza por Caja'
                                WHEN h.CANAL = 2 THEN 'Cobranza por Debito Automatico'
                                WHEN h.CANAL = 4 THEN 'Cobranza por Rapipago'
                                WHEN h.CANAL = 5 THEN 'Cobranza por PagoFacil'
                                WHEN h.CANAL IS NULL THEN NULL
                                ELSE 'Origen Desconocido'
                            END AS "origen.descripcion"
                        FROM TJC_HISTORICO_PAGOS h
                        INNER JOIN TJC_MAESTRO_USUARIO U ON U.USUARIO = h.USUARIO AND U.ADMINISTRADORA = h.ADMINISTRADORA AND U.TZ_LOCK = 0
                        INNER JOIN TJC_MAESTRO_ADMINISTRADORAS a (NOLOCK) ON a.COD_ADMINISTRADORA = h.ADMINISTRADORA AND A.TZ_LOCK = 0
                        INNER JOIN USUARIOS usu (NOLOCK) ON usu.INICIALES = h.USUARIO_MOD 
                        WHERE 
                        h.FECHA = @fecha AND 
                        h.TZ_LOCK = 0
                        ORDER BY "cuenta.numeroSocio" ASC
                        OFFSET (@pagina - 1) * @largo_pagina ROWS
                        FETCH NEXT @largo_pagina ROWS ONLY;
                    END
                END
                
                
            </sql>
            <input>
                <inParameter description="" type="STRING">fecha</inParameter>
                <inParameter description="" type="INTEGER">pagina</inParameter>
                <inParameter description="" type="INTEGER">largoPagina</inParameter>
            </input>
            <output>
                <level groupby="paginado.paginaActual" name="paginado">
                    <outParameter description="" type="LONG">
                        <queryname>paginado.totalRegistros</queryname>
                        <servicename>paginado.totalRegistros</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>paginado.paginaActual</queryname>
                        <servicename>paginado.paginaActual</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>paginado.primerRegistroPag</queryname>
                        <servicename>paginado.primerRegistroPag</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>paginado.registroPorPag</queryname>
                        <servicename>paginado.registroPorPag</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>paginado.ultimoRegistroPag</queryname>
                        <servicename>paginado.ultimoRegistroPag</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>paginado.siguientesRegistros</queryname>
                        <servicename>paginado.siguientesRegistros</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>paginado.cantidadPaginas</queryname>
                        <servicename>paginado.cantidadPaginas</servicename>
                    </outParameter>
                </level>
                <level groupby="" name="pagos">
                    <outParameter description="" type="INTEGER">
                        <queryname>sucursal</queryname>
                        <servicename>sucursal</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>sucursalCuenta</queryname>
                        <servicename>sucursalCuenta</servicename>
                    </outParameter>
                    <outParameter description="" type="LONG">
                        <queryname>cuenta.numeroSocio</queryname>
                        <servicename>cuenta.numeroSocio</servicename>
                    </outParameter>
                    <outParameter description="" type="STRING">
                        <queryname>cuenta.administradora.marca</queryname>
                        <servicename>cuenta.administradora.marca</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>cuenta.administradora.codigo</queryname>
                        <servicename>cuenta.administradora.codigo</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>importe</queryname>
                        <servicename>importe</servicename>
                    </outParameter>
                    <outParameter description="" type="STRING">
                        <queryname>fechaAlta</queryname>
                        <servicename>fechaAlta</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>moneda.id</queryname>
                        <servicename>moneda.id</servicename>
                    </outParameter>
                    <outParameter description="" type="STRING">
                        <queryname>moneda.descripcion</queryname>
                        <servicename>moneda.descripcion</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>auditoria.numeroAsiento</queryname>
                        <servicename>auditoria.numeroAsiento</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>auditoria.sucursal</queryname>
                        <servicename>auditoria.sucursal</servicename>
                    </outParameter>
                    <outParameter description="" type="STRING">
                        <queryname>auditoria.usuario</queryname>
                        <servicename>auditoria.usuario</servicename>
                    </outParameter>
                    <outParameter description="" type="INTEGER">
                        <queryname>origen.codigo</queryname>
                        <servicename>origen.codigo</servicename>
                    </outParameter>
                    <outParameter description="" type="STRING">
                        <queryname>origen.descripcion</queryname>
                        <servicename>origen.descripcion</servicename>
                    </outParameter>
                </level>
            </output>
        </query>
    </querys>
</serviceQuery>