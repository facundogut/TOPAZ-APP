<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<serviceQuery>
    <uri>/sibe/graduacionyfraccionamiento/{cuit}/{monto}</uri>
    <serviceDescription> Proceso de analisis de graduacion y fraccionamiento</serviceDescription>
    <title>SIBE013AnalisisGraduacionFraccionamiento</title>
    <querys>
        <query id="1" name="Analisis" type="SIMPLE">
            <sql>&#13;
&#13;
DECLARE&#13;
	@_cuit VARCHAR(11) = ?,&#13;
	@_monto NUMERIC(15, 2) = CONVERT(NUMERIC(15,2), ?),&#13;
	@_cliente NUMERIC(12),&#13;
	@_nroPersona NUMERIC(12),&#13;
	@_graduacion VARCHAR(1) = 'N',&#13;
	@_con_gtia VARCHAR(1) = 'N',&#13;
	@fechaproceso DATETIME = (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)),&#13;
	@sucursal NUMERIC(5) = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO = 21);&#13;
   &#13;
SET @_cliente = 0;&#13;
SET @_nroPersona = 0;  &#13;
	&#13;
SELECT TOP 1&#13;
	@_cliente = cliper.CODIGOCLIENTE,&#13;
	@_nroPersona = cliper.numeropersona&#13;
FROM CLI_DocumentosPFPJ doc&#13;
	JOIN CLI_ClientePersona cliper ON doc.numeropersonafj = cliper.numeropersona	&#13;
WHERE &#13;
	doc.NUMERODOCUMENTO =  @_cuit&#13;
	&#13;
	  	&#13;
--retorno sp&#13;
DECLARE @TOTAL_DEUDA NUMERIC (20, 2)&#13;
DECLARE @TRAMO_SIN_G NUMERIC (20, 2)&#13;
DECLARE @TRAMO_CON_G NUMERIC (20, 2)&#13;
DECLARE @TRAMO_SIN_G_B NUMERIC (20, 2)&#13;
DECLARE @TRAMO_CON_G_B NUMERIC (20, 2)&#13;
DECLARE @RPC_BANCO NUMERIC (20, 2)&#13;
DECLARE @EXCLUSIONES NUMERIC (20, 2)&#13;
DECLARE @TOT_CONTROL_GRAD NUMERIC (20, 2)&#13;
DECLARE @RPC_CLIENTE NUMERIC (20, 2)&#13;
DECLARE @RPC_CLIENTE_MAX NUMERIC (20, 2)&#13;
DECLARE @RPC_NETO_BANCO NUMERIC (20, 2)&#13;
DECLARE @MARGEN_RESGUAR NUMERIC (20, 2)&#13;
DECLARE @LIMITE_GRAD NUMERIC (20, 2)&#13;
DECLARE @RESULTADO_GRADUACION VARCHAR (200)&#13;
DECLARE @RESULTADO_FRACCIONAMIENTO VARCHAR (200)&#13;
DECLARE @IMPORTE_SING_GRUPO NUMERIC (20, 2)&#13;
DECLARE @IMPORTE_CONG_GRUPO NUMERIC (20, 2)&#13;
DECLARE @PERIODO VARCHAR (10)&#13;
DECLARE @CN1_BANCO NUMERIC (20, 2)&#13;
DECLARE @MARGEN_BASICO NUMERIC (5, 2)&#13;
DECLARE @RPC_CLIENTE_O NUMERIC (5, 2)&#13;
DECLARE @RPC_BANCO_O NUMERIC (5, 2)&#13;
DECLARE @RPC_CLIENTE_SGR_FGP NUMERIC (5, 2)&#13;
DECLARE @RPC_BANCO_SGR_FGP NUMERIC (5, 2)&#13;
DECLARE @PORC_TRAMO_SING NUMERIC (5, 2)&#13;
DECLARE @PORC_TRAMO_CONG NUMERIC (5, 2)&#13;
DECLARE @MARGEN_RESGUARDO NUMERIC (5, 2)&#13;
DECLARE @RPC_BANCO_IMP NUMERIC (15, 2)&#13;
DECLARE @VINCULO VARCHAR (80)&#13;
DECLARE @DESCRIPCION_GRUPO VARCHAR (60)&#13;
DECLARE @MENSAJE_VINCULADOS VARCHAR (200)&#13;
DECLARE @EXCEDE_GRADUACION_O VARCHAR(1)&#13;
DECLARE @EXCEDE_FRACCIONAMIENTO_O VARCHAR(1)&#13;
DECLARE @TIPO_LIMITE_O VARCHAR(30)&#13;
DECLARE @IMPORTE_LIMITEVINC_O NUMERIC(15,2)&#13;
	&#13;
	&#13;
IF (@_cliente &lt;&gt; 0 and @_nroPersona &lt;&gt; 0 and @_monto &lt;&gt; 0)&#13;
&#13;
BEGIN&#13;
EXECUTE dbo.SP_CALCULA_GRADUACION @_cliente, @_nroPersona, @_monto, @_graduacion, @_con_gtia, @TOTAL_DEUDA OUT, @TRAMO_SIN_G OUT, @TRAMO_CON_G OUT, @TRAMO_SIN_G_B OUT, @TRAMO_CON_G_B OUT, @RPC_BANCO OUT, @EXCLUSIONES OUT, @TOT_CONTROL_GRAD OUT, @RPC_CLIENTE OUT, @RPC_CLIENTE_MAX OUT, @RPC_NETO_BANCO OUT, @MARGEN_RESGUAR OUT, @LIMITE_GRAD OUT, @RESULTADO_GRADUACION OUT, @RESULTADO_FRACCIONAMIENTO OUT, @IMPORTE_SING_GRUPO OUT, @IMPORTE_CONG_GRUPO OUT, @PERIODO OUT, @CN1_BANCO OUT, @MARGEN_BASICO OUT, @RPC_CLIENTE_O OUT, @RPC_BANCO_O OUT, @RPC_CLIENTE_SGR_FGP OUT, @RPC_BANCO_SGR_FGP OUT, @PORC_TRAMO_SING OUT, @PORC_TRAMO_CONG OUT, @MARGEN_RESGUARDO OUT, @RPC_BANCO_IMP OUT, @VINCULO OUT, @DESCRIPCION_GRUPO OUT, @MENSAJE_VINCULADOS OUT, @EXCEDE_GRADUACION_O OUT, @EXCEDE_FRACCIONAMIENTO_O OUT, @TIPO_LIMITE_O OUT, @IMPORTE_LIMITEVINC_O OUT&#13;
	 &#13;
	&#13;
		--- Registra en tabla bitacora&#13;
INSERT INTO dbo.CRE_GRAD_FRACC_BITACORA (TZ_LOCK, CODIGOCLIENTE, ASIENTO, FECHAPROCESO, SUCURSAL, TIPO, &#13;
CN1_BANCO, PORC_TRAMO_SIN_G, TRAMO_SIN_GARANTIA, PORC_TRAMO_CON_G, TRAMO_CON_GARANTIA, &#13;
DEUDA_SIN_GARANTIA, DEUDA_CON_GARANTIA, DEUDA_CON_GARANTIA_GRUPO, DEUDA_SIN_GARANTIA_GRUPO, &#13;
RPC_BANCO, EXCLUSIONES, RPC_CLIENTE, PORCENTAJE_RPC_CLIENTE, MAXIMO_RPC_CLIENTE, PORC_RPC_NETA_BANCO, &#13;
RPC_NETA_BANCO, PORC_MARGE_RES, MARGEN_REGUARDO, LIMITE_GRADUACION, IMPORTE_SOLICITADO, EXCLUIDO, &#13;
CON_GTIA, DEUDA_TOTAL, PERIODO, RESULTADO_GRAD, RESULTADO_FRACC)&#13;
VALUES (0, @_cliente, 0, @fechaproceso, @sucursal, 'B', @CN1_BANCO, &#13;
@PORC_TRAMO_SING, @TRAMO_SIN_G_B, @PORC_TRAMO_CONG, @TRAMO_CON_G_B, @TRAMO_SIN_G, &#13;
@TRAMO_CON_G, @IMPORTE_CONG_GRUPO, @IMPORTE_SING_GRUPO, @RPC_BANCO, @EXCLUSIONES, &#13;
@RPC_CLIENTE, @RPC_CLIENTE_O, @RPC_CLIENTE_MAX, @RPC_BANCO_O, @RPC_NETO_BANCO, &#13;
@MARGEN_RESGUARDO, @MARGEN_RESGUAR, @LIMITE_GRAD, @_monto, @_graduacion, @_con_gtia, &#13;
@TOTAL_DEUDA, @PERIODO, @RESULTADO_GRADUACION, @RESULTADO_FRACCIONAMIENTO)	&#13;
&#13;
END&#13;
&#13;
SELECT&#13;
 	 'ok' respuesta,&#13;
     bita.DEUDA_TOTAL deudaTotal,&#13;
     bita.IMPORTE_SOLICITADO totalGraduacion,&#13;
     bita.RPC_CLIENTE rpcCliente,&#13;
     bita.RPC_NETA_BANCO rpc200,&#13;
     bita.RPC_BANCO rpc25NBCH, &#13;
     bita.LIMITE_GRADUACION limiteGraduacion,&#13;
     bita.PORC_TRAMO_SIN_G porcSobreRpcSinGara,&#13;
     bita.PORC_TRAMO_CON_G porcSobreRpcConGara,&#13;
     bita.TRAMO_SIN_GARANTIA topeSinGara,&#13;
     bita.TRAMO_CON_GARANTIA topeConGara,&#13;
     bita.DEUDA_SIN_GARANTIA totalDeudaSinGara,&#13;
     bita.DEUDA_CON_GARANTIA totalDeudaConGara &#13;
     &#13;
     &#13;
     &#13;
FROM CRE_GRAD_FRACC_BITACORA bita &#13;
WHERE &#13;
	bita.CODIGOCLIENTE =  @_cliente 	&#13;
	AND bita.ASIENTO = 0 &#13;
	AND bita.FECHAPROCESO = @fechaproceso&#13;
	AND bita.SUCURSAL = @sucursal&#13;
</sql>
            <input>
                <inParameter description="" type="LONG">cuit</inParameter>
                <inParameter description="" type="STRING">monto</inParameter>
            </input>
            <output>
                <level groupby="" name="retorno">
                    <outParameter description="" type="STRING">
                        <queryname>respuesta</queryname>
                        <servicename>respuesta</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>deudaTotal</queryname>
                        <servicename>deudaTotal</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>totalGraduacion</queryname>
                        <servicename>totalGraduacion</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>rpcCliente</queryname>
                        <servicename>rpcCliente</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>rpc200</queryname>
                        <servicename>rpc200</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>rpc25NBCH</queryname>
                        <servicename>rpc25NBCH</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>limiteGraduacion</queryname>
                        <servicename>limiteGraduacion</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>porcSobreRpcSinGara</queryname>
                        <servicename>porcSobreRpcSinGara</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>porcSobreRpcConGara</queryname>
                        <servicename>porcSobreRpcConGara</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>topeSinGara</queryname>
                        <servicename>topeSinGara</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>topeConGara</queryname>
                        <servicename>topeConGara</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>totalDeudaSinGara</queryname>
                        <servicename>totalDeudaSinGara</servicename>
                    </outParameter>
                    <outParameter description="" type="BIGDECIMAL">
                        <queryname>totalDeudaConGara</queryname>
                        <servicename>totalDeudaConGara</servicename>
                    </outParameter>
                </level>
            </output>
        </query>
    </querys>
</serviceQuery>
