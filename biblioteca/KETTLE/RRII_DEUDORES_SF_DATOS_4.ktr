<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>RRII_DEUDORES_SF_DATOS_4</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
      <parameter>
        <name>fecha</name>
        <default_value>01/11/2023</default_value>
        <description/>
      </parameter>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>Y</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2025/01/15 13:34:59.453</created_date>
    <modified_user>-</modified_user>
    <modified_date>2025/01/15 13:34:59.453</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>TopazConect</name>
    <server/>
    <type>MSSQL</type>
    <access>JNDI</access>
    <database>TopazDS</database>
    <port>1521</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MSSQL_DOUBLE_DECIMAL_SEPARATOR</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1521</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>Cargar campos para insertar</from>
      <to>Mensaje 3</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Data Grid</from>
      <to>Traer fecha parametro</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Mensaje 3</from>
      <to>Abort</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Obtengo fechaActual</from>
      <to>Valido si es mayor </to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Traer fecha parametro</from>
      <to>Obtengo fechaActual</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Valido si es mayor </from>
      <to>Cargar campos para insertar</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Cargar campos para insertar</from>
      <to>Log en tabla errores</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Valido si es mayor </from>
      <to>Deudores 4306</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Deudores 4306</from>
      <to>Deudores 4307</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Abort</name>
    <type>Abort</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <row_threshold>0</row_threshold>
    <message/>
    <always_log_rows>Y</always_log_rows>
    <abort_option>ABORT_WITH_ERROR</abort_option>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>432</xloc>
      <yloc>352</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Cargar campos para insertar</name>
    <type>Constant</type>
    <description/>
    <distribute>N</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>CODIGO_ERROR</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif>1000</nullif>
        <length>-1</length>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>NOMBRE_REPORTE</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif>Che_Cheques_Rechazados</nullif>
        <length>-1</length>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>DESCRIPCION_ERROR</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif>La fecha ingresada es mayor a la fecha actual</nullif>
        <length>-1</length>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>FECHA_REPORTE</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <length>-1</length>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>MENSAJE_EXTRA</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif>-</nullif>
        <length>-1</length>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
      </field>
      <field>
        <name>NOMBRE_ERROR</name>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif>La fecha ingresada es mayor a la fecha actual</nullif>
        <length>-1</length>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>320</xloc>
      <yloc>256</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Data Grid</name>
    <type>DataGrid</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
    </fields>
    <data>
      <line>  </line>
    </data>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>80</xloc>
      <yloc>48</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Deudores 4306</name>
    <type>ExecSQL</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazConect</connection>
    <execute_each_row>Y</execute_each_row>
    <single_statement>Y</single_statement>
    <replace_variables>Y</replace_variables>
    <quoteString>N</quoteString>
    <sql>INSERT INTO DEUDORES_4306
SELECT DISTINCT
-----4306
4306 AS CODIGO_DISENIO,
CASE WHEN (SELECT COUNT(1) FROM CLI_PERSONASJURIDICAS WITH(NOLOCK) WHERE NUMEROPERSONAJURIDICA = DPFJ.NUMEROPERSONAFJ AND TZ_LOCK = 0 AND TIPOSOCIEDAD = 66) > 0 AND DPFJ.TIPOPERSONA = 'J' THEN 77
ELSE 11 END AS TIPO_ID,
MC.CUIT_CUIL_CDI AS NRO_ID,
CASE 
WHEN D.RES_SECTOR = 5 THEN 13
WHEN MD.TIPO_ASISTENCIA IS NOT NULL THEN MD.TIPO_ASISTENCIA
ELSE 99 END AS TIPO_ASIST_CRED,
---MD.PRODUCTO,
CASE WHEN D.SITUACION NOT IN (1, 11,21,22, 23,5) THEN ROUND(SUM(MD.CAPITAL_VENCIDO_2)/1000,0) ELSE 0 END AS GAR_A_CAP_INT_VENC,
ROUND(SUM(MD.DEUDA_TOTAL_2)/1000,0) AS GAR_A_CAP_INT_TOT,
CASE WHEN D.SITUACION NOT IN (1, 11,21,22, 23,5) THEN ROUND(SUM(MD.CAPITAL_VENCIDO_1)/1000,0) ELSE 0 END AS GAR_B_CAP_INT_NOPREV_VENC,
ROUND(SUM(MD.DEUDA_TOTAL_1)/1000,0) AS GAR_B_CAP_INT_NOPREV_TOT,
0 AS GAR_B_INT_PREV_VENC,
0 AS GAR_B_INT_PREV_TOT,
CASE WHEN D.SITUACION NOT IN (1, 11,21,22, 23,5) THEN ROUND(SUM(MD.CAPITAL_VENCIDO_0)/1000,0) ELSE 0 END AS SIN_GAR_CAP_INT_NOPREV_VENC,
ROUND(SUM(MD.DEUDA_TOTAL_0)/1000,0) AS SIN_GAR_CAP_INT_NOPREV_TOT,
0 AS SIN_GAR_INT_PREV_VENC,
0 AS SIN_GAR_INT_PREV_TOT,
CASE WHEN D.SITUACION IN (4,5) AND MD.TIPO_ASISTENCIA = 18 THEN ROUND(SUM(NAT.PREVISIONES)/1000,0) ELSE 0 END AS PREV_MIN_CRED_ADIC,
CASE WHEN MC.Clte_Refinanciado = 'N' THEN 0 ELSE CONVERT(VARCHAR,ISNULL((SELECT MAX(FECHA_ALTA_OPER) FROM MEMO_DETALLE WITH(NOLOCK) 
WHERE FECHA_INFO = CONVERT(DATETIME,?,103) AND SALDO_JTS_OID IN (SELECT JTS_OID FROM SALDOS WITH(NOLOCK) 
WHERE C8748 = 'S') AND NUM_DOC = MC.CUIT_CUIL_CDI), MAX(S.C1621)),112) END AS FECHA_ULT_REFIN,
ROUND(SUM(CASE WHEN MC.tamano_emp = 'mipyme' THEN MD.TOTAL_2 + MD.TOTAL_1 + MD.TOTAL_0 ELSE 0 END)/1000,0) AS FIN_MIPYME,  
CONVERT(DATETIME,?,103) as FECHA_PROCESO
FROM MEMO_CABECERA MC with(NOLOCK)
INNER JOIN (select MD.num_doc, MD.SALDO_JTS_OID, MD.Producto, MD.Fecha_Info, 
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 1 THEN MD.saldo_capital ELSE 0 END) AS DEUDA_TOTAL_1,
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 1 THEN MD.Capital_Vencido + ISNULL(HD.ICMORA_DEVEN_VIGENTE_CONT,0) ELSE 0 END) AS CAPITAL_VENCIDO_1,
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 1 THEN MD.saldo_capital + MD.int_deven_cobrar_cont + MD.iva_financiado + MD.rg_financiado + 
MD.seguro_financ + MD.otros_accesorios - MD.int_adelantados ELSE 0 END) AS TOTAL_1,
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 2 THEN MD.saldo_capital + MD.int_deven_cobrar_cont ELSE 0 END) AS DEUDA_TOTAL_2,
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 2 THEN MD.Capital_Vencido + ISNULL(HD.ICMORA_DEVEN_VIGENTE_CONT,0) ELSE 0 END) AS CAPITAL_VENCIDO_2,
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 2 THEN MD.saldo_capital + MD.int_deven_cobrar_cont + MD.iva_financiado + MD.rg_financiado + 
MD.seguro_financ + MD.otros_accesorios - MD.int_adelantados ELSE 0 END) AS TOTAL_2,
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 0 OR MD.TIPO_GTIA_BCRA IS NULL THEN MD.saldo_capital + MD.int_deven_cobrar_cont + MD.otros_accesorios ELSE 0 END) AS DEUDA_TOTAL_0,
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 0 OR MD.TIPO_GTIA_BCRA IS NULL THEN MD.Capital_Vencido + ISNULL(HD.ICMORA_DEVEN_VIGENTE_CONT,0) ELSE 0 END) AS CAPITAL_VENCIDO_0,
SUM(CASE WHEN MD.TIPO_GTIA_BCRA = 0 OR MD.TIPO_GTIA_BCRA IS NULL THEN MD.Int_Deven_Cobrar_Cont  ELSE 0 END) TOTAL_0,
max(TIPO_GTIA_BCRA) AS TIPO_GTIA_BCRA, CUENTA_ORDEN, CPI.TIPO_ASISTENCIA, MD.FAMILIA
from MEMO_DETALLE MD with(nolock)
LEFT JOIN HISTORICO_DEVENGAMIENTO HD WITH(NOLOCK) ON HD.SALDO_JTS_OID = MD.SALDO_JTS_OID AND HD.FECHA = MD.Fecha_Info
LEFT JOIN CRE_PROD_INSTNBCH CPI WITH(NOLOCK) ON CPI.PRODUCTO = MD.PRODUCTO AND CPI.TIPO_INST_NBCH = (CASE WHEN EXISTS (
SELECT 1 FROM CRE_PROD_INSTNBCH with(nolock) WHERE PRODUCTO = MD.PRODUCTO AND TIPO_INST_NBCH = ISNULL(MD.TIPO_INST_NBCH, 0)) 
THEN ISNULL(MD.TIPO_INST_NBCH, 0) ELSE 0 END)
where MD.Fecha_Info = CONVERT(DATETIME,?,103)
GROUP BY MD.num_doc, MD.SALDO_JTS_OID, MD.Producto, MD.Fecha_Info, MD.CUENTA_ORDEN, CPI.TIPO_ASISTENCIA, MD.FAMILIA) MD ON MC.CUIT_CUIL_CDI = MD.NUM_DOC AND MC.Fecha_Info = MD.Fecha_Info
INNER JOIN (SELECT MIN(TZ_LOCK) AS TZ_LOCK, NUMERODOCUMENTO FROM CLI_DocumentosPFPJ WITH(NOLOCK) GROUP BY NUMERODOCUMENTO) DOCT ON
DOCT.NUMERODOCUMENTO  = MC.CUIT_CUIL_CDI
INNER JOIN CLI_DocumentosPFPJ DPFJ WITH(NOLOCK) ON DOCT.NUMERODOCUMENTO = DPFJ.NUMERODOCUMENTO AND DOCT.TZ_LOCK = DPFJ.TZ_LOCK
INNER JOIN DEUDORES_4305 D WITH(NOLOCK) ON D.NRO_ID = CONVERT(VARCHAR,MD.Num_Doc) AND D.FECHA_PROCESO = MD.Fecha_Info
LEFT JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = MD.SALDO_JTS_OID
----LEFT JOIN HISTORICO_DEVENGAMIENTO HD WITH(NOLOCK) ON HD.SALDO_JTS_OID = MD.SALDO_JTS_OID AND HD.FECHA = MD.Fecha_Info
LEFT JOIN (SELECT ope_upl_gdncuenta, OPE_UPL_Periodo, SUM(CONVERT(NUMERIC, REPLACE(ISNULL(ope_peva_saldo,'0'),'.00','0')) + CONVERT(NUMERIC, REPLACE(ISNULL(ope_peva_limite,'0'), '.00', '0'))) AS PREVISIONES FROM 
SALIDA_NAT WITH(NOLOCK) GROUP BY ope_upl_gdncuenta, OPE_UPL_Periodo) NAT ON NAT.ope_upl_gdncuenta = CONVERT(VARCHAR,MC.CUIT_CUIL_CDI) AND CONVERT(NUMERIC,SUBSTRING(NAT.OPE_UPL_Periodo, 1, 4)) = YEAR(MC.Fecha_Info) AND 
CONVERT(NUMERIC,SUBSTRING(NAT.OPE_UPL_Periodo, 5, 2)) = MONTH(MC.Fecha_Info)
WHERE MC.Fecha_Info= CONVERT(DATETIME,?,103) AND MD.PRODUCTO NOT IN (12301, 12303) AND (MD.CUENTA_ORDEN = 'N' OR MD.CUENTA_ORDEN IS NULL) AND MD.FAMILIA NOT IN (15000, 16000)
AND MC.TZ_LOCK=0 AND (MC.Max_Asistencia > 0 OR MC.Deuda_Total > 0) 
AND (MC.DEUDA_TOTAL >= (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784) OR 
(MC.DEUDA_TOTAL &lt; (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784)) AND ((MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 609)*0.005) OR
MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 501)*0.4))
AND MC.CUIT_CUIL_CDI IN (SELECT NRO_ID FROM DEUDORES_4305 WITH(NOLOCK) WHERE FECHA_PROCESO = CONVERT(DATETIME,?,103))
GROUP BY MC.CUIT_CUIL_CDI, DPFJ.NUMEROPERSONAFJ, DPFJ.TIPOPERSONA, MD.TIPO_ASISTENCIA, MC.Clasificacion, MC.Clte_Refinanciado, D.SITUACION, D.RES_SECTOR
HAVING (SUM(MD.DEUDA_TOTAL_2 + MD.DEUDA_TOTAL_1 + MD.DEUDA_TOTAL_0) > 0 AND 
(ROUND(SUM(MD.DEUDA_TOTAL_2)/1000,0) + ROUND(SUM(MD.DEUDA_TOTAL_1)/1000,0) + ROUND(SUM(MD.DEUDA_TOTAL_0)/1000,0)) > 0)
UNION
SELECT DISTINCT
-----4306
4306 AS CODIGO_DISENIO,
CASE WHEN (SELECT COUNT(1) FROM CLI_PERSONASJURIDICAS WITH(NOLOCK) WHERE NUMEROPERSONAJURIDICA = DPFJ.NUMEROPERSONAFJ AND TZ_LOCK = 0 AND TIPOSOCIEDAD = 66) > 0 AND DPFJ.TIPOPERSONA = 'J' THEN 77
ELSE 11 END AS TIPO_ID,
MC.CUIT_CUIL_CDI AS NRO_ID,
14 AS TIPO_ASIST_CRED,
---MD.PRODUCTO,
0 AS GAR_A_CAP_INT_VENC,
ROUND(SUM(MD.IMP_2)/1000,0) AS GAR_A_CAP_INT_TOT,
0 AS GAR_B_CAP_INT_NOPREV_VENC,
ROUND(SUM(MD.IMP_1)/1000,0) AS GAR_B_CAP_INT_NOPREV_TOT,
0 AS GAR_B_INT_PREV_VENC,
0 AS GAR_B_INT_PREV_TOT,
0 AS SIN_GAR_CAP_INT_NOPREV_VENC,
ROUND(SUM(MD.IMP_0)/1000,0) AS SIN_GAR_CAP_INT_NOPREV_TOT,
0 AS SIN_GAR_INT_PREV_VENC,
0 AS SIN_GAR_INT_PREV_TOT,
0 AS PREV_MIN_CRED_ADIC,
CASE WHEN MC.Clte_Refinanciado = 'N' THEN 0 ELSE CONVERT(VARCHAR,ISNULL((SELECT MAX(FECHA_ALTA_OPER) FROM MEMO_DETALLE WITH(NOLOCK) 
WHERE FECHA_INFO = CONVERT(DATETIME,?,103) AND SALDO_JTS_OID IN (SELECT JTS_OID FROM SALDOS WITH(NOLOCK) 
WHERE C8748 = 'S') AND NUM_DOC = MC.CUIT_CUIL_CDI), MAX(S.C1621)),112) END AS FECHA_ULT_REFIN,
0 AS FIN_MIPYME,  
CONVERT(DATETIME,?,103) as FECHA_PROCESO
FROM MEMO_CABECERA MC with(NOLOCK)
INNER JOIN (select num_doc, SALDO_JTS_OID, Producto, Fecha_Info, 
SUM(CASE WHEN Tipo_Gtia_BCRA = 2 THEN iva_financiado + rg_financiado + seguro_financ ELSE 0 END) AS IMP_2,
SUM(CASE WHEN Tipo_Gtia_BCRA = 1 THEN iva_financiado + rg_financiado + seguro_financ ELSE 0 END) AS IMP_1,
SUM(CASE WHEN Tipo_Gtia_BCRA = 0 OR Tipo_Gtia_BCRA IS NULL THEN iva_financiado + rg_financiado + seguro_financ ELSE 0 END) AS IMP_0,
max(TIPO_GTIA_BCRA) AS TIPO_GTIA_BCRA,
CUENTA_ORDEN, FAMILIA
from MEMO_DETALLE with(nolock)
where Fecha_Info = CONVERT(DATETIME,?,103)
GROUP BY num_doc, SALDO_JTS_OID, Producto, Fecha_Info, CUENTA_ORDEN, FAMILIA) MD ON MC.CUIT_CUIL_CDI = MD.NUM_DOC AND MC.Fecha_Info = MD.Fecha_Info
INNER JOIN (SELECT MIN(TZ_LOCK) AS TZ_LOCK, NUMERODOCUMENTO FROM CLI_DocumentosPFPJ WITH(NOLOCK) GROUP BY NUMERODOCUMENTO) DOCT ON
DOCT.NUMERODOCUMENTO  = MC.CUIT_CUIL_CDI
INNER JOIN CLI_DocumentosPFPJ DPFJ WITH(NOLOCK) ON DOCT.NUMERODOCUMENTO = DPFJ.NUMERODOCUMENTO AND DOCT.TZ_LOCK = DPFJ.TZ_LOCK
INNER JOIN DEUDORES_4305 D WITH(NOLOCK) ON D.NRO_ID = CONVERT(VARCHAR,MD.Num_Doc) AND D.FECHA_PROCESO = MD.Fecha_Info
LEFT JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = MD.SALDO_JTS_OID
WHERE MC.Fecha_Info= CONVERT(DATETIME,?,103) AND MD.PRODUCTO NOT IN (12301, 12303) AND (MD.CUENTA_ORDEN = 'N' OR MD.CUENTA_ORDEN IS NULL) AND MD.FAMILIA NOT IN (15000, 16000)
AND MC.TZ_LOCK=0 AND (MC.Max_Asistencia > 0 OR MC.Deuda_Total > 0) 
AND (MC.DEUDA_TOTAL >= (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784) OR 
(MC.DEUDA_TOTAL &lt; (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784)) AND ((MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 609)*0.005) OR
MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 501)*0.4))
AND MC.CUIT_CUIL_CDI IN (SELECT NRO_ID FROM DEUDORES_4305 WITH(NOLOCK) WHERE FECHA_PROCESO = CONVERT(DATETIME,?,103))
GROUP BY MC.CUIT_CUIL_CDI, DPFJ.NUMEROPERSONAFJ, DPFJ.TIPOPERSONA, MC.Clte_Refinanciado, D.SITUACION
HAVING (SUM(MD.IMP_2 + MD.IMP_1 + MD.IMP_0) > 0 AND 
(ROUND(SUM(MD.IMP_2)/1000,0) + ROUND(SUM(MD.IMP_1)/1000,0) + ROUND(SUM(MD.IMP_0)/1000,0)) > 0)</sql>
    <set_params>Y</set_params>
    <insert_field/>
    <update_field/>
    <delete_field/>
    <read_field/>
    <arguments>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
    </arguments>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>512</xloc>
      <yloc>160</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Deudores 4307</name>
    <type>ExecSQL</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazConect</connection>
    <execute_each_row>Y</execute_each_row>
    <single_statement>Y</single_statement>
    <replace_variables>Y</replace_variables>
    <quoteString>N</quoteString>
    <sql>INSERT INTO dbo.DEUDORES_4307
SELECT
CODIGO_DISENIO, TIPO_ID, NRO_ID, SIN_USO_1, SIN_USO_2, SUM(RESP_EVENT_GAR_A), SUM(RESP_EVENT_GAR_B),
SUM(RESP_EVENT_SIN_GAR), SUM(GAR_OTORG_GAR_A), SUM(GAR_OTORG_GAR_B), SUM(ADEL_CC_GAR_A),
SUM(ADEL_CC_GAR_B), SUM(ADEL_CC_SIN_GAR), SUM(GAR_OTORG_SIN_GAR), SUM(MONTO_IRREC_FUERA_BAL),
SUM(FIN_EXTERIOR), SUM(DIF_ADQ_CARTERA), FECHA_PROCESO
FROM (
SELECT DISTINCT
-----4307
4307 AS CODIGO_DISENIO,
CASE WHEN (SELECT COUNT(1) FROM CLI_PERSONASJURIDICAS WITH(NOLOCK) WHERE NUMEROPERSONAJURIDICA = DPFJ.NUMEROPERSONAFJ AND TZ_LOCK = 0 AND TIPOSOCIEDAD = 66) > 0 AND DPFJ.TIPOPERSONA = 'J' THEN 77
ELSE 11 END AS TIPO_ID,
ISNULL(TRY_CAST(MD.Num_Doc  AS VARCHAR(11)), 0) AS NRO_ID,
0 AS SIN_USO_1,
0 AS SIN_USO_2,
0 AS RESP_EVENT_GAR_A,
0 AS RESP_EVENT_GAR_B,
0 AS RESP_EVENT_SIN_GAR,
0 AS GAR_OTORG_GAR_A,
0 AS GAR_OTORG_GAR_B,
----ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 2 THEN MD.Acuerdo_No_Utiliz ELSE 0 END /1000 ),0)
0  AS ADEL_CC_GAR_A,
----ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 1 THEN MD.Acuerdo_No_Utiliz ELSE 0 END /1000 ),0) 
0 AS ADEL_CC_GAR_B,
----ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 0 OR MD.Tipo_Gtia_BCRA IS NULL THEN MD.Acuerdo_No_Utiliz ELSE 0 END /1000 ),0) 
0 AS ADEL_CC_SIN_GAR,
0 AS GAR_OTORG_SIN_GAR,
ROUND(SUM((MD.Saldo_Capital + (MD.Int_Deven_Cobrar_Cont) + MD.IVA_Financiado + MD.RG_Financiado + MD.Seguro_Financ + MD.Otros_Accesorios) /1000),0) AS MONTO_IRREC_FUERA_BAL,
0 AS FIN_EXTERIOR,
0 AS DIF_ADQ_CARTERA,
CONVERT(DATETIME,?,103) as FECHA_PROCESO
FROM MEMO_DETALLE MD WITH(NOLOCK)
INNER JOIN MEMO_CABECERA MC with(NOLOCK) ON MC.CUIT_CUIL_CDI = MD.NUM_DOC AND MC.Fecha_Info = MD.Fecha_Info
INNER JOIN CLI_DocumentosPFPJ DPFJ WITH(NOLOCK) ON DPFJ.NUMERODOCUMENTO = CONVERT(VARCHAR,MD.Num_Doc) 
INNER JOIN DEUDORES_4305 D WITH(NOLOCK) ON D.NRO_ID = CONVERT(VARCHAR,MD.Num_Doc) AND D.FECHA_PROCESO = MD.Fecha_Info
INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = MD.PRODUCTO
WHERE MD.Fecha_Info= CONVERT(DATETIME,?,103)
AND MD.TZ_LOCK=0
AND MD.CUENTA_ORDEN = 'S'
AND (MC.Max_Asistencia > 0 OR MC.Deuda_Total > 0)
AND (MC.DEUDA_TOTAL >= (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784) OR 
(MC.DEUDA_TOTAL &lt; (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784)) AND ((MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 609)*0.005) OR
MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 501)*0.4))
AND MC.CUIT_CUIL_CDI IN (SELECT NRO_ID FROM DEUDORES_4305 WITH(NOLOCK) WHERE FECHA_PROCESO = CONVERT(DATETIME,?,103))
GROUP BY DPFJ.NUMEROPERSONAFJ, DPFJ.TIPOPERSONA, MD.Num_Doc
UNION ALL
SELECT DISTINCT
-----4307
4307 AS CODIGO_DISENIO,
CASE WHEN (SELECT COUNT(1) FROM CLI_PERSONASJURIDICAS WITH(NOLOCK) WHERE NUMEROPERSONAJURIDICA = DPFJ.NUMEROPERSONAFJ AND TZ_LOCK = 0 AND TIPOSOCIEDAD = 66) > 0 AND DPFJ.TIPOPERSONA = 'J' THEN 77
ELSE 11 END AS TIPO_ID,
ISNULL(TRY_CAST(MD.Num_Doc  AS VARCHAR(11)), 0) AS NRO_ID,
0 AS SIN_USO_1,
0 AS SIN_USO_2,
0 AS RESP_EVENT_GAR_A,
0 AS RESP_EVENT_GAR_B,
0 AS RESP_EVENT_SIN_GAR,
ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 2 THEN MD.SALDO_CAPITAL ELSE 0 END/1000),0) AS GAR_OTORG_GAR_A,
ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 1 THEN MD.SALDO_CAPITAL ELSE 0 END/1000),0) AS GAR_OTORG_GAR_B,
0 AS ADEL_CC_GAR_A,
0 AS ADEL_CC_GAR_B,
0 AS ADEL_CC_SIN_GAR,
ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 0 OR MD.Tipo_Gtia_BCRA IS NULL THEN MD.SALDO_CAPITAL ELSE 0 END/1000),0) AS GAR_OTORG_SIN_GAR,
0 AS MONTO_IRREC_FUERA_BAL,
0 AS FIN_EXTERIOR,
0 AS DIF_ADQ_CARTERA,
CONVERT(DATETIME,?,103) as FECHA_PROCESO
FROM MEMO_DETALLE MD WITH(NOLOCK)
INNER JOIN MEMO_CABECERA MC with(NOLOCK) ON MC.CUIT_CUIL_CDI = MD.NUM_DOC AND MC.Fecha_Info = MD.Fecha_Info
INNER JOIN CLI_DocumentosPFPJ DPFJ WITH(NOLOCK) ON DPFJ.NUMERODOCUMENTO = CONVERT(VARCHAR,MD.Num_Doc)
INNER JOIN DEUDORES_4305 D WITH(NOLOCK) ON D.NRO_ID = CONVERT(VARCHAR,MD.Num_Doc) AND D.FECHA_PROCESO = MD.Fecha_Info
INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = MD.PRODUCTO
WHERE MD.Fecha_Info= CONVERT(DATETIME,?,103) AND P.C6800 = 'GO' AND MD.CUENTA_ORDEN = 'N'
AND MD.TZ_LOCK=0
AND (MC.Max_Asistencia > 0 OR MC.Deuda_Total > 0)
AND (MC.DEUDA_TOTAL >= (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784) OR 
(MC.DEUDA_TOTAL &lt; (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784)) AND ((MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 609)*0.005) OR
MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 501)*0.4))
AND MC.CUIT_CUIL_CDI IN (SELECT NRO_ID FROM DEUDORES_4305 WITH(NOLOCK) WHERE FECHA_PROCESO = CONVERT(DATETIME,?,103))
GROUP BY DPFJ.NUMEROPERSONAFJ, DPFJ.TIPOPERSONA, MD.Num_Doc
----HAVING COUNT(DISTINCT CASE WHEN P.C6800 = 'GO' THEN 1 ELSE NULL END) = COUNT(1)
/*UNION ALL
SELECT DISTINCT
-----4307
4307 AS CODIGO_DISENIO,
CASE WHEN (SELECT COUNT(1) FROM CLI_PERSONASJURIDICAS WITH(NOLOCK) WHERE NUMEROPERSONAJURIDICA = DPFJ.NUMEROPERSONAFJ AND TZ_LOCK = 0 AND TIPOSOCIEDAD = 66) > 0 AND DPFJ.TIPOPERSONA = 'J' THEN 77
ELSE 11 END AS TIPO_ID,
ISNULL(TRY_CAST(MD.Num_Doc  AS VARCHAR(11)), 0) AS NRO_ID,
0 AS SIN_USO_1,
0 AS SIN_USO_2,
0 AS RESP_EVENT_GAR_A,
0 AS RESP_EVENT_GAR_B,
0 AS RESP_EVENT_SIN_GAR,
0 AS GAR_OTORG_GAR_A,
0 AS GAR_OTORG_GAR_B,
ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 2 THEN MD.Acuerdo_No_Utiliz ELSE 0 END/1000),0) AS ADEL_CC_GAR_A,
ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 1 THEN MD.Acuerdo_No_Utiliz ELSE 0 END/1000),0) AS ADEL_CC_GAR_B,
ROUND(SUM(CASE WHEN MD.Tipo_Gtia_BCRA = 0 OR MD.Tipo_Gtia_BCRA IS NULL THEN MD.Acuerdo_No_Utiliz ELSE 0 END/1000),0) AS ADEL_CC_SIN_GAR,
0 AS GAR_OTORG_SIN_GAR,
0 AS MONTO_IRREC_FUERA_BAL,
0 AS FIN_EXTERIOR,
0 AS DIF_ADQ_CARTERA,
CONVERT(DATETIME,?,103) as FECHA_PROCESO
FROM MEMO_DETALLE MD WITH(NOLOCK)
INNER JOIN MEMO_CABECERA MC with(NOLOCK) ON MC.CUIT_CUIL_CDI = MD.NUM_DOC AND MC.Fecha_Info = MD.Fecha_Info
INNER JOIN CLI_DocumentosPFPJ DPFJ WITH(NOLOCK) ON DPFJ.NUMERODOCUMENTO = CONVERT(VARCHAR,MD.Num_Doc) 
INNER JOIN DEUDORES_4305 D WITH(NOLOCK) ON D.NRO_ID = CONVERT(VARCHAR,MD.Num_Doc) AND D.FECHA_PROCESO = MD.Fecha_Info
INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = MD.PRODUCTO
WHERE MD.Fecha_Info= CONVERT(DATETIME,?,103)
AND MD.TZ_LOCK=0
AND P.C6800 != 'GO' AND MD.Acuerdo_No_Utiliz > 0
AND (MC.Max_Asistencia > 0 OR MC.Deuda_Total > 0)
AND (MC.DEUDA_TOTAL >= (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784) OR 
(MC.DEUDA_TOTAL &lt; (SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=784)) AND ((MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 609)*0.005) OR
MC.Max_Asistencia > (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 501)*0.4))
AND MC.CUIT_CUIL_CDI IN (SELECT NRO_ID FROM DEUDORES_4305 WITH(NOLOCK) WHERE FECHA_PROCESO = CONVERT(DATETIME,?,103))
GROUP BY DPFJ.NUMEROPERSONAFJ, DPFJ.TIPOPERSONA, MD.Num_Doc*/
) T
GROUP BY CODIGO_DISENIO, TIPO_ID, NRO_ID, SIN_USO_1, SIN_USO_2, FECHA_PROCESO
HAVING SUM(RESP_EVENT_GAR_A) > 0  OR SUM(RESP_EVENT_GAR_B) > 0 OR
SUM(RESP_EVENT_SIN_GAR) > 0 OR SUM(GAR_OTORG_GAR_A) > 0 OR SUM(GAR_OTORG_GAR_B) > 0 OR SUM(ADEL_CC_GAR_A)>0 OR
SUM(ADEL_CC_GAR_B)>0 OR SUM(ADEL_CC_SIN_GAR)>0 OR SUM(GAR_OTORG_SIN_GAR)>0 OR SUM(MONTO_IRREC_FUERA_BAL)>0 OR
SUM(FIN_EXTERIOR)>0 OR SUM(DIF_ADQ_CARTERA)>0</sql>
    <set_params>Y</set_params>
    <insert_field/>
    <update_field/>
    <delete_field/>
    <read_field/>
    <arguments>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
      <argument>
        <name>fecha</name>
      </argument>
    </arguments>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>704</xloc>
      <yloc>160</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Log en tabla errores</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazConect</connection>
    <schema>dbo</schema>
    <table>RRII_ERRORES_VALIDACIONES</table>
    <commit>1000</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>N</use_batch>
    <specify_fields>Y</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
      <field>
        <column_name>CODIGO_ERROR</column_name>
        <stream_name>CODIGO_ERROR</stream_name>
      </field>
      <field>
        <column_name>NOMBRE_REPORTE</column_name>
        <stream_name>NOMBRE_REPORTE</stream_name>
      </field>
      <field>
        <column_name>DESCRIPCION_ERROR</column_name>
        <stream_name>DESCRIPCION_ERROR</stream_name>
      </field>
      <field>
        <column_name>FECHA_REPORTE</column_name>
        <stream_name>fecha</stream_name>
      </field>
      <field>
        <column_name>NOMBRE_ERROR</column_name>
        <stream_name>NOMBRE_ERROR</stream_name>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>320</xloc>
      <yloc>352</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Mensaje 3</name>
    <type>SetVariable</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <field_name>msg_res</field_name>
        <variable_name>msg_res</variable_name>
        <variable_type>PARENT_JOB</variable_type>
        <default_value/>
      </field>
    </fields>
    <use_formatting>Y</use_formatting>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>432</xloc>
      <yloc>256</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Obtengo fechaActual</name>
    <type>DBJoin</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazConect</connection>
    <rowlimit>0</rowlimit>
    <sql>

select
case when CONVERT(DATETIME, ?, 103) > CONVERT(DATETIME,fechaproceso,103) then 1 else 0 End as FechaActual   
from parametros

--then 1 else 0 End as FechaActual </sql>
    <outer_join>N</outer_join>
    <replace_vars>Y</replace_vars>
    <parameter>
      <field>
        <name>fecha</name>
        <type>Date</type>
      </field>
    </parameter>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>208</xloc>
      <yloc>160</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Traer fecha parametro</name>
    <type>GetVariable</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>fecha</name>
        <variable>${fecha}</variable>
        <type>Date</type>
        <format>dd/MM/yyyy</format>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>80</xloc>
      <yloc>160</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Valido si es mayor </name>
    <type>Validator</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <validate_all>N</validate_all>
    <concat_errors>N</concat_errors>
    <concat_separator>|</concat_separator>
    <validator_field>
      <name>FechaActual</name>
      <validation_name>Fecha mayor a la actual </validation_name>
      <max_length/>
      <min_length/>
      <null_allowed>N</null_allowed>
      <only_null_allowed>N</only_null_allowed>
      <only_numeric_allowed>N</only_numeric_allowed>
      <data_type>Integer</data_type>
      <data_type_verified>N</data_type_verified>
      <conversion_mask/>
      <decimal_symbol/>
      <grouping_symbol/>
      <max_value/>
      <min_value/>
      <start_string/>
      <end_string/>
      <start_string_not_allowed/>
      <end_string_not_allowed/>
      <regular_expression/>
      <regular_expression_not_allowed/>
      <error_code>1000</error_code>
      <error_description>TOPAZ_PROCESS_ERROR: La fecha a procesar es mayor a la del sistema. CÃ³digo de error 1000.</error_description>
      <is_sourcing_values>N</is_sourcing_values>
      <sourcing_step/>
      <sourcing_field/>
      <allowed_value>
        <value>0</value>
      </allowed_value>
    </validator_field>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>320</xloc>
      <yloc>160</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
    <error>
      <source_step>Valido si es mayor </source_step>
      <target_step>Cargar campos para insertar</target_step>
      <is_enabled>Y</is_enabled>
      <nr_valuename/>
      <descriptions_valuename>msg_res</descriptions_valuename>
      <fields_valuename/>
      <codes_valuename/>
      <max_errors/>
      <max_pct_errors/>
      <min_pct_rows/>
    </error>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes/>
</transformation>
