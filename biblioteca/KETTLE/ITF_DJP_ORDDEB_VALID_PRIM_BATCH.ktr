<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>ITF_DJP_ORDDEB_VALID_PRIM_BATCH</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2024/12/23 13:33:33.070</created_date>
    <modified_user>-</modified_user>
    <modified_date>2024/12/23 13:33:33.070</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
    <notepad>
      <note>Lectura de datos y validaciones primaria</note>
      <xloc>192</xloc>
      <yloc>304</yloc>
      <width>277</width>
      <heigth>30</heigth>
      <fontname>Segoe UI</fontname>
      <fontsize>9</fontsize>
      <fontbold>N</fontbold>
      <fontitalic>N</fontitalic>
      <fontcolorred>0</fontcolorred>
      <fontcolorgreen>0</fontcolorgreen>
      <fontcolorblue>0</fontcolorblue>
      <backgroundcolorred>255</backgroundcolorred>
      <backgroundcolorgreen>205</backgroundcolorgreen>
      <backgroundcolorblue>112</backgroundcolorblue>
      <bordercolorred>100</bordercolorred>
      <bordercolorgreen>100</bordercolorgreen>
      <bordercolorblue>100</bordercolorblue>
      <drawshadow>Y</drawshadow>
    </notepad>
  </notepads>
  <connection>
    <name>TopazDS</name>
    <server/>
    <type>MSSQL</type>
    <access>JNDI</access>
    <database>TopazDS</database>
    <port>1521</port>
    <username/>
    <password>Encrypted </password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MSSQL_DOUBLE_DECIMAL_SEPARATOR</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1521</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>Text file input</from>
      <to>flujo vacio</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Text file input</from>
      <to>MarcaUltimo</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>MarcaUltimo</from>
      <to>Cancelatorias del Archivo</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Cancelatorias del Archivo</from>
      <to>Obtiene Detalle</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Obtiene Detalle</from>
      <to>Descarta campos</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Descarta campos</from>
      <to>Validar tipo de datos DETALLE</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Parse Error Duplicado</from>
      <to>Ordena Duplicado</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Ordena Referencia Debito</from>
      <to>Encuentra duplicados</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Encuentra duplicados</from>
      <to>Parse Error Duplicado</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Validar tipo de datos DETALLE</from>
      <to>Get variables</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Convenio existe? Corresponde a la empresa?</from>
      <to>Valida Prestacion</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Empresa homologada? Tiene convenio ord deb?</from>
      <to>Convenio existe? Corresponde a la empresa?</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Parsea Fechas</from>
      <to>Une</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Valida Prestacion</from>
      <to>parse Core</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Vencimientos son dias habiles?</from>
      <to>Parsea Fechas</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>parse Core</from>
      <to>Une</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Get variables</from>
      <to>Ordena Referencia Debito</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Ordena Referencia Debito</from>
      <to>Une con duplicados</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Ordena Duplicado</from>
      <to>Une con duplicados</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Espera informe</from>
      <to>Abort</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Filter rows</from>
      <to>Select values</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Select values</from>
      <to>Copy rows to result</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Valida set datos &amp; set Variables</from>
      <to>Filter rows</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Filter rows</from>
      <to>Informa bitacora</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Informa bitacora</from>
      <to>Espera informe</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Informa bitacora</from>
      <to>Write to log</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>flujo vacio</from>
      <to>Aborta archivo vacio</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Periodo Correcto</from>
      <to>Empresa homologada? Tiene convenio ord deb?</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Une con duplicados</from>
      <to>Vencimientos son dias habiles?</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Une</from>
      <to>Add constants</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Add constants</from>
      <to>OBTIENE LOTEID</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>LOTEID</from>
      <to>parseLOTEID</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>parseLOTEID</from>
      <to>OBTIENE LOTEID</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>OBTIENE LOTEID</from>
      <to>Valida set datos &amp; set Variables</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Abort</name>
    <type>Abort</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <row_threshold>0</row_threshold>
    <message/>
    <always_log_rows>Y</always_log_rows>
    <abort_option>ABORT_WITH_ERROR</abort_option>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2656</xloc>
      <yloc>992</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Aborta archivo vacio</name>
    <type>ScriptValueMod</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <compatible>N</compatible>
    <optimizationLevel>9</optimizationLevel>
    <jsScripts>
      <jsScript>
        <jsScript_type>0</jsScript_type>
        <jsScript_name>Script 1</jsScript_name>
        <jsScript_script>//Script here

trans_Status = CONTINUE_TRANSFORMATION
var message = 'Archivo vacío.'

writeToLog('e', message);
setVariable('Top.MSG', message, 'r');
trans_Status = ERROR_TRANSFORMATION;
_step_.setErrors(1);
_step_.stopAll();
</jsScript_script>
      </jsScript>
    </jsScripts>
    <fields>    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>64</xloc>
      <yloc>864</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Add constants</name>
    <type>Constant</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>keyLOTEID</name>
        <type>integer</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <nullif>1</nullif>
        <length>-1</length>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2144</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Cancelatorias del Archivo</name>
    <type>ScriptValueMod</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <compatible>N</compatible>
    <optimizationLevel>9</optimizationLevel>
    <jsScripts>
      <jsScript>
        <jsScript_type>0</jsScript_type>
        <jsScript_name>Script 1</jsScript_name>
        <jsScript_script>trans_Status = CONTINUE_TRANSFORMATION;

// Largo de registro
if (reg.length != 200) 	kaboom("Largo de Registro Incorrecto. [N° Registro: " + NumeroRegistro + "] ");



// Validaciones de parámetros sólo 1 vez
if (tipo_reg == '1') {

	// Cuenta cabecera
	TIPO_CABECERA_CANT++;

	if (TIPO_CABECERA_CANT == 1) {
		// Obtiene elementos cabecera
		CABECERA_CUIT = substr(reg, 1, 11);
		CABECERA_PERIODO = substr(reg, 28, 6);
		CABECERA_PERIODO = parseDate(CABECERA_PERIODO, 'yyyyMM');
	
		// Valido tipo de datos parametros
		if (!PERIODO) kaboom('Parametro PERIODO incorrecto');
		else if (isNaN(CUIT_EMPRESA) || CUIT_EMPRESA.length != 11) kaboom('Parametro CUIT incorrecto');
		else if (isNaN(CONVENIO)) kaboom('Parametro CONVENIO incorrecto');
		else if (CUIT_EMPRESA != CABECERA_CUIT) kaboom('Parametro CUIT no se corresponde con CUIT en Cabecera del Soporte');
		else if (dateDiff(PERIODO, CABECERA_PERIODO, 'd') != 0)	kaboom('Parametro PERIODO no se corresponde con PERIODO en Cabecera del Soporte');
	};
}

// Cuenta pie
if (tipo_reg == '3') TIPO_PIE_CANT++;

// Validaciones de tipo de registro
if (TIPO_CABECERA_CANT > 1) kaboom('Existe más de un Registro Tipo 1 [CABECERA]');
if (TIPO_PIE_CANT > 1) kaboom('Existe más de un Registro Tipo 3 [PIE]');

if ( (NumeroRegistro == 1 &amp;&amp; tipo_reg != '1') || (NumeroRegistro != 1 &amp;&amp; tipo_reg == '1') ) {
	
	kaboom('Registro Tipo 1 [CABECERA] inválido');

} else if ( (esUltimo==true &amp;&amp; tipo_reg != '3') || (tipo_reg == '3' &amp;&amp; esUltimo ==false) ) {

	kaboom('Registro Tipo 3 [PIE] inválido');

} 

if (tipo_reg == '2') {

	// Cuenta detalle
	TIPO_REGISTRO_CANT++;

	// Obtiene y valida importe de vencimientos
	DETALLE_VENC_1 = substr(reg, 158, 10)
	DETALLE_VENC_2 = substr(reg, 176, 10)
	if (isNaN(DETALLE_VENC_1)) {
		kaboom("El registro en la línea [" + NumeroRegistro + "] contiene el campo IMPORTE 1er VENC. no numérico");
	}
	else if (isNaN(DETALLE_VENC_2)) {
		kaboom("El registro en la línea [" + NumeroRegistro + "] contiene el campo IMPORTE 2do VENC. no numérico");
	}
	else {

	// Sumariza primer vencimiento
	DETALLE_VENC_1 = new java.math.BigDecimal( java.lang.String.valueOf(DETALLE_VENC_1) )
	DETALLE_VENC_1 = DETALLE_VENC_1.scaleByPowerOfTen(-2);
	SUMA_VENC_1 = SUMA_VENC_1.add( DETALLE_VENC_1 );
	writeToLog('d', '- - - -');
	writeToLog('d', 'Se suma ' + DETALLE_VENC_1.toPlainString() + ' al 1° VENC.');
	writeToLog('d', 'Suma 1° VENC: = ' + SUMA_VENC_1.toPlainString() );
	
	// Sumariza segundo vencimiento
	DETALLE_VENC_2 = new java.math.BigDecimal( java.lang.String.valueOf(DETALLE_VENC_2) )
	DETALLE_VENC_2 = DETALLE_VENC_2.scaleByPowerOfTen(-2);
	SUMA_VENC_2 = SUMA_VENC_2.add( DETALLE_VENC_2 );
	writeToLog('d', 'Se suma ' + DETALLE_VENC_2.toPlainString() + ' al 2° VENC.');
	writeToLog('d', 'Suma 2° VENC: = ' + SUMA_VENC_2.toPlainString() );
};



}

if (tipo_reg == '3') {

	// Obtiene elementos del pie
	PIE_CANT = substr(reg, 1, 6);
	VENC_1 = substr(reg, 7, 12);
	VENC_2 = substr(reg, 19, 12);
	
	// Valida Elementos del pie
	if (isNaN(PIE_CANT)) kaboom('Cantidad de registros [PIE] no numérico');
	else if (isNaN(VENC_1)) kaboom('Total importes 1er Venc. [PIE] no numérico');
	else if (isNaN(VENC_2)) kaboom('Total importes 2do Venc. [PIE] no numérico');
	else {
		// Parsear elementos del pie
		PIE_CANT = parseInt(PIE_CANT, 10);

		PIE_TOTAL_VENC_1 = new java.math.BigDecimal( java.lang.String.valueOf(String(VENC_1)) ) ;
		PIE_TOTAL_VENC_1 = PIE_TOTAL_VENC_1.scaleByPowerOfTen(-2);

		PIE_TOTAL_VENC_2 = new java.math.BigDecimal( java.lang.String.valueOf(String(VENC_2)) ) ;
		PIE_TOTAL_VENC_2 = PIE_TOTAL_VENC_2.scaleByPowerOfTen(-2);

		// Validar igualdades y cantidades
		if ( PIE_TOTAL_VENC_1.compareTo(SUMA_VENC_1) )  {
			kaboom('Sumatoria de 1° Venc. Calculada [' + SUMA_VENC_1.toPlainString() + 
					"] distinta a sumatoria del Pie [" + PIE_TOTAL_VENC_1.toPlainString() + "]");
		};
		if ( PIE_TOTAL_VENC_2.compareTo(SUMA_VENC_2) )  {
			kaboom('Sumatoria de 2° Venc. Calculada [' + SUMA_VENC_2.toPlainString() + 
					"] distinta a sumatoria del Pie [" + PIE_TOTAL_VENC_2.toPlainString() + "]");
		};
		if (TIPO_REGISTRO_CANT != PIE_CANT) {
			kaboom('Cantidad de registros Calculados [' + TIPO_REGISTRO_CANT + 
					"] distinta a cantidad de registros del Pie [" + PIE_CANT + "]");
		}
	};
}


// Parsear parametros
CUIT_EMPRESA = parseInt(CUIT_EMPRESA, 10);
CONVENIO = parseInt(CONVENIO, 10);

// DESCARTA PIE Y CABECERA
if (tipo_reg == '1' || tipo_reg == '3') trans_Status = SKIP_TRANSFORMATION

EXT = '.'+EXT
SHORTNAME = SHORTNAME.replace(EXT, '');</jsScript_script>
      </jsScript>
      <jsScript>
        <jsScript_type>1</jsScript_type>
        <jsScript_name>Item_0</jsScript_name>
        <jsScript_script>LoadScriptFromTab('Util');

var CABECERA_CUIT = 0;
var CABECERA_PERIODO = '';

var PIE_REGISTROS_CANTIDAD = 0;
var PIE_TOTAL_VENC_1 = java.math.BigDecimal.ZERO;
var PIE_TOTAL_VENC_2 = java.math.BigDecimal.ZERO;

var TIPO_CABECERA_CANT = 0;
var TIPO_PIE_CANT = 0;
var TIPO_REGISTRO_CANT = 0;

var CONVENIO = getVariable('B_CONVENIO', '');
var CUIT_EMPRESA = getVariable('B_CUIT', '');
var PERIODO = getVariable('B_PERIODO', '');
PERIODO = parseDate(PERIODO, 'yyyy-MM');

var SUMA_VENC_1 = java.math.BigDecimal.ZERO;
var SUMA_VENC_2 = java.math.BigDecimal.ZERO;</jsScript_script>
      </jsScript>
      <jsScript>
        <jsScript_type>-1</jsScript_type>
        <jsScript_name>Util</jsScript_name>
        <jsScript_script>
const parseDate = function (date, format) {
  // Convierte parámetros a strings de javascript, en caso de que se hayan recibido strings de java.
  date = String(date)
  format = String(format)
 
  // Intenta parsear el string en el formato especificado. Si no puede hacerlo, retorna nulo.
  var parsedDate;
  try {
    parsedDate = str2date( date, format);
  } catch (ex) {
    return null;
  }
 
  // Convierte la fecha parseada de nuevo a string
  var reversedDate = date2str( parsedDate, format);
 
  // Si la fecha parseada y el string generado a partir de la fecha parseada son iguales,
  // entonces la fecha no generó problemas en el parseo.
  if ( reversedDate == date) {
    return parsedDate;
  } else {
    return null;
  }
}


const kaboom = function (message) {
	message = String(message);
	writeToLog('e', message);
	setVariable('Top.MSG', message, 'r');
	trans_Status = ERROR_TRANSFORMATION;
	_step_.setErrors(1);
	_step_.stopAll();
}
</jsScript_script>
      </jsScript>
      <jsScript>
        <jsScript_type>2</jsScript_type>
        <jsScript_name>Item_1</jsScript_name>
        <jsScript_script>//Script here

if (TIPO_CABECERA_CANT == 0) kaboom('Debe existir un registro tipo Cabecera.');
if (TIPO_PIE_CANT == 0) kaboom('Debe existir un registro tipo Pie.');
if (TIPO_REGISTRO_CANT == 0) kaboom('Debe existir al menos un registro tipo Detalle.'); </jsScript_script>
      </jsScript>
    </jsScripts>
    <fields>
      <field>
        <name>CUIT_EMPRESA</name>
        <rename>CUIT_EMPRESA</rename>
        <type>Integer</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>CONVENIO</name>
        <rename>CONVENIO</rename>
        <type>Integer</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>PERIODO</name>
        <rename>PERIODO</rename>
        <type>Date</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>PIE_REGISTROS_CANTIDAD</name>
        <rename>PIE_REGISTROS_CANTIDAD</rename>
        <type>Integer</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>PIE_TOTAL_VENC_1</name>
        <rename>PIE_TOTAL_VENC_1</rename>
        <type>BigNumber</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>PIE_TOTAL_VENC_2</name>
        <rename>PIE_TOTAL_VENC_2</rename>
        <type>BigNumber</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>DETALLE_VENC_1</name>
        <rename>DETALLE_VENC_1</rename>
        <type>BigNumber</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>DETALLE_VENC_2</name>
        <rename>DETALLE_VENC_2</rename>
        <type>BigNumber</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>TIPO_REGISTRO_CANT</name>
        <rename>DETALLE_REGISTRO_NUMERO</rename>
        <type>Integer</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>SHORTNAME</name>
        <rename>SHORTNAME</rename>
        <type>String</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>Y</replace>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>368</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Convenio existe? Corresponde a la empresa?</name>
    <type>DBJoin</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazDS</connection>
    <rowlimit>0</rowlimit>
    <sql>SELECT 
	TOP 1
	ccr.Id_ConvRec AS CONVENIO_ORDDEB, -- Nulo => Convenio sin orden debito contrato | No Nulo => Convenio correcto
	CASE
		WHEN ccr.Cuit = ? THEN Id_ConvRec
		ELSE NULL
	END AS CONVENIO_CORRECTO -- Nulo => El convenio es orden de débito pero no corresponde a la empresa | No Nulo => El convenio es orden de débito y es de la empresa
FROM CONV_CONVENIOS_REC ccr 
LEFT JOIN CONV_TIPOS ct ON ct.Id_TpoConv = ccr.Id_TpoConv AND ct.TpoContrato = 2 AND ct.TZ_LOCK = 0
WHERE ccr.Id_ConvRec = ? AND ccr.TZ_LOCK = 0</sql>
    <outer_join>Y</outer_join>
    <replace_vars>N</replace_vars>
    <parameter>
      <field>
        <name>PARAM_CUIT</name>
        <type>Integer</type>
      </field>
      <field>
        <name>PARAM_CONVENIO</name>
        <type>Integer</type>
      </field>
    </parameter>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2032</xloc>
      <yloc>400</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Copy rows to result</name>
    <type>RowsToResult</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2976</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Descarta campos</name>
    <type>SelectValues</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <select_unspecified>N</select_unspecified>
      <remove>
        <name>esUltimo</name>
      </remove>
      <remove>
        <name>tipo_reg</name>
      </remove>
      <remove>
        <name>reg</name>
      </remove>
      <remove>
        <name>EXT</name>
      </remove>
      <meta>
        <name>DETALLE_VENC_1</name>
        <rename>ORD_IMPORTE_PRIMER_VENC</rename>
        <type>BigNumber</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask>0.00</conversion_mask>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale/>
        <date_format_timezone/>
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding/>
        <decimal_symbol/>
        <grouping_symbol/>
        <currency_symbol/>
        <storage_type/>
      </meta>
      <meta>
        <name>DETALLE_VENC_2</name>
        <rename>ORD_IMPORTE_SEGUNDO_VENC</rename>
        <type>BigNumber</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask>0.00</conversion_mask>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale/>
        <date_format_timezone/>
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding/>
        <decimal_symbol/>
        <grouping_symbol/>
        <currency_symbol/>
        <storage_type/>
      </meta>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>640</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Empresa homologada? Tiene convenio ord deb?</name>
    <type>DBJoin</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazDS</connection>
    <rowlimit>0</rowlimit>
    <sql>select 
	TOP 1
	MAX(spe.CUIT_EO) AS EMPRESA_HOMOLOGADA, -- Nulo => No Homologada | No Nulo => Homologada
	MAX(ct.TpoContrato) AS EMPRESA_ORDDEB -- Nulo => Empresa sin convenio y homologada | No Nulo => Tiene convenio y está homologada
FROM SNP_PRESTACIONES_EMPRESAS spe
LEFT JOIN CONV_CONVENIOS_REC ccr ON ccr.Cuit = spe.CUIT_EO AND ccr.TZ_LOCK = 0 AND ccr.ESTADO = 'A'
LEFT JOIN CONV_TIPOS ct ON ct.Id_TpoConv = ccr.Id_TpoConv AND ct.TpoContrato = 2 AND ct.TZ_LOCK = 0
WHERE spe.CUIT_EO = ? AND spe.TZ_LOCK = 0</sql>
    <outer_join>Y</outer_join>
    <replace_vars>N</replace_vars>
    <parameter>
      <field>
        <name>PARAM_CUIT</name>
        <type>Integer</type>
      </field>
    </parameter>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2032</xloc>
      <yloc>304</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Encuentra duplicados</name>
    <type>UniqueRowsByHashSet</type>
    <description/>
    <distribute>N</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <store_values>N</store_values>
    <reject_duplicate_row>Y</reject_duplicate_row>
    <error_description>DUPLICADO</error_description>
    <fields>
      <field>
        <name>ORD_REF_DEBITO</name>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>1168</xloc>
      <yloc>768</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Espera informe</name>
    <type>BlockingStep</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <pass_all_rows>N</pass_all_rows>
    <directory>%%java.io.tmpdir%%</directory>
    <prefix>block</prefix>
    <cache_size>5000</cache_size>
    <compress>Y</compress>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2656</xloc>
      <yloc>896</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Filter rows</name>
    <type>FilterRows</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <send_true_to>Select values</send_true_to>
    <send_false_to>Informa bitacora</send_false_to>
    <compare>
      <condition>
        <negated>N</negated>
        <leftvalue>ERROR</leftvalue>
        <function>IS NULL</function>
        <rightvalue/>
      </condition>
    </compare>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2656</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Get variables</name>
    <type>GetVariable</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>FECHATOP</name>
        <variable>${FECHATOP}</variable>
        <type>Date</type>
        <format>yyyy-MM-dd</format>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>FYHACTTOP</name>
        <variable>${FYHACTTOP}</variable>
        <type>Date</type>
        <format>yyyy-MM-dd HH:mm:ss</format>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>FYHACTRELOJ</name>
        <variable>${FYHACTRELOJ}</variable>
        <type>Date</type>
        <format>yyyy-MM-dd HH:mm:ss</format>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>FECHATOP_F2</name>
        <variable>${FECHATOP_F2}</variable>
        <type>String</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>992</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Informa bitacora</name>
    <type>TableOutput</type>
    <description/>
    <distribute>N</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazDS</connection>
    <schema>dbo</schema>
    <table>OrdenDebitoLote_bitacora</table>
    <commit>1000</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>Y</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
      <field>
        <column_name>idLote</column_name>
        <stream_name>LOTEID</stream_name>
      </field>
      <field>
        <column_name>codigoError</column_name>
        <stream_name>COD_ERROR</stream_name>
      </field>
      <field>
        <column_name>descripcionError</column_name>
        <stream_name>ERROR</stream_name>
      </field>
      <field>
        <column_name>fecha_proceso</column_name>
        <stream_name>FYHACTTOP</stream_name>
      </field>
      <field>
        <column_name>fecha_reloj</column_name>
        <stream_name>FYHACTRELOJ</stream_name>
      </field>
      <field>
        <column_name>id</column_name>
        <stream_name>DETALLE_REGISTRO_NUMERO</stream_name>
      </field>
      <field>
        <column_name>idRegistro</column_name>
        <stream_name>ORD_ID_REGISTRO</stream_name>
      </field>
      <field>
        <column_name>codigoServicio</column_name>
        <stream_name>ORD_CODIGO_SERVICIO</stream_name>
      </field>
      <field>
        <column_name>nombreServicio</column_name>
        <stream_name>PRESTACION_CORRECTA</stream_name>
      </field>
      <field>
        <column_name>tipoDocumento</column_name>
        <stream_name>ORD_TIPO_DOC</stream_name>
      </field>
      <field>
        <column_name>numeroDocumento</column_name>
        <stream_name>ORD_NRO_DOC</stream_name>
      </field>
      <field>
        <column_name>cuit</column_name>
        <stream_name>ORD_CUIT</stream_name>
      </field>
      <field>
        <column_name>apellidoNombre</column_name>
        <stream_name>ORD_NOMBRE</stream_name>
      </field>
      <field>
        <column_name>cbu</column_name>
        <stream_name>ORD_CBU</stream_name>
      </field>
      <field>
        <column_name>codigoCliente</column_name>
        <stream_name>CERO</stream_name>
      </field>
      <field>
        <column_name>referenciaDebito</column_name>
        <stream_name>ORD_REF_DEBITO</stream_name>
      </field>
      <field>
        <column_name>fechaPrimerVencimiento</column_name>
        <stream_name>FECHA_VENC1</stream_name>
      </field>
      <field>
        <column_name>importePrimerVencimiento</column_name>
        <stream_name>ORD_IMPORTE_PRIMER_VENC</stream_name>
      </field>
      <field>
        <column_name>fechaSegundoVencimiento</column_name>
        <stream_name>FECHA_VENC2</stream_name>
      </field>
      <field>
        <column_name>importeSegundoVencimiento</column_name>
        <stream_name>ORD_IMPORTE_SEGUNDO_VENC</stream_name>
      </field>
      <field>
        <column_name>clientePagador</column_name>
        <stream_name>ORD_ID_CLIENTE</stream_name>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2656</xloc>
      <yloc>784</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>LOTEID</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazDS</connection>
    <sql>WITH LotesFiltrados AS (
    SELECT ID_ARCHIVO, CAST(SUBSTRING(ID_ARCHIVO, 4, LEN(ID_ARCHIVO) - 3) AS INT) AS Numero
    FROM snp_msg_cabezal
    WHERE ID_ARCHIVO LIKE 'DD-%' AND ISNUMERIC(SUBSTRING(ID_ARCHIVO, 4, LEN(ID_ARCHIVO) - 3)) = 1
),
MaximoLote AS (
    SELECT MAX(Numero) AS MaxNumero
    FROM LotesFiltrados
)
SELECT 
    COALESCE('DD-' + CAST(MaxNumero + 1 AS VARCHAR), 'DD-1') AS LOTEID,
	1 as LOTEID_KEY
FROM MaximoLote;</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2272</xloc>
      <yloc>480</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>MarcaUltimo</name>
    <type>DetectLastRow</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <resultfieldname>esUltimo</resultfieldname>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>224</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>OBTIENE LOTEID</name>
    <type>StreamLookup</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <from>parseLOTEID</from>
    <input_sorted>N</input_sorted>
    <preserve_memory>Y</preserve_memory>
    <sorted_list>Y</sorted_list>
    <integer_pair>N</integer_pair>
    <lookup>
      <key>
        <name>keyLOTEID</name>
        <field>LOTEID_KEY</field>
      </key>
      <value>
        <name>LOTEID</name>
        <rename>LOTEID</rename>
        <default>DD-0</default>
        <type>String</type>
      </value>
    </lookup>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2272</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Obtiene Detalle</name>
    <type>StringCut</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_CODIGO_SERVICIO</out_stream_name>
        <cut_from>17</cut_from>
        <cut_to>32</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_TIPO_DOC</out_stream_name>
        <cut_from>32</cut_from>
        <cut_to>34</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_NRO_DOC</out_stream_name>
        <cut_from>34</cut_from>
        <cut_to>49</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_CUIT</out_stream_name>
        <cut_from>49</cut_from>
        <cut_to>60</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_NOMBRE</out_stream_name>
        <cut_from>60</cut_from>
        <cut_to>90</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_CBU</out_stream_name>
        <cut_from>90</cut_from>
        <cut_to>112</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_ID_CLIENTE</out_stream_name>
        <cut_from>112</cut_from>
        <cut_to>134</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_ACCION</out_stream_name>
        <cut_from>135</cut_from>
        <cut_to>136</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_REF_DEBITO</out_stream_name>
        <cut_from>135</cut_from>
        <cut_to>150</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_FECHA_PRIMER_VENC</out_stream_name>
        <cut_from>150</cut_from>
        <cut_to>158</cut_to>
      </field>
      <field>
        <in_stream_name>reg</in_stream_name>
        <out_stream_name>ORD_FECHA_SEGUNDO_VENC</out_stream_name>
        <cut_from>168</cut_from>
        <cut_to>176</cut_to>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>512</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Ordena Duplicado</name>
    <type>SortRows</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <directory>%%java.io.tmpdir%%</directory>
    <prefix>out</prefix>
    <sort_size>1000000</sort_size>
    <free_memory/>
    <compress>N</compress>
    <compress_variable/>
    <unique_rows>N</unique_rows>
    <fields>
      <field>
        <name>UNICO_REFERENCIA_DEBITO</name>
        <ascending>Y</ascending>
        <case_sensitive>N</case_sensitive>
        <collator_enabled>N</collator_enabled>
        <collator_strength>0</collator_strength>
        <presorted>N</presorted>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>1504</xloc>
      <yloc>768</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Ordena Referencia Debito</name>
    <type>SortRows</type>
    <description/>
    <distribute>N</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <directory>%%java.io.tmpdir%%</directory>
    <prefix>out</prefix>
    <sort_size>1000000</sort_size>
    <free_memory/>
    <compress>N</compress>
    <compress_variable/>
    <unique_rows>N</unique_rows>
    <fields>
      <field>
        <name>ORD_REF_DEBITO</name>
        <ascending>Y</ascending>
        <case_sensitive>N</case_sensitive>
        <collator_enabled>N</collator_enabled>
        <collator_strength>0</collator_strength>
        <presorted>N</presorted>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>1168</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Parse Error Duplicado</name>
    <type>SelectValues</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>ORD_REF_DEBITO</name>
        <rename>UNICO_REFERENCIA_DEBITO</rename>
      </field>
      <select_unspecified>N</select_unspecified>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>1344</xloc>
      <yloc>768</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Parsea Fechas</name>
    <type>SelectValues</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <select_unspecified>N</select_unspecified>
      <meta>
        <name>ORD_FECHA_PRIMER_VENC</name>
        <rename>FECHA_VENC1</rename>
        <type>Date</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask>yyyy-MM-dd</conversion_mask>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale/>
        <date_format_timezone/>
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding/>
        <decimal_symbol/>
        <grouping_symbol/>
        <currency_symbol/>
        <storage_type/>
      </meta>
      <meta>
        <name>ORD_FECHA_SEGUNDO_VENC</name>
        <rename>FECHA_VENC2</rename>
        <type>Date</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask>yyyy-MM-dd</conversion_mask>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale/>
        <date_format_timezone/>
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding/>
        <decimal_symbol/>
        <grouping_symbol/>
        <currency_symbol/>
        <storage_type/>
      </meta>
      <meta>
        <name>DIA_HABIL_VENC1</name>
        <rename>DIA_HABIL_VENC1</rename>
        <type>Date</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask>yyyy-MM-dd</conversion_mask>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale/>
        <date_format_timezone/>
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding/>
        <decimal_symbol/>
        <grouping_symbol/>
        <currency_symbol/>
        <storage_type/>
      </meta>
      <meta>
        <name>DIA_HABIL_VENC2</name>
        <rename>DIA_HABIL_VENC2</rename>
        <type>Date</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask>yyyy-MM-dd</conversion_mask>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale/>
        <date_format_timezone/>
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding/>
        <decimal_symbol/>
        <grouping_symbol/>
        <currency_symbol/>
        <storage_type/>
      </meta>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>1904</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Periodo Correcto</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazDS</connection>
    <sql>SELECT 
	(SELECT 1 FROM SNP_SOPORTE_DEBITO_DIRECTO s 
		INNER JOIN SNP_MSG_CABEZAL c ON c.CUIT_EO = s.CUIT AND c.ID_ARCHIVO = s.LOTE_ID
		WHERE CONVENIO = TRY_CONVERT(NUMERIC(10,0),'${B_CONVENIO}')
		  AND PERIODO = TRY_CONVERT(NUMERIC(6, 0), REPLACE('${B_PERIODO}', '-', ''))
		  AND ESTADO &lt;&gt; 'AN'
	) AS CONVENIO_PERIODO_CORRECTO,
	TRY_CONVERT(NUMERIC(12,0), '${B_CONVENIO}') AS 'PARAM_CONVENIO',
	TRY_CONVERT(NUMERIC(12,0), '${B_CUIT}') AS 'PARAM_CUIT',
	'${B_PERIODO}' AS 'PARAM_PERIODO'</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>Y</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2032</xloc>
      <yloc>208</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Select values</name>
    <type>SelectValues</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>CUIT_EMPRESA</name>
      </field>
      <field>
        <name>CONVENIO</name>
      </field>
      <field>
        <name>PERIODO</name>
      </field>
      <field>
        <name>ORD_IMPORTE_PRIMER_VENC</name>
      </field>
      <field>
        <name>ORD_IMPORTE_SEGUNDO_VENC</name>
      </field>
      <field>
        <name>DETALLE_REGISTRO_NUMERO</name>
      </field>
      <field>
        <name>ORD_CODIGO_SERVICIO</name>
      </field>
      <field>
        <name>ORD_TIPO_DOC</name>
      </field>
      <field>
        <name>ORD_NRO_DOC</name>
      </field>
      <field>
        <name>ORD_CUIT</name>
      </field>
      <field>
        <name>ORD_NOMBRE</name>
      </field>
      <field>
        <name>ORD_CBU</name>
      </field>
      <field>
        <name>ORD_ID_CLIENTE</name>
      </field>
      <field>
        <name>ORD_ACCION</name>
      </field>
      <field>
        <name>ORD_REF_DEBITO</name>
      </field>
      <field>
        <name>FECHA_VENC1</name>
      </field>
      <field>
        <name>FECHA_VENC2</name>
      </field>
      <field>
        <name>ORD_ID_REGISTRO</name>
      </field>
      <field>
        <name>FECHATOP</name>
      </field>
      <field>
        <name>FYHACTTOP</name>
      </field>
      <field>
        <name>FYHACTRELOJ</name>
      </field>
      <field>
        <name>LOTEID</name>
      </field>
      <field>
        <name>COD_ERROR</name>
      </field>
      <field>
        <name>ERROR</name>
      </field>
      <field>
        <name>CERO</name>
      </field>
      <field>
        <name>PRESTACION_CORRECTA</name>
        <rename>ORD_PRESTACION</rename>
      </field>
      <select_unspecified>N</select_unspecified>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2816</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Text file input</name>
    <type>TextFileInput</type>
    <description/>
    <distribute>N</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <accept_filenames>N</accept_filenames>
    <passing_through_fields>N</passing_through_fields>
    <accept_field/>
    <accept_stepname/>
    <separator/>
    <enclosure/>
    <enclosure_breaks>N</enclosure_breaks>
    <escapechar/>
    <header>N</header>
    <nr_headerlines>1</nr_headerlines>
    <footer>N</footer>
    <nr_footerlines>1</nr_footerlines>
    <line_wrapped>N</line_wrapped>
    <nr_wraps>1</nr_wraps>
    <layout_paged>N</layout_paged>
    <nr_lines_per_page>80</nr_lines_per_page>
    <nr_lines_doc_header>0</nr_lines_doc_header>
    <noempty>Y</noempty>
    <include>N</include>
    <include_field/>
    <rownum>Y</rownum>
    <rownumByFile>N</rownumByFile>
    <rownum_field>NumeroRegistro</rownum_field>
    <format>DOS</format>
    <encoding>windows-1252</encoding>
    <length>Characters</length>
    <add_to_result_filenames>Y</add_to_result_filenames>
    <file>
      <name>${RCI}${NA}</name>
      <filemask/>
      <exclude_filemask/>
      <file_required>N</file_required>
      <include_subfolders>N</include_subfolders>
      <type>Fixed</type>
      <compression>None</compression>
    </file>
    <filters>
    </filters>
    <fields>
      <field>
        <name>tipo_reg</name>
        <type>String</type>
        <format>#</format>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <ifnull/>
        <position>0</position>
        <length>1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
      <field>
        <name>reg</name>
        <type>String</type>
        <format>#</format>
        <currency/>
        <decimal/>
        <group/>
        <nullif/>
        <ifnull/>
        <position>0</position>
        <length>201</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
        <repeat>N</repeat>
      </field>
    </fields>
    <limit>0</limit>
    <error_ignored>N</error_ignored>
    <skip_bad_files>N</skip_bad_files>
    <file_error_field/>
    <file_error_message_field/>
    <error_line_skipped>N</error_line_skipped>
    <error_count_field/>
    <error_fields_field/>
    <error_text_field/>
    <bad_line_files_destination_directory/>
    <bad_line_files_extension>warning</bad_line_files_extension>
    <error_line_files_destination_directory/>
    <error_line_files_extension>error</error_line_files_extension>
    <line_number_files_destination_directory/>
    <line_number_files_extension>line</line_number_files_extension>
    <date_format_lenient>N</date_format_lenient>
    <date_format_locale>en_US</date_format_locale>
    <shortFileFieldName>SHORTNAME</shortFileFieldName>
    <pathFieldName/>
    <hiddenFieldName/>
    <lastModificationTimeFieldName/>
    <uriNameFieldName/>
    <rootUriNameFieldName/>
    <extensionFieldName>EXT</extensionFieldName>
    <sizeFieldName/>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>64</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Une</name>
    <type>JoinRows</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <directory>%%java.io.tmpdir%%</directory>
    <prefix>out</prefix>
    <cache_size>500</cache_size>
    <main>Parsea Fechas</main>
    <compare>
      <condition>
        <negated>N</negated>
        <leftvalue/>
        <function>=</function>
        <rightvalue/>
      </condition>
    </compare>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2032</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Une con duplicados</name>
    <type>StreamLookup</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <from>Ordena Duplicado</from>
    <input_sorted>N</input_sorted>
    <preserve_memory>Y</preserve_memory>
    <sorted_list>Y</sorted_list>
    <integer_pair>N</integer_pair>
    <lookup>
      <key>
        <name>ORD_REF_DEBITO</name>
        <field>UNICO_REFERENCIA_DEBITO</field>
      </key>
      <value>
        <name>UNICO_REFERENCIA_DEBITO</name>
        <rename>UNICO_REFERENCIA_DEBITO</rename>
        <default/>
        <type>String</type>
      </value>
    </lookup>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>1504</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Valida Prestacion</name>
    <type>DBJoin</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazDS</connection>
    <rowlimit>0</rowlimit>
    <sql>SELECT
	ccr.Id_ConvRec AS 'CONVENIO_PRESTACION', -- Convenio = 0 o NULL: Inválido 
	spe.PRESTACION AS 'PRESTACION_CORRECTA'
FROM SNP_PRESTACIONES_EMPRESAS spe
LEFT JOIN CONV_CONVENIOS_REC ccr ON ccr.Id_ConvRec = spe.ID_CONVENIO AND ccr.TZ_LOCK = 0
WHERE spe.ID_CONVENIO = ?</sql>
    <outer_join>Y</outer_join>
    <replace_vars>Y</replace_vars>
    <parameter>
      <field>
        <name>PARAM_CONVENIO</name>
        <type>Integer</type>
      </field>
    </parameter>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2032</xloc>
      <yloc>480</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Valida set datos &amp; set Variables</name>
    <type>ScriptValueMod</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <compatible>N</compatible>
    <optimizationLevel>9</optimizationLevel>
    <jsScripts>
      <jsScript>
        <jsScript_type>0</jsScript_type>
        <jsScript_name>Script 1</jsScript_name>
        <jsScript_script>//Script here
var CERO = 0;
var COD_ERROR = 0;
var ERROR = null;

// Guardo en variable global fechas de primer y segundo vencimiento, de la primera fila.
if (firstRow != null) {
	firstRow = null;
	firstDate = FECHA_VENC1;
	secondDate = FECHA_VENC2;
};


if (dateDiff(firstDate, FECHA_VENC1, 'd')!=0) {
	COD_ERROR = 28;
	ERROR = 'Fecha primer vencimiento debe ser igual en todo el lote';
} else if (dateDiff(secondDate, FECHA_VENC2, 'd')!=0) {
	COD_ERROR = 29;
	ERROR = 'Fecha segundo vencimiento debe ser igual en todo el lote';
} else if (CONVENIO_PERIODO_CORRECTO == 1) {
	COD_ERROR = 27;
	ERROR = 'Un lote ya fué procesado segun convenio y periodo recibidos';
}  else if (UNICO_REFERENCIA_DEBITO != null) {
	COD_ERROR = 26;
	ERROR = 'Código refencia débito debe ser único en el lote';
} else if (EMPRESA_HOMOLOGADA == null) {
	COD_ERROR = 10;
	ERROR = 'Empresa No Homologada';
} else if (CONVENIO_ORDDEB == null) {
	COD_ERROR = 11;
	ERROR = 'No existe Convenio Débito Directo';
} else if (CONVENIO_CORRECTO == null) {
	COD_ERROR = 12;
	ERROR = 'Convenio no relacionado a empresa';
} else if (EMPRESA_ORDDEB == null) {
	COD_ERROR = 13;
	ERROR = 'Empresa sin Convenio Débito Directo';
} else if (PRESTACION_CORRECTA == null) {
	COD_ERROR = 14;
	ERROR = 'No existe Prestación Débito Directo';
} else if (CONVENIO_PRESTACION == 0 || CONVENIO_PRESTACION == null) {
	COD_ERROR = 15;
	ERROR = 'Convenio no asignado a una prestación';
} else if (dateDiff(FECHA_VENC1, DIA_HABIL_VENC1, 'd') != 0) {
	COD_ERROR = 16;
	ERROR = 'La fecha del primer vencimiento no es dia hábil';
} else if (VENCIMIENTO_DOS_DIAS == null) {
	COD_ERROR = 17;
	ERROR = 'La fecha del primer vencimiento debe ser 2 días hábiles posterior a fecha proceso';
} else if (dateDiff(FECHA_VENC2, DIA_HABIL_VENC2, 'd') != 0) {
	COD_ERROR = 18;
	ERROR = 'La fecha del segundo vencimiento no es hábil';
} else if (VENCIMIENTO_SIETE_DIAS == null) {
	COD_ERROR = 19;
	ERROR = 'La fecha del segundo vencimiento debe ser 7 días hábiles posterior a fecha primer vencimiento';
} else if (VENCIMIENTO_TRECE_MESES == null) {
	COD_ERROR = 25;
	ERROR = 'La fecha del primer vencimiento no puede superar por 13 meses a fecha proceso';
} 

var CERO = 0;
var errorCancelatorio = mapaErrorCancelatorio[COD_ERROR];
var msg_lote = 'Id Lote: ['+LOTEID+'] - ';

var PERIODO_INT = parseInt(date2str(PERIODO, 'yyyyMM'), 10);

if (CANCELATORIO == null) {

	if (errorCancelatorio == 'C') {
		COD_RETORNO = COD_ERROR;
		DESC_MENSAJE = msg_lote+ERROR;
		CANCELATORIO = errorCancelatorio;
	}
	else if (ERROR != null) {
		COD_RETORNO = 99;
		DESC_MENSAJE = msg_lote+'Existen errores en ordenes individuales: '+ERROR;
	};

};


</jsScript_script>
      </jsScript>
      <jsScript>
        <jsScript_type>1</jsScript_type>
        <jsScript_name>Item_0</jsScript_name>
        <jsScript_script>//Script here
var COD_RETORNO = 0;
var DESC_MENSAJE = '';

var firstRow = 'yes';
var firstDate = '';
var secondDate = '';

var FECHA_PROCESO = str2date(getVariable('FECHATOP', ''), 'yyyy-MM-dd');
var CANCELATORIO = null;
mapaErrorCancelatorio = {
	10: 'C',
	11: 'C',
	12: 'C',
	13: 'C',
	14: 'C',
	15: 'C',
	20: 'C',
	21: 'C',
	22: 'C',
	23: 'C',
	24: 'C',
	27: 'C',
	28: 'C',
	29: 'C'
}</jsScript_script>
      </jsScript>
      <jsScript>
        <jsScript_type>2</jsScript_type>
        <jsScript_name>Item_1</jsScript_name>
        <jsScript_script>//Script here

if (DESC_MENSAJE != '') {
	writeToLog('e', DESC_MENSAJE);
	setVariable('Top.MSG', DESC_MENSAJE, 'r');
};


setVariable('B_LOTEID', LOTEID, 'r');
setVariable('B_PERIODO_INT', PERIODO_INT, 'r');
setVariable('B_CONVENIO_INT', CONVENIO, 'r');
</jsScript_script>
      </jsScript>
    </jsScripts>
    <fields>
      <field>
        <name>COD_ERROR</name>
        <rename>COD_ERROR</rename>
        <type>Integer</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>ERROR</name>
        <rename>ERROR</rename>
        <type>String</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>CERO</name>
        <rename>CERO</rename>
        <type>Integer</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2464</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Validar tipo de datos DETALLE</name>
    <type>ScriptValueMod</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <compatible>N</compatible>
    <optimizationLevel>9</optimizationLevel>
    <jsScripts>
      <jsScript>
        <jsScript_type>0</jsScript_type>
        <jsScript_name>Script 1</jsScript_name>
        <jsScript_script>//Script here
ERROR = '';

ORD_ID_REGISTRO++

// MAPEA TIPO DOCUMENTO
ORD_TIPO_DOC = mapTipoDoc[String(ORD_TIPO_DOC)];
if ( ORD_TIPO_DOC == null )  ORD_TIPO_DOC = 'DNI';

// Parse fechas
ORD_FECHA_PRIMER_VENC = parseDate(ORD_FECHA_PRIMER_VENC, 'yyyyMMdd');
ORD_FECHA_SEGUNDO_VENC = parseDate(ORD_FECHA_SEGUNDO_VENC, 'yyyyMMdd');

// Encuentra errores
if ( isNaN(ORD_CODIGO_SERVICIO) ) errrors.push('Código de servicio inválido');
if ( ORD_TIPO_DOC == null )  errors.push('Tipo documento inválido');
if ( isNaN(ORD_NRO_DOC) ) errors.push('Número documento inválido');
if ( isNaN(ORD_CUIT) ) errors.push('Cuit inválido'); 
if ( isNaN(ORD_CBU) ) errors.push('CBU inválido');
if ( isNaN(ORD_ID_CLIENTE) ) errors.push('ID_CLIENTE [CLIENTE PAGADOR] inválido');
if ( !ORD_FECHA_PRIMER_VENC ) errors.push('Fecha PRIMER vencimiento inválida');
if ( !ORD_FECHA_SEGUNDO_VENC ) errors.push('Fecha SEGUNDO vencimiento inválida');

if (errors.length != 0) {

	ERROR = 'ERROR en Registro N° '+NumeroRegistro+': '+errors.join(' | ');
	kaboom(ERROR);
}</jsScript_script>
      </jsScript>
      <jsScript>
        <jsScript_type>1</jsScript_type>
        <jsScript_name>Item_0</jsScript_name>
        <jsScript_script>//Script here
LoadScriptFromTab('Util');

var ORD_ID_REGISTRO = 0;

mapTipoDoc = {
	'89': 'LE',
	'90': 'LC',
	'96': 'DNI',
	'DNI': 'DNI',
	'LE': 'LE',
	'LC': 'LC'
}

errors = [];

</jsScript_script>
      </jsScript>
      <jsScript>
        <jsScript_type>-1</jsScript_type>
        <jsScript_name>Util</jsScript_name>
        <jsScript_script>//Script here


const parseDate = function (date, format) {
  // Convierte parámetros a strings de javascript, en caso de que se hayan recibido strings de java.
  date = String(date)
  format = String(format)
 
  // Intenta parsear el string en el formato especificado. Si no puede hacerlo, retorna nulo.
  var parsedDate;
  try {
    parsedDate = str2date( date, format);
  } catch (ex) {
    return null;
  }
 
  // Convierte la fecha parseada de nuevo a string
  var reversedDate = date2str( parsedDate, format);
 
  // Si la fecha parseada y el string generado a partir de la fecha parseada son iguales,
  // entonces la fecha no generó problemas en el parseo.
  if ( reversedDate == date) {
    return parsedDate;
  } else {
    return null;
  }
}


const kaboom = function (message) {
	message = String(message);
	writeToLog('e', message);
	setVariable('Top.MSG', message, 'r');
	trans_Status = ERROR_TRANSFORMATION;
	_step_.setErrors(1);
	_step_.stopAll();
}
</jsScript_script>
      </jsScript>
    </jsScripts>
    <fields>
      <field>
        <name>ORD_FECHA_PRIMER_VENC</name>
        <rename>ORD_FECHA_PRIMER_VENC</rename>
        <type>Date</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>Y</replace>
      </field>
      <field>
        <name>ORD_FECHA_SEGUNDO_VENC</name>
        <rename>ORD_FECHA_SEGUNDO_VENC</rename>
        <type>Date</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>Y</replace>
      </field>
      <field>
        <name>ORD_ID_REGISTRO</name>
        <rename>ORD_ID_REGISTRO</rename>
        <type>Integer</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>N</replace>
      </field>
      <field>
        <name>ORD_TIPO_DOC</name>
        <rename>ORD_TIPO_DOC</rename>
        <type>String</type>
        <length>-1</length>
        <precision>-1</precision>
        <replace>Y</replace>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>816</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Vencimientos son dias habiles?</name>
    <type>DBJoin</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>TopazDS</connection>
    <rowlimit>0</rowlimit>
    <sql>DECLARE @fechaProceso DATE = ?
DECLARE @fechaPrimerVencimiento DATE = ?
DECLARE @fechaSegundoVencimiento DATE = ?
DECLARE @fechaTreceMeses DATE = dbo.DiaHabil(DATEADD(month, 13, @fechaProceso),'A')
DECLARE @fechaDosdias DATE = dbo.AgregarDiasHabiles(@fechaProceso, 2)
DECLARE @fechaSieteDias DATE = dbo.AgregarDiasHabiles(@fechaPrimerVencimiento, 7)
SELECT 
	TOP 1
	(SELECT CAST(dbo.diaHabil(@fechaPrimerVencimiento,'A') AS DATE)) AS DIA_HABIL_VENC1, -- Primer dia habil igual o posterior a la fecha de vencimiento
	(SELECT CAST(dbo.diaHabil(@fechaSegundoVencimiento,'A') AS DATE)) AS DIA_HABIL_VENC2,
    (CASE WHEN @fechaPrimerVencimiento &lt;= @fechaTreceMeses THEN 'OK' ELSE NULL END) AS VENCIMIENTO_TRECE_MESES, --NULL: ERROR
    (CASE WHEN @fechaPrimerVencimiento >= @fechaDosdias THEN 'OK' ELSE NULL END) AS VENCIMIENTO_DOS_DIAS, --NULL: ERROR
    (CASE WHEN @fechaSegundoVencimiento >= @fechaSieteDias THEN 'OK' ELSE NULL END) AS VENCIMIENTO_SIETE_DIAS, -- NULL: ERROR
    MAX(spe.PRESTACION) AS PRESTACION_CORRECTA   -- Nulo => No existe prestacion para la empresa | No Nulo => Existe prestacion para la empresa
FROM SNP_PRESTACIONES_EMPRESAS spe
WHERE CUIT_EO = ? --spe.PRESTACION = ? AND
</sql>
    <outer_join>Y</outer_join>
    <replace_vars>N</replace_vars>
    <parameter>
      <field>
        <name>FECHATOP</name>
        <type>Date</type>
      </field>
      <field>
        <name>ORD_FECHA_PRIMER_VENC</name>
        <type>Date</type>
      </field>
      <field>
        <name>ORD_FECHA_SEGUNDO_VENC</name>
        <type>Date</type>
      </field>
      <field>
        <name>CUIT_EMPRESA</name>
        <type>Integer</type>
      </field>
    </parameter>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>1712</xloc>
      <yloc>672</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Write to log</name>
    <type>WriteToLog</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <loglevel>log_level_error</loglevel>
    <displayHeader>Y</displayHeader>
    <limitRows>N</limitRows>
    <limitRowsNumber>0</limitRowsNumber>
    <logmessage/>
    <fields>
      <field>
        <name>ERROR_DESCRIPCION</name>
      </field>
      <field>
        <name>ERROR_FIELDNAME</name>
      </field>
      <field>
        <name>CUIT_EMPRESA</name>
      </field>
      <field>
        <name>CONVENIO</name>
      </field>
      <field>
        <name>PERIODO</name>
      </field>
      <field>
        <name>PIE_REGISTROS_CANTIDAD</name>
      </field>
      <field>
        <name>PIE_TOTAL_VENC_1</name>
      </field>
      <field>
        <name>PIE_TOTAL_VENC_2</name>
      </field>
      <field>
        <name>ORD_IMPORTE_PRIMER_VENC</name>
      </field>
      <field>
        <name>ORD_IMPORTE_SEGUNDO_VENC</name>
      </field>
      <field>
        <name>DETALLE_REGISTRO_NUMERO</name>
      </field>
      <field>
        <name>ORD_CODIGO_SERVICIO</name>
      </field>
      <field>
        <name>ORD_TIPO_DOC</name>
      </field>
      <field>
        <name>ORD_NRO_DOC</name>
      </field>
      <field>
        <name>ORD_CUIT</name>
      </field>
      <field>
        <name>ORD_NOMBRE</name>
      </field>
      <field>
        <name>ORD_CBU</name>
      </field>
      <field>
        <name>ORD_ID_CLIENTE</name>
      </field>
      <field>
        <name>ORD_ACCION</name>
      </field>
      <field>
        <name>ORD_REF_DEBITO</name>
      </field>
      <field>
        <name>FECHA_VENC1</name>
      </field>
      <field>
        <name>FECHA_VENC2</name>
      </field>
      <field>
        <name>ORD_ID_REGISTRO</name>
      </field>
      <field>
        <name>FECHATOP</name>
      </field>
      <field>
        <name>FYHACTTOP</name>
      </field>
      <field>
        <name>FYHACTRELOJ</name>
      </field>
      <field>
        <name>UNICO_REFERENCIA_DEBITO</name>
      </field>
      <field>
        <name>DIA_HABIL_VENC1</name>
      </field>
      <field>
        <name>DIA_HABIL_VENC2</name>
      </field>
      <field>
        <name>VENCIMIENTO_TRECE_MESES</name>
      </field>
      <field>
        <name>VENCIMIENTO_DOS_DIAS</name>
      </field>
      <field>
        <name>VENCIMIENTO_SIETE_DIAS</name>
      </field>
      <field>
        <name>PRESTACION_CORRECTA</name>
      </field>
      <field>
        <name>CONVENIO_PERIODO_CORRECTO</name>
      </field>
      <field>
        <name>EMPRESA_HOMOLOGADA</name>
      </field>
      <field>
        <name>EMPRESA_ORDDEB</name>
      </field>
      <field>
        <name>CONVENIO_ORDDEB</name>
      </field>
      <field>
        <name>CONVENIO_CORRECTO</name>
      </field>
      <field>
        <name>CONVENIO_PRESTACION</name>
      </field>
      <field>
        <name>COD_ERROR</name>
      </field>
      <field>
        <name>ERROR</name>
      </field>
      <field>
        <name>COD_RETORONO</name>
      </field>
      <field>
        <name>DESC_MENSAJE</name>
      </field>
      <field>
        <name>CERO</name>
      </field>
      <field>
        <name>LOTEID</name>
      </field>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2816</xloc>
      <yloc>784</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>flujo vacio</name>
    <type>DetectEmptyStream</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>64</xloc>
      <yloc>768</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>parse Core</name>
    <type>SelectValues</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>CONVENIO_PERIODO_CORRECTO</name>
      </field>
      <field>
        <name>EMPRESA_HOMOLOGADA</name>
      </field>
      <field>
        <name>EMPRESA_ORDDEB</name>
      </field>
      <field>
        <name>CONVENIO_ORDDEB</name>
      </field>
      <field>
        <name>CONVENIO_CORRECTO</name>
      </field>
      <field>
        <name>CONVENIO_PRESTACION</name>
      </field>
      <select_unspecified>N</select_unspecified>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2032</xloc>
      <yloc>576</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>parseLOTEID</name>
    <type>SelectValues</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <select_unspecified>N</select_unspecified>
      <meta>
        <name>LOTEID</name>
        <rename>LOTEID</rename>
        <type>String</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask/>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale/>
        <date_format_timezone/>
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding/>
        <decimal_symbol/>
        <grouping_symbol/>
        <currency_symbol/>
        <storage_type/>
      </meta>
      <meta>
        <name>LOTEID_KEY</name>
        <rename>LOTEID_KEY</rename>
        <type>Integer</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask/>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale/>
        <date_format_timezone/>
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding/>
        <decimal_symbol/>
        <grouping_symbol/>
        <currency_symbol/>
        <storage_type/>
      </meta>
    </fields>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>2272</xloc>
      <yloc>560</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
    <error>
      <source_step>Encuentra duplicados</source_step>
      <target_step>Parse Error Duplicado</target_step>
      <is_enabled>Y</is_enabled>
      <nr_valuename/>
      <descriptions_valuename/>
      <fields_valuename/>
      <codes_valuename/>
      <max_errors/>
      <max_pct_errors/>
      <min_pct_rows/>
    </error>
    <error>
      <source_step>Informa bitacora</source_step>
      <target_step>Write to log</target_step>
      <is_enabled>Y</is_enabled>
      <nr_valuename/>
      <descriptions_valuename/>
      <fields_valuename/>
      <codes_valuename/>
      <max_errors/>
      <max_pct_errors/>
      <min_pct_rows/>
    </error>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes/>
</transformation>
