CREATE  OR ALTER  PROCEDURE [dbo].[SP_ITF_CAJA_MUNICIPAL] @formato AS VARCHAR(20), @fch_proceso AS VARCHAR(8), @nomArchivo AS VARCHAR(15), @ticket AS VARCHAR(15)
AS
BEGIN
	--------------- DECLARO VRIABLES --------------- 						
	DECLARE @tabla NUMERIC(5,0) = 0;
	DECLARE @nro_ayuda NUMERIC(5,0) = 0;
	DECLARE @codEnte VARCHAR(15);
	DECLARE @convenio VARCHAR(15);
	DECLARE @convenioPadre VARCHAR(15);	
	DECLARE @descrEnte VARCHAR(50);
	DECLARE @CargoEspec NUMERIC(15,2);
	DECLARE @ID_CABEZAL NUMERIC(15,0) = 0;
	DECLARE @ID_LINEA NUMERIC(15,0) = 0;
	DECLARE @TZ_LOCK NUMERIC(15,0) = 0;
	DECLARE @TOT_IMPORTE NUMERIC(15,2);
	DECLARE @TOT_CARGO_ESPEC NUMERIC(15,2);
	
	DECLARE @CADENA_01 VARCHAR(100);
	DECLARE @CADENA_02 VARCHAR(100);
	DECLARE @CADENA_03 VARCHAR(100);
	DECLARE @CADENA_04 VARCHAR(100);
	DECLARE @CADENA_05 VARCHAR(100);
	DECLARE @CADENA_06 VARCHAR(100);
	DECLARE @CADENA_07 VARCHAR(100);				
	DECLARE @CADENA_08 VARCHAR(100);
	DECLARE @CADENA_09 VARCHAR(100);
	DECLARE @CADENA_10 VARCHAR(100);
	DECLARE @CADENA_11 VARCHAR(100);
	DECLARE @CADENA_12 VARCHAR(100);
	DECLARE @CADENA_13 VARCHAR(100);
	DECLARE @CADENA_14 VARCHAR(100);
	DECLARE @CADENA_15 VARCHAR(100);
	DECLARE @NRO_01 NUMERIC(15,2);
	DECLARE @NRO_02 NUMERIC(15,2);
	DECLARE @NRO_03 NUMERIC(15,2);
	DECLARE @NRO_04 NUMERIC(15,2);
	DECLARE @NRO_05 NUMERIC(15,2);
	DECLARE @NRO_06 NUMERIC(15,2);
	DECLARE @NRO_07 NUMERIC(15,2);
	DECLARE @NRO_08 NUMERIC(15,2);
	DECLARE @NRO_09 NUMERIC(15,2);
	DECLARE @NRO_10 NUMERIC(15,2);
	DECLARE @NRO_11 NUMERIC(15,2);
	DECLARE @FECHA_01 DATETIME;
	
	DECLARE @CANT_REG NUMERIC(10,0) = 0;
	DECLARE @FechaCarga DATETIME;
	------------------------------------------------		
	
	IF @formato = 'CM01'
	BEGIN
		DECLARE cursor_ayuda cursor FOR
			SELECT DISTINCT cadena_03 FROM REC_EXT_RECAUDOS_CANAL ext 
				JOIN conv_rel_enteconv conv ON conv.COD_ENTE = ext.CADENA_03
				 	WHERE ext.FORMATO = @formato AND ext.FECHA = @fch_proceso AND ext.ID_CABEZAL = @ticket AND ext.NRO_11 = 0 AND conv.TZ_LOCK = 0 ;
		
		OPEN cursor_ayuda;
		FETCH NEXT FROM cursor_ayuda INTO @codEnte
		
		WHILE @@fetch_status = 0 
		BEGIN		
			SET @convenio = (SELECT TOP 1 ID_CONVREC FROM CONV_REL_ENTECONV WHERE TZ_LOCK = 0 AND COD_ENTE = CAST(CAST(@codEnte AS INT) AS VARCHAR))
			SET @descrEnte =(SELECT TOP 1 DESC_ENTE FROM CONV_REL_ENTECONV WHERE TZ_LOCK = 0 AND COD_ENTE = CAST(CAST(@codEnte AS INT) AS VARCHAR))
			SET @ID_CABEZAL = ( SELECT (ISNULL(max(ID),0)+1) AS MAX_ID FROM REC_CAB_RECAUDOS_CANAL );
			SET @FechaCarga = (SELECT fechaproceso FROM PARAMETROS);
			
			DECLARE cursor_convenios cursor FOR
				SELECT CADENA_01, CADENA_02, CADENA_03, CADENA_04, CADENA_05, CADENA_06, CADENA_07, 
				CADENA_08, CADENA_09, CADENA_10, CADENA_11, CADENA_12, CADENA_14, NRO_01, NRO_02, NRO_03, NRO_04, 
				NRO_05, NRO_06, NRO_07, NRO_08, NRO_09, NRO_10, FECHA_01
				FROM REC_EXT_RECAUDOS_CANAL WHERE FORMATO= @formato AND FECHA= @fch_proceso AND CADENA_03= @codEnte  AND ID_CABEZAL = @ticket AND NRO_11 = 0 ;	
		
			OPEN cursor_convenios;
			
			SET @ID_LINEA = 0;
			SET @TOT_IMPORTE = 0;
			SET @TOT_CARGO_ESPEC = 0;
			
			FETCH NEXT FROM cursor_convenios INTO @CADENA_01,@CADENA_02,@CADENA_03,@CADENA_04,@CADENA_05,@CADENA_06,@CADENA_07,@CADENA_08,
			@CADENA_09,@CADENA_10,@CADENA_11,@CADENA_12,@CADENA_14,@NRO_01,@NRO_02,@NRO_03,@NRO_04,@NRO_05,@NRO_06,@NRO_07,@NRO_08,
			@NRO_09,@NRO_10,@FECHA_01
			
			INSERT INTO dbo.REC_CAB_RECAUDOS_CANAL (ID, ESTADO, ARCHIVO, CONVENIO, FECHACARGA, ID_LIQUIDACION, MONEDA, TOTALREGISTROS, TOTALIMPORTE, TZ_LOCK, TOTAL_CARGO_ESPECIFICO, NOMBRE,Fecha_Cobranza)
			VALUES (@ID_CABEZAL, 'I', @nomArchivo, @convenio, @FechaCarga, 0, 1, 0, 0, @TZ_LOCK, 0, @descrEnte,@FECHA_01);

			
			WHILE @@fetch_status = 0
			BEGIN
				
				SET @convenioPadre = (SELECT Id_ConvPadre FROM CONV_CONVENIOS_REC WHERE TZ_LOCK = 0 AND Id_ConvRec = @convenio)
				
				SET @CargoEspec = (SELECT TOTAL_CARGO_ESPECIFICO FROM CONV_PADRONES WHERE TZ_LOCK = 0 AND CONVENIO = @convenioPadre AND Nro_Comprobante_Cliente = @CADENA_05 AND ESTADO = 'P')
				
				UPDATE CONV_PADRONES set Estado = 'C' WHERE TZ_LOCK = 0 AND CONVENIO = @convenioPadre AND Nro_Comprobante_Cliente = @CADENA_05 AND ESTADO = 'P'
					
				SET @ID_LINEA = @ID_LINEA + 1;
				SET @TOT_IMPORTE = @TOT_IMPORTE + @NRO_02;
				SET @TOT_CARGO_ESPEC = @TOT_CARGO_ESPEC + @CargoEspec;
				
				INSERT INTO dbo.REC_DET_RECAUDOS_CANAL 
				(ID_CABEZAL, ID_LINEA, MONEDA, IMPORTE, CODIGO_BARRAS, CODIGO_BARRAS_RENDIDO, ESTADO, DETALLE_ESTADO, 
				TOTAL_CARGO_ESPECIFICO, TZ_LOCK, FECHA_COBRANZA, COMPROBANTE)
				VALUES (@ID_CABEZAL, @ID_LINEA, @NRO_06, @NRO_02, @CADENA_12, @CADENA_12, 'I', 'Ingresado', @CargoEspec, @TZ_LOCK,@FECHA_01,@CADENA_05);
				
			    FETCH NEXT FROM cursor_convenios INTO @CADENA_01,@CADENA_02,@CADENA_03,@CADENA_04,@CADENA_05,@CADENA_06,@CADENA_07,@CADENA_08,
				@CADENA_09,@CADENA_10,@CADENA_11,@CADENA_12,@CADENA_14,@NRO_01,@NRO_02,@NRO_03,@NRO_04,@NRO_05,@NRO_06,@NRO_07,@NRO_08,
				@NRO_09,@NRO_10,@FECHA_01
			END
			
			CLOSE cursor_convenios;
			DEALLOCATE cursor_convenios;
			
			UPDATE REC_CAB_RECAUDOS_CANAL SET TOTALREGISTROS = @ID_LINEA, TOTALIMPORTE = @TOT_IMPORTE, TOTAL_CARGO_ESPECIFICO = @TOT_CARGO_ESPEC WHERE ID = @ID_CABEZAL
					
			FETCH NEXT FROM cursor_ayuda INTO @codEnte	
		END 
		
		CLOSE cursor_ayuda;
		DEALLOCATE cursor_ayuda;
		
		--Seteo error en los registros que no tienen ente asociado
		UPDATE REC_EXT_RECAUDOS_CANAL SET cadena_15 = 'No existe ente.', nro_11 = 1 WHERE ID_CABEZAL = @ticket AND CADENA_03 NOT IN (SELECT cod_ente FROM CONV_REL_ENTECONV (nolock) WHERE TZ_LOCK = 0)

	END	  
	
	IF @formato = 'CM02'
	BEGIN
		SET @convenio = (SELECT NUMERICO FROM PARAMETROSGENERALES WHERE TZ_LOCK = 0 AND CODIGO = 303)
		SET @descrEnte = (SELECT NomConvRec FROM CONV_CONVENIOS_REC WHERE Id_ConvRec = @convenio AND TZ_LOCK = 0)
		SET @ID_CABEZAL = ( SELECT (ISNULL(max(ID),0)+1) AS MAX_ID FROM REC_CAB_RECAUDOS_CANAL );
		SET @CANT_REG = ( SELECT count(*) FROM REC_EXT_RECAUDOS_CANAL WHERE FORMATO= @formato AND FECHA= @fch_proceso );
		SET @TOT_IMPORTE = ( SELECT sum(NRO_07) FROM REC_EXT_RECAUDOS_CANAL WHERE FORMATO= @formato AND FECHA= @fch_proceso );
		
		INSERT INTO dbo.REC_CAB_RECAUDOS_CANAL (ID, ESTADO, ARCHIVO, CONVENIO, FECHACARGA, ID_LIQUIDACION, MONEDA, TOTALREGISTROS, TOTALIMPORTE, TZ_LOCK, TOTAL_CARGO_ESPECIFICO, NOMBRE)
			VALUES (@ID_CABEZAL, 'I', @nomArchivo, @convenio, @fch_proceso, 0, 1, @CANT_REG, @TOT_IMPORTE, @TZ_LOCK, 0, @descrEnte);
			
		DECLARE cursor_convenios_3 cursor FOR
			SELECT NRO_01, NRO_02, NRO_03, NRO_04, NRO_05, NRO_06, NRO_07, NRO_08, NRO_09, NRO_10, NRO_11, CADENA_01, CADENA_02, 
			CADENA_13, CADENA_14, CADENA_15, CADENA_03, CADENA_04, CADENA_05, CADENA_06, CADENA_07, CADENA_08, CADENA_09, 
			CADENA_10, CADENA_11, CADENA_12
			FROM REC_EXT_RECAUDOS_CANAL WHERE FORMATO= @formato AND FECHA= @fch_proceso;
		
		
		OPEN cursor_convenios_3;
		FETCH NEXT FROM cursor_convenios_3 INTO @NRO_01,@NRO_02,@NRO_03,@NRO_04,@NRO_05,@NRO_06,@NRO_07,@NRO_08,@NRO_09,@NRO_10,
		@NRO_11,@CADENA_01,@CADENA_02,@CADENA_13,@CADENA_14,@CADENA_15,@CADENA_03,@CADENA_04,@CADENA_05,@CADENA_06,@CADENA_07,@CADENA_08,
		@CADENA_09,@CADENA_10,@CADENA_11,@CADENA_12
		
		SET @ID_LINEA = 0;
		SET @TOT_IMPORTE = 0;
		
		WHILE @@fetch_status = 0 
			BEGIN
				
				--SET @ID_CABEZAL = ( SELECT (ISNULL(max(ID),0)+1) AS MAX_ID FROM REC_CAB_RECAUDOS_CANAL );	
				SET @ID_LINEA = @ID_LINEA + 1;
				--SET @TOT_IMPORTE = @TOT_IMPORTE + @NRO_07;
				
				INSERT INTO dbo.REC_DET_RECAUDOS_CANAL 
				(ID_CABEZAL, ID_LINEA, MONEDA, IMPORTE, CODIGO_BARRAS, CODIGO_BARRAS_RENDIDO, ESTADO, DETALLE_ESTADO, 
				TOTAL_CARGO_ESPECIFICO, TZ_LOCK, COMPROBANTE)
				VALUES (@ID_CABEZAL, @ID_LINEA, CAST(@CADENA_07 AS NUMERIC(4,0)), @NRO_07, @CADENA_12, @CADENA_12, 'I', 'Ingresado', 0, @TZ_LOCK, @CADENA_05);
				
				FETCH NEXT FROM cursor_convenios_3 INTO @NRO_01,@NRO_02,@NRO_03,@NRO_04,@NRO_05,@NRO_06,@NRO_07,@NRO_08,@NRO_09,@NRO_10,
				@NRO_11,@CADENA_01,@CADENA_02,@CADENA_13,@CADENA_14,@CADENA_15,@CADENA_03,@CADENA_04,@CADENA_05,@CADENA_06,@CADENA_07,@CADENA_08,
				@CADENA_09,@CADENA_10,@CADENA_11,@CADENA_12
				
			END
			
		CLOSE cursor_convenios_3;
		DEALLOCATE cursor_convenios_3;
	END
		 				
END
GO
