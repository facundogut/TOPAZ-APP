EXECUTE('
	IF OBJECT_ID (''dbo.VW_SNP_MSG_ORDENES'') IS NOT NULL
	DROP VIEW dbo.VW_SNP_MSG_ORDENES
')

EXECUTE('
	CREATE VIEW VW_SNP_MSG_ORDENES
	AS
	SELECT
		CONCAT('''''''',O.CBU) AS CBU,
		E.NOMBRE_EMPRESA,
		O.CUIT_EO,
		O.PRESTACION,
		CASE
			WHEN (SELECT NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO = 2) = LEFT(O.CBU, 3)
			THEN 
				CASE 
					WHEN SUBSTRING(O.CBU, 4,3) = ''000'' THEN SUBSTRING(O.CBU, 7, 1)
					WHEN SUBSTRING(O.CBU, 4,2) = ''00'' THEN SUBSTRING(O.CBU, 6, 2) 
					WHEN SUBSTRING(O.CBU, 4,1) = ''0'' THEN SUBSTRING(O.CBU, 5, 3)  
					ELSE SUBSTRING(O.CBU, 4, 4)  
				END
			ELSE '''' 
		END AS SUCURSAL,
		CASE 
			WHEN (SELECT NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO = 2) = LEFT(O.CBU, 3)
			THEN SUBSTRING(O.CBU, 11, 11)  
			ELSE '''' 
		END AS CUENTA,
		CASE 
			WHEN (SELECT NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO = 2) = LEFT(O.CBU, 3)
			THEN OT.DESCRIPCION 
			ELSE ''''
		END AS TIPO_CUENTA_DEBITADA,
		M.C6400 AS NOMBRE_MONEDA,
		LEFT(O.CBU, 3) AS BANCO,
		B.NOMBRE AS NOMBRE_BANCO,
		CONCAT('''''''',O.CLIENTE_PAGADOR) AS ID_CLIENTE_PAGADOR,
		CONCAT('''''''',O.REFERENCIA) AS REFERENCIA,
		O.PRESENTACION_PRIMER_VTO AS F_PRESENTACION_PRIMER_VTO,
		O.PRESENTACION_SEGUNDO_VTO AS F_PRESENTACION_SEGUNDO_VTO,
		O.FECHA_VENCIMIENTO,
		O.SEGUNDO_VTO AS FECHA_SEGUNDO_VTO,
		O.FECHA_COMPENSACION,
		O.IMPORTE AS IMPORTE_PRIMER_VTO,
		O.SEGUNDO_IMPORTE AS IMPORTE_SEGUNDO_VTO,
		OE.DESCRIPCION AS ESTADO_DEBITO,
		O.TIPO_DOCUMENTO AS TIPO_DOC_CLIENTE,
		O.NRO_DOCUMENTO AS DOCUMENTO_CLIENTE,
		O.ID_ARCHIVO,
		O.NRO_ARCHIVO,
		O.CORRELATIVO, 
		O.ID_ARCHIVO_REVERSADO,
		O.MOTIVO_RECHAZO,
		O.TIPO_REVERSA   
	FROM SNP_MSG_ORDENES AS O WITH (nolock)
	INNER JOIN SNP_MSG_CABEZAL AS C WITH (nolock) ON
		C.CUIT_EO = O.CUIT_EO
		AND C.ID_ARCHIVO = O.ID_ARCHIVO
		AND C.NRO_ARCHIVO = O.NRO_ARCHIVO
		AND ((C.TZ_LOCK < 100000000000000 OR C.TZ_LOCK >= 200000000000000)
		AND (C.TZ_LOCK < 300000000000000 OR C.TZ_LOCK >= 400000000000000)  
		)
	INNER JOIN SNP_PRESTACIONES_EMPRESAS AS E WITH (nolock) ON
		E.CUIT_EO = O.CUIT_EO
		AND E.PRESTACION = O.PRESTACION
		AND ((E.TZ_LOCK < 100000000000000 OR E.TZ_LOCK >= 200000000000000)
		AND (E.TZ_LOCK < 300000000000000 OR E.TZ_LOCK >= 400000000000000)  
		)
	INNER JOIN MONEDAS AS M WITH (nolock) ON
		M.C6399 = O.MONEDA
		AND ((M.TZ_LOCK < 100000000000000 OR M.TZ_LOCK >= 200000000000000)
		AND (M.TZ_LOCK < 300000000000000 OR M.TZ_LOCK >= 400000000000000)  
		)
	INNER JOIN OPCIONES AS OE WITH (nolock) ON
		OE.NUMERODECAMPO = 44613
		AND OE.IDIOMA = ''E''
		AND OE.OPCIONINTERNA = O.ESTADO
	LEFT JOIN CLI_BANCOSPLAZA AS B WITH (nolock) ON
		CONVERT(VARCHAR, 
			CASE 
				WHEN LEFT(O.CBU, 2) = ''00'' THEN SUBSTRING(O.CBU, 3, 1) 
				WHEN LEFT(O.CBU, 1) = ''0'' THEN SUBSTRING(O.CBU, 2, 2)  
				ELSE LEFT(O.CBU, 3)  
			END 
		) = CONVERT(VARCHAR, B.CODIGOBC)
		AND B.SUCURSAL = 0
		AND ((B.TZ_LOCK < 100000000000000 OR B.TZ_LOCK >= 200000000000000)
			AND (B.TZ_LOCK < 300000000000000 OR B.TZ_LOCK >= 400000000000000)
		)
	LEFT JOIN VTA_SALDOS AS V WITH (nolock) ON
		V.CTA_CBU = O.CBU
		AND ((V.TZ_LOCK < 100000000000000 OR V.TZ_LOCK >= 200000000000000)
		AND (V.TZ_LOCK < 300000000000000 OR V.TZ_LOCK >= 400000000000000)  
		)
	LEFT JOIN SALDOS AS S WITH (nolock) ON
		S.JTS_OID = V.JTS_OID_SALDO
		AND ((S.TZ_LOCK < 100000000000000 OR S.TZ_LOCK >= 200000000000000)
		AND (S.TZ_LOCK < 300000000000000 OR S.TZ_LOCK >= 400000000000000)  
		)
	LEFT JOIN OPCIONES AS OT WITH (nolock) ON
		OT.NUMERODECAMPO = 1785
		AND OT.IDIOMA = ''E''
		AND OT.OPCIONINTERNA = S.C1785
	WHERE
		O.TZ_LOCK = 0
')