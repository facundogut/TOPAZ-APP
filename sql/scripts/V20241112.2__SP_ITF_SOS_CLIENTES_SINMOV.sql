EXECUTE('
CREATE OR ALTER   PROCEDURE [dbo].[SP_ITF_SOS_CLIENTES_SINMOV]
	@Fecha VARCHAR(8)
AS
  DECLARE @FECHAPROCESO VARCHAR(8);
BEGIN

SELECT @FECHAPROCESO = CONVERT(VARCHAR,FECHAPROCESO,112) FROM PARAMETROS WITH (NOLOCK);

--Limpiamos por si hay reproceso
DELETE FROM SOS_CLIENTES_SINMOV WHERE convert(VARCHAR,FECHADEINFORMACION) = @FECHAPROCESO;

SELECT DISTINCT A.NROPERSFISICAJURIDICA
  INTO #TMP_PERSONAS_FJ
FROM SOS_VINCULACION A
  INNER JOIN CLI_DocumentosPFPJ B ON B.NUMEROPERSONAFJ = A.NROPERSFISICAJURIDICA
WHERE A.FECHADEINFORMACION = @FECHAPROCESO

/*
SELECT DISTINCT sa.c1803 AS CODCLIENTE 
  INTO #TMP_CLIENTES
FROM SALDOS sa
WHERE sa.C1604 <> 0
  AND sa.C1803 <> 0
  AND NOT EXISTS(SELECT 1 FROM SOS_MOVS_HISTORICOS smov WHERE smov.FECHADEINFORMACION = @Fecha AND smov.CODCLIENTE = sa.C1803)
  AND NOT EXISTS(SELECT 1 FROM SOS_VINCULACION svinc WHERE svinc.FECHADEINFORMACION = @Fecha AND svinc.CODCLIENTE = sa.C1803)
  AND sa.TZ_LOCK = 0
*/

INSERT INTO SOS_CLIENTES_SINMOV
--NATURAL
SELECT 
--1
''311'' AS EMPRESA,
--2
CONVERT(NUMERIC,@FECHAPROCESO) AS FECHADEINFORMACION,
--3
''11'' AS IDENTTRIBUTARIATIPO,
--4
CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS IDENTTRIBUTARIANUMERO,
--5
(CASE WHEN doc.TIPO_DOC_FISICO = ''DNI'' THEN ''01''
	WHEN doc.TIPO_DOC_FISICO = ''LE'' THEN ''02''
	WHEN doc.TIPO_DOC_FISICO = ''LC'' THEN ''03''
	WHEN doc.TIPO_DOC_FISICO = ''PAS'' THEN ''04''
	WHEN doc.TIPO_DOC_FISICO = ''CI'' THEN ''06''
	ELSE ''05''
END)AS DOCIDENTIFICATORIATIPO,
--6
CONVERT(NUMERIC,doc.NUM_DOC_FISICO) AS DOCIDENTIFICATORIANUMERO,
--7
SUBSTRING(((CASE WHEN APELLIDOPATERNO = '' '' THEN '''' ELSE APELLIDOPATERNO END) +
		(CASE WHEN APELLIDOMATERNO = '' '' THEN '''' ELSE '' '' + APELLIDOMATERNO END) + 
		(CASE WHEN PRIMERNOMBRE = '' '' THEN '''' ELSE '' '' + PRIMERNOMBRE END) +
		(CASE WHEN SEGUNDONOMBRE = '' '' THEN '''' ELSE '' '' + SEGUNDONOMBRE END)),1,55) AS DENOMINACION,
--8
SUBSTRING(dir.CALLE,1,55) AS DOMICILIOCALLE,
--9
dir.NUMERO AS DOMICILIONUMERO,
--10
RIGHT(ISNULL(dir.PISO,0),2) AS DOMICILIOPISO,
--11
dir.APARTAMENTO AS DOMICILIODPTOOFICINA,
--12
dir.CPA_VIEJO AS DOMICILIOCODIGOPOSTAL,
--13
--dir.LOCALIDAD AS DOMICILIOLOCALIDAD,
SUBSTRING(l.DESCRIPCION_DIM3,1,25) AS DOMICILIOLOCALIDAD,
--14
(SELECT ID_BCRA FROM CLI_PROVINCIAS x WHERE x.CODIGOPAIS = dir.PAIS AND x.DIM1 = dir.PROVINCIA) AS DOMICILIOPROVINCIA,
--15
ISNULL((SELECT x.CODIGOSWIFT FROM CLI_PAISES x WHERE x.CODIGOPAIS = dir.PAIS),''AR'') AS DOMICIOLIOPAISSWFIT,
--16
(SELECT cliact.CODIGO_BCRA FROM VW_SOS_ACT_ECO cliact	
WHERE cliact.CODIGO_PERSONA = cp.NUMEROPERSONA
  AND cliact.tipo_actividad = ''Primaria'') AS CODIGOACTIVIDAD,
--17
(SELECT TOP 1 cliact.CODIGO_BCRA FROM VW_SOS_ACT_ECO cliact	
WHERE cliact.CODIGO_PERSONA = cp.NUMEROPERSONA
  AND cliact.tipo_actividad = ''Secundaria'') AS CODIGOACTIVIDADSEC,
--18
(SELECT x.CODIGOSWIFT FROM CLI_PAISES x WHERE x.CODIGOPAIS = dir.PAIS)  AS RESIDENCIA,
--19
'''' AS CODIGOAREATEL,
--20
'''' AS CARACTERISTICATEL,
--21
'''' AS TELEFONO,
--22
'''' AS FAX,
--23
'''' AS TELEX,
--24
'''' AS EMAIL,
--25
nat.SEXO,
--26
(case when nat.ESTADOCIVIL = ''C'' THEN 2
	when nat.ESTADOCIVIL = ''D'' THEN 4
	when nat.ESTADOCIVIL = ''S'' THEN 1
	when nat.ESTADOCIVIL = ''U'' THEN 5
	when nat.ESTADOCIVIL = ''V'' THEN 3
END) AS ESTADOCIVIL,
--27
'''' AS CODIGOACTIVIDADINTERNO,
--28
convert(VARCHAR, nat.FECHAALTA, 112) AS FECHAALTA,
--29
'''' AS FECHABAJA,
--30
nat.SUC_ALTA,
--31
(SELECT x.CODIGOSWIFT FROM CLI_PAISES x WHERE x.CODIGOPAIS = nat.PAISNACIMIENTO) AS CODIGOPAIS,
--32
''PF'' AS TIPOCLIENTE,
--33
(CASE WHEN nat.EMPLEADO_BC_BANCO = ''1'' THEN ''N'' ELSE ''S'' END)  AS MARCAEMPLEADO,
--34
nat.INCLUIDO_PEP AS PEP,
--35
nat.SUJETO_UIF AS SUJETOOBLIGADO,
--36
isnull(nat.INSC_UIF,''N'') AS CONST_INSCRIP_SSOO,
--37
(SELECT cliact.CODIGO_ACT_AFIP FROM VW_SOS_ACT_ECO cliact	
  WHERE cliact.CODIGO_PERSONA = cp.NUMEROPERSONA
    AND cliact.tipo_actividad = ''Primaria'') AS CODIGOACTIVIDADAFIP,
--38
(SELECT TOP 1 cliact.CODIGO_ACT_AFIP FROM VW_SOS_ACT_ECO cliact	
  WHERE cliact.CODIGO_PERSONA = cp.NUMEROPERSONA
    AND cliact.tipo_actividad = ''Secundaria'') AS CODIGOACTIVIDADAFIPSEC,
--39
''00'' AS FORMAJURIDICA,
--40
nat.SECTOR AS SECTORBCRA,
--41
SUBSTRING((CASE WHEN APELLIDOPATERNO = '' '' THEN '''' ELSE APELLIDOPATERNO END) +
		  (CASE WHEN APELLIDOMATERNO = '' '' THEN '''' ELSE '' '' + APELLIDOMATERNO END),1,55) AS APELLIDO,
--42
SUBSTRING((CASE WHEN PRIMERNOMBRE = '' '' THEN '''' ELSE PRIMERNOMBRE END) +
		(CASE WHEN SEGUNDONOMBRE = '' '' THEN '''' ELSE '' '' + SEGUNDONOMBRE END),1,55) AS NOMBRE,
--43
'''' AS FECHACONSTITUCIONSOCIEDAD,
--44
nat.TIPO_SUJETO_UIF AS TIPOSSOO,
--45
nat.INSC_UIF AS DECJURSSOO,
--46
(CASE WHEN nat.IVA = ''AC'' THEN 1
	WHEN nat.IVA = ''EP'' THEN 8
	WHEN nat.IVA = ''EX'' THEN 4
	WHEN nat.IVA = ''NI'' THEN 3
END) AS CATEGORIAIVA,
--47
(CASE WHEN (SELECT COUNT(1) FROM PRODUCTOS pro 
              INNER JOIN SALDOS sa ON sa.PRODUCTO = pro.C6250
            WHERE pro.TIPO_CUENTA_VISTA = 7
              AND sa.C1803 = cli.CODIGOCLIENTE
              AND sa.C1651 <> ''1''
              AND sa.TZ_LOCK = 0
              AND pro.TZ_LOCK = 0) > 0 THEN ''Y'' ELSE ''N'' END)  AS MARCASUELDO,
--48
0 AS TAMANIOEMPRESA,
--49
'''' AS CLIMONTRIBIVA,
--
cli.CODIGOCLIENTE,
nat.NUMEROPERSONAFISICA
FROM /*CLI_CLIENTES cli (NOLOCK)
  INNER JOIN CLI_CLIENTEPERSONA cp (NOLOCK) ON cp.CODIGOCLIENTE = cli.CODIGOCLIENTE
  INNER JOIN*/ CLI_PERSONASFISICAS nat (NOLOCK) --ON nat.NUMEROPERSONAFISICA = cp.NUMEROPERSONA
  INNER JOIN CLI_DIRECCIONES dir (NOLOCK) ON dir.ID = nat.NUMEROPERSONAFISICA AND dir.FORMATO = ''PF'' AND dir.TIPODIRECCION = ''F''
    AND dir.ORDINAL_DIR = 1
  INNER JOIN CLI_DocumentosPFPJ doc (NOLOCK) ON doc.NUMEROPERSONAFJ = nat.NUMEROPERSONAFISICA
  LEFT JOIN CLI_LOCALIDADES l ON l.CODIGOPAIS = dir.PAIS AND l.DIM1 = dir.PROVINCIA AND l.DIM2 = dir.DEPARTAMENTO AND l.DIM3 = dir.LOCALIDAD
  LEFT JOIN VW_CLIENTE_PFPJ vfj ON vfj.NUMEROPERSONA = nat.NUMEROPERSONAFISICA
WHERE /*cli.TZ_LOCK = 0
  AND cp.TZ_LOCK = 0
  AND */ nat.TZ_LOCK = 0
  AND dir.TZ_LOCK = 0
  AND doc.TZ_LOCK = 0
  --AND cp.TITULARIDAD = ''T''
  AND NOT EXISTS(SELECT 1 FROM #TMP_PERSONAS_FJ x WHERE x.NROPERSFISICAJURIDICA = nat.NUMEROPERSONAFISICA)
  AND (nat.FALLECIDO = ''N'' OR (nat.FALLECIDO = ''S''
          AND NOT EXISTS(SELECT 1 FROM CLI_DOCUMENTOSPFPJ V WITH(NOLOCK)
                         WHERE V.NUMERODOCUMENTO = doc.NUMERODOCUMENTO AND V.TIPOPERSONA = ''J'')))
  
---JURIDICA
INSERT INTO SOS_CLIENTES_SINMOV
SELECT 
--1
''311'' AS EMPRESA,
--2
CONVERT(NUMERIC,@FECHAPROCESO) AS FECHADEINFORMACION,
--3
(CASE WHEN jur.TIPOSOCIEDAD IN (66,29) THEN jur.TIPOSOCIEDAD ELSE 11 END) AS IDENTTRIBUTARIATIPO,
--4
CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS IDENTTRIBUTARIANUMERO,
--5
''05'' AS DOCIDENTIFICATORIATIPO,
--6
CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS DOCIDENTIFICATORIANUMERO,
--7
SUBSTRING(jur.RAZONSOCIAL,1,55) AS DENOMINACION,
--8
SUBSTRING(dir.CALLE,1,55) AS DOMICILIOCALLE,
--9
dir.NUMERO AS DOMICILIONUMERO,
--10
RIGHT(ISNULL(dir.PISO,0),2) AS DOMICILIOPISO,
--11
dir.APARTAMENTO AS DOMICILIODPTOOFICINA,
--12
dir.CPA_VIEJO AS DOMICILIOCODIGOPOSTAL,
--13
--dir.LOCALIDAD AS DOMICILIOLOCALIDAD,
SUBSTRING(l.DESCRIPCION_DIM3,1,25) AS DOMICILIOLOCALIDAD,
--14
(SELECT ID_BCRA FROM CLI_PROVINCIAS x WHERE x.CODIGOPAIS = dir.PAIS AND x.DIM1 = dir.PROVINCIA) AS DOMICILIOPROVINCIA,
--15
ISNULL((SELECT x.CODIGOSWIFT FROM CLI_PAISES x WHERE x.CODIGOPAIS = dir.PAIS),''AR'') AS DOMICIOLIOPAISSWFIT,
--16
(SELECT cliact.CODIGO_BCRA FROM VW_SOS_ACT_ECO cliact	
  WHERE cliact.CODIGO_PERSONA = cp.NUMEROPERSONA
    AND cliact.tipo_actividad = ''Primaria'') AS CODIGOACTIVIDAD,
--17
(SELECT TOP 1 cliact.CODIGO_BCRA FROM VW_SOS_ACT_ECO cliact	
WHERE cliact.CODIGO_PERSONA = cp.NUMEROPERSONA
  AND cliact.tipo_actividad = ''Secundaria'')AS CODIGOACTIVIDADSEC,
--18
ISNULL((SELECT x.CODIGOSWIFT FROM CLI_PAISES x WHERE x.CODIGOPAIS = dir.PAIS),''AR'')  AS RESIDENCIA,
--19
'''' AS CODIGOAREATEL,
--20
'''' AS CARACTERISTICATEL,
--21
'''' AS TELEFONO,
--22
'''' AS FAX,
--23
'''' AS TELEX,
--24
'''' AS EMAIL,
--25
'''' AS SEXO,
--26
'''' AS ESTADOCIVIL,
--27
'''' AS CODIGOACTIVIDADINTERNO,
--28
convert(VARCHAR, jur.FECHAALTA, 112) AS FECHAALTA,
--29
'''' AS FECHABAJA,
--30
jur.SUC_ALTA,
--31
ISNULL((SELECT x.CODIGOSWIFT FROM CLI_PAISES x WHERE x.CODIGOPAIS = jur.PAISRESIDENCIA),''AR'') AS CODIGOPAIS,
--32
''PJ'' AS TIPOCLIENTE,
--33
''N'' AS MARCAEMPLEADO,
--34
''N'' AS PEP,
--35
jur.SUJETO_UIF,
--36
ISNULL(jur.INSC_UIF,''N'') AS CONST_INSCRIP_SSOO,
--37
(SELECT cliact.CODIGO_ACT_AFIP FROM VW_SOS_ACT_ECO cliact	
  WHERE cliact.CODIGO_PERSONA = cp.NUMEROPERSONA
    AND cliact.tipo_actividad = ''Primaria'') AS CODIGOACTIVIDADAFIP,
--38
(SELECT TOP 1 cliact.CODIGO_ACT_AFIP FROM VW_SOS_ACT_ECO cliact	
  WHERE cliact.CODIGO_PERSONA = cp.NUMEROPERSONA
    AND cliact.tipo_actividad = ''Secundaria'') AS CODIGOACTIVIDADAFIPSEC,
--39
jur.TIPOSOCIEDAD AS FORMAJURIDICA,
--40
jur.SECTOR,
--41
'''' AS APELLIDO,
--42
'''' AS NOMBRE,
--43
(CASE WHEN ISNULL(jur.FECHACONSTITUCION,'''') = '''' THEN '''' ELSE CONVERT(VARCHAR, jur.FECHACONSTITUCION,112) END) AS FECHACONSTITUCIONSOCIEDAD,
--44
jur.TIPO_SUJETO_UIF AS TIPOSSOO,
--45
jur.INSC_UIF AS DECJURSSOO,
--46
(CASE WHEN jur.IVA = ''AC'' THEN 1
	WHEN jur.IVA = ''EP'' THEN 8
	WHEN jur.IVA = ''EX'' THEN 4
	WHEN jur.IVA = ''NI'' THEN 3
END) AS CATEGORIAIVA,
--47
''N'' AS MARCASUELDO,
--48
jur.CANTIDAD_EMPLEADOS AS TAMANIOEMPRESA,
--49
'''' AS CLIMONTRIBIVA,
--
cli.CODIGOCLIENTE,
jur.NUMEROPERSONAJURIDICA
FROM /*CLI_CLIENTES cli (NOLOCK)
  INNER JOIN CLI_CLIENTEPERSONA cp (NOLOCK) ON cp.CODIGOCLIENTE = cli.CODIGOCLIENTE AND cp.TITULARIDAD = ''T''
  INNER JOIN*/ CLI_PERSONASJURIDICAS jur (NOLOCK) --ON jur.NUMEROPERSONAJURIDICA = cp.NUMEROPERSONA
  INNER JOIN CLI_DIRECCIONES dir (NOLOCK) ON dir.ID = jur.NUMEROPERSONAJURIDICA AND dir.FORMATO = ''PJ'' AND dir.TIPODIRECCION = ''L''
    AND dir.ORDINAL_DIR = 1
  INNER JOIN CLI_DocumentosPFPJ doc (NOLOCK) ON doc.NUMEROPERSONAFJ = jur.NUMEROPERSONAJURIDICA
  LEFT JOIN CLI_LOCALIDADES l ON l.CODIGOPAIS = dir.PAIS AND l.DIM1 = dir.PROVINCIA AND l.DIM2 = dir.DEPARTAMENTO AND l.DIM3 = dir.LOCALIDAD
  LEFT JOIN VW_CLIENTE_PFPJ vfj ON vfj.NUMEROPERSONA = jur.NUMEROPERSONAJURIDICA
WHERE /*cp.TZ_LOCK = 0
  AND cli.TZ_LOCK = 0
  AND */jur.TZ_LOCK = 0
  AND dir.TZ_LOCK = 0
  AND doc.TZ_LOCK = 0
  AND NOT EXISTS(SELECT 1 FROM #TMP_PERSONAS_FJ x WHERE x.NROPERSFISICAJURIDICA = jur.NUMEROPERSONAJURIDICA)
  
END
')