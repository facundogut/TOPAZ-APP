EXECUTE('
IF OBJECT_ID (''dbo.VW_ASISTENCIAS_D_NO_EXIGIBLE_POSICION'') IS NOT NULL
	DROP VIEW dbo.VW_ASISTENCIAS_D_NO_EXIGIBLE_POSICION
')

EXECUTE('
CREATE VIEW dbo.VW_ASISTENCIAS_D_NO_EXIGIBLE_POSICION
AS
SELECT 
SALDO_JTS_OID,
SUM(CAPITAL_NO_EXIGIBLE) AS CAPITAL_NO_EXIGIBLE,
SUM(GASTOS) AS GASTOS,
ROUND(SUM(CAPITAL_NO_EXIGIBLE)+SUM(GASTOS),2) AS TOTAL_NO_EXIGIBLE
FROM (
SELECT 
		T1.SALDO_JTS_OID,
		T1.CUOTA AS CUOTA,
		SUM(T1.DEUDA_NO_EXIGIBLE)*m.C6440 AS CAPITAL_NO_EXIGIBLE,
		SUM(T1.GASTOS)*m.C6440 AS GASTOS
FROM SALDOS S WITH (NOLOCK)
-- Cuota Periodo
INNER JOIN ( 
	SELECT 
		PP.SALDO_JTS_OID,
		PP.C2300 AS CUOTA,
		PP.C2309+PP.C2310+PP.IVAINTERES+PP.IVAPERCEPCIONINTERES AS DEUDA_NO_EXIGIBLE,
		ISNULL((SELECT SUM(SALDO_GASTO) FROM GASTOS_POR_CUOTA WITH (NOLOCK) WHERE SALDOS_JTS_OID=PP.SALDO_JTS_OID AND NUMERO_CUOTA=PP.C2300
		 AND ( (tz_lock < 300000000000000 OR tz_lock >= 400000000000000) AND (tz_lock < 100000000000000 OR tz_lock >= 200000000000000)  )),0) AS GASTOS
	FROM SALDOS S1 WITH (NOLOCK) INNER JOIN PLANPAGOS PP WITH (NOLOCK) ON S1.JTS_OID=PP.SALDO_JTS_OID AND S1.TZ_LOCK=0
	WHERE (PP.C2309+PP.C2310)>0 AND 
	(((SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK)) BETWEEN PP.C2301 AND PP.C2302 AND PP.C2301 <= 
	(SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))
	) 
	OR (PP.C2301=S1.C1621 
	AND (S1.C1621= (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))))
	)
	AND ((PP.TZ_LOCK < 300000000000000 OR PP.TZ_LOCK >= 400000000000000) AND (PP.TZ_LOCK < 100000000000000 OR PP.TZ_LOCK >= 200000000000000)  )
	UNION
-- Cuotas a Vencer
	SELECT 
			PP.SALDO_JTS_OID,
			PP.C2300 AS CUOTA,
			PP.C2309 AS DEUDA_NO_EXIGIBLE,
			ISNULL((SELECT SUM(SALDO_GASTO) FROM GASTOS_POR_CUOTA WITH (NOLOCK) WHERE SALDOS_JTS_OID=PP.SALDO_JTS_OID AND NUMERO_CUOTA=PP.C2300
			 AND ( (tz_lock < 300000000000000 OR tz_lock >= 400000000000000) AND (tz_lock < 100000000000000 OR tz_lock >= 200000000000000)  )),0) AS GASTOS
	FROM SALDOS S1 WITH (NOLOCK) INNER JOIN PLANPAGOS PP WITH (NOLOCK) ON S1.JTS_OID=PP.SALDO_JTS_OID AND S1.TZ_LOCK=0
	WHERE (C2309+C2310)>0 AND 
		(PP.C2301 > (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))) 
		AND ((PP.TZ_LOCK < 300000000000000 OR PP.TZ_LOCK >= 400000000000000) AND (PP.TZ_LOCK < 100000000000000 OR PP.TZ_LOCK >= 200000000000000)  )
		
	) T1
ON T1.SALDO_JTS_OID=S.JTS_OID
INNER JOIN MONEDAS m WITH(NOLOCK) ON m.C6399 =s.moneda
	AND ( (m.tz_lock < 300000000000000 OR m.tz_lock >= 400000000000000) AND (m.tz_lock < 100000000000000 OR m.tz_lock >= 200000000000000)  )	
WHERE  S.C1785 = 5 AND S.C1604<>0 
    AND ( (s.tz_lock < 300000000000000 OR s.tz_lock >= 400000000000000) AND (s.tz_lock < 100000000000000 OR s.tz_lock >= 200000000000000)  )
GROUP BY T1.SALDO_JTS_OID, T1.CUOTA,m.C6440
) T3
GROUP BY SALDO_JTS_OID
')