EXECUTE('
ALTER PROCEDURE SP_PA_REVISION_DE_TASAS_ACUERDOS
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS
BEGIN
DECLARE @CANTIDAD_REGISTROS INT
DECLARE @REVISION_TASAS_ACUERDOS_AUX TABLE (NRO_AUTORIZACION NUMERIC(10,0), TIPO_TASA_BASE VARCHAR(3),TIPO_TASA VARCHAR(1),
							   TASA_BASE_ACTUAL NUMERIC(11,7),
							   TASA_ACTUAL NUMERIC (11,7),PUNTOS_TASA NUMERIC (11,7), NUEVA_TASA NUMERIC(11,7),
							   NUEVA_TASA_BASE NUMERIC (11,7))
							   
	SET @P_RET_PROCESO = NULL
    SET @P_MSG_PROCESO = NULL
	SELECT @P_DT_PROCESO=(SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))
---Insert a la tabla temporal en base a la siguiente query
BEGIN
	INSERT INTO @REVISION_TASAS_ACUERDOS_AUX
	SELECT  VTA.NRO_AUTORIZACION, 
				vt.TIPO_TASA_BASE,
				vt.TIPO_TASA AS TIPO_TASA,
				vt.TASA_BASE AS TASA_BASE_ACTUAL,
				vt.TASA AS TASA_ACTUAL,
				vt.PUNTOS_TASA,
				(tb1.TASA+vt.PUNTOS_TASA) AS NUEVA_TASA,
				tb1.TASA AS NUEVA_TASA_BASE
	FROM VTA_SOBREGIROS VTA WITH (NOLOCK) 
	INNER JOIN (SELECT vt1.NRO_ACUERDO, max(vt1.FECHADESDE) AS FECHADESDE
				FROM VTA_TASAS_SOBREGIROS vt1 WITH (NOLOCK) GROUP BY vt1.NRO_ACUERDO) vt2 ON vt2.NRO_ACUERDO=VTA.NRO_AUTORIZACION   
	INNER JOIN VTA_TASAS_SOBREGIROS vt ON vt.NRO_ACUERDO=VTA.NRO_AUTORIZACION AND vt.FECHADESDE=vt2.FECHADESDE
	INNER JOIN (SELECT TIPOTASABASE, max(VIGENCIADESDE) AS VIGENCIADESDE FROM TASASBASE WITH (NOLOCK) 
				 			 WHERE TZ_LOCK=0 
							 GROUP BY TIPOTASABASE) tb ON tb.TIPOTASABASE=vt.TIPO_TASA_BASE 
	INNER JOIN TASASBASE tb1 WITH (NOLOCK) ON tb1.TIPOTASABASE = vt.TIPO_TASA_BASE 
			     					      AND tb1.VIGENCIADESDE=tb.VIGENCIADESDE AND tb1.TZ_LOCK=0
	WHERE VTA.ESTADO=1 
		  AND vt.TIPO_TASA=''V''
		  AND tb1.TASA <> ISNULL(vt.TASA_BASE,0)
		  AND VTA.TZ_LOCK=0 
			  

	SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM @REVISION_TASAS_ACUERDOS_AUX)
END
BEGIN
-- Creamos un nuevo registro en VTA_TASAS_SOBREGIROS con fecha desde hoy y tasas actualizadas
	INSERT INTO dbo.VTA_TASAS_SOBREGIROS (TZ_LOCK,NRO_ACUERDO,TASA,TASA_MORA,FECHADESDE,TIPO_TASA,TIPO_TASA_BASE, 
	TASA_BASE,PUNTOS_TASA)	
	(SELECT 0,
				RTA.NRO_AUTORIZACION,
				RTA.NUEVA_TASA,
				RTA.NUEVA_TASA/2, 
				(SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK)),
				RTA.TIPO_TASA,
				RTA.TIPO_TASA_BASE,
				RTA.NUEVA_TASA_BASE,
				RTA.PUNTOS_TASA
		  FROM @REVISION_TASAS_ACUERDOS_AUX RTA
	   	)
		
END
    SET @P_MSG_PROCESO = ''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros''     
           
    SET @P_RET_PROCESO = 1
      
    DECLARE @p_tipo_error varchar(80)
    SET @p_tipo_error=''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros'' 

EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
				@P_ID_PROCESO,
		    	@P_DT_PROCESO,
		    	''SP_PA_REVISION_DE_TASAS_ACUERDOS'',
		    	@P_RET_PROCESO,
		    	@P_MSG_PROCESO,
		    	@p_tipo_error
		    	
		    	
END
')