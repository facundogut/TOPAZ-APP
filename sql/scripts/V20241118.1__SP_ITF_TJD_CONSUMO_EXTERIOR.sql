CREATE OR ALTER   PROCEDURE ITF_TJD_CONSUMO_EXTERIOR(
  @DI_FECHA VARCHAR(8))

AS
BEGIN
  DECLARE @FechaIni VARCHAR(8);
  DECLARE @FechaFin VARCHAR(8);
  DECLARE @CA_SECUENCIA VARCHAR(2) = (SELECT RIGHT(concat('0',isnull(MAX(SECUENCIA),-1)+1),2) FROM ITF_AFIP_SITEREX_HIST (nolock) hist
																	WHERE TIPO_REGISTRO = '01' 
																   		AND LEFT(convert(VARCHAR(10), @DI_FECHA, 112), 6) = hist.PERIODO_INFORMADO);
  


    SET @FechaIni = CONVERT(VARCHAR,DATEADD(DAY, 1, EOMONTH(@DI_FECHA, -1)),112);
    
    SET @FechaFin = @DI_FECHA; 
     
   
	
    TRUNCATE TABLE ITF_TJD_CONS_EXT
    DROP TABLE IF EXISTS #TMP_TOPAZCONTROL
	
	SELECT DISTINCT CONVERT(VARCHAR, tp.FECHAMENSAJE,112) AS FechaOperacion,
	  tp.ELEMENT4 AS MontoOperacionPesos,
	  (CASE WHEN convert(NUMERIC(12),tp.ELEMENT4) < 0 THEN '-' ELSE '+' END) AS SignoMontoOperacionPesos,
	  SubString(element43,1,22) AS NombreComercio,
	  substring(element43,39,2) AS IdentificacionPais,
	  '08' AS CodigoRubro,
	  td.ID_TARJETA,
	  td.NRO_CLIENTE
	  INTO #TMP_TOPAZCONTROL
	
	FROM TP_TOPAZPOSCONTROL tp
	  INNER JOIN TJD_TARJETAS td ON td.ID_TARJETA = SUBSTRING(tp.ELEMENT35,1, CHARINDEX('=',tp.ELEMENT35)-1)
	WHERE tp.TZ_LOCK=0 
	AND tp.element3 IN  ('711000', '711500', '712000')
	AND tp.element105!='0'
	AND tp.element49 = 840
--	AND tp.element39 = '00'
	AND tp.element0 in ('0210', '0230')
	AND CONVERT(VARCHAR,tp.TOPAZPROCESSDATE,112) BETWEEN @FechaIni AND @FechaFin
	AND NOT EXISTS (
	select 1 from TP_TOPAZPOSCONTROL c 
	WHERE c.element13=tp.element13 
		  and c.element12=tp.element12 
		  and c.element37=tp.element37 
		  and c.element41=tp.element41
		  and c.element0 in ('0430')
		  and c.element39='00'
	)
	
	
	IF (SELECT count(1) FROM #TMP_TOPAZCONTROL WHERE 1 = 1) > 0
	BEGIN
	
	--REG 01
	INSERT INTO ITF_TJD_CONS_EXT
	SELECT DISTINCT @DI_FECHA AS Fecha,
	 '01' AS TipoRegistro,
	 RIGHT(CONCAT(REPLICATE('0',11),pa.NOMBRE2),11) + 
	 RIGHT(CONCAT(REPLICATE('0',11), SUBSTRING(@FechaIni,1,6)),6) + 
	 @CA_SECUENCIA + 
	 '0103' + 
	 '097' + 
	 '8103' + 
	 REPLICATE(' ',212) + 
	 '00200' + 
	 (CASE WHEN EXISTS(SELECT TOP 1 1 FROM #TMP_TOPAZCONTROL pos 
		   JOIN TJD_REL_TARJETA_CUENTA tdr ON tdr.ID_TARJETA = pos.ID_TARJETA AND tdr.TZ_LOCK = 0
		   JOIN SALDOS sa ON sa.JTS_OID = tdr.SALDO_JTS_OID AND sa.TZ_LOCK = 0
		   JOIN VTA_SALDOS vsa ON vsa.JTS_OID_SALDO = sa.JTS_OID AND vsa.TZ_LOCK = 0
		   JOIN VW_CLIENTE_PERSONAS cp ON cp.CODIGOCLIENTE = sa.C1803 )  THEN '1' ELSE '0' END) AS DATO, 
	 0 AS IdTarjeta,
	 0 AS CodCliente
	FROM PARAMETROS pa
	
	--inserto en tabla historial REG 01
	
	INSERT INTO ITF_AFIP_SITEREX_HIST (TIPO_REGISTRO	,CUIT_INFORMANTE	,PERIODO_INFORMADO	,SECUENCIA	,COD_IMPUESTO	,COD_CONCEPTO	,NRO_FORMULARIO	,VERSION	,PRESENTACION_SIN_MOVIMIENTO)
	SELECT DISTINCT
	'01',
	 RIGHT(CONCAT(REPLICATE('0',11),pa.NOMBRE2),11), 
	 RIGHT(CONCAT(REPLICATE('0',11), SUBSTRING(@FechaIni,1,6)),6), 
	 @CA_SECUENCIA,
--	 RIGHT(CONCAT(REPLICATE('0',2),(SELECT NUMERICO_1 FROM ITF_MASTER_PARAMETROS WHERE CODIGO = 517)),2), 
	 '0103',
	 '097',
	 '8103',
   --	 REPLICATE(' ',212) + 
	 '00200', 
	 (CASE WHEN EXISTS(SELECT TOP 1 1 FROM #TMP_TOPAZCONTROL)  THEN '0' ELSE '1' END) 
	FROM PARAMETROS pa
	
	
	--REG 02
	
	INSERT INTO ITF_TJD_CONS_EXT
	SELECT DISTINCT @DI_FECHA AS Fecha,
	'02' AS TipoRegistro,
	  LEFT(CONCAT(vsa.CTA_CBU,REPLICATE(' ',22)),22) + 
	  RIGHT(CONCAT(REPLICATE('0',11),cp.NUMERODOCUMENTO),11) + 
	  (CASE WHEN cp.TIPOPERSONA = 'F' AND cp.TITULARIDAD = 'T' THEN '01'
	  		WHEN cp.TIPOPERSONA = 'F' AND cp.TITULARIDAD = 'C' THEN '02'
	  		WHEN cp.TIPOPERSONA = 'J' AND cp.CODIGOCARGOPJ = 'APO' THEN '03'
	  		WHEN cp.TIPOPERSONA = 'J' AND cp.CODIGOCARGOPJ = 'REP' THEN '04'
	  		WHEN cp.TIPOPERSONA = 'J' AND cp.CODIGOCARGOPJ = 'SDE' THEN '06'
	  		WHEN cp.TIPOPERSONA = 'J' AND cp.CODIGOCARGOPJ = 'FCO' THEN '07'
	    END) AS DATO, 
	   pos.ID_TARJETA,
	   pos.NRO_CLIENTE
	FROM #TMP_TOPAZCONTROL pos 
	  INNER JOIN TJD_REL_TARJETA_CUENTA tdr ON tdr.ID_TARJETA = pos.ID_TARJETA AND tdr.TZ_LOCK = 0
	  INNER JOIN SALDOS sa ON sa.JTS_OID = tdr.SALDO_JTS_OID AND sa.TZ_LOCK = 0
	  INNER JOIN VTA_SALDOS vsa ON vsa.JTS_OID_SALDO = sa.JTS_OID AND vsa.TZ_LOCK = 0
	  INNER JOIN VW_CLIENTE_PERSONAS cp ON cp.CODIGOCLIENTE = sa.C1803 
	 
	  
	--inserto en tabla historial REG 02
	INSERT INTO ITF_AFIP_SITEREX_HIST (TIPO_REGISTRO, CBU, SECUENCIA, CUIT_CUIL_CDI, CARACTER_INTEGRANTE)
	SELECT DISTINCT
		'02',
		LEFT(CONCAT(vsa.CTA_CBU,REPLICATE(' ',22)),22),
		@CA_SECUENCIA,
	  	RIGHT(CONCAT(REPLICATE('0',11),cp.NUMERODOCUMENTO),11),
		(CASE WHEN cp.TIPOPERSONA = 'F' AND cp.TITULARIDAD = 'T' THEN '01'
	  		WHEN cp.TIPOPERSONA = 'F' AND cp.TITULARIDAD = 'C' THEN '02'
	  		WHEN cp.TIPOPERSONA = 'J' AND cp.CODIGOCARGOPJ = 'APO' THEN '03'
	  		WHEN cp.TIPOPERSONA = 'J' AND cp.CODIGOCARGOPJ = 'REP' THEN '04'
	  		WHEN cp.TIPOPERSONA = 'J' AND cp.CODIGOCARGOPJ = 'SDE' THEN '06'
	  		WHEN cp.TIPOPERSONA = 'J' AND cp.CODIGOCARGOPJ = 'FCO' THEN '07'
	    END)
	FROM #TMP_TOPAZCONTROL pos 
	  INNER JOIN TJD_REL_TARJETA_CUENTA tdr ON tdr.ID_TARJETA = pos.ID_TARJETA AND tdr.TZ_LOCK = 0
	  INNER JOIN SALDOS sa ON sa.JTS_OID = tdr.SALDO_JTS_OID AND sa.TZ_LOCK = 0
	  INNER JOIN VTA_SALDOS vsa ON vsa.JTS_OID_SALDO = sa.JTS_OID AND vsa.TZ_LOCK = 0
	  INNER JOIN VW_CLIENTE_PERSONAS cp ON cp.CODIGOCLIENTE = sa.C1803 
	
	
	
	--REG 03
	
 	INSERT INTO ITF_TJD_CONS_EXT
	SELECT DISTINCT @DI_FECHA AS Fecha,
	  '03' AS TipoRegistro,
	  RIGHT(CONCAT(REPLICATE('0',11),cp.NUMERODOCUMENTO),11) + 
	  RIGHT(CONCAT(REPLICATE('0',8),pos.FechaOperacion),8) + 
	  RIGHT(CONCAT(REPLICATE('0',3),pais.CODIGOSWIFT),3)  + 
	  pos.SignoMontoOperacionPesos + 
	  RIGHT(CONCAT(REPLICATE('0',12),pos.MontoOperacionPesos),12) + 
	  LEFT(CONCAT(pos.NombreComercio, REPLICATE(' ',25)),25) + 
	  RIGHT(CONCAT(REPLICATE('0',2),pos.CodigoRubro),2) AS DATO, 
	  pos.ID_TARJETA,
	   pos.NRO_CLIENTE
	FROM #TMP_TOPAZCONTROL pos 
	  INNER JOIN VW_CLIENTE_PERSONAS cp ON cp.CODIGOCLIENTE = pos.NRO_CLIENTE AND cp.TITULARIDAD = 'T'
  	  JOIN CLI_DIRECCIONES dir ON cp.NUMEROPERSONA = dir.ID 
	  JOIN CLI_PAISES pais ON dir.PAIS = pais.CODIGOPAIS
	  WHERE dir.TZ_LOCK=0 AND pais.TZ_LOCK = 0
	  
	  	--inserto en tabla historial REG 03
 		INSERT INTO ITF_AFIP_SITEREX_HIST (TIPO_REGISTRO, CUIT_CUIL_CDI, SECUENCIA, FECHA_OPERACION, ID_PAIS, SG_MONTO_OP_PESOS, MONTO_OP_PESOS, NOM_COMERCIO, COD_RUBRO)  	  	
		SELECT DISTINCT
			  '03',
			  RIGHT(CONCAT(REPLICATE('0',11),cp.NUMERODOCUMENTO),11),
			  @CA_SECUENCIA,
			  RIGHT(CONCAT(REPLICATE('0',8),pos.FechaOperacion),8),
			  CAST(cod_pais.num1 AS INT),
			  pos.SignoMontoOperacionPesos, 
			  RIGHT(CONCAT(REPLICATE('0',12),pos.MontoOperacionPesos),12),
			  LEFT(CONCAT(pos.NombreComercio, REPLICATE(' ',25)),25), 
			  RIGHT(CONCAT(REPLICATE('0',2),pos.CodigoRubro),2) 
		FROM #TMP_TOPAZCONTROL pos 
		  INNER JOIN VW_CLIENTE_PERSONAS cp ON cp.CODIGOCLIENTE = pos.NRO_CLIENTE AND cp.TITULARIDAD = 'T'
		  JOIN CLI_DIRECCIONES dir ON cp.NUMEROPERSONA = dir.ID 
		  JOIN CLI_PAISES pais ON dir.PAIS = pais.CODIGOPAIS
		  JOIN (SELECT ID4,NUM1 FROM RRI_PARAMETROS_inf WHERE CODIGO=515 AND TZ_LOCK = 0) cod_pais ON pais.CODIGOSWIFT = cod_pais.id4
		  WHERE dir.TZ_LOCK=0 AND pais.TZ_LOCK = 0
	  
	END
END
GO