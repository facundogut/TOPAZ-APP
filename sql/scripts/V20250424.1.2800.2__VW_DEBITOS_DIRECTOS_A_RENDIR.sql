EXECUTE('
IF OBJECT_ID (''dbo.VW_DEBITOS_DIRECTOS_A_RENDIR'') IS NOT NULL
	DROP VIEW dbo.VW_DEBITOS_DIRECTOS_A_RENDIR
')

EXECUTE('
CREATE VIEW VW_DEBITOS_DIRECTOS_A_RENDIR
AS
WITH TOTALES AS (
	SELECT
		O.CONVENIO AS ID_CONVENIO,
		O.MONEDA AS MONEDA,
		COUNT(O.IMPORTE) AS CANTIDAD_ORDENES,
		SUM(
			(CASE 
				WHEN O.TRACE_N_2PRE IS NOT NULL THEN O.SEGUNDO_IMPORTE 
				ELSE O.IMPORTE 
			END) * 
			CASE ISNULL(O.ID_ARCHIVO_REVERSADO, '''')
				WHEN '''' THEN 1
				ELSE -1 /*VALOR EN ID_ARCHIVO_REVERSADO SIGNIFICA QUE ES UNA REVERSA*/
			END
		) AS TOTAL_IMPORTE
	FROM SNP_MSG_ORDENES AS O WITH (nolock)
	WHERE 
		O.TIPO_ORDEN = ''DEBENV''
		AND O.ESTADO = ''PR''
		AND O.FECHA_COMPENSACION < (SELECT FECHAPROCESO FROM PARAMETROS WITH (nolock))
		AND O.RENDIDA <> ''S''
		AND O.TZ_LOCK = 0
	GROUP BY
		O.CONVENIO,
		O.MONEDA,
		CASE ISNULL(O.ID_ARCHIVO_REVERSADO, '''')
			WHEN '''' THEN 1
			ELSE -1 /*VALOR EN ID_ARCHIVO_REVERSADO SIGNIFICA QUE ES UNA REVERSA*/
		END
)

SELECT
	ROW_NUMBER() OVER(PARTITION BY T.ID_CONVENIO ORDER BY T.TOTAL_IMPORTE DESC) AS ID_RENDICION,
	C.Id_ConvRec AS ID_CONVENIO,
	C.NomConvRec AS NOMBRE_CONVENIO,
	C.Cuit AS CUIT_EMPRESA,
	C.Cliente AS CLIENTE,
	CLI.NOMBRECLIENTE,
	T.MONEDA,
	M.C6400 AS NOMBRE_MONEDA,
	CAST(T.CANTIDAD_ORDENES AS NUMERIC(10)) AS CANTIDAD_ORDENES,
	CAST(T.TOTAL_IMPORTE AS NUMERIC(15, 2)) AS TOTAL_IMPORTE,
	C.FecAlta AS FECHA_ALTA,
	C.FecVto AS FECHA_VENCIMIENTO
FROM CONV_CONVENIOS_REC AS C WITH (nolock)
INNER JOIN CLI_CLIENTES AS CLI WITH (nolock) ON
	CLI.CODIGOCLIENTE = C.Cliente
	AND ((CLI.TZ_LOCK < 100000000000000 OR CLI.TZ_LOCK >= 200000000000000)
		AND (CLI.TZ_LOCK < 300000000000000 OR CLI.TZ_LOCK >= 400000000000000)  
	)
INNER JOIN TOTALES AS T WITH (nolock) ON
	T.ID_CONVENIO = C.Id_ConvRec
INNER JOIN MONEDAS AS M WITH (nolock) ON
	M.C6399 = T.MONEDA
	AND ((M.TZ_LOCK < 100000000000000 OR M.TZ_LOCK >= 200000000000000)
		AND (M.TZ_LOCK < 300000000000000 OR M.TZ_LOCK >= 400000000000000)  
	)	
WHERE
	C.TZ_LOCK = 0
	AND C.ESTADO = ''A''
	AND C.Id_TpoConv IN (	
		SELECT T.Id_TpoConv
		FROM CONV_TIPOS AS T WITH (nolock)
		WHERE 
			T.TpoContrato = 2
			AND ((T.TZ_LOCK < 100000000000000 OR T.TZ_LOCK >= 200000000000000)
				AND (T.TZ_LOCK < 300000000000000 OR T.TZ_LOCK >= 400000000000000)
			)
	)
')

