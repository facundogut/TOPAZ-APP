EXECUTE('
IF OBJECT_ID (''dbo.VW_VINCULACIONES_CONVENIOS'') IS NOT NULL
	DROP VIEW dbo.VW_VINCULACIONES_CONVENIOS
')

EXECUTE('
CREATE VIEW dbo.VW_VINCULACIONES_CONVENIOS
AS 
SELECT DISTINCT
vinc.ID_CONVENIO,
conv.NomConvPago AS DESC_CONVENIO, 
vinc.ID_PERSONA,
s.C1803 AS CLIENTE,
doc.NUMERODOCUMENTO,
doc.NUM_DOC_FISICO AS DOCUMENTO_FISICO,
vinc.ID_JURISDICCION AS ID_DOMINIO,
dom.DESCRIPCION AS DESC_DOMINIO,
vinc.JTS_CV AS JTS_OID_CV,
s.CUENTA,
s.SUCURSAL,
s.PRODUCTO,
s.MONEDA,
s.OPERACION,
s.ORDINAL,
CASE
WHEN bloq.SALDO_JTS_OID IS NULL THEN ''S''
ELSE ''N''
END AS CTA_DESBLOQUEADA, 
CASE
WHEN canc.SALDO_JTS_OID IS NULL THEN ''S''
ELSE ''N''
END AS CTA_ACTIVA,
vinc.CBU,
dom.SUB_DOMINIO,
vinc.ID_BENEFICIO AS CLAVE_ANSES,
ISNULL(dom.CONC_CONT_TRANSITORIO,domsinjur.CONC_CONT_TRANSITORIO) AS CONC_CONT_TRANSITORIO
FROM CRE_VINCULACIONES_CONVENIOS vinc WITH (NOLOCK)
INNER JOIN CONV_CONVENIOS_PAG conv WITH (NOLOCK) ON conv.ID_ConvPago=vinc.ID_CONVENIO
left JOIN (
select ID_CONVENIO, ID_DOMINIO, MAX(DESCRIPCION) as DESCRIPCION ,  0 AS SUB_DOMINIO, CONC_CONT_TRANSITORIO
from CONV_DOMINIOS WITH (NOLOCK)
GROUP BY ID_CONVENIO, ID_DOMINIO, CONC_CONT_TRANSITORIO) dom
 ON  dom.ID_CONVENIO=vinc.ID_CONVENIO AND dom.ID_DOMINIO = vinc.ID_JURISDICCION
left JOIN (
select ID_CONVENIO, ID_DOMINIO, MAX(DESCRIPCION) as DESCRIPCION ,  0 AS SUB_DOMINIO, CONC_CONT_TRANSITORIO
from CONV_DOMINIOS WITH (NOLOCK) WHERE (ID_DOMINIO = 0 OR ID_DOMINIO IS NULL) AND (SUB_DOMINIO = 0 OR SUB_DOMINIO IS NULL)
GROUP BY ID_CONVENIO, ID_DOMINIO, CONC_CONT_TRANSITORIO) domsinjur
 ON  domsinjur.ID_CONVENIO=vinc.ID_CONVENIO
INNER JOIN SALDOS s WITH (NOLOCK) ON s.JTS_OID=vinc.JTS_CV AND s.TZ_LOCK=0
INNER JOIN CLI_CLIENTES cli WITH (NOLOCK) ON cli.CODIGOCLIENTE=s.C1803
INNER JOIN CLI_DocumentosPFPJ doc WITH (NOLOCK) ON doc.NUMEROPERSONAFJ=vinc.ID_PERSONA AND doc.TZ_LOCK=0
LEFT JOIN GRL_BLOQUEOS bloq WITH(NOLOCK) ON bloq.SALDO_JTS_OID = s.JTS_OID AND bloq.ESTADO = ''1'' AND bloq.TZ_LOCK = 0
LEFT JOIN CV_CANCELACION_CUENTAS canc WITH(NOLOCK) ON canc.SALDO_JTS_OID = s.JTS_OID AND canc.ESTADO = ''F'' AND canc.TZ_LOCK = 0
WHERE vinc.TZ_LOCK = 0 AND conv.TZ_LOCK = 0 AND cli.TZ_LOCK = 0
')