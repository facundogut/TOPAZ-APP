------------------------------------------------------------
-- DDL DE TABLAS
------------------------------------------------------------
DROP TABLE IF EXISTS dbo.TLF_CONCILIACION_CABECERA;
CREATE TABLE dbo.TLF_CONCILIACION_CABECERA (
    ID_CABECERA BIGINT NOT NULL IDENTITY(1,1) PRIMARY KEY,
    ARCHIVO varchar(100) COLLATE Modern_Spanish_CI_AS NOT NULL, 
    LKTRAD varchar(6) COLLATE Modern_Spanish_CI_AS NOT NULL,
	LKTRAT varchar(8) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKSEQN varchar(12) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKTERM varchar(16) COLLATE Modern_Spanish_CI_AS NOT NULL,
    COD_MSJ_TLF varchar(6) COLLATE Modern_Spanish_CI_AS NOT NULL,
    COD_MSJ_H2H varchar(6) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKFROM varchar(28) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKTOAC varchar(28) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKFI04 varchar(1) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKRVSL varchar(2) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKORIG numeric(3,0) DEFAULT 0 NULL,
    LKAMT1 numeric(19,2) DEFAULT 0 NULL,
    LKTIPV numeric(8,3) DEFAULT 0 NULL,
    IMPORTE numeric(19,2) DEFAULT 0 NULL,
    LKPOST DATE NOT NULL,
    ESTADO_TLF varchar(30) COLLATE Modern_Spanish_CI_AS NULL,
    IMPACTOS_ONLINE numeric(10,0) DEFAULT 0 NULL,
    REVERSAS_ONLINE numeric(10,0) DEFAULT 0 NULL,
    ESTADO_CONCILIACION varchar(30) COLLATE Modern_Spanish_CI_AS NULL,
    DESCRIPCION_CONCILIACION varchar(4000) COLLATE Modern_Spanish_CI_AS NULL,
    REVERSA_DIA_ANTERIOR numeric(2,0) DEFAULT 0 NULL,
    FECHA_PROCESO DATETIME NOT NULL,
    
    CONSTRAINT UQ_TLF_CONCILIACION_CABECERA_CLAVE_LOGICA UNIQUE (
        LKTRAD,
        LKTRAT,
        LKSEQN,
        LKTERM,
        COD_MSJ_H2H,
        LKFROM,
        LKTOAC
    )
);

DROP TABLE IF EXISTS dbo.TLF_CONCILIACION_DETALLE;
CREATE TABLE dbo.TLF_CONCILIACION_DETALLE (
    ID_CABECERA BIGINT NOT NULL,
    ID_DETALLE BIGINT NOT NULL,
    LKTRAD varchar(6) COLLATE Modern_Spanish_CI_AS NOT NULL,
	LKTRAT varchar(8) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKSEQN varchar(12) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKTERM varchar(16) COLLATE Modern_Spanish_CI_AS NOT NULL,
    COD_MSJ_H2H varchar(6) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKFROM varchar(28) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKTOAC varchar(28) COLLATE Modern_Spanish_CI_AS NOT NULL,
    LKORIG numeric(3,0) DEFAULT 0 NULL,
    LKAMT1 varchar(12) COLLATE Modern_Spanish_CI_AS NULL,
    IMPORTE numeric(19,2) DEFAULT 0 NULL,
    LKTYP varchar(4) COLLATE Modern_Spanish_CI_AS NOT NULL,
    ASIENTO_SUCURSAL numeric(12,0) NOT NULL,
    ASIENTO_FECHA datetime NOT NULL,
    ASIENTO_NUMERO numeric(15,0) NOT NULL,
    JTS_OID_TP numeric(18,0) NOT NULL,
    PRIMARY KEY (ID_CABECERA, ID_DETALLE),

    CONSTRAINT UQ_TLF_CONCILIACION_DETALLE_CLAVE_LOGICA UNIQUE (
        JTS_OID_TP
    )
);


------------------------------------------------------------
-- INDICE DE TABLAS
------------------------------------------------------------

CREATE NONCLUSTERED INDEX IX_TLF_CONCILIACION_CABECERA_LK
ON dbo.TLF_CONCILIACION_CABECERA (
    LKTRAD,
    LKTRAT,
    LKSEQN,
    LKTERM,
    COD_MSJ_H2H,
    LKFROM,
    LKTOAC
)
INCLUDE (
    ESTADO_TLF,
    ESTADO_CONCILIACION,
    IMPACTOS_ONLINE,
    REVERSAS_ONLINE,
    COD_MSJ_TLF
);

CREATE NONCLUSTERED INDEX IX_TLF_CONCILIACION_CABECERA_EXTORNO
ON dbo.TLF_CONCILIACION_CABECERA (
    ESTADO_TLF,
    ESTADO_CONCILIACION,
    IMPACTOS_ONLINE,
    REVERSAS_ONLINE,
    FECHA_PROCESO
)
INCLUDE (
    ID_CABECERA
);

CREATE NONCLUSTERED INDEX IX_TLF_CONCILIACION_DETALLE_LK
    ON dbo.TLF_CONCILIACION_DETALLE (
        LKTRAD,
        LKTRAT,
        LKSEQN,
        LKTERM,
        COD_MSJ_H2H,
        LKFROM,
        LKTOAC
    )
    INCLUDE (
        LKTYP,
        ASIENTO_SUCURSAL,
        ASIENTO_FECHA,
        ASIENTO_NUMERO,
        JTS_OID_TP
    );

CREATE NONCLUSTERED INDEX IX_TLF_CONCILIACION_DETALLE_JTS
    ON dbo.TLF_CONCILIACION_DETALLE (
        JTS_OID_TP
    )
    INCLUDE (
        ASIENTO_SUCURSAL,
        ASIENTO_FECHA,
        ASIENTO_NUMERO
    );

CREATE NONCLUSTERED INDEX IX_TLF_CONCILIACION_DETALLE_LK_JTS
    ON dbo.TLF_CONCILIACION_DETALLE (
        ID_CABECERA,
        JTS_OID_TP
    )
    INCLUDE (
        ID_DETALLE
    );



