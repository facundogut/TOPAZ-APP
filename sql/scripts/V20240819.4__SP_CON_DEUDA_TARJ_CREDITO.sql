EXECUTE('
CREATE OR ALTER PROCEDURE SP_TJC_DEUDA_TARJ_CREDITO
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
      
AS 

   BEGIN

      SET @P_RET_PROCESO = NULL
      SET @P_MSG_PROCESO = NULL
      
      DECLARE
      	@v_constante VARCHAR(1)
      
      --DECLARO TABLA AUXILIAR--
	  DECLARE @Tabla_DEUDA_TARJ_CREDITO_POR_CLIENTE  TABLE(
	  	LIMITE_COMPRA NUMERIC (15, 2),
		SALDO NUMERIC (38, 2), 
      	DEUDA NUMERIC (38, 2),
      	SUC_USUARIO NUMERIC (5, 0),
      	USUARIO NUMERIC (20, 0),
      	CLIENTE NUMERIC (12, 0),
      	PERIODO_DEUDA NUMERIC (6, 0)
	  )
	  
	  	INSERT INTO 
			@Tabla_DEUDA_TARJ_CREDITO_POR_CLIENTE
		SELECT 
			MU.LIMITE_COMPRA,
			(SUM(TS.SALDO_ME)*(SELECT C6440 FROM MONEDAS WHERE C6399 = 2)+SUM(TS.SALDO_MN)) AS ''SALDO'',
			MU.LIMITE_COMPRA-(SUM(TS.SALDO_ME)*(SELECT C6440 FROM MONEDAS WHERE C6399 = 2)+SUM(TS.SALDO_MN)) AS "Deuda",
			MU.SUC_USUARIO, 
			MU.USUARIO,
			MU.CLIENTE,
			TS.PERIODO_DEUDA
		FROM TJC_MAESTRO_USUARIO MU
		INNER JOIN TJC_SALDOS TS ON MU.ADMINISTRADORA = TS.ADMINISTRADORA AND MU.USUARIO = TS.USUARIO 
		WHERE MU.FECHA_BAJA_USU IS NULL
		AND TS.PERIODO_DEUDA = (SELECT CONVERT(NUMERIC ,(SELECT FORMAT(FECHAPROCESO,''yyyyMM'') FROM PARAMETROS)))
		GROUP BY MU.USUARIO, MU.SUC_USUARIO, MU.LIMITE_COMPRA, TS.PERIODO_DEUDA, MU.CLIENTE
		ORDER BY TS.PERIODO_DEUDA
				
		
    
      BEGIN TRANSACTION	
      
        BEGIN TRY
        
        	DELETE 
        	FROM TJC_SALDOS_SUCURSAL 
	    
			INSERT INTO TJC_SALDOS_SUCURSAL 
			SELECT 
				SUC_USUARIO AS ''Sucursal'',
				PERIODO_DEUDA,
				sum(DEUDA) AS ''Total_Sucursal'',
				0
			FROM @Tabla_DEUDA_TARJ_CREDITO_POR_CLIENTE
			WHERE DEUDA > 0
			GROUP BY SUC_USUARIO, PERIODO_DEUDA	
			
				
			COMMIT TRANSACTION;
			
			SET @P_RET_PROCESO = 1
		    SET @P_MSG_PROCESO = ''Se generaron datos de saldos de tarjetas de cr√©dito exitosamente.''
			 
				
		END TRY     
		
		BEGIN CATCH
			ROLLBACK TRANSACTION
			SET @P_RET_PROCESO = ERROR_NUMBER()
			SET @P_MSG_PROCESO = ERROR_MESSAGE()
			EXECUTE dbo.pkg_constantes$VarcharConstantes ''C_LOG_TIPO_ERROR'', @v_constante OUTPUT;
		END CATCH
		 	      
 END
')
