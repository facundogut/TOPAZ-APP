EXECUTE('
ALTER PROCEDURE dbo.SP_TP_TLF_SUMMARY  
   @P_ID_PROCESO FLOAT(53),
   @P_DT_PROCESO DATETIME2(0),
   @P_RET_PROCESO FLOAT(53) OUTPUT,
   @P_MSG_PROCESO VARCHAR(MAX) OUTPUT
AS 
BEGIN
   DECLARE @FECHACAPTURA VARCHAR(12)
   DECLARE @FECHACAPTURA2 VARCHAR(12)
   DECLARE @RETORNO_CON_REGISTRO NUMERIC(12)
   
   

   SET @P_RET_PROCESO = NULL
   SET @P_MSG_PROCESO = NULL

	-- Asignar a @P_FECHA_ALT el valor máximo de LKPOST de la tabla ITF_TLF_POS
	SELECT @FECHACAPTURA = MAX(substring(ITF_TLF_POS.LKPOST, 3, 2)+substring(ITF_TLF_POS.LKPOST, 5, 2)) ,
	@FECHACAPTURA2 = MAX(ITF_TLF_POS.LKPOST)
	FROM ITF_TLF_POS WITH (NOLOCK)
  
   -- Eliminar registros de TJD_TLF_SUMMARY para la fecha de captura especificada
   DELETE FROM TJD_TLF_SUMMARY 
   WHERE FECHACAPTURA = @FECHACAPTURA;

   -- Insertar datos en TJD_TLF_SUMMARY con el formato adecuado para @P_FECHA_ALT
   INSERT INTO dbo.TJD_TLF_SUMMARY(
       TIPOMENSAJE,
       CODIGOPROCESAMIENTO,
       FECHACAPTURA,
       FECHATRANSACCION,
       HORATRANSACCION,
       CODIGORESPUESTA,
       NUMEROTARJETA,
       NUMEROTRANSACCION,
       NUMEROAUTORIZACION,
       IDENTIFICACIONCAJERO,
       IMPORTE,
       IMPORTEDISPENSADO,
       FROMACCOUNT,
       TOACCOUNT,
       MONEDA,
       CONCILIACION,
       IMPORTETLF
   )
   SELECT DISTINCT 
       CASE ITF_TLF_POS.LKTYP    
           WHEN ''210'' THEN ''0200''
           WHEN ''420'' THEN ''0420''
           ELSE ITF_TLF_POS.LKTYP   
       END AS TIPOMENSAJE,
       (SELECT COD_MSJ_H2H 
        FROM TLF_COD_TRANSACCIONES O WITH (NOLOCK) 
        WHERE LKTCDE + LKTFRO + LKTTO = O.COD_MSJ_TLF) AS CODIGOPROCESAMIENTO, 
       @FECHACAPTURA AS FECHACAPTURA,
       SUBSTRING(ITF_TLF_POS.LKTRAD, 3, 2) + SUBSTRING(ITF_TLF_POS.LKTRAD, 5, 2) AS FECHATRANSACCION,  
       SUBSTRING(ITF_TLF_POS.LKTRAT, 0, 7) AS HORATRANSACCION,
       (SELECT H2H 
        FROM dbo.COD_RETORNO_2H2_TLF O WITH (NOLOCK) 
        WHERE LKRES2 = O.TLF) AS CODIGORESPUESTA, 
       ITF_TLF_POS.LKPANC AS NUMEROTARJETA,
       ITF_TLF_POS.LKSEQN AS NUMEROTRANSACCION,
       ''00000'' AS NUMEROAUTORIZACION,
       ITF_TLF_POS.LKTERM AS IDENTIFICACIONCAJERO,
       REPLACE(CONVERT(VARCHAR(15), ITF_TLF_POS.LKAMT1), ''.'', '''') AS IMPORTE,
       NULL AS IMPORTEDISPENSADO,
       CASE WHEN LKTCDE NOT IN (''29'', ''F4'') THEN LKTFRO + LKFROM ELSE LKFROM END AS FROMACCOUNT,
       CASE WHEN LKTCDE IN (''29'', ''F4'', ''40'') THEN LKTTO + LKTOAC ELSE LKTOAC END AS TOACCOUNT,
       CASE ITF_TLF_POS.LKORIG WHEN 32 THEN ''N'' WHEN 840 THEN ''D'' ELSE ''N'' END AS MONEDA,
       ''S'' AS CONCILIACION,
       ITF_TLF_POS.LKAMT1 AS IMPORTETLF
   FROM dbo.ITF_TLF_POS WITH (NOLOCK) 
   INNER JOIN TLF_COD_TRANSACCIONES WITH (NOLOCK) 
       ON COD_MSJ_TLF = LKTCDE + LKTFRO + LKTTO
   WHERE 
       ITF_TLF_POS.LKTYP IN (''210'', ''0220'', ''0420'') AND 
       ITF_TLF_POS.LKRECT = ''01'' AND
       ITF_TLF_POS.LKPOST = @FECHACAPTURA2;
       
   --ITF_TLF_POS.LKPOST = SUBSTRING(@P_FECHA_ALT, 5, 2) + SUBSTRING(@P_FECHA_ALT, 3, 2) + SUBSTRING(@P_FECHA_ALT, 1, 2);

   -- Validación final y mensaje
   SET @P_RET_PROCESO = 1
   SET @P_MSG_PROCESO = ''La tabla TJD_TLF_SUMMARY se ha cargado correctamente.''

   SELECT @RETORNO_CON_REGISTRO = COUNT(1)
   FROM TJD_TLF_SUMMARY WITH (NOLOCK)
   WHERE FECHACAPTURA = @FECHACAPTURA;

   IF (@RETORNO_CON_REGISTRO = 0)
   BEGIN
       SET @P_RET_PROCESO = 2
       SET @P_MSG_PROCESO = ''No se insertaron registros en la tabla TJD_TLF_SUMMARY''
   END
END;
')