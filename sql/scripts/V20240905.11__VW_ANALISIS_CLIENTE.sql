
CREATE or alter VIEW [dbo].[VW_ANALISIS_CLIENTE] 
AS
WITH CTE_ACREDITACIONES AS (
    SELECT 
        SALDO_JTS_OID,
        CONVENIO,
        MONTO,
        ROW_NUMBER() OVER (PARTITION BY SALDO_JTS_OID, CONVENIO ORDER BY FECHA DESC) AS RECIBO
    FROM 
        CRE_SOL_ACREDITACIONES_SUELDOS WITH (NOLOCK)
    WHERE 
        TZ_LOCK = 0
)
SELECT  
    COUNT(SALDO_JTS_OID) AS CANTIDAD,
    ROUND(AVG(MONTO), 0) AS MONTO,
    'Analisis de sueldos' AS NOMBRE_PRODUCTO,
    NULL AS DESGLOSE,
    NULL AS LINEA,
    'SU' AS CLASIFICACION,
    S.CUENTA,
    '' AS SITUACION,
    S.C1785 AS TIPO,
    NULL AS FECHA,
    S.C1803,
    S.JTS_OID AS JTS_OID,
    '1' AS SUMA_RESTA,
    ACRD.CONVENIO,
    NULL AS SUCURSAL,
    NULL AS OPERACION
FROM 
    SALDOS S WITH (NOLOCK)
INNER JOIN 
    CTE_ACREDITACIONES ACRD WITH (NOLOCK) ON ACRD.SALDO_JTS_OID = S.JTS_OID
WHERE 
    ACRD.RECIBO < 12
GROUP BY 
    S.JTS_OID, 
	S.CUENTA, 
	S.C1803, 
	ACRD.CONVENIO, 
	S.C1785

UNION ALL

SELECT 
    DESGLOSE + 1 AS CANTIDAD,
    MONTOORIGEN AS MONTO,
    CASE 
        WHEN ASIST.TIPO = 5 THEN 'Analisis Prestamos'
        WHEN ASIST.TIPO = 1 THEN 'Analisis Tarjetas'
    END AS NOMBRE_PRODUCTO,
    DESGLOSE,
    PRODUCTO,
    CLASIFICACION,
    CUENTA,
    SITUACION,
    TIPO,
    VENCIMIENTO,
    ASIST.CLIENTE,
    JTS_OID,
    '2' AS SUMA_RESTA,
    '0' AS CONVENIO,
    ASIST.SUCURSAL,
    ASIST.OPERACION
FROM 
    VW_ASISTENCIAS_COBRADOR AS ASIST
WHERE 
    ASIST.SALDO > 0
    AND ASIST.CLASIFICACION IN ('PP', 'AH', 'T')
