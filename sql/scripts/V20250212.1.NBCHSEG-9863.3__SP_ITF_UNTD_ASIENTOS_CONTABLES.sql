EXECUTE('
CREATE OR ALTER     PROCEDURE SP_ITF_UNTD_ASIENTOS_CONTABLES
 
AS 
BEGIN 

DECLARE @asiento VARCHAR(10), @fecha_asiento DATETIME; --, @sucursal NUMERIC(5,0), @producto NUMERIC(5,0), @cuenta NUMERIC(12,0), @moneda NUMERIC(4,0), @operacion NUMERIC(12,0), @ordinal NUMERIC(6,0); 
DECLARE @idCount INT = (SELECT MIN(ID) FROM ITF_ASIENTOS_EXTERNOS WHERE SATELITE=''UNITRADE'' AND ESTADO=''S'');
--recorro padron de entrada
SELECT @asiento = ASIENTO, @fecha_asiento=FECHA_ASIENTO
FROM ITF_ASIENTOS_EXTERNOS (nolock) WHERE ID=@idCount;

	WHILE @asiento IS NOT NULL 
	BEGIN	
	
	
	INSERT INTO dbo.BANDEJA_ASIENTOS_IN (ESTADO, ORIGEN, OPERACION, DESCRIPCION, FECHAPROCESO)
	VALUES (''S'', ''UNT'',  8624, (SELECT DESCRIPCION FROM BANDEJA_ORIGENES WHERE ORIGEN=''UNT''), (SELECT FECHAPROCESO FROM PARAMETROS))
	
	INSERT INTO dbo.BANDEJA_MOVS_IN (JTS_OID_ASIENTO, SUCURSAL, PRODUCTO, CUENTA, MONEDA, 
	OPERACION, ORDINAL, CLIENTE, SIGNO, MONTO, CONCEPTO, RUBRO_CONTABLE, 
	fecha_valor, moneda_monto, RUBRO_OPERATIVO)
	SELECT  (SELECT MAX(JTS_OID) FROM BANDEJA_ASIENTOS_IN WHERE ESTADO=''S'' AND ORIGEN=''UNT''), s.SUCURSAL, s.PRODUCTO, s.CUENTA, s.MONEDA,
	s.OPERACION, s.ORDINAL, 0, a.COD_MOVIMIENTO, (a.IMPORTE_DEBE + a.IMPORTE_HABER), 
	CONCAT(''1.19.6 TG '',a.CONCEPTO_ASIENTO), CONCAT(a.CAPITULO_CONT,a.RUBRO_CONT,a.MONEDA_CONT,a.CUENTA_CONT,a.SUCUENTA_CONT), 
	/*(SELECT FECHAPROCESO FROM PARAMETROS)*/ a.FECHA_ASIENTO, a.MONEDA, CONCAT(a.CAPITULO_CONT,a.RUBRO_CONT,a.MONEDA_CONT,a.CUENTA_CONT,a.SUCUENTA_CONT)
	FROM ITF_ASIENTOS_EXTERNOS a INNER JOIN SALDOS s ON s.JTS_OID = (SELECT TOP 1 JTS_OID FROM SALDOS WHERE C1730=(CONCAT(a.CAPITULO_CONT,a.RUBRO_CONT,a.MONEDA_CONT,a.CUENTA_CONT,a.SUCUENTA_CONT)) AND MONEDA=a.MONEDA AND SUCURSAL=(SELECT NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO=21))
	WHERE a.ASIENTO=@asiento AND a.FECHA_ASIENTO=@fecha_asiento AND SATELITE=''UNITRADE'' AND ESTADO=''S''
	ORDER BY NRO_ORDEN
	
	IF(1<(SELECT COUNT(1) FROM BANDEJA_MOVS_IN WHERE JTS_OID_ASIENTO=(SELECT MAX(JTS_OID) FROM BANDEJA_ASIENTOS_IN WHERE ESTADO=''S'' AND ORIGEN=''UNT'')))
	BEGIN
	UPDATE dbo.ITF_ASIENTOS_EXTERNOS
	SET ESTADO=''P'', ID_LOTE=(SELECT MAX(JTS_OID) FROM BANDEJA_ASIENTOS_IN WHERE ESTADO=''S'' AND ORIGEN=''UNT'')
	WHERE SATELITE=''UNITRADE'' AND ESTADO=''S'' AND ASIENTO=@asiento AND @fecha_asiento=FECHA_ASIENTO;
	
	DELETE FROM ITF_ASIENTOS_EXTERNOS  
    WHERE SATELITE=''UNITRADE'' AND ESTADO=''P'' AND ASIENTO=@asiento AND FECHA_ASIENTO = @fecha_asiento
      AND ID_LOTE=(SELECT MAX(JTS_OID) FROM BANDEJA_ASIENTOS_IN WHERE ESTADO=''S'' AND ORIGEN=''UNT'');
	
	END
	ELSE
	BEGIN
	UPDATE dbo.ITF_ASIENTOS_EXTERNOS
	SET ESTADO=''E'', ID_LOTE=(SELECT MAX(JTS_OID) FROM BANDEJA_ASIENTOS_IN WHERE ESTADO=''S'' AND ORIGEN=''UNT'')
	WHERE SATELITE=''UNITRADE'' AND ESTADO=''S'' AND ASIENTO=@asiento AND @fecha_asiento=FECHA_ASIENTO;
	DELETE FROM dbo.BANDEJA_ASIENTOS_IN
	WHERE JTS_OID = (SELECT MAX(JTS_OID) FROM BANDEJA_ASIENTOS_IN WHERE ESTADO=''S'' AND ORIGEN=''UNT'');
	END
	
	
	SET @idCount = NULL;
	SET @asiento= NULL;
	
	SET @idCount  = (SELECT MIN(ID) FROM ITF_ASIENTOS_EXTERNOS WHERE SATELITE=''UNITRADE'' AND ESTADO=''S'');
	SELECT @asiento = ASIENTO, @fecha_asiento=FECHA_ASIENTO
	FROM ITF_ASIENTOS_EXTERNOS (nolock) WHERE ID=@idCount;
	
	END

    
END
')