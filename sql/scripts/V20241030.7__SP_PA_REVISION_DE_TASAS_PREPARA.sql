EXECUTE('
ALTER PROCEDURE SP_PA_REVISION_DE_TASAS_PREPARA
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime,
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS
BEGIN
DECLARE @CANTIDAD_REGISTROS INT
DECLARE @REVISION_TASAS_AUX TABLE (JTS_OID NUMERIC(10,0), TIPOTASAB VARCHAR(3),TNA_BASE_SALDO NUMERIC(11,7),
							   NUEVA_TNA NUMERIC (11,7),NUEVA_TNA_BASE NUMERIC (11,7), TEA_FINAL NUMERIC(11,7),
							   PUNTOS_TEA NUMERIC (7,4),TEA_BASE NUMERIC (11,7),
							   TIPO_TASA VARCHAR (1), DIVISOR NUMERIC (4),PERIODO NUMERIC(5))
							   
	SET @P_RET_PROCESO = NULL
    SET @P_MSG_PROCESO = NULL
---Insert a la tabla temporal en base a la siguiente query
BEGIN
	INSERT INTO @REVISION_TASAS_AUX
	SELECT JTS_OID, s.TIPOTASAB,
			cs.TASA_CONVERTIDA AS TNA_BASE_SALDO,
			(tb1.TASA_CONVERTIDA+CS.PUNTOS_CONVERTIDOS) AS NUEVA_TNA,
			tb1.TASA_CONVERTIDA AS NUEVA_TNA_BASE,
			0 AS TEA_FINAL,
			0 AS PUNTOS_TEA,
			tb1.TASA AS TEA_BASE,
			''N'' AS TIPO_TASA, --Dejamos N ya que solo se tratan productos efectivas
			prod.C6255 AS DIVISOR,
			360/s.C1642 AS PERIODO
			 FROM SALDOS s WITH (NOLOCK)
			 INNER JOIN CRE_SALDOS cs WITH (NOLOCK) ON cs.SALDOS_JTS_OID=s.JTS_OID
			 INNER JOIN PRODUCTOS prod WITH (NOLOCK) ON prod.C6250=s.PRODUCTO
			 INNER JOIN TOPESPRODUCTO tp WITH (NOLOCK) ON tp.CODPRODUCTO=s.PRODUCTO AND s.MONEDA=tp.MONEDA
			 INNER JOIN (SELECT TIPOTASABASE, max(VIGENCIADESDE) AS VIGENCIADESDE FROM TASASBASE WITH (NOLOCK) WHERE TZ_LOCK=0 
			 GROUP BY TIPOTASABASE) tb ON tb.TIPOTASABASE=s.TIPOTASAB 
			 INNER JOIN TASASBASE tb1 WITH (NOLOCK) ON tb1.TIPOTASABASE = tb.TIPOTASABASE 
			 AND tb1.VIGENCIADESDE=tb.VIGENCIADESDE AND tb1.TZ_LOCK=0
			WHERE s.TZ_LOCK = 0  AND s.C1785 = 5
			  and s.C1604 <0 AND s.C1627 >= (SELECT fechaproceso  FROM PARAMETROS WITH (nolock)) 
			  and s.C1690 in (''V'', ''M'')
			  AND tp.TASA_REVISABLE=''S''
			  AND prod.C6253=''E'' --Dejamos solo productos que manejen tasa efectiva para mantenimiento de puntos
			  AND tb1.TASA_CONVERTIDA<> ISNULL(cs.TASA_CONVERTIDA,0)
			  

	SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM @REVISION_TASAS_AUX)
END
BEGIN
-- TASASBASE.TASA_CONVERTIDA + CRE_SALDOS.PUNTOS_CONVERTIDOS --> NUEVA T.N.A FINAL
-- Convertir T.N.A Final en T.E.A con funcion CONVERSION_TASA = T.E.A final
--La funcion me pide parametros que vamos a tener que insertar en TBL_AUX (?)
--Sacar periodo
	UPDATE @REVISION_TASAS_AUX
	SET TEA_FINAL = dbo.CONVERSION_TASA(PERIODO,NUEVA_TNA,TIPO_TASA,DIVISOR)

-- Update saldos set PUNTOSTASA = nuevos puntos tea
--De donde salen NUEVOS PUNTOS TEA
	UPDATE s 
	SET s.PUNTOSTASA= RTA.TEA_FINAL-RTA.TEA_BASE
	FROM SALDOS s
	INNER JOIN @REVISION_TASAS_AUX RTA ON s.JTS_OID=RTA.JTS_OID
	
END
    SET @P_MSG_PROCESO = ''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros''     
           
    SET @P_RET_PROCESO = 1
      
    DECLARE @p_tipo_error varchar(80)
    SET @p_tipo_error=''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros'' 

EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
				@P_ID_PROCESO,
		    	@P_DT_PROCESO,
		    	''SP_PA_REVISION_DE_TASAS_PREPARA'',
		    	@P_RET_PROCESO,
		    	@P_MSG_PROCESO,
		    	@p_tipo_error
		    	
		    	
END
')