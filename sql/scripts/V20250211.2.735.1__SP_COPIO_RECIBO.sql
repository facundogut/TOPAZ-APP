EXECUTE('
ALTER PROCEDURE [dbo].[SP_COPIO_RECIBO]  
   @SOLICITUD NUMERIC(12,0),
   @DOCUMENTO VARCHAR(20)
AS 
  
BEGIN
   
   DECLARE @CANT_RECIBOS INT = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO = 251)
   
   -- Obtenemos el periodo maximo que tiene recibos para buscar recibos del mismo
   DECLARE @MAX_PERIODO VARCHAR(10) = (SELECT TOP 1
   CASE WHEN charindex(''/'',PERIODO) = 0 THEN PERIODO ELSE CAST(SUBSTRING(PERIODO, 4, 4) + SUBSTRING(PERIODO, 1, 2) AS VARCHAR(10)) END
   							  FROM(	select *, 
									row_number() over (partition by ID_BENEFICIO, JURIDICCION, NOMBRE_BENEFICIO 
									order by CASE WHEN charindex(''/'',PERIODO) = 0 THEN PERIODO 
									ELSE CAST(SUBSTRING(PERIODO, 4, 4) + SUBSTRING(PERIODO, 1, 2) AS VARCHAR(10)) END  desc) as rn 
									from CRE_SOL_RECIBO_SUELDO WITH (NOLOCK)
									WHERE DOCUMENTO = @DOCUMENTO 
										AND TZ_LOCK = 0 AND DESCARTADO = ''N'') t
							  WHERE t.rn =1
							  ORDER BY CASE WHEN charindex(''/'',PERIODO) = 0 THEN PERIODO ELSE CAST(SUBSTRING(PERIODO, 4, 4) + SUBSTRING(PERIODO, 1, 2) AS VARCHAR(10)) END DESC);
   -- Obtenemos periodo proceso - 2 para comparar
   -- Convierto el periodo a una fecha (primer dia mes)
    DECLARE @FECHAPROCESO DATE;
    SET @FECHAPROCESO = (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))
    -- Restar 2 meses
    SET @FECHAPROCESO = DATEADD(MONTH, -2, @FECHAPROCESO);
    -- obtengo nuevo periodo formato aaaamm
    DECLARE @PERIODO_MIN VARCHAR(6);
    SET @PERIODO_MIN = FORMAT(@FECHAPROCESO, ''yyyyMM'');
    -- devuelvo el nuevo periodo
   -- SELECT @PERIODO_MIN AS periodo_resultante;
    
    
   -- Si @MAX_PERIODO es mayor o igual a @PERIODO_MIN 
   IF (@MAX_PERIODO>=@PERIODO_MIN)  						  
		INSERT INTO dbo.CRE_SOL_RECIBO_SUELDO_DET (SOLICITUD, NUMERO_RECIBO, DOCUMENTO, CONCEPTO, DESCRIPCION, IMPORTE, ACUMULADOR, PORCENTAJE_AFECTACION, HABITUAL, TZ_LOCK, IMPORTE_AFECTADO)
		SELECT @SOLICITUD AS SOLICITUD, d.NUMERO_RECIBO, d.DOCUMENTO, CONCEPTO, DESCRIPCION, IMPORTE, ACUMULADOR, PORCENTAJE_AFECTACION, HABITUAL, TZ_LOCK, 
			CASE WHEN (	SELECT CUOTA_MAXIMA 
						FROM CRE_RECIBOACUMULADOR WITH (NOLOCK)
						WHERE TZ_LOCK = 0 
							AND CODIGO IN (	SELECT COD_ACUMULADOR 
											FROM CRE_RECIBOCONCEPTO WITH (NOLOCK)
											WHERE CODIGO = d.CONCEPTO 
												AND TZ_LOCK = 0)) = ''N'' THEN 0 
			ELSE CASE WHEN HABITUAL = ''N'' THEN 0 ELSE ROUND((IMPORTE*PORCENTAJE_AFECTACION/100),2) END END AS IMPORTE_AFECTADO
		FROM CRE_SOL_RECIBO_SUELDO_DET d WITH (NOLOCK)
		INNER JOIN (
					SELECT MAX(t.SOLICITUD) AS SOLICITUD, t.NUMERO_RECIBO, t.DOCUMENTO 
					FROM (	select *, 
								row_number() over (partition by ID_BENEFICIO, JURIDICCION, NOMBRE_BENEFICIO order by CASE WHEN charindex(''/'',PERIODO) = 0 THEN PERIODO 
									ELSE CAST(SUBSTRING(PERIODO, 4, 4) + SUBSTRING(PERIODO, 1, 2) AS VARCHAR(10)) END desc) as rn 
							from CRE_SOL_RECIBO_SUELDO WITH (NOLOCK)
							WHERE DOCUMENTO = @DOCUMENTO AND TZ_LOCK = 0 AND DESCARTADO = ''N'' AND PERIODO=@MAX_PERIODO) t
					WHERE t.rn BETWEEN 1 AND @CANT_RECIBOS GROUP BY t.NUMERO_RECIBO, t.DOCUMENTO) c
					ON c.SOLICITUD = d.SOLICITUD AND c.NUMERO_RECIBO = d.NUMERO_RECIBO AND c.DOCUMENTO = d.DOCUMENTO
		WHERE d.TZ_LOCK = 0;
		
		INSERT INTO dbo.CRE_SOL_RECIBO_SUELDO (SOLICITUD, NUMERO_RECIBO, DOCUMENTO, PERIODO, CONVENIO, ID_BENEFICIO, JURIDICCION, FECHA_INGRESO, HABERES, DESCUENTOS, DEDUCCIONES, LIQUIDO, SITUACION_REVISTA, NETO, TZ_LOCK, COPIADO, DESCARTADO, NOMBRE_BENEFICIO)
		SELECT @SOLICITUD AS SOLICITUD, NUMERO_RECIBO, DOCUMENTO, PERIODO, CONVENIO, ID_BENEFICIO, JURIDICCION, FECHA_INGRESO, HABERES, DESCUENTOS, DEDUCCIONES, LIQUIDO, SITUACION_REVISTA, NETO, TZ_LOCK, ''S'' AS COPIADO, ''N'' AS DESCARTADO, NOMBRE_BENEFICIO 
		FROM(	select *,
					row_number() over (partition by ID_BENEFICIO, JURIDICCION, NOMBRE_BENEFICIO order by CASE WHEN charindex(''/'',PERIODO) = 0 THEN PERIODO 
									ELSE CAST(SUBSTRING(PERIODO, 4, 4) + SUBSTRING(PERIODO, 1, 2) AS VARCHAR(10)) END desc) as rn 
				from CRE_SOL_RECIBO_SUELDO WITH (NOLOCK) 
				WHERE DOCUMENTO = @DOCUMENTO 
					AND TZ_LOCK = 0 AND DESCARTADO = ''N'' AND PERIODO=@MAX_PERIODO
					AND NUMERO_RECIBO IN (SELECT DISTINCT NUMERO_RECIBO FROM CRE_SOL_RECIBO_SUELDO_DET  WITH (NOLOCK) WHERE DOCUMENTO = @DOCUMENTO AND SOLICITUD = @SOLICITUD)
					AND SOLICITUD = (SELECT MAX(SOLICITUD) FROM CRE_SOL_RECIBO_SUELDO WITH (NOLOCK) WHERE DOCUMENTO = @DOCUMENTO 
					AND TZ_LOCK = 0 AND DESCARTADO = ''N'' AND PERIODO=@MAX_PERIODO)) t
		WHERE t.rn BETWEEN 1 AND @CANT_RECIBOS;  ----1
		
END
')