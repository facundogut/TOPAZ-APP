EXECUTE('
ALTER   PROCEDURE SP_CALCULA_GRADUACION
    @CLIENTE NUMERIC(12,0), 
    @PERSONA NUMERIC(12,0), 
    @IMPORTE_SOLICITUD NUMERIC(18,2),
    @EXCLUIDO VARCHAR(1),
    @CON_GTIA VARCHAR(1),
    @TOTAL_DEUDA    NUMERIC(18,2) OUTPUT,
    @TRAMO_SIN_G   NUMERIC(18,2) OUTPUT, 
    @TRAMO_CON_G  NUMERIC(18,2) OUTPUT,
    @TRAMO_SIN_G_B   NUMERIC(18,2) OUTPUT, 
    @TRAMO_CON_G_B  NUMERIC(18,2) OUTPUT,
    @RPC_BANCO NUMERIC(18,2)OUTPUT,
    @EXCLUSIONES NUMERIC(18,2)OUTPUT,
    @TOT_CONTROL_GRAD NUMERIC(18,2)OUTPUT,
    @RPC_CLIENTE NUMERIC(18,2)OUTPUT,
    @RPC_CLIENTE_MAX NUMERIC(18,2)OUTPUT,
    @RPC_NETO_BANCO NUMERIC(18,2)OUTPUT,
    @MARGEN_RESGUAR NUMERIC(18,2)OUTPUT,
    @LIMITE_GRAD NUMERIC(18,2)OUTPUT,
    @RESULTADO_GRADUACION VARCHAR(200) OUTPUT,
    @RESULTADO_FRACCIONAMIENTO VARCHAR(200) OUTPUT,
    @IMPORTE_SING_GRUPO NUMERIC(18,2) OUTPUT,
    @IMPORTE_CONG_GRUPO NUMERIC(18,2) OUTPUT,
    @PERIODO VARCHAR(10) OUTPUT,
    --- Parametros
    @CN1_BANCO NUMERIC(18,2) OUTPUT, ---600
    @MARGEN_BASICO NUMERIC(18,2) OUTPUT, ---601
    @RPC_CLIENTE_O NUMERIC(18,2) OUTPUT, ---602
    @RPC_BANCO_O NUMERIC(18,2) OUTPUT, ---603
    @RPC_CLIENTE_SGR_FGP NUMERIC(18,2) OUTPUT, ---604
    @RPC_BANCO_SGR_FGP NUMERIC(18,2) OUTPUT, ---605
    @PORC_TRAMO_SING NUMERIC(18,2) OUTPUT, ---606
    @PORC_TRAMO_CONG NUMERIC(18,2) OUTPUT, ---607
    @MARGEN_RESGUARDO NUMERIC(18,2) OUTPUT, ---608
    @RPC_BANCO_IMP NUMERIC(18,2) OUTPUT, ---609
    --- Descripciones
    @VINCULO VARCHAR(80) OUTPUT,
    @DESCRIPCION_GRUPO VARCHAR(60) OUTPUT,
    --- Deuda tope vinculado
    @MENSAJE_VINCULADOS VARCHAR(200) OUTPUT,
    --- Para operaciones
    @EXCEDE_GRADUACION_O VARCHAR(1) OUTPUT,
    @EXCEDE_FRACCIONAMIENTO_O VARCHAR(1) OUTPUT,
    --- Vinculados
    @TIPO_LIMITE_O VARCHAR(30) OUTPUT,
    @IMPORTE_LIMITEVINC_O NUMERIC(15,2) OUTPUT
AS
BEGIN

	DECLARE @MENOR_MARGEN NUMERIC(18,2);
	DECLARE @TIENE_GRUPO NUMERIC(5);
	DECLARE @GRUPO NUMERIC(12);
	DECLARE @DEUDA_CLIENTE NUMERIC(18,2);
	DECLARE @EXCLUSION_CLIENTE_G NUMERIC(18,2);
	DECLARE @EXCLUSION_ASISTENCIA_G NUMERIC(18,2);
	DECLARE @EXCLUSION_PRODUCTO_G NUMERIC(18,2);
	DECLARE @EXCLUSION_GARANTIA_G NUMERIC(18,2);
	DECLARE @EXCLUSION_DESCUENTO_G NUMERIC(18,2);
	/*DECLARE @EXCLUSION_CLIENTE_F_CONG NUMERIC(18,2);
	DECLARE @EXCLUSION_CLIENTE_F_SING NUMERIC(18,2);
	DECLARE @EXCLUSION_ASISTENCIA_F_CONG NUMERIC(18,2);
	DECLARE @EXCLUSION_ASISTENCIA_F_SING NUMERIC(18,2);
	DECLARE @EXCLUSION_PRODUCTO_F_CONG NUMERIC(18,2);
	DECLARE @EXCLUSION_PRODUCTO_F_SING NUMERIC(18,2);
	DECLARE @EXCLUSION_GARANTIA_F_SING NUMERIC(18,2);
	DECLARE @EXCLUSION_GARANTIA_F_CONG NUMERIC(18,2);*/
	DECLARE @CLIENTE_EXCLUIDO_GRAD NUMERIC (12,0);
	DECLARE @CLIENTE_EXCLUIDO_FRACC NUMERIC (12,0);
	DECLARE @EXCEDE_GRADUACION VARCHAR(1);
	DECLARE @EXCEDE_FRACCIONAMIENTO VARCHAR(1);
	DECLARE @TOTAL_DEUDA_GRUPO NUMERIC (18,2);
	DECLARE @EXCLUSIONES_GRUPALES_GRADUACION NUMERIC (18,2);
	DECLARE @IMPORTE_A_EVALUAR NUMERIC (20,2);
	DECLARE @TABLA_ASISTENCIAS TABLE (CLIENTE NUMERIC(12), JTS_ASISTENCIA NUMERIC(10),
	IMPORTE_DEUDA NUMERIC(18,2), TIENE_GARANTIA VARCHAR(1), TIPO_GARANTIA NUMERIC(2),
	PRODUCTO NUMERIC(5), FAMILIA NUMERIC(10), PERSONA NUMERIC(12))
	DECLARE @ES_VINCULADO NUMERIC(2)
	DECLARE @TOPE_ANALISIS NUMERIC(18,2)
	DECLARE @TIPO_VINCULO NUMERIC(3)
	DECLARE @RESULTADO_GRAD_GRUPO VARCHAR(200)
	DECLARE @RESULTADO_FRACC_GRUPO VARCHAR(200)
	DECLARE @EXCEDE_GRAD_VINC VARCHAR(1)
	DECLARE @RESULTADO_IND_VINC VARCHAR(200)
	DECLARE @RESULTADO_GRUP_VINC VARCHAR(200)
	DECLARE @TIPO_LIMITE VARCHAR(30)
    DECLARE @IMPORTE_LIMITEVINC NUMERIC(15,2)


--Chequeo de vinculado
	SET @ES_VINCULADO = (SELECT COUNT(1) FROM CRE_VINCULACIONES CV WITH(NOLOCK)  
						INNER JOIN CRE_VINCULOS_RELACIONES CVR WITH(NOLOCK) ON CV.TIPO_RELACION = CVR.TIPO_RELACION AND CV.TIPO_VINCULO = CVR.ID_VINCULO
						WHERE CV.TZ_LOCK=0 AND CVR.TZ_LOCK = 0
						AND ID_PERSONA_VINCULADA IN (SELECT NUMEROPERSONA FROM CLI_ClientePersona WITH(NOLOCK) WHERE 
						TZ_LOCK = 0 AND CODIGOCLIENTE = @CLIENTE AND TITULARIDAD=''T'') 
						AND (((CASE WHEN CVR.PARAMETRO_613 = ''N'' THEN CV.FECHA_FIN
						ELSE DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),CV.FECHA_FIN) END) >=
						(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))) OR CV.FECHA_FIN IS NULL))
						
--Chequeo de grupo
	SELECT @TIENE_GRUPO=COUNT(1), @GRUPO=A.CODIGOGRUPOECONOMICO FROM dbo.CLI_GRUPOSECONOMICOSCLIENTE A WITH(NOLOCK)
	INNER JOIN  dbo.CLI_CLIENTES B WITH(NOLOCK) ON A.CODIGOCLIENTE = B.CODIGOCLIENTE AND B.CODIGOCLIENTE = @CLIENTE 
	AND B.TZ_LOCK = 0 WHERE A.TZ_LOCK = 0 GROUP BY A.CODIGOGRUPOECONOMICO						
	
----------------VARIABLES GENERALES--------------------------------------------------------------------------------------------- 
	SET @CN1_BANCO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=600);
	SET @MARGEN_BASICO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=601);
	SET @RPC_BANCO_IMP = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=609);
	SET @RPC_BANCO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=609);
	SET @RPC_CLIENTE_SGR_FGP = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=604);
	SET @RPC_BANCO_SGR_FGP = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=605);
	SET @PORC_TRAMO_SING = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=606);
	SET @PORC_TRAMO_CONG = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=607);
	SET @TRAMO_SIN_G_B = (@CN1_BANCO * (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=606))/100;
	SET @TRAMO_CON_G_B = (@CN1_BANCO * (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=607))/100;	
	SET @PERIODO = SUBSTRING(CONVERT(VARCHAR(10),DATEADD(month, -2 , (SELECT fechaproceso FROM PARAMETROS WITH(nolock))), 112),1,6);
    SET @IMPORTE_CONG_GRUPO = 0;
	SET @IMPORTE_SING_GRUPO = 0;	
	
	--NO Vinculados
	IF(@ES_VINCULADO = 0 OR @ES_VINCULADO IS NULL)
		BEGIN
			SET @RPC_CLIENTE_O = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=602);
			SET @MARGEN_RESGUARDO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=608);
			SET @RPC_BANCO_O = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=603);
			SET @RPC_CLIENTE = ISNULL((SELECT TOP 1 RPC FROM CRE_TAM_EMP_BALANCE WITH(NOLOCK) WHERE TZ_LOCK = 0 AND ID_PERSONA = @PERSONA AND F_FINAL >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) ORDER BY F_FINAL DESC),0)
			SET @TIPO_LIMITE_O = '''';
			SET @IMPORTE_LIMITEVINC_O = 0;
		END
	--Vinculados	
    ELSE
	    BEGIN
	    	DECLARE @VINCULANTE_DIR NUMERIC(5)
			DECLARE @DIRECTORES NUMERIC(5)
			
			SET @DIRECTORES = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 620)
			SET @RPC_CLIENTE = ISNULL((SELECT TOP 1 RPC FROM CRE_TAM_EMP_BALANCE WITH(NOLOCK) WHERE TZ_LOCK = 0 AND ID_PERSONA = @PERSONA AND F_FINAL >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) ORDER BY F_FINAL DESC),0)
			
			IF(@RPC_CLIENTE = 0)
			BEGIN
	    		SET @RPC_CLIENTE_O = 0;
	    		SET @RPC_CLIENTE = 0;	
				SET @MARGEN_RESGUARDO = 0;
				SET @RPC_BANCO_O = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=603);  	  
			END		
			ELSE
			BEGIN
				SET @RPC_CLIENTE_O = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=602);
				SET @MARGEN_RESGUARDO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=608);
				SET @RPC_BANCO_O = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=603);
			END

	    		    	
	    	----Busca si el vinculante es director
	    	SET @VINCULANTE_DIR = (SELECT COUNT(1) FROM CRE_VINCULACIONES V WITH(NOLOCK) 
	    	INNER JOIN CRE_VINCULOS_RELACIONES VR WITH(NOLOCK) ON V.TIPO_RELACION = VR.TIPO_RELACION AND V.TIPO_VINCULO = VR.ID_VINCULO
	    	WHERE V.ID_PERSONA_VINCULADA = @PERSONA AND V.TZ_LOCK = 0 AND VR.TZ_LOCK = 0
			AND V.TIPO_VINCULO IN (SELECT ID_VINCULO FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK) WHERE EVALUA_MAYOR_DEUDA = ''S'') 
			AND V.ID_PERSONA_VINCULANTE IN (SELECT ID_PERSONA_VINCULADA 
			FROM CRE_VINCULACIONES VINC WITH(NOLOCK) 
			INNER JOIN CRE_VINCULOS_RELACIONES VINCR WITH(NOLOCK) ON VINC.TIPO_RELACION = VINCR.TIPO_RELACION AND VINC.TIPO_VINCULO = VINCR.ID_VINCULO
			WHERE VINC.TIPO_VINCULO = @DIRECTORES AND VINC.TZ_LOCK = 0 AND VINCR.TZ_LOCK = 0
			AND VINC.FECHA_INICIO <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			AND (((CASE WHEN VINCR.PARAMETRO_613 = ''N'' THEN VINC.FECHA_FIN
			ELSE DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),VINC.FECHA_FIN) END) >=
			(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))) OR VINC.FECHA_FIN IS NULL))
			AND V.FECHA_INICIO <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) AND 
			(((CASE WHEN VR.PARAMETRO_613 = ''N'' THEN V.FECHA_FIN
			ELSE DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),V.FECHA_FIN) END) >=
			(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))) OR V.FECHA_FIN IS NULL))
			
			IF(@VINCULANTE_DIR > 0)
			BEGIN
				DECLARE @VINC_VINCULANTE NUMERIC(15)
				
				SET @VINC_VINCULANTE = (SELECT TOP 1 ID_PERSONA_VINCULANTE FROM CRE_VINCULACIONES V WITH(NOLOCK) 
	    		INNER JOIN CRE_VINCULOS_RELACIONES VR WITH(NOLOCK) ON V.TIPO_RELACION = VR.TIPO_RELACION AND V.TIPO_VINCULO = VR.ID_VINCULO
	    		WHERE V.ID_PERSONA_VINCULADA = @PERSONA AND V.TZ_LOCK = 0 AND VR.TZ_LOCK = 0
				AND V.TIPO_VINCULO IN (SELECT ID_VINCULO FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK) WHERE EVALUA_MAYOR_DEUDA = ''S'') 
				AND V.ID_PERSONA_VINCULANTE IN (SELECT ID_PERSONA_VINCULADA 
				FROM CRE_VINCULACIONES VINC WITH(NOLOCK) 
				INNER JOIN CRE_VINCULOS_RELACIONES VINCR WITH(NOLOCK) ON VINC.TIPO_RELACION = VINCR.TIPO_RELACION AND VINC.TIPO_VINCULO = VINCR.ID_VINCULO
				WHERE VINC.TIPO_VINCULO = @DIRECTORES AND VINC.TZ_LOCK = 0 AND VINCR.TZ_LOCK = 0
				AND VINC.FECHA_INICIO <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
				AND (((CASE WHEN VINCR.PARAMETRO_613 = ''N'' THEN VINC.FECHA_FIN
				ELSE DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),VINC.FECHA_FIN) END) >=
				(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))) OR VINC.FECHA_FIN IS NULL))
				AND V.FECHA_INICIO <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) AND 
				(((CASE WHEN VR.PARAMETRO_613 = ''N'' THEN V.FECHA_FIN
				ELSE DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),V.FECHA_FIN) END) >=
				(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))) OR V.FECHA_FIN IS NULL))
			
				--- Busco tipo de vinculación
	    		SET @TIPO_VINCULO = (SELECT TOP 1 TIPO_VINCULO FROM CRE_VINCULACIONES CV WITH(NOLOCK)  
									INNER JOIN CRE_VINCULOS_RELACIONES CVR WITH(NOLOCK) ON CV.TIPO_RELACION = CVR.TIPO_RELACION AND CV.TIPO_VINCULO = CVR.ID_VINCULO
									WHERE CV.TZ_LOCK=0 AND CVR.TZ_LOCK = 0 AND CV.ID_PERSONA_VINCULANTE = @VINC_VINCULANTE
									AND ID_PERSONA_VINCULADA IN (SELECT NUMEROPERSONA FROM CLI_ClientePersona WITH(NOLOCK) WHERE 
									TZ_LOCK = 0 AND CODIGOCLIENTE = @CLIENTE) AND ((CASE WHEN CVR.PARAMETRO_613 = ''N'' THEN CV.FECHA_FIN
									ELSE DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),CV.FECHA_FIN) END) >=
									(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) OR CV.FECHA_FIN IS NULL)
									ORDER BY CV.TIPO_VINCULO ASC, CV.TIPO_RELACION DESC)
									
				SET @VINCULO = (SELECT DESCRIPCION_VINCULO FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK) WHERE ID_VINCULO = @TIPO_VINCULO)
			
			END
			ELSE
			BEGIN
				--- Busco tipo de vinculación
	    		SET @TIPO_VINCULO = (SELECT TOP 1 TIPO_VINCULO FROM CRE_VINCULACIONES CV WITH(NOLOCK)  
									INNER JOIN CRE_VINCULOS_RELACIONES CVR WITH(NOLOCK) ON CV.TIPO_RELACION = CVR.TIPO_RELACION AND CV.TIPO_VINCULO = CVR.ID_VINCULO
									WHERE CV.TZ_LOCK=0 AND CVR.TZ_LOCK = 0
									AND ID_PERSONA_VINCULADA IN (SELECT NUMEROPERSONA FROM CLI_ClientePersona WITH(NOLOCK) WHERE 
									TZ_LOCK = 0 AND CODIGOCLIENTE = @CLIENTE) AND ((CASE WHEN CVR.PARAMETRO_613 = ''N'' THEN CV.FECHA_FIN
									ELSE DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),CV.FECHA_FIN) END) >=
									(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) OR CV.FECHA_FIN IS NULL)
									ORDER BY CV.TIPO_VINCULO ASC, CV.TIPO_RELACION DESC)
									
				SET @VINCULO = (SELECT DESCRIPCION_VINCULO FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK) WHERE ID_VINCULO = @TIPO_VINCULO)
			END

	    	--- Busco si tiene tramo parametrizado
	    	SET @TRAMO_SIN_G_B = (@CN1_BANCO*(SELECT PORC_GRANDES_EXP_SING FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK)
	       							WHERE TZ_LOCK = 0 AND ID_VINCULO = @TIPO_VINCULO))/100;
	    	
	    	SET @TRAMO_CON_G_B = (@CN1_BANCO*(SELECT PORC_GRANDES_EXP_CNG FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK)
	    							WHERE TZ_LOCK = 0 AND ID_VINCULO = @TIPO_VINCULO))/100;
	    							

	    	
	    	IF(@TRAMO_SIN_G_B IS NOT NULL)
		    BEGIN
		    	SET @PORC_TRAMO_SING = (SELECT PORC_GRANDES_EXP_SING FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK)
		    	WHERE TZ_LOCK = 0 AND ID_VINCULO = @TIPO_VINCULO);
	    	END
	    	
	    	IF(@TRAMO_CON_G_B IS NOT NULL)
		    BEGIN
		    	SET @PORC_TRAMO_CONG = (SELECT PORC_GRANDES_EXP_CNG FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK)
		    	WHERE TZ_LOCK = 0 AND ID_VINCULO = @TIPO_VINCULO);
	    	END
	    	
	    	IF(@VINCULANTE_DIR>0)
	    	BEGIN
	    		SET @TRAMO_SIN_G_B = 0
	    		SET @TRAMO_CON_G_B = 0
	    		SET @PORC_TRAMO_SING = 0
	    		SET @PORC_TRAMO_CONG = 0
	    	END
	    	
	    END
    
    
	---Calcula RPC máximo cliente
	SET @RPC_CLIENTE_MAX = @RPC_CLIENTE + ((@RPC_CLIENTE * @RPC_CLIENTE_O)/100);
	---Calcula RPC Neto banco
	SET @RPC_NETO_BANCO = @RPC_CLIENTE + ((@RPC_BANCO * (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 603))/100);
	---Busca menor margen para calcular límite de graduación
	SET @MENOR_MARGEN = (SELECT CASE WHEN @RPC_CLIENTE_MAX < @RPC_NETO_BANCO THEN @RPC_CLIENTE_MAX ELSE @RPC_NETO_BANCO END);
	---Calcula margen resguardo
	SET @MARGEN_RESGUAR = ((@MENOR_MARGEN)*(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 608))/100; 
	---Calcula límite de graduación
	SET @LIMITE_GRAD = 	(@MENOR_MARGEN)-@MARGEN_RESGUAR;
	IF  @LIMITE_GRAD<0
		BEGIN 
			SET @LIMITE_GRAD=0;
		END
		
	--Chequeo de cliente exluido
	SET @CLIENTE_EXCLUIDO_GRAD =(SELECT COUNT(*) FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE CODIGOCLIENTE=@CLIENTE AND TZ_LOCK = 0);  
	SET @CLIENTE_EXCLUIDO_FRACC = 0;  
    
	-- Si la deuda total supera el % por sobre el importe de referencia establecido, queda encuadradro en graduacion. Se obtiene valor
    SET @TOPE_ANALISIS = ((SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=501) * 
	(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=615)); 
	
	
---------------ASISTENCIAS DEL CLIENTE------------------------------------------------------	
	INSERT INTO @TABLA_ASISTENCIAS
	SELECT 
	AD.CLIENTE,
	AD.JTS_OID,
	SUM(AD.SALDO_DEUDA),
	CASE 
	WHEN gar.TIPO_GARANTIA IS NULL THEN ''N''
	ELSE ''S''
	END AS GARANTIA,
	ISNULL(gar.TIPO_GARANTIA,0),
	p.C6250, 
	p.C6283,
	AD.NUMEROPERSONA
	FROM VW_DEUDA_CLIENTES AD WITH(NOLOCK)
	INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = AD.JTS_OID
	INNER JOIN PRODUCTOS p WITH(NOLOCK) ON s.PRODUCTO = p.C6250 
	AND ( (p.tz_lock < 300000000000000 OR p.tz_lock >= 400000000000000) 
	AND (p.tz_lock < 100000000000000 OR p.tz_lock >= 200000000000000)  )
	LEFT JOIN (SELECT DISTINCT CG.JTSOID_SALDO, CTG.TIPO_GARANTIA FROM CRE_GARANTIACREDITO CG WITH(NOLOCK)
	LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA
	LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND
	CTG.TIPO_BCRA IN (1,2)) gar ON gar.JTSOID_SALDO = S.JTS_OID
	WHERE AD.SALDO_DEUDA <> 0 ---AND S.C1785 IN (1,5,6)
	AND AD.NUMEROPERSONA = @PERSONA
	GROUP BY AD.JTS_OID, gar.JTSOID_SALDO, gar.TIPO_GARANTIA, p.C6250, p.C6283, AD.CLIENTE, AD.NUMEROPERSONA

	---Seteo deuda total cliente
	SET @DEUDA_CLIENTE=ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS  
						WHERE PERSONA = @PERSONA),0);
	   					
   --- Exclusiones cliente	
	SET @EXCLUSION_CLIENTE_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
								FROM @TABLA_ASISTENCIAS WHERE PERSONA = @PERSONA 
								AND CLIENTE IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
								WHERE TZ_LOCK=0)),0);
								
	--- Exclusiones descuentos
	SET @EXCLUSION_DESCUENTO_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS WHERE PERSONA = @PERSONA
								 AND CLIENTE NOT IN (SELECT CODIGOCLIENTE 
								 FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE TZ_LOCK=0)
								 AND JTS_ASISTENCIA IN (SELECT DISTINCT JTS_OID FROM VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO CD WITH (NOLOCK) 
								 WHERE EXISTS (SELECT 1 FROM CRE_EXCLUSIONES_CUIT_EMISOR CE WITH(NOLOCK)
								 WHERE CE.NUMERODOCUMENTO = CD.documento_librador AND CE.CUENTA_FORANEA = CD.numerico_cuenta_giradora AND CE.TZ_LOCK=0) 
								 AND CD.jts_oid <> 0)),0);

	--- Exlusiones asistencias
	SET @EXCLUSION_ASISTENCIA_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
								FROM @TABLA_ASISTENCIAS WHERE PERSONA = @PERSONA
								AND CLIENTE NOT IN (SELECT CODIGOCLIENTE 
								FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE TZ_LOCK=0)
								AND JTS_ASISTENCIA NOT IN (SELECT DISTINCT JTS_OID FROM VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO CD WITH(NOLOCK) 
								WHERE EXISTS (SELECT 1 FROM CRE_EXCLUSIONES_CUIT_EMISOR CE WITH(NOLOCK)
								WHERE CE.NUMERODOCUMENTO = CD.documento_librador AND CE.CUENTA_FORANEA = CD.numerico_cuenta_giradora AND CE.TZ_LOCK=0) 
								AND CD.jts_oid <> 0)
								AND JTS_ASISTENCIA IN (SELECT ASISTENCIA_JTS_OID 
								FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) WHERE TZ_LOCK=0)),0);
		
	--- Exclusiones producto-familia
	SET @EXCLUSION_PRODUCTO_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
								FROM @TABLA_ASISTENCIAS WHERE PERSONA = @PERSONA
								AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
								WHERE TZ_LOCK=0)
								AND JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) 
								WHERE TZ_LOCK=0)
								AND (PRODUCTO IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
								WHERE TIPO=''P'' AND TZ_LOCK=0)
								OR (FAMILIA IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
								WHERE TIPO=''F'' AND TZ_LOCK=0)))),0);
		
	--- Exlusiones garantia
	SET @EXCLUSION_GARANTIA_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
								FROM @TABLA_ASISTENCIAS WHERE PERSONA = @PERSONA
								AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
								WHERE TZ_LOCK=0)
								AND JTS_ASISTENCIA NOT IN (SELECT DISTINCT JTS_OID FROM VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO CD WITH(NOLOCK) 
								WHERE EXISTS (SELECT 1 FROM CRE_EXCLUSIONES_CUIT_EMISOR CE WITH(NOLOCK)
								WHERE CE.NUMERODOCUMENTO = CD.documento_librador AND CE.CUENTA_FORANEA = CD.numerico_cuenta_giradora AND CE.TZ_LOCK=0) 
								AND CD.jts_oid <> 0)
								AND JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) 
								WHERE TZ_LOCK=0)
								AND PRODUCTO NOT IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
								WHERE TIPO=''P'' AND TZ_LOCK=0)
								AND FAMILIA NOT IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
								WHERE TIPO=''F'' AND TZ_LOCK=0) AND TIPO_GARANTIA IN (SELECT TIPO_GARANTIA
								FROM CRE_EXCLUSIONES_TIPOSGARANTIAS WITH(NOLOCK) WHERE TZ_LOCK = 0)),0);

	-----------------------------------ATENCION-------------------------------------------------------------------------------------
	-- Este es el parametro a tener en cuenta para controlar en las solicitudes si el producto que esta contratando esta excluido
	-- o no del control. Refinanciaciones deberian enviar desde las operaciones dicho valor en S para que el importe de la solicitud
	-- no sea considerado
	-----------------------------------ATENCION-------------------------------------------------------------------------------------	

	SET @TOTAL_DEUDA=ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS
	WHERE PERSONA = @PERSONA),0)+@IMPORTE_SOLICITUD;

    
    ---Setea exclusiones GRADUACION
	SET @EXCLUSIONES = @EXCLUSION_CLIENTE_G+@EXCLUSION_ASISTENCIA_G+@EXCLUSION_PRODUCTO_G+@EXCLUSION_GARANTIA_G+@EXCLUSION_DESCUENTO_G+(CASE WHEN @EXCLUIDO = ''N'' THEN 0 ELSE @IMPORTE_SOLICITUD END);
    ---Setea importe a analizar para graduación
	SET @TOT_CONTROL_GRAD = @TOTAL_DEUDA - @EXCLUSIONES;				
		
	--Determinar a que tramo se suma el importe de la simulacion	
	IF(@CON_GTIA = ''S'')
		BEGIN
			SET @TRAMO_CON_G = ISNULL((ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS  
	   							WHERE PERSONA=@PERSONA AND TIENE_GARANTIA = ''S''),0)+@IMPORTE_SOLICITUD),0);
			SET @TRAMO_SIN_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS 
								WHERE PERSONA=@PERSONA AND TIENE_GARANTIA = ''N''),0);
		END
	ELSE
		BEGIN
			SET @TRAMO_CON_G = ISNULL(ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS
	   							WHERE PERSONA=@PERSONA AND TIENE_GARANTIA = ''S''),0),0);
			SET @TRAMO_SIN_G = (ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS 
								WHERE PERSONA=@PERSONA AND TIENE_GARANTIA = ''N''),0)+@IMPORTE_SOLICITUD);
		END
	
-----------------CLIENTE SIN GRUPO ECONOMICO------------------------------------------------
--RESULTADO ANALISIS
	IF(@TIENE_GRUPO=0 OR @TIENE_GRUPO IS NULL)
		--GRADUACION
		BEGIN 		
			IF (@TOPE_ANALISIS>@TOTAL_DEUDA AND @ES_VINCULADO = 0)
				BEGIN
					SET @RESULTADO_GRADUACION =  concat(''Encuadrado (Riesgo Total < '' , (SELECT LTRIM(STR(IMPORTE))  FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=615) , ''IR)'');
					SET @EXCEDE_GRADUACION_O = ''N''
				END	
    		ELSE IF((@LIMITE_GRAD>=@TOT_CONTROL_GRAD OR @RPC_CLIENTE=0))
    			BEGIN
					SET @RESULTADO_GRADUACION = ''Encuadrado.''
					SET @EXCEDE_GRADUACION_O = ''N'';
				END					
			ELSE IF(@CLIENTE_EXCLUIDO_GRAD>0)
				BEGIN
				 	SET @RESULTADO_GRADUACION = ''Encuadrado (Cliente excluido).''
				 	SET @EXCEDE_GRADUACION_O = ''N'';
				END			
			ELSE IF(@LIMITE_GRAD<@TOT_CONTROL_GRAD)
				BEGIN
					SET @RESULTADO_GRADUACION = ''Exceso en Graduación: ''+ CONVERT(VARCHAR(30),FORMAT(ROUND(@TOT_CONTROL_GRAD-@LIMITE_GRAD,2), ''C'', ''es-ar'')) + ''.'';;
					SET @EXCEDE_GRADUACION_O = ''S''
				END
		--GRANDES EXPOSICIONES
		    IF(@CLIENTE_EXCLUIDO_FRACC>0)
				BEGIN
					SET @RESULTADO_FRACCIONAMIENTO = ''Encuadrado (Cliente excluido).'';
					SET @EXCEDE_FRACCIONAMIENTO_O = ''N'';
	 			END
	 		ELSE IF (@TRAMO_SIN_G_B>=@TRAMO_SIN_G AND @TRAMO_CON_G_B>=(@TRAMO_CON_G+@TRAMO_SIN_G) )
				BEGIN
					SET @RESULTADO_FRACCIONAMIENTO = ''Encuadrado en Grandes Exposiciones sin garantía.'' +char(10) + char(13) + ''Encuadrado en Grandes Exposiciones con y sin garantía.'';
					SET @EXCEDE_FRACCIONAMIENTO_O = ''N'';
				END
			ELSE IF (@TRAMO_SIN_G_B>=@TRAMO_SIN_G AND @TRAMO_CON_G_B<(@TRAMO_CON_G+@TRAMO_SIN_G) )
				BEGIN
					SET @RESULTADO_FRACCIONAMIENTO = ''Encuadrado en Grandes Exposiciones sin garantía.'' +char(10) + char(13) + ''Exceso en Grandes Exposiciones con y sin garantía: '' + CONVERT(VARCHAR(30),FORMAT(ROUND((@TRAMO_CON_G+@TRAMO_SIN_G)-@TRAMO_CON_G_B,2), ''C'', ''es-ar'')) + ''.'';
					SET @EXCEDE_FRACCIONAMIENTO_O = ''S'';
				END	
			ELSE IF (@TRAMO_SIN_G_B<@TRAMO_SIN_G AND @TRAMO_CON_G_B>=(@TRAMO_CON_G+@TRAMO_SIN_G) )
				BEGIN
					SET @RESULTADO_FRACCIONAMIENTO = ''Exceso en Grandes Exposiciones sin garantía: '' + CONVERT(VARCHAR(30),FORMAT(ROUND(@TRAMO_SIN_G-@TRAMO_SIN_G_B,2), ''C'', ''es-ar'')) + ''.'' +char(10) + char(13) + ''Encuadrado en Grandes Exposiciones con y sin garantía. '';
					SET @EXCEDE_FRACCIONAMIENTO_O = ''S'';
				END
			ELSE IF (@TRAMO_SIN_G_B<@TRAMO_SIN_G AND @TRAMO_CON_G_B<(@TRAMO_CON_G+@TRAMO_SIN_G) )
				BEGIN
					SET @RESULTADO_FRACCIONAMIENTO = ''Exceso en Grandes Exposiciones sin garantía: '' + CONVERT(VARCHAR(30),FORMAT(ROUND(@TRAMO_SIN_G-@TRAMO_SIN_G_B,2), ''C'', ''es-ar'')) + ''.'' +char(10) + char(13) + ''Exceso en Grandes Exposiciones con y sin garantía: '' + CONVERT(VARCHAR(30),FORMAT(ROUND((@TRAMO_CON_G+@TRAMO_SIN_G)-@TRAMO_CON_G_B,2), ''C'', ''es-ar'')) + ''.'';
					SET @EXCEDE_FRACCIONAMIENTO_O = ''S'';
				END										
 		END
----------------------FIN CLIENTE SIN GRUPO ECONOMICO--------------------------------------------------------


----------------------GRUPOS ECONOMICOS----------------------------------------------------------------------	   
IF(@TIENE_GRUPO > 0)
	BEGIN 		
		EXECUTE SP_CONTROL_GYF_GRUPO @GRUPO,
		@IMPORTE_SOLICITUD,
		@EXCLUIDO,
		@CON_GTIA,
		@CLIENTE,
		@EXCLUIDO,
		@LIMITE_GRAD,
	    @TRAMO_SIN_G_B,
	    @TRAMO_CON_G_B,
	    @RPC_CLIENTE,
	    @PERSONA,
		@EXCEDE_GRADUACION OUTPUT,
		@EXCEDE_FRACCIONAMIENTO OUTPUT,
		@IMPORTE_SING_GRUPO OUTPUT,
	    @IMPORTE_CONG_GRUPO OUTPUT,
	    @TOTAL_DEUDA_GRUPO OUTPUT,
	    @EXCLUSIONES_GRUPALES_GRADUACION OUTPUT,
	    @IMPORTE_A_EVALUAR OUTPUT,
	    @RESULTADO_GRAD_GRUPO OUTPUT,
	    @RESULTADO_FRACC_GRUPO OUTPUT; 
		
		---PARA FRACCIONAMIENTO, IGUALAR CON TRAMO SIN G GRUPO CON TRAMO CON G GRUPO   
		SET @IMPORTE_SING_GRUPO=@IMPORTE_SING_GRUPO;
		--SELECT @IMPORTE_SING_GRUPO;
		SET @IMPORTE_CONG_GRUPO=@IMPORTE_CONG_GRUPO; 
		     
		--- DESCRIPCION DEL GRUPO ECONOMICO
		SET @DESCRIPCION_GRUPO = (SELECT NOMBRE FROM CLI_GRUPOSECONOMICOS WITH(NOLOCK) 
								  WHERE CODIGOGRUPOECONOMICO = @GRUPO)
		
					
--RESULTADO ANALISIS (variables de mensajes vienen definidas del sp SP_CONTROL_GYF_GRUPO)
	--GRADUACION
			BEGIN
				SET @RESULTADO_GRADUACION=@RESULTADO_GRAD_GRUPO; 
				SET @EXCEDE_GRADUACION_O = @EXCEDE_GRADUACION;
			END
		--GRANDES EXPOSICIONES
			BEGIN 
		    	SET @RESULTADO_FRACCIONAMIENTO=@RESULTADO_FRACC_GRUPO;
		    	SET @EXCEDE_FRACCIONAMIENTO_O = @EXCEDE_FRACCIONAMIENTO;
			END
	END		
----------------------FIN GRUPOS ECONOMICOS----------------------------------------------------------------------
	
	
----------------------VINCULADOS----------------------------------------------------------------------------------		
IF(@ES_VINCULADO > 0 AND @TIPO_VINCULO <> 1)
	--CONTROL DE VINCULADOS
		BEGIN
			EXECUTE dbo.SP_CONTROL_GYF_VINCULADOS @CLIENTE, @PERSONA, @TIPO_VINCULO, @IMPORTE_SOLICITUD, @TRAMO_CON_G, @TRAMO_SIN_G, @EXCEDE_GRAD_VINC OUT, @RESULTADO_IND_VINC OUT, 
			@RESULTADO_GRUP_VINC OUT, @TIPO_LIMITE OUT, @IMPORTE_LIMITEVINC OUT
			
			SET @MENSAJE_VINCULADOS = @RESULTADO_GRUP_VINC;
			
			SET @TIPO_LIMITE_O = @TIPO_LIMITE;
			
			SET @IMPORTE_LIMITEVINC_O = @IMPORTE_LIMITEVINC;
			
		END
--RESULTADO ANALISIS	
   IF(@ES_VINCULADO > 0)
   	BEGIN
   		IF(@EXCEDE_GRAD_VINC = ''S'')
		   	BEGIN
		    	SET @RESULTADO_FRACCIONAMIENTO = @RESULTADO_IND_VINC;
		    	---SET @RESULTADO_GRADUACION = @RESULTADO_GRUP_VINC;
		    	---SET @EXCEDE_GRADUACION_O = ''S'';
		    	SET @EXCEDE_FRACCIONAMIENTO_O = ''S'';
		    END
    	ELSE
		   	BEGIN
		   	   IF(@RPC_CLIENTE = 0)
		   	   BEGIN
		       	SET @RESULTADO_GRADUACION = ''Encuadrado'';
		       	SET @EXCEDE_GRADUACION_O = ''N'';
		       END
		       
		       SET @RESULTADO_FRACCIONAMIENTO = @RESULTADO_IND_VINC;
		       SET @EXCEDE_FRACCIONAMIENTO_O = ''N'';
		   	END
   END	
   
----------------------FIN VINCULADOS----------------------------------------------------------------------------------	
	 
 END
')