EXECUTE('
IF OBJECT_ID (''RRII_OperacionesPasivas'') IS NOT NULL
	DROP VIEW RRII_OperacionesPasivas
')
EXECUTE('
CREATE VIEW RRII_OperacionesPasivas AS

SELECT DISTINCT
    GSD.FECHA as FechaParametroEntrada,
    S.SUCURSAL as NroSucursal,
    R.ID3 AS TIPOOPERACION,
    CASE WHEN S.C1785<>4 THEN 
    	S.CUENTA
	ELSE 
    	S.OPERACION
    END AS NROCUENTA,
    CONCAT(YEAR(S.C1620), RIGHT(''0'' + RTRIM(MONTH(S.C1620)), 2), RIGHT(''0'' + RTRIM(DAY(S.C1620)), 2)) AS FECHAAPERTURACUENTA,
    CASE    
        WHEN s.C1785 IN(2,3) THEN 
        	''000000000000000''
        ELSE 
            S.OPERACION
    END NROCERTIFICADOPLAZOFIJO,
    CASE  
        WHEN S.MONEDA NOT IN (998, 999) THEN     
        	(SELECT S2.C1785 
             FROM SALDOS S2 WITH (NOLOCK) 
			WHERE S2.JTS_OID = S.C1665 
				AND S2.C1688 = 0
				AND	((S2.tz_lock < 300000000000000 OR S2.tz_lock >= 400000000000000) AND 
					(S2.tz_lock < 100000000000000 OR S2.tz_lock >= 200000000000000)) )
		WHEN S.C1688 > 0 THEN
			S.C1785
		WHEN S.MONEDA IN (998, 999) THEN 
            (SELECT S3.C1785 
            FROM SALDOS S3 WITH (NOLOCK) 
            WHERE ((S3.tz_lock < 300000000000000 OR S3.tz_lock >= 400000000000000) AND 
				(S3.tz_lock < 100000000000000 OR S3.tz_lock >= 200000000000000)) 
				AND S3.JTS_OID = (SELECT TOP 1 CV.JTS_OID_CTA_FUENTE 
                                	FROM CV_TRANSFERENCIA CV WITH (NOLOCK) 
                                INNER JOIN SALDOS S WITH (NOLOCK) ON 
                                    ((S.tz_lock < 300000000000000 OR S.tz_lock >= 400000000000000) 
                                    AND (S.tz_lock < 100000000000000 OR S.tz_lock >= 200000000000000)) 
                                    AND CV.JTS_OID_CTA_DESTINO=S.JTS_OID 
                                    AND S.C1688=0
									AND ((CV.tz_lock < 300000000000000 OR CV.tz_lock >= 400000000000000) AND 
										(CV.tz_lock < 100000000000000 OR CV.tz_lock >= 200000000000000))))
		ELSE 6
	END AS ORIGENIMPOSICION,
	CASE 
		WHEN S.C1688 > 0 THEN 
			S.OPERACION
		ELSE 
			''000000000000000''
	END PLAZOFIJORENOVADO,
	CONCAT(YEAR(S.C1620), RIGHT(''0'' + RTRIM(MONTH(S.C1620)), 2), RIGHT(''0'' + RTRIM(DAY(S.C1620)), 2)) AS FECHACONSTITUCION,
	CASE 
		WHEN S.C1785=4 THEN 
			DATEDIFF(DAY,S.C1621, S.C1627) 
		ELSE 
			''00000'' 
	END AS PLAZO,
	CONCAT(YEAR(S.C1627), RIGHT(''0'' + RTRIM(MONTH(S.C1627)), 2), RIGHT(''0'' + RTRIM(DAY(S.C1627)), 2)) AS FECHAVENCIMIENTOPLAZOFIJO,
	ABS(GSD.SALDO_AJUSTADO) AS CAPITALMONEDAORIGEN,
	ABS(GSD.SALDO_AJUSTADO_MN) AS CAPITALPESOS,
	ABS(S.C1611) AS INTERESDEVENGADO,
	ABS(S.C1611 * (SELECT HC.TIPO_CAMBIO_OFICIAL
		FROM HISTORICOTIPOSCAMBIO HC WHERE HC.MONEDA = S.MONEDA
		AND HC.FECHA_COTIZACION = GSD.FECHA
		AND HC.CODIGO_TIPO_CAMBIO = 1)) AS INTERESDEVENGADOPESOS,
	0 AS COEF,
	CASE 
		WHEN S.C1785=2 AND S.MONEDA IN(998, 999) THEN 
			(SELECT S2.C1604 FROM SALDOS S2 WITH (NOLOCK)  
				WHERE S.SUCURSAL = S2.SUCURSAL 
					AND S.CUENTA = S2.CUENTA 
					AND S.MONEDA = S2.MONEDA 
				  	AND S.OPERACION = S2.OPERACION 
				  	AND S.PRODUCTO = S2.PRODUCTO 
				  	AND SUBSTRING(REPLACE(CAST(S2.C1730 AS VARCHAR (18)), ''.'', ''''),1,6) = ''311870'')
		WHEN S.C1785=4 AND S.MONEDA IN(998, 999) THEN 
			(SELECT S2.C1604 FROM SALDOS S2 WITH (NOLOCK)  
				WHERE S.SUCURSAL = S2.SUCURSAL 
					AND S.CUENTA = S2.CUENTA 
					AND S.MONEDA = S2.MONEDA 
				  	AND S.OPERACION = S2.OPERACION 
				  	AND S.PRODUCTO = S2.PRODUCTO 
				  	AND SUBSTRING(REPLACE(CAST(S2.C1730 AS VARCHAR (18)), ''.'', ''''),1,6) = ''311868'')
		ELSE 0 
	END AS AJUSTEUVAUVI,
	
	(SELECT ABS(GSD.SALDO_AJUSTADO) + ABS(S.C1611)) AS MONTO, 
	(SELECT ABS(GSD.SALDO_AJUSTADO_MN) + ABS(S.C1611*(SELECT HC.TIPO_CAMBIO_OFICIAL
													FROM HISTORICOTIPOSCAMBIO HC WHERE HC.MONEDA = S.MONEDA
													AND HC.FECHA_COTIZACION = GSD.FECHA
													AND HC.CODIGO_TIPO_CAMBIO = 1))) AS MONTOPESOS,
	S.C1632 AS TASAINTERESPACTADA,
	CASE 
		WHEN S.C1690  = ''F'' THEN 0
		WHEN S.C1690  = ''V'' THEN 1
		ELSE 0
	END TIPOTASA,--caso de Ajustable Cer aplica cuando saldo en moneda extranjera y Ajustable UVA-UVI moneda es 999 o 998.  
	CASE WHEN S.c1785 IN(2,3) THEN 
		0
	ELSE 
		1 
	END AS TASAVARIABLE,
	CASE WHEN S.C1785 IN (2,3) THEN 
		0
	ELSE 
		CASE PRD.C6259 WHEN ''P'' THEN
			CAST ((((POWER( ((((S.C1632 / 100) * S.C1642) / PRD.C6255) + 1),
			PRD.C6255 / S.C1642)) - 1) * 100) AS DECIMAL(11,2))
		ELSE 
			CAST ((((POWER( ((((S.C1632 / 100) * DATEDIFF(DAY,S.C1621,S.C1627)) / PRD.C6255) + 1),
			PRD.C6255 / DATEDIFF(DAY,S.C1621,S.C1627))) - 1) * 100) AS DECIMAL(11,2))
		END
	END AS TASANOMINALANUAL,
	(SELECT SUM(MC.CAPITALREALIZADO) 
		FROM MOVIMIENTOS_CONTABLES MC WITH (NOLOCK)  
		WHERE MC.DEBITOCREDITO = ''D''
			AND MONTH(MC.FECHAPROCESO)= MONTH(GSD.FECHA)
			AND MC.CUENTA = S.CUENTA
			AND MC.SUCURSAL = S.SUCURSAL
			AND MC.MONEDA = S.MONEDA) AS DEBITOSTOTALES, 
	(SELECT SUM(MC.CAPITALREALIZADO) 
		FROM MOVIMIENTOS_CONTABLES MC WITH (NOLOCK)
		WHERE MC.DEBITOCREDITO = ''C'' 
			AND MONTH(MC.FECHAPROCESO)= MONTH(GSD.FECHA)
			AND MC.CUENTA = S.CUENTA
			AND MC.SUCURSAL = S.SUCURSAL
			AND MC.MONEDA = S.MONEDA) AS CREDITOSTOTALES,
	GSD.SUMA_PROMEDIO_DIARIO AS PROMEDIOMENSUAL,
	CASE WHEN M.C6399=1 THEN
		1
	WHEN M.C6399=2 THEN
		2
	WHEN M.C6399=5 THEN
		3
	ELSE
		4
	END AS MONEDAORIGEN,
	0 AS RETRIB,  
	STR(S.C1730) AS CUENTACONTABLE,
	S.C1730 AS CUENTACONTABLEUSOINTERNO,
	S.C1803 AS CLIENTE
FROM 
    SALDOS S WITH (NOLOCK)
INNER JOIN GRL_SALDOS_DIARIOS GSD WITH (NOLOCK) on 
    S.JTS_OID = GSD.SALDOS_JTS_OID AND
	((GSD.tz_lock < 300000000000000 OR GSD.tz_lock >= 400000000000000) AND 
		(GSD.tz_lock < 100000000000000 OR GSD.tz_lock >= 200000000000000))
INNER JOIN MONEDAS M WITH (NOLOCK) on 
    S.MONEDA = M.C6399 AND
    ((M.tz_lock < 300000000000000 OR M.tz_lock >= 400000000000000) AND 
		(M.tz_lock < 100000000000000 OR M.tz_lock >= 200000000000000))
INNER JOIN PRODUCTOS PRD WITH (NOLOCK) ON
    S.PRODUCTO = PRD.C6250
    AND ((PRD.tz_lock < 300000000000000 OR PRD.tz_lock >= 400000000000000) AND 
		(PRD.tz_lock < 100000000000000 OR PRD.tz_lock >= 200000000000000))
INNER JOIN RRI_PARAMETROS_INF R WITH (NOLOCK) ON
	R.CODIGO=5 AND
	R.ID1 = S.PRODUCTO AND 
	R.ID2= S.MONEDA AND
	R.TZ_LOCK=0
WHERE 
	((S.tz_lock < 300000000000000 OR S.tz_lock >= 400000000000000) AND 
		(S.tz_lock < 100000000000000 OR S.tz_lock >= 200000000000000)) AND
	(S.C1785 IN (2,3) OR (DATEDIFF(DAY,S.C1621,S.C1627)>0 AND S.C1785 IN (4)))
    AND PRD.C6255 != 0
')

