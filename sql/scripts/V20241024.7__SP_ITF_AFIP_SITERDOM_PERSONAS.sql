CREATE OR ALTER    PROCEDURE [dbo].[SP_ITF_AFIP_SITERDOM_PERSONAS]
@anio VARCHAR (4),
@semestre VARCHAR(1)

AS
BEGIN

DECLARE @CA_TIPO_DE_REGISTRO VARCHAR(2) = '01';
DECLARE @CA_CUIT_DEL_INFORMANTE VARCHAR(11) = (SELECT NOMBRE2 FROM PARAMETROS (NOLOCK));
DECLARE @CA_PERIODO_VALORES VARCHAR(5) = CONCAT(@semestre, @anio);
DECLARE @CA_SECUENCIA VARCHAR(2) = (SELECT right(concat('00',isnull(MAX(SECUENCIA),-1)+1),2) FROM ITF_AFIP_SITERDOM_HIST (nolock) hist
																			WHERE TIPO_REGISTRO = '01' 
																				AND @anio = RIGHT(hist.PERIODO, 4) 
																				AND @semestre  = LEFT(hist.PERIODO, 1));																			 
DECLARE @CA_CODIGO_ENTIDAD_FINANCIERA VARCHAR(5) = RIGHT(concat('00000', (SELECT numerico FROM PARAMETROSGENERALES (nolock) WHERE CODIGO=2)),5);
DECLARE @CA_IMPUESTO VARCHAR(4) = '0103';
DECLARE @CA_CONCEPTO VARCHAR(3) = '910';
DECLARE @CA_NUMERO_DE_FORMULARIO VARCHAR(4) = '0944';
DECLARE @CA_FILLER VARCHAR(212) = REPLICATE(' ',212);
DECLARE @CA_VERSION VARCHAR(5) = '00300';
DECLARE @CA_LINEA VARCHAR(253);

DECLARE @R02_TIPO_REGISTRO VARCHAR(40) = '02';
DECLARE @R02_TIPO_DOCUMENTACION VARCHAR(40);
DECLARE @R02_NUMERO_DOCUMENTACION VARCHAR(40);
DECLARE @R02_DENOMINACION VARCHAR(40);
DECLARE @R02_CALLE_POSTAL VARCHAR(40);
DECLARE @R02_NUMERO_PUERTA_POSTAL VARCHAR(40);
DECLARE @R02_DEPARTAMENTO_POSTAL VARCHAR(40);
DECLARE @R02_SECTOR_POSTAL VARCHAR(40)  = '     ';
DECLARE @R02_TORRE_POSTAL VARCHAR(40)  = '     ';
DECLARE @R02_MANZANA_POSTAL VARCHAR(40);
DECLARE @R02_PISO_POSTAL VARCHAR(40);
DECLARE @R02_CODIGO_POSTAL VARCHAR(40);
DECLARE @R02_LOCALIDAD_POSTAL VARCHAR(40);
DECLARE @R02_CODIGO_PROVINCIA VARCHAR(40);
DECLARE @R02_PAIS_POSTAL VARCHAR(40);
DECLARE @R02_CALLE_COMERCIAL VARCHAR(40);
DECLARE @R02_NUMERO_PUERTA_COMERCIAL VARCHAR(40);
DECLARE @R02_DEPARTAMENTO_COMERCIAL VARCHAR(40);
DECLARE @R02_SECTOR_COMERCIAL VARCHAR(40)  = '     ';
DECLARE @R02_TORRE_COMERCIAL VARCHAR(40)  = '     ';
DECLARE @R02_MANZANA_COMERCIAL VARCHAR(40);
DECLARE @R02_PISO_COMERCIAL VARCHAR(40);
DECLARE @R02_CODIGO_POSTAL_COMERCIAL VARCHAR(40);
DECLARE @R02_LOCALIDAD_COMERCIAL VARCHAR(40);
DECLARE @R02_PROVINCIA_COMERCIAL VARCHAR(40);
DECLARE @R02_PAIS_COMERCIAL VARCHAR(40);
DECLARE @R02_RESIDENCIAÂ VARCHAR(1) = '1';
DECLARE @R02_LINEA VARCHAR(252) ;

DECLARE @R03_TIPO_REGISTRO VARCHAR(30) = '03';
DECLARE @R03_TIPO_PERSONA VARCHAR(30);
DECLARE @R03_NOMBRE_RAZON_SOCIAL VARCHAR(30);
DECLARE @R03_TIPO_DOCUMENTO VARCHAR(30);
DECLARE @R03_OTROS VARCHAR(30);
DECLARE @R03_NUMERO_DOCUMENTO VARCHAR(30);
DECLARE @R03_PAIS_OTORGANTE_DOC VARCHAR(30);
DECLARE @R03_LUGAR_NACIMIENTO VARCHAR(30);
DECLARE @R03_FECHA_NACIMIENTO VARCHAR(30);
DECLARE @R03_DOMICILIO_ACTUAL_EXT VARCHAR(50);
DECLARE @R03_CIUDAD VARCHAR(30);
DECLARE @R03_PROVINCIA VARCHAR(30);
DECLARE @R03_PAIS VARCHAR(30);
DECLARE @R03_NIF VARCHAR(30);
DECLARE @R03_RESIDENCIA_TRIBUTARIA VARCHAR(30);
DECLARE @R03_RESIDENCIA VARCHAR(1) = '2' ;
DECLARE @R03_LINEA VARCHAR(232);

DECLARE @FECHA_PROCESO DATE = (SELECT FECHAPROCESO FROM PARAMETROS(NOLOCK));
DECLARE @NOMBRE_FICHERO VARCHAR(100) = concat('F0944.',@semestre,@anio, '0',@CA_SECUENCIA);
DECLARE @PERIODO_INFORMADO VARCHAR(6);

TRUNCATE TABLE ITF_AFIP_SITERDOM_AUX;

SET @CA_LINEA = CONCAT(@CA_TIPO_DE_REGISTRO,@CA_CUIT_DEL_INFORMANTE,@CA_PERIODO_VALORES,@CA_SECUENCIA,@CA_CODIGO_ENTIDAD_FINANCIERA,@CA_IMPUESTO,@CA_CONCEPTO,@CA_NUMERO_DE_FORMULARIO,@CA_FILLER,@CA_VERSION);

INSERT INTO ITF_AFIP_SITERDOM_AUX
VALUES(@CA_TIPO_DE_REGISTRO,@CA_LINEA, @CA_SECUENCIA, @NOMBRE_FICHERO)

INSERT INTO ITF_AFIP_SITERDOM_HIST (TIPO_REGISTRO, CUIT_INFORMANTE, PERIODO, SECUENCIA,ENTIDAD_FINANCIERA,IMPUESTO,CONCEPTO,NRO_FORMULARIO,VERSION,FECHA_PROCESO)
VALUES (@CA_TIPO_DE_REGISTRO,@CA_CUIT_DEL_INFORMANTE,@CA_PERIODO_VALORES,@CA_SECUENCIA,@CA_CODIGO_ENTIDAD_FINANCIERA,@CA_IMPUESTO,@CA_CONCEPTO,@CA_NUMERO_DE_FORMULARIO,@CA_VERSION,@FECHA_PROCESO);

DECLARE cursor_residentes CURSOR FOR
SELECT DISTINCT 
	concat(@semestre, @anio),
	NRO_DOCUMENTO,
    CASE 
        WHEN residentes.TIPO_DOCUMENTO = 'CUIT' THEN '80' 
        WHEN residentes.TIPO_DOCUMENTO = 'CUIL' THEN '86' 
        WHEN residentes.TIPO_DOCUMENTO = 'CDI' THEN '87' 
        WHEN residentes.TIPO_DOCUMENTO = 'CNV' THEN '55' 
        ELSE '99' 
    END,
    DENOMINACION,
    CALLE_POSTAL,
    NUMERO_POSTAL,
    DEPARTAMENTO_POSTAL,
    MANZANA_POSTAL,
    PISO_POSTAL,
    CODIGO_POSTAL,
    LOCALIDAD_POSTAL,
    CODIGO_PROVINCIA_POSTAL,
    PAIS_POSTAL,
    CASE WHEN MIN(CALLE_COMERCIAL) IS NOT NULL THEN MIN(CALLE_COMERCIAL) ELSE MIN(CALLE_POSTAL) END,
    CASE WHEN MIN(NUMERO_COMERCIAL) IS NOT NULL THEN MIN(NUMERO_COMERCIAL) ELSE MIN(NUMERO_POSTAL) END,
    CASE WHEN MIN(DEPARTAMENTO_COMERCIAL) IS NOT NULL THEN MIN(DEPARTAMENTO_COMERCIAL) ELSE MIN(DEPARTAMENTO_POSTAL) END,
    CASE WHEN MIN(MANZANA_COMERCIAL) IS NOT NULL THEN MIN(MANZANA_COMERCIAL) ELSE MIN(MANZANA_POSTAL) END,
    CASE WHEN MIN(PISO_COMERCIAL) IS NOT NULL THEN MIN(PISO_COMERCIAL) ELSE MIN(PISO_POSTAL) END,
    CASE WHEN MIN(CODIGO_POSTAL_COMERCIAL) IS NOT NULL THEN MIN(CODIGO_POSTAL_COMERCIAL) ELSE MIN(CODIGO_POSTAL) END,
    CASE WHEN MIN(LOCALIDAD_COMERCIAL) IS NOT NULL THEN MIN(LOCALIDAD_COMERCIAL) ELSE MIN(LOCALIDAD_POSTAL) END,
    CASE WHEN MIN(CODIGO_PROVINCIA_COMERCIAL) IS NOT NULL THEN MIN(CODIGO_PROVINCIA_COMERCIAL) ELSE MIN(CODIGO_PROVINCIA_POSTAL) END,
    CASE WHEN MIN(PAIS_COMERCIAL) IS NOT NULL THEN MIN(PAIS_COMERCIAL) ELSE MIN(PAIS_POSTAL) END
FROM (

		
	    SELECT DISTINCT  
	    	'1' TIPO_PERSONA,
	    	pfpj.NUMERODOCUMENTO doc,
			dir.id,		
	    	pfpj.TIPODOCUMENTO TIPO_DOCUMENTO,
	    	pfpj.NUMERODOCUMENTO NRO_DOCUMENTO, 
	    	concat(pf.primernombre, CASE WHEN len(pf.segundonombre) = 0 THEN ' ' ELSE pf.segundonombre END ,  CASE WHEN len(pf.apellidopaterno) = 0 THEN ' ' ELSE pf.apellidopaterno END,  CASE WHEN len(pf.apellidomaterno) = 0 THEN ' ' ELSE pf.apellidomaterno END  ) DENOMINACION,
    		    	
	    	dir.CALLE CALLE_POSTAL,	    	
	    	dir.NUMERO NUMERO_POSTAL,
			dir.DEPARTAMENTO DEPARTAMENTO_POSTAL,
			dir.MANZANA MANZANA_POSTAL,
			dir.PISO PISO_POSTAL,
			dir.cpa_nuevo CODIGO_POSTAL,
			dir.LOCALIDAD LOCALIDAD_POSTAL,
			prov.NUM1 CODIGO_PROVINCIA_POSTAL, 
			pais.CODIGOSWIFT PAIS_POSTAL,
			
	    	NULL CALLE_COMERCIAL,	    	
	    	NULL NUMERO_COMERCIAL,
			NULL DEPARTAMENTO_COMERCIAL,
			NULL MANZANA_COMERCIAL,
			NULL PISO_COMERCIAL,
		    NULL CODIGO_POSTAL_COMERCIAL,
			NULL LOCALIDAD_COMERCIAL,
			NULL CODIGO_PROVINCIA_COMERCIAL, 
			NULL PAIS_COMERCIAL,
			
			pf.CODIGODERESIDENCIA RESIDENCIA
	    	
			FROM CLI_DocumentosPFPJ pfpj (nolock)
			JOIN CLI_PERSONASFISICAS pf (nolock) ON pf.NUMEROPERSONAFISICA = pfpj.NUMEROPERSONAFJ
			JOIN CLI_DIRECCIONES dir (nolock) ON pf.NUMEROPERSONAFISICA = dir.ID
			JOIN (SELECT ID4, NUM1 FROM RRI_PARAMETROS_INF WHERE CODIGO=510) prov ON dir.PROVINCIA = prov.ID4
			JOIN cli_paises pais (nolock) ON dir.PAIS = pais.CODIGOPAIS
				WHERE dir.TIPODIRECCION IN ('R','PR') 	AND pfpj.TZ_LOCK = 0 AND pf.TZ_LOCK=0 AND dir.TZ_LOCK=0  AND pais.TZ_LOCK = 0
				
    UNION ALL
      
		
    SELECT DISTINCT  
    		'1' TIPO_PERSONA,
	    	pfpj.NUMERODOCUMENTO doc,
    		dir.id,	    		
    		pfpj.TIPODOCUMENTO TIPO_DOCUMENTO,
	    	pfpj.NUMERODOCUMENTO NRO_DOCUMENTO, 	    	
    		concat(pf.primernombre, CASE WHEN len(pf.segundonombre) = 0 THEN ' ' ELSE pf.segundonombre END ,  CASE WHEN len(pf.apellidopaterno) = 0 THEN ' ' ELSE pf.apellidopaterno END,  CASE WHEN len(pf.apellidomaterno) = 0 THEN ' ' ELSE pf.apellidomaterno END  ) DENOMINACION,
			
	    	NULL CALLE_POSTAL,	    	
	    	NULL NUMERO_POSTAL,
			NULL DEPARTAMENTO_POSTAL,
			NULL MANZANA_POSTAL,
			NULL PISO_POSTAL,
		    NULL CODIGO_POSTAL,
			NULL LOCALIDAD_POSTAL,
			NULL CODIGO_PROVINCIA_POSTAL, 
			NULL PAIS_POSTAL,
						
			dir.CALLE CALLE_COMERCIAL,	    	
	    	dir.NUMERO NUMERO_COMERCIAL,
			dir.DEPARTAMENTO DEPARTAMENTO_COMERCIAL,
			dir.MANZANA MANZANA_COMERCIAL,
			dir.PISO PISO_COMERCIAL,
			dir.cpa_nuevo CODIGO_COMERCIAL,
			dir.LOCALIDAD LOCALIDAD_COMERCIAL,
			prov.NUM1 CODIGO_PROVINCIA_COMERCIAL, 
			pais.CODIGOSWIFT PAIS_COMERCIAL,
			
			pf.CODIGODERESIDENCIA RESIDENCIA			

    		FROM CLI_DocumentosPFPJ pfpj (nolock)
				JOIN CLI_PERSONASFISICAS pf (nolock) ON pf.NUMEROPERSONAFISICA = pfpj.NUMEROPERSONAFJ
				JOIN CLI_DIRECCIONES dir (nolock) ON pf.NUMEROPERSONAFISICA = dir.ID
				JOIN (SELECT ID4, NUM1 FROM RRI_PARAMETROS_INF WHERE CODIGO=510) prov ON dir.PROVINCIA = prov.ID4
				JOIN cli_paises pais (nolock) ON dir.PAIS = pais.CODIGOPAIS
				WHERE TIPODIRECCION IN ('L','F') AND pfpj.TZ_LOCK = 0 AND pf.TZ_LOCK=0 AND dir.TZ_LOCK=0 AND pais.TZ_LOCK = 0
				
     UNION ALL				
	
	
    SELECT DISTINCT      
    		'2' TIPO_PERSONA,
	    	pfpj.NUMERODOCUMENTO doc,
    	 	dir.id,     
    	 	
    	 	pfpj.TIPODOCUMENTO TIPO_DOCUMENTO,
	    	pfpj.NUMERODOCUMENTO NRO_DOCUMENTO, 
    		pj.RAZONSOCIAL DENOMINACION,
    	 		    	
	    	dir.CALLE CALLE_POSTAL,	    	
	    	dir.NUMERO NUMERO_POSTAL,
			dir.DEPARTAMENTO DEPARTAMENTO_POSTAL,
			dir.MANZANA MANZANA_POSTAL,
			dir.PISO PISO_POSTAL,
			dir.cpa_nuevo CODIGO_POSTAL,
			dir.LOCALIDAD LOCALIDAD_POSTAL,
			prov.NUM1 CODIGO_PROVINCIA_POSTAL, 
			pais.CODIGOSWIFT PAIS_POSTAL,
					    
			dir.CALLE CALLE_COMERCIAL,	    	
	    	dir.NUMERO NUMERO_COMERCIAL,
			dir.DEPARTAMENTO DEPARTAMENTO_COMERCIAL,
			dir.MANZANA MANZANA_COMERCIAL,
			dir.PISO PISO_COMERCIAL,
			dir.cpa_nuevo CODIGO_COMERCIAL,
			dir.LOCALIDAD LOCALIDAD_COMERCIAL,
			prov.NUM1 CODIGO_PROVINCIA_COMERCIAL, 
			pais.CODIGOSWIFT PAIS_COMERCIAL,			
			
			pj.CODIGODERESIDENCIA RESIDENCIA			
		    
		    FROM CLI_DocumentosPFPJ pfpj (nolock)
					JOIN CLI_PERSONASJURIDICAS pj (nolock) ON pj.NUMEROPERSONAJURIDICA = pfpj.NUMEROPERSONAFJ
					JOIN CLI_DIRECCIONES dir (nolock) ON pj.NUMEROPERSONAJURIDICA  = dir.ID
					JOIN (SELECT ID4, NUM1 FROM RRI_PARAMETROS_INF WHERE CODIGO=510) prov ON dir.PROVINCIA = prov.ID4
					JOIN cli_paises pais (nolock) ON dir.PAIS = pais.CODIGOPAIS
					WHERE TIPODIRECCION IN ('L','F') AND pfpj.TZ_LOCK = 0 AND pj.TZ_LOCK=0 AND dir.TZ_LOCK=0  AND pais.TZ_LOCK = 0
					
) AS residentes 
JOIN ITF_AFIP_SITEROP_HIST hist ON RESIDENTES.NRO_DOCUMENTO = hist.NUMERO_DOCUMENTO
WHERE @anio = LEFT(hist.PERIODO_INFORMADO, 4) 
    AND (@semestre = '1' AND CAST(RIGHT(hist.PERIODO_INFORMADO, 2) AS INT) < 7 
    OR @semestre = '2' AND CAST(RIGHT(hist.PERIODO_INFORMADO, 2) AS INT) > 6)
    AND RESIDENCIA = '2' 
GROUP BY RESIDENTES.ID, hist.PERIODO_INFORMADO, TIPO_PERSONA, DENOMINACION, 
         RESIDENTES.TIPO_DOCUMENTO, NRO_DOCUMENTO, RESIDENCIA, 
         CALLE_POSTAL, NUMERO_POSTAL, DEPARTAMENTO_POSTAL, 
         MANZANA_POSTAL, PISO_POSTAL, CODIGO_POSTAL, LOCALIDAD_POSTAL, 
         CODIGO_PROVINCIA_POSTAL, PAIS_POSTAL, 
         CALLE_COMERCIAL, NUMERO_COMERCIAL, DEPARTAMENTO_COMERCIAL, 
         MANZANA_COMERCIAL, PISO_COMERCIAL, LOCALIDAD_COMERCIAL, 
         CODIGO_PROVINCIA_COMERCIAL, PAIS_COMERCIAL;

OPEN cursor_residentes;
FETCH NEXT FROM cursor_residentes INTO 
	@PERIODO_INFORMADO,
    @R02_NUMERO_DOCUMENTACION,
    @R02_TIPO_DOCUMENTACION,
    @R02_DENOMINACION,
    @R02_CALLE_POSTAL,
    @R02_NUMERO_PUERTA_POSTAL,
    @R02_DEPARTAMENTO_POSTAL,
    @R02_MANZANA_POSTAL,
    @R02_PISO_POSTAL,
    @R02_CODIGO_POSTAL,
    @R02_LOCALIDAD_POSTAL,
    @R02_CODIGO_PROVINCIA,
    @R02_PAIS_POSTAL,
    @R02_CALLE_COMERCIAL,
    @R02_NUMERO_PUERTA_COMERCIAL,
    @R02_DEPARTAMENTO_COMERCIAL,
    @R02_MANZANA_COMERCIAL,
    @R02_PISO_COMERCIAL,
    @R02_CODIGO_POSTAL_COMERCIAL,
    @R02_LOCALIDAD_COMERCIAL,
    @R02_PROVINCIA_COMERCIAL,
    @R02_PAIS_COMERCIAL;

WHILE @@FETCH_STATUS = 0
BEGIN
  
SET @R02_LINEA = CONCAT(@R02_TIPO_REGISTRO, @R02_TIPO_DOCUMENTACION, 	left(concat(@R02_NUMERO_DOCUMENTACION,replicate(' ', 11)), 11),	left(concat(@R02_DENOMINACION,replicate(' ', 30)), 30),		left(concat(max(@R02_CALLE_POSTAL),replicate(' ', 30)), 30),	left(concat(max(@R02_NUMERO_PUERTA_POSTAL),replicate(' ', 6)), 6 ),	left(concat(max(@R02_DEPARTAMENTO_POSTAL),replicate(' ', 5)), 5 ),	@R02_SECTOR_POSTAL, @R02_TORRE_POSTAL,	left(concat(max(@R02_MANZANA_POSTAL),replicate(' ', 5)), 5 ),	left(concat(max(@R02_PISO_POSTAL),replicate(' ', 5)), 5 ),	left(concat(max(@R02_CODIGO_POSTAL),replicate(' ', 8)), 8 ),	left(concat(max(@R02_LOCALIDAD_POSTAL),replicate(' ', 30)), 30 ),	right(concat('00', max(@R02_CODIGO_PROVINCIA)), 2 ),	left(concat(max(@R02_PAIS_POSTAL),replicate(' ', 2)), 2 ),	left(concat(@R02_CALLE_COMERCIAL,replicate(' ', 30)), 30 ),	left(concat(@R02_NUMERO_PUERTA_COMERCIAL,replicate(' ', 6)), 6 ),	left(concat(@R02_DEPARTAMENTO_COMERCIAL,replicate(' ', 5)), 5 ),	@R02_SECTOR_COMERCIAL,   @R02_TORRE_COMERCIAL, 	left(concat(@R02_MANZANA_COMERCIAL,replicate(' ', 5)), 5 ),	left(concat(@R02_PISO_COMERCIAL,replicate(' ', 5)), 5 ),	left(concat(@R02_CODIGO_POSTAL_COMERCIAL,replicate(' ', 8)), 8 ),	left(concat(@R02_LOCALIDAD_COMERCIAL,replicate(' ', 30)), 30 ),	right(concat('00',@R02_PROVINCIA_COMERCIAL), 2),	left(concat(@R02_PAIS_COMERCIAL,replicate(' ', 2)), 2 ),@R02_RESIDENCIA);
 
INSERT INTO ITF_AFIP_SITERDOM_AUX (TIPO_REGISTRO, LINEA, SECUENCIA)
VALUES (@R02_TIPO_REGISTRO, @R02_LINEA, @CA_SECUENCIA);

INSERT INTO ITF_AFIP_SITERDOM_HIST (PERIODO	, FECHA_PROCESO , TIPO_REGISTRO	,SECUENCIA ,TIPO_DOCUMENTACION, NUMERO_DOCUMENTACION  	,NOMBRE_PERSONA  ,CALLE_POSTAL ,NUMERO_POSTAL	,DEPTO_POSTAL 	,SECTOR_POSTAL 	,TORRE_POSTAL 	,MANZANA_POSTAL ,PISO_POSTAL ,CODIGO_POSTAL ,LOC_POSTAL  ,COD_PROV_POSTAL ,PAIS_POSTAL 	,CALLE_COMERCIAL ,NRO_PUERTA_COMERCIAL 	,DEPTO_COMERCIAL ,SECTOR_COMERCIAL,TORRE_COMERCIAL	,MANZANA_COMERCIAL ,PISO_COMERCIAL,COD_POSTAL_COMERCIAL,LOCALIDAD_COMERCIAL	,PROVINCIA_COMERCIAL ,PAIS_COMERCIAL ,COD_RESIDENCIA )
 VALUES (@PERIODO_INFORMADO, @FECHA_PROCESO, @R02_TIPO_REGISTRO,@CA_SECUENCIA ,@R02_TIPO_DOCUMENTACION,@R02_NUMERO_DOCUMENTACION,@R02_DENOMINACION,@R02_CALLE_POSTAL,@R02_NUMERO_PUERTA_POSTAL,@R02_DEPARTAMENTO_POSTAL,@R02_SECTOR_POSTAL,@R02_TORRE_POSTAL,@R02_MANZANA_POSTAL,@R02_PISO_POSTAL,@R02_CODIGO_POSTAL,@R02_LOCALIDAD_POSTAL,@R02_CODIGO_PROVINCIA,@R02_PAIS_POSTAL,@R02_CALLE_COMERCIAL,@R02_NUMERO_PUERTA_COMERCIAL,@R02_DEPARTAMENTO_COMERCIAL,@R02_SECTOR_COMERCIAL,@R02_TORRE_COMERCIAL,@R02_MANZANA_COMERCIAL,@R02_PISO_COMERCIAL,@R02_CODIGO_POSTAL_COMERCIAL,@R02_LOCALIDAD_COMERCIAL,@R02_PROVINCIA_COMERCIAL,@R02_PAIS_COMERCIAL,@R02_RESIDENCIA);

    FETCH NEXT FROM cursor_residentes INTO 
    	@PERIODO_INFORMADO,
        @R02_NUMERO_DOCUMENTACION,
        @R02_TIPO_DOCUMENTACION,
        @R02_DENOMINACION,
        @R02_CALLE_POSTAL,
        @R02_NUMERO_PUERTA_POSTAL,
        @R02_DEPARTAMENTO_POSTAL,
        @R02_MANZANA_POSTAL,
        @R02_PISO_POSTAL,
        @R02_CODIGO_POSTAL,
        @R02_LOCALIDAD_POSTAL,
        @R02_CODIGO_PROVINCIA,
        @R02_PAIS_POSTAL,
        @R02_CALLE_COMERCIAL,
        @R02_NUMERO_PUERTA_COMERCIAL,
        @R02_DEPARTAMENTO_COMERCIAL,
        @R02_MANZANA_COMERCIAL,
        @R02_PISO_COMERCIAL,
        @R02_CODIGO_POSTAL_COMERCIAL,
        @R02_LOCALIDAD_COMERCIAL,
        @R02_PROVINCIA_COMERCIAL,
        @R02_PAIS_COMERCIAL;
END

CLOSE cursor_residentes;
DEALLOCATE cursor_residentes;

DECLARE cursorNoResidentes CURSOR FOR
SELECT DISTINCT 
	 concat(@semestre, @anio),
     tipoPersona,
     nombrePersona,
    CASE 
        WHEN tipoDocumento = 'CUIT' THEN '80' 
        WHEN tipoDocumento = 'CUIL' THEN '86' 
        WHEN tipoDocumento = 'CDI' THEN '87' 
        WHEN tipoDocumento = 'CNV' THEN '55' 
        ELSE '99' 
    END AS tipoDocumento,
    replicate(' ', 30) AS otrosTiposEntidad,
    right(concat(replicate('0',20),nroDocumento),20),
	paisDocumento,
    lugarNacimiento, 
    fechaNacimiento,
    domicilioActual,
    localidad,
    provinciaEstado,
    pais,
    nif,
    residenciaTributaria
FROM (
    SELECT DISTINCT  
        '1' AS tipoPersona,
        LEFT(concat(CONCAT(pf.primernombre, 
            CASE WHEN LEN(pf.segundonombre) = 0 THEN ' ' ELSE pf.segundonombre END,  
            CASE WHEN LEN(pf.apellidopaterno) = 0 THEN ' ' ELSE pf.apellidopaterno END,  
            CASE WHEN LEN(pf.apellidomaterno) = 0 THEN ' ' ELSE pf.apellidomaterno END) , REPLICATE(' ', 30)), 30) AS nombrePersona,
        pfpj.TIPODOCUMENTO AS tipoDocumento,
        pfpj.NUMERODOCUMENTO AS nroDocumento,
        'AR' AS paisDocumento,
        pais.CODIGOSWIFT AS lugarNacimiento, 
        CONVERT(VARCHAR(8), pf.FECHANACIMIENTO, 112) AS fechaNacimiento,
        LEFT(CONCAT(CONCAT(dir.CALLE, ' ', dir.NUMERO), REPLICATE(' ', 50)), 50) AS domicilioActual,  
        LEFT(CONCAT(dir.LOCALIDAD, REPLICATE(' ', 30)), 30) AS localidad,
        LEFT(CONCAT(dir.PROVINCIA, REPLICATE(' ', 30)), 30) AS provinciaEstado,
        RIGHT(CONCAT('00', pais.CODIGOSWIFT), 2) AS pais,  
        RIGHT(CONCAT(REPLICATE('0', 20), pf.NIF), 20) AS nif, 
        RIGHT(CONCAT('00', pais.CODIGOSWIFT), 2) AS residenciaTributaria 
    FROM CLI_DocumentosPFPJ pfpj (NOLOCK)
    JOIN CLI_PERSONASFISICAS pf (NOLOCK) ON pf.NUMEROPERSONAFISICA = pfpj.NUMEROPERSONAFJ
    JOIN CLI_DIRECCIONES dir (NOLOCK) ON pf.NUMEROPERSONAFISICA = dir.ID
    JOIN CLI_PROVINCIAS prov (NOLOCK) ON dir.PAIS = prov.CODIGOPAIS AND dir.PROVINCIA = prov.DIM1
    JOIN cli_paises pais (NOLOCK) ON dir.PAIS = pais.CODIGOPAIS 		
    WHERE pfpj.TZ_LOCK = 0 AND pf.TZ_LOCK = 0 AND dir.TZ_LOCK = 0 AND prov.TZ_LOCK = 0 AND pais.TZ_LOCK = 0 
    			AND TIPODIRECCION = 'ED' AND CODIGODERESIDENCIA = '3'
    
    UNION ALL 

    SELECT DISTINCT 
        '2' AS tipoPersona, 
        LEFT(CONCAT(pj.RAZONSOCIAL, REPLICATE(' ', 30)), 30) AS nombrePersona,
        pfpj.TIPODOCUMENTO AS tipoDocumento,
        pfpj.NUMERODOCUMENTO AS nroDocumento,
        'AR' AS paisDocumento, 
        pj.PAIS_TRIBUTARIO AS lugarNacimiento,
        CONVERT(VARCHAR(8), pj.FECHACONSTITUCION, 112) AS fechaNacimiento,
        LEFT(CONCAT(CONCAT(dir.CALLE, ' ', dir.NUMERO), REPLICATE(' ', 50)), 50) AS domicilioActual,  
        LEFT(CONCAT(dir.LOCALIDAD, REPLICATE(' ', 30)), 30) AS localidad,
        LEFT(CONCAT(dir.PROVINCIA, REPLICATE(' ', 30)), 30) AS provinciaEstado,
        RIGHT(CONCAT('00', pj.PAIS_TRIBUTARIO), 2) AS pais, 
        RIGHT(CONCAT(REPLICATE('0', 20), pj.NIF), 20) AS nif, 
        RIGHT(CONCAT('00', pj.PAIS_TRIBUTARIO), 2) AS residenciaTributaria
    FROM CLI_DocumentosPFPJ pfpj (NOLOCK)
    JOIN CLI_PERSONASJURIDICAS pj (NOLOCK) ON pj.NUMEROPERSONAJURIDICA = pfpj.NUMEROPERSONAFJ
    JOIN CLI_DIRECCIONES dir (NOLOCK) ON pj.NUMEROPERSONAJURIDICA = dir.ID
    JOIN CLI_PROVINCIAS prov (NOLOCK) ON dir.PAIS = prov.CODIGOPAIS AND dir.PROVINCIA = prov.DIM1
    JOIN cli_paises pais (NOLOCK) ON dir.PAIS = pais.CODIGOPAIS 	 
    WHERE pfpj.TZ_LOCK = 0 AND pj.TZ_LOCK = 0 AND dir.TZ_LOCK = 0 AND prov.TZ_LOCK = 0 AND pais.TZ_LOCK = 0
        AND TIPODIRECCION = 'ED' AND CODIGODERESIDENCIA = '3'
) noResidentes
JOIN ITF_AFIP_SITEROP_HIST hist ON noResidentes.nroDocumento = hist.NUMERO_DOCUMENTO
WHERE @anio = LEFT(hist.PERIODO_INFORMADO, 4) 
    AND (@semestre = '1' AND CAST(RIGHT(hist.PERIODO_INFORMADO, 2) AS INT) < 7 
    OR @semestre = '2' AND CAST(RIGHT(hist.PERIODO_INFORMADO, 2) AS INT) > 6);

OPEN cursorNoResidentes;

FETCH NEXT FROM cursorNoResidentes INTO 
	@PERIODO_INFORMADO,
    @R03_TIPO_PERSONA,
    @R03_NOMBRE_RAZON_SOCIAL,
    @R03_TIPO_DOCUMENTO,
    @R03_OTROS,
    @R03_NUMERO_DOCUMENTO,
    @R03_PAIS_OTORGANTE_DOC,
    @R03_LUGAR_NACIMIENTO,
    @R03_FECHA_NACIMIENTO,
    @R03_DOMICILIO_ACTUAL_EXT,
    @R03_CIUDAD,
    @R03_PROVINCIA,
    @R03_PAIS,
    @R03_NIF,
    @R03_RESIDENCIA_TRIBUTARIA;

WHILE @@FETCH_STATUS = 0
BEGIN

SET @R03_LINEA = concat(@R03_TIPO_REGISTRO, @R03_TIPO_PERSONA,@R03_NOMBRE_RAZON_SOCIAL,@R03_TIPO_DOCUMENTO,@R03_OTROS,@R03_NUMERO_DOCUMENTO,@R03_PAIS_OTORGANTE_DOC,@R03_LUGAR_NACIMIENTO,@R03_FECHA_NACIMIENTO,@R03_DOMICILIO_ACTUAL_EXT,@R03_CIUDAD,@R03_PROVINCIA,@R03_PAIS,@R03_NIF,@R03_RESIDENCIA_TRIBUTARIA, @R03_RESIDENCIA)

INSERT INTO ITF_AFIP_SITERDOM_AUX (TIPO_REGISTRO, LINEA, SECUENCIA)
VALUES (@R03_TIPO_REGISTRO, @R03_LINEA, @CA_SECUENCIA);

INSERT INTO ITF_AFIP_SITERDOM_HIST (PERIODO,FECHA_PROCESO ,  SECUENCIA  ,TIPO_REGISTRO,TIPO_PERSONA  ,NOMBRE_PERSONA, TIPO_DOCUMENTACION , OTROS_TIPOS_ENT,NUMERO_DOCUMENTACION ,PAIS_DOCUMENTO,LUGAR_NACIMIENTO ,FECHA_NACIMIENTO ,DOMICILIO_ACTUAL ,LOCALIDAD ,PROVINCIA_ESTADO ,PAIS ,NIF ,RESIDENCIA_TRIBUTARIA 	,COD_RESIDENCIA )
VALUES (@PERIODO_INFORMADO, @FECHA_PROCESO,@CA_SECUENCIA,@R03_TIPO_REGISTRO, @R03_TIPO_PERSONA,@R03_NOMBRE_RAZON_SOCIAL,@R03_TIPO_DOCUMENTO,@R03_OTROS,RIGHT(@R03_NUMERO_DOCUMENTO, 11),@R03_PAIS_OTORGANTE_DOC,@R03_LUGAR_NACIMIENTO,@R03_FECHA_NACIMIENTO,@R03_DOMICILIO_ACTUAL_EXT,@R03_CIUDAD,@R03_PROVINCIA,@R03_PAIS,@R03_NIF,@R03_RESIDENCIA_TRIBUTARIA, @R03_RESIDENCIA)

        

    FETCH NEXT FROM cursorNoResidentes INTO 
    	@PERIODO_INFORMADO,
        @R03_TIPO_PERSONA,
        @R03_NOMBRE_RAZON_SOCIAL,
        @R03_TIPO_DOCUMENTO,
        @R03_OTROS,
        @R03_NUMERO_DOCUMENTO,
        @R03_PAIS_OTORGANTE_DOC,
        @R03_LUGAR_NACIMIENTO,
        @R03_FECHA_NACIMIENTO,
        @R03_DOMICILIO_ACTUAL_EXT,
        @R03_CIUDAD,
        @R03_PROVINCIA,
        @R03_PAIS,
        @R03_NIF,
        @R03_RESIDENCIA_TRIBUTARIA;
END

CLOSE cursorNoResidentes;
DEALLOCATE cursorNoResidentes;

END
GO
