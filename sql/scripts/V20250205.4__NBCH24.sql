EXECUTE('
	CREATE OR ALTER VIEW dbo.VW_NBCH24_CRE_CUOTAS(origen, jtsCRE, nroCuota, fecVencimiento, fecPago, capital, interes, saldo, impuestos, otrosRubros, totalPago)
	AS
	SELECT
	''Topaz'',
	ecc.SALDO_JTS_OID, 
	ecc.NCUOTA,
	ecc.VENCIMIENTOCUOTA,
	ecc.fechavalor,
	ecc.CAPITAL,
	ecc.INTERES,
	ecc.SALDO_CAPITAL+ecc.SALDO_INTERES+ecc.PP_IVAINTERES+ecc.PP_IVAPERCEPCIONINTERES+ecc.PP_MORA+ecc.PP_IVAMORA+ecc.PP_IVAPERCEPCIONMORA+
	ecc.PP_INTCOMPMORA+ecc.PP_IVAINTCOMPMORA+ecc.PP_IVAPERCEPCIONINTCOMPMORA,
	isnull(pagos.impuestos, 0),
	isnull(pagos.otrosRubros, 0), 
	isnull(pagos.totalPago, 0)
	FROM VBS_ESTADO_CUENTA_CLIENTE ecc WITH (NOLOCK)
	LEFT JOIN 

	(select
	vp.SALDO_JTS_OID,
	vp.ncuota,
	(sum(VP.PP_IVAINTERES)+sum(VP.PP_IVAPERCEPCIONINTERES)+sum(VP.PP_IVAMORA)+sum(VP.PP_IVAPERCEPCIONMORA)+sum(VP.PP_IVAINTCOMPMORA)+sum(VP.PP_IVAPERCEPCIONINTCOMPMORA)) AS impuestos, 
	(sum(VP.PP_MORA)+sum(VP.PP_INTCOMPMORA)+sum(VP.PP_GASTOS)) AS otrosRubros,
	(sum(VP.CAPITAL)+sum(VP.INTERES)+sum(VP.PP_IVAINTERES)+sum(VP.PP_IVAPERCEPCIONINTERES)+sum(VP.PP_IVAMORA)+sum(VP.PP_IVAPERCEPCIONMORA)+sum(VP.PP_IVAINTCOMPMORA)+sum(VP.PP_IVAPERCEPCIONINTCOMPMORA)+
	sum(VP.PP_MORA)+sum(VP.PP_INTCOMPMORA)+sum(VP.PP_GASTOS)) AS totalPago
	from VBS_DETALLE_CUOTAS_PAGADAS VP group by VP.SALDO_JTS_OID, VP.NCUOTA

	UNION
	 
	select
	VPMig.SALDO_JTS_OID,
	VPMig.NCUOTA,
	(sum(VPMig.PP_IVAINTERES)+sum(VPMig.PP_IVAPERCEPCIONINTERES)+sum(VPMig.PP_IVAMORA)+sum(VPMig.PP_IVAPERCEPCIONMORA)+sum(VPMig.PP_IVAINTCOMPMORA)+sum(VPMig.PP_IVAPERCEPCIONINTCOMPMORA)) AS impuestos, 
	(sum(VPMig.PP_MORA)+sum(VPMig.PP_INTCOMPMORA)+sum(VPMig.PP_GASTOS)) AS otrosRubros,
	(sum(VPMig.CAPITAL)+sum(VPMig.INTERES)+sum(VPMig.PP_IVAINTERES)+sum(VPMig.PP_IVAPERCEPCIONINTERES)+sum(VPMig.PP_IVAMORA)+sum(VPMig.PP_IVAPERCEPCIONMORA)+sum(VPMig.PP_IVAINTCOMPMORA)+sum(VPMig.PP_IVAPERCEPCIONINTCOMPMORA)+
	sum(VPMig.PP_MORA)+sum(VPMig.PP_INTCOMPMORA)+sum(VPMig.PP_GASTOS)) AS totalPago
	from VBS_DETALLE_CUOTAS_PAGADAS_MIGRADOS VPMig group by VPMig.SALDO_JTS_OID, VPMig.NCUOTA ) 

	pagos ON pagos.SALDO_JTS_OID=ecc.SALDO_JTS_OID AND pagos.NCUOTA=ecc.NCUOTA
');
