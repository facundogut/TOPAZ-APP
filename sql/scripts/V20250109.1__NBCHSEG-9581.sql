EXECUTE('


CREATE  OR ALTER  PROC  SP_ITF_AD_ASIENTOS_CONTABLES
 
AS 
BEGIN 

DECLARE @asiento VARCHAR(10), @fecha_asiento DATETIME, @nro_modelo VARCHAR(22); --, @sucursal NUMERIC(5,0), @producto NUMERIC(5,0), @cuenta NUMERIC(12,0), @moneda NUMERIC(4,0), @operacion NUMERIC(12,0), @ordinal NUMERIC(6,0); 
DECLARE @idCount INT = (SELECT MIN(ID) FROM ITF_ASIENTOS_EXTERNOS WHERE SATELITE=''ADINTAR'' AND ESTADO=''S'');
--recorro padron de entrada
SELECT @asiento = ASIENTO, @fecha_asiento=FECHA_ASIENTO, @nro_modelo=NRO_MODELO
FROM ITF_ASIENTOS_EXTERNOS (nolock) WHERE ID=@idCount;

	WHILE @asiento IS NOT NULL 
	BEGIN	
	
	
	INSERT INTO dbo.BANDEJA_ASIENTOS_IN (ESTADO, ORIGEN, OPERACION, DESCRIPCION, FECHAPROCESO)
	VALUES (''S'', ''AAC'',  8624, (SELECT DESCRIPCION FROM BANDEJA_ORIGENES WHERE ORIGEN=''AAC''), (SELECT FECHAPROCESO FROM PARAMETROS))
	
	INSERT INTO dbo.BANDEJA_MOVS_IN (JTS_OID_ASIENTO, 
									 SUCURSAL, 
									 PRODUCTO, 
									 CUENTA, 
									 MONEDA, 
									 OPERACION, 
									 ORDINAL, 
									 CLIENTE, 
									 SIGNO, 
									 MONTO, 
									 CONCEPTO, 
									 RUBRO_CONTABLE, 
									 fecha_valor, 
									 moneda_monto,
									 RUBRO_OPERATIVO)
	SELECT  (SELECT MAX(JTS_OID) FROM BANDEJA_ASIENTOS_IN WHERE ESTADO=''S'' AND ORIGEN=''AAC''), 
			 CASE WHEN EXISTS (SELECT 1
			                   FROM CON_RUBRO_CONTABLE_ORIG_DEST_ME me
			                   WHERE substring(convert(VARCHAR(12),me.rubro_origen),1,10) = CONCAT(a.CAPITULO_CONT,a.RUBRO_CONT,a.MONEDA_CONT,a.CUENTA_CONT,a.SUCUENTA_CONT)) 
			 THEN 97
			 ELSE 95
			 END, 
			 s.PRODUCTO, 
			 s.CUENTA, 
			 s.MONEDA, 
			 s.OPERACION, 
			 s.ORDINAL, 
			 0, 
			 a.COD_MOVIMIENTO, 
			 (a.IMPORTE_DEBE + a.IMPORTE_HABER), 
			 CONCAT(''1.3.2 AD '',a.CONCEPTO_ASIENTO), 
			 CONCAT(a.CAPITULO_CONT,a.RUBRO_CONT,a.MONEDA_CONT,a.CUENTA_CONT,a.SUCUENTA_CONT), 
			 a.FECHA_ASIENTO, 
			 a.MONEDA,
			 (select C6340 
			  from PLANCTAS 
			  WHERE C6326=CONCAT(a.CAPITULO_CONT,a.RUBRO_CONT,a.MONEDA_CONT,a.CUENTA_CONT,a.SUCUENTA_CONT))
	FROM ITF_ASIENTOS_EXTERNOS a 
	INNER JOIN SALDOS s ON s.JTS_OID = (SELECT TOP 1 JTS_OID 
										FROM SALDOS 
										WHERE C1730=(CONCAT(a.CAPITULO_CONT,a.RUBRO_CONT,a.MONEDA_CONT,a.CUENTA_CONT,a.SUCUENTA_CONT)) 
										AND MONEDA=a.MONEDA 
										--AND SUCURSAL= (SELECT NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO=21)
										AND SUCURSAL= (CASE WHEN EXISTS(SELECT 1 FROM CON_RUBRO_CONTABLE_ORIG_DEST_ME me WITH(NOLOCK)
									   				              WHERE substring(convert(VARCHAR(12),me.rubro_origen),1,10) = C1730)
												            THEN (SELECT NUMERICO FROM PARAMETROSGENERALES NOLOCK WHERE CODIGO=21)
														    ELSE 95
													   END)
										)
	WHERE a.ASIENTO=@asiento 
	AND a.FECHA_ASIENTO=@fecha_asiento 
	AND a.NRO_MODELO=@nro_modelo 
	AND SATELITE=''ADINTAR'' 
	AND ESTADO=''S''
	ORDER BY NRO_ORDEN
	
	
	---- Siguiente registro
	UPDATE dbo.ITF_ASIENTOS_EXTERNOS
	SET ESTADO=''P'', ID_LOTE=(SELECT MAX(JTS_OID) FROM BANDEJA_ASIENTOS_IN WHERE ESTADO=''S'' AND ORIGEN=''AAC'')
	WHERE SATELITE=''ADINTAR'' AND ESTADO=''S'' AND ASIENTO=@asiento AND @fecha_asiento=FECHA_ASIENTO AND @nro_modelo=NRO_MODELO
	
	SET @idCount = NULL;
	SET @asiento= NULL;
	
	SET @idCount  = (SELECT MIN(ID) FROM ITF_ASIENTOS_EXTERNOS WHERE SATELITE=''ADINTAR'' AND ESTADO=''S'');
	SELECT @asiento = ASIENTO, @fecha_asiento=FECHA_ASIENTO, @nro_modelo=NRO_MODELO
	FROM ITF_ASIENTOS_EXTERNOS (nolock) WHERE ID=@idCount;
	
	END


END
')