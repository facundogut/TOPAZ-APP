EXECUTE('
IF OBJECT_ID (''dbo.VW_PAS_CV_INMOVILIZAR'') IS NOT NULL
	DROP VIEW dbo.VW_PAS_CV_INMOVILIZAR
')
EXECUTE('
CREATE VIEW [dbo].[VW_PAS_CV_INMOVILIZAR] 
AS
WITH CTE_PARAMETROS_INMOVILIZADAS AS (
	SELECT ORDINAL, TIPO, VALOR, INCLUIR_EXCLUIR FROM VTA_PARAM_CTAS_INMOV WITH (nolock)
	WHERE ACTIVO = ''A''
		AND TZ_LOCK = 0
),

CTE_MOVIMIENTOS_CONFIRMADOS AS (
	SELECT MC.SALDO_JTS_OID, MAX(MC.FECHAPROCESO) AS FECHAPROCESO
	FROM MOVIMIENTOS_CONTABLES AS MC WITH (nolock)
	INNER JOIN ASIENTOS AS A WITH (nolock) ON
		A.ASIENTO = MC.ASIENTO
		AND A.SUCURSAL = MC.SUCURSAL
		AND A.FECHAPROCESO = MC.FECHAPROCESO
		AND A.ESTADO = 77
	--BUSCAMOS EL MOVIMIENTO CON ASIENTO CONFIRMADO MÁS RECIENTE PARA EL SALDO
	--SIN TENER EN CUENTA LOS CÓDIGOS DE TRANSACCIÓN PARAMETRIZADO
	WHERE MC.COD_TRANSACCION NOT IN (
		SELECT VALOR FROM CTE_PARAMETROS_INMOVILIZADAS WITH (NOLOCK)
		WHERE TIPO = ''V'' --TIPO DE MOVIMIENTO
			AND INCLUIR_EXCLUIR = ''E''
	)
	GROUP BY MC.SALDO_JTS_OID
)

SELECT
	S.C1803 AS NRO_CLIENTE,
	C.NOMBRECLIENTE,
	S.CUENTA,
	S.MONEDA,
	S.C1604 AS SALDO,
	S.JTS_OID
FROM SALDOS AS S WITH (nolock)
INNER JOIN TOPESPRODUCTO AS TP WITH (nolock) ON
	TP.CODPRODUCTO = S.PRODUCTO
	AND TP.MONEDA = S.MONEDA
	--1: INCLUSIÓN DE PRODUCTOS QUE PUEDEN PASAR A INMOVILIZADO
	AND TP.PASAJE_INMOVILIZADO = ''S''
	AND ((TP.TZ_LOCK < 100000000000000 OR TP.TZ_LOCK >= 200000000000000)
		AND (TP.TZ_LOCK < 300000000000000 OR TP.TZ_LOCK >= 400000000000000)  
	)
INNER JOIN CLI_CLIENTES AS C WITH (nolock) ON
	C.CODIGOCLIENTE = S.C1803
	--CONTROL PARA EXCLUIR A CUENTAS DEL SECTOR FINANCIERO
	AND C.SUBDIVISION1 <> ''03''
	AND ((C.TZ_LOCK < 100000000000000 OR C.TZ_LOCK >= 200000000000000)
		AND (C.TZ_LOCK < 300000000000000 OR C.TZ_LOCK >= 400000000000000)  
	)
WHERE
	--2: EXCLUSIÓN DE CÓDIGOS DE MOVIMIENTO
	--7: DÍAS SIN MOVIMIENTO
	DATEDIFF(DD, (	SELECT FECHAPROCESO 
					FROM CTE_MOVIMIENTOS_CONFIRMADOS AS MC WITH (nolock)
					WHERE MC.SALDO_JTS_OID = S.JTS_OID
			), (SELECT FECHAPROCESO FROM PARAMETROS WITH (nolock))
	) >=
  	ISNULL ((	SELECT MAX(VALOR) FROM CTE_PARAMETROS_INMOVILIZADAS WITH (nolock)
				WHERE TIPO = ''D'' --DÍAS
					AND INCLUIR_EXCLUIR = ''I''
			), 0
	)
	--3: EXCLUSIÓN DE CONTRACUENTAS
	AND S.JTS_OID NOT IN (	SELECT JTS_OID_DEBITO 
							FROM COF_COFRES_CONTRATOS WITH (nolock)
							WHERE
								ESTADO NOT IN (''A'', ''R'')
								AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
									AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  
								)
							GROUP BY JTS_OID_DEBITO
	)
	AND S.JTS_OID NOT IN (	SELECT SALDO_JTS_OID 
							FROM TJD_REL_TARJETA_CUENTA WITH (nolock)
							WHERE ESTADO NOT IN (''9'', ''X'')
								AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
									AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  
								)
							GROUP BY SALDO_JTS_OID
	)
	AND S.JTS_OID NOT IN (	SELECT C1665
							FROM SALDOS WITH (nolock)
							WHERE C1785 IN ( 
								SELECT VALOR FROM CTE_PARAMETROS_INMOVILIZADAS WITH (nolock)
								WHERE TIPO = ''C'' --CONTRACUENTA
									AND INCLUIR_EXCLUIR = ''E''
							)
							AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
								AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  
							)
							GROUP BY C1665
	)
	--4: IMPORTES MÍNIMO Y MÁXIMO
	AND S.C1604 >= ISNULL((	SELECT VALOR FROM CTE_PARAMETROS_INMOVILIZADAS WITH (nolock)
							WHERE TIPO = ''M'' --MÍNIMO
								AND INCLUIR_EXCLUIR = ''I''
					), -9999999999999.99)
					
	AND S.C1604 <= 	ISNULL((SELECT VALOR FROM CTE_PARAMETROS_INMOVILIZADAS WITH (nolock)
							WHERE TIPO = ''X'' --MÍNIMO
								AND INCLUIR_EXCLUIR = ''I''
					), 9999999999999.99)
	--5: EXCLUSIÓN DE DETERMINADOS BLOQUEOS
	AND S.JTS_OID NOT IN (	SELECT SALDO_JTS_OID
							FROM GRL_BLOQUEOS WITH (nolock)
							WHERE ESTADO IN (0, 1)
								AND COD_BLOQUEO IN (
									SELECT VALOR FROM CTE_PARAMETROS_INMOVILIZADAS WITH (nolock)
									WHERE TIPO = ''B'' --BLOQUEOS
										AND INCLUIR_EXCLUIR = ''E''
								)
								AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
									AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  
								)
							GROUP BY SALDO_JTS_OID
	)
	--6: INCLUSIÓN DE MONEDAS
	AND S.MONEDA IN (
		SELECT VALOR FROM CTE_PARAMETROS_INMOVILIZADAS WITH (nolock)
		WHERE TIPO = ''N'' --MONEDA
			AND INCLUIR_EXCLUIR = ''I''
	)
	
	--FILTROS GENERALES
	AND S.C1785 IN (2, 3) 	--CUENTAS VISTA
	AND S.C1651 <> ''1'' 		--SALDO NO CANCELADO
	AND S.C1728 <> ''I''		--SALDO NO INMOVILIZADO
	AND S.C1734 <> ''I''		--SALDO NO MARCADO PARA INMOVILIZAR
	AND ((S.TZ_LOCK < 100000000000000 OR S.TZ_LOCK >= 200000000000000)
		AND (S.TZ_LOCK < 300000000000000 OR S.TZ_LOCK >= 400000000000000)  
	)

')