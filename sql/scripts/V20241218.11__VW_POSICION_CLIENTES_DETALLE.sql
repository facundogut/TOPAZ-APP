EXECUTE('
IF OBJECT_ID (''dbo.VW_POSICION_CLIENTES_DETALLE'') IS NOT NULL
	DROP VIEW dbo.VW_POSICION_CLIENTES_DETALLE
')

EXECUTE('
CREATE VIEW [dbo].[VW_POSICION_CLIENTES_DETALLE] AS 
SELECT 	CLIENTE AS ''Cliente'',
 		TIPODOC AS ''Tipo'',NUMERODOC AS ''Nro Doc'', PAISDOCUMENTO AS ''Pais Doc'', NUMEROPERSONA AS ''Persona'',
		CLASIFICACION AS ''Clasificacion'',
		T.SUCURSAL AS ''Sucursal'',
		T.NOMBRESUCURSAL AS ''Nombre Sucursal'',
		T.PRODUCTO AS ''Producto'',
		T.NOMBREPRODUCTO AS ''Nombre Producto'', 
		T.CUENTA AS ''Cuenta'',
		T.MONEDA AS ''Moneda'',
		T.OPERACION AS ''Operacion'',
		T.ORDINAL AS ''Desglose'',
		DEUDA_EXIGIBLE AS ''Deuda Exigible'',
		DEUDA_NO_EXIGIBLE AS ''Deuda no Exigible'',
		DEUDA_TOTAL ''Deuda Total'',
		DEUDA_CONTINGENTE ''Deuda Contingente'',
CASE WHEN DEUDA_TOTAL < DEUDA_CONTINGENTE THEN DEUDA_CONTINGENTE
	ELSE DEUDA_TOTAL END AS ''Riesgo Total'',
		T.MONTOORIGEN AS ''Monto Origen'',
		T.SALDO AS ''Saldo Capital'',
		T.VENCIMIENTO AS ''Vencimiento'',
		T.ESTADO AS ''Estado'',
		T.JTS_OID
FROM ( 
SELECT 	vw.CLIENTE, 
		s.SUCURSAL,
		vw.NOMBRESUCURSAL,
		s.PRODUCTO,
		vw.NOMBREPRODUCTO,
		s.CUENTA,
		s.MONEDA,
		s.OPERACION,
		s.ORDINAL,
		CASE WHEN vw.CLASIFICACION IN (''S'',''A'',''O'') THEN 0 ELSE vw.MONTOORIGEN END AS MONTOORIGEN ,
		vw.SALDO,
		vw.VENCIMIENTO,
		vw.ESTADO,
	 CASE WHEN vw.CLASIFICACION=''L'' THEN ''Leasing''
	 WHEN vw.CLASIFICACION IN (''S'',''A'',''O'') THEN ''CC''
	 WHEN vw.CLASIFICACION=''D'' THEN ''Descuento Bancario''
	 WHEN vw.CLASIFICACION=''T'' THEN ''Tarjeta de Crédito''
	 WHEN vw.CLASIFICACION=''GO'' THEN ''Garantías Otorgadas''
	 WHEN vw.CLASIFICACION=''SGR'' THEN ''Sociedades de Garantía Recíproca''
	 ELSE ''Prestamos'' END AS CLASIFICACION,
	 CASE WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))> 0 THEN sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))
	 	  WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))< 0 THEN 0
	 	  WHEN CLASIFICACION=''SGR'' THEN 0
	      WHEN CLASIFICACION=''GO''  THEN 0
	      WHEN CLASIFICACION=''D''  THEN 0
	      WHEN CLASIFICACION IN (''S'',''A'',''O'')  THEN  sum(SALDO) --  Para CC considera acuerdos vigentes, es el disponible
	 	  ELSE sum(SALDO_DEUDA) END AS DEUDA_EXIGIBLE,
	 	  
	 CASE WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))> 0 THEN sum(s.AJUSTEINFLACION) -  (sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION)))
	      WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))< 0 THEN sum(SALDO_DEUDA)
	      WHEN CLASIFICACION=''SGR'' THEN 0
	      WHEN CLASIFICACION=''GO''  THEN 0
	      WHEN CLASIFICACION=''D'' THEN SUM(SALDO_DEUDA)
	 	  ELSE SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0)) 
	 END  AS DEUDA_NO_EXIGIBLE,
	 CASE WHEN CLASIFICACION=''D'' THEN SUM(SALDO_DEUDA)
	 	  WHEN CLASIFICACION IN (''S'',''A'',''O'') THEN  sum(SALDO)+sum(SALDO_DEUDA)
	 	  ELSE (sum(SALDO_DEUDA)+ SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0))) 
	 END AS DEUDA_TOTAL,
	 
	 CASE WHEN prod.MONTO IS NOT NULL THEN max(prod.MONTO) -- Monto Calificacion
	 	  WHEN CLASIFICACION IN (''S'',''A'',''O'') THEN sum(vw.MONTOORIGEN) -- Monto Acuerdos
	      WHEN CLASIFICACION=''T'' THEN sum(s.C1806) -- Limite Cuotas
	      WHEN CLASIFICACION=''SGR'' THEN sum(SALDO_DEUDA)
	      WHEN CLASIFICACION=''GO''  THEN sum(SALDO_DEUDA)
	      ELSE 0 -- Si no tiene nada de lo anterior es 0 
	 END AS DEUDA_CONTINGENTE,
s.JTS_OID,
vw.TIPODOC,vw.NUMERODOC, vw.PAISDOCUMENTO, vw.NUMEROPERSONA 	      
FROM VW_DEUDA_CLIENTES_POSICION vw
INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID=vw.JTS_OID
LEFT JOIN VW_ASISTENCIAS_D_NO_EXIGIBLE_POSICION A ON A.SALDO_JTS_OID=vw.JTS_OID
LEFT JOIN CRE_LIMITECLIENTE l WITH (nolock) ON l.CLIENTE=vw.CLIENTE AND l.ESTADO=''A'' AND l.TZ_LOCK=0
LEFT JOIN CRE_PRODUCTOLIC prod WITH (nolock) ON prod.IDLIMITE=l.IDLIMITE AND prod.PRODUCTO=vw.PRODUCTO AND prod.TZ_LOCK=0
-- WHERE 
-- vw.SALDO >0
GROUP BY vw.CLIENTE, vw.TIPODOC,vw.NUMERODOC, vw.PAISDOCUMENTO, vw.NUMEROPERSONA,
 vw.CLASIFICACION, s.JTS_OID,s.SUCURSAL,s.PRODUCTO,s.CUENTA,s.MONEDA,s.OPERACION,vw.NOMBRESUCURSAL,vw.NOMBREPRODUCTO,
s.ORDINAL,vw.MONTOORIGEN,vw.SALDO,vw.VENCIMIENTO,vw.ESTADO, prod.MONTO
) T
WHERE DEUDA_TOTAL> 0
-- (CASE WHEN CLASIFICACION IN (''S'',''A'',''O'') THEN (SALDO+SALDO_DEUDA+MONTOORIGEN) ELSE SALDO END) >0
')