EXECUTE('
IF OBJECT_ID (''dbo.VW_CUENTAS'') IS NOT NULL
	DROP VIEW dbo.VW_CUENTAS
')

EXECUTE('
CREATE   VIEW [dbo].[VW_CUENTAS]
(
	CUENTA,
	NOMBRE,
	PRODUCTO,
	DESCRIPCION,
	MONEDA,
	DESCRIPCION_MONEDA,
	SUCURSAL,
	ORDINAL,
	OPERACION,
	CLIENTE,
	TIPO_DOCUMENTO,
	DOCUMENTO,
	TIPOPROD,
	BLOQUEO,
	C1728,
	TIPO_SALDO_FONDO,
	RUBRO,
	C1651,
	SALDO_ACTUAL,
	C1601,
	JTS_OID,
	VISUALIZABLE,
	NOMBRE_RUBRO
) AS 
SELECT	S.CUENTA, 
		VS.NOMBRE_CUENTA, 
		S.PRODUCTO, 
		P.C6251, 
		S.MONEDA,
		M.C6400,
		S.SUCURSAL, 
		S.ORDINAL, 
		S.OPERACION, 
		S.C1803, 
		ISNULL(DF.TIPODOCUMENTO, DJ.TIPODOCUMENTO) AS TIPODOCUMENTO, 
		ISNULL(DF.NUMERODOCUMENTO, DJ.NUMERODOCUMENTO) AS NUMERODOCUMENTO,
		S.C1785, 
   		CASE WHEN S.C1679=''1'' THEN ''Si'' ELSE ''No'' END AS BLOQUEO, 
		S.C1728, 
		S.TIPO_SALDO_FONDO, 
		S.C1730, 
		S.C1651, 
		(S.C1604 + S.C1605 + S.C1683 + S.C2627) as disponible,
		S.C1601, 
		S.JTS_OID, 
		S.C1694, 
		PL.C6300
FROM SALDOS AS S with (nolock)
INNER JOIN VTA_SALDOS AS VS with (nolock) ON
	VS.JTS_OID_SALDO = S.JTS_OID
	AND ((VS.TZ_LOCK < 300000000000000 OR VS.TZ_LOCK >= 400000000000000)
		AND (VS.TZ_LOCK < 100000000000000 OR VS.TZ_LOCK >= 200000000000000)
	) 
INNER JOIN PRODUCTOS AS P with (nolock) ON 
	P.C6250 = S.PRODUCTO
	AND ((P.TZ_LOCK < 300000000000000 OR P.TZ_LOCK >= 400000000000000)
		AND (P.TZ_LOCK < 100000000000000 OR P.TZ_LOCK >= 200000000000000)
	)
INNER JOIN MONEDAS M with (nolock) ON 
	M.C6399 = S.MONEDA
	AND ((M.TZ_LOCK < 300000000000000 OR M.TZ_LOCK >= 400000000000000)
		AND (M.TZ_LOCK < 100000000000000 OR M.TZ_LOCK >= 200000000000000)
	)
INNER JOIN PLANCTAS PL with (nolock) ON 
	PL.C6326 = S.C1730
	AND ((PL.TZ_LOCK < 300000000000000 OR PL.TZ_LOCK >= 400000000000000)
		AND (PL.TZ_LOCK < 100000000000000 OR PL.TZ_LOCK >= 200000000000000)
	)
INNER JOIN CLI_CLIENTEPERSONA AS CP WITH (nolock) ON
	CP.CODIGOCLIENTE = S.C1803
	AND CP.TITULARIDAD = ''T''
	AND ((CP.TZ_LOCK < 300000000000000 OR CP.TZ_LOCK >= 400000000000000)
		AND (CP.TZ_LOCK < 100000000000000 OR CP.TZ_LOCK >= 200000000000000)
	)
LEFT JOIN CLI_PERSONASFISICAS AS PF WITH (nolock) ON
	PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA
	AND ((PF.TZ_LOCK < 300000000000000 OR PF.TZ_LOCK >= 400000000000000)
		AND (PF.TZ_LOCK < 100000000000000 OR PF.TZ_LOCK >= 200000000000000)
	)
LEFT JOIN CLI_PERSONASJURIDICAS AS PJ WITH (nolock) ON
	PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA
	AND ((PJ.TZ_LOCK < 300000000000000 OR PJ.TZ_LOCK >= 400000000000000)
		AND (PJ.TZ_LOCK < 100000000000000 OR PJ.TZ_LOCK >= 200000000000000)
	)
LEFT JOIN CLI_DOCUMENTOSPFPJ AS DF WITH (nolock) ON
	DF.NUMEROPERSONAFJ = PF.NUMEROPERSONAFISICA
	AND DF.TIPODOCUMENTO IN (
		SELECT TOP 1 TIPODOCUMENTO
		FROM CLI_DOCUMENTOSPFPJ WITH (nolock)
		WHERE 
			NUMEROPERSONAFJ = DF.NUMEROPERSONAFJ
			AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
			)						
	)
	AND DF.NUMERODOCUMENTO IN (
		SELECT TOP 1 NUMERODOCUMENTO
		FROM CLI_DocumentosPFPJ WITH (nolock)
		WHERE 
			NUMEROPERSONAFJ = DF.NUMEROPERSONAFJ
			AND TIPODOCUMENTO = DF.TIPODOCUMENTO
			AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
			)						
	)
	AND ((DF.TZ_LOCK < 300000000000000 OR DF.TZ_LOCK >= 400000000000000)
		AND (DF.TZ_LOCK < 100000000000000 OR DF.TZ_LOCK >= 200000000000000)
	)
LEFT JOIN CLI_DOCUMENTOSPFPJ AS DJ WITH (nolock) ON
	DJ.NUMEROPERSONAFJ = PJ.NUMEROPERSONAJURIDICA
	AND DJ.TIPODOCUMENTO IN (
		SELECT TOP 1 TIPODOCUMENTO
		FROM CLI_DOCUMENTOSPFPJ WITH (nolock)
		WHERE 
			NUMEROPERSONAFJ = DJ.NUMEROPERSONAFJ
			AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
			)						
	)
	AND DJ.NUMERODOCUMENTO IN (
		SELECT TOP 1 NUMERODOCUMENTO
		FROM CLI_DocumentosPFPJ WITH (nolock)
		WHERE 
			NUMEROPERSONAFJ = DJ.NUMEROPERSONAFJ
			AND TIPODOCUMENTO = DJ.TIPODOCUMENTO
			AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
			)						
	)
	AND ((DJ.TZ_LOCK < 300000000000000 OR DJ.TZ_LOCK >= 400000000000000)
		AND (DJ.TZ_LOCK < 100000000000000 OR DJ.TZ_LOCK >= 200000000000000)
	)
WHERE 
	S.TZ_LOCK = 0
')