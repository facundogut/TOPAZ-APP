EXECUTE('
DROP TABLE IF EXISTS dbo.RESTR_TRABA_CONTABLE_USU;
DROP TABLE IF EXISTS dbo.RESTR_TRABA_CONTABLE_PROC;
DROP FUNCTION IF EXISTS dbo.VALIDA_TRABA_CONTABLE;
DROP VIEW IF EXISTS dbo.VW_RESTR_TRABA_CONTABLE_USU;
DROP VIEW IF EXISTS dbo.VW_CODIGO_TRANSACCIONES;
DROP TABLE dbo.ITF_AD_CREDICOM_AUX;
');
EXECUTE('
delete from OPERACIONES where IDENTIFICACION = 96;
delete from DESCRIPTORES where IDENTIFICACION in (13,25);
delete from DICCIONARIO where NUMERODECAMPO in (7836,7837,7838,7839,7840,7841,7842,7843);
delete from INDICES where NUMERODEARCHIVO in (13,25);
delete from AYUDAS where NUMERODEAYUDA in (1301,2501,34556);
delete from OPCIONES where NUMERODECAMPO = 7842;
delete from dbo.ITF_MASTER_PARAMETROS where CODIGO_INTERFACE = 131 or CODIGO in (175,190,191,237,238,239,240,241,484,485,486,487,512,513,514,515,516);
delete from dbo.ITF_MASTER where ID in (109,110);
delete from ITF_MASTER_CAUSALES where ID_SATELITE = ''ADINTAR'' and COD_CAUSAL in (''CREDCOMCB'',''CREDCOMMC'',''CREDCOMTU'',''CREDCOMVI'',''DEBCOMCB'',''DEBCOMTU'',''DEBCOMVI'');
delete from CODIGO_TRANSACCIONES where CODIGO_OPERACION = 8908 and CODIGO_INTERNO_MOV in (7,8,9,10);
delete from PACAMPOS where OPERACION = 18 and LINEA in (4,5) and CAMPO = 7919;
delete from PACAMPOSCABEZAL where OPERACION = 18 and LINEA in (4,5);
');
EXECUTE('
CREATE TABLE dbo.RESTR_TRABA_CONTABLE_USU 
(
	USUARIO varchar(10) COLLATE Modern_Spanish_CI_AS NOT NULL, 
	TRABA_CONTABLE numeric(3,0) DEFAULT 0 NOT NULL, 
	TZ_LOCK numeric(15,0) DEFAULT 0 NOT NULL, 
	CONSTRAINT PK_RESTR_TRABA_CONTABLE_USU PRIMARY KEY (USUARIO) 
);
CREATE TABLE dbo.RESTR_TRABA_CONTABLE_PROC 
(
	CLAVE_PROCESO varchar(50) COLLATE Modern_Spanish_CI_AS NOT NULL, 
	TRABA_CONTABLE numeric(3,0) DEFAULT 0 NOT NULL, 
	COMENTARIO varchar(100),
	TZ_LOCK numeric(15,0) DEFAULT 0 NOT NULL, 
	CONSTRAINT PK_RESTR_TRABA_CONTABLE_PROC PRIMARY KEY (CLAVE_PROCESO) 
);
CREATE TABLE dbo.ITF_AD_CREDICOM_AUX (
	NRO_REG numeric(15,0) NOT NULL,
	COD_ACRED varchar(2) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	NRO_CUENTA_ACRED varchar(11) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	COD_TIPO_MOV varchar(1) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	FECHA_ACRED varchar(8) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	NRO_COMPROBANTE varchar(9) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	IMPORTE_ACRED varchar(13) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	COD_ADMIN varchar(1) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	COD_MONEDA varchar(1) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	SUCURSAL_CUENTA varchar(5) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	NOMBRE_CLIENTE varchar(30) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	NRO_CUIT varchar(12) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	NRO_COMERCIO varchar(20) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	NRO_CBU varchar(22) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	ID_UNIVOCO varchar(15) COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	COD_RESPUESTA varchar(3) COLLATE Modern_Spanish_CI_AS NULL,
	DETALLE text COLLATE Modern_Spanish_CI_AS DEFAULT '' '' NULL,
	JTS_BANDEJA numeric(15,0) NULL,
	CONSTRAINT PK_ITF_AD_CREDICOM_AUX_01 PRIMARY KEY (NRO_REG)
);
');
EXECUTE('
CREATE VIEW dbo.VW_RESTR_TRABA_CONTABLE_USU 
AS
select 
rtc.USUARIO as ''USUARIO'', 
u.NOMBRE as ''NOMBRE'', 
rtc.TRABA_CONTABLE as ''TRABA'' 
from RESTR_TRABA_CONTABLE_USU rtc 
left join USUARIOS u on u.CLAVE = rtc.USUARIO and u.TZ_LOCK = 0 
where rtc.TZ_LOCK = 0;
');
EXECUTE('
CREATE VIEW dbo.VW_CODIGO_TRANSACCIONES
AS
SELECT cod.CODIGO_OPERACION AS OPERACION, cod.CODIGO_INTERNO_MOV AS CODIGO_INTERNO, cod.CODIGO_TRANSACCION, def.DESCRIPCION 
FROM CODIGO_TRANSACCIONES cod WITH (NOLOCK)
INNER JOIN TTR_CODIGO_TRANSACCION_DEF def WITH (NOLOCK) ON cod.CODIGO_TRANSACCION=def.CODIGO_TRANSACCION 
WHERE cod.TZ_LOCK=0 AND def.TZ_LOCK=0;
');
EXECUTE('
CREATE FUNCTION dbo.VALIDA_TRABA_CONTABLE (@FECHA_VALOR DATE, @USUARIO varchar(10), @CLAVE_PROCESO varchar(50)) RETURNS varchar(1) 
AS
BEGIN
	
	DECLARE @RETORNO varchar(1) = ''S'';
	
	IF (@FECHA_VALOR is not null)
	BEGIN
		
		DECLARE @PERIODO_CERRADO numeric(6,0) = (select MAX(ANIOMES) from ESTADO_BALANCE where ABIERTO_CERRADO = ''C'' and TZ_LOCK = 0);
		DECLARE @PERIODO_FECHA_VALOR numeric(6,0) = CONVERT(numeric(6,0), CONVERT(varchar(6), YEAR(@FECHA_VALOR)) + RIGHT(''0'' + CONVERT(varchar(2), MONTH(@FECHA_VALOR)), 2));
		
		IF (@PERIODO_FECHA_VALOR <= @PERIODO_CERRADO)
			RETURN ''N'';
		
		DECLARE @FECHA_PROCESO DATE = (select top 1 FECHAPROCESO from PARAMETROS);
		DECLARE @RESTRICCION_USUARIO numeric(3,0) = (select TRABA_CONTABLE from RESTR_TRABA_CONTABLE_USU where USUARIO = @USUARIO and TZ_LOCK = 0);
		DECLARE @RESTRICCION_PROCESO numeric(3,0) = (select TRABA_CONTABLE from RESTR_TRABA_CONTABLE_PROC where CLAVE_PROCESO = @CLAVE_PROCESO and TZ_LOCK = 0);
		DECLARE @DIAS_ENTRE_FECHAS INT = (select dbo.DiasHabilesEntreFechas(@FECHA_VALOR,@FECHA_PROCESO));
		
		IF datediff(day,@FECHA_VALOR,@FECHA_PROCESO) < 0 
			RETURN ''N'';
		
		IF dbo.diaHabil(@FECHA_VALOR,''A'') <> @FECHA_VALOR
			RETURN ''N'';
		
		IF @DIAS_ENTRE_FECHAS > @RESTRICCION_USUARIO
			RETURN ''N'';
		
		IF @DIAS_ENTRE_FECHAS > @RESTRICCION_PROCESO
			RETURN ''N'';
		
	END
	
	RETURN @RETORNO;
	
END;
');
EXECUTE('
insert into OPERACIONES (TITULO,IDENTIFICACION,NOMBRE,DESCRIPCION,MNEMOTECNICO,AUTORIZACION,FORMULARIOPRINCIPAL,PROXOPERACION,ESTADO,TZ_LOCK,COPIAS,SUBOPERACION,PERMITEBAJA,COMPORTAMIENTOENCIERRE,REQUIERECONTRASENA,PERMITECONCURRENTE,PERMITEESTADODIFERIDO,ICONO_TITULO,ESTILO) values
	 (6800,96,N''Restriccion Dias Fecha Valor'',N''Configuracion de restriccion para Dias Fecha Valor'',N''96'',N''N'',NULL,NULL,N''P'',0,NULL,0,N''S'',N''N'',N''N'',N''S'',N''N'',NULL,0);
insert into DESCRIPTORES (TITULO,IDENTIFICACION,TIPODEARCHIVO,DESCRIPCION,GRUPODELMAPA,NOMBREFISICO,TIPODEDBMS,LARGODELREGISTRO,INICIALIZACIONDELREGISTRO,BASE,SELECCION,ACEPTA_MOVS_DIFERIDO) values
	 (800,13,NULL,N''Restr Traba Contable Usuarios'',0,N''RESTR_TRABA_CONTABLE_USU'',N''D'',NULL,NULL,N''Top/Clientes'',NULL,N''N''),
	 (800,25,NULL,N''Restr Traba Contable Procesos'',0,N''RESTR_TRABA_CONTABLE_PROC'',N''D'',NULL,NULL,N''Top/Clientes'',NULL,N''N'');
insert into DICCIONARIO (NUMERODECAMPO,USODELCAMPO,REFERENCIA,DESCRIPCION,PROMPT,LARGO,TIPODECAMPO,DECIMALES,EDICION,CONTABILIZA,CONCEPTO,CALCULO,VALIDACION,TABLADEVALIDACION,TABLADEAYUDA,OPCIONES,TABLA,CAMPO,BASICO,MASCARA) values
	 (7836,N'''',0,N''Usuario Restringido'',N''Clave del Usuario'',10,N''A'',0,NULL,0,0,0,0,0,9902,0,13,N''USUARIO'',0,NULL),
	 (7837,N'''',0,N''Restriccion en dias Traba Contable'',N''Días Fecha Valor'',3,N''N'',0,NULL,0,0,0,0,0,0,0,13,N''TRABA_CONTABLE'',0,NULL),
	 (7838,N'''',0,N''Proceso Restringido'',N''Clave del Proceso'',50,N''A'',0,NULL,0,0,0,0,0,0,0,25,N''CLAVE_PROCESO'',0,NULL),
	 (7839,N'''',0,N''Restriccion en dias Traba Contable'',N''Días Fecha Valor'',3,N''N'',0,NULL,0,0,0,0,0,0,0,25,N''TRABA_CONTABLE'',0,NULL),
	 (7840,N'''',0,N''Grilla Restr Usu'',N''Grilla Restricciones por Usuario'',10,N''A'',0,NULL,0,0,0,0,0,1301,0,0,NULL,0,NULL),
	 (7841,N'''',0,N''Grilla Restr Proc'',N''Grilla Restricciones por Proceso'',50,N''A'',0,NULL,0,0,0,0,0,2501,0,0,NULL,0,NULL),
	 (7842,N'''',0,N''Tipos de Restriccion TC'',N''Tipos Restriccion TC'',1,N''A'',0,NULL,0,0,0,0,0,0,1,0,NULL,0,NULL),
	 (7843,N'''',0,N''Comentario Proceso Restringido'',N''Descripción Proceso'',100,N''A'',0,NULL,0,0,0,0,0,0,0,25,N''COMENTARIO'',0,NULL);
insert into INDICES (NUMERODEARCHIVO,NUMERODEINDICE,DESCRIPCION,CLAVESREPETIDAS,CAMPO1,CAMPO2,CAMPO3,CAMPO4,CAMPO5,CAMPO6,CAMPO7,CAMPO8,CAMPO9,CAMPO10,CAMPO11,CAMPO12,CAMPO13,CAMPO14,CAMPO15,CAMPO16,CAMPO17,CAMPO18,CAMPO19,CAMPO20) values
	 (13,1,N''PK_RESTR_TRABA_CONTABLE_USU'',0,7836,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL),
	 (25,1,N''PK_RESTR_TRABA_CONTABLE_PROC'',0,7838,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL);
insert into AYUDAS (NUMERODEARCHIVO,NUMERODEAYUDA,DESCRIPCION,FILTRO,MOSTRARTODOS,CAMPOS,CAMPOSVISTA,BASEVISTA,NOMBREVISTA,AYUDAGRANDE) values
	 (0,1301,N''Grilla Elegir Restr Usu'',N'''',0,N''7836R;4414;7837;'',''USUARIO;NOMBRE;TRABA;'',''TOP/CLIENTES'',''VW_RESTR_TRABA_CONTABLE_USU'',0),
	 (25,2501,N''Grilla Elegir Restr Proc'',N'''',0,N''7838R;7843;7839;'',NULL,NULL,NULL,0),
	 (0,34556,N''VW_CODIGO_TRANSACCIONES'',N'''',0,N''2631;199R;35462;3920;'',N''Operacion;Codigo_Interno;Codigo_Transaccion;Descripcion;'',N''TOP/CLIENTES'',N''VW_CODIGO_TRANSACCIONES'',0);
insert into OPCIONES (NUMERODECAMPO,IDIOMA,DESCRIPCION,OPCIONINTERNA,OPCIONDEPANTALLA) values
	 (7842,N''E'',N''Por Usuario'',N''U'',N''U''),
	 (7842,N''E'',N''Por Proceso'',N''P'',N''P'');
insert into ITF_MASTER_PARAMETROS (CODIGO,CODIGO_INTERFACE,FUNCIONALIDAD,ALFA_1,ALFA_2,ALFA_3,NUMERICO_1,NUMERICO_2,FECHA,IMPORTE_1,IMPORTE_2,TZ_LOCK) values
	 (175,131,N''1.3.1 CREDICOM IDPRO'',N''ID PROCESO'',N''CREDICOM'',N'''',0,0,NULL,0.00,0.00,0),
	 (190,131,N''1.3.1 CREDICOM MON P'',N''MONEDA PERMITIDA'',N'''',N'''',1,0,NULL,0.00,0.00,0),
	 (191,131,N''1.3.1 CREDICOM MON P'',N''MONEDA PERMITIDA'',N'''',N'''',2,0,NULL,0.00,0.00,0),
	 (237,131,N''1.3.1 CREDICOM P EXC'',N''PRODUCTO EXCLUIDO'',N'' '',N'' '',9,0,NULL,0.00,0.00,0),
	 (238,131,N''1.3.1 CREDICOM P EXC'',N''PRODUCTO EXCLUIDO'',N'' '',N'' '',10,0,NULL,0.00,0.00,0),
	 (239,131,N''1.3.1 CREDICOM P EXC'',N''PRODUCTO EXCLUIDO'',N'' '',N'' '',12,0,NULL,0.00,0.00,0),
	 (240,131,N''1.3.1 CREDICOM P EXC'',N''PRODUCTO EXCLUIDO'',N'' '',N'' '',17,0,NULL,0.00,0.00,0),
	 (241,131,N''1.3.1 CREDICOM N ARC'',N''NOMBRE ARCHIVO'',N'' '',N'' '',0,0,NULL,0.00,0.00,0),
	 (484,131,N''1.3.1 CREDICOM CTA O'',N''CUENTA ORIGEN'',N'' '',N'' '',905485,0,NULL,0.00,0.00,0),
	 (485,131,N''1.3.1 CREDICOM CTA O'',N''CUENTA ORIGEN'',N'' '',N'' '',905485,0,NULL,0.00,0.00,0),
	 (486,131,N''1.3.1 CREDICOM SAT C'',N''C'',N''ADINTAR'',N''CREDCOMCB'',2,0,NULL,0.00,0.00,0),
	 (487,131,N''1.3.1 CREDICOM SAT D'',N''D'',N''ADINTAR'',N''DEBCOMCB'',2,0,NULL,0.00,0.00,0),
	 (512,131,N''1.3.1 CREDICOM SAT C'',N''C'',N''ADINTAR'',N''CREDCOMMC'',1,0,NULL,0.00,0.00,0),
	 (513,131,N''1.3.1 CREDICOM SAT C'',N''C'',N''ADINTAR'',N''CREDCOMTU'',8,0,NULL,0.00,0.00,0),
	 (514,131,N''1.3.1 CREDICOM SAT C'',N''C'',N''ADINTAR'',N''CREDCOMVI'',3,0,NULL,0.00,0.00,0),
	 (515,131,N''1.3.1 CREDICOM SAT D'',N''D'',N''ADINTAR'',N''DEBCOMTU'',8,0,NULL,0.00,0.00,0),
	 (516,131,N''1.3.1 CREDICOM SAT D'',N''D'',N''ADINTAR'',N''DEBCOMVI'',3,0,NULL,0.00,0.00,0);
insert into dbo.ITF_MASTER (TZ_LOCK,ID,DESCRIPCION,OBJ_KETTLE,P0_MODO,P0_TIPO,P0_CAPTION,P0_CONSTANTE,P1_MODO,P1_TIPO,P1_CAPTION,P1_CONSTANTE,P2_MODO,P2_TIPO,P2_CAPTION,P2_CONSTANTE,P3_MODO,P3_TIPO,P3_CAPTION,P3_CONSTANTE,P4_MODO,P4_TIPO,P4_CAPTION,P4_CONSTANTE,P5_MODO,P5_TIPO,P5_CAPTION,P5_CONSTANTE,P6_MODO,P6_TIPO,P6_CAPTION,P6_CONSTANTE,P7_MODO,P7_TIPO,P7_CAPTION,P7_CONSTANTE,P8_MODO,P8_TIPO,P8_CONSTANTE,P8_CAPTION,P9_MODO,P9_TIPO,P9_CAPTION,P9_CONSTANTE,TIPO_OBJ,COMENTARIO,ID_REPORTE,MODO_EJECUCION,KETTLE_NAME) values
	 (0,109,N''Adintar Credicom'',N''PUNTO_ENTRADA_LOG_PA.kjb'',N'''',N'''',N'''',N'' '',N'''',N'''',N'''',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N''J'',N'' '',0,N''M'',N''ITF_TC_AD_CREDICOM_MAIN_JOB.kjb''),
	 (0,110,N''Adintar Credicom Reporte'',N''PUNTO_ENTRADA_LOG_PA.kjb'',N'''',N'''',N'''',N'' '',N'''',N'''',N'''',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N'' '',N''J'',N'' '',0,N''M'',N''ITF_TC_AD_CREDICOM_REPORTE_MAIN_JOB.kjb'');
insert into ITF_MASTER_CAUSALES (TZ_LOCK,ID_SATELITE,COD_CAUSAL,DESCRIPCION,COD_TRN,ESTADO,TIPO_MOV,ID_EVENTO,CONC_CONTABLE,CONC_CONTABLE_ME,CONC_CONTABLE_2,CONC_CONTABLE_ME_2,SUC1,SUC2,SUC3,SUC4,CANAL) values
	 (0,N''ADINTAR'',N''CREDCOMCB'',N''Crédito a comercio NBCH por ventas Cabal.'',10,1,N''C'',853,402,0,0,0,95,0,0,0,N''ACREDCOM_CRED''),
	 (0,N''ADINTAR'',N''CREDCOMMC'',N''Crédito a comercio NBCH por ventas Mastercard.'',9,1,N''C'',853,400,0,0,0,95,0,0,0,N''ACREDCOM_CRED''),
	 (0,N''ADINTAR'',N''CREDCOMTU'',N''Crédito a comercio NBCH por ventas Tuya.'',7,1,N''C'',853,406,0,0,0,95,0,0,0,N''ACREDCOM_CRED''),
	 (0,N''ADINTAR'',N''CREDCOMVI'',N''Crédito a comercio NBCH por ventas Visa.'',8,1,N''C'',853,404,0,0,0,95,0,0,0,N''ACREDCOM_CRED''),
	 (0,N''ADINTAR'',N''DEBCOMCB'',N''Débito a comercio NBCH por Cabal.'',10,1,N''D'',854,402,0,0,0,95,0,0,0,N''ACREDCOM_DEB''),
	 (0,N''ADINTAR'',N''DEBCOMTU'',N''Débito a comercio NBCH por Tuya.'',7,1,N''D'',854,406,0,0,0,95,0,0,0,N''ACREDCOM_DEB''),
	 (0,N''ADINTAR'',N''DEBCOMVI'',N''Débito a comercio NBCH por Visa.'',8,1,N''D'',854,404,0,0,0,95,0,0,0,N''ACREDCOM_DEB'');
insert into CODIGO_TRANSACCIONES (CODIGO_OPERACION,CODIGO_INTERNO_MOV,CODIGO_TRANSACCION,TZ_LOCK) values
	 (8908,7,130,0),
	 (8908,8,131,0),
	 (8908,9,132,0),
	 (8908,10,133,0);
insert into PACAMPOS (OPERACION,LINEA,CAMPO,VALOR) values
	 (18,4,7919,N''''''Pagos a Comercios''''''),
	 (18,5,7919,N''''''Pagos a Comercios'''''');
insert into PACAMPOSCABEZAL (OPERACION,LINEA,CAMPOPIVOT,CONDICION,DESCRIPCION,TRTIPO) values
	 (18,4,0,N''A(C45788="ACREDCOM_CRED")'',N''Pagos a Comercios'',0),
	 (18,5,0,N''A(C45788="ACREDCOM_DEB")'',N''Pagos a Comercios'',0);
insert into RESTR_TRABA_CONTABLE_PROC (CLAVE_PROCESO,TRABA_CONTABLE,COMENTARIO,TZ_LOCK) values
	 (N''CREDICOM'',2,N''Acreditacion de Comercios'',0);
');