EXECUTE('
IF OBJECT_ID (''dbo.VW_POSICION_CLIENTES'') IS NOT NULL
	DROP VIEW dbo.VW_POSICION_CLIENTES
')

EXECUTE('
CREATE VIEW [dbo].[VW_POSICION_CLIENTES] AS 
SELECT 
	TIPODOC AS ''Tipo'',
	NUMERODOC AS ''Nro Doc'', 
	PAISDOCUMENTO AS ''Pais Doc'', 
	NUMEROPERSONA AS ''Persona'', 
	CLASIFICACION AS ''Clasificacion'',
	SUM (DEUDA_EXIGIBLE) AS ''Deuda Exigible'',
	SUM(DEUDA_NO_EXIGIBLE) AS ''Deuda no Exigible'',
	SUM(DEUDA_TOTAL) ''Deuda Total'',
	SUM(DEUDA_CONTINGENTE) ''Deuda Contingente'',
	CASE WHEN SUM(DEUDA_TOTAL) < SUM(DEUDA_CONTINGENTE) THEN SUM(DEUDA_CONTINGENTE) 
		 ELSE SUM(DEUDA_TOTAL) END AS ''Riesgo Total''
	 
FROM ( 
SELECT CASE WHEN CLASIFICACION=''L'' THEN ''Leasing''
	 WHEN CLASIFICACION IN (''S'',''A'',''O'') THEN ''CC''
	 WHEN CLASIFICACION=''D'' THEN ''Descuento Bancario''
	 WHEN CLASIFICACION=''T'' THEN ''Tarjeta de Crédito''
	 WHEN CLASIFICACION=''GO'' THEN ''Garantías Otorgadas''
	 WHEN CLASIFICACION=''SGR'' THEN ''Sociedades de Garantía Recíproca''
	 ELSE ''Prestamos'' END AS CLASIFICACION,
	 CASE WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))> 0 THEN sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))
	 	  WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))< 0 THEN 0
	 	  WHEN CLASIFICACION=''SGR'' THEN 0
	     -- WHEN CLASIFICACION=''GO''  THEN 0
	      WHEN CLASIFICACION=''D''  THEN 0
	 	  ELSE sum(SALDO_DEUDA) END AS DEUDA_EXIGIBLE,
	 	  
	 CASE WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))> 0 THEN sum(s.AJUSTEINFLACION) -  (sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION)))
	      WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))< 0 THEN sum(SALDO_DEUDA)
	      WHEN CLASIFICACION=''SGR'' THEN 0
	      WHEN CLASIFICACION=''D'' THEN SUM(SALDO_DEUDA)
	      WHEN CLASIFICACION IN (''S'',''A'',''O'')  THEN  sum(SALDO) --  Para CC considera acuerdos vigentes, es el disponible
	 	  ELSE SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0)) 
	 END  AS DEUDA_NO_EXIGIBLE,
	 	 CASE WHEN CLASIFICACION=''D'' THEN SUM(SALDO_DEUDA)
	 	 	  WHEN CLASIFICACION IN (''S'',''A'',''O'') THEN  sum(SALDO)+sum(SALDO_DEUDA)
	 	      ELSE (sum(SALDO_DEUDA)+ SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0))) 
	 END AS DEUDA_TOTAL,
	 CASE WHEN prod.MONTO IS NOT NULL THEN max(prod.MONTO)+ isnull(sum(bl.OPCION_COMPRA),0) -- Monto Calificacion
	 	  WHEN CLASIFICACION=''L''  THEN sum(SALDO_DEUDA)+sum(bl.OPCION_COMPRA)
	 	  WHEN CLASIFICACION IN (''S'',''A'',''O'') THEN sum(vw.MONTOORIGEN) -- Monto Acuerdos
	      WHEN CLASIFICACION=''T'' THEN sum(s.C1806) -- Limite Cuotas
	      WHEN CLASIFICACION=''SGR'' THEN sum(SALDO_DEUDA)
	      WHEN CLASIFICACION=''GO''  THEN sum(SALDO_DEUDA)
	      ELSE 0 -- Si no tiene nada de lo anterior es 0 
	 END AS DEUDA_CONTINGENTE,
	  vw.TIPODOC,vw.NUMERODOC, vw.PAISDOCUMENTO, vw.NUMEROPERSONA
FROM VW_DEUDA_CLIENTES_POSICION vw
INNER JOIN SALDOS S WITH (nolock) ON S.JTS_OID=vw.JTS_OID
LEFT JOIN VW_ASISTENCIAS_D_NO_EXIGIBLE_POSICION A ON A.SALDO_JTS_OID=vw.JTS_OID
LEFT JOIN CRE_LIMITECLIENTE l WITH (nolock) ON l.CLIENTE=vw.CLIENTE AND l.ESTADO=''A'' AND l.TZ_LOCK=0
LEFT JOIN CRE_PRODUCTOLIC prod WITH (nolock) ON prod.IDLIMITE=l.IDLIMITE AND prod.PRODUCTO=vw.PRODUCTO AND prod.TZ_LOCK=0
LEFT JOIN CRE_BIENES_LEASING bl ON bl.SALDOS_JTS_OID=s.JTS_OID and bl.TZ_LOCK=0
WHERE (CASE WHEN CLASIFICACION IN (''S'',''A'',''O'') THEN (vw.SALDO+vw.SALDO_DEUDA+vw.MONTOORIGEN) ELSE vw.SALDO END) >0 --AND vw.NUMEROPERSONA=25067
GROUP BY vw.TIPODOC,vw.NUMERODOC, vw.PAISDOCUMENTO, vw.NUMEROPERSONA, CLASIFICACION, prod.PRODUCTO, prod.MONTO
) T
GROUP BY TIPODOC,NUMERODOC, PAISDOCUMENTO, NUMEROPERSONA,CLASIFICACION
')