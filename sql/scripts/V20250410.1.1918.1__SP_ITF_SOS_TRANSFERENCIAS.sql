EXECUTE('
CREATE OR ALTER PROCEDURE [dbo].[SP_ITF_SOS_TRANSFERENCIAS]
    @FechaIni VARCHAR(8),
	@FechaFin VARCHAR(8)
AS
  DECLARE @PERIODO VARCHAR(6);
  DECLARE @FECHAPROCESO VARCHAR(8);
   
BEGIN

  SELECT @FECHAPROCESO = CONVERT(VARCHAR, FECHAPROCESO, 112) FROM PARAMETROS
  
  SET @PERIODO = SUBSTRING(CONVERT(VARCHAR, @FechaIni, 112),1,6);
  
	--Limpiamos por si hay reproceso
	DELETE FROM SOS_TRANSFERENCIAS
	WHERE PERIODO = @PERIODO;

	INSERT INTO SOS_TRANSFERENCIAS(EMPRESA, PERIODO, FECHADEINFORMACION, NUMERODECUENTA, NUMERODEOPERACION, CLASEDECUENTA, TIPODECUENTAUOPERACION,
		SUCURSALSISCEN, SUCURSALINTERNA, FECHADELAOPERACION, MONTOPESOS, ESPECIETRANSADACANTIDAD,
		ESPECIETRANSADATIPO, BANCOCORRESPONSALSWIFT, BENEFICIARIOORDENANTEDELEXTE, PAISDELBENEFICIARIOORDENANTE, DATOSADICIONALES,
		FECHAALTA, CODIGOSTOPAZ, COTIZACION, REVERSADA, OPER_ID_BIC_SWIFT, RTE_OPE_FON_CUIT_CUIL_CDI,
		RTE_OPE_FON_TIPO_PERSONA, RTE_OPE_FON_DENOMINACION, RTE_OPE_FON_APELLIDOS, RTE_OPE_FON_NOMBRES, RTE_OPE_FON_TIPODOC,
		RTE_OPE_FON_NUMDOC, RTE_TIT_FON_CUIT_CUIL_CDI, RTE_TIT_FON_TIPO_PERSONA, RTE_TIT_FON_DENOMINACION, RTE_TIT_FON_APELLIDOS,
		RTE_TIT_FON_NOMBRES, RTE_TIT_FON_TIPODOC, RTE_TIT_FON_NUMDOC, RTI_TIPOPERSONA, RTI_TIPOOPERACION_COMEX, 
		FECHAAPERTURACUENTA, CODCLIENTE, SUCURSALSISCENCTA,
		REL_FON_TIT, REL_PRO_TIT, REL_FON_OPER, REL_PRO_OPER, SALDO_JTS_OID)
	SELECT
	--1
	311 AS EMPRESA, 
	
	@PERIODO AS PERIODO,
	--2
	--CONVERT(VARCHAR,mov.fechaproceso,112) AS FECHADEINFORMACION,
	--CONVERT(VARCHAR,(SELECT fechaproceso FROM parametros),112) AS FECHADEINFORMACION,
	@FECHAPROCESO AS FECHADEINFORMACION, --1.1
	--3
	/*(CASE WHEN sos.Subsistema IN (''PR'')
	  		THEN CONCAT(RIGHT(''0''+CONVERT(VARCHAR,sa.SUCURSAL),2), sos.Subsistema, CONVERT(VARCHAR, sa.OPERACION),CONVERT(VARCHAR,sa.ORDINAL))
	  	  WHEN sos.Subsistema IN (''PF'')
	  		THEN CONCAT(RIGHT(''0''+CONVERT(VARCHAR,sa.SUCURSAL),2), sos.Subsistema, CONVERT(VARCHAR,mov.OPERACION_CUENTA))
	      ELSE*/ CONCAT(RIGHT(''0''+CONVERT(VARCHAR,sa.SUCURSAL),2), sos.Subsistema, CONVERT(VARCHAR,mov.CUENTA)) /*END)*/ AS NUMERODECUENTA,
	--4
	LEFT(concat(mov.ASIENTO, CONVERT(VARCHAR,mov.FECHAPROCESO,112), mov.SUCURSAL, mov.ORDINAL),22) AS NUMERODEOPERACION,
	--5
	LEFT(sos.Subsistema,3) AS CLASEDECUENTA,
	--6
	--SOS.TipOperacion  AS TIPODECUENTAUOPERACION,
	(CASE WHEN SOS.TIPOPERACION = 101
		         AND ISNULL(VT.BEN_MISMO_TITULAR, ISNULL((CASE WHEN JSON_VALUE(infoExtendidaMeta,''$.mismotitular'') = ''C'' THEN ''S''
		         												ELSE JSON_VALUE(infoExtendidaMeta,''$.mismotitular'') END),''NO'')) = ''S'' THEN 501
          WHEN SOS.TIPOPERACION = 103
		         AND ISNULL(VT.BEN_MISMO_TITULAR, ISNULL((CASE WHEN JSON_VALUE(infoExtendidaMeta,''$.mismotitular'') = ''C'' THEN ''S''
		         												ELSE JSON_VALUE(infoExtendidaMeta,''$.mismotitular'') END),''NO'')) = ''S'' THEN 503
		      ELSE SOS.TIPOPERACION END) AS TIPODECUENTAUOPERACION,
	--7
	CONVERT(VARCHAR,suc.SucursalBCRA) AS SUCURSALSISCEN,
	--8
	CONVERT(VARCHAR,mov.SUCURSAL) AS SUCURSALINTERNA,
	--9
	CONVERT(VARCHAR,mov.FECHAPROCESO,112) AS FECHADELAOPERACION,
	--10
	(CASE WHEN mov.MONEDA = 1 THEN
	 		 mov.CAPITALREALIZADO  
		  ELSE 0 END) AS MONTOPESOS, 
	--11
	(CASE WHEN mov.MONEDA <> 1 THEN 
	   mov.CAPITALREALIZADO
	   ELSE 0 END) AS ESPECIETRANSADACANTIDAD, 
	--12
	LEFT((SELECT m.C6402 FROM MONEDAS m WITH (NOLOCK) 
	      WHERE m.C6399 = (CASE WHEN mov.MONEDA IN (988,999) THEN 1 ELSE mov.MONEDA END)
		    AND m.TZ_LOCK = 0),10) AS ESPECIETRANSADATIPO,
	--13
	'''' AS BANCOCORRESPONSALSWIFT,
	--14
	'''' AS BENEFICIARIOORDENANTEDELEXTE,
	--15
	'''' AS PAISDELBENEFICIARIOORDENANTE,
	--16
	ISNULL(vt.BEN_MISMO_TITULAR, ISNULL((CASE WHEN JSON_VALUE(infoExtendidaMeta,''$.mismotitular'') = ''C'' THEN ''S''
		         												ELSE JSON_VALUE(infoExtendidaMeta,''$.mismotitular'') END),''NO'')
	                   /*(CASE WHEN (SELECT COUNT(DISTINCT CLIENTE) 
	         				  FROM MOVIMIENTOS_CONTABLES mc WITH (NOLOCK) 
	                          WHERE mc.ASIENTO = mov.ASIENTO 
	                            AND mc.SUCURSAL = mov.SUCURSAL 
	                            AND mc.FECHAPROCESO = mov.FECHAPROCESO
	                            --AND mc.CLIENTE <> mov.cliente
	                            AND mc.CLIENTE <> 0) > 1 THEN ''N''
	                            WHEN (SELECT COUNT(DISTINCT CLIENTE) 
	         				  FROM MOVIMIENTOS_CONTABLES mc WITH (NOLOCK) 
	                          WHERE mc.ASIENTO = mov.ASIENTO 
	                            AND mc.SUCURSAL = mov.SUCURSAL 
	                            AND mc.FECHAPROCESO = mov.FECHAPROCESO
	                            --AND mc.CLIENTE <> mov.cliente
	                            AND mc.CLIENTE <> 0) = 1 THEN ''S''
	                    ELSE ''NO'' END)*/) AS DATOSADICIONALES,
	--17
	CONVERT(VARCHAR, mov.FECHAVALOR,112) AS FECHAALTA,
	--18
	concat(right(concat(Replicate(''0'',4),sos.Operacion),4), sos.Subsistema, RIGHT(concat(Replicate(''0'',7), sos.CodTransaccion),7)) AS CODIGOSTOPAZ,
	--19
	ISNULL((CASE WHEN mov.MONEDA = 1 THEN 0 ELSE 
	  (CASE WHEN sos.SubSistema IN (''AC'',''CC'') THEN 
	        	(SELECT TipC.TIPO_CAMBIO_OFICIAL 
	        	 FROM HISTORICOTIPOSCAMBIO TipC WITH (NOLOCK) 
	        	 WHERE TipC.FECHA_COTIZACION = mov.FECHAPROCESO 
	        	   AND Tipc.MONEDA = sa.MONEDA 
	        	   AND Tipc.TZ_LOCK = 0)																			 
	   ELSE 0 END) END),0) AS COTIZACION,
	--20
	/* 1.1 Ini
	ISNULL((SELECT (CASE WHEN asi.ESTADO = 42 THEN ''SI'' ELSE ''NO'' END) FROM ASIENTOS asi 
	 WHERE asi.FECHAPROCESO = mov.FECHAPROCESO AND asi.ASIENTO = mov.ASIENTO AND asi.SUCURSAL = mov.SUCURSAL),''NO'') AS REVERSADA,
	1.1 Fin */
	ISNULL((CASE WHEN asi.ESTADO = 42 THEN ''SI'' ELSE ''NO'' END),''NO'') AS REVERSADA, --1.1
	--21
	'''' AS OPER_ID_BIC_SWIFT,
	--22
	LEFT((CASE WHEN sos.TipOperacion IN (101,103) THEN
	     isnull(CONVERT(VARCHAR,vt.BEN_NRO_DOC), JSON_VALUE(infoExtendidaMeta,''$.destino.cuit'')
	     /*(SELECT clix.NUMERODOC FROM MOVIMIENTOS_CONTABLES movx WITH (NOLOCK)
	      INNER JOIN SALDOS sax ON sax.JTS_OID = movx.SALDO_JTS_OID
	      INNER JOIN VW_CLI_X_DOC clix WITH (NOLOCK) ON clix.CODIGOCLIENTE = movx.CLIENTE_ORIGEN
		WHERE movx.FECHAPROCESO = mov.FECHAPROCESO
		  AND movx.ASIENTO = mov.ASIENTO
		  AND movx.SUCURSAL = mov.SUCURSAL
		  AND movx.ORDINAL = 0
		  AND movx.COD_TRANSACCION <> mov.COD_TRANSACCION)*/)
		ELSE '''' END),11) AS RTE_OPE_FON_CUIT_CUIL_CDI,
	--23
	'''' AS RTE_OPE_FON_TIPO_PERSONA,
	--24
	'''' AS RTE_OPE_FON_DENOMINACION,
	--25
	''''  AS RTE_OPE_FON_APELLIDOS,
	--26
	'''' AS RTE_OPE_FON_NOMBRES,
	--27
	'''' AS RTE_OPE_FON_TIPODOC,
	--28
	''''  AS RTE_OPE_FON_NUMDOC,
	--29
	'''' AS RTE_TIT_FON_CUIT_CUIL_CDI,
	--30
	'''' AS RTE_TIT_FON_TIPO_PERSONA,
	--31
	'''' AS RTE_TIT_FON_DENOMINACION,
	--32
	'''' AS RTE_TIT_FON_APELLIDOS,
	--33
	'''' AS RTE_TIT_FON_NOMBRES,
	--34
	'''' AS RTE_TIT_FON_TIPODOC,
	--35
	'''' AS RTE_TIT_FON_NUMDOC,
	--36
	'''' AS RTI_TIPOPERSONA,
	--37
	'''' AS RTI_TIPOOPERACION_COMEX,
	--FECHAAPERTURACUENTA
	(CASE WHEN sos.Subsistema = ''ME'' THEN CONVERT(NUMERIC,CONVERT(VARCHAR, mov.FECHAVALOR  ,112))  
		  ELSE
		   CONVERT(NUMERIC,CONVERT(VARCHAR,sa.c1620 ,112)) END) AS FECHAAPERTURACUENTA,
	--CLIENTE
	sa.C1803 AS CODCLIENTE,
	suc.SucursalBCRA AS SUCURSALSISCENCTA,
	--38
	'''' AS REL_FON_TIT,
	--39
	'''' AS REL_PRO_TIT,
	--40
	'''' AS REL_FON_OPER,
	--41
	'''' AS REL_PRO_OPER,
	--
	sa.JTS_OID
	--SELECT mov.*
	FROM MOVIMIENTOS_CONTABLES mov WITH (NOLOCK)
	  INNER JOIN ASIENTOS ASI WITH (NOLOCK) ON ASI.ASIENTO = MOV.ASIENTO AND ASI.SUCURSAL = MOV.SUCURSAL AND ASI.FECHAPROCESO = MOV.FECHAPROCESO --1
	  INNER JOIN SOS_TRANSACCIONES sos WITH (NOLOCK) ON sos.Subsistema IN (''AC'',''CC'')
	    AND sos.Operacion = mov.OPERACION
	    AND sos.CodTransaccion = mov.COD_TRANSACCION
	    AND sos.TipOperacion IN (101,103)
	    --1 Ini
	    AND ((SOS.PAGOSAINFORMAR = ''T'') OR
		         (SOS.PAGOSAINFORMAR = ''E'' AND ((MOV.CAJADIARIO = ''D'' AND ASI.EXTORNO = 1) OR (MOV.CAJADIARIO = ''C''))) OR
		         (SOS.PAGOSAINFORMAR = ''D'' AND MOV.CAJADIARIO <> ''C''))
		AND ((ASI.EXTORNO = 0 AND (SOS.TIPO_MOVIMIENTO = MOV.DEBITOCREDITO
		         OR SOS.TIPO_MOVIMIENTO = ''A''))
		         OR ASI.EXTORNO = 1)
		--1 Fin
	    AND sos.TZ_LOCK = 0
	  INNER JOIN SOS_SUCURSALES suc WITH (NOLOCK) ON suc.Sucursal = mov.SUCURSAL
	  INNER JOIN SALDOS sa WITH (NOLOCK) ON sa.JTS_OID = mov.SALDO_JTS_OID
		  AND (CASE WHEN sa.C1785 = ''3'' THEN ''AC''
					WHEN sa.C1785 = ''2'' THEN ''CC''
					WHEN sa.C1785 = ''4'' THEN ''PF'' END) =  sos.Subsistema
	  LEFT JOIN VTA_TRANSFERENCIAS vt WITH (NOLOCK) ON vt.NUMERO_ASIENTO = mov.ASIENTO AND vt.FECHA_ASIENTO = mov.FECHAPROCESO AND  vt.SUCURSAL_ASIENTO = mov.SUCURSAL
	  LEFT JOIN HISTORICO_MOVIMIENTOS HM WITH (NOLOCK) ON HM.fechaAsiento = MOV.FECHAPROCESO AND HM.movJtsOid = MOV.JTS_OID AND HM.ASIENTO = MOV.ASIENTO AND HM.sucursalAlta = mov.SUCURSAL
	WHERE mov.FECHAPROCESO BETWEEN @FechaIni AND @FechaFin
	  AND mov.CLIENTE <> 0
	  AND suc.TZ_LOCK = 0
	  AND sa.TZ_LOCK = 0
	  --AND mov.NROCAJA <> 0 --1.1
	  AND sa.PRODUCTO <> 0
	  AND ASI.ESTADO = 77 --1.1
	  AND NOT EXISTS(SELECT 1 FROM ITF_MASTER_PARAMETROS x WITH (NOLOCK) 
	  				 WHERE x.FUNCIONALIDAD = ''PRODUCTO JUDICIAL'' 
	  				   AND x.ALFA_1 = sa.PRODUCTO
	  				   AND x.TZ_LOCK = 0)
	  --1 Ini
	  AND NOT EXISTS(SELECT 1 FROM ASIENTOS_EXTORNADOS ASI WITH (NOLOCK)
	  				 WHERE ASI.SUCURSAL = MOV.SUCURSAL 
	  				    AND ASI.FECHA_PROCESO = MOV.FECHAPROCESO
	                 	AND ASI.ASIENTO = MOV.ASIENTO
	                 	AND ASI.FECHA_PROCESO = ASI.FECHA_EXTORNO)
	  AND NOT EXISTS(SELECT 1 FROM CAJ_SOLICITUD_BAJA_ASIENTO BAJ WITH (NOLOCK)
	  				 WHERE BAJ.ASIENTO = MOV.ASIENTO
	  				   AND BAJ.SUCURSAL = MOV.SUCURSAL
	  				   AND BAJ.FECHAPROCESO = MOV.FECHAPROCESO
	  				   AND BAJ.ESTADO = ''C'')
	  --1 Fin
	  AND NOT EXISTS(SELECT 1 FROM CLI_CLIENTES cli WITH(NOLOCK)
	   					INNER JOIN CLI_ClientePersona p WITH(NOLOCK) ON p.CODIGOCLIENTE = cli.CODIGOCLIENTE
	  					INNER JOIN CLI_PERSONASFISICAS nat WITH(NOLOCK) ON p.NUMEROPERSONA = nat.NUMEROPERSONAFISICA
	  				 WHERE cli.CODIGOCLIENTE = sa.C1803
	  				   AND nat.SECTOR IN (6,7)
	  				   AND nat.TZ_LOCK = 0
	  				   AND p.TZ_LOCK = 0
	  				   AND cli.TZ_LOCK = 0)
	  AND NOT EXISTS(SELECT 1 FROM CLI_CLIENTES cli WITH(NOLOCK)
	   					INNER JOIN CLI_ClientePersona p WITH(NOLOCK) ON p.CODIGOCLIENTE = cli.CODIGOCLIENTE
	  					INNER JOIN CLI_PERSONASJURIDICAS jur WITH(NOLOCK) ON p.NUMEROPERSONA = jur.NUMEROPERSONAJURIDICA
	  				 WHERE cli.CODIGOCLIENTE = sa.C1803
	  				   AND jur.SECTOR IN (6,7)
	  				   AND jur.TZ_LOCK = 0
	  				   AND p.TZ_LOCK = 0
	  				   AND cli.TZ_LOCK = 0)
  
END
')