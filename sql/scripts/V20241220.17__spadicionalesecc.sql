EXECUTE('
CREATE PROCEDURE SP_GRL_ECC_AUX
	@SALDO_JTS_OID NUMERIC(10),
	@PERIODO VARCHAR(2)
AS 
BEGIN
	
	--- FECHA DE CANCELACION
	UPDATE CAB
	SET FECHA_CANCELACION = CAN.FECHA_CANCELACION
	FROM GRL_CAB_ENVIO_ESTCTA CAB
	INNER JOIN CV_CANCELACION_CUENTAS CAN ON CAB.JTSOID = CAN.SALDO_JTS_OID 
	AND CAN.TZ_LOCK = 0 AND CAN.ESTADO = ''F''
	WHERE CAB.PERIODO = @PERIODO AND CAB.JTSOID = @SALDO_JTS_OID
	
	--- PRODUCTO - MONEDA
	
	UPDATE CAB
	SET COD_PRODUCTO = S.PRODUCTO,
	COD_MONEDA = S.MONEDA
	FROM GRL_CAB_ENVIO_ESTCTA CAB
	INNER JOIN SALDOS S ON S.JTS_OID = CAB.JTSOID
	WHERE CAB.PERIODO = @PERIODO AND CAB.JTSOID = @SALDO_JTS_OID
	
	--- Saldo final - SIRCREB - IIBB_CORRIENTES
	
	UPDATE CAB
	SET SALDO_FINAL = DET.SALDOCALCLINEA,
	SIRCREB = DET.SIRCREB,
	IIBB_CORRIENTES = DET.IIBB_CORRIENTES
	FROM GRL_CAB_ENVIO_ESTCTA CAB
	INNER JOIN GRL_DET_ENVIO_ESTCTA DET ON DET.IDCAB = CAB.IDCAB AND DET.JTSOID = CAB.JTSOID AND DET.TIPOMOV = ''F''
	WHERE CAB.PERIODO = @PERIODO AND CAB.JTSOID = @SALDO_JTS_OID
	
	--- Tipo cambio
	
	UPDATE CAB
	SET TIPO_CAMBIO_OFICIAL = H.TIPO_CAMBIO_OFICIAL
	FROM GRL_CAB_ENVIO_ESTCTA CAB
	INNER JOIN HISTORICOTIPOSCAMBIO AS H ON H.TZ_LOCK = 0 AND H.MONEDA = CAB.COD_MONEDA
	AND H.FECHA_COTIZACION = (SELECT TOP 1 FECHA_COTIZACION FROM HISTORICOTIPOSCAMBIO WITH(NOLOCK) 
	WHERE FECHA_COTIZACION <= (SELECT FECHAPROCESO FROM PARAMETROS WITH (nolock)) AND TZ_LOCK = 0
	AND MONEDA = CAB.COD_MONEDA
	ORDER BY FECHA_COTIZACION DESC)
	WHERE CAB.PERIODO = @PERIODO AND CAB.JTSOID = @SALDO_JTS_OID

END
')