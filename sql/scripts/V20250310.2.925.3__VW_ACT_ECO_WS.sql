EXECUTE('
IF OBJECT_ID (''dbo.VW_ACT_ECO_WS'') IS NOT NULL
    DROP VIEW dbo.VW_ACT_ECO_WS;
')
EXECUTE('
CREATE VIEW dbo.VW_ACT_ECO_WS
AS
WITH CTE_ITF AS (
    SELECT 
        i.COD_ACTIVIDAD,
        a.DESCRIPCION,
        (RIGHT(i.PERIODO, 2) + LEFT(i.PERIODO, 4)) AS PERIODO_ACTIVIDAD,
        (CASE i.ORDEN WHEN 1 THEN ''Primaria'' ELSE ''Secundaria'' END) AS TIPO_ACTIVIDAD,
        ''S'' AS VERIFICADO_AFIP,
        (SELECT FECHAPROCESO FROM dbo.PARAMETROS) AS FECHA_VERIFICADO,
        d.NUMEROPERSONAFJ AS CODIGO_PERSONA,
        d.TIPODOCUMENTO,
        i.CUIL AS NUMERO_DOCUMENTO,
        COALESCE(e.ORDINAL_ACTIVIDAD, 99) AS ORDINAL,
        ''2_AFIP'' AS REGISTRO_POR,
        i.ORDEN AS ORDEN_AFIP,
		'' '' AS ESTADO_REGISTRO 
    FROM dbo.ITF_AFIP_ACT_ECONOMICA i WITH (NOLOCK)
    LEFT JOIN dbo.CLI_DocumentosPFPJ d WITH (NOLOCK) ON i.CUIL = d.NUMERODOCUMENTO
    INNER JOIN dbo.CLI_Cod_Act_AFIP a WITH (NOLOCK) ON i.COD_ACTIVIDAD = a.CODIGO_ACT_AFIP 
    LEFT JOIN dbo.CLI_ACTIVIDAD_ECONOMICA e WITH (NOLOCK) ON d.NUMEROPERSONAFJ = e.CODIGO_PERSONA_CLIENTE
        AND e.CODIGO_ACTIVIDAD = i.COD_ACTIVIDAD 
        AND e.ORDEN_AFIP = i.ORDEN 
    WHERE (i.TZ_LOCK < 300000000000000 OR i.TZ_LOCK >= 400000000000000)
        AND (d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000)
),

CTE_CLI AS (
    SELECT
        c.CODIGO_ACTIVIDAD,
        a.DESCRIPCION,
        c.INICIO_ACTIVIDAD AS PERIODO_ACTIVIDAD,
        (CASE 
            WHEN c.ORDEN_AFIP = 1 THEN ''Primaria''
            ELSE ''Secundaria''
        END) AS TIPO_ACTIVIDAD,
        c.VERIFICADO_AFIP,
        c.FECHA_VERIFICADO,
        c.CODIGO_PERSONA_CLIENTE AS CODIGO_PERSONA,
        d.TIPODOCUMENTO,
        d.NUMERODOCUMENTO,
        c.ORDINAL_ACTIVIDAD AS ORDINAL,
        ''1_TOPAZ'' AS REGISTRO_POR,
        c.ORDEN_AFIP,
		'' '' AS ESTADO_REGISTRO 
    FROM dbo.CLI_ACTIVIDAD_ECONOMICA c WITH (NOLOCK)
    INNER JOIN dbo.CLI_Cod_Act_AFIP a WITH (NOLOCK) ON c.CODIGO_ACTIVIDAD = a.CODIGO_ACT_AFIP 
    LEFT JOIN dbo.CLI_DocumentosPFPJ d WITH (NOLOCK) ON d.NUMEROPERSONAFJ = c.CODIGO_PERSONA_CLIENTE
    WHERE (c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000)
        AND (d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000)
),

CTE_TEMP AS (
    SELECT
        c.CODIGO_ACTIVIDAD,
        a.DESCRIPCION,
        c.INICIO_ACTIVIDAD AS PERIODO_ACTIVIDAD,
        (CASE 
            WHEN c.ORDEN_AFIP = 1 THEN ''Primaria''
            ELSE ''Secundaria''
        END) AS TIPO_ACTIVIDAD,
        c.VERIFICADO_AFIP,
        c.FECHA_VERIFICADO,
        c.CODIGO_PERSONA_CLIENTE AS CODIGO_PERSONA,
        d.TIPODOCUMENTO,
        c.CUIL AS NUMERO_DOCUMENTO,
        c.ORDINAL_ACTIVIDAD AS ORDINAL,
        ''3_TEMP'' AS REGISTRO_POR,
        c.ORDEN_AFIP,
        c.ESTADO_REGISTRO 
    FROM dbo.TEMP_CLI_ACTIVIDAD_ECONOMICA c WITH (NOLOCK)
    INNER JOIN dbo.CLI_Cod_Act_AFIP a WITH (NOLOCK) ON c.CODIGO_ACTIVIDAD = a.CODIGO_ACT_AFIP  
    LEFT JOIN dbo.CLI_DocumentosPFPJ d WITH (NOLOCK) ON d.NUMEROPERSONAFJ = c.CODIGO_PERSONA_CLIENTE
    WHERE (c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000)
)

SELECT 
    X.ORDEN_AFIP,
    X.ORDINAL,
    X.COD_ACTIVIDAD,
    X.DESCRIPCION,
    X.PERIODO_ACTIVIDAD,
    X.TIPO_ACTIVIDAD,
    X.VERIFICADO_AFIP,
    X.FECHA_VERIFICADO,
    X.CODIGO_PERSONA,
    X.TIPODOCUMENTO,
    X.NUMERO_DOCUMENTO,
    J.REGISTRO_POR,
    X.ESTADO_REGISTRO
FROM (
    SELECT 
        COD_ACTIVIDAD, 
        DESCRIPCION, 
        PERIODO_ACTIVIDAD, 
        TIPO_ACTIVIDAD, 
        VERIFICADO_AFIP, 
        FECHA_VERIFICADO, 
        CODIGO_PERSONA, 
        TIPODOCUMENTO, 
        NUMERO_DOCUMENTO, 
        ORDINAL, 
        REGISTRO_POR, 
        ORDEN_AFIP,
        '' ''  AS ESTADO_REGISTRO
    FROM CTE_ITF

    UNION ALL

    SELECT 
        CODIGO_ACTIVIDAD, 
        DESCRIPCION, 
        PERIODO_ACTIVIDAD, 
        TIPO_ACTIVIDAD, 
        VERIFICADO_AFIP, 
        FECHA_VERIFICADO, 
        CODIGO_PERSONA, 
        TIPODOCUMENTO, 
        NUMERODOCUMENTO AS NUMERO_DOCUMENTO, 
        ORDINAL, 
        REGISTRO_POR, 
        ORDEN_AFIP,
        '' ''  AS ESTADO_REGISTRO 
    FROM CTE_CLI

    UNION ALL

    SELECT 
        CODIGO_ACTIVIDAD, 
        DESCRIPCION, 
        PERIODO_ACTIVIDAD, 
        TIPO_ACTIVIDAD, 
        VERIFICADO_AFIP, 
        FECHA_VERIFICADO, 
        CODIGO_PERSONA, 
        TIPODOCUMENTO, 
        NUMERO_DOCUMENTO,
        ORDINAL, 
        REGISTRO_POR, 
        ORDEN_AFIP,
        ESTADO_REGISTRO 
    FROM CTE_TEMP
) X
INNER JOIN (
    SELECT 
        COD_ACTIVIDAD,
        NUMERO_DOCUMENTO,
        MAX(REGISTRO_POR) AS REGISTRO_POR
    FROM (
        SELECT 
            i.COD_ACTIVIDAD,
            i.CUIL AS NUMERO_DOCUMENTO,
            ''2_AFIP'' AS REGISTRO_POR
        FROM dbo.ITF_AFIP_ACT_ECONOMICA i WITH (NOLOCK)
        LEFT JOIN dbo.CLI_DocumentosPFPJ d WITH (NOLOCK) ON i.CUIL = d.NUMERODOCUMENTO 
        INNER JOIN dbo.CLI_Cod_Act_AFIP a WITH (NOLOCK) ON i.COD_ACTIVIDAD = a.CODIGO_ACT_AFIP 
        WHERE (i.TZ_LOCK < 300000000000000 OR i.TZ_LOCK >= 400000000000000)
            AND (d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000)

        UNION ALL

        SELECT 
            c.CODIGO_ACTIVIDAD,
            d.NUMERODOCUMENTO,
            ''1_TOPAZ'' AS REGISTRO_POR
        FROM dbo.CLI_ACTIVIDAD_ECONOMICA c WITH (NOLOCK)
        INNER JOIN dbo.CLI_Cod_Act_AFIP a WITH (NOLOCK) ON c.CODIGO_ACTIVIDAD = a.CODIGO_ACT_AFIP
        LEFT JOIN dbo.CLI_DocumentosPFPJ d WITH (NOLOCK) ON d.NUMEROPERSONAFJ = c.CODIGO_PERSONA_CLIENTE
        WHERE (c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000)
            AND (d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000)

        UNION ALL

        SELECT 
            c.CODIGO_ACTIVIDAD,
            c.CUIL AS NUMERO_DOCUMENTO,
            ''3_TEMP'' AS REGISTRO_POR
        FROM dbo.TEMP_CLI_ACTIVIDAD_ECONOMICA c WITH (NOLOCK)
        INNER JOIN dbo.CLI_Cod_Act_AFIP a WITH (NOLOCK) ON c.CODIGO_ACTIVIDAD = a.CODIGO_ACT_AFIP  
        LEFT JOIN dbo.CLI_DocumentosPFPJ d WITH (NOLOCK) ON d.NUMEROPERSONAFJ = c.CODIGO_PERSONA_CLIENTE
        WHERE (c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000)
    ) Y
    GROUP BY COD_ACTIVIDAD, NUMERO_DOCUMENTO
) J ON J.NUMERO_DOCUMENTO = X.NUMERO_DOCUMENTO AND J.COD_ACTIVIDAD = X.COD_ACTIVIDAD AND J.REGISTRO_POR = X.REGISTRO_POR
WHERE X.ORDINAL <> 0 AND x.ESTADO_REGISTRO <> ''B''  

ORDER BY  ORDEN_AFIP, ORDINAL OFFSET 0 ROWS
')
