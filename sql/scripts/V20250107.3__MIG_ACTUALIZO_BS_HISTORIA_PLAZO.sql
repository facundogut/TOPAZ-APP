EXECUTE('
CREATE OR ALTER                                                      PROCEDURE [dbo].[MIG_ACTUALIZO_BS_HISTORIA_PLAZO]

@P_ID_PROCESO INT,
@P_DT_PROCESO DATE,

@P_RET_PROCESO INT OUTPUT,
@P_MSG_PROCESO VARCHAR(500) OUTPUT


AS
BEGIN 

DECLARE @v_FECHASYS 	 DATETIME
DECLARE @v_CICLO         SMALLINT 
DECLARE @v_PROCESO       SMALLINT
DECLARE @p_modulo	     VARCHAR(30)
DECLARE @p_NomScr	     VARCHAR(30)
DECLARE @v_mensaje_ERR	 VARCHAR(2000)
DECLARE @v_CANT_FINAL	 BIGINT

SET @v_FECHASYS = SYSDATETIME()
SET @v_ciclo    = 1
SET @v_proceso  = 1
SET @p_modulo	= ''PRESTAMOS''
SET @p_NomScr	= ''AJU_BS_HP''
SET @v_CANT_FINAL = 1

-- LIMPIO LA TABLA --
DELETE FROM MIG_ERRORES WHERE TABLA = ''AJU_BS_HP''

-- ACTUALIZO CAMPO NUMEROMOV DE BS_HISTORIA_PLAZO CON C1627 DE SALDOS POSTERIOR AL RECALCULO -- 

	UPDATE BS_HISTORIA_PLAZO 
	SET NUMEROMOV = CONVERT(NUMERIC(8, 0), CONVERT(VARCHAR(8), S.C1627, 112))
	FROM BS_HISTORIA_PLAZO 
	INNER JOIN SALDOS S(NOLOCK)
	ON SALDOS_JTS_OID = S.JTS_OID
	WHERE S.C1785 = 5

-- ACTUALIZO EL CAMPO RUBROANTERIOR DE BS_HISTORIA_PLAZO CON C1644 DE SALDOS POSTERIOR AL RECALCULO -- 

	UPDATE BS_HISTORIA_PLAZO 
	SET RUBROANTERIOR = S.C1644
	FROM BS_HISTORIA_PLAZO
	INNER JOIN SALDOS S(NOLOCK)
	ON SALDOS_JTS_OID = S.JTS_OID
	WHERE S.C1785 = 5

--
	 SET @P_RET_PROCESO = 1
	 SET @P_MSG_PROCESO = ''Proceso ejecutado con exito. ''
--

-- INSERT EN LA MIG_RESULTADOS --
BEGIN TRANSACTION
	INSERT INTO MIG_RESULTADOS
				(CICLO, PROCESO, MODULO, FECHAINICIO, FECHAFIN, ESTADO, ERRORES, MENSAJE, ARCHIVO)
			VALUES
				(@v_CICLO,
				@v_PROCESO,
				@p_MODULO,
				@v_FECHASYS,
				SYSDATETIME(),
				''A'',
				''N'',
				''OK'',
				@p_NomScr)
	COMMIT;

END
')