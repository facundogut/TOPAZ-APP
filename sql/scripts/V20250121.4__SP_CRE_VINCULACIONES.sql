EXECUTE('
CREATE OR ALTER PROCEDURE SP_CRE_VINCULACIONES
   @P_ID_PERSONA_VINCULADA	NUMERIC(12),
   @P_RESULTADO	NUMERIC(5) OUTPUT
   
AS 

BEGIN

	SET @P_RESULTADO = NULL
	
		SELECT @P_RESULTADO= COUNT(CV.ID_VINCULO)
		FROM 
		    CRE_VINCULACIONES CV
		LEFT JOIN  
		    CRE_VINCULOS_RELACIONES CVR 
		ON
		    CVR.ID_VINCULO = CV.TIPO_VINCULO
		WHERE 
		    CV.ID_PERSONA_VINCULADA = @P_ID_PERSONA_VINCULADA
		    AND CV.TZ_LOCK = 0
		    AND (CVR.TZ_LOCK = 0 OR CVR.TZ_LOCK IS NULL)
		    AND CV.FECHA_INICIO <= (SELECT fechaproceso FROM PARAMETROS)
		    AND (
		        ((CVR.PARAMETRO_613 != ''S'' OR CVR.PARAMETRO_613 is NULL) 
		          AND CV.FECHA_FIN <= (SELECT fechaproceso FROM PARAMETROS))
		        OR 
		        (CV.FECHA_FIN is null )
				OR
				((CVR.PARAMETRO_613 = ''S'') AND (CV.FECHA_FIN is not NULL) 
				  AND (SELECT fechaproceso FROM PARAMETROS) <= DATEADD(year, (SELECT importe FROM CRE_PARAMETROS WHERE CODIGO = 613), (CV.FECHA_FIN)))
		    );
				
END
')
