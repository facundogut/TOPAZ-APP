EXECUTE('
CREATE FUNCTION FN_ObtenerTipoCambioOficial
(
    @moneda INT,
    @fecha DATETIME
)
RETURNS DECIMAL(18, 6)
AS
BEGIN
    DECLARE @tipoCambio DECIMAL(18, 6);

    SELECT TOP 1 @tipoCambio = H.TIPO_CAMBIO_OFICIAL
    FROM HISTORICOTIPOSCAMBIO H
    WHERE H.MONEDA = @moneda 
    AND H.FECHA_COTIZACION <= @fecha
    AND H.TZ_LOCK = 0
    ORDER BY H.FECHA_COTIZACION DESC;

    RETURN ISNULL(@tipoCambio, 1); 
END;
')
EXECUTE('
CREATE FUNCTION FN_ObtenerTipoCambioMesAnterior
(
    @moneda INT,
    @fecha DATETIME
)
RETURNS DECIMAL(18, 6)
AS
BEGIN
    DECLARE @fechaMesAnterior DATETIME;
    DECLARE @tipoCambioMesAnterior DECIMAL(18, 6);

    
    SET @fechaMesAnterior = dbo.ULTIMODIAHABIL(DATEADD(MONTH, -1, @fecha));

    SELECT TOP 1 @tipoCambioMesAnterior = H.TIPO_CAMBIO_OFICIAL
    FROM HISTORICOTIPOSCAMBIO H
    WHERE H.MONEDA = @moneda 
    AND H.FECHA_COTIZACION <= @fechaMesAnterior
    AND H.TZ_LOCK = 0
    ORDER BY H.FECHA_COTIZACION DESC;

    RETURN ISNULL(@tipoCambioMesAnterior, 1);
END;
')
EXECUTE('

CREATE VIEW VW_SaldosAjustados
AS
SELECT
    G.FECHA,
    G.SUCURSAL,
    G.MONEDA,
    G.SALDO_AJUSTADO,
    G.PROMEDIO_DIARIO,
    G.RUBROCONTABLE,
    S.CAT_BCRA,
    R.NUM1 AS MONEDA_NUM1
FROM 
    GRL_SALDOS_DIARIOS G WITH (NOLOCK)
INNER JOIN SUCURSALES S WITH (NOLOCK)
    ON G.SUCURSAL = S.SUCURSAL AND G.TZ_LOCK = S.TZ_LOCK
INNER JOIN RRI_PARAMETROS_INF R WITH (NOLOCK)
    ON G.MONEDA = R.ID1 AND G.TZ_LOCK = R.TZ_LOCK
WHERE 
    R.CODIGO = 1
    AND G.TZ_LOCK = 0
    AND S.TZ_LOCK = 0;
')