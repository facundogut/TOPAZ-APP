EXECUTE('
ALTER PROCEDURE PA_MEMOS_DETALLE
   @P_ID_PROCESO float(53), /* Identificador de proceso*/
   @P_DT_PROCESO datetime2(0), /* Fecha de proceso*/

   @P_RET_PROCESO float(53)  OUTPUT, /* Estado de ejecucion del PL/SQL(1:Correcto, 2: Error)*/
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS 
   BEGIN
      SET @P_RET_PROCESO = NULL
      SET @P_MSG_PROCESO = NULL
      
      --- Cargo variables ---
      
      DECLARE @FECHA_PROCESO DATETIME
      DECLARE @COTIZACION NUMERIC(15,2)

      DECLARE @INFO_GENERAL TABLE (TIPO_DOCUMENTO VARCHAR(4), 
      NUMERO_DOC VARCHAR(20), 
      NOMBRE VARCHAR(70),
      SUCURSAL_CLIENTE NUMERIC(5), 
      CUENTA NUMERIC(12), 
      CUENTAORDEN VARCHAR(1), 
      FAMILIA NUMERIC(10), 
      PRODUCTO NUMERIC(5),
      DESCRPCION_PRODUCTO VARCHAR(60), 
      MONEDA NUMERIC(4), 
      SUCURSAL_PROD NUMERIC(5), 
      OPERACION NUMERIC(16), 
      DESGLOSE NUMERIC(12),
      TIPO_GARANTIA VARCHAR(100), 
      GARANTIA_BCRA NUMERIC(2), 
      NUM_GARANTIA NUMERIC(6), 
      IMPORTE_GARANTIA NUMERIC(15,2),
      GARANTIA_INTERNA NUMERIC(2), 
      NUMERO_ACUERDO NUMERIC(6), 
      MONTO_ACUERDO NUMERIC(15,2), 
      ACUERDO_NO_UTILIZADO NUMERIC(15,2),
      FECHA_ALTA_AC DATETIME, 
      PLAZO_ACUERDO NUMERIC(5), 
      DIAS_AC_CC NUMERIC(5), 
      CLIENTE NUMERIC(12), 
      NUMERO_CHEQUE NUMERIC(12),
      NUMERO_BOLETA NUMERIC(12), 
      NUM_TARJETA NUMERIC(20), 
      ADMINISTRADORA VARCHAR(20), 
      SALDO_DEUDA NUMERIC(15,2), 
      DIAS_ATRASO NUMERIC(10),
      FECHA_ALTA DATETIME, 
      PRIMER_VENCIMIENTO DATETIME, 
      FECHA_VENCIMIENTO DATETIME, 
      CANT_CUOTAS NUMERIC(5), 
      CAPITAL_INICIAL NUMERIC(15,2),
      CLASIFICACION VARCHAR(2), 
      CONVENIO NUMERIC(10), 
      NOMBRE_CONVENIO VARCHAR(100), 
      JURISDICCION VARCHAR(10), 
      DENOM_JURISDICCION VARCHAR(100),
      SITUACION_REVISTA VARCHAR(20),
      PREVISION NUMERIC(15,2), 
      IVA_FINANCIADO NUMERIC(15,2), 
      RG_FINANCIADO NUMERIC(15,2), 
      CFT_TEA NUMERIC(11,7), 
      CFT_TNA NUMERIC(11,7),
      INT_DEVEN_VENCIDO NUMERIC(15,2), 
      CAPITAL_VENCIDO NUMERIC(18,2), 
      IMP_VALOR_TASACION NUMERIC(15,2), 
      INTERESES_ADELANTADOS NUMERIC(15,2),
      INT_DEVEN_NOPAGADOS NUMERIC(15,2), 
      TNA NUMERIC(11,7), 
      TNA_ORIGINAL NUMERIC(11,7), 
      PROMEDIO_MENSUAL NUMERIC(15,2),
      ----NUMERAL BIGINT,
      SALDO_JTS_OID NUMERIC(15),
      OTROS_ACCESORIOS NUMERIC(15,2),
      AFORO NUMERIC(15,2),
      AJUSTE_NIIF NUMERIC(15,2),
      TIENE_GARANTIA NUMERIC(10)
      )
      
      
      BEGIN TRY
      
      SET @FECHA_PROCESO = (SELECT FECHAPROCESOANTERIOR FROM PARAMETROS WITH(NOLOCK))
      
	  BEGIN
      DELETE FROM MEMO_DETALLE WHERE Fecha_Info = @FECHA_PROCESO
      
      -- ACTUALIZO EL CAPITAL DE LA TABLA CRE_HISTORICO_DEUDA_GARANTIAS cuando las ASISTENCIAS TIPO P están afectadas
      
      UPDATE hd
      SET hd.CAPITAL = IIF(hd.CAPITAL - (hd.INTERES + hd.IVA_FINANCIADO + hd.IVA_PERCEPCION_FINANCIADO + hd.ACCESORIOS) = 0, 0, hd.CAPITAL - (hd.INTERES + hd.IVA_FINANCIADO + hd.IVA_PERCEPCION_FINANCIADO + hd.ACCESORIOS))
      FROM CRE_HISTORICO_DEUDA_GARANTIAS hd
    	WHERE
			hd.FECHA_PROCESO = @FECHA_PROCESO AND 
        	hd.TIPO_ASISTENCIA = ''P'' AND
			(hd.CAPITAL + hd.INTERES + hd.IVA_FINANCIADO + hd.IVA_PERCEPCION_FINANCIADO + hd.ACCESORIOS)<>hd.MONTO_GARANTIZADO;

      --- Obtengo cotizacion

      SET @COTIZACION = (SELECT TOP 1 TIPO_CAMBIO_OFICIAL FROM HISTORICOTIPOSCAMBIO WITH(NOLOCK) WHERE MONEDA=2 AND FECHA_COTIZACION <= @FECHA_PROCESO ORDER BY FECHA_COTIZACION DESC)

                
                INSERT INTO @INFO_GENERAL     
                --PRESTAMOS
			   SELECT DISTINCT
                 DOC.TIPODOCUMENTO,
                 DOC.NUMERODOCUMENTO,
                 CASE WHEN C.TIPO = ''F'' THEN PF.APELLIDOPATERNO + '' '' + PF.PRIMERNOMBRE ELSE PJ.RAZONSOCIAL END AS NOMBRE,
                 C.SUCURSALVINCULADA,
                 S.CUENTA,
                 CASE WHEN S.C1728 = ''C'' AND S.C1785 = 5 THEN ''S'' ELSE ''N'' END AS CUENTAORDEN,
                 P.C6283,
                 S.PRODUCTO,
                 P.C6251,
                 S.MONEDA,
                 S.SUCURSAL,
                 S.OPERACION,
                 S.ORDINAL AS DESGLOSE,
                 OPG.DESCRIPCION, ---CTG.DSC_TIPO_GARANTIA,
                 HPD.TIPO_BCRA,
                 ISNULL(HPD.NRO_GARANTIA,0) AS NRO_GARANTIA,
                 ISNULL(HPD.IMPORTE_CONTRACTUAL,0) AS IMPORTE_GARANTIZADO,
                 CGR.TIPOGARANTIA,
                 0 as NRO_AUTORIZACION,
                 0 as SALDO_ACUERDO,
                 0 AS IMPORTE_NOUTILIZADO,
                 NULL as FECHA_ALTA,
                 0 AS PLAZO_ACUERDO,
                 0 AS DIAS_AC_CC,
                 C.CODIGOCLIENTE,
                 0 AS NUMERO_CHEQUE,
                 0 AS NUMERO_BOLETA,
                 0 as NUM_TJC,
                 '''' AS ADMINISTRADORA,
                 HPD.CAPITAL, --- AS Capital adeudado
                 --ABS(S.C1604), --- AS Capital adeudado
                 CASE WHEN S.C1785 IN (5,6) AND S.C1628 < @FECHA_PROCESO THEN DATEDIFF(DD,S.C1628,@FECHA_PROCESO) WHEN S.C1785 = 1 THEN S.C1652 ELSE 0 END AS DIAS_ATRASO,
                 S.C1621,
                 CASE WHEN S.C1785 = 5 THEN S.C1641 ELSE NULL END AS PRIMER_VENC,
                 S.C1627 AS VENCIMIENTO,
                 ---CASE WHEN S.C1785 = 6 THEN VA.FECHA_VENCIMIENTO WHEN S.C1785 = 1 THEN TMU. ELSE S.C1627 END AS FECHA_VENCIMIENTO,
                 -- CASE WHEN S.C1785 = 5 THEN (SELECT COUNT(1) FROM PLANPAGOS WITH(NOLOCK) WHERE SALDO_JTS_OID = S.JTS_OID) ELSE 0 END 
                 S.C1644 AS CANT_CUOTAS,
                 S.C1601,
                 C.CATEGORIARESULTANTE,
                 CS.ID_CONVENIO,
                 CCP.NomConvPago,
                 CD.ID_DOMINIO,
                 CD.DESCRIPCION,
                 NULL AS SITUACION_REVISTA, --se quita momentanamente porque esta generando duplicados
                 ISNULL(HPD.PREVISION,0) AS PREVISION,
                 HPD.IVA_FINANCIADO,
                 HPD.IVA_PERCEPCION_FINANCIADO,
                 CASE WHEN P.C6253 = ''E'' THEN CS.CFT ELSE 0 END, ---CFT_TEA
                 CASE WHEN P.C6253 = ''N'' THEN CS.CFT ELSE 0 END, ---CFT_TNA
                 ISNULL(VAD.MORA+VAD.IVA_MORA+VAD.PUNITORIO+VAD.IVA_PUNITORIO+VAD.IVA_PERCEPCION_MORA+VAD.IVA_PERCEPCION_INTCOMP_MORA,0), ---INT DEVEN VENCIDO
                 (SELECT SUM(C2309) FROM PLANPAGOS WITH(NOLOCK) WHERE SALDO_JTS_OID = S.JTS_OID AND C2302 <= @FECHA_PROCESO), ---CAPITAL VENCIDO
                 ISNULL(CGR.IMPORTE_REAL,0) AS IMPORTE_VALOR_TASACION,
                 0 AS INTERESES_ADELANTADOS,
                 HPD.INTERES AS INT_VIGENTES,
                 --CASE WHEN (S.C1610 + S.C1893) <= S.C1814 THEN S.C1814 - (S.C1610 + S.C1893) ELSE 0 END AS INT_VIGENTES,
                 S.C1632 AS TNA,
                 BHP.TASAINTERES,
                 0, -- (SELECT AVG(GRL.SALDO_AJUSTADO) FROM GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) WHERE GRL.TZ_LOCK = 0 AND MONTH(FECHA) = MONTH(@FECHA_PROCESO) AND YEAR(FECHA) = YEAR(@FECHA_PROCESO)),
                 ----ROW_NUMBER() OVER(ORDER BY S.JTS_OID ASC),
                 ---DENSE_RANK() OVER (PARTITION BY S.JTS_OID ORDER BY s.JTS_OID ASC) AS RegistroxJTS,
                 S.JTS_OID,
                 HPD.ACCESORIOS, --OTROS ACCESORIOS
                 HPD.PORCENTAJE_AFECTACION AS AFORO,
                 (SELECT SUM(DEVENGADO) FROM BS_COMISIONDESEMBOLSO WITH(NOLOCK) WHERE SALDOS_JTS_OID=S.JTS_OID),
                 0 AS TIENE_GARANTIA
                 FROM CRE_HISTORICO_DEUDA_GARANTIAS HPD WITH(NOLOCK)
                 INNER JOIN SALDOS S WITH(NOLOCK) ON HPD.SALDO_JTS_OID = S.JTS_OID AND HPD.FECHA_PROCESO = @FECHA_PROCESO and HPD.TIPO_ASISTENCIA=''P''
                 INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON C.CODIGOCLIENTE = S.C1803 AND C.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON CP.TITULARIDAD = ''T'' AND CP.CODIGOCLIENTE = C.CODIGOCLIENTE AND CP.TZ_LOCK = 0
                 INNER JOIN CLI_DOCUMENTOSPFPJ DOC WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA 
                 AND DOC.TIPOPERSONA = C.TIPO AND DOC.TZ_LOCK = 0
                 INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = S.PRODUCTO AND P.TZ_LOCK = 0 AND P.C6800 NOT IN (''CF'', ''CR'')
                 INNER JOIN CRE_SALDOS CS WITH(NOLOCK) ON CS.SALDOS_JTS_OID = S.JTS_OID AND CS.TZ_LOCK = 0
                 INNER JOIN VW_ASISTENCIAS_DEUDA VAD WITH(NOLOCK) ON VAD.JTS_OID = S.JTS_OID
                 --LEFT JOIN VW_DEUDA_CLIENTES DC WITH(NOLOCK) ON DC.JTS_OID = S.JTS_OID AND DC.SALDO_DEUDA >= 0
                 INNER JOIN BS_HISTORIA_PLAZO BHP WITH(NOLOCK) ON BHP.SALDOS_JTS_OID = S.JTS_OID AND BHP.TZ_LOCK = 0 AND BHP.TIPOMOV IN (''A'',''I'')
                 LEFT JOIN CLI_PERSONASFISICAS PF WITH(NOLOCK) ON PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA AND PF.TZ_LOCK = 0
                 LEFT JOIN CLI_PERSONASJURIDICAS PJ WITH(NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA AND PJ.TZ_LOCK = 0
                 --LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID AND CG.TZ_LOCK = 0
				 LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = HPD.NRO_GARANTIA AND CGR.TZ_LOCK = 0 AND CGR.FCHVTO_GARANTIA >= @FECHA_PROCESO
				 --LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND CTG.TZ_LOCK = 0
				 --LEFT JOIN CRE_CLASGARANTIAS CCG WITH(NOLOCK) ON CCG.PAIS_GARANTIA = CGR.PAIS_GARANTIA AND CCG.COD_SUBCLA_GARANTIA = CGR.COD_SUBCLAGARANTIA
				 --AND CCG.TIPOGARANTIA = CGR.TIPOGARANTIA AND CCG.SUBTIPOGTIA = CGR.SUBTIPOGARANTIA
				 LEFT JOIN OPCIONES OPG WITH(NOLOCK) ON OPG.IDIOMA = ''E'' AND OPG.OPCIONINTERNA = HPD.TIPO_BCRA AND OPG.NUMERODECAMPO = 44448
				 --LEFT JOIN VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO_SL CLD WITH(NOLOCK) ON CLD.jts_oid = S.JTS_OID AND ISNUMERIC(CLD.numero) = 1
				 --LEFT JOIN HISTORICO_CALIF_X_SALDO HCS WITH(NOLOCK) ON HCS.JTS_PRESTAMO = S.JTS_OID 
				 --AND HCS.FECHA = (SELECT TOP 1 FECHA FROM HISTORICO_CALIF_X_SALDO WITH(NOLOCK) WHERE JTS_PRESTAMO = S.JTS_OID AND FECHA <= @FECHA_PROCESO ORDER BY FECHA DESC)
                 LEFT JOIN CONV_CONVENIOS_PAG CCP WITH(NOLOCK) ON CCP.ID_ConvPago = CS.ID_CONVENIO AND CCP.TZ_LOCK = 0
                 LEFT JOIN CONV_DOMINIOS CD WITH(NOLOCK) ON CD.ID_CONVENIO = CS.ID_CONVENIO AND CONVERT(VARCHAR,CD.ID_DOMINIO) = CS.JURISDICCION AND CS.TZ_LOCK = 0 AND CD.ID_CONVENIO IN (1, 2, 3)
                 --LEFT JOIN CRE_SOL_RECIBO_SUELDO SRS WITH(NOLOCK) ON SRS.SOLICITUD = S.C1704 AND SRS.CONVENIO = CS.ID_CONVENIO
                 --AND CONVERT(VARCHAR,SRS.JURIDICCION) = CS.JURISDICCION AND SRS.TZ_LOCK=0
				 --LEFT JOIN (SELECT SALDO_JTS_OID, SUM(ISNULL(PREVISION,0)) AS PREVISION 
                 --FROM CRE_HISTORICO_DEUDA_GARANTIAS WITH(NOLOCK) 
                 --WHERE FECHA_PROCESO = @FECHA_PROCESO and TIPO_ASISTENCIA in (''P'')
                 --GROUP BY SALDO_JTS_OID) HPD
                 --ON HPD.SALDO_JTS_OID = S.JTS_OID
                 
                 WHERE S.TZ_LOCK = 0
			UNION ALL
                --PRESTAMOS CASTIGADOS
			   SELECT DISTINCT
                 DOC.TIPODOCUMENTO,
                 DOC.NUMERODOCUMENTO,
                 CASE WHEN C.TIPO = ''F'' THEN PF.APELLIDOPATERNO + '' '' + PF.PRIMERNOMBRE ELSE PJ.RAZONSOCIAL END AS NOMBRE,
                 C.SUCURSALVINCULADA,
                 S.CUENTA,
                 ''S'' AS CUENTAORDEN,
                 P.C6283,
                 S.PRODUCTO,
                 P.C6251,
                 S.MONEDA,
                 S.SUCURSAL,
                 S.OPERACION,
                 S.ORDINAL AS DESGLOSE,
                 OPG.DESCRIPCION, ---CTG.DSC_TIPO_GARANTIA,
                 CTG.TIPO_BCRA,
                 ISNULL(CG.NUM_GARANTIA,0) AS NRO_GARANTIA,
                 ISNULL(CGR.IMPORTECONTRACTUAL,0) AS IMPORTE_GARANTIZADO,
                 CTG.TIPO_GARANTIA,
                 0 as NRO_AUTORIZACION,
                 0 as SALDO_ACUERDO,
                 0 AS IMPORTE_NOUTILIZADO,
                 NULL as FECHA_ALTA,
                 0 AS PLAZO_ACUERDO,
                 0 AS DIAS_AC_CC,
                 C.CODIGOCLIENTE,
                 0 AS NUMERO_CHEQUE,
                 0 AS NUMERO_BOLETA,
                 0 as NUM_TJC,
                 '''' AS ADMINISTRADORA,
                 --HPD.CAPITAL, --- AS Capital adeudado
                 ABS(S.C1604), --- AS Capital adeudado
                 CASE WHEN S.C1785 IN (5,6) AND S.C1628 < @FECHA_PROCESO THEN DATEDIFF(DD,S.C1628,@FECHA_PROCESO) WHEN S.C1785 = 1 THEN S.C1652 ELSE 0 END AS DIAS_ATRASO,
                 S.C1621,
                 CASE WHEN S.C1785 = 5 THEN S.C1641 ELSE NULL END AS PRIMER_VENC,
                 S.C1627 AS VENCIMIENTO,
                 ---CASE WHEN S.C1785 = 6 THEN VA.FECHA_VENCIMIENTO WHEN S.C1785 = 1 THEN TMU. ELSE S.C1627 END AS FECHA_VENCIMIENTO,
                 -- CASE WHEN S.C1785 = 5 THEN (SELECT COUNT(1) FROM PLANPAGOS WITH(NOLOCK) WHERE SALDO_JTS_OID = S.JTS_OID) ELSE 0 END 
                 S.C1644 AS CANT_CUOTAS,
                 S.C1601,
                 C.CATEGORIARESULTANTE,
                 CS.ID_CONVENIO,
                 CCP.NomConvPago,
                 CD.ID_DOMINIO,
                 CD.DESCRIPCION,
                 NULL AS SITUACION_REVISTA, --se quita por ahora porque esta generando duplicados
                 0 AS PREVISION,
                 S.IVA_FINANCIADO,
                 S.IVA_PERCEPCION_FINANCIADO,
                 CASE WHEN P.C6253 = ''E'' THEN CS.CFT ELSE 0 END, ---CFT_TEA
                 CASE WHEN P.C6253 = ''N'' THEN CS.CFT ELSE 0 END, ---CFT_TNA
                 ISNULL(VAD.MORA+VAD.IVA_MORA+VAD.PUNITORIO+VAD.IVA_PUNITORIO+VAD.IVA_PERCEPCION_MORA+VAD.IVA_PERCEPCION_INTCOMP_MORA,0), ---INT DEVEN VENCIDO
                 (SELECT SUM(C2309) FROM PLANPAGOS WITH(NOLOCK) WHERE SALDO_JTS_OID = S.JTS_OID AND C2302 <= @FECHA_PROCESO), ---CAPITAL VENCIDO
                 ISNULL(CGR.IMPORTE_REAL,0) AS IMPORTE_VALOR_TASACION,
                 0 AS INTERESES_ADELANTADOS,
                 --HPD.INTERES AS INT_VIGENTES,
                 CASE WHEN (S.C1610 + S.C1893) <= S.C1814 THEN S.C1814 - (S.C1610 + S.C1893) ELSE 0 END AS INT_VIGENTES,
                 S.C1632 AS TNA,
                 BHP.TASAINTERES,
                 0, -- (SELECT AVG(GRL.SALDO_AJUSTADO) FROM GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) WHERE GRL.TZ_LOCK = 0 AND MONTH(FECHA) = MONTH(@FECHA_PROCESO) AND YEAR(FECHA) = YEAR(@FECHA_PROCESO)),
                 ----ROW_NUMBER() OVER(ORDER BY S.JTS_OID ASC),
                 ---DENSE_RANK() OVER (PARTITION BY S.JTS_OID ORDER BY s.JTS_OID ASC) AS RegistroxJTS,
                 S.JTS_OID,
                 VAD.GASTOS AS ACCESORIOS, --OTROS ACCESORIOS - son los GASTOS POR CUOTA
                 CASE WHEN DATEDIFF(YY,S.C1621,S.C1627) < 1 OR (DATEDIFF(YY,S.C1621,S.C1627) = 1 AND DATEDIFF(DD,S.C1621,S.C1627) = 0)
                 THEN CCG.PORCENTAJEAFECTACION ELSE CCG.PORCENTAJEAFECTACION_1_ANIO END AS AFORO,
                 (SELECT SUM(DEVENGADO) FROM BS_COMISIONDESEMBOLSO WITH(NOLOCK) WHERE SALDOS_JTS_OID=S.JTS_OID),
                 0 AS TIENE_GARANTIA
                 FROM SALDOS S WITH(NOLOCK)
                 --FROM CRE_HISTORICO_DEUDA_GARANTIAS HPD WITH(NOLOCK)
                 --INNER JOIN SALDOS S WITH(NOLOCK) ON HPD.SALDO_JTS_OID = S.JTS_OID AND HPD.FECHA_PROCESO = @FECHA_PROCESO and HPD.TIPO_ASISTENCIA=''P''
                 INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON C.CODIGOCLIENTE = S.C1803 AND C.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON CP.TITULARIDAD = ''T'' AND CP.CODIGOCLIENTE = C.CODIGOCLIENTE AND CP.TZ_LOCK = 0
                 INNER JOIN CLI_DOCUMENTOSPFPJ DOC WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA 
                 AND DOC.TIPOPERSONA = C.TIPO AND DOC.TZ_LOCK = 0
                 INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = S.PRODUCTO AND P.TZ_LOCK = 0 AND P.C6800 NOT IN (''CF'', ''CR'')
                 INNER JOIN CRE_SALDOS CS WITH(NOLOCK) ON CS.SALDOS_JTS_OID = S.JTS_OID AND CS.TZ_LOCK = 0
                 INNER JOIN VW_ASISTENCIAS_DEUDA VAD WITH(NOLOCK) ON VAD.JTS_OID = S.JTS_OID
                 --LEFT JOIN VW_DEUDA_CLIENTES DC WITH(NOLOCK) ON DC.JTS_OID = S.JTS_OID AND DC.SALDO_DEUDA >= 0
                 INNER JOIN BS_HISTORIA_PLAZO BHP WITH(NOLOCK) ON BHP.SALDOS_JTS_OID = S.JTS_OID AND BHP.TZ_LOCK = 0 AND BHP.TIPOMOV IN (''A'',''I'')
                 LEFT JOIN CLI_PERSONASFISICAS PF WITH(NOLOCK) ON PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA AND PF.TZ_LOCK = 0
                 LEFT JOIN CLI_PERSONASJURIDICAS PJ WITH(NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA AND PJ.TZ_LOCK = 0
                 LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID AND CG.TZ_LOCK = 0
				 LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA AND CGR.TZ_LOCK = 0 AND CGR.FCHVTO_GARANTIA >= @FECHA_PROCESO
				 LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND CTG.TZ_LOCK = 0
				 LEFT JOIN CRE_CLASGARANTIAS CCG WITH(NOLOCK) ON CCG.PAIS_GARANTIA = CGR.PAIS_GARANTIA AND CCG.COD_SUBCLA_GARANTIA = CGR.COD_SUBCLAGARANTIA
				 AND CCG.TIPOGARANTIA = CGR.TIPOGARANTIA AND CCG.SUBTIPOGTIA = CGR.SUBTIPOGARANTIA
				 LEFT JOIN OPCIONES OPG WITH(NOLOCK) ON OPG.IDIOMA = ''E'' AND OPG.OPCIONINTERNA = CTG.TIPO_BCRA AND OPG.NUMERODECAMPO = 44448
				 --LEFT JOIN VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO_SL CLD WITH(NOLOCK) ON CLD.jts_oid = S.JTS_OID AND ISNUMERIC(CLD.numero) = 1
				 --LEFT JOIN HISTORICO_CALIF_X_SALDO HCS WITH(NOLOCK) ON HCS.JTS_PRESTAMO = S.JTS_OID 
				 --AND HCS.FECHA = (SELECT TOP 1 FECHA FROM HISTORICO_CALIF_X_SALDO WITH(NOLOCK) WHERE JTS_PRESTAMO = S.JTS_OID AND FECHA <= @FECHA_PROCESO ORDER BY FECHA DESC)
                 LEFT JOIN CONV_CONVENIOS_PAG CCP WITH(NOLOCK) ON CCP.ID_ConvPago = CS.ID_CONVENIO AND CCP.TZ_LOCK = 0
                 LEFT JOIN CONV_DOMINIOS CD WITH(NOLOCK) ON CD.ID_CONVENIO = CS.ID_CONVENIO AND CONVERT(VARCHAR,CD.ID_DOMINIO) = CS.JURISDICCION AND CS.TZ_LOCK = 0 AND CD.ID_CONVENIO IN (1, 2, 3)
                 --LEFT JOIN CRE_SOL_RECIBO_SUELDO SRS WITH(NOLOCK) ON SRS.SOLICITUD = S.C1704 AND SRS.CONVENIO = CS.ID_CONVENIO 
                 --AND CONVERT(VARCHAR,SRS.JURIDICCION) = CS.JURISDICCION AND SRS.TZ_LOCK=0
				 --LEFT JOIN (SELECT SALDO_JTS_OID, SUM(ISNULL(PREVISION,0)) AS PREVISION 
                 --FROM CRE_HISTORICO_DEUDA_GARANTIAS WITH(NOLOCK) 
                 --WHERE FECHA_PROCESO = @FECHA_PROCESO and TIPO_ASISTENCIA in (''P'')
                 --GROUP BY SALDO_JTS_OID) HPD
                 --ON HPD.SALDO_JTS_OID = S.JTS_OID
                 WHERE S.TZ_LOCK = 0 AND S.C1785=5 AND C1728=''C''           
            UNION ALL
            	--DTO DOCUMENTOS 
			   SELECT DISTINCT
                 DOC.TIPODOCUMENTO,
                 DOC.NUMERODOCUMENTO,
                 CASE WHEN C.TIPO = ''F'' THEN PF.APELLIDOPATERNO + '' '' + PF.PRIMERNOMBRE ELSE PJ.RAZONSOCIAL END AS NOMBRE,
                 C.SUCURSALVINCULADA,
                 S.C1803,
                 CASE WHEN S.C1728 = ''C'' AND S.C1785 = 5 THEN ''S'' ELSE ''N'' END AS CUENTAORDEN,
                 P.C6283,
                 S.PRODUCTO,
                 P.C6251,
                 S.MONEDA,
                 S.SUCURSAL,
                 S.CUENTA,
                 S.ORDINAL AS DESGLOSE,
                 OPG.DESCRIPCION, ---CTG.DSC_TIPO_GARANTIA,
                 CTG.TIPO_BCRA,
                 ISNULL(CG.NUM_GARANTIA,0) AS NRO_GARANTIA,
                 ISNULL(CGR.IMPORTECONTRACTUAL,0) AS IMPORTE_GARANTIZADO,
                 CTG.TIPO_GARANTIA,
                 0 as NRO_AUTORIZACION,
                 0 as SALDO_ACUERDO,
                 0 AS IMPORTE_NOUTILIZADO,
                 NULL as FECHA_ALTA,
                 0 AS PLAZO_ACUERDO,
                 0 AS DIAS_AC_CC,
                 C.CODIGOCLIENTE,
                 ISNULL(CCS.NUMERO_CHEQUE,0) AS NUMERO_CHEQUE,
                 ISNULL(CCS.NUMERO_DEPOSITO,0) AS NUMERO_BOLETA,
                 0 as NUM_TJC,
                 '''' AS ADMINISTRADORA,
                 ABS(S.C1604), --- AS Capital adeudado
                 CASE WHEN S.C1785 IN (5,6) AND S.C1628 < @FECHA_PROCESO THEN DATEDIFF(DD,S.C1628,@FECHA_PROCESO) WHEN S.C1785 = 1 THEN S.C1652 ELSE 0 END AS DIAS_ATRASO,
                 S.C1621,
                 CASE WHEN S.C1785 = 5 THEN S.C1641 ELSE NULL END AS PRIMER_VENC,
                 S.C1627 AS VENCIMIENTO,
                 ---CASE WHEN S.C1785 = 6 THEN VA.FECHA_VENCIMIENTO WHEN S.C1785 = 1 THEN TMU. ELSE S.C1627 END AS FECHA_VENCIMIENTO,
                 -- CASE WHEN S.C1785 = 5 THEN (SELECT COUNT(1) FROM PLANPAGOS WITH(NOLOCK) WHERE SALDO_JTS_OID = S.JTS_OID) ELSE 0 END 
                 S.C1644 AS CANT_CUOTAS,
                 S.C1601,
                 C.CATEGORIARESULTANTE,
                 CS.ID_CONVENIO,
                 CCP.NomConvPago,
                 CD.ID_DOMINIO,
                 CD.DESCRIPCION,
                 NULL AS SITUACION_REVISTA,--Se quita por ahora porque genera duplicados
                 ISNULL(HPD.PREVISION,0) AS PREVISION,
                 S.IVA_FINANCIADO,
                 S.IVA_PERCEPCION_FINANCIADO,
                 CASE WHEN P.C6253 = ''E'' THEN CS.CFT ELSE 0 END, ---CFT_TEA
                 CASE WHEN P.C6253 = ''N'' THEN CS.CFT ELSE 0 END, ---CFT_TNA
                 0, ---INT DEVEN VENCIDO
                 (SELECT SUM(C2309) FROM PLANPAGOS WITH(NOLOCK) WHERE SALDO_JTS_OID = S.JTS_OID AND C2302 <= @FECHA_PROCESO), ---CAPITAL VENCIDO
                 ISNULL(CGR.IMPORTE_REAL,0) AS IMPORTE_VALOR_TASACION,
                 (S.C1600 - S.C1601) AS INTERESES_ADELANTADOS,
                 CASE WHEN (S.C1610 + S.C1893) <= S.C1814 THEN S.C1814 - (S.C1610 + S.C1893) ELSE 0 END AS INT_VIGENTES,
                 S.C1632 AS TNA,
                 BHP.TASAINTERES,
                 0, -- (SELECT AVG(GRL.SALDO_AJUSTADO) FROM GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) WHERE GRL.TZ_LOCK = 0 AND MONTH(FECHA) = MONTH(@FECHA_PROCESO) AND YEAR(FECHA) = YEAR(@FECHA_PROCESO)),
                 ----ROW_NUMBER() OVER(ORDER BY S.JTS_OID ASC),
                 ---DENSE_RANK() OVER (PARTITION BY S.JTS_OID ORDER BY s.JTS_OID ASC) AS RegistroxJTS,
                 S.JTS_OID,
                 0 AS ACCESORIOS, --OTROS ACCESORIOS
                 CASE WHEN DATEDIFF(YY,S.C1621,S.C1627) < 1 OR (DATEDIFF(YY,S.C1621,S.C1627) = 1 AND DATEDIFF(DD,S.C1621,S.C1627) = 0)
                 THEN CCG.PORCENTAJEAFECTACION ELSE CCG.PORCENTAJEAFECTACION_1_ANIO END AS AFORO,
                 (SELECT SUM(DEVENGADO) FROM BS_COMISIONDESEMBOLSO WITH(NOLOCK) WHERE SALDOS_JTS_OID=S.JTS_OID),
                 0 AS TIENE_GARANTIA
                 FROM SALDOS S WITH(NOLOCK) 
                 INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON C.CODIGOCLIENTE = S.C1803 AND C.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON CP.TITULARIDAD = ''T'' AND CP.CODIGOCLIENTE = C.CODIGOCLIENTE AND CP.TZ_LOCK = 0
                 INNER JOIN CLI_DOCUMENTOSPFPJ DOC WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA 
                 AND DOC.TIPOPERSONA = C.TIPO AND DOC.TZ_LOCK = 0
                 INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = S.PRODUCTO AND P.TZ_LOCK = 0
                 INNER JOIN CRE_SALDOS CS WITH(NOLOCK) ON CS.SALDOS_JTS_OID = S.JTS_OID AND CS.TZ_LOCK = 0
                 --INNER JOIN VW_ASISTENCIAS_DEUDA VAD WITH(NOLOCK) ON VAD.JTS_OID = S.JTS_OID
                 -- LEFT JOIN VW_DEUDA_CLIENTES DC WITH(NOLOCK) ON DC.JTS_OID = S.JTS_OID AND DC.SALDO_DEUDA >= 0
                 INNER JOIN BS_HISTORIA_PLAZO BHP WITH(NOLOCK) ON BHP.SALDOS_JTS_OID = S.JTS_OID AND BHP.TZ_LOCK = 0 AND BHP.TIPOMOV IN (''A'',''I'')
                 LEFT JOIN CLI_PERSONASFISICAS PF WITH(NOLOCK) ON PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA AND PF.TZ_LOCK = 0
                 LEFT JOIN CLI_PERSONASJURIDICAS PJ WITH(NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA AND PJ.TZ_LOCK = 0
                 LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID AND CG.TZ_LOCK = 0
				 LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA AND CGR.TZ_LOCK = 0
				 LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND CTG.TZ_LOCK = 0
				 LEFT JOIN CRE_CLASGARANTIAS CCG WITH(NOLOCK) ON CCG.PAIS_GARANTIA = CGR.PAIS_GARANTIA AND CCG.COD_SUBCLA_GARANTIA = CGR.COD_SUBCLAGARANTIA
				 AND CCG.TIPOGARANTIA = CGR.TIPOGARANTIA AND CCG.SUBTIPOGTIA = CGR.SUBTIPOGARANTIA
				 LEFT JOIN OPCIONES OPG WITH(NOLOCK) ON OPG.IDIOMA = ''E'' AND OPG.OPCIONINTERNA = CTG.TIPO_BCRA AND OPG.NUMERODECAMPO = 44448
				 LEFT JOIN VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO_SL CLD WITH(NOLOCK) ON CLD.jts_oid = S.JTS_OID AND ISNUMERIC(CLD.numero) = 1
				 --LEFT JOIN HISTORICO_CALIF_X_SALDO HCS WITH(NOLOCK) ON HCS.JTS_PRESTAMO = S.JTS_OID 
				 --AND HCS.FECHA = (SELECT TOP 1 FECHA FROM HISTORICO_CALIF_X_SALDO WITH(NOLOCK) WHERE JTS_PRESTAMO = S.JTS_OID AND FECHA <= @FECHA_PROCESO ORDER BY FECHA DESC)
                 LEFT JOIN CONV_CONVENIOS_PAG CCP WITH(NOLOCK) ON CCP.ID_ConvPago = CS.ID_CONVENIO AND CCP.TZ_LOCK = 0
                 LEFT JOIN CONV_DOMINIOS CD WITH(NOLOCK) ON CD.ID_CONVENIO = CS.ID_CONVENIO AND CONVERT(VARCHAR,CD.ID_DOMINIO) = CS.JURISDICCION AND CS.TZ_LOCK = 0 AND CD.ID_CONVENIO IN (1, 2, 3)
                 --LEFT JOIN CRE_SOL_RECIBO_SUELDO SRS WITH(NOLOCK) ON SRS.SOLICITUD = S.C1704 AND SRS.CONVENIO = CS.ID_CONVENIO 
                 --AND CONVERT(VARCHAR,SRS.JURIDICCION) = CS.JURISDICCION AND SRS.TZ_LOCK=0
				 LEFT JOIN CLE_CHEQUES_SALIENTE CCS WITH(NOLOCK) ON CCS.JTS_OID_DESCUENTO = S.JTS_OID
				 LEFT JOIN (SELECT SALDO_JTS_OID, SUM(ISNULL(PREVISION,0)) AS PREVISION 
                 FROM CRE_HISTORICO_DEUDA_GARANTIAS WITH(NOLOCK) 
                 WHERE FECHA_PROCESO = @FECHA_PROCESO and TIPO_ASISTENCIA in (''D'')
                 GROUP BY SALDO_JTS_OID) HPD
                 ON HPD.SALDO_JTS_OID = S.JTS_OID
                 
                 WHERE S.TZ_LOCK = 0 AND
                 (S.C1604<>0 AND S.C1785=6)
                 AND S.C1621 <= @FECHA_PROCESO     
			UNION ALL
				----TARJETAS
				SELECT DISTINCT
                 DOC.TIPODOCUMENTO,
                 DOC.NUMERODOCUMENTO,
                 CASE WHEN C.TIPO = ''F'' THEN PF.APELLIDOPATERNO + '' '' + PF.PRIMERNOMBRE ELSE PJ.RAZONSOCIAL END AS NOMBRE,
                 C.SUCURSALVINCULADA,
                 S.CUENTA,
                 ''N'' AS CUENTAORDEN,
                 P.C6283,
                 S.PRODUCTO,
                 P.C6251,
                 S.MONEDA,
                 S.SUCURSAL,
                 TMU.USUARIO AS OPERACION,
                 S.ORDINAL AS DESGLOSE,
                 NULL AS  DESCRIPCION, ---CTG.DSC_TIPO_GARANTIA,
                 0 as TIPO_BCRA,
                 0 AS NRO_GARANTIA,
                 0 AS IMPORTE_GARANTIZADO,
                 NULL TIPO_GARANTIA,
                 0 as NRO_AUTORIZACION,
                 0 as SALDO_ACUERDO,
                 0 AS IMPORTE_NOUTILIZADO,
                 TMU.FECHA_ALTA_USU as FECHA_ALTA,
                 0 AS PLAZO_ACUERDO,
                 0 AS DIAS_AC_CC,
                 C.CODIGOCLIENTE,
                 0 AS NUMERO_CHEQUE,
                 0 AS NUMERO_BOLETA,
                 TMU.NUM_TJC,
                 TMA.DESCRIPCION AS ADMINISTRADORA,
                 S.C1726, --- AS Capital adeudado
                 S.C1652 AS DIAS_ATRASO,
                 S.C1621,
                 S.C1761 AS PRIMER_VENC,
                 TAD.FECHA_VENCIMIENTO AS VENCIMIENTO,
                 ---CASE WHEN S.C1785 = 6 THEN VA.FECHA_VENCIMIENTO WHEN S.C1785 = 1 THEN TMU. ELSE S.C1627 END AS FECHA_VENCIMIENTO,
                 0 AS CANT_CUOTAS,
                 TSR.LIMITE_TOT_DEUDA_RRII AS C1806, --LIMITE EN CUOTAS Y AL CONTADO
                 C.CATEGORIARESULTANTE,
                 0 AS ID_CONVENIO,
                 NULL NomConvPago,
                 0 AS ID_DOMINIO,
                 NULL AS DESCRIPCION,
                 NULL AS SITUACION_REVISTA,
                 ISNULL(HPD.PREVISION,0) AS PREVISION,
                 0 AS IVA_FINANCIADO,
                 0 AS IVA_PERCEPCION_FINANCIADO,
                 0, ---CFT_TEA
                 0, ---CFT_TNA
                 0, ---INT DEVEN VENCIDO
                 0, ---CAPITAL VENCIDO
                 0 AS IMPORTE_VALOR_TASACION,
                 0 AS INTERESES_ADELANTADOS,
                 0 AS INT_VIGENTES,
                 TSR.TNA AS TNA,
                 0 AS TASAINTERES,
                 0, -- (SELECT AVG(GRL.SALDO_AJUSTADO) FROM GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) WHERE GRL.TZ_LOCK = 0 AND MONTH(FECHA) = MONTH(@FECHA_PROCESO) AND YEAR(FECHA) = YEAR(@FECHA_PROCESO)),
                 ----ROW_NUMBER() OVER(ORDER BY S.JTS_OID ASC),
                 ---DENSE_RANK() OVER (PARTITION BY S.JTS_OID ORDER BY s.JTS_OID ASC) AS RegistroxJTS,
                 S.JTS_OID,
                 0 AS ACCESORIOS, --OTROS ACCESORIOS
                 0 AS AFORO,
                 0,
                 0 AS TIENE_GARANTIA
                 FROM SALDOS S WITH(NOLOCK) 
                 INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON C.CODIGOCLIENTE = S.C1803 AND C.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON CP.TITULARIDAD = ''T'' AND CP.CODIGOCLIENTE = C.CODIGOCLIENTE AND CP.TZ_LOCK = 0
                 INNER JOIN CLI_DOCUMENTOSPFPJ DOC WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA 
                 AND DOC.TIPOPERSONA = C.TIPO AND DOC.TZ_LOCK = 0
                 INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = S.PRODUCTO AND P.TZ_LOCK = 0
                 -- LEFT JOIN VW_DEUDA_CLIENTES DC WITH(NOLOCK) ON DC.JTS_OID = S.JTS_OID AND DC.SALDO_DEUDA >= 0
                 LEFT JOIN CLI_PERSONASFISICAS PF WITH(NOLOCK) ON PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA AND PF.TZ_LOCK = 0
                 LEFT JOIN CLI_PERSONASJURIDICAS PJ WITH(NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA AND PJ.TZ_LOCK = 0
                 -- LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID AND CG.TZ_LOCK = 0
				 -- LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA AND CGR.TZ_LOCK = 0
				 -- LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND CTG.TZ_LOCK = 0
				 -- LEFT JOIN CRE_CLASGARANTIAS CCG WITH(NOLOCK) ON CCG.PAIS_GARANTIA = CGR.PAIS_GARANTIA AND CCG.COD_SUBCLA_GARANTIA = CGR.COD_SUBCLAGARANTIA
				 -- AND CCG.TIPOGARANTIA = CGR.TIPOGARANTIA AND CCG.SUBTIPOGTIA = CGR.SUBTIPOGARANTIA
				 -- LEFT JOIN OPCIONES OPG WITH(NOLOCK) ON OPG.IDIOMA = ''E'' AND OPG.OPCIONINTERNA = CTG.TIPO_BCRA AND OPG.NUMERODECAMPO = 44448
				 -- LEFT JOIN VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO_SL CLD WITH(NOLOCK) ON CLD.jts_oid = S.JTS_OID AND ISNUMERIC(CLD.numero) = 1
				 LEFT JOIN TJC_MAESTRO_USUARIO TMU WITH(NOLOCK) ON TMU.JTS_SALDO_TARJETA = S.JTS_OID AND TMU.TZ_LOCK = 0
				 --LEFT JOIN TJC_SALDOS TMS WITH(NOLOCK) ON TMS.USUARIO = TMU.USUARIO AND TMS.ADMINISTRADORA = TMU.ADMINISTRADORA AND TMS.TZ_LOCK = 0
				 LEFT JOIN (SELECT MAX(FECHA_GENERACION) AS FECHA,ADMINISTRADORA,NRO_CUENTA FROM TJC_ADINTAR_DEUDASPLAS WITH(NOLOCK) WHERE TZ_LOCK = 0 AND FECHA_GENERACION <= @FECHA_PROCESO AND ESTADO = ''A'' AND CONDICION=''T'' GROUP BY NRO_CUENTA, ADMINISTRADORA) TADF ON TADF.NRO_CUENTA = TMU.USUARIO AND TADF.ADMINISTRADORA = TMU.ADMINISTRADORA
				 LEFT JOIN TJC_ADINTAR_DEUDASPLAS TAD WITH(NOLOCK) ON TAD.NRO_CUENTA = TMU.USUARIO AND TAD.ADMINISTRADORA = TMU.ADMINISTRADORA AND TAD.TZ_LOCK = 0 AND TAD.ESTADO = ''A'' AND TAD.CONDICION=''T'' AND TAD.FECHA_GENERACION = TADF.FECHA
				 LEFT JOIN (SELECT MAX(FECHA_GENERACION) AS FECHA,ADMINISTRADORA,USUARIO FROM TJC_SALDOS_RRII WITH(NOLOCK) WHERE TZ_LOCK = 0 AND FECHA_GENERACION <= @FECHA_PROCESO GROUP BY ADMINISTRADORA,USUARIO) TSRF ON TSRF.USUARIO = TMU.USUARIO AND TSRF.ADMINISTRADORA = TMU.ADMINISTRADORA
				 LEFT JOIN TJC_SALDOS_RRII TSR WITH(NOLOCK) ON TSR.USUARIO = TMU.USUARIO AND TSR.ADMINISTRADORA = TMU.ADMINISTRADORA AND TSR.TZ_LOCK = 0 AND TSR.FECHA_GENERACION = TSRF.FECHA
				 LEFT JOIN TJC_MAESTRO_ADMINISTRADORAS TMA WITH(NOLOCK) ON TMA.COD_ADMINISTRADORA = TMU.ADMINISTRADORA AND TMA.TZ_LOCK = 0
				 --LEFT JOIN HISTORICO_CALIF_X_SALDO HCS WITH(NOLOCK) ON HCS.JTS_PRESTAMO = S.JTS_OID 
				 --AND HCS.FECHA = (SELECT TOP 1 FECHA FROM HISTORICO_CALIF_X_SALDO WITH(NOLOCK) WHERE JTS_PRESTAMO = S.JTS_OID AND FECHA <= @FECHA_PROCESO ORDER BY FECHA DESC)
                 -- LEFT JOIN CRE_SALDOS CS WITH(NOLOCK) ON CS.SALDOS_JTS_OID = S.JTS_OID AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CONV_CONVENIOS_PAG CCP WITH(NOLOCK) ON CCP.ID_ConvPago = CS.ID_CONVENIO AND CCP.TZ_LOCK = 0
                 -- LEFT JOIN CONV_DOMINIOS CD WITH(NOLOCK) ON CD.ID_CONVENIO = CS.ID_CONVENIO AND CONVERT(VARCHAR,CD.ID_DOMINIO) = CS.JURISDICCION AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CRE_SOL_RECIBO_SUELDO SRS WITH(NOLOCK) ON SRS.SOLICITUD = S.C1704 AND SRS.CONVENIO = CS.ID_CONVENIO 
                 -- AND CONVERT(VARCHAR,SRS.JURIDICCION) = CS.JURISDICCION
                 ---LEFT JOIN CRE_HISTORICO_DEUDA_GARANTIAS HPD WITH(NOLOCK) ON HPD.SALDO_JTS_OID=S.JTS_OID AND  HPD.FECHA_PROCESO = @FECHA_PROCESO AND HPD.TIPO_ASISTENCIA = ''T'' 
                 LEFT JOIN (SELECT SALDO_JTS_OID, SUM(ISNULL(PREVISION,0)) AS PREVISION 
                 FROM CRE_HISTORICO_DEUDA_GARANTIAS WITH(NOLOCK) 
                 WHERE FECHA_PROCESO = @FECHA_PROCESO and TIPO_ASISTENCIA = ''T''
                 GROUP BY SALDO_JTS_OID) HPD
                 ON HPD.SALDO_JTS_OID = S.JTS_OID
                 
                 WHERE S.TZ_LOCK = 0 AND
                 (S.C1785 = 1 AND S.PRODUCTO IN (SELECT C6250 FROM PRODUCTOS WITH(NOLOCK) WHERE TZ_LOCK = 0 AND C6800=''T''))
                 AND S.C1621 <= @FECHA_PROCESO
			UNION ALL 
				--CC tipo Asisntencia A
				SELECT DISTINCT
                 DOC.TIPODOCUMENTO,
                 DOC.NUMERODOCUMENTO,
                 CASE WHEN C.TIPO = ''F'' THEN PF.APELLIDOPATERNO + '' '' + PF.PRIMERNOMBRE ELSE PJ.RAZONSOCIAL END AS NOMBRE,
                 C.SUCURSALVINCULADA,
                 S.CUENTA,
                 ''N'' AS CUENTAORDEN,
                 P.C6283,
                 ISNULL(VA.NROLINEA, S.PRODUCTO),
                 P.C6251,
                 S.MONEDA,
                 S.SUCURSAL,
                 S.CUENTA AS OPERACION,
                 S.ORDINAL AS DESGLOSE,
                 OPG.DESCRIPCION, ---CTG.DSC_TIPO_GARANTIA,
                 HDP.TIPO_BCRA,
                 ISNULL(HDP.NRO_GARANTIA,0) AS NRO_GARANTIA,
                 ISNULL(HDP.IMPORTE_CONTRACTUAL,0) AS IMPORTE_GARANTIZADO,
                 CTG.TIPO_GARANTIA,
                 VA.NRO_AUTORIZACION,
                 VA.SALDO_ACUERDO,
                 ISNULL(VA.IMPORTE,0) - ISNULL(VA.IMPORTE_CONSUMIDO,0) AS IMPORTE_NOUTILIZADO,
                 VA.FECHA_ALTA,
                 ISNULL(VA.PERIODO,0) AS PLAZO_ACUERDO,
                 DATEDIFF(DD,VA.FECHA_ALTA,@FECHA_PROCESO) AS DIAS_AC_CC,
                 C.CODIGOCLIENTE,
                 0 AS NUMERO_CHEQUE,
                 0 AS NUMERO_BOLETA,
                 0 AS NUM_TJC,
                 NULL AS ADMINISTRADORA,
                 HDP.MONTO_GARANTIZADO, --- AS Capital adeudado
                 0 AS DIAS_ATRASO,
                 S.C1621,
                 NULL AS PRIMER_VENC,
                 NULL AS VENCIMIENTO,
                 ---CASE WHEN S.C1785 = 6 THEN VA.FECHA_VENCIMIENTO WHEN S.C1785 = 1 THEN TMU. ELSE S.C1627 END AS FECHA_VENCIMIENTO,
                 0 AS CANT_CUOTAS,
                 S.C1601,
                 C.CATEGORIARESULTANTE,
                 0 AS ID_CONVENIO,
                 NULL AS  NomConvPago,
                 0 AS ID_DOMINIO,
                 NULL DESCRIPCION,
                 NULL SITUACION_REVISTA,
                 ISNULL(HDP.PREVISION,0) AS PREVISION,
                 S.IVA_FINANCIADO,
                 S.IVA_PERCEPCION_FINANCIADO,
                 0, ---CFT_TEA
                 0, ---CFT_TNA
                 0, ---INT DEVEN VENCIDO
                 0, ---CAPITAL VENCIDO
                 ISNULL(CGR.IMPORTE_REAL,0) AS IMPORTE_VALOR_TASACION,
                 0 AS INTERESES_ADELANTADOS,
                 0 AS INT_VIGENTES,
                 0 AS TNA,
                 0 AS TASAINTERES,
                 (SELECT AVG(GRL.SALDO_AJUSTADO) FROM GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) WHERE GRL.SALDOS_JTS_OID = VA.JTS_OID_SALDO AND GRL.TZ_LOCK = 0 AND MONTH(GRL.FECHA) = MONTH(@FECHA_PROCESO) AND YEAR(GRL.FECHA) = YEAR(@FECHA_PROCESO)),
                 ---ROW_NUMBER() OVER(ORDER BY S.JTS_OID ASC),
                 ---DENSE_RANK() OVER (PARTITION BY S.JTS_OID ORDER BY s.JTS_OID ASC) AS RegistroxJTS,
                 S.JTS_OID,
                 0 AS ACCESORIOS, --OTROS ACCESORIOS
				 HDP.PORCENTAJE_AFECTACION AS AFORO,
                 0,
                 0 AS TIENE_GARANTIA
                 FROM CRE_HISTORICO_DEUDA_GARANTIAS HDP WITH(NOLOCK)
                 INNER JOIN VTA_SOBREGIROS VA WITH(NOLOCK) ON HDP.FECHA_PROCESO = @FECHA_PROCESO and HDP.TIPO_ASISTENCIA=''A'' AND HDP.SALDO_JTS_OID = VA.NRO_AUTORIZACION AND VA.ESTADO = 1 AND VA.TZ_LOCK = 0
                 INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = VA.JTS_OID_SALDO
                 INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON C.CODIGOCLIENTE = S.C1803 AND C.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON CP.TITULARIDAD = ''T'' AND CP.CODIGOCLIENTE = C.CODIGOCLIENTE AND CP.TZ_LOCK = 0
                 INNER JOIN CLI_DOCUMENTOSPFPJ DOC WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA 
                 AND DOC.TIPOPERSONA = C.TIPO AND DOC.TZ_LOCK = 0
                 -- LEFT JOIN VW_DEUDA_CLIENTES DC WITH(NOLOCK) ON DC.JTS_OID = S.JTS_OID AND DC.SALDO_DEUDA >= 0
                 LEFT JOIN CLI_PERSONASFISICAS PF WITH(NOLOCK) ON PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA AND PF.TZ_LOCK = 0
                 LEFT JOIN CLI_PERSONASJURIDICAS PJ WITH(NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA AND PJ.TZ_LOCK = 0
                 --LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID AND CG.TZ_LOCK = 0
				 LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = HDP.NRO_GARANTIA AND CGR.TZ_LOCK = 0
				 LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND CTG.TZ_LOCK = 0
				 LEFT JOIN CRE_CLASGARANTIAS CCG WITH(NOLOCK) ON CCG.PAIS_GARANTIA = CGR.PAIS_GARANTIA AND CCG.COD_SUBCLA_GARANTIA = CGR.COD_SUBCLAGARANTIA
				 AND CCG.TIPOGARANTIA = CGR.TIPOGARANTIA AND CCG.SUBTIPOGTIA = CGR.SUBTIPOGARANTIA
				 LEFT JOIN OPCIONES OPG WITH(NOLOCK) ON OPG.IDIOMA = ''E'' AND OPG.OPCIONINTERNA = CTG.TIPO_BCRA AND OPG.NUMERODECAMPO = 44448
                 INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = ISNULL(VA.NROLINEA, S.PRODUCTO) AND P.TZ_LOCK = 0
				 -- LEFT JOIN VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO_SL CLD WITH(NOLOCK) ON CLD.jts_oid = S.JTS_OID AND ISNUMERIC(CLD.numero) = 1
				 --LEFT JOIN HISTORICO_CALIF_X_SALDO HCS WITH(NOLOCK) ON HCS.JTS_PRESTAMO = S.JTS_OID 
				 --AND HCS.FECHA = (SELECT TOP 1 FECHA FROM HISTORICO_CALIF_X_SALDO WITH(NOLOCK) WHERE JTS_PRESTAMO = S.JTS_OID AND FECHA <= @FECHA_PROCESO ORDER BY FECHA DESC)
                 -- LEFT JOIN CRE_SALDOS CS WITH(NOLOCK) ON CS.SALDOS_JTS_OID = S.JTS_OID AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CONV_CONVENIOS_PAG CCP WITH(NOLOCK) ON CCP.ID_ConvPago = CS.ID_CONVENIO AND CCP.TZ_LOCK = 0
                 -- LEFT JOIN CONV_DOMINIOS CD WITH(NOLOCK) ON CD.ID_CONVENIO = CS.ID_CONVENIO AND CONVERT(VARCHAR,CD.ID_DOMINIO) = CS.JURISDICCION AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CRE_SOL_RECIBO_SUELDO SRS WITH(NOLOCK) ON SRS.SOLICITUD = S.C1704 AND SRS.CONVENIO = CS.ID_CONVENIO 
                 -- AND CONVERT(VARCHAR,SRS.JURIDICCION) = CS.JURISDICCION
                 ---LEFT JOIN CRE_HISTORICO_DEUDA_GARANTIAS HPD WITH(NOLOCK) ON (CASE WHEN HPD.TIPO_ASISTENCIA = ''A'' THEN VA.NRO_AUTORIZACION ELSE S.JTS_OID END) = HPD.SALDO_JTS_OID AND HPD.TIPO_ASISTENCIA IN (''A'', ''S'') AND HPD.FECHA_PROCESO = @FECHA_PROCESO
                 --LEFT JOIN (SELECT SALDO_JTS_OID, SUM(ISNULL(PREVISION,0)) AS PREVISION, TIPO_ASISTENCIA 
                 ---FROM CRE_HISTORICO_DEUDA_GARANTIAS WITH(NOLOCK) 
                 --WHERE FECHA_PROCESO = @FECHA_PROCESO and TIPO_ASISTENCIA IN (''A'', ''S'')
                 ---GROUP BY SALDO_JTS_OID, TIPO_ASISTENCIA) HPD
                 ---ON HPD.SALDO_JTS_OID = (CASE WHEN HPD.TIPO_ASISTENCIA = ''A'' THEN VA.NRO_AUTORIZACION ELSE S.JTS_OID END)
                 
                 WHERE S.TZ_LOCK = 0
			UNION ALL
				--CC sobregirada con acuerdo no utilizado
				SELECT DISTINCT
                 DOC.TIPODOCUMENTO,
                 DOC.NUMERODOCUMENTO,
                 CASE WHEN C.TIPO = ''F'' THEN PF.APELLIDOPATERNO + '' '' + PF.PRIMERNOMBRE ELSE PJ.RAZONSOCIAL END AS NOMBRE,
                 C.SUCURSALVINCULADA,
                 S.CUENTA,
                 ''N'' AS CUENTAORDEN,
                 P.C6283,
                 ISNULL(VA.NROLINEA, S.PRODUCTO),
                 P.C6251,
                 S.MONEDA,
                 S.SUCURSAL,
                 S.CUENTA AS OPERACION,
                 S.ORDINAL AS DESGLOSE,
                 '''' AS DESCRIPCION, ---CTG.DSC_TIPO_GARANTIA,
                 0 AS TIPO_BCRA,
                 0 AS NRO_GARANTIA,
                 0 AS IMPORTE_GARANTIZADO,
                 0 AS TIPO_GARANTIA,
                 VA.NRO_AUTORIZACION,
                 VA.SALDO_ACUERDO,
                 ISNULL(VA.IMPORTE,0) - ISNULL(VA.IMPORTE_CONSUMIDO,0) AS IMPORTE_NOUTILIZADO,
                 VA.FECHA_ALTA,
                 ISNULL(VA.PERIODO,0) AS PLAZO_ACUERDO,
                 DATEDIFF(DD,VA.FECHA_ALTA,@FECHA_PROCESO) AS DIAS_AC_CC,
                 C.CODIGOCLIENTE,
                 0 AS NUMERO_CHEQUE,
                 0 AS NUMERO_BOLETA,
                 0 AS NUM_TJC,
                 NULL AS ADMINISTRADORA,
                 0, --- AS Capital adeudado
                 0 AS DIAS_ATRASO,
                 S.C1621,
                 NULL AS PRIMER_VENC,
                 NULL AS VENCIMIENTO,
                 ---CASE WHEN S.C1785 = 6 THEN VA.FECHA_VENCIMIENTO WHEN S.C1785 = 1 THEN TMU. ELSE S.C1627 END AS FECHA_VENCIMIENTO,
                 0 AS CANT_CUOTAS,
                 S.C1601,
                 C.CATEGORIARESULTANTE,
                 0 AS ID_CONVENIO,
                 NULL AS  NomConvPago,
                 0 AS ID_DOMINIO,
                 NULL DESCRIPCION,
                 NULL SITUACION_REVISTA,
                 0 AS PREVISION,
                 S.IVA_FINANCIADO,
                 S.IVA_PERCEPCION_FINANCIADO,
                 0, ---CFT_TEA
                 0, ---CFT_TNA
                 0, ---INT DEVEN VENCIDO
                 0, ---CAPITAL VENCIDO
                 0 AS IMPORTE_VALOR_TASACION,
                 0 AS INTERESES_ADELANTADOS,
                 0 AS INT_VIGENTES,
                 0 AS TNA,
                 0 AS TASAINTERES,
                 (SELECT AVG(GRL.SALDO_AJUSTADO) FROM GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) WHERE GRL.SALDOS_JTS_OID = VA.JTS_OID_SALDO AND GRL.TZ_LOCK = 0 AND MONTH(GRL.FECHA) = MONTH(@FECHA_PROCESO) AND YEAR(GRL.FECHA) = YEAR(@FECHA_PROCESO)),
                 ---ROW_NUMBER() OVER(ORDER BY S.JTS_OID ASC),
                 ---DENSE_RANK() OVER (PARTITION BY S.JTS_OID ORDER BY s.JTS_OID ASC) AS RegistroxJTS,
                 S.JTS_OID,
                 0 AS ACCESORIOS, --OTROS ACCESORIOS
				 0 AS AFORO,
                 0,
                 0 AS TIENE_GARANTIA
                 FROM SALDOS S WITH(NOLOCK)
                 INNER JOIN VTA_SOBREGIROS VA WITH(NOLOCK) ON S.JTS_OID = VA.JTS_OID_SALDO AND VA.ESTADO = 1 AND VA.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON C.CODIGOCLIENTE = S.C1803 AND C.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON CP.TITULARIDAD = ''T'' AND CP.CODIGOCLIENTE = C.CODIGOCLIENTE AND CP.TZ_LOCK = 0
                 INNER JOIN CLI_DOCUMENTOSPFPJ DOC WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA 
                 AND DOC.TIPOPERSONA = C.TIPO AND DOC.TZ_LOCK = 0
                 -- LEFT JOIN VW_DEUDA_CLIENTES DC WITH(NOLOCK) ON DC.JTS_OID = S.JTS_OID AND DC.SALDO_DEUDA >= 0
                 LEFT JOIN CLI_PERSONASFISICAS PF WITH(NOLOCK) ON PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA AND PF.TZ_LOCK = 0
                 LEFT JOIN CLI_PERSONASJURIDICAS PJ WITH(NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA AND PJ.TZ_LOCK = 0
                 --LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID AND CG.TZ_LOCK = 0
				 --LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = HDP.NRO_GARANTIA AND CGR.TZ_LOCK = 0
				 --LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND CTG.TZ_LOCK = 0
				 --LEFT JOIN CRE_CLASGARANTIAS CCG WITH(NOLOCK) ON CCG.PAIS_GARANTIA = CGR.PAIS_GARANTIA AND CCG.COD_SUBCLA_GARANTIA = CGR.COD_SUBCLAGARANTIA
				 --AND CCG.TIPOGARANTIA = CGR.TIPOGARANTIA AND CCG.SUBTIPOGTIA = CGR.SUBTIPOGARANTIA
				 --LEFT JOIN OPCIONES OPG WITH(NOLOCK) ON OPG.IDIOMA = ''E'' AND OPG.OPCIONINTERNA = CTG.TIPO_BCRA AND OPG.NUMERODECAMPO = 44448
                 INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = ISNULL(VA.NROLINEA, S.PRODUCTO) AND P.TZ_LOCK = 0
				 -- LEFT JOIN VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO_SL CLD WITH(NOLOCK) ON CLD.jts_oid = S.JTS_OID AND ISNUMERIC(CLD.numero) = 1
				 --LEFT JOIN HISTORICO_CALIF_X_SALDO HCS WITH(NOLOCK) ON HCS.JTS_PRESTAMO = S.JTS_OID 
				 --AND HCS.FECHA = (SELECT TOP 1 FECHA FROM HISTORICO_CALIF_X_SALDO WITH(NOLOCK) WHERE JTS_PRESTAMO = S.JTS_OID AND FECHA <= @FECHA_PROCESO ORDER BY FECHA DESC)
                 -- LEFT JOIN CRE_SALDOS CS WITH(NOLOCK) ON CS.SALDOS_JTS_OID = S.JTS_OID AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CONV_CONVENIOS_PAG CCP WITH(NOLOCK) ON CCP.ID_ConvPago = CS.ID_CONVENIO AND CCP.TZ_LOCK = 0
                 -- LEFT JOIN CONV_DOMINIOS CD WITH(NOLOCK) ON CD.ID_CONVENIO = CS.ID_CONVENIO AND CONVERT(VARCHAR,CD.ID_DOMINIO) = CS.JURISDICCION AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CRE_SOL_RECIBO_SUELDO SRS WITH(NOLOCK) ON SRS.SOLICITUD = S.C1704 AND SRS.CONVENIO = CS.ID_CONVENIO 
                 -- AND CONVERT(VARCHAR,SRS.JURIDICCION) = CS.JURISDICCION
                 ---LEFT JOIN CRE_HISTORICO_DEUDA_GARANTIAS HPD WITH(NOLOCK) ON (CASE WHEN HPD.TIPO_ASISTENCIA = ''A'' THEN VA.NRO_AUTORIZACION ELSE S.JTS_OID END) = HPD.SALDO_JTS_OID AND HPD.TIPO_ASISTENCIA IN (''A'', ''S'') AND HPD.FECHA_PROCESO = @FECHA_PROCESO
                 --LEFT JOIN (SELECT SALDO_JTS_OID, SUM(ISNULL(PREVISION,0)) AS PREVISION, TIPO_ASISTENCIA 
                 ---FROM CRE_HISTORICO_DEUDA_GARANTIAS WITH(NOLOCK) 
                 --WHERE FECHA_PROCESO = @FECHA_PROCESO and TIPO_ASISTENCIA IN (''A'', ''S'')
                 ---GROUP BY SALDO_JTS_OID, TIPO_ASISTENCIA) HPD
                 ---ON HPD.SALDO_JTS_OID = (CASE WHEN HPD.TIPO_ASISTENCIA = ''A'' THEN VA.NRO_AUTORIZACION ELSE S.JTS_OID END)
                 WHERE S.TZ_LOCK = 0 AND VA.IMPORTE_CONSUMIDO=0 AND S.C1604 < 0
			UNION ALL
				--CC tipo Asisntencia S
				SELECT DISTINCT
                 DOC.TIPODOCUMENTO,
                 DOC.NUMERODOCUMENTO,
                 CASE WHEN C.TIPO = ''F'' THEN PF.APELLIDOPATERNO + '' '' + PF.PRIMERNOMBRE ELSE PJ.RAZONSOCIAL END AS NOMBRE,
                 C.SUCURSALVINCULADA,
                 S.CUENTA,
                 ''N'' AS CUENTAORDEN,
                 P.C6283,
                 S.PRODUCTO,
                 P.C6251,
                 S.MONEDA,
                 S.SUCURSAL,
                 S.CUENTA AS OPERACION,
                 S.ORDINAL AS DESGLOSE,
                 OPG.DESCRIPCION, ---CTG.DSC_TIPO_GARANTIA,
                 HDP.TIPO_BCRA,
                 ISNULL(HDP.NRO_GARANTIA,0) AS NRO_GARANTIA,
                 ISNULL(HDP.IMPORTE_CONTRACTUAL,0) AS IMPORTE_GARANTIZADO,
                 CTG.TIPO_GARANTIA,
                 0 AS NRO_AUTORIZACION,
                 0 AS SALDO_ACUERDO,
                 0 AS IMPORTE_NOUTILIZADO,
                 NULL AS FECHA_ALTA,
                 0 AS PLAZO_ACUERDO,
                 0 AS DIAS_AC_CC,
                 C.CODIGOCLIENTE,
                 0 AS NUMERO_CHEQUE,
                 0 AS NUMERO_BOLETA,
                 0 AS NUM_TJC,
                 NULL AS ADMINISTRADORA,
                 HDP.MONTO_GARANTIZADO, --- AS Capital adeudado
                 DATEDIFF(DD,S.ULT_FECHA_VIGENTE,@FECHA_PROCESO)+1 AS DIAS_ATRASO,
                 S.C1621,
                 NULL AS PRIMER_VENC,
                 NULL AS VENCIMIENTO,
                 ---CASE WHEN S.C1785 = 6 THEN VA.FECHA_VENCIMIENTO WHEN S.C1785 = 1 THEN TMU. ELSE S.C1627 END AS FECHA_VENCIMIENTO,
                 0 AS CANT_CUOTAS,
                 S.C1601,
                 C.CATEGORIARESULTANTE,
                 0 AS ID_CONVENIO,
                 NULL AS  NomConvPago,
                 0 AS ID_DOMINIO,
                 NULL DESCRIPCION,
                 NULL SITUACION_REVISTA,
                 ISNULL(HDP.PREVISION,0) AS PREVISION,
                 S.IVA_FINANCIADO,
                 S.IVA_PERCEPCION_FINANCIADO,
                 0, ---CFT_TEA
                 0, ---CFT_TNA
                 0, ---INT DEVEN VENCIDO
                 0, ---CAPITAL VENCIDO
                 ISNULL(CGR.IMPORTE_REAL,0) AS IMPORTE_VALOR_TASACION,
                 0 AS INTERESES_ADELANTADOS,
                 0 AS INT_VIGENTES,
                 0 AS TNA,
                 0 AS TASAINTERES,
                 (SELECT AVG(GRL.SALDO_AJUSTADO) FROM GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) WHERE GRL.SALDOS_JTS_OID = S.JTS_OID AND GRL.TZ_LOCK = 0 AND MONTH(GRL.FECHA) = MONTH(@FECHA_PROCESO) AND YEAR(GRL.FECHA) = YEAR(@FECHA_PROCESO)),
                 ---ROW_NUMBER() OVER(ORDER BY S.JTS_OID ASC),
                 ---DENSE_RANK() OVER (PARTITION BY S.JTS_OID ORDER BY s.JTS_OID ASC) AS RegistroxJTS,
                 S.JTS_OID,
                 0 AS ACCESORIOS, --OTROS ACCESORIOS
				 HDP.PORCENTAJE_AFECTACION AS AFORO,
                 0,
                 0 AS TIENE_GARANTIA
                 FROM CRE_HISTORICO_DEUDA_GARANTIAS HDP WITH(NOLOCK)
                 --LEFT JOIN VTA_SOBREGIROS VA WITH(NOLOCK) ON HDP.FECHA_PROCESO = @FECHA_PROCESO and HDP.TIPO_ASISTENCIA IN (''A'', ''S'') AND HDP.SALDO_JTS_OID = (CASE WHEN HDP.TIPO_ASISTENCIA = ''A'' THEN VA.NRO_AUTORIZACION ELSE VA.JTS_OID_SALDO END) AND VA.ESTADO = 1 AND VA.TZ_LOCK = 0
                 INNER JOIN SALDOS S WITH(NOLOCK) ON HDP.FECHA_PROCESO = @FECHA_PROCESO and HDP.TIPO_ASISTENCIA=''S'' AND S.JTS_OID = HDP.SALDO_JTS_OID
                 INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON C.CODIGOCLIENTE = S.C1803 AND C.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON CP.TITULARIDAD = ''T'' AND CP.CODIGOCLIENTE = C.CODIGOCLIENTE AND CP.TZ_LOCK = 0
                 INNER JOIN CLI_DOCUMENTOSPFPJ DOC WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA 
                 AND DOC.TIPOPERSONA = C.TIPO AND DOC.TZ_LOCK = 0
                 -- LEFT JOIN VW_DEUDA_CLIENTES DC WITH(NOLOCK) ON DC.JTS_OID = S.JTS_OID AND DC.SALDO_DEUDA >= 0
                 LEFT JOIN CLI_PERSONASFISICAS PF WITH(NOLOCK) ON PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA AND PF.TZ_LOCK = 0
                 LEFT JOIN CLI_PERSONASJURIDICAS PJ WITH(NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA AND PJ.TZ_LOCK = 0
                 --LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID AND CG.TZ_LOCK = 0
				 LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = HDP.NRO_GARANTIA AND CGR.TZ_LOCK = 0
				 LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND CTG.TZ_LOCK = 0
				 LEFT JOIN CRE_CLASGARANTIAS CCG WITH(NOLOCK) ON CCG.PAIS_GARANTIA = CGR.PAIS_GARANTIA AND CCG.COD_SUBCLA_GARANTIA = CGR.COD_SUBCLAGARANTIA
				 AND CCG.TIPOGARANTIA = CGR.TIPOGARANTIA AND CCG.SUBTIPOGTIA = CGR.SUBTIPOGARANTIA
				 LEFT JOIN OPCIONES OPG WITH(NOLOCK) ON OPG.IDIOMA = ''E'' AND OPG.OPCIONINTERNA = CTG.TIPO_BCRA AND OPG.NUMERODECAMPO = 44448
                 INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = S.PRODUCTO AND P.TZ_LOCK = 0
				 -- LEFT JOIN VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO_SL CLD WITH(NOLOCK) ON CLD.jts_oid = S.JTS_OID AND ISNUMERIC(CLD.numero) = 1
				 --LEFT JOIN HISTORICO_CALIF_X_SALDO HCS WITH(NOLOCK) ON HCS.JTS_PRESTAMO = S.JTS_OID 
				 --AND HCS.FECHA = (SELECT TOP 1 FECHA FROM HISTORICO_CALIF_X_SALDO WITH(NOLOCK) WHERE JTS_PRESTAMO = S.JTS_OID AND FECHA <= @FECHA_PROCESO ORDER BY FECHA DESC)
                 -- LEFT JOIN CRE_SALDOS CS WITH(NOLOCK) ON CS.SALDOS_JTS_OID = S.JTS_OID AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CONV_CONVENIOS_PAG CCP WITH(NOLOCK) ON CCP.ID_ConvPago = CS.ID_CONVENIO AND CCP.TZ_LOCK = 0
                 -- LEFT JOIN CONV_DOMINIOS CD WITH(NOLOCK) ON CD.ID_CONVENIO = CS.ID_CONVENIO AND CONVERT(VARCHAR,CD.ID_DOMINIO) = CS.JURISDICCION AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CRE_SOL_RECIBO_SUELDO SRS WITH(NOLOCK) ON SRS.SOLICITUD = S.C1704 AND SRS.CONVENIO = CS.ID_CONVENIO 
                 -- AND CONVERT(VARCHAR,SRS.JURIDICCION) = CS.JURISDICCION
                 ---LEFT JOIN CRE_HISTORICO_DEUDA_GARANTIAS HPD WITH(NOLOCK) ON (CASE WHEN HPD.TIPO_ASISTENCIA = ''A'' THEN VA.NRO_AUTORIZACION ELSE S.JTS_OID END) = HPD.SALDO_JTS_OID AND HPD.TIPO_ASISTENCIA IN (''A'', ''S'') AND HPD.FECHA_PROCESO = @FECHA_PROCESO
                 --LEFT JOIN (SELECT SALDO_JTS_OID, SUM(ISNULL(PREVISION,0)) AS PREVISION, TIPO_ASISTENCIA 
                 ---FROM CRE_HISTORICO_DEUDA_GARANTIAS WITH(NOLOCK) 
                 --WHERE FECHA_PROCESO = @FECHA_PROCESO and TIPO_ASISTENCIA IN (''A'', ''S'')
                 ---GROUP BY SALDO_JTS_OID, TIPO_ASISTENCIA) HPD
                 ---ON HPD.SALDO_JTS_OID = (CASE WHEN HPD.TIPO_ASISTENCIA = ''A'' THEN VA.NRO_AUTORIZACION ELSE S.JTS_OID END)
                 
                 WHERE S.TZ_LOCK = 0 AND
                 (S.C1785 = 2 AND S.C1651<>''1'')
               UNION ALL
               --CC con acuerdo sin sobregiro o con acuerdo no utilizado
				SELECT DISTINCT
                 DOC.TIPODOCUMENTO,
                 DOC.NUMERODOCUMENTO,
                 CASE WHEN C.TIPO = ''F'' THEN PF.APELLIDOPATERNO + '' '' + PF.PRIMERNOMBRE ELSE PJ.RAZONSOCIAL END AS NOMBRE,
                 C.SUCURSALVINCULADA,
                 S.CUENTA,
                 ''N'' AS CUENTAORDEN,
                 P.C6283,
                 ISNULL(VA.NROLINEA, S.PRODUCTO),
                 P.C6251,
                 S.MONEDA,
                 S.SUCURSAL,
                 S.CUENTA AS OPERACION,
                 S.ORDINAL AS DESGLOSE,
                 '''' AS DESCRIPCION, ---CTG.DSC_TIPO_GARANTIA,
                 0 AS TIPO_BCRA,
                 0 AS NRO_GARANTIA,
                 0 AS IMPORTE_GARANTIZADO,
                 0 AS TIPO_GARANTIA,
                 VA.NRO_AUTORIZACION, --- Acuerdo
                 VA.SALDO_ACUERDO, --- Saldo acuerdo
                 ISNULL(VA.IMPORTE,0) - ISNULL(VA.IMPORTE_CONSUMIDO,0) AS IMPORTE_NOUTILIZADO, ---IMPORTE_NOUTILIZADO
                 VA.FECHA_ALTA, ---FECHA_ALTA
                 ISNULL(VA.PERIODO,0) AS PLAZO_ACUERDO, ---PLAZO_ACUERDO
                 DATEDIFF(DD,VA.FECHA_ALTA,@FECHA_PROCESO) AS DIAS_AC_CC, ---DIAS_AC_CC
                 C.CODIGOCLIENTE,
                 0 AS NUMERO_CHEQUE,
                 0 AS NUMERO_BOLETA,
                 0 AS NUM_TJC,
                 NULL AS ADMINISTRADORA,
                 0, --- AS Capital adeudado
                 0 AS DIAS_ATRASO,
                 S.C1621,
                 NULL AS PRIMER_VENC,
                 NULL AS VENCIMIENTO,
                 ---CASE WHEN S.C1785 = 6 THEN VA.FECHA_VENCIMIENTO WHEN S.C1785 = 1 THEN TMU. ELSE S.C1627 END AS FECHA_VENCIMIENTO,
                 0 AS CANT_CUOTAS,
                 S.C1601,
                 C.CATEGORIARESULTANTE,
                 0 AS ID_CONVENIO,
                 NULL AS  NomConvPago,
                 0 AS ID_DOMINIO,
                 NULL DESCRIPCION,
                 NULL SITUACION_REVISTA,
                 0 AS PREVISION,
                 S.IVA_FINANCIADO,
                 S.IVA_PERCEPCION_FINANCIADO,
                 0, ---CFT_TEA
                 0, ---CFT_TNA
                 0, ---INT DEVEN VENCIDO
                 0, ---CAPITAL VENCIDO
                 0 AS IMPORTE_VALOR_TASACION,
                 0 AS INTERESES_ADELANTADOS,
                 0 AS INT_VIGENTES,
                 0 AS TNA,
                 0 AS TASAINTERES,
                 (SELECT AVG(GRL.SALDO_AJUSTADO) FROM GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) WHERE GRL.SALDOS_JTS_OID = S.JTS_OID AND GRL.TZ_LOCK = 0 AND MONTH(GRL.FECHA) = MONTH(@FECHA_PROCESO) AND YEAR(GRL.FECHA) = YEAR(@FECHA_PROCESO)),
                 ---ROW_NUMBER() OVER(ORDER BY S.JTS_OID ASC),
                 ---DENSE_RANK() OVER (PARTITION BY S.JTS_OID ORDER BY s.JTS_OID ASC) AS RegistroxJTS,
                 S.JTS_OID,
                 0 AS ACCESORIOS, --OTROS ACCESORIOS
                 0 AS AFORO,
                 0,
                 0 AS TIENE_GARANTIA
                 FROM SALDOS S WITH(NOLOCK) 
                 INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON C.CODIGOCLIENTE = S.C1803 AND C.TZ_LOCK = 0
                 INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON CP.TITULARIDAD = ''T'' AND CP.CODIGOCLIENTE = C.CODIGOCLIENTE AND CP.TZ_LOCK = 0
                 INNER JOIN CLI_DOCUMENTOSPFPJ DOC WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA 
                 AND DOC.TIPOPERSONA = C.TIPO AND DOC.TZ_LOCK = 0
                 INNER JOIN VTA_SOBREGIROS VA WITH(NOLOCK) ON VA.JTS_OID_SALDO = S.JTS_OID AND VA.ESTADO = 1 AND VA.TZ_LOCK = 0
                 INNER JOIN PRODUCTOS P WITH(NOLOCK) ON P.C6250 = ISNULL(VA.NROLINEA, S.PRODUCTO) AND P.TZ_LOCK = 0
                 -- LEFT JOIN VW_DEUDA_CLIENTES DC WITH(NOLOCK) ON DC.JTS_OID = S.JTS_OID AND DC.SALDO_DEUDA >= 0
                 LEFT JOIN CLI_PERSONASFISICAS PF WITH(NOLOCK) ON PF.NUMEROPERSONAFISICA = CP.NUMEROPERSONA AND PF.TZ_LOCK = 0
                 LEFT JOIN CLI_PERSONASJURIDICAS PJ WITH(NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = CP.NUMEROPERSONA AND PJ.TZ_LOCK = 0
                 --LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID AND CG.TZ_LOCK = 0
				 --LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA AND CGR.TZ_LOCK = 0
				 --LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND CTG.TZ_LOCK = 0
				 --LEFT JOIN CRE_CLASGARANTIAS CCG WITH(NOLOCK) ON CCG.PAIS_GARANTIA = CGR.PAIS_GARANTIA AND CCG.COD_SUBCLA_GARANTIA = CGR.COD_SUBCLAGARANTIA
				 --AND CCG.TIPOGARANTIA = CGR.TIPOGARANTIA AND CCG.SUBTIPOGTIA = CGR.SUBTIPOGARANTIA
				 --LEFT JOIN OPCIONES OPG WITH(NOLOCK) ON OPG.IDIOMA = ''E'' AND OPG.OPCIONINTERNA = CTG.TIPO_BCRA AND OPG.NUMERODECAMPO = 44448
				 -- LEFT JOIN VW_CRE_DOCUMENTOS_DESC_O_AL_COBRO_SL CLD WITH(NOLOCK) ON CLD.jts_oid = S.JTS_OID AND ISNUMERIC(CLD.numero) = 1
				 --LEFT JOIN HISTORICO_CALIF_X_SALDO HCS WITH(NOLOCK) ON HCS.JTS_PRESTAMO = S.JTS_OID 
				 --AND HCS.FECHA = (SELECT TOP 1 FECHA FROM HISTORICO_CALIF_X_SALDO WITH(NOLOCK) WHERE JTS_PRESTAMO = S.JTS_OID AND FECHA <= @FECHA_PROCESO ORDER BY FECHA DESC)
                 -- LEFT JOIN CRE_SALDOS CS WITH(NOLOCK) ON CS.SALDOS_JTS_OID = S.JTS_OID AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CONV_CONVENIOS_PAG CCP WITH(NOLOCK) ON CCP.ID_ConvPago = CS.ID_CONVENIO AND CCP.TZ_LOCK = 0
                 -- LEFT JOIN CONV_DOMINIOS CD WITH(NOLOCK) ON CD.ID_CONVENIO = CS.ID_CONVENIO AND CONVERT(VARCHAR,CD.ID_DOMINIO) = CS.JURISDICCION AND CS.TZ_LOCK = 0
                 -- LEFT JOIN CRE_SOL_RECIBO_SUELDO SRS WITH(NOLOCK) ON SRS.SOLICITUD = S.C1704 AND SRS.CONVENIO = CS.ID_CONVENIO 
                 -- AND CONVERT(VARCHAR,SRS.JURIDICCION) = CS.JURISDICCION
                 ---LEFT JOIN CRE_HISTORICO_DEUDA_GARANTIAS HPD WITH(NOLOCK) ON (CASE WHEN HPD.TIPO_ASISTENCIA = ''A'' THEN VA.NRO_AUTORIZACION ELSE S.JTS_OID END) = HPD.SALDO_JTS_OID AND HPD.TIPO_ASISTENCIA IN (''A'', ''S'') AND HPD.FECHA_PROCESO = @FECHA_PROCESO
                 --LEFT JOIN (SELECT SALDO_JTS_OID, SUM(ISNULL(PREVISION,0)) AS PREVISION, TIPO_ASISTENCIA 
                 --FROM CRE_HISTORICO_DEUDA_GARANTIAS WITH(NOLOCK) 
                 --WHERE FECHA_PROCESO = @FECHA_PROCESO and TIPO_ASISTENCIA = ''S''
                 --GROUP BY SALDO_JTS_OID, TIPO_ASISTENCIA) HPD
                 --ON HPD.SALDO_JTS_OID = S.JTS_OID
                 WHERE S.TZ_LOCK = 0 AND
                 (S.C1785 = 2 AND S.C1651<>''1'')
                 AND S.C1621 <= @FECHA_PROCESO
                 AND S.C1604 >= 0 AND S.C1683 <> 0
                 ORDER BY C.CODIGOCLIENTE
                 
				--Coloco una marca de si el jts tiene garantía o no que servirá luego para componer la deuda en el memo_cabecera
                UPDATE I
                SET I.TIENE_GARANTIA=1
                FROM @INFO_GENERAL I
                WHERE EXISTS (SELECT * FROM CRE_HISTORICO_DEUDA_GARANTIAS HD WITH(NOLOCK) where HD.SALDO_JTS_OID = I.SALDO_JTS_OID
                AND FECHA_PROCESO=@FECHA_PROCESO AND HD.NRO_GARANTIA<>0);
				
				--UPDATEO NRO_CHEQUE para producto 22130
				UPDATE I
                SET I.NUMERO_CHEQUE=CH.NUMERO_CHEQUE
                FROM @INFO_GENERAL I
                INNER JOIN SALDOS S2 WITH(NOLOCK) on s2.jts_oid = I.SALDO_JTS_OID and s2.c1704<>0 and s2.PRODUCTO=22130 and s2.tz_lock=0
				INNER JOIN SALDOS S3 WITH(NOLOCK) on s2.c1704 = s3.c1704 and s3.tz_lock=0
				INNER JOIN CLE_CHEQUES_SALIENTE ch WITH(NOLOCK) ON ch.JTS_OID_DESCUENTO=s3.JTS_OID;
              	
              	--UPDATEO NRO_BOLETA para producto 22130
				UPDATE I
                SET I.NUMERO_BOLETA=CH.NUMERO_DEPOSITO
                FROM @INFO_GENERAL I
                INNER JOIN SALDOS S2 WITH(NOLOCK) on s2.jts_oid = I.SALDO_JTS_OID and s2.c1704<>0 and s2.PRODUCTO=22130 and s2.tz_lock=0
				INNER JOIN SALDOS S3 WITH(NOLOCK) on s2.c1704 = s3.c1704 and s3.tz_lock=0
				INNER JOIN CLE_CHEQUES_SALIENTE ch WITH(NOLOCK) ON ch.JTS_OID_DESCUENTO=s3.JTS_OID;
              	
              	--Si hay mas de un acuerdo con importe no utilizado solo dejo 1 de ellos con No Uilizado <> 0
              	WITH AcuerdosConMultiplesRegistros AS
				(select t.*, ROW_NUMBER() OVER (PARTITION BY t.NUMERO_ACUERDO order by t.NUMERO_ACUERDO) AS NUMERO 
				FROM (SELECT md.* FROM @INFO_GENERAL md WHERE md.ACUERDO_NO_UTILIZADO >0) AS t)
				UPDATE I
				SET I.ACUERDO_NO_UTILIZADO = 0
				FROM @INFO_GENERAL I
				WHERE I.NUMERO_ACUERDO IN (
    				SELECT NUMERO_ACUERDO
    				FROM AcuerdosConMultiplesRegistros ar WHERE ar.numero>1
				);
                
                 INSERT INTO MEMO_DETALLE  
                 (FECHA_INFO,
                  NUMERAL,
                  TIPO_DOC,
                  NUM_DOC,
                  SUC_CLIENTE,
                  NOMBRE_APELLIDO,
                  CUENTA_CLI,
                  CUENTA_ORDEN,
                  FAMILIA,
                  PRODUCTO,
                  DESC_PROD,
                  TIPO_GARANTIA_Desc,
                  Tipo_GTIA_BCRA,
                  TIPO_INST_NBCH,
                  COD_MONEDA,
                  SUC_PRODUCTO,
                  OPERACION,
                  DESGLOSE,
                  NRO_ACUERDO,
                  NRO_BOLETA,
                  NRO_CHEQUE,
                  NRO_TARJETA_CRE,
                  ADMIN_TARJ_CRED,
                  SALDO_CAPITAL,
                  INT_DEVEN_COBRAR_CONT,
                  INT_ADELANTADOS,
                  IVA_FINANCIADO,
                  RG_FINANCIADO,
                  PREVISION,
                  CAPITAL_VENCIDO,
                  INT_DEVEN_VENC,
                  CLASIFICACION,
                  CAPITAL_ORIGINAL,
                  CANTIDAD_CUOTAS,
                  FECHA_ALTA_OPER,
                  FECHA_1ERVTO_IMPAGO,
                  FECHA_VTO,
                  DIAS_ATRASO,
                  TASA_NOM_ANUAL,
                  TNA_ORIGINAL,
                  PROM_MENS_SDOS_DIAR,
                  MONTO_ACUERDO_CC,
                  ACUERDO_NO_UTILIZ,
                  FECHA_ALTA_AC_CC,
                  PLAZO_AC_CC,
                  DIAS_CONSEC_SDO_DEUD,
                  CONVENIO,
                  NOMBRE_CONVENIO,
                  JURISDICCION,
                  DENOM_JURISD,
                  SIT_REVISTA,
                  NRO_GARANTIA,
                  IMP_GARANT,
                  IMP_VALOR_TASACION,
                  CFT_TNA,
                  CFT_TEA,
                  CLIENTE,
                  TZ_LOCK,
                  SEGURO_FINANC,
                  OTROS_ACCESORIOS,
                  AFORO,
                  Ajuste_NIIF,
                  SALDO_JTS_OID,
                  TIENE_GARANTIA
                 )
                 (SELECT
                 @FECHA_PROCESO,
                 ROW_NUMBER() OVER(ORDER BY SALDO_JTS_OID ASC, OPERACION ASC),
                 TIPO_DOCUMENTO,
                 NUMERO_DOC,
                 SUCURSAL_CLIENTE,
                 NOMBRE,
                 CUENTA,
                 CUENTAORDEN,
                 FAMILIA,
                 PRODUCTO,
                 DESCRPCION_PRODUCTO,
                 ISNULL(TIPO_GARANTIA,''''),
                 GARANTIA_BCRA,
                 GARANTIA_INTERNA,
                 MONEDA,
                 SUCURSAL_PROD,
                 OPERACION,
                 DESGLOSE,
                 NUMERO_ACUERDO,
                 NUMERO_BOLETA,
                 NUMERO_CHEQUE,
                 NUM_TARJETA,
                 ADMINISTRADORA,
                 CASE WHEN MONEDA = 2 THEN SALDO_DEUDA * @COTIZACION ELSE SALDO_DEUDA END,
                 CASE WHEN MONEDA = 2 THEN INT_DEVEN_NOPAGADOS * @COTIZACION ELSE INT_DEVEN_NOPAGADOS END,
                 CASE WHEN MONEDA = 2 THEN INTERESES_ADELANTADOS * @COTIZACION ELSE INTERESES_ADELANTADOS END,
                 CASE WHEN MONEDA = 2 THEN IVA_FINANCIADO * @COTIZACION ELSE IVA_FINANCIADO END,
                 CASE WHEN MONEDA = 2 THEN RG_FINANCIADO * @COTIZACION ELSE RG_FINANCIADO END,
                 CASE WHEN MONEDA = 2 THEN PREVISION * @COTIZACION ELSE PREVISION END,
                 CASE WHEN MONEDA = 2 THEN CAPITAL_VENCIDO * @COTIZACION ELSE CAPITAL_VENCIDO END,
                 CASE WHEN MONEDA = 2 THEN INT_DEVEN_VENCIDO * @COTIZACION ELSE INT_DEVEN_VENCIDO END,
                 CLASIFICACION,
                 CAPITAL_INICIAL, --- Capital original
                 CANT_CUOTAS,
                 FECHA_ALTA,
                 PRIMER_VENCIMIENTO,
                 FECHA_VENCIMIENTO,
                 DIAS_ATRASO,
                 TNA,
                 TNA_ORIGINAL,
                 CASE WHEN MONEDA = 2 THEN PROMEDIO_MENSUAL * @COTIZACION ELSE PROMEDIO_MENSUAL END,
                 CASE WHEN MONEDA = 2 THEN MONTO_ACUERDO * @COTIZACION ELSE MONTO_ACUERDO END,
                 CASE WHEN MONEDA = 2 THEN ACUERDO_NO_UTILIZADO * @COTIZACION ELSE ACUERDO_NO_UTILIZADO END,
                 FECHA_ALTA_AC,
                 PLAZO_ACUERDO,
                 DIAS_AC_CC,
                 CONVENIO,
                 NOMBRE_CONVENIO,
                 CONVERT(VARCHAR,JURISDICCION),
                 DENOM_JURISDICCION,
                 SITUACION_REVISTA,
                 NUM_GARANTIA,
                 CASE WHEN MONEDA = 2 THEN IMPORTE_GARANTIA * @COTIZACION ELSE IMPORTE_GARANTIA END,
                 CASE WHEN MONEDA = 2 THEN IMP_VALOR_TASACION * @COTIZACION ELSE IMP_VALOR_TASACION END,
                 CFT_TNA,
                 CFT_TEA,
                 CLIENTE,
                 0,
                 0,
                 OTROS_ACCESORIOS,
                 CASE WHEN MONEDA = 2 THEN AFORO * @COTIZACION ELSE AFORO END,
                 CASE WHEN MONEDA = 2 THEN AJUSTE_NIIF * @COTIZACION ELSE AJUSTE_NIIF END,
                 SALDO_JTS_OID,
                 TIENE_GARANTIA
                 FROM @INFO_GENERAL 
                 WHERE (SALDO_DEUDA+INT_DEVEN_NOPAGADOS+IVA_FINANCIADO+RG_FINANCIADO+PREVISION+OTROS_ACCESORIOS+ACUERDO_NO_UTILIZADO) > 0
                 )
                 
              
                
                  	 
			           BEGIN
			
			            SET @P_RET_PROCESO = 1
			
			            SET @P_MSG_PROCESO = ''La tabla de memos detalle ha sido cargada correctamente''
			
			            DECLARE
			               @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$5 varchar(8000)
			               
			               SET @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$5 = ''I''
			
			            EXECUTE PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
			               @P_ID_PROCESO = @P_ID_PROCESO, 
			               @P_FCH_PROCESO = @P_DT_PROCESO, 
			               @P_NOM_PACKAGE = ''PA_MEMOS'', 
			               @P_COD_ERROR = @P_RET_PROCESO, 
			               @P_MSG_ERROR = @P_MSG_PROCESO, 
			               @P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$5
			         END
			         
			         
					 BEGIN
					 
					   DECLARE @CANTCAMP_ NUMERIC(10)
					   
					   SET @CANTCAMP_ = (SELECT COUNT(1) FROM MEMO_DETALLE WITH(NOLOCK) WHERE FECHA_INFO = @FECHA_PROCESO)
					 
					   SET @P_RET_PROCESO = 1
					 
			           SET @P_MSG_PROCESO = ''Se agregaron '' + ISNULL(CAST(@CANTCAMP_ AS varchar(max)), '''') + '' a memos detalle''
			
			            DECLARE
			               @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$6 varchar(8000)
			               
			               SET @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$6 = ''I''
			
			    
			            EXECUTE PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
			               @P_ID_PROCESO = @P_ID_PROCESO, 
			               @P_FCH_PROCESO = @P_DT_PROCESO, 
			               @P_NOM_PACKAGE = ''PA_MEMOS_DETALLE'', 
			               @P_COD_ERROR = @P_RET_PROCESO, 
			               @P_MSG_ERROR = @P_MSG_PROCESO, 
			               @P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$6
			
			         END          
              END
             
              

              END TRY
              
              BEGIN CATCH
              	BEGIN	
         
				  SET @P_RET_PROCESO = 3
					
				  SET @P_MSG_PROCESO = ''Ingreso de memos Finalizo con Errores: ''+ ERROR_MESSAGE() + '' '' + CONVERT(VARCHAR,ERROR_LINE())
					         
				  DECLARE
					@PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$4 varchar(8000)
					
					SET @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$4 = ''E''
							
				  EXECUTE dbo.PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
					@P_ID_PROCESO = @P_ID_PROCESO, 
					@P_FCH_PROCESO = @P_DT_PROCESO, 
					@P_NOM_PACKAGE = ''PA_MEMOS_DETALLE - Error'', 
					@P_COD_ERROR = @P_RET_PROCESO, 
					@P_MSG_ERROR = @P_MSG_PROCESO, 
					@P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$4
					
				END
              END CATCH
																	  

   END
')