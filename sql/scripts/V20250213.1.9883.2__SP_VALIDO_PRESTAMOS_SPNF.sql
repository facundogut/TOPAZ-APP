EXECUTE('
ALTER PROCEDURE dbo.SP_VALIDO_PRESTAMOS_SPNF
   @P_CLIENTE numeric(15),
   @P_SALIDA NUMERIC(1) OUTPUT
AS 
   BEGIN
   
   	  DECLARE @P_VIGENTES NUMERIC (3) = (SELECT DIASINMOVILIZADA FROM CRE_PARAMETROS WHERE CODIGO = 164)
   	  DECLARE @P_MESES NUMERIC (3) = (SELECT DIASINMOVILIZADA FROM CRE_PARAMETROS WHERE CODIGO = 163)
   	  DECLARE @P_DIASHABILES NUMERIC (3) = (SELECT DIASINMOVILIZADA FROM CRE_PARAMETROS WHERE CODIGO = 162)
   	  -- Se cambia para controlar que si tiene asistencias vencidas no permita solicitar una nueva
   	  DECLARE @P_CANTVIVOS NUMERIC (3) = (SELECT count(*) FROM SALDOS WHERE C1604 < 0 AND TZ_LOCK = 0 AND C1785 = 5 AND C1803 = @P_CLIENTE AND PRODUCTO IN (SELECT C6250 FROM PRODUCTOS WHERE TZ_LOCK = 0 AND C6800 = ''SP'')
   	  									  AND C1627<(SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK)))
   	  DECLARE @P_CANTCANCELADOS NUMERIC (3) = 0
   
   	  SET @P_SALIDA = 0
   	  
   	  IF (@P_CANTVIVOS > 0)
   	  	SET @P_SALIDA = 1
   	  	
   	  IF (@P_SALIDA = 0)
   	  	BEGIN
   	  	
			SELECT @P_CANTCANCELADOS = count(*)
			FROM SALDOS 
			WHERE C1604 = 0 AND TZ_LOCK = 0 AND C1785 = 5 AND C1803 = @P_CLIENTE AND 
			PRODUCTO IN (SELECT C6250 FROM PRODUCTOS WHERE TZ_LOCK = 0 AND C6800 = ''SP'') AND
			C1621 >= (SELECT DATEADD(MONTH,-@P_MESES,FECHAPROCESO) FROM PARAMETROS) AND 
			C1629 > (SELECT dbo.sumarDiasHabiles (C1621, @P_DIASHABILES))   	  	
			
			IF (@P_CANTCANCELADOS > @P_VIGENTES)
				SET @P_SALIDA = 1
				
   	  	END
   END
')