EXECUTE('
IF OBJECT_ID (''dbo.VW_CLIENTE_PFPJ'') IS NOT NULL
	DROP VIEW dbo.VW_CLIENTE_PFPJ
')

EXECUTE('
CREATE VIEW VW_CLIENTE_PFPJ
AS
/***************************************************************
DESCRIPCION: Vista para obtener las personas naturales y juridicas con su documento y codigo de cliente
Para un documento se devuelve solo un cliente o persona
***************************************************************/

SELECT z.TIPODOCUMENTO, z.NUMERODOCUMENTO, (CASE WHEN NROREGISTRO = 0 THEN NULL ELSE Z.CODIGOCLIENTE END) AS CODIGOCLIENTE, z.NOMBRECLIENTE, z.NUMEROPERSONA, z.TIPO
FROM
(
SELECT DOC.TIPODOCUMENTO, DOC.NUMERODOCUMENTO,  CP.CODIGOCLIENTE, 
   CASE WHEN doc.TIPOPERSONA = ''F'' THEN ((CASE WHEN APELLIDOPATERNO = '' '' THEN '''' ELSE APELLIDOPATERNO END) +
										(CASE WHEN APELLIDOMATERNO = '' '' THEN '''' ELSE '' '' + APELLIDOMATERNO END) + 
										(CASE WHEN PRIMERNOMBRE = '' '' THEN '''' ELSE '' '' + PRIMERNOMBRE END) +
										(CASE WHEN SEGUNDONOMBRE = '' '' THEN '''' ELSE '' '' + SEGUNDONOMBRE END)) 
	    WHEN doc.TIPOPERSONA = ''J'' THEN jur.RAZONSOCIAL END AS NOMBRECLIENTE, 
   CASE WHEN doc.TIPOPERSONA = ''F'' THEN nat.NUMEROPERSONAFISICA
   	    WHEN doc.TIPOPERSONA = ''J'' THEN jur.NUMEROPERSONAJURIDICA END NUMEROPERSONA, 
   doc.TIPOPERSONA AS TIPO,
   (CASE WHEN (SELECT count(1)
    		  FROM CLI_ClientePersona CPX WITH(NOLOCK)
    		  WHERE CPX.TZ_LOCK = 0
      			AND CPX.CODIGOCLIENTE = CP.CODIGOCLIENTE) > 1 
           AND (SELECT count(DISTINCT CODIGOCLIENTE)
		        FROM CLI_ClientePersona CPX WITH(NOLOCK)
		        WHERE CPX.NUMEROPERSONA = CP.NUMEROPERSONA
		          AND CPX.TZ_LOCK = 0) = 1 THEN 0 
		 ELSE (SELECT count(1)
    		  FROM CLI_ClientePersona CPX WITH(NOLOCK)
    		  WHERE CPX.CODIGOCLIENTE = CP.CODIGOCLIENTE
    		    AND CPX.TZ_LOCK = 0) END)  AS NROREGISTRO
FROM CLI_DocumentosPFPJ DOC
  LEFT JOIN CLI_PERSONASFISICAS nat ON nat.NUMEROPERSONAFISICA = DOC.NUMEROPERSONAFJ AND nat.TZ_LOCK = 0
  LEFT JOIN CLI_PERSONASJURIDICAS jur ON jur.NUMEROPERSONAJURIDICA = DOC.NUMEROPERSONAFJ AND jur.TZ_LOCK = 0
  LEFT JOIN CLI_ClientePersona CP WITH(NOLOCK) ON DOC.NUMEROPERSONAFJ = CP.NUMEROPERSONA AND CP.TZ_LOCK = 0
  LEFT JOIN CLI_CLIENTES cli WITH(NOLOCK) ON CP.CODIGOCLIENTE = cli.CODIGOCLIENTE AND cli.TZ_LOCK = 0
WHERE DOC.TZ_LOCK = 0
) z
WHERE z.NROREGISTRO <= 1

')