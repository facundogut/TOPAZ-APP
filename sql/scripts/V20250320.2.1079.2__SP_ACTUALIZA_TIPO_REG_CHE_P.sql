EXECUTE('
	CREATE OR ALTER PROCEDURE [dbo].[SP_ACTUALIZA_TIPO_REG_CHE_P]
		@P_ID_PROCESO float(53),
		@P_DT_PROCESO datetime2(0),
		@P_RET_PROCESO float(53) OUTPUT,
		@P_MSG_PROCESO varchar(max) OUTPUT
	AS
	BEGIN	
		DECLARE 
		@CantidadCheques NUMERIC(10)
		 
		BEGIN TRY
			SELECT @CantidadCheques = COUNT(*)
				FROM CLE_DEPOSITOS_ECHEQ AS C  WITH (nolock)
			INNER JOIN CLE_CHEQUES_SALIENTE AS S  WITH (nolock) ON
				C.SERIE=S.SERIE_DEL_CHEQUE
				AND C.NUMERO_CHEQUE=S.NUMERO_CHEQUE
				AND (SELECT NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO=2)= S.BANCO_GIRADO
				AND C.SUCURSAL=S.SUCURSAL_BANCO_GIRADO
				AND C.CUENTA=S.NUMERICO_CUENTA_GIRADORA
			WHERE 
				C.ESTADO=''A''
				AND C.TIPO_REG<>''N''
				
			IF @CantidadCheques = 0
				BEGIN
					SET @P_MSG_PROCESO = ''No hay cheques que coincidan''
				END
			IF @CantidadCheques = 1
				BEGIN
					SET @P_MSG_PROCESO = ''Se modificó ''+ CONVERT(VARCHAR, @CantidadCheques) + '' cheque''
				END
			IF @CantidadCheques > 1
				BEGIN
					SET @P_MSG_PROCESO = ''Se modificaron ''+ CONVERT(VARCHAR, @CantidadCheques) + '' cheques''
				END
			SET @P_RET_PROCESO = 1
			
			UPDATE C
				SET C.TIPO_REG=''N''
				FROM CLE_DEPOSITOS_ECHEQ AS C  WITH (nolock)
			INNER JOIN CLE_CHEQUES_SALIENTE AS S  WITH (nolock) ON
				C.SERIE=S.SERIE_DEL_CHEQUE
				AND C.NUMERO_CHEQUE=S.NUMERO_CHEQUE
				AND (SELECT NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO=2)= S.BANCO_GIRADO
				AND C.SUCURSAL=S.SUCURSAL_BANCO_GIRADO
				AND C.CUENTA=S.NUMERICO_CUENTA_GIRADORA
			WHERE 
				C.ESTADO=''A''
				AND C.TIPO_REG<>''N''
		END TRY

		BEGIN CATCH
			DECLARE
				@errornumber int
			SET @errornumber = ERROR_NUMBER()
			DECLARE
				@errormessage nvarchar(4000)
			SET @errormessage = ERROR_MESSAGE()
			BEGIN
				SET @P_RET_PROCESO = ERROR_NUMBER()
				SET @P_MSG_PROCESO = ''Error en la actualización de los cheques. '' + @errormessage
				DECLARE
					@PKG_CONSTANTES$C_LOG_TIPO_ERROR varchar(30)
				SET @PKG_CONSTANTES$C_LOG_TIPO_ERROR = ''E''
				EXECUTE dbo.PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
					@P_ID_PROCESO = @P_ID_PROCESO, 
					@P_FCH_PROCESO = @P_DT_PROCESO, 
					@P_NOM_PACKAGE = ''SP_ACTUALIZA_TIPO_REG_CHE_P'',
					@P_COD_ERROR = @P_RET_PROCESO, 
					@P_MSG_ERROR = @P_MSG_PROCESO, 
					@P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_ERROR
			END
		END CATCH
	END
')

