EXECUTE('DELETE FROM RRII_CHE_RECHAZADOS;')

EXECUTE('
--Fecha parametro
DECLARE @FECHA_PARAMETRO AS DATETIME;
SET @FECHA_PARAMETRO = CONVERT(DATETIME,''17/03/2025'',103);

INSERT INTO RRII_CHE_RECHAZADOS (
    COD_ENTIDAD, NRO_SUCURSAL, CUENTA, NRO_CHEQUE, AVISO, COD_MOVIMIENTO, 
    FECHA_NOTIF_O_DENUNCIA, CAUSAL, MONEDA, IMPORTE, FECHA_RECHAZO_O_PRES_COBRO,
    FECHA_REGISTRACION, PLAZO_DIFERIMIENTO, FECHA_PAGO_CHEQUE, FECHA_PAGO_MULTA,
    FECHA_CIERRE_CTA, FECHA_REGISTRO_NOVEDAD, CODIGO_MOTIVO, ESTADO, 
    FECHA_ENVIADO_BCRA, SERIE, CLASE_REGISTRO
)

SELECT
    (SELECT numerico FROM PARAMETROSGENERALES WHERE CODIGO=2) AS COD_ENTIDAD,
    CD.SUCURSAL AS NRO_SUCURSAL,
    CD.CUENTA AS CUENTA,
    CD.NUMEROCHEQUE AS NRO_CHEQUE,
    CD.Nro_Aviso AS AVISO,
    ''A'' AS COD_MOVIMIENTO,
    CD.FECHAREGISTRO AS FECHA_NOTIF_O_DENUNCIA,
    (SELECT CM.CODIGO_RRII FROM CHE_MOTIVOS_RECHAZO CM WHERE CM.CODIGO_BCRA = CD.CODIGO_MOTIVO_RECHAZO) AS CAUSAL,
    0 AS MONEDA,
    COALESCE(
    (SELECT TOP 1 IMPORTE 
     FROM CLE_CHEQUES_CLEARING_DEVUELTOS CCCD
     WHERE CCCD.NROCHEQUE = CD.NUMEROCHEQUE
       AND CCCD.SUCURSAL = CD.SUCURSAL
       AND CCCD.CUENTA = CD.CUENTA), 
    0
  ) AS IMPORTE,
    NULL AS FECHA_RECHAZO_O_PRES_COBRO,
    --CD.FECHAREGISTRO 
    NULL AS FECHA_REGISTRACION,
    0 AS PLAZO_DIFERIMIENTO,
    00000000 AS FECHA_PAGO_CHEQUE,
    NULL AS FECHA_PAGO_MULTA,
    NULL AS FECHA_CIERRE_CTA,
    CD.FECHAREGISTRO AS FECHA_REGISTRO_NOVEDAD,
    (SELECT CM.CODIGO_RRII FROM CHE_MOTIVOS_RECHAZO CM WHERE CM.CODIGO_BCRA = CD.CODIGO_MOTIVO_RECHAZO) AS CODIGO_MOTIVO,
    ''DP'' AS ESTADO,
    (CD.FECHAREGISTRO) AS FECHA_ENVIADO_BCRA,
     CD.SERIE AS SERIE, 
    1 AS CLASE_REGISTRO
FROM CHE_CHEQUESDENUNCIADOS CD WITH(NOLOCK)
WHERE 
   CD.FECHAREGISTRO <= @FECHA_PARAMETRO
   AND
   CD.TZ_LOCK = 0
UNION ALL
--CHEQUES RECHAZADOS
SELECT 
    (SELECT numerico FROM PARAMETROSGENERALES WHERE CODIGO=2) AS COD_ENTIDAD,
    CBR.SUCURSAL AS NRO_SUCURSAL,
    CBR.CUENTA AS CUENTA,
    CBR.NRO_CHEQUE AS NRO_CHEQUE,
    CBR.Nro_Aviso AS AVISO,
    ''A'' AS COD_MOVIMIENTO,
    dbo.diaHabil(DATEADD(day, 1,CBR.FECHA_RECHAZO), ''A'') AS FECHA_NOTIF_O_DENUNCIA,
    CBR.COD_RECHAZO AS CAUSAL,
    CBR.MONEDA AS MONEDA,
    COALESCE(CBR.IMPORTE_CHEQUE, 0) AS IMPORTE,
    CBR.FECHA_RECHAZO AS FECHA_RECHAZO_O_PRES_COBRO,
    --CBR.FECHA_NOTIFICACION 
    NULL AS FECHA_REGISTRACION,
    CASE 
        WHEN EXISTS (
            SELECT 1 
            FROM CHE_CHEQUERAS CC 
            WHERE CBR.NRO_CHEQUE <= CC.CHEQUEHASTA
            AND CBR.NRO_CHEQUE >= CC.CHEQUEDESDE
            AND CC.TIPOLIBRETA = ''D''
            AND CC.CLIENTE = CBR.CLIENTE
        )
        THEN DATEDIFF(DAY,CBR.FECHA_VENCIMIENTO,CBR.FECHA_EMISION)
        ELSE 0
    END AS PLAZO_DIFERIMIENTO,
	CASE 
     WHEN CBR.FECHA_REINTEGRO <@FECHA_PARAMETRO
     THEN CBR.FECHA_REINTEGRO 
     ELSE NULL 
     END AS FECHA_PAGO_CHEQUE,
    CASE 
     WHEN CBR.FECHA_PAGO_MULTA<@FECHA_PARAMETRO
     THEN CBR.FECHA_PAGO_MULTA
     ELSE NULL 
     END AS FECHA_PAGO_MULTA,
    --(SELECT TOP 1 FECHACIERRE FROM CLI_CLIENTES WHERE CODIGOCLIENTE = CBR.CLIENTE) AS FECHA_CIERRE_CTA,
    ---buscamos cierre de cuenta del saldo relacionado al cheque
       CCC.FECHA_CANCELACION AS FECHA_CIERRE_CTA,    
	dbo.diaHabil(DATEADD(day, 1,CBR.FECHA_RECHAZO), ''A'') AS FECHA_REGISTRO_NOVEDAD,
    CBR.COD_RECHAZO AS CODIGO_MOTIVO,
    CASE
    	WHEN CBR.FECHA_PAGO_MULTA IS NULL or CBR.FECHA_PAGO_MULTA > @FECHA_PARAMETRO  THEN
    		''PSM''
    	ELSE ''PCM''
    END AS ESTADO,
    CBR.FECHA_NOTIF_BCRA AS FECHA_ENVIADO_BCRA,
    CBR.SERIE_CHEQUE AS SERIE,	
    1 AS CLASE_REGISTRO
FROM 
    CHE_BCO_RECHAZADOS CBR
LEFT JOIN SALDOS S WITH(NOLOCK) ON
     CBR.JTS_SALDOS=S.JTS_OID
     AND S.C1679=''1'' 
LEFT JOIN cv_cancelacion_cuentas ccc WITH(NOLOCK) ON
      CBR.JTS_SALDOS=CCC.SALDO_JTS_OID AND
      CCC.ESTADO=''F''

   WHERE CBR.FECHA_RECHAZO<= @FECHA_PARAMETRO AND CBR.TZ_LOCK=0
')
