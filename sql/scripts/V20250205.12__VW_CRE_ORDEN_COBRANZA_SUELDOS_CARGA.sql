EXECUTE('
IF OBJECT_ID (''dbo.VW_ORDEN_COBRANZA_DEBITOS_AUTOMATICOS'') IS NOT NULL
	DROP VIEW dbo.VW_ORDEN_COBRANZA_DEBITOS_AUTOMATICOS
')

EXECUTE('
CREATE VIEW dbo.VW_ORDEN_COBRANZA_DEBITOS_AUTOMATICOS
AS
SELECT ISNULL(b.CODIGO_COBRANZA,0) AS CODIGO,ISNULL(b.ORDEN,99) AS ORDEN,CD.CONVENIO,S.C1803 AS CLIENTE,DD.FECHA_NOVEDAD AS FECHA,
0 AS TIPO,''C'' AS CLASIFICACION, DD.ID_CABEZAL, DD.ID_LINEA
FROM REC_DET_DEBITOSAUTOMATICOS DD with (nolock)
INNER JOIN REC_CAB_DEBITOSAUTOMATICOS CD WITH(nolock)
ON DD.ID_CABEZAL=CD.ID AND CD.TZ_LOCK = 0
INNER JOIN SALDOS S WITH (nolock) 
ON S.JTS_OID=DD.JTS_DEBITO AND S.TZ_LOCK = 0
INNER JOIN CONV_CONVENIOS_REC C WITH(NOLOCK) ON C.Id_ConvRec = CD.CONVENIO AND C.TZ_LOCK = 0
LEFT JOIN CRE_COB_ORDEN_COBRANZA b with (nolock) 
ON CD.CONVENIO=b.CODIGO_ITEM AND b.TZ_LOCK=0 AND b.TIPO=''C''
WHERE DD.ESTADO = ''V'' AND CD.ESTADO IN (''V'',''Z'') AND DD.TZ_LOCK = 0
AND (DD.FECHA_NOVEDAD IS NULL OR DD.FECHA_NOVEDAD <= (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK)))
AND CD.FECHACORTE >= (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))
---- Fecha de corte en el mismo mes y año de la de proceso o un mes para adelante
AND ((DATEDIFF(YY,CD.FECHACORTE,(SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))) = 0
AND DATEDIFF(MM,CD.FECHACORTE,(SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))) = 0)
OR (DATEPART(MM,DATEADD(MM,1,(SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK)))) = DATEPART(MM,CD.FECHACORTE)
AND DATEPART(YY,DATEADD(MM,1,(SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK)))) = DATEPART(YY,CD.FECHACORTE)))
')

EXECUTE('
IF OBJECT_ID (''dbo.VW_CRE_ORDEN_COBRANZA_SUELDOS_CARGA'') IS NOT NULL
	DROP VIEW dbo.VW_CRE_ORDEN_COBRANZA_SUELDOS_CARGA
')

EXECUTE('
CREATE VIEW dbo.VW_CRE_ORDEN_COBRANZA_SUELDOS_CARGA
AS
SELECT T.CODIGO, T.ORDEN, T.JTS_DEBITO, T.CLIENTE, T.FECHA, T.TIPO, T.CLASIFICACION, T.ID_CABEZAL, T.ID_LINEA,
V.NUMERODOCUMENTO AS NUMERODOC FROM (
SELECT DA.CODIGO,
DA.ORDEN,
DA.CONVENIO AS JTS_DEBITO,
DA.CLIENTE,
DA.FECHA,
DA.TIPO,
DA.CLASIFICACION,
DA.ID_CABEZAL,
DA.ID_LINEA
FROM VW_ORDEN_COBRANZA_DEBITOS_AUTOMATICOS DA
UNION
SELECT
CA.codigo,
CA.orden,
CA.JTS_OID,
CA.CLIENTE,
CA.VENCIMIENTO,
CA.TIPO,
CA.CLASIFICACION,
0 AS ID_CABEZAL,
0 AS ID_LINEA
FROM VW_CRE_ORDEN_COBRANZA_ASISTENCIAS CA) T
INNER JOIN CLI_CLIENTEPERSONA  AS CP WITH (nolock) ON CP.CODIGOCLIENTE = T.CLIENTE AND CP.TITULARIDAD=''T'' AND CP.TZ_LOCK=0
INNER JOIN CLI_DOCUMENTOSPFPJ  AS V WITH (nolock) ON CP.NUMEROPERSONA = V.NUMEROPERSONAFJ AND V.TZ_LOCK=0
')