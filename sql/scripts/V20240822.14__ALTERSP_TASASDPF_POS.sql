EXECUTE('
ALTER PROCEDURE [dbo].[SP_TASAS_DPF_POS]
(
  @PCliente NUMERIC(12),
  @PPlazo	NUMERIC(10),
  @PImporte NUMERIC(15,2),
  @PProducto NUMERIC(5),
  @PMoneda	NUMERIC(5),
  @PElemento62 VARCHAR(6),
  @Resultado   VARCHAR(400) OUTPUT
)
AS

DECLARE @TARIFA NUMERIC(5)
DECLARE @CANAL NUMERIC(5)
DECLARE @PAQUETE NUMERIC(5)
DECLARE @CAMPANIA NUMERIC(5)
DECLARE @SEGMENTO NUMERIC(5)
DECLARE @CANTIDAD NUMERIC(10)
DECLARE @PUNTOS_TASA NUMERIC(11,7)
DECLARE @TIPO_TASA VARCHAR(3)
DECLARE @TASA NUMERIC(11,7)
DECLARE @TASA_CALCULADA NUMERIC(11,7)
DECLARE @TASA_PRECANCELA NUMERIC(11,7)
DECLARE @CABECERA VARCHAR(36)
DECLARE @LINEA1 VARCHAR(36)
DECLARE @LINEA2 VARCHAR(36)
DECLARE @LINEA3 VARCHAR(36)
DECLARE @LINEA4 VARCHAR(36)
DECLARE @LINEA5 VARCHAR(36)
DECLARE @LINEA6 VARCHAR(36)
DECLARE @LINEA7 VARCHAR(36)
DECLARE @LINEA8 VARCHAR(36)
DECLARE @LINEA9 VARCHAR(36)
DECLARE @LINEA10 VARCHAR(36)
DECLARE @TASA_FINAL VARCHAR(20)
DECLARE @PRECANCELA VARCHAR(20)
DECLARE @AUX_LINEAS TABLE (DATOS VARCHAR(200))
DECLARE @LARGO_LINEA NUMERIC(3)
DECLARE @TASAS_LINEAS VARCHAR(300)
DECLARE @PPlazoExacto NUMERIC(10)
SET @PAQUETE = 100;

SET @CAMPANIA = 0;

--DESCRIMINACION DE CANAL, 3 o 5
IF(@PElemento62=''D0'')
	BEGIN
		SET @CANAL = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO = 224);
	END
	ELSE
	BEGIN 
		SET @CANAL = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO = 219);
	END

---GENERAR IF
IF (@PCliente=0 OR @PCLIENTE IS NULL)
BEGIN
SELECT @SEGMENTO= (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=241);
END
ELSE
BEGIN
SELECT @SEGMENTO=SEGMENTOCLIENTE FROM CLI_CLIENTES WITH(NOLOCK) WHERE CODIGOCLIENTE = @PCliente;
END
---END
IF(@PPlazo > 0 AND @PImporte>0)
BEGIN

	EXEC SP_DETERMINACION_TARIFA @PAQUETE, @CAMPANIA, @SEGMENTO, @CANAL, @PProducto, @PMoneda, @TARIFA OUT, @CANTIDAD OUT

	SELECT TOP 1 @PUNTOS_TASA=PUNTOS, @TIPO_TASA=TIPOTASAINT 
	FROM TASAS WITH(NOLOCK) 
	WHERE ((Moneda=@PMoneda AND Producto=@PProducto AND Plazo<=@PPlazo AND Importe<=@PImporte 
	AND ((CLIENTE=@PCliente AND TARIFA=0) OR ((CLIENTE=0 AND TARIFA=@TARIFA)) OR 
	((CLIENTE=0 AND TARIFA=0)) OR ((CLIENTE=@PCliente AND TARIFA=@TARIFA))) AND 
	(VIGENCIAHASTA IS NULL OR (VIGENCIAHASTA>=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) AND 
	VIGENCIADESDE<=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) 
	AND TZ_LOCK = 0
	ORDER BY CLIENTE DESC, TARIFA DESC, Importe 
	DESC, Plazo DESC, VIGENCIADESDE DESC

	SELECT TOP 1 @TASA = Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=@TIPO_TASA AND TZ_LOCK = 0) 
	AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
	AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
	ORDER BY VigenciaDesde DESC

	
	SET @CABECERA = ''1P''+CONVERT(VARCHAR,(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)),12)+''10''+''36'';
	/*SET @CABECERA = @CABECERA + REPLICATE('' '', 19 - LEN(@CABECERA));
	SET @LINEA1 = (SELECT REPLACE(C6251,''ú'', ''u'') FROM PRODUCTOS WITH(NOLOCK) WHERE C6250 = @PProducto);
	SET @LINEA1 = @LINEA1 + REPLICATE('' '', 36 - LEN(@LINEA1));
	SET @LINEA2 = ''IMPORTE:'';
	DECLARE @IMPORTE_FORMATEADO VARCHAR(20);
	SET @IMPORTE_FORMATEADO = FORMAT(@PImporte, ''C'', ''es-ar'');
	SET @LINEA2 = @LINEA2 + REPLICATE('' '', 36 - (LEN(@LINEA2)+LEN(@IMPORTE_FORMATEADO))) + @IMPORTE_FORMATEADO;
	SET @LINEA3 = ''PLAZO ''+ CONVERT(VARCHAR,@PPlazo) + '' DIAS'';
	SET @LINEA3 = @LINEA3 + REPLICATE('' '', 36 - LEN(@LINEA3));*/
	
	SET @TASA_CALCULADA = @PUNTOS_TASA + @TASA;
	
	SET @TASA_FINAL = REPLACE(SUBSTRING(CONVERT(VARCHAR(20),@TASA_CALCULADA),1,6),''.'','',''); 
	
	SET @LINEA1 = ''%'' + @TASA_FINAL;
	SET @LINEA2 = REPLICATE('' '',36);
	SET @LINEA3 = REPLICATE('' '',36);
	SET @LINEA4 = REPLICATE('' '',36);
	SET @LINEA5 = REPLICATE('' '',36);
	SET @LINEA6 = REPLICATE('' '',36);
	SET @LINEA7 = REPLICATE('' '',36);
	SET @LINEA8 = REPLICATE('' '',36);
	SET @LINEA9 = REPLICATE('' '',36);
	SET @LINEA10 = REPLICATE('' '',36);
	
	/*IF(@PProducto = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=716))
	BEGIN
		SELECT TOP 1 @TASA_PRECANCELA=VALOR FROM TASAS_PRECANCELACION WITH(NOLOCK) 
		WHERE FECHA_VIGENCIA <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		ORDER BY FECHA_VIGENCIA DESC
		
		
		SET @PRECANCELA = REPLACE(SUBSTRING(CONVERT(VARCHAR, @TASA_PRECANCELA),1,5),''.'','','') + ''%'';
		
		SET @LINEA4 = ''TASA FIJA DE PRECANCELACION:'';
		SET @LINEA4 = @LINEA4 + REPLICATE('' '',36-(LEN(@LINEA4)+LEN(@PRECANCELA)))+@PRECANCELA;
		
		SET @LINEA5 = ''TASA DE CONSTITUCION: '';
		SET @LINEA5 = @LINEA5 +@TASA_FINAL;
		
		SET @LINEA6 = REPLICATE('' '',36);
		SET @LINEA7 = REPLICATE('' '',36);
		SET @LINEA8 = REPLICATE('' '',36);
		SET @LINEA9 = REPLICATE('' '',36);
		SET @LINEA10 = REPLICATE('' '',36);
		
	END
	ELSE
	BEGIN
		SET @LINEA4 = ''TASA DE CONSTITUCION: '';
		SET @LINEA4 = @LINEA4 + REPLICATE('' '',36-(LEN(@LINEA4)+LEN(@TASA_FINAL)))+@TASA_FINAL;
		
		SET @LINEA5 = REPLICATE('' '',36);
		SET @LINEA6 = REPLICATE('' '',36);
		SET @LINEA7 = REPLICATE('' '',36);
		SET @LINEA8 = REPLICATE('' '',36);
		SET @LINEA9 = REPLICATE('' '',36);
		SET @LINEA10 = REPLICATE('' '',36);
	END*/
	SET @Resultado = @CABECERA + @LINEA1 + @LINEA2 + @LINEA3 + @LINEA4 + @LINEA5 + @LINEA6 + @LINEA7 + @LINEA8 + @LINEA9 + @LINEA10;
END

IF(@PPlazo > 0 AND @PImporte = 0)
BEGIN
	
	EXEC SP_DETERMINACION_TARIFA @PAQUETE, @CAMPANIA, @SEGMENTO, @CANAL, @PProducto, @PMoneda, @TARIFA OUT, @CANTIDAD OUT
	
	SET @PPlazoExacto= (SELECT TOP 1 Plazo
	FROM TASAS WITH(NOLOCK) 
	WHERE ((Moneda=@PMoneda AND Producto=@PProducto AND Plazo<=@PPlazo AND Importe<=@PImporte 
	AND ((CLIENTE=@PCliente AND TARIFA=0) OR ((CLIENTE=0 AND TARIFA=@TARIFA)) OR 
	((CLIENTE=0 AND TARIFA=0)) OR ((CLIENTE=@PCliente AND TARIFA=@TARIFA))) AND 
	(VIGENCIAHASTA IS NULL OR (VIGENCIAHASTA>=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) AND 
	VIGENCIADESDE<=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) 
	AND TZ_LOCK = 0
	ORDER BY CLIENTE DESC, TARIFA DESC, Importe 
	DESC, Plazo DESC, VIGENCIADESDE DESC)
	
	
	SELECT @PUNTOS_TASA=PUNTOS, @TIPO_TASA=TIPOTASAINT 
	FROM TASAS WITH(NOLOCK) 
	WHERE ((Moneda=@PMoneda AND Producto=@PProducto AND Plazo=@PPlazoExacto AND Importe<=@PImporte 
	AND ((CLIENTE=@PCliente AND TARIFA=0) OR ((CLIENTE=0 AND TARIFA=@TARIFA)) OR 
	((CLIENTE=0 AND TARIFA=0)) OR ((CLIENTE=@PCliente AND TARIFA=@TARIFA))) AND 
	(VIGENCIAHASTA IS NULL OR (VIGENCIAHASTA>=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) AND 
	VIGENCIADESDE<=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) 
	AND TZ_LOCK = 0
	ORDER BY CLIENTE DESC, TARIFA DESC, Importe 
	DESC, Plazo DESC, VIGENCIADESDE DESC
	
	SET @CABECERA = ''1P''+CONVERT(VARCHAR,(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)),12)+''10''+''36'';
	
	SET @LINEA1 = (SELECT REPLACE(C6251,''ú'', ''u'') FROM PRODUCTOS WITH(NOLOCK) WHERE C6250 = @PProducto);
	SET @LINEA1 = @LINEA1 + REPLICATE('' '', 36 - DATALENGTH(@LINEA1));
	
	SET @LINEA2 = ''PLAZO ''+ CONVERT(VARCHAR,@PPlazo) + '' DIAS'';
	SET @LINEA2 = @LINEA2 + REPLICATE('' '', 36 - DATALENGTH(@LINEA2));
	
	IF(@PProducto = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=716))
	BEGIN
		SELECT TOP 1 @TASA_PRECANCELA=VALOR FROM TASAS_PRECANCELACION WITH(NOLOCK) 
		WHERE FECHA_VIGENCIA <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		ORDER BY FECHA_VIGENCIA DESC

		SET @PRECANCELA = SUBSTRING(CONVERT(VARCHAR, @TASA_PRECANCELA),1,5) + ''%'';
		
		SET @LINEA3 = ''TASA FIJA DE PRECANCELACION: '';
		SET @LINEA3 = @LINEA3 + REPLICATE('' '',36-(DATALENGTH(@LINEA3)+LEN(@PRECANCELA)))+@PRECANCELA;
		
		SET @LINEA4 = ''........IMPORTE DESDE'';
		SET @LINEA4 = @LINEA4 + REPLICATE('' '', 31-DATALENGTH(@LINEA4)) + ''TNA  '';
		
		SET @LINEA5 = ''-''+REPLICATE('' '', 35);
		
		INSERT INTO @AUX_LINEAS
		SELECT TOP 5
		M.C6401 + REPLICATE('' '',24-(LEN(M.C6401)+LEN(CONVERT(VARCHAR,T.IMPORTE)))) + REPLACE(CONVERT(VARCHAR,T.IMPORTE),''.'','','') +
		+ REPLICATE('' '', 12-LEN(REPLACE(CONVERT(VARCHAR,CONVERT(NUMERIC(12,4),T.PUNTOS + (SELECT TOP 1 Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=T.TIPOTASAINT AND TZ_LOCK = 0)
		AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		ORDER BY VigenciaDesde DESC)))+''%'', ''.'', '','')))+REPLACE(CONVERT(VARCHAR,CONVERT(NUMERIC(12,4),T.PUNTOS + (SELECT TOP 1 Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=T.TIPOTASAINT AND TZ_LOCK = 0)
		AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		ORDER BY VigenciaDesde DESC)))+''%'', ''.'', '','') 
		FROM TASAS T WITH(NOLOCK)   
		INNER JOIN MONEDAS M WITH(NOLOCK) ON T.MONEDA=M.C6399  
		WHERE ((T.Moneda=@PMoneda AND T.Producto=@PProducto AND T.Plazo<=@PPlazo  
		AND ((T.CLIENTE=@PCliente AND T.TARIFA=0) OR ((T.CLIENTE=0 AND T.TARIFA=@TARIFA)) OR 
		((T.CLIENTE=0 AND T.TARIFA=0)) OR ((T.CLIENTE=@PCliente AND T.TARIFA=@TARIFA))) AND 
		(T.VIGENCIAHASTA IS NULL OR (T.VIGENCIAHASTA>=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) AND 
		VIGENCIADESDE<=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) 
		AND T.TZ_LOCK = 0
		ORDER BY T.CLIENTE, T.TARIFA, T.Importe, T.Plazo, T.VIGENCIADESDE
		
		SELECT @TASAS_LINEAS=STRING_AGG(DATOS,'''') FROM @AUX_LINEAS
		
		SET @LARGO_LINEA = DATALENGTH(@TASAS_LINEAS);
		
		SET @Resultado = @CABECERA+@LINEA1+@LINEA2+@LINEA3+@LINEA4+@LINEA5+@TASAS_LINEAS + REPLICATE('' '', (36*(5-(@LARGO_LINEA/36))))

	END
	ELSE
	BEGIN
		SET @LINEA3 = ''........IMPORTE DESDE'';
		SET @LINEA3 = @LINEA3 + REPLICATE('' '', 31-LEN(@LINEA3)) + ''TNA  '';
		
		SET @LINEA4 = ''-''+REPLICATE('' '', 35);
		
		INSERT INTO @AUX_LINEAS
		SELECT TOP 6
		M.C6401 + REPLICATE('' '',24-(LEN(M.C6401)+LEN(CONVERT(VARCHAR,T.IMPORTE)))) + REPLACE(CONVERT(VARCHAR,T.IMPORTE),''.'','','') +
		+ REPLICATE('' '', 12-LEN(REPLACE(CONVERT(VARCHAR,CONVERT(NUMERIC(12,4),T.PUNTOS + (SELECT TOP 1 Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=T.TIPOTASAINT AND TZ_LOCK = 0)
		AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		ORDER BY VigenciaDesde DESC)))+''%'', ''.'', '','')))+REPLACE(CONVERT(VARCHAR,CONVERT(NUMERIC(12,4),T.PUNTOS + (SELECT TOP 1 Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=T.TIPOTASAINT AND TZ_LOCK = 0)
		AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
		ORDER BY VigenciaDesde DESC)))+''%'', ''.'', '','') 
		FROM TASAS T WITH(NOLOCK)   
		INNER JOIN MONEDAS M WITH(NOLOCK) ON T.MONEDA=M.C6399  
		WHERE ((T.Moneda=@PMoneda AND T.Producto=@PProducto AND T.Plazo=@PPlazoExacto  
		AND ((T.CLIENTE=@PCliente AND T.TARIFA=0) OR ((T.CLIENTE=0 AND T.TARIFA=@TARIFA)) OR   
		((T.CLIENTE=0 AND T.TARIFA=0)) OR ((T.CLIENTE=@PCliente AND T.TARIFA=@TARIFA))) AND 
		(T.VIGENCIAHASTA IS NULL OR (T.VIGENCIAHASTA>=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) AND   
		VIGENCIADESDE<=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))))   
		AND T.TZ_LOCK = 0
		ORDER BY T.CLIENTE, T.TARIFA, T.Importe, T.Plazo, T.VIGENCIADESDE
		
		SELECT @TASAS_LINEAS=STRING_AGG(DATOS,'''') FROM @AUX_LINEAS
		
		SET @LARGO_LINEA = DATALENGTH(@TASAS_LINEAS);
		
		SET @Resultado = @CABECERA+@LINEA1+@LINEA2+@LINEA3+@LINEA4+@TASAS_LINEAS + REPLICATE('' '', (36*(6-(@LARGO_LINEA/36))))
		
	END
END 
IF(@PPlazo = 0 AND @PImporte > 0)
	BEGIN
		EXEC SP_DETERMINACION_TARIFA @PAQUETE, @CAMPANIA, @SEGMENTO, @CANAL, @PProducto, @PMoneda, @TARIFA OUT, @CANTIDAD OUT

		SELECT TOP 1 @PUNTOS_TASA=PUNTOS, @TIPO_TASA=TIPOTASAINT 
		FROM TASAS WITH(NOLOCK) 
		WHERE ((Moneda=@PMoneda AND Producto=@PProducto AND Plazo<=@PPlazo AND Importe<=@PImporte 
		AND ((CLIENTE=@PCliente AND TARIFA=0) OR ((CLIENTE=0 AND TARIFA=@TARIFA)) OR 
		((CLIENTE=0 AND TARIFA=0)) OR ((CLIENTE=@PCliente AND TARIFA=@TARIFA))) AND 
		(VIGENCIAHASTA IS NULL OR (VIGENCIAHASTA>=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) AND 
		VIGENCIADESDE<=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) 
		AND TZ_LOCK = 0
		ORDER BY CLIENTE DESC, TARIFA DESC, Importe 
		DESC, Plazo DESC, VIGENCIADESDE DESC
	
		SET @CABECERA = ''1P''+CONVERT(VARCHAR,(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)),12)+''10''+''36'';
		SET @LINEA1 = (SELECT REPLACE(C6251,''ú'', ''u'') FROM PRODUCTOS WITH(NOLOCK) WHERE C6250 = @PProducto);
		SET @LINEA1 = @LINEA1 + REPLICATE('' '', 36 - DATALENGTH(@LINEA1));
	
		SET @LINEA2 = ''IMPORTE: '';
		SET @LINEA2 = @LINEA2 + REPLICATE('' '', 36 - (DATALENGTH(@LINEA2)+LEN(CONVERT(VARCHAR(17),FORMAT(@PImporte, ''C'', ''es-ar''))))) + CONVERT(VARCHAR(17),FORMAT(@PImporte, ''C'', ''es-ar''));
	
		IF(@PProducto = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=716))
		BEGIN
		
			
			SELECT TOP 1 @TASA_PRECANCELA=VALOR FROM TASAS_PRECANCELACION WITH(NOLOCK) 
			WHERE FECHA_VIGENCIA <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			ORDER BY FECHA_VIGENCIA DESC

	   		SET @PRECANCELA = SUBSTRING(CONVERT(VARCHAR, @TASA_PRECANCELA),1,5) + ''%'';
	   		
		
			SET @LINEA3 = ''TASA FIJA DE PRECANCELACION: '';
			SET @LINEA3 = @LINEA3 + REPLICATE('' '',36-(DATALENGTH(@LINEA3)+LEN(@PRECANCELA)))+@PRECANCELA;
			
		
			SET @LINEA4 = ''PLAZO DESDE:'';
			SET @LINEA4 = @LINEA4 + REPLICATE('' '', 33-DATALENGTH(@LINEA4)) + ''TNA'';
		
		
			INSERT INTO @AUX_LINEAS
			SELECT TOP 6
			CONVERT(VARCHAR,T.PLAZO) + REPLICATE('' '',24-LEN(CONVERT(VARCHAR,T.PLAZO))) +
			+ REPLICATE('' '', 12-LEN(REPLACE(CONVERT(VARCHAR,CONVERT(NUMERIC(12,4),T.PUNTOS + (SELECT TOP 1 Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=T.TIPOTASAINT AND TZ_LOCK = 0)
			AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			ORDER BY VigenciaDesde DESC)))+''%'', ''.'', '','')))+REPLACE(CONVERT(VARCHAR,CONVERT(NUMERIC(12,4),T.PUNTOS + (SELECT TOP 1 Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=T.TIPOTASAINT AND TZ_LOCK = 0)
			AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			ORDER BY VigenciaDesde DESC)))+''%'', ''.'', '','') 
			FROM TASAS T WITH(NOLOCK)   
			INNER JOIN MONEDAS M WITH(NOLOCK) ON T.MONEDA=M.C6399  
			WHERE ((T.Moneda=@PMoneda AND T.Producto=@PProducto AND T.IMPORTE<=@PImporte  
			AND ((T.CLIENTE=@PCliente AND T.TARIFA=0) OR ((T.CLIENTE=0 AND T.TARIFA=@TARIFA)) OR 
			((T.CLIENTE=0 AND T.TARIFA=0)) OR ((T.CLIENTE=@PCliente AND T.TARIFA=@TARIFA))) AND 
			(T.VIGENCIAHASTA IS NULL OR (T.VIGENCIAHASTA>=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) AND 
			VIGENCIADESDE<=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) 
			AND T.TZ_LOCK = 0
			ORDER BY T.CLIENTE, T.TARIFA, T.Importe, T.Plazo, T.VIGENCIADESDE
		
		SELECT @TASAS_LINEAS=STRING_AGG(DATOS,'''') FROM @AUX_LINEAS
		
		SET @LARGO_LINEA = DATALENGTH(@TASAS_LINEAS);
		
		SET @Resultado = @CABECERA+@LINEA1+@LINEA2+@LINEA3+@LINEA4+@TASAS_LINEAS + REPLICATE('' '', (36*(6-(@LARGO_LINEA/36))))
		END
	ELSE
		BEGIN
			SET @LINEA3 = ''PLAZO DESDE:'';
			SET @LINEA3 = @LINEA3 + REPLICATE('' '', 33-LEN(@LINEA3)) + ''TNA'';
			
			INSERT INTO @AUX_LINEAS
			SELECT TOP 7
			CONVERT(VARCHAR,T.PLAZO) + REPLICATE('' '',24-LEN(CONVERT(VARCHAR,T.PLAZO))) +
			+ REPLICATE('' '', 12-LEN(REPLACE(CONVERT(VARCHAR,CONVERT(NUMERIC(12,4),T.PUNTOS + (SELECT TOP 1 Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=T.TIPOTASAINT AND TZ_LOCK = 0)
			AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			ORDER BY VigenciaDesde DESC)))+''%'', ''.'', '','')))+REPLACE(CONVERT(VARCHAR,CONVERT(NUMERIC(12,4),T.PUNTOS + (SELECT TOP 1 Tasa FROM TasasBase WITH(NOLOCK) WHERE (TipoTasaBase=T.TIPOTASAINT AND TZ_LOCK = 0)
			AND VIGENCIADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			AND VIGENCIAHASTA >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
			ORDER BY VigenciaDesde DESC)))+''%'', ''.'', '','') 
			FROM TASAS T WITH(NOLOCK)   
			INNER JOIN MONEDAS M WITH(NOLOCK) ON T.MONEDA=M.C6399  
			WHERE ((T.Moneda=@PMoneda AND T.Producto=@PProducto AND T.IMPORTE<=@PImporte  
			AND ((T.CLIENTE=@PCliente AND T.TARIFA=0) OR ((T.CLIENTE=0 AND T.TARIFA=@TARIFA)) OR 
			((T.CLIENTE=0 AND T.TARIFA=0)) OR ((T.CLIENTE=@PCliente AND T.TARIFA=@TARIFA))) AND 
			(T.VIGENCIAHASTA IS NULL OR (T.VIGENCIAHASTA>=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) AND 
			VIGENCIADESDE<=(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))) 
			AND T.TZ_LOCK = 0
			ORDER BY T.CLIENTE, T.TARIFA, T.Importe, T.Plazo, T.VIGENCIADESDE
		
			SELECT @TASAS_LINEAS=STRING_AGG(DATOS,'''') FROM @AUX_LINEAS
		
			SET @LARGO_LINEA = DATALENGTH(@TASAS_LINEAS);
		
			SET @Resultado = @CABECERA+@LINEA1+@LINEA2+@LINEA3+@TASAS_LINEAS + REPLICATE('' '', (36*(7-(@LARGO_LINEA/36))))

		
		END
	END
')