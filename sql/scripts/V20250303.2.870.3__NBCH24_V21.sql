EXECUTE('
CREATE OR ALTER PROCEDURE dbo.SP_NBCH24_CRE_SCORING
    @DOCUMENTO BIGint,
    @LINEA numeric(5, 0),
    @jtsCV numeric(15, 0)
    AS
    BEGIN
    SELECT
    vc.JTS_CV jtsCV,
    ca.producto AS linea,
    (SELECT p.C6251 FROM PRODUCTOS p WHERE p.C6250 =ca.producto) AS descripcion,
    CASE WHEN max(pc.MONTO_MINIMO) = 0 THEN 1000 ELSE max(pc.MONTO_MINIMO) END AS montoMinimo,
    sum(ca.MONTO_CALCULADO) AS montoMaximo,
    cast(@DOCUMENTO AS char) documentoUsuario,
    ''AH'' AS modulo,
    ''HO'' AS canal,
    '' '' AS id    
    FROM CRE_VINCULACIONES_CONVENIOS vc WITH (NOLOCK)
    INNER JOIN SALDOS s WITH (NOLOCK) ON vc.JTS_CV = s.JTS_OID AND s.TZ_LOCK = 0 AND s.C1785 IN (2,3)
    INNER JOIN SUCURSALES suc WITH (NOLOCK) ON s.SUCURSAL = suc.SUCURSAL AND suc.TZ_LOCK = 0
    INNER JOIN CRE_PROD_CONVENIOS pc WITH (NOLOCK) ON vc.ID_CONVENIO = pc.DATO_TIPO AND pc.TIPO = ''C'' AND pc.HABILITADO = ''S''   AND pc.TZ_LOCK = 0
    INNER JOIN CONV_CONVENIOS_PAG c WITH (NOLOCK) ON pc.DATO_TIPO = c.ID_ConvPago AND c.TZ_LOCK=0
    INNER JOIN CONV_TIPOS t WITH (NOLOCK) ON c.Id_TpoConv = t.Id_TpoConv AND t.TZ_LOCK = 0
    INNER JOIN CRE_PRODUCTOSCANALDIGITAL dg WITH (NOLOCK) ON dg.PRODUCTO=pc.PRODUCTO
    INNER JOIN VW_CLI_X_DOC doc WITH (NOLOCK) ON doc.CODIGOCLIENTE=s.C1803
    LEFT JOIN CRE_AUX_SOL_CALCULO_ADELANTO ca (NOLOCK) ON pc.PRODUCTO = ca.PRODUCTO AND c.ID_ConvPago = ca.CONVENIO
                    AND s.C1803 = ca.CLIENTE AND vc.ID_JURISDICCION = ca.ID_JURIDICCION AND dg.CANAL = ca.CANAL
    where (vc.TZ_LOCK=0 AND dg.CANAL=''HO'')
    AND COALESCE (ca.MONTO_CALCULADO, 0) > 0
    AND doc.numerodoc = @DOCUMENTO
    AND  (@LINEA IS NULL OR pc.PRODUCTO = @LINEA)
    AND  (@jtsCV IS NULL OR vc.JTS_CV = @jtsCV)
    GROUP BY vc.JTS_CV, ca.producto, pc.MONTO_MINIMO
	OPTION (RECOMPILE)
END
');
