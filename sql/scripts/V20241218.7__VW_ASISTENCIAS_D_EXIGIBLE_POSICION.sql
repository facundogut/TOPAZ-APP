EXECUTE('
IF OBJECT_ID (''dbo.VW_ASISTENCIAS_D_EXIGIBLE_POSICION'') IS NOT NULL
	DROP VIEW dbo.VW_ASISTENCIAS_D_EXIGIBLE_POSICION
')

EXECUTE('
CREATE VIEW dbo.VW_ASISTENCIAS_D_EXIGIBLE_POSICION
AS
SELECT 
	S.JTS_OID,S.C1803 AS CLIENTE,
	s.C1604*-1 AS CAPITAL, 
	s.C1601 AS CAPITAL_ORIGEN,
	--INTERES
	--ROUND(S.C1609-S.C1610,2) AS INTERES,
	SUM(PP_INTERES) AS INTERES,
	SUM(PP_CAPITAL) AS CAPITAL_A_FECHA,
	SUM(PP_IVAINTERES) AS IVAINTERES ,
	SUM(PP_IVAPERCEPCIONINTERES) AS IVA_PERCEPCION_INTERES ,
    -- IVA_FINANCIADO AS IVAINTERES ,
	-- IVA_PERCEPCION_FINANCIADO AS IVA_PERCEPCION_INTERES ,	
	-- MORA
	SUM(PP_INTCOMPMORA) AS MORA,
	SUM(PP_IVAINTCOMPMORA) AS IVA_MORA,
	-- PUNITORIO
	SUM(PP_PUNITORIO) AS PUNITORIO,	
	SUM(PP_IVAPUNITORIO) AS IVA_PUNITORIO,
	-- PERCEPCIONES
	SUM(PP_IVAPERCEPCIONMORA) AS IVA_PERCEPCION_MORA,
	SUM(PP_IVAPERCEPCIONINTCOMPMORA) AS IVA_PERCEPCION_INTCOMP_MORA,
	-- GASTOS
	SUM(GASTOS) AS GASTOS,
	--TOTAL DEUDA
	(s.C1604*-1)+SUM(PP_INTERES)+SUM(PP_IVAINTERES)+SUM(PP_IVAPERCEPCIONINTERES)+SUM(PP_INTCOMPMORA)+SUM(PP_IVAINTCOMPMORA)+
	SUM(PP_IVAPERCEPCIONMORA)+SUM(PP_IVAPERCEPCIONINTCOMPMORA)+
	SUM(PP_PUNITORIO)+SUM(PP_IVAPUNITORIO)+
	SUM(GASTOS)
  AS SALDO_DEUDA,
    SUM(PP_CAPITAL)+SUM(PP_INTERES)+SUM(PP_IVAINTERES)+SUM(PP_IVAPERCEPCIONINTERES)+SUM(PP_INTCOMPMORA)+SUM(PP_IVAINTCOMPMORA)+
	SUM(PP_IVAPERCEPCIONMORA)+SUM(PP_IVAPERCEPCIONINTCOMPMORA)+
	SUM(PP_PUNITORIO)+SUM(PP_IVAPUNITORIO)+
	SUM(GASTOS)
  AS SALDO_A_FECHA
FROM SALDOS S WITH (NOLOCK) 
INNER JOIN ( 
	SELECT 
		PP.SALDO_JTS_OID,
		PP.C2311 AS PP_PUNITORIO,
		PP.IVAMORA AS PP_IVAPUNITORIO,
		PP.IVAPERCEPCIONMORA AS PP_IVAPERCEPCIONMORA,
		PP.ICMORA_DEV AS PP_INTCOMPMORA,
		PP.IVAINTCOMPMORA AS PP_IVAINTCOMPMORA,
		PP.IVAPERCEPCIONINTCOMPMORA AS PP_IVAPERCEPCIONINTCOMPMORA,	
		PP.C2310 AS PP_INTERES,
		PP.C2309 AS PP_CAPITAL,
		PP.IVAINTERES AS PP_IVAINTERES,
		PP.IVAPERCEPCIONINTERES AS PP_IVAPERCEPCIONINTERES,
		ISNULL((SELECT SUM(SALDO_GASTO) FROM GASTOS_POR_CUOTA WITH (NOLOCK) WHERE SALDOS_JTS_OID=PP.SALDO_JTS_OID AND NUMERO_CUOTA=PP.C2300
		 AND ( (tz_lock < 300000000000000 OR tz_lock >= 400000000000000) AND (tz_lock < 100000000000000 OR tz_lock >= 200000000000000)  )),0) AS GASTOS
	FROM SALDOS S1 WITH (NOLOCK) INNER JOIN PLANPAGOS PP WITH (NOLOCK) ON S1.JTS_OID=PP.SALDO_JTS_OID AND S1.TZ_LOCK=0
	WHERE (C2309+C2310)>0 AND
	(PP.C2302 < (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))) 
	AND ((PP.TZ_LOCK < 300000000000000 OR PP.TZ_LOCK >= 400000000000000) AND (PP.TZ_LOCK < 100000000000000 OR PP.TZ_LOCK >= 200000000000000)  )
	) T
ON T.SALDO_JTS_OID=S.JTS_OID
WHERE S.C1785 = 5 AND S.C1604<>0 AND ( (s.tz_lock < 300000000000000 OR s.tz_lock >= 400000000000000) AND (s.tz_lock < 100000000000000 OR s.tz_lock >= 200000000000000)  )
GROUP BY S.JTS_OID,s.C1803,s.c1604,S.C1601,S.C1614,S.ICMORA_CONTABILIZADO,IVA_FINANCIADO,IVA_PERCEPCION_FINANCIADO,C1609,C1610,s.ICMORA_CONTABILIZADO
')