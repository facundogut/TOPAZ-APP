ALTER   FUNCTION dbo.CredComp(
    @periodo VARCHAR(1),
    @jts NUMERIC(10,0),
    @fechaDesde DATE,
    @fechaHasta DATE 
)
RETURNS NUMERIC(15,2)
AS
BEGIN
    DECLARE @resultado NUMERIC(15,2);
WITH COBROS_CREDEB AS (
	SELECT
		ISNULL(B.SEGMENTO, 0) AS SEGMEMNTO,
		ISNULL(CT.TASA, CI.TASA) AS TASA,
		CF.TASA_CREDITO_FISCAL,
		CD.MONEDA,
		FL.MONTO_FACTURABLE,
		CASE
			WHEN C6403 = 'I'
				THEN (FL.MONTO_FACTURABLE * HTC.TIPO_CAMBIO_VENTA)
			WHEN C6403 = 'N'
				THEN FL.MONTO_FACTURABLE
			ELSE
				(FL.MONTO_FACTURABLE * COT.TC_VENTA)
		END AS MONTO_CONVERTIDO_MN
	FROM GRL_CAB_ENVIO_ESTCTA AS CE WITH (nolock)
	INNER JOIN GRL_DET_ENVIO_ESTCTA AS CD WITH (nolock) ON
		CD.LEGAL = CE.LEGAL
		AND CD.PERIODO = CE.PERIODO
		AND CD.IDCAB = CE.IDCAB
		AND CD.JTSOID = CE.JTSOID
		AND CD.TIPOMOV = 'M'
		AND CD.IDDET = (
			SELECT TOP 1 IDDET
			FROM GRL_DET_ENVIO_ESTCTA
			WHERE LEGAL = CD.LEGAL
				AND PERIODO = CD.PERIODO
				AND IDCAB = CD.IDCAB
				AND JTSOID = CD.JTSOID
				AND TIPOMOV = CD.TIPOMOV
				AND SUCURSALORIGEN = CD.SUCURSALORIGEN
				AND ASIENTO = CD.ASIENTO
				AND FECHAVALOR = CD.FECHAVALOR
				/*AND CODMOVIMIENTO IN (
					SELECT DISTINCT CODIGO_TRANSACCION
					FROM CI_CARGOS
					WHERE TIPO_CARGO_IMPOSITIVO = 6
						AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
							AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
						)
					UNION
					SELECT DISTINCT CODIGO_TRANSACCION 
					FROM CI_IMPUESTOS
					WHERE TIPO_IMPUESTO = 6
						AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
							AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
						)
				)*/
		)
	INNER JOIN CI_FACTURA_LINEA AS FL WITH (nolock) ON
		FL.ASIENTO = CD.ASIENTO
		AND FL.SUCURSAL_ASIENTO = CD.SUCURSALORIGEN
		AND FL.FECHA_PROCESO_ASIENTO = CD.FECHAVALOR
		AND (FL.ID_CARGO IN (
				SELECT ID_CARGO
				FROM CI_CARGOS
				WHERE TIPO_CARGO_IMPOSITIVO = 6
					AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
						AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
					)
			)
			OR FL.ID_IMPUESTO IN (
				SELECT ID_IMPUESTO
				FROM CI_IMPUESTOS
				WHERE TIPO_IMPUESTO = 6
					AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
						AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
					)
			)
		)
		AND ((FL.TZ_LOCK < 100000000000000 OR FL.TZ_LOCK >= 200000000000000)
			AND (FL.TZ_LOCK < 300000000000000 OR FL.TZ_LOCK >= 400000000000000)
		)
	INNER JOIN MONEDAS AS M WITH (nolock) ON
		M.C6399 = CD.MONEDA
	LEFT JOIN CON_COTIZACIONES_BNA AS COT WITH (nolock) ON
		COT.Moneda = CD.MONEDA
		AND COT.Fecha_Cotizacion = dbo.diahabil(CD.FECHA_REAL_MOV, 'D')
		AND ((COT.TZ_LOCK < 100000000000000 OR COT.TZ_LOCK >= 200000000000000)
			AND (COT.TZ_LOCK < 300000000000000 OR COT.TZ_LOCK >= 400000000000000)
		)
	LEFT JOIN HISTORICOTIPOSCAMBIO AS HTC WITH (nolock) ON
		HTC.MONEDA = CD.MONEDA
		AND HTC.FECHA_COTIZACION = dbo.diahabil(CD.FECHA_REAL_MOV, 'D')
		AND HTC.CODIGO_TIPO_CAMBIO = (
			SELECT TOP 1 CODIGO_TIPO_CAMBIO
			FROM HISTORICOTIPOSCAMBIO WITH (nolock)
			WHERE MONEDA = HTC.MONEDA
				AND FECHA_COTIZACION = HTC.FECHA_COTIZACION
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				)
			ORDER BY CODIGO_TIPO_CAMBIO
		)
		AND ((HTC.TZ_LOCK < 100000000000000 OR HTC.TZ_LOCK >= 200000000000000)
			AND (HTC.TZ_LOCK < 300000000000000 OR HTC.TZ_LOCK >= 400000000000000)
		)
	LEFT JOIN RRII_BITACORA_CREDEB AS B WITH (nolock) ON
		B.JTS_OID_SALDOS = CE.JTSOID
		AND B.TIPO_CARGO_IMPOSITIVO = 6
		AND B.FECHA = (
			SELECT TOP 1 FECHA
			FROM RRII_BITACORA_CREDEB
			WHERE JTS_OID_SALDOS = B.JTS_OID_SALDOS
				AND TIPO_CARGO_IMPOSITIVO = B.TIPO_CARGO_IMPOSITIVO
				AND FECHA <= CD.FECHA_REAL_MOV
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				)
		)
		AND ((B.TZ_LOCK < 100000000000000 OR B.TZ_LOCK >= 200000000000000)
			AND (B.TZ_LOCK < 300000000000000 OR B.TZ_LOCK >= 400000000000000)
		)
	LEFT JOIN CI_CARGOS_TARIFAS AS CT WITH (nolock) ON
		CT.ID_CARGO = FL.ID_CARGO
		AND CT.MONEDA = CD.MONEDA
		AND CT.SEGMENTO = ISNULL(B.SEGMENTO, 0)
		AND CT.ID_CLIENTE = 0
		AND CT.EMPRESA = 0
		AND CT.FECHA_DESDE = (
			SELECT TOP 1 FECHA_DESDE
			FROM CI_CARGOS_TARIFAS
			WHERE ID_CARGO = CT.ID_CARGO
				AND MONEDA = CT.MONEDA
				AND SEGMENTO = CT.SEGMENTO
				AND ID_CLIENTE = CT.ID_CLIENTE
				AND EMPRESA = CT.EMPRESA
				AND FECHA_DESDE <= (CD.FECHA_REAL_MOV)
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				)
			ORDER BY FECHA_DESDE DESC
		)
		AND CT.RANGO_HASTA = (
			SELECT TOP 1 RANGO_HASTA
			FROM CI_CARGOS_TARIFAS
			WHERE ID_CARGO = CT.ID_CARGO
				AND MONEDA = CT.MONEDA
				AND SEGMENTO = CT.SEGMENTO
				AND ID_CLIENTE = CT.ID_CLIENTE
				AND EMPRESA = CT.EMPRESA
				AND FECHA_DESDE = CT.FECHA_DESDE
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				) 
		)
		AND ((CT.TZ_LOCK < 100000000000000 OR CT.TZ_LOCK >= 200000000000000)
			AND (CT.TZ_LOCK < 300000000000000 OR CT.TZ_LOCK >= 400000000000000)
		)
	LEFT JOIN CI_IMPUESTOS_TARIFAS AS CI WITH (nolock) ON
		CI.ID_IMPUESTO = FL.ID_IMPUESTO
		AND CI.MONEDA = CD.MONEDA
		AND CI.SEGMENTO = ISNULL(B.SEGMENTO, 0)
		AND CI.ID_CLIENTE = 0
		AND CI.EMPRESA = 0
		AND CI.FECHA_DESDE = (
			SELECT TOP 1 FECHA_DESDE
			FROM CI_IMPUESTOS_TARIFAS
			WHERE ID_IMPUESTO = CI.ID_IMPUESTO
				AND MONEDA = CI.MONEDA
				AND SEGMENTO = CI.SEGMENTO
				AND ID_CLIENTE = CI.ID_CLIENTE
				AND EMPRESA = CI.EMPRESA
				AND FECHA_DESDE <= (CD.FECHA_REAL_MOV)
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				)
			ORDER BY FECHA_DESDE DESC
		)
		AND CI.RANGO_HASTA = (
			SELECT TOP 1 RANGO_HASTA
			FROM CI_IMPUESTOS_TARIFAS
			WHERE ID_IMPUESTO = CI.ID_IMPUESTO
				AND MONEDA = CI.MONEDA
				AND SEGMENTO = CI.SEGMENTO
				AND ID_CLIENTE = CI.ID_CLIENTE
				AND EMPRESA = CI.EMPRESA
				AND FECHA_DESDE = CI.FECHA_DESDE
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
				) 
		)
		AND ((CI.TZ_LOCK < 100000000000000 OR CI.TZ_LOCK >= 200000000000000)
			AND (CI.TZ_LOCK < 300000000000000 OR CI.TZ_LOCK >= 400000000000000)
		)
	LEFT JOIN CON_CREDITO_FISCAL_CREDEB AS CF WITH (nolock) ON
		CF.ALICUOTA_CREDEB = ISNULL(CT.TASA, CI.TASA)
		AND ((CF.TZ_LOCK < 100000000000000 OR CF.TZ_LOCK >= 200000000000000)
			AND (CF.TZ_LOCK < 300000000000000 OR CF.TZ_LOCK >= 400000000000000)
		)
	WHERE
		CE.LEGAL = ''
		AND CE.PERIODO = @resultado
		AND CE.JTSOID = @jts
		AND CD.FECHA_REAL_MOV BETWEEN @fechaDesde AND @fechaHasta
)
SELECT
--	CASE
--		WHEN (TASA * 100) < 1
--			THEN CONCAT(FORMAT(TASA * 1000, 'N2'), ' 0/00')
--		ELSE
--			CONCAT(FORMAT(TASA * 100, 'N2'), ' %')
--	END AS ALICUOTA,
--	FORMAT(TASA_CREDITO_FISCAL, 'P2') AS TASA_CREDITO_FISCAL,
--	SUM(MONTO_CONVERTIDO_MN) AS TOTAL_PERCIBIDO,
	@resultado=(SUM(MONTO_CONVERTIDO_MN) * TASA_CREDITO_FISCAL) 
FROM COBROS_CREDEB
GROUP BY
	TASA,
	TASA_CREDITO_FISCAL

    RETURN @resultado;
END;
GO

