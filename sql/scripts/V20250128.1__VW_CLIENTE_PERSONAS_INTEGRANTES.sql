EXECUTE('
IF OBJECT_ID (''dbo.VW_CLIENTE_PERSONAS_INTEGRANTES'') IS NOT NULL
	DROP VIEW dbo.VW_CLIENTE_PERSONAS_INTEGRANTES
')
EXECUTE('
CREATE VIEW VW_CLIENTE_PERSONAS_INTEGRANTES
AS (
  --Naturales
  SELECT A.CODIGOCLIENTE, A.NUMEROPERSONA, 
    B.TIPOPERSONA,
    B.TIPODOCUMENTO, B.NUMERODOCUMENTO, CONCAT(PF.PRIMERNOMBRE, '' '',PF.APELLIDOPATERNO) AS NOMBREPERSONA,  A.TITULARIDAD
  FROM CLI_ClientePersona A WITH (NOLOCK)
    INNER JOIN CLI_DocumentosPFPJ B WITH (NOLOCK) ON B.NUMEROPERSONAFJ = A.NUMEROPERSONA AND B.TIPOPERSONA = ''F''
    INNER JOIN CLI_PERSONASFISICAS PF WITH (NOLOCK) ON PF.NUMEROPERSONAFISICA = A.NUMEROPERSONA 
  WHERE (A.TZ_LOCK < 300000000000000 OR A.TZ_LOCK >= 400000000000000) 
    AND (B.TZ_LOCK < 300000000000000 OR B.TZ_LOCK >= 400000000000000)
    AND (PF.TZ_LOCK < 300000000000000 OR PF.TZ_LOCK >= 400000000000000) 
  UNION ALL
  --Juridicos
  SELECT A.CODIGOCLIENTE, A.NUMEROPERSONA, 
    B.TIPOPERSONA,
    B.TIPODOCUMENTO, B.NUMERODOCUMENTO, PJ.RAZONSOCIAL AS NOMBREPERSONA,  A.TITULARIDAD
  FROM CLI_ClientePersona A WITH (NOLOCK)
    INNER JOIN CLI_DocumentosPFPJ B WITH (NOLOCK) ON B.NUMEROPERSONAFJ = A.NUMEROPERSONA AND B.TIPOPERSONA = ''J''
    INNER JOIN CLI_PERSONASJURIDICAS PJ WITH (NOLOCK) ON PJ.NUMEROPERSONAJURIDICA = A.NUMEROPERSONA 
  WHERE (A.TZ_LOCK < 300000000000000 OR A.TZ_LOCK >= 400000000000000) 
    AND (B.TZ_LOCK < 300000000000000 OR B.TZ_LOCK >= 400000000000000)
    AND (PJ.TZ_LOCK < 300000000000000 OR PJ.TZ_LOCK >= 400000000000000)
  UNION ALL
  --Integrantes Juridicos
  SELECT A.CODIGOCLIENTE, IPJ.NUMEROPERSONAFISICA AS NUMEROPERSONA, IPJ.TIPO_PERSONA AS TIPOPERSONA, B.TIPODOCUMENTO, B.NUMERODOCUMENTO, 
  CASE WHEN IPJ.TIPO_PERSONA = ''J''
  			THEN (SELECT PJ.RAZONSOCIAL FROM CLI_PERSONASJURIDICAS PJ WITH (NOLOCK) WHERE PJ.NUMEROPERSONAJURIDICA = IPJ.NUMEROPERSONAFISICA)
  	   WHEN IPJ.TIPO_PERSONA = ''F''
  	   		THEN (SELECT CONCAT(PF.PRIMERNOMBRE, '' '',PF.APELLIDOPATERNO) FROM CLI_PERSONASFISICAS PF WITH (NOLOCK) WHERE PF.NUMEROPERSONAFISICA = IPJ.NUMEROPERSONAFISICA)
  END AS NOMBREPERSONA,
  A.TITULARIDAD  
  FROM CLI_INTEGRANTESPJ IPJ WITH (NOLOCK)
  INNER JOIN CLI_DocumentosPFPJ B WITH (NOLOCK) ON B.NUMEROPERSONAFJ = IPJ.NUMEROPERSONAFISICA
  INNER JOIN CLI_ClientePersona A WITH (NOLOCK) ON A.NUMEROPERSONA = ipj.NUMEROPERSONAJURIDICA
  WHERE (A.TZ_LOCK < 300000000000000 OR A.TZ_LOCK >= 400000000000000) 
    AND (B.TZ_LOCK < 300000000000000 OR B.TZ_LOCK >= 400000000000000)
    AND (IPJ.TZ_LOCK < 300000000000000 OR IPJ.TZ_LOCK >= 400000000000000) 
)
')

