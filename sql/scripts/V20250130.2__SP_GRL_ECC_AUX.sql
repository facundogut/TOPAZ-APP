EXECUTE('
CREATE OR ALTER PROCEDURE SP_GRL_ECC_AUX
	@PERIODICIDAD VARCHAR(2),
	@SALDO_JTS_OID NUMERIC(10)--,
	--@FECHA_DESDE DATETIME,
	--@FECHA_HASTA DATETIME
AS
BEGIN
	
	--- FECHA DE CANCELACION
	UPDATE CE
	SET FECHA_CANCELACION = CAN.FECHA_CANCELACION
	FROM GRL_CAB_ENVIO_ESTCTA CE
	INNER JOIN CV_CANCELACION_CUENTAS CAN ON 
		CE.JTSOID = CAN.SALDO_JTS_OID 
		AND CAN.ESTADO = ''F''
		AND ((CAN.TZ_LOCK < 100000000000000 OR CAN.TZ_LOCK >= 200000000000000)
			AND (CAN.TZ_LOCK < 300000000000000 OR CAN.TZ_LOCK >= 400000000000000)  
		)
	WHERE
		CE.LEGAL = ''''
		--AND CE.FECHADESDE = @FECHA_DESDE 
		--AND CE.FECHAHASTA = @FECHA_HASTA
		AND ((@PERIODICIDAD=''P'' AND CE.JTSOID = @SALDO_JTS_OID)
			OR (CE.PERIODO = @PERIODICIDAD AND ISNULL(@SALDO_JTS_OID, 0) = 0)
		)
	
	--- PRODUCTO - MONEDA	
	UPDATE CE
	SET COD_PRODUCTO = S.PRODUCTO,
		COD_MONEDA = S.MONEDA
	FROM GRL_CAB_ENVIO_ESTCTA CE
	INNER JOIN SALDOS S ON
		S.JTS_OID = CE.JTSOID
		AND ((S.TZ_LOCK < 100000000000000 OR S.TZ_LOCK >= 200000000000000)
			AND (S.TZ_LOCK < 300000000000000 OR S.TZ_LOCK >= 400000000000000)  
		)
	WHERE
		CE.LEGAL = ''''
		--AND CE.FECHADESDE = @FECHA_DESDE 
		--AND CE.FECHAHASTA = @FECHA_HASTA
		AND ((@PERIODICIDAD=''P'' AND CE.JTSOID = @SALDO_JTS_OID)
			OR (CE.PERIODO = @PERIODICIDAD AND ISNULL(@SALDO_JTS_OID, 0) = 0)
		)
	
	--- Saldo final - SIRCREB - IIBB_CORRIENTES	
	UPDATE CE
	SET SALDO_FINAL = CD.SALDOCALCLINEA,
		SIRCREB = CD.SIRCREB,
		IIBB_CORRIENTES = CD.IIBB_CORRIENTES
	FROM GRL_CAB_ENVIO_ESTCTA CE
	INNER JOIN GRL_DET_ENVIO_ESTCTA CD ON 
		CD.IDCAB = CE.IDCAB 
		AND CD.JTSOID = CE.JTSOID 
		AND CD.TIPOMOV = ''F''
	WHERE
		CE.LEGAL = ''''
		--AND CE.FECHADESDE = @FECHA_DESDE 
		--AND CE.FECHAHASTA = @FECHA_HASTA
		AND ((@PERIODICIDAD=''P'' AND CE.JTSOID = @SALDO_JTS_OID)
			OR (CE.PERIODO = @PERIODICIDAD AND ISNULL(@SALDO_JTS_OID, 0) = 0)
		)
	
	--- Tipo cambio	
	UPDATE CE
	SET TIPO_CAMBIO_OFICIAL = H.TIPO_CAMBIO_OFICIAL
	FROM GRL_CAB_ENVIO_ESTCTA CE
	INNER JOIN HISTORICOTIPOSCAMBIO AS H ON 
		H.MONEDA = CE.COD_MONEDA
		AND H.FECHA_COTIZACION = (
									SELECT TOP 1 FECHA_COTIZACION 
									FROM HISTORICOTIPOSCAMBIO WITH(NOLOCK)
									WHERE
										MONEDA = H.MONEDA
										AND FECHA_COTIZACION <= (SELECT FECHAPROCESO FROM PARAMETROS WITH (nolock))
										AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
											AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  
										)
									ORDER BY FECHA_COTIZACION DESC
								)
		AND ((H.TZ_LOCK < 100000000000000 OR H.TZ_LOCK >= 200000000000000)
			AND (H.TZ_LOCK < 300000000000000 OR H.TZ_LOCK >= 400000000000000)  
		)
	WHERE
		CE.LEGAL = ''''
		--AND CE.FECHADESDE = @FECHA_DESDE 
		--AND CE.FECHAHASTA = @FECHA_HASTA
		AND ((@PERIODICIDAD=''P'' AND CE.JTSOID = @SALDO_JTS_OID)
			OR (CE.PERIODO = @PERIODICIDAD AND ISNULL(@SALDO_JTS_OID, 0) = 0)
		)

END
')

