EXECUTE('
DROP PROCEDURE IF EXISTS SP_PA_REVISION_DE_TASAS_ACUERDOS
')

EXECUTE('
CREATE PROCEDURE SP_PA_REVISION_DE_TASAS_ACUERDOS
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS
BEGIN
DECLARE @CANTIDAD_REGISTROS INT
DECLARE @REVISION_TASAS_ACUERDOS_AUX TABLE (NRO_AUTORIZACION NUMERIC(10,0), TIPO_TASA_BASE VARCHAR(3),
							   TASA_BASE_ACTUAL NUMERIC(11,7),
							   TASA_ACTUAL NUMERIC (11,7),PUNTOS_TASA NUMERIC (11,7), NUEVA_TASA NUMERIC(11,7),
							   NUEVA_TASA_BASE NUMERIC (11,7))
							   
	SET @P_RET_PROCESO = NULL
    SET @P_MSG_PROCESO = NULL
	SELECT @P_DT_PROCESO=(SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))
---Insert a la tabla temporal en base a la siguiente query
BEGIN
	INSERT INTO @REVISION_TASAS_ACUERDOS_AUX
	SELECT  VTA.NRO_AUTORIZACION, 
				vt.TIPO_TASA_BASE,
				vt.TASA_BASE AS TASA_BASE_ACTUAL,
				vt.TASA AS TASA_ACTUAL,
				vt.PUNTOS_TASA,
				(tb1.TASA+vt.PUNTOS_TASA) AS NUEVA_TASA,
				tb1.TASA AS NUEVA_TASA_BASE
	FROM VTA_SOBREGIROS VTA WITH (NOLOCK) 
	INNER JOIN VTA_TASAS_SOBREGIROS vt WITH (NOLOCK) ON vt.NRO_ACUERDO=VTA.NRO_AUTORIZACION   
	INNER JOIN (SELECT TIPOTASABASE, max(VIGENCIADESDE) AS VIGENCIADESDE FROM TASASBASE WITH (NOLOCK) 
				 			 WHERE TZ_LOCK=0 
							 GROUP BY TIPOTASABASE) tb ON tb.TIPOTASABASE=vt.TIPO_TASA_BASE 
	INNER JOIN TASASBASE tb1 WITH (NOLOCK) ON tb1.TIPOTASABASE = vt.TIPO_TASA_BASE 
			     					      AND tb1.VIGENCIADESDE=tb.VIGENCIADESDE AND tb1.TZ_LOCK=0
	WHERE VTA.ESTADO=1  
		  AND vt.TIPO_TASA=''V''
		  AND tb1.TASA <> ISNULL(vt.TASA_BASE,0)
		  AND VTA.TZ_LOCK=0 
			  

	SET @CANTIDAD_REGISTROS = (SELECT COUNT(*) FROM @REVISION_TASAS_ACUERDOS_AUX)
END
BEGIN

-- Update saldos set PUNTOSTASA = nuevos puntos tea
--De donde salen NUEVOS PUNTOS TEA
	UPDATE vta 
	SET vta.TASA = RTA.NUEVA_TASA,
		vta.TASA_MORA = RTA.NUEVA_TASA/2,
		vta.TASA_BASE = RTA.NUEVA_TASA_BASE
	FROM VTA_TASAS_SOBREGIROS vta
	INNER JOIN @REVISION_TASAS_ACUERDOS_AUX RTA ON vta.NRO_ACUERDO=RTA.NRO_AUTORIZACION
	
END
    SET @P_MSG_PROCESO = ''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros''     
           
    SET @P_RET_PROCESO = 1
      
    DECLARE @p_tipo_error varchar(80)
    SET @p_tipo_error=''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros'' 

EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
				@P_ID_PROCESO,
		    	@P_DT_PROCESO,
		    	''SP_PA_REVISION_DE_TASAS_ACUERDOS'',
		    	@P_RET_PROCESO,
		    	@P_MSG_PROCESO,
		    	@p_tipo_error
		    	
		    	
END
')