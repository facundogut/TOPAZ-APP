EXECUTE('

CREATE  OR ALTER  PROCEDURE [dbo].[SP_INSERT_CHE_BCO_RECHAZADOS]
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS
BEGIN

    DECLARE @NumFilasInsertadas INT;

    INSERT INTO dbo.CHE_BCO_RECHAZADOS    
    SELECT
    0 AS TZ_LOCK,
    S.SUCURSAL AS SUCURSAL,
    cc.MONEDA AS MONEDA,
    S.PRODUCTO AS PRODUCTO,
    S.CUENTA AS CUENTA,
    cc.SERIE_DEL_CHEQUE AS SERIE_CHEQUE,
    cc.NUMERO_CHEQUE AS NRO_CHEQUE,
    cc.IMPORTE AS IMPORTE_CHEQUE,
    --CASE PQ SI EL CHEQUE NO ESTA EN LA CHE_CHEQUES EL VALOR ES NULL Y ESTE CAMPO ES PK DE LA BCO
    CASE 
    WHEN CCC.FECHAINGRESO IS NULL 
    THEN (SELECT P.FECHAPROCESO FROM parametros P) 
    ELSE CCC.FECHAINGRESO
    END AS FECHA_CHEQUE,
    ccc.FECHAINGRESO AS FECHA_EMISION,
    ccc.FECHA_VENCIMIENTO AS FECHA_VENCIMIENTO,
    S.C1803 AS CLIENTE,
    '''' AS FORMA_PRESENTO,
    0 AS ESTADO,
    NULL AS FECHA_ESTADO,
    CTC.CODIGO_RRII AS COD_RECHAZO,
    cc.FECHA_ACREDITACION AS FECHA_RECHAZO,
    CTC.DESCRIPCION AS MOTIVO_RECHAZO,
    15 AS CODIGO_DE_CAUSAL,
    S.JTS_OID AS JTS_SALDOS,
    0 AS Nro_Aviso,
    cc.SUCURSAL_DE_INGRESO AS SUCURSAL_DEVOLUCION,
    '''' AS CLASEREINCIDENCIA,
    NULL AS FECHA_REINTEGRO,
    NULL AS FECHA_MAXIMA_REINTEGRO,
    cc.FECHA_ACREDITACION AS FECHA_NOTIFICACION,
    NULL AS FECHA_NOTIF_JUDICIAL,
    NULL AS FECHA_NOTIF_BCRA,
    0 AS IMPORTE_MULTA,
    0 AS BONIFICACION_MULTA,
    NULL AS FECHA_PAGO_MULTA
    FROM 
        CLE_CHEQUES_SALIENTE cc
        --ENTRAMOS A LA CHE_CHEQUERES PARA OBTENER EL JTS_OID PQ EL DE LA SALIENTE NO ES EL QUE SE NECESITA
    INNER JOIN CHE_CHEQUERAS CHEQ ON 
    cc.NUMERO_CHEQUE>=CHEQ.CHEQUEDESDE
    AND cc.NUMERO_CHEQUE<=CHEQ.CHEQUEHASTA
    AND cc.SUCURSAL_BANCO_GIRADO=CHEQ.SUCURSAL
    AND cc.MONEDA=CHEQ.MONEDA
    INNER JOIN SALDOS S ON 
    CHEQ.SUCURSAL=S.SUCURSAL
    AND CHEQ.MONEDA=S.MONEDA
    AND CHEQ.PRODUCTO=S.PRODUCTO
    AND CHEQ.CUENTA=S.CUENTA    
    LEFT JOIN 
        CHE_CHEQUES ccc ON cc.SUCURSAL_DE_INGRESO = ccc.SUCURSAL
                         AND cc.MONEDA = ccc.MONEDA
                         AND cc.NUMERO_CHEQUE = ccc.NUMEROCHEQUE
                         AND cc.SERIE_DEL_CHEQUE = ccc.SERIE
    INNER JOIN 
        CLE_TIPO_CAUSAL CTC ON CTC.CODIGO_DE_CAUSAL = 15
    WHERE 
        cc.ESTADO = 70 
        AND cc.BANCO_GIRADO = 311 
        AND cc.FECHA_ACREDITACION = (SELECT FECHAPROCESO FROM PARAMETROS)
        AND NOT EXISTS (
            SELECT 1 
            FROM dbo.CHE_BCO_RECHAZADOS bco
            WHERE 
                bco.SUCURSAL = cc.SUCURSAL_DE_INGRESO AND
                bco.MONEDA = cc.MONEDA AND
                bco.NRO_CHEQUE = cc.NUMERO_CHEQUE AND
                bco.SERIE_CHEQUE = cc.SERIE_DEL_CHEQUE
        )
    
    SET @NumFilasInsertadas = (SELECT @@ROWCOUNT)
    
    IF @NumFilasInsertadas > 0
    BEGIN
        SET @P_RET_PROCESO = 1  
        SET @P_MSG_PROCESO = CAST(@NumFilasInsertadas AS VARCHAR(MAX)) + '' registros insertados correctamente''
    END
    ELSE
    BEGIN
        SET @P_RET_PROCESO = 0  
        SET @P_MSG_PROCESO = ''No se realizaron inserciones; los registros ya est√°n presentes en la tabla o no hay datos para procesar.''
    END
END;
')
