EXECUTE('
CREATE OR ALTER  PROCEDURE [dbo].[SP_ITF_SOS_LAVADOPERDFILDET]
AS


DECLARE @Fecha NUMERIC(8)
DECLARE @Periodo NUMERIC(8)
DECLARE @FechaDesde NUMERIC(8)
DECLARE @FechaHasta NUMERIC(8)
DECLARE @PrimerDiaMesAnterior NUMERIC(8)
DECLARE @UltimoDiaFechaDesde  NUMERIC(8)
DECLARE @FechaProcesoAFIP DATETIME
DECLARE @PriFecProcesoAFIP NUMERIC(8);
DECLARE @UltimoDiaMesAnterior NUMERIC(8);
DECLARE @UltimoDiaFechaDesdeDoce NUMERIC(8);
DECLARE @UltimoDiaFechaDesdeDoceAfip NUMERIC(8);

BEGIN 

SET ANSI_WARNINGS OFF; 

SELECT @Fecha = CONVERT(VARCHAR,FECHAPROCESO,112),
@Periodo = SUBSTRING(CONVERT(VARCHAR,EOMONTH(FECHAPROCESO,-1),112),1,6),
@FechaDesde = CONVERT(VARCHAR, DATEADD(dd,1,EOMONTH(EOMONTH(FECHAPROCESO,-1), -12)),112),
@FechaHasta = convert(VARCHAR,EOMONTH(FECHAPROCESO,-1),112),
@PrimerDiaMesAnterior = convert(VARCHAR,DATEADD(DAY, 1,EOMONTH(FECHAPROCESO,-2)),112),
@UltimoDiaFechaDesde = CONVERT(VARCHAR, EOMONTH(DATEADD(dd,1,EOMONTH(EOMONTH(FECHAPROCESO,-1), -12))),112),
@UltimoDiaMesAnterior = convert(VARCHAR,EOMONTH(FECHAPROCESO,-1),112),
@UltimoDiaFechaDesdeDoce = CONVERT(VARCHAR, EOMONTH(DATEADD(dd,1,EOMONTH(DATEADD(DAY, 1,EOMONTH(FECHAPROCESO,-2)), 10))),112)
FROM PARAMETROS (NOLOCK);

DELETE FROM SOS_LAVADOPERDFILDET WHERE PERIODO = @Periodo;

SELECT @FechaProcesoAFIP = MAX(FECHAHORA) 
FROM ITF_BITACORA 
WHERE INTERFACE = ''AFIP'';

SET @PriFecProcesoAFIP = convert(VARCHAR,DATEADD(DAY, 1,EOMONTH(@FechaProcesoAFIP,-1)),112);
SET @UltimoDiaFechaDesdeDoceAfip = CONVERT(VARCHAR, EOMONTH(DATEADD(dd,1,EOMONTH(DATEADD(DAY, 1,EOMONTH(@FechaProcesoAFIP,-1)), 10))),112);

WITH PersonasFJ
AS(
SELECT b.TIPODOCUMENTO, B.NUMERODOCUMENTO, A.NUMEROPERSONAFISICA AS NUMEROPERSONA, B.TIPOPERSONA,
  11 AS IDENTTRIBUTARIATIPO, A.MONOTRIBUTO
FROM CLI_PERSONASFISICAS A (NOLOCK)
  INNER JOIN CLI_DocumentosPFPJ B (NOLOCK) ON B.NUMEROPERSONAFJ = A.NUMEROPERSONAFISICA
    AND B.TZ_LOCK = 0 AND A.TZ_LOCK = 0
UNION
SELECT b.TIPODOCUMENTO, B.NUMERODOCUMENTO, A.NUMEROPERSONAJURIDICA AS NUMEROPERSONA, B.TIPOPERSONA,
  (CASE WHEN A.TIPOSOCIEDAD IN (66,29) THEN A.TIPOSOCIEDAD ELSE 11 END) AS IDENTTRIBUTARIATIPO, A.MONOTRIBUTO
FROM CLI_PERSONASJURIDICAS A (NOLOCK)
  INNER JOIN CLI_DocumentosPFPJ B (NOLOCK) ON B.NUMEROPERSONAFJ = A.NUMEROPERSONAJURIDICA
    AND B.TZ_LOCK = 0 AND A.TZ_LOCK = 0
)



INSERT INTO SOS_LAVADOPERDFILDET
--Sueldos
SELECT ''0311'' AS EMPRESA,
    pfj.IDENTTRIBUTARIATIPO, 
	pfj.NUMERODOCUMENTO, 
    ''SUELDOS'' AS Origen,
	ISNULL(ROUND((SUM(MONTO)/COUNT(DISTINCT SUBSTRING(CONVERT(VARCHAR,FECHA,112),1,6))),2),0) AS MONTO,
	@PrimerDiaMesAnterior AS FECHAVIGENCIADESDE,
	@UltimoDiaMesAnterior AS FECHAVIGENCIAHASTA,
	'''' AS OBSERVACIONES,
	@Fecha AS FECHAPROCESO,
	@Periodo AS PERIODO
FROM CRE_SOL_ACREDITACIONES_SUELDOS A (NOLOCK)
  INNER JOIN SALDOS B (NOLOCK) ON A.SALDO_JTS_OID = B.JTS_OID AND A.TZ_LOCK = 0
    AND CONVERT(VARCHAR, A.FECHA,112) BETWEEN @FechaDesde AND @FechaHasta
  INNER JOIN VW_CLI_X_DOC c (NOLOCK) ON c.CODIGOCLIENTE = B.C1803
  RIGHT JOIN PersonasFJ pfj ON pfj.NUMERODOCUMENTO = c.NUMERODOC AND pfj.TIPODOCUMENTO = c.TIPODOC
GROUP BY pfj.IDENTTRIBUTARIATIPO, pfj.NUMERODOCUMENTO
UNION
--Agencieros
SELECT ''0311'' AS EMPRESA,
    pfj.IDENTTRIBUTARIATIPO, 
	pfj.NUMERODOCUMENTO, 
	''AGENCIEROS'' AS Origen,
	ISNULL(ROUND((SUM(IMPORTE)/COUNT(DISTINCT SUBSTRING(CONVERT(VARCHAR,FCHA_PROCESAR,112),1,6))),2),0) AS MONTO,
	@PrimerDiaMesAnterior AS FECHAVIGENCIADESDE,
	@UltimoDiaFechaDesdeDoce AS FECHAVIGENCIAHASTA,
	'''' AS OBSERVACIONES,
	@Fecha AS FECHAPROCESO,
	@Periodo AS PERIODO
FROM GRL_ACREDITACIONES_MASIVAS A (NOLOCK)
  INNER JOIN SALDOS B (NOLOCK) ON A.CTA_DEB = B.JTS_OID AND A.CANAL = ''LOTE'' AND A.ESTADO = ''P'' AND A.TIPO_ACREDITACION = ''AGEN''
    AND CONVERT(VARCHAR, A.FCHA_PROCESAR,112) BETWEEN @FechaDesde AND @FechaHasta
  INNER JOIN VW_CLI_X_DOC c (NOLOCK) ON c.CODIGOCLIENTE = B.C1803
  RIGHT JOIN PersonasFJ pfj ON pfj.NUMERODOCUMENTO = c.NUMERODOC AND pfj.TIPODOCUMENTO = c.TIPODOC
GROUP BY pfj.IDENTTRIBUTARIATIPO, pfj.NUMERODOCUMENTO
UNION
--Comercial
SELECT ''0311'' AS EMPRESA,
    pfj.IDENTTRIBUTARIATIPO, 
	pfj.NUMERODOCUMENTO, 
	''COMERCIAL'' AS Origen, 
	ISNULL(a.TOTAL_VENTAS,0) AS MONTO,
	CONVERT(VARCHAR, a.F_INICIO, 112) AS FECHAVIGENCIADESDE,
	CONVERT(VARCHAR, a.F_FINAL, 112) AS FECHAVIGENCIAHASTA,
	'''' AS OBSERVACIONES,
	@Fecha AS FECHAPROCESO,
	@Periodo AS PERIODO
FROM CRE_TAM_EMP_BALANCE A (NOLOCK)
	RIGHT JOIN PersonasFJ pfj ON pfj.NUMERODOCUMENTO = a.DOCUMENTO AND pfj.TIPODOCUMENTO = a.TIPO_DOCUMENTO
WHERE a.F_INICIO = (SELECT MAX(F_INICIO) 
					FROM CRE_TAM_EMP_BALANCE T (NOLOCK)
					WHERE T.ID_PERSONA = A.ID_PERSONA 
					  AND T.TIPO_PERSONA = A.TIPO_PERSONA
					  AND T.TZ_LOCK = 0)
  AND A.TZ_LOCK = 0
UNION
--Monotributista
SELECT ''0311'' AS EMPRESA,
    pfj.IDENTTRIBUTARIATIPO, 
	pfj.NUMERODOCUMENTO, 
	''MONOTRIBUTISTAS'' AS Origen, 
	ISNULL((SELECT m.IngresoProyectado FROM ITF_MTO_X_MONOTRIBUTISTA m (NOLOCK) WHERE m.Categoria = afip.MONOTRIBUTO_CATEGORIA
	  AND m.FechaVigenciaDesde = (SELECT mn.FechaVigenciaDesde FROM ITF_MTO_X_MONOTRIBUTISTA mn (NOLOCK)
	  						      WHERE mn.Categoria = m.Categoria 
	  						        AND CONVERT(VARCHAR,mn.FechaVigenciaDesde,112) < @FechaHasta)),0) AS MONTO,
	@PriFecProcesoAFIP AS FECHAVIGENCIADESDE,
	@UltimoDiaFechaDesdeDoceAfip AS FECHAVIGENCIAHASTA,
	'''' AS OBSERVACIONES,
	@Fecha AS FECHAPROCESO,
	@Periodo AS PERIODO
FROM PersonasFJ pfj
  LEFT JOIN ITF_AFIP_PUCA afip ON afip.CUIT = pfj.NUMERODOCUMENTO

SET ANSI_WARNINGS ON;
 
END
')