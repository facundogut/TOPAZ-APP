EXECUTE('
CREATE OR ALTER   PROCEDURE [dbo].[SP_ITF_SOS_PERFILDOC]
	@Fecha VARCHAR(8)
AS
BEGIN

--Limpiamos por si hay reproceso
DELETE FROM SOS_PERFILDOC WHERE convert(VARCHAR,FECHADEINFORMACION) = @Fecha;

INSERT INTO SOS_PERFILDOC(EMPRESA, FECHADEINFORMACION, IDENTTRIBUTARIATIPO, IDENTTRIBUTARIANUMERO,
  MONTOPERFIL, FECHAALTAPERFIL, OBSERVACIONES)
SELECT ''311'' AS EMPRESA,
  @Fecha AS FECHADEINFORMACION,
  11 AS IDENTTRIBUTARIATIPO,
  T.NUMERODOCUMENTO AS IDENTTRIBUTARIANUMERO,
  A.PROMEDIO_SUELDOS AS MONTOPERFIL, 
  CONVERT(VARCHAR, A.FECHA_ACTUALIZACION,112) AS FECHAALTAPERFIL,
  '''' AS OBSERVACIONES
FROM dbo.VW_CLIENTE_PFPJ T--dbo.CLI_CLIENTES  AS R WITH(NOLOCK)
  --INNER JOIN dbo.CLI_CLIENTEPERSONA T WITH(NOLOCK) ON R.CODIGOCLIENTE = T.CODIGOCLIENTE
  INNER JOIN dbo.CLI_PERSONASFISICAS U WITH(NOLOCK) ON U.NUMEROPERSONAFISICA = T.NUMEROPERSONA
  --INNER JOIN dbo.CLI_DOCUMENTOSPFPJ V WITH(NOLOCK) ON U.NUMEROPERSONAFISICA = V.NUMEROPERSONAFJ AND V.TIPOPERSONA = ''N''
  INNER JOIN dbo.CLI_PERFILDOCUMENTAL A WITH(NOLOCK) ON A.ID_PERSONA = U.NUMEROPERSONAFISICA
WHERE (A.TZ_LOCK < 100000000000000 OR A.TZ_LOCK >= 200000000000000) AND 
      --((R.TZ_LOCK < 300000000000000 OR R.TZ_LOCK >= 400000000000000) AND (R.TZ_LOCK < 100000000000000 OR R.TZ_LOCK >= 200000000000000)) AND 
      --((T.TZ_LOCK < 300000000000000 OR T.TZ_LOCK >= 400000000000000) AND (T.TZ_LOCK < 100000000000000 OR T.TZ_LOCK >= 200000000000000)) AND 
      ((U.TZ_LOCK < 300000000000000 OR U.TZ_LOCK >= 400000000000000) AND (U.TZ_LOCK < 100000000000000 OR U.TZ_LOCK >= 200000000000000)) AND 
      --((V.TZ_LOCK < 300000000000000 OR V.TZ_LOCK >= 400000000000000) AND (V.TZ_LOCK < 100000000000000 OR V.TZ_LOCK >= 200000000000000)) AND
      NOT EXISTS(SELECT 1 FROM CLI_CLIENTES cli WITH(NOLOCK)
   					INNER JOIN CLI_ClientePersona p WITH(NOLOCK) ON p.CODIGOCLIENTE = cli.CODIGOCLIENTE
  					INNER JOIN CLI_PERSONASFISICAS nat WITH(NOLOCK) ON p.NUMEROPERSONA = nat.NUMEROPERSONAFISICA
  				 WHERE cli.CODIGOCLIENTE = T.CODIGOCLIENTE
  				   AND nat.SECTOR IN (6,7)
  				   AND cli.TZ_LOCK = 0
  				   AND p.TZ_LOCK = 0
  				   AND nat.TZ_LOCK = 0)
  				   
UNION ALL
SELECT ''311'' AS EMPRESA,
  @Fecha AS FECHADEINFORMACION,
  (CASE WHEN s.TIPOSOCIEDAD IN (66,29) THEN s.TIPOSOCIEDAD ELSE 11 END) AS IDENTTRIBUTARIATIPO,
  T.NUMERODOCUMENTO AS IDENTTRIBUTARIANUMERO,
  A.PROMEDIO_SUELDOS AS MONTOPERFIL, 
  CONVERT(VARCHAR, A.FECHA_ACTUALIZACION,112) AS FECHAALTAPERFIL,
  '''' AS OBSERVACIONES
FROM dbo.VW_CLIENTE_PFPJ T --dbo.CLI_CLIENTES  AS R WITH(NOLOCK)
  --INNER JOIN dbo.CLI_CLIENTEPERSONA  AS T WITH(NOLOCK) ON R.CODIGOCLIENTE = T.CODIGOCLIENTE
  INNER JOIN dbo.CLI_PERSONASJURIDICAS  AS S WITH(NOLOCK) ON S.NUMEROPERSONAJURIDICA = T.NUMEROPERSONA
  --INNER JOIN dbo.CLI_DOCUMENTOSPFPJ  AS V WITH(NOLOCK) ON V.NUMEROPERSONAFJ = S.NUMEROPERSONAJURIDICA AND V.TIPOPERSONA = ''J''
  INNER JOIN dbo.CLI_PERFILDOCUMENTAL A WITH(NOLOCK) ON A.ID_PERSONA = S.NUMEROPERSONAJURIDICA
WHERE (A.TZ_LOCK < 100000000000000 OR A.TZ_LOCK >= 200000000000000) AND 
      --((R.TZ_LOCK < 300000000000000 OR R.TZ_LOCK >= 400000000000000) AND (R.TZ_LOCK < 100000000000000 OR R.TZ_LOCK >= 200000000000000)) AND 
      --((T.TZ_LOCK < 300000000000000 OR T.TZ_LOCK >= 400000000000000) AND (T.TZ_LOCK < 100000000000000 OR T.TZ_LOCK >= 200000000000000)) AND 
      ((S.TZ_LOCK < 300000000000000 OR S.TZ_LOCK >= 400000000000000) AND (S.TZ_LOCK < 100000000000000 OR S.TZ_LOCK >= 200000000000000)) AND 
      --((V.TZ_LOCK < 300000000000000 OR V.TZ_LOCK >= 400000000000000) AND (V.TZ_LOCK < 100000000000000 OR V.TZ_LOCK >= 200000000000000)) AND
      NOT EXISTS(SELECT 1 FROM CLI_CLIENTES cli WITH(NOLOCK)
   					INNER JOIN CLI_ClientePersona p WITH(NOLOCK) ON p.CODIGOCLIENTE = cli.CODIGOCLIENTE
  					INNER JOIN CLI_PERSONASJURIDICAS jur WITH(NOLOCK) ON p.NUMEROPERSONA = jur.NUMEROPERSONAJURIDICA
  				 WHERE cli.CODIGOCLIENTE = T.CODIGOCLIENTE
  				   AND jur.SECTOR IN (6,7)
  				   AND cli.TZ_LOCK = 0
  				   AND p.TZ_LOCK = 0
  				   AND jur.TZ_LOCK = 0)

END
')