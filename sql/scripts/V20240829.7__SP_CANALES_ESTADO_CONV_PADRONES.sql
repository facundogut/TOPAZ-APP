EXECUTE('
CREATE OR ALTER PROCEDURE SP_CANALES_ESTADO_CONV_PADRONES
   @P_ID_LIQUIDACION NUMERIC(15),
   @P_ASIENTO	     NUMERIC(10),
   @ESTADO           VARCHAR(1),
   @P_RESULTADO	VARCHAR(5) OUTPUT
   
AS 

BEGIN

 SET @P_RESULTADO = ''ERROR''
 
 
 DECLARE @TablaAux TABLE(
		ID                       NUMERIC(15),
		ID_LINEA				 NUMERIC(15),
		NRO_COMPROBANTE_CLIENTE  NUMERIC(12),
		LETRA					 VARCHAR(1),
		PUNTO_VENTA				 VARCHAR(4),
		TOTAL_CARGO_ESPECIFICO   NUMERIC(15,2)
	)

  IF @ESTADO = ''A''	
   BEGIN	
	
	
	BEGIN
	
		INSERT INTO @TablaAux
		SELECT DISTINCT L.ID_CABEZAL, RD.ID_LINEA, VW.NRO_COMPROBANTE_CLIENTE, VW.LETRA,
		                VW.PUNTO_VENTA,VW.TOTAL_CARGO_ESPECIFICO
		  FROM REC_LIQUIDACION L		 
		                               
		 INNER JOIN REC_DET_RECAUDOS_CANAL RD ON RD.ID_CABEZAL = l.ID_CABEZAL
		                                       AND RD.TZ_LOCK =0 
		 
		 INNER JOIN VW_CANAL_REND_CARGO_ESPECIFICO VW ON VW.ID_CABEZAL = l.ID_CABEZAL
		                                         AND VW.ID_CABEZAL = RD.ID_CABEZAL
		                                         AND VW.ID_LINEA = Rd.ID_LINEA
		                                         AND VW.ESTADO = ''P''
		 WHERE l.ID_LIQUIDACION = @P_ID_LIQUIDACION
		   AND l.TZ_LOCK = 0;
		
	END
	
    BEGIN
		UPDATE REC_DET_RECAUDOS_CANAL
		SET
			TOTAL_CARGO_ESPECIFICO = c.TOTAL_CARGO_ESPECIFICO
		FROM REC_DET_RECAUDOS_CANAL A
		JOIN @TablaAux C ON
			A.ID_CABEZAL=c.ID
			AND a.ID_LINEA = c.ID_LINEA
		WHERE TZ_LOCK = 0
		
		UPDATE CONV_PADRONES
		SET
			ESTADO = ''C'',
			REF_TOPAZ = @P_ASIENTO
		FROM CONV_PADRONES A
		JOIN @TablaAux C ON
			A.NRO_COMPROBANTE_CLIENTE = c.NRO_COMPROBANTE_CLIENTE
			AND A.LETRA = c.LETRA
			AND A.PUNTO_VENTA = c.PUNTO_VENTA
		WHERE TZ_LOCK = 0
		
		SET @P_RESULTADO = ''OK''
	
	
		
	END
   END
   
  
  END
')
