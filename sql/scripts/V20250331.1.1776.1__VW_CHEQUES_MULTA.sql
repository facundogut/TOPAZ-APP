EXECUTE('
	IF OBJECT_ID (''dbo.VW_CHEQUES_MULTA'') IS NOT NULL
		DROP VIEW dbo.VW_CHEQUES_MULTA
')

EXECUTE('
	CREATE OR ALTER VIEW [dbo].[VW_CHEQUES_MULTA] (
			[Número de cheque],
			Sucursal,
			Cuenta,
			Denominación,
			Producto,
			Moneda,
			Importe,
			[Causal de Devolución],
			Descripción,
			[Fecha de rechazo],
			Cliente,
			Serie,
			Banco,
			Multa,
			[Fecha pago de multa],
			[Número de aviso],
			[Fecha notificación BCRA],
			Fecha)
	AS 
	SELECT 
		DISTINCT 
			B.NRO_CHEQUE,
			B.SUCURSAL,
			B.CUENTA,
			VS.NOMBRE_CUENTA,
			B.PRODUCTO,
			B.MONEDA,
			B.IMPORTE_CHEQUE,
			B.CODIGO_DE_CAUSAL,
			T.DESCRIPCION,
			B.FECHA_CHEQUE,
			B.CLIENTE,
			B.SERIE_CHEQUE,
			D.CODBANCO,
			T.MULTA,
			B.FECHA_PAGO_MULTA,
			B.Nro_Aviso,
			B.FECHA_NOTIF_BCRA,
			D.FECHACHEQUE
	FROM CHE_BCO_RECHAZADOS B WITH (NOLOCK)
	INNER JOIN SALDOS S WITH (NOLOCK) ON 
		S.SUCURSAL = B.SUCURSAL
		AND S.MONEDA = B.MONEDA
		AND S.PRODUCTO = B.PRODUCTO
		AND S.CUENTA = B.CUENTA
		AND S.TZ_LOCK = 0
	INNER JOIN CLE_TIPO_CAUSAL T WITH (NOLOCK) ON 
		T.CODIGO_DE_CAUSAL = B.CODIGO_DE_CAUSAL
		AND ((T.TZ_LOCK < 100000000000000 OR T.TZ_LOCK >= 200000000000000)
			AND (T.TZ_LOCK < 300000000000000 OR T.TZ_LOCK >= 400000000000000)  
		)
	INNER JOIN VTA_SALDOS VS WITH (NOLOCK) ON 
		S.JTS_OID = VS.JTS_OID_SALDO
		AND ((VS.TZ_LOCK < 100000000000000 OR VS.TZ_LOCK >= 200000000000000)
			AND (VS.TZ_LOCK < 300000000000000 OR VS.TZ_LOCK >= 400000000000000)  
		)
	LEFT JOIN CLE_CHEQUES_CLEARING_DEVUELTOS D WITH (NOLOCK) ON
		D.SERIE = B.SERIE_CHEQUE
		AND D.NROCHEQUE = B.NRO_CHEQUE
		AND D.SUCURSAL = B.SUCURSAL
		AND D.MONEDA = B.MONEDA
		AND D.PRODUCTO = B.PRODUCTO
		AND D.CUENTA = B.CUENTA
		AND D.TZ_LOCK = 0
		AND D.FECHACHEQUE = (
			SELECT TOP 1 FECHACHEQUE
			FROM CLE_CHEQUES_CLEARING_DEVUELTOS WITH (NOLOCK)
			WHERE 
				SERIE = D.SERIE
				AND NROCHEQUE = D.NROCHEQUE
				AND SUCURSAL = D.SUCURSAL
				AND MONEDA = D.MONEDA
				AND PRODUCTO = D.PRODUCTO
				AND CUENTA = D.CUENTA
				AND TZ_LOCK = 0
				AND FECHACHEQUE <= (SELECT FECHAPROCESO FROM PARAMETROS)
				ORDER BY FECHACHEQUE DESC
		)
	WHERE
		B.TZ_LOCK = 0
')

