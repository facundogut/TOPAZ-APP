EXECUTE('
CREATE OR ALTER  PROCEDURE SP_CHEQUE_APODERADO
   @P_NRODOC NUMERIC (11, 0),
   @P_CUENTA NUMERIC (11, 0),
   

   @CANT_INTEGRANTES_DENUNCIADOS NUMERIC (12, 0) OUTPUT,
   @CANT_INTEGRANTES_RECHAZADOS NUMERIC (12, 0) OUTPUT
      
AS 

   BEGIN

		--Fecha parametro
		DECLARE @FECHA_PARAMETRO AS DATETIME;
		SET @FECHA_PARAMETRO = CONVERT(DATETIME,(SELECT FECHAPROCESO FROM PARAMETROS),103);
		
		--DECLARO TABLA AUXILIAR BaseIDs--
		  DECLARE @Tabla_BaseDenunciados TABLE(
		  NRODOC            VARCHAR (20),
		  CUENTA            NUMERIC (12, 0)
		  )
		
		--Traigo personas apoderadas de la cuenta Cheques denunciados
		INSERT INTO @Tabla_BaseDenunciados
		SELECT
		    ISNULL(VW.NroDocIdent,0) AS NRODOC, 
		    ISNULL(S.CUENTA,0) AS CUENTA
		    --ROW_NUMBER() OVER (PARTITION BY S.CUENTA ORDER BY A.ID_PERSONA) AS NR
		
		FROM SALDOS S WITH(NOLOCK) 
		
		INNER JOIN CHE_CHEQUESDENUNCIADOS CD WITH(NOLOCK) ON
		    CD.SUCURSAL=S.SUCURSAL AND
		    CD.MONEDA=S.MONEDA AND
		    CD.CUENTA=S.CUENTA AND
		    CD.PRODUCTO=S.PRODUCTO AND
		    CD.OPERACION=S.OPERACION AND
		    CD.ORDINAL=S.ORDINAL AND
		    --CD.FECHAREGISTRO=@FECHA_PARAMETRO AND
		    CD.SERIE= (SELECT TOP 1 SERIE FROM CHE_CHEQUESDENUNCIADOS WITH(NOLOCK) 
		                        WHERE SUCURSAL=CD.SUCURSAL AND
		                            MONEDA=CD.MONEDA AND
		                            CUENTA=CD.CUENTA AND
		                            PRODUCTO=CD.PRODUCTO AND
		                            OPERACION=CD.OPERACION AND
		                            ORDINAL=CD.ORDINAL AND
		                            FECHAREGISTRO=CD.FECHAREGISTRO
		                            ) AND
		    CD.NUMEROCHEQUE=(SELECT TOP 1 NUMEROCHEQUE FROM CHE_CHEQUESDENUNCIADOS WITH(NOLOCK) 
		                        WHERE SUCURSAL=CD.SUCURSAL AND
		                            MONEDA=CD.MONEDA AND
		                            CUENTA=CD.CUENTA AND
		                            PRODUCTO=CD.PRODUCTO AND
		                            OPERACION=CD.OPERACION AND
		                            ORDINAL=CD.ORDINAL AND
		                            SERIE=CD.SERIE AND
		                            FECHAREGISTRO=CD.FECHAREGISTRO) 
		                          
		INNER JOIN PYF_APODERADOS A WITH (NOLOCK) ON
		    A.ID_ENTIDAD=S.JTS_OID AND
		    A.TIPO_PODER=2 AND
		    A.TIPO_ENTIDAD=2 AND
		    @FECHA_PARAMETRO BETWEEN A.FECHA_INI_VIGENCIA AND A.FECHA_VENCIMIENTO AND
		    @FECHA_PARAMETRO NOT BETWEEN ISNULL(A.FECHA_INI_SUSPENSION,CONVERT(DATETIME,''23/01/1800'',103)) AND ISNULL(A.FECHA_FIN_SUSPENSION,CONVERT(DATETIME,''23/01/1800'',103)) AND
		    A.TZ_LOCK = 0 
		    
		INNER JOIN VW_PERSONAS_F_Y_J AS VW WITH (NOLOCK) ON 
		    VW.NUMEROPERSONA = A.ID_PERSONA
		
		WHERE
		    S.C1785=2 AND
		    S.TZ_LOCK=0

		--DECLARO TABLA AUXILIAR BaseIDs_Rec--
		  DECLARE @Tabla_BaseIRechazados TABLE(
		  NRODOC            VARCHAR (20),
		  CUENTA            NUMERIC (12, 0)
		  )
		
		--Traigo personas apoderadas de la cuenta Cheques rechazados
		INSERT INTO @Tabla_BaseIRechazados
		SELECT
		    ISNULL(VW.NroDocIdent,0) AS NRODOC, 
		    ISNULL(S.CUENTA,0) AS CUENTA
		    --ROW_NUMBER() OVER (PARTITION BY S.CUENTA ORDER BY A.ID_PERSONA) AS NR
		
		FROM SALDOS S WITH(NOLOCK) 
		
		INNER JOIN CHE_BCO_RECHAZADOS CR WITH(NOLOCK) ON
		    CR.SUCURSAL=S.SUCURSAL AND
		    CR.MONEDA=S.MONEDA AND
		    CR.CUENTA=S.CUENTA AND
		    CR.PRODUCTO=S.PRODUCTO AND
		    --CR.FECHA_RECHAZO=CONVERT(DATETIME,(DATEADD(day, -1, @FECHA_PARAMETRO)),103) AND
		    CR.SERIE_CHEQUE= (SELECT TOP 1 SERIE_CHEQUE FROM CHE_BCO_RECHAZADOS WITH(NOLOCK) 
		                        WHERE SUCURSAL=CR.SUCURSAL AND
		                            MONEDA=CR.MONEDA AND
		                            CUENTA=CR.CUENTA AND
		                            PRODUCTO=CR.PRODUCTO AND
		                            FECHA_RECHAZO=CR.FECHA_RECHAZO) AND
		    CR.NRO_CHEQUE=(SELECT TOP 1 NRO_CHEQUE FROM CHE_BCO_RECHAZADOS WITH(NOLOCK) 
		                        WHERE SUCURSAL=CR.SUCURSAL AND
		                            MONEDA=CR.MONEDA AND
		                            CUENTA=CR.CUENTA AND
		                            PRODUCTO=CR.PRODUCTO AND
		                            FECHA_RECHAZO=CR.FECHA_RECHAZO AND
		                            SERIE_CHEQUE=CR.SERIE_CHEQUE) AND
		    CR.FECHA_CHEQUE=(SELECT TOP 1 FECHA_CHEQUE FROM CHE_BCO_RECHAZADOS WITH(NOLOCK) 
		                        WHERE SUCURSAL=CR.SUCURSAL AND
		                            MONEDA=CR.MONEDA AND
		                            CUENTA=CR.CUENTA AND
		                            PRODUCTO=CR.PRODUCTO AND
		                            FECHA_RECHAZO=CR.FECHA_RECHAZO AND
		                            SERIE_CHEQUE=CR.SERIE_CHEQUE AND
		                            NRO_CHEQUE=CR.NRO_CHEQUE) 
		
		                          
		INNER JOIN PYF_APODERADOS A WITH (NOLOCK) ON
		    A.ID_ENTIDAD=S.JTS_OID AND
		    A.TIPO_PODER=2 AND
		    A.TIPO_ENTIDAD=2 AND
		    @FECHA_PARAMETRO BETWEEN A.FECHA_INI_VIGENCIA AND A.FECHA_VENCIMIENTO AND
		    @FECHA_PARAMETRO NOT BETWEEN ISNULL(A.FECHA_INI_SUSPENSION,CONVERT(DATETIME,''23/01/1800'',103)) AND ISNULL(A.FECHA_FIN_SUSPENSION,CONVERT(DATETIME,''23/01/1800'',103)) AND
		    A.TZ_LOCK = 0 
		    
		INNER JOIN VW_PERSONAS_F_Y_J AS VW WITH (NOLOCK) ON 
		    VW.NUMEROPERSONA = A.ID_PERSONA
		
		WHERE
		    S.C1785=2 AND
		    S.TZ_LOCK=0
		
	--BEGIN TRANSACTION	
      
       --BEGIN TRY
	       	  	
			SET @CANT_INTEGRANTES_DENUNCIADOS = (SELECT COUNT(*) FROM @Tabla_BaseDenunciados WHERE NRODOC = @P_NRODOC AND CUENTA = @P_CUENTA);
			SET @CANT_INTEGRANTES_RECHAZADOS = (SELECT COUNT(*) FROM @Tabla_BaseIRechazados WHERE NRODOC = @P_NRODOC AND CUENTA = @P_CUENTA);
			
		--END TRY     
		 	      
  END
')