EXECUTE('
CREATE PROCEDURE SP_ACTUALIZO_ESTADO_ADELANTO
    @P_ID_PROCESO FLOAT(53),
    @P_DT_PROCESO DATETIME2(0),
    @P_RET_PROCESO FLOAT(53) OUTPUT,
    @P_MSG_PROCESO VARCHAR(MAX) OUTPUT
AS 
BEGIN
	DECLARE @RETORNO_CON_REGISTRO NUMERIC(12)
    
    SET @P_RET_PROCESO = NULL
    SET @P_MSG_PROCESO = NULL
---Comienzo de lógica
  
  UPDATE AH
    SET AH.ESTADO = ''P''
    FROM CRE_ADELANTOS_HABERES AH WITH(NOLOCK)
    INNER JOIN CRE_ADELANTOS_HABERES_RESUMEN RES WITH(NOLOCK)
        ON AH.JTS_OID_CV = RES.JTS_OID_CV
        AND AH.FECHA = RES.FECHA
        AND AH.PRODUCTO = RES.PRODUCTO
        AND AH.CANAL = RES.CANAL
    WHERE RES.ESTADO = ''P''
    	AND RES.FECHA_PROCESADO = (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
    	AND AH.ESTADO=''I''
		AND AH.TZ_LOCK=0 AND RES.TZ_LOCK=0
   -- Validación final y mensaje
    SET @P_RET_PROCESO = 1
    SET @P_MSG_PROCESO = ''La tabla CRE_ADELANTOS_HABERES se ha actualizado correctamente.''

    SELECT @RETORNO_CON_REGISTRO = COUNT(1)
    FROM CRE_ADELANTOS_HABERES A WITH (NOLOCK)
    INNER JOIN CRE_ADELANTOS_HABERES_RESUMEN R WITH(NOLOCK)
        ON A.JTS_OID_CV = R.JTS_OID_CV
        AND A.FECHA = R.FECHA
        AND A.PRODUCTO = R.PRODUCTO
        AND A.CANAL = R.CANAL
    WHERE R.ESTADO = ''P''
    	AND R.FECHA_PROCESADO = (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
    	AND A.ESTADO=''P''
		AND A.TZ_LOCK=0 AND R.TZ_LOCK=0
    

    IF (@RETORNO_CON_REGISTRO = 0)
    BEGIN
        SET @P_RET_PROCESO = 2
        SET @P_MSG_PROCESO = ''No se actualizaron registros en la tabla CRE_ADELANTOS_HABERES_RESUMEN''
    END
END;

')