
execute('

ALTER VIEW VW_ACT_ECO_WS AS
SELECT 
X.COD_ACTIVIDAD,
DESCRIPCION AS ''DESCRIPCION'',
PERIODO_ACTIVIDAD AS ''PERIODO_ACTIVIDAD'',
TIPO_ACTIVIDAD AS ''TIPO_ACTIVIDAD'',
VERIFICADO_AFIP AS ''VERIFICADO_AFIP'',
FECHA_VERIFICADO AS ''FECHA_VERIFICADO'',
CODIGO_PERSONA AS ''CODIGO_PERSONA'',
TIPO_DOCUMENTO AS ''TIPO_DOCUMENTO'',
X.NUMERO_DOCUMENTO AS ''NUMERO_DOCUMENTO'',
X.ORDINAL AS ''ORDINAL'',
X.REGISTRO_POR AS ''REGISTRO_POR'',
X.ORDEN_AFIP AS ''ORDEN_AFIP''
FROM
(     

SELECT 
i.COD_ACTIVIDAD,
a.DESCRIPCION,
(RIGHT(i.PERIODO,2)+LEFT(i.PERIODO,4)) AS PERIODO_ACTIVIDAD,
(CASE i.ORDEN
WHEN 1 THEN ''Primaria''
ELSE ''Secundaria''
END) AS TIPO_ACTIVIDAD,
''S'' AS VERIFICADO_AFIP,
(SELECT FECHAPROCESO FROM PARAMETROS) AS FECHA_VERIFICADO,
d.NUMEROPERSONAFJ AS CODIGO_PERSONA,
d.TIPODOCUMENTO AS TIPO_DOCUMENTO,
i.CUIL AS NUMERO_DOCUMENTO,
e.ORDINAL_ACTIVIDAD AS ORDINAL,
''2_AFIP'' AS REGISTRO_POR,
i.ORDEN AS ORDEN_AFIP
FROM ITF_AFIP_ACT_ECONOMICA i LEFT JOIN CLI_DocumentosPFPJ d ON i.CUIL=d.NUMERODOCUMENTO AND 
((i.TZ_LOCK < 300000000000000 OR i.TZ_LOCK >= 400000000000000) AND (i.TZ_LOCK < 100000000000000 OR i.TZ_LOCK >= 200000000000000))
INNER JOIN CLI_Cod_Act_AFIP a ON i.COD_ACTIVIDAD=a.CODIGO_ACT_AFIP LEFT JOIN CLI_ACTIVIDAD_ECONOMICA e ON d.NUMEROPERSONAFJ=e.CODIGO_PERSONA_CLIENTE
AND e.CODIGO_ACTIVIDAD=i.COD_ACTIVIDAD AND e.ORDEN_AFIP=i.ORDEN 

UNION

SELECT
c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
a.DESCRIPCION,
c.INICIO_ACTIVIDAD AS PERIODO_ACTIVIDAD,
(CASE c.ORDEN_AFIP
WHEN 1 THEN ''Primaria''
ELSE ''Secundaria''
END) AS TIPO_ACTIVIDAD,
c.VERIFICADO_AFIP AS VERIFICADO_AFIP,
c.FECHA_VERIFICADO,
c.CODIGO_PERSONA_CLIENTE AS CODIGO_PERSONA,
d.TIPODOCUMENTO AS TIPO_DOCUMENTO,
d.NUMERODOCUMENTO AS NUMERO_DOCUMENTO,
c.ORDINAL_ACTIVIDAD AS ORDINAL,
''1_TOPAZ'' AS REGISTRO_POR,
c.ORDEN_AFIP
FROM CLI_ACTIVIDAD_ECONOMICA c INNER JOIN 
CLI_Cod_Act_AFIP a ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP AND 
((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
LEFT JOIN CLI_DocumentosPFPJ d ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE

UNION

SELECT
c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
a.DESCRIPCION,
c.INICIO_ACTIVIDAD AS PERIODO_ACTIVIDAD,
(CASE c.ORDEN_AFIP
WHEN 1 THEN ''Primaria''
ELSE ''Secundaria''
END) AS TIPO_ACTIVIDAD,
c.VERIFICADO_AFIP AS VERIFICADO_AFIP,
c.FECHA_VERIFICADO,
c.CODIGO_PERSONA_CLIENTE AS CODIGO_PERSONA,
d.TIPODOCUMENTO AS TIPO_DOCUMENTO,
c.CUIL AS NUMERO_DOCUMENTO,
c.ORDINAL_ACTIVIDAD AS ORDINAL,
''0_TEMP'' AS REGISTRO_POR,
c.ORDEN_AFIP
FROM TEMP_CLI_ACTIVIDAD_ECONOMICA c INNER JOIN 
CLI_Cod_Act_AFIP a ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP AND c.ESTADO_REGISTRO<>''B'' AND 
((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
LEFT JOIN CLI_DocumentosPFPJ d ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE


) X
INNER JOIN
(
--- Se agrupa para luego diferenciar que registro vino de AFIP, cual de TOPAZ y de los temporales.
SELECT 
COD_ACTIVIDAD,
NUMERO_DOCUMENTO AS ''NUMERO_DOCUMENTO'',
MAX(REGISTRO_POR) AS ''REGISTRO_POR''
FROM
(     

SELECT 
i.COD_ACTIVIDAD,
i.CUIL AS NUMERO_DOCUMENTO,
''2_AFIP'' AS REGISTRO_POR
FROM ITF_AFIP_ACT_ECONOMICA i LEFT JOIN CLI_DocumentosPFPJ d ON i.CUIL=d.NUMERODOCUMENTO AND 
((i.TZ_LOCK < 300000000000000 OR i.TZ_LOCK >= 400000000000000) AND (i.TZ_LOCK < 100000000000000 OR i.TZ_LOCK >= 200000000000000))
INNER JOIN CLI_Cod_Act_AFIP a ON i.COD_ACTIVIDAD=a.CODIGO_ACT_AFIP 

UNION

---Union entre temporales y Topaz
SELECT 
COD_ACTIVIDAD,
NUMERO_DOCUMENTO AS ''NUMERO_DOCUMENTO'',
MAX(REGISTRO_POR) AS ''REGISTRO_POR''
FROM
( 
---Se une los datos en la temporal con los ya grabados en Topaz
---En caso de estar repetido se muestra solo el de topaz
SELECT
c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
d.NUMERODOCUMENTO AS NUMERO_DOCUMENTO,
''1_TOPAZ'' AS REGISTRO_POR
FROM CLI_ACTIVIDAD_ECONOMICA c INNER JOIN 
CLI_Cod_Act_AFIP a ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP AND 
((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
LEFT JOIN CLI_DocumentosPFPJ d ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE

UNION

SELECT
c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
c.CUIL AS NUMERO_DOCUMENTO,
''0_TEMP'' AS REGISTRO_POR
FROM TEMP_CLI_ACTIVIDAD_ECONOMICA c INNER JOIN 
CLI_Cod_Act_AFIP a ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP AND c.ESTADO_REGISTRO<>''B'' AND
((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
LEFT JOIN CLI_DocumentosPFPJ d ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE
) V GROUP BY V.NUMERO_DOCUMENTO , V.COD_ACTIVIDAD 

) Y GROUP BY Y.NUMERO_DOCUMENTO , Y.COD_ACTIVIDAD
) J ON J.NUMERO_DOCUMENTO=X.NUMERO_DOCUMENTO AND J.COD_ACTIVIDAD=X.COD_ACTIVIDAD AND J.REGISTRO_POR=X.REGISTRO_POR



')