EXECUTE('
IF OBJECT_ID (''dbo.VW_PODERES_PERSONAS_COFRES'') IS NOT NULL
	DROP VIEW dbo.VW_PODERES_PERSONAS_COFRES
')
EXECUTE('
CREATE VIEW [dbo].[VW_PODERES_PERSONAS_COFRES] (
												   NUMERO_CONTRATO, 
												   TIPODOC, 
												   NUMERODOC, 
												   NUMEROPERSONA, 
												   TITULARIDAD, 
												   TIPOPERSONA, 
												   NOMBRE, 
												   PODER, 
												   ESTADO, 
												   DEPENDENCIA)
AS
SELECT 
	CC.[CODIGO],
	DOC.TIPODOCUMENTO AS tipodoc, 
	DOC.NUMERODOCUMENTO AS numerodoc, 
	DOC.NUMEROPERSONAFJ AS numeropersona, 
	CASE 
		WHEN (CP.CODIGOCLIENTE IS NULL AND IT.NUMEROPERSONAJURIDICA IS NULL) 
			THEN ''AUTORIZADO''
		ELSE ''TITULAR''
	END AS titularidad,
	DOC.TIPOPERSONA,
	ISNULL(PF.PRIMERNOMBRE, '''') + '' '' + ISNULL(PF.APELLIDOPATERNO, '''') + '' '' + ISNULL(PF.APELLIDOMATERNO, '''') AS NOMBRE, 
	P.TIPO_PODER, 
	CC.ESTADO, 
	C.DEPENDENCIA
FROM 
	dbo.PYF_APODERADOS AS P WITH (NOLOCK)
INNER JOIN dbo.CLI_PERSONASFISICAS AS PF WITH (NOLOCK) ON 
	PF.NUMEROPERSONAFISICA = P.ID_PERSONA
	AND PF.TZ_LOCK=0
INNER JOIN dbo.CLI_DOCUMENTOSPFPJ AS DOC WITH (NOLOCK) ON 
	DOC.NUMEROPERSONAFJ = PF.NUMEROPERSONAFISICA
	AND DOC.TZ_LOCK = 0 
INNER JOIN dbo.COF_COFRES AS C WITH (NOLOCK) ON 
	C.CODIGO = P.ID_ENTIDAD 
	AND C.TZ_LOCK = 0	
INNER JOIN dbo.COF_COFRES_CONTRATOS AS CC WITH (NOLOCK) ON 
	CC.CODIGO_COFRE = C.CODIGO
	AND CC.TZ_LOCK = 0 
LEFT JOIN CLI_ClientePersona AS CP WITH (NOLOCK) ON 
	CP.NUMEROPERSONA = PF.NUMEROPERSONAFISICA 
	AND CP.CODIGOCLIENTE = CC.CLIENTE
	AND CP.TZ_LOCK=0
LEFT JOIN CLI_INTEGRANTESPJ AS IT WITH (NOLOCK) ON 
	IT.NUMEROPERSONAFISICA = PF.NUMEROPERSONAFISICA 
	AND IT.TZ_LOCK=0
	AND IT.NUMEROPERSONAJURIDICA IN	(
									SELECT 
										NUMEROPERSONA
									FROM
										CLI_ClientePersona WITH (nolock)
									WHERE
										CODIGOCLIENTE = CC.CLIENTE
										AND TZ_LOCK = 0
									)
WHERE 
	P.TIPO_ENTIDAD=3 
	AND P.TZ_LOCK=0
')

