EXECUTE('
----
ALTER PROCEDURE [dbo].[SP_MAILS_CARGOS_PENDIENTES]
@id_proceso		NUMERIC,
@dt_proceso		DATE,
@ret_proceso	NUMERIC OUTPUT,
@msg_proceso	VARCHAR OUTPUT
AS
BEGIN
  	SET NOCOUNT ON;

	--DECLARO TABLA AUXILIAR--
	DECLARE @TablaAuxiliar TABLE(
		ORDINAL INT IDENTITY(1,1) NOT NULL,
		MAIL_TO VARCHAR(128),
		MAIL_FROM VARCHAR(128),
		DATA VARCHAR(2048),
		INTENTOS NUMERIC(1,0),
		SUBJECT VARCHAR(255),
		FECHA_INGRESO DATETIME,
		TZ_LOCK NUMERIC(15,0)
	)
		
	--COMPLETO TABLA AUXILIAR--
	INSERT INTO 
		@TablaAuxiliar
	SELECT
		E.EMAIL AS MAIL_TO,
		(SELECT ALFA FROM PARAMETROSGENERALES WHERE CODIGO = 205) AS MAIL_FROM,
		concat(''Html=ComisionesPendientes.html;Variables=DescripcionCargo::'',S.CONCEPTO,
			'';Variables=Cuenta::'',SA.CUENTA,'';Variables=Fecha::'',CONVERT(VARCHAR, GETDATE(), 103),
			'';Variables=Moneda::'',S.MONEDA,'';Variables=Importe::'',S.IMPORTE,'';Variables=Operacion::'',
			O.NOMBRE,'';'') AS DATA,
		0 AS INTENTOS,
		''NOTIFICACIÓN COMISIONES PENDIENTES DE PAGO'' AS SUBJECT,
		(SELECT FECHAPROCESO FROM PARAMETROS) AS FECHA_INGRESO,
		0 AS TZ_LOCK
	FROM 
		CI_SOLICITUD AS S WITH (nolock)
	INNER JOIN SALDOS AS SA WITH (nolock) ON
		SA.JTS_OID = S.SALDO_JTS_OID 
		AND SA.TZ_LOCK = 0
	INNER JOIN GRL_ESTADOS_DE_CUENTA AS G with (nolock) ON
		G.JTSOID = S.SALDO_JTS_OID
		AND G.TZ_LOCK = 0
	INNER JOIN ASIENTOS AS A WITH (nolock) ON
		A.FECHAPROCESO = S.FECHA_PROCESO 
		AND A.SUCURSAL = S.SUCURSALDIF
		AND A.ASIENTO = S.ASIENTODIF
	INNER JOIN OPERACIONES AS O WITH (nolock) ON
		O.IDENTIFICACION = A.OPERACION
		AND O.TZ_LOCK = 0
	INNER JOIN CLI_ClientePersona AS T with (nolock) ON
		T.CODIGOCLIENTE = G.CLIENTE
		AND T.TITULARIDAD = ''T''
		AND T.TZ_LOCK = 0
	INNER JOIN CLI_EMAILS AS E WITH (nolock) ON
		E.ID = T.NUMEROPERSONA
		AND E.TIPO = G.TIPO_MAIL
		AND E.FORMATO = G.FORMATO_MAIL
		AND E.ORDINAL = G.ORDINAL_MAIL
		AND E.TZ_LOCK = 0
		AND LEN(E.EMAIL)>0
		AND E.EMAIL IS NOT NULL 
	WHERE 
		S.TZ_LOCK = 0 
		
		
	--INSERTO EN CORREOS_A_ENVIAR--
	INSERT INTO
		CORREOS_A_ENVIAR
	SELECT
		T.ORDINAL + ident_current(''SEQUENCE_CORREOS_A_ENVIAR''),
		T.MAIL_TO,
		T.MAIL_FROM,
		T.DATA,
		T.INTENTOS,
		T.SUBJECT,
		T.FECHA_INGRESO,
		T.TZ_LOCK
	FROM @TablaAuxiliar AS T
	
	--INSERT EN SEQUENCE_CORREOS_A_ENVIAR--
		--PARA ACTUALIZAR NUMERADOR--
	INSERT INTO
		SEQUENCE_CORREOS_A_ENVIAR
	SELECT 0
	FROM @TablaAuxiliar
	
	DELETE FROM SEQUENCE_CORREOS_A_ENVIAR
    
    SET @ret_proceso = 1
	SET @msg_proceso = ''Proceso de Notificaciones Finalizado''
    
	SET NOCOUNT OFF;
END
----
')
