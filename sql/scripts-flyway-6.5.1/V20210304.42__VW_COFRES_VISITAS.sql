

/****** Object:  View [dbo].[VW_COFRES_VISITAS]    Script Date: 24/02/2021 11:24:33 ******/
DROP VIEW [dbo].[VW_COFRES_VISITAS]
GO

/****** Object:  View [dbo].[VW_COFRES_VISITAS]    Script Date: 24/02/2021 11:24:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[VW_COFRES_VISITAS] (
   [CODIGO_CONTRATO], 
   [CODIGO_EVENTO], 
   PAIS_DOCUMENTO, 
   TIPO_DOCUMENTO, 
   NUMERO_DOCUMENTO, 
   NUMERO_PERSONA, 
   TIPO_PERSONA, 
   NOMBRE_PERSONA, 
   TITULARIDAD,  
   FECHA_EVENTO,
   ESTADO_CONTRATO,
   DEPENDENCIA)
AS 
   SELECT
      C.[CODIGO_CONTRATO], 
      E.[CODIGO_EVENTO], 
      D.PAISDOCUMENTO AS PAIS_DOCUMENTO, 
      D.TIPODOCUMENTO AS TIPO_DOCUMENTO, 
      D.NUMERODOCUMENTO AS NUMERO_DOCUMENTO, 
      E.NUMERO_PERSONA, 
      D.TIPOPERSONA AS TIPO_PERSONA, 
      (ISNULL(F.PRIMERNOMBRE, '') + ' ' + ISNULL(F.APELLIDOPATERNO, '')) AS NOMBRE_PERSONA, 
      CASE W.[CATEGORIA]
         WHEN 'A' THEN 'TITULAR'
         WHEN 'B' THEN 'TITULAR'
         ELSE 'AUTORIZADO'
      END AS TITULARIDAD, 
      C.FECHA_EVENTO,
      X.ESTADO, 
      Y.DEPENDENCIA
   FROM 
      COF_COFRES_DETALLE_EVENTOS AS E with (nolock) 
      INNER JOIN COF_COFRES_EVENTOS AS C with (nolock) ON E.[CODIGO_EVENTO] = C.NUMERO_EVENTO 
      INNER JOIN CLI_PERSONASFISICAS AS F with (nolock) ON E.NUMERO_PERSONA = F.NUMEROPERSONAFISICA 
      INNER JOIN CLI_DOCUMENTOSPFPJ AS D with (nolock) ON E.NUMERO_PERSONA = D.NUMEROPERSONAFJ
      INNER JOIN PYF_APODERADOS AS W with (nolock)ON W.ID_PERSONA = F.NUMEROPERSONAFISICA 
      INNER JOIN COF_COFRES_CONTRATOS AS X with (nolock) ON W.ID_ENTIDAD = X.JTS_OID_DEBITO
      INNER JOIN COF_COFRES AS Y with(nolock)ON X.[CODIGO_COFRE] = Y.[CODIGO]
   WHERE 
      C.TIPO_EVENTO = 'V' AND 
      W.TIPO_PODER = 10 AND 
      C.[CODIGO_CONTRATO] = X.[CODIGO] AND
										( 
										  E.TZ_LOCK = 0 AND
										  C.TZ_LOCK = 0 AND
										  F.TZ_LOCK = 0 AND
										  D.TZ_LOCK = 0 AND
										  W.TZ_LOCK = 0 AND
										  X.TZ_LOCK = 0 AND
										  Y.TZ_LOCK = 0
										 );
     
GO


