EXECUTE('
----
IF OBJECT_ID (''dbo.VW_SNP_PRESTACIONES_EMPRESAS'') IS NOT NULL
	DROP VIEW dbo.VW_SNP_PRESTACIONES_EMPRESAS
--
IF OBJECT_ID (''dbo.VW_SNP_STOP_DEBIT_DD'') IS NOT NULL
	DROP VIEW dbo.VW_SNP_STOP_DEBIT_DD
----
IF OBJECT_ID (''dbo.VW_SNP_MSG_ORDENES'') IS NOT NULL
	DROP VIEW dbo.VW_SNP_MSG_ORDENES
----
IF OBJECT_ID (''dbo.VW_SNP_MSG_ORDENES_NUMERADAS'') IS NOT NULL
	DROP VIEW dbo.VW_SNP_MSG_ORDENES_NUMERADAS
----
IF OBJECT_ID (''dbo.VW_DEBITOS_DIRECTOS_A_RENDIR'') IS NOT NULL
	DROP VIEW dbo.VW_DEBITOS_DIRECTOS_A_RENDIR
----
IF OBJECT_ID (''dbo.VW_DEBITOS_DIRECTOS_RENDIDOS'') IS NOT NULL
	DROP VIEW dbo.VW_DEBITOS_DIRECTOS_RENDIDOS
----
')
EXECUTE('
----
CREATE VIEW VW_SNP_PRESTACIONES_EMPRESAS
AS
SELECT
	PE.PRESTACION,
	PE.NOMBRE_EMPRESA,
	PE.CUIT_EO,
	OE.DESCRIPCION AS ESTADO,
	PE.FECHA_ALTA
FROM
	SNP_PRESTACIONES_EMPRESAS AS PE WITH (nolock)
LEFT JOIN OPCIONES AS OE WITH (nolock) ON
	OE.NUMERODECAMPO = 44515
	AND OE.IDIOMA = ''E''
	AND OE.OPCIONINTERNA = PE.ESTADO
WHERE
	((PE.TZ_LOCK < 100000000000000 OR PE.TZ_LOCK >= 200000000000000)
	AND (PE.TZ_LOCK < 300000000000000 OR PE.TZ_LOCK >= 400000000000000)  )
')
EXECUTE('
----
CREATE VIEW VW_SNP_STOP_DEBIT_DD
AS
SELECT
	SD.CLIENTE_ADHERIDO,
	SD.CORRELATIVO,
	OS.DESCRIPCION AS TIPO_CUENTA,
	S.CUENTA,
	CASE 
		WHEN SD.PRESTACION = ''''
			THEN ''TODAS''
		ELSE SD.PRESTACION
	END AS PRESTACION,
	CASE
		WHEN SD.CUIT_EO = 0
			THEN ''TODAS''
		ELSE PJ.RAZONSOCIAL
	END AS NOMBRE_EMPRESA,
	ISNULL(SD.CUIT_EO, 0) AS CUIT_EO,
	OE.DESCRIPCION AS ESTADO,
	SD.FECHA_ALTA
FROM 
	SNP_STOP_DEBIT AS SD WITH (nolock)
LEFT JOIN CLI_DOCUMENTOSPFPJ AS DOC WITH (nolock) ON
	DOC.NUMERODOCUMENTO = SD.CUIT_EO
	AND DOC.NUMEROPERSONAFJ IN (SELECT TOP 1 NUMEROPERSONAFJ
								FROM CLI_DOCUMENTOSPFPJ
								WHERE NUMERODOCUMENTO = DOC.NUMERODOCUMENTO
									AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
										AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  
									)
								ORDER BY NUMEROPERSONAFJ, TIPODOCUMENTO
								)
	AND DOC.TIPODOCUMENTO IN 	(SELECT TOP 1 TIPODOCUMENTO
								FROM CLI_DOCUMENTOSPFPJ
								WHERE NUMERODOCUMENTO = DOC.NUMERODOCUMENTO
									AND NUMEROPERSONAFJ = DOC.NUMEROPERSONAFJ
									AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
										AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  
									)
								ORDER BY NUMEROPERSONAFJ, TIPODOCUMENTO
								)
	AND ((DOC.TZ_LOCK < 100000000000000 OR DOC.TZ_LOCK >= 200000000000000)
		AND (DOC.TZ_LOCK < 300000000000000 OR DOC.TZ_LOCK >= 400000000000000)  
	)
LEFT JOIN CLI_PERSONASJURIDICAS AS PJ WITH (nolock) ON
	PJ.NUMEROPERSONAJURIDICA = DOC.NUMEROPERSONAFJ
	AND ((PJ.TZ_LOCK < 100000000000000 OR PJ.TZ_LOCK >= 200000000000000)
		AND (PJ.TZ_LOCK < 300000000000000 OR PJ.TZ_LOCK >= 400000000000000)  
	)
LEFT JOIN OPCIONES AS OE WITH (nolock) ON
	OE.NUMERODECAMPO = 44563
	AND OE.IDIOMA = ''E''
	AND OE.OPCIONINTERNA = SD.ESTADO
LEFT JOIN SALDOS AS S WITH (nolock) ON
	S.JTS_OID = SD.SALDO_JTS_OID
	AND SD.TZ_LOCK = 0
LEFT JOIN OPCIONES AS OS WITH (nolock) ON
	OS.NUMERODECAMPO = 1785
	AND OS.IDIOMA = ''E''
	AND OS.OPCIONINTERNA = S.C1785
WHERE
	SD.DEBITO_DIRECTO = ''S''
	AND ((SD.TZ_LOCK < 100000000000000 OR SD.TZ_LOCK >= 200000000000000)
		AND (SD.TZ_LOCK < 300000000000000 OR SD.TZ_LOCK >= 400000000000000)  )
')
EXECUTE('
----
CREATE VIEW VW_SNP_MSG_ORDENES
AS
SELECT
	C.FECHA_RECEPCION,
	O.CUIT_EO,
	E.NOMBRE_EMPRESA,
	O.PRESTACION,
	O.TIPO_DOCUMENTO AS TIPO_DOC_CLIENTE,
	O.NRO_DOCUMENTO AS DOCUMENTO_CLIENTE,
	B.CODIGOBC AS BANCO,
	B.NOMBRE AS NOMBRE_BANCO,
	O.CUENTA,
	O.MONEDA,
	M.C6400 AS NOMBRE_MONEDA,
	O.IMPORTE,
	O.FECHA_VENCIMIENTO,
	OE.DESCRIPCION AS ESTADO,
	O.ID_ARCHIVO,
	O.NRO_ARCHIVO,
	O.CORRELATIVO
FROM SNP_MSG_ORDENES AS O WITH (nolock)
INNER JOIN SNP_MSG_CABEZAL AS C WITH (nolock) ON
	C.CUIT_EO = O.CUIT_EO
	AND C.ID_ARCHIVO = O.ID_ARCHIVO
	AND C.NRO_ARCHIVO = O.NRO_ARCHIVO
	AND ((C.TZ_LOCK < 100000000000000 OR C.TZ_LOCK >= 200000000000000)
		AND (C.TZ_LOCK < 300000000000000 OR C.TZ_LOCK >= 400000000000000)  
	)
INNER JOIN SNP_PRESTACIONES_EMPRESAS AS E WITH (nolock) ON
	E.CUIT_EO = O.CUIT_EO
	AND E.PRESTACION = O.PRESTACION
	AND ((E.TZ_LOCK < 100000000000000 OR E.TZ_LOCK >= 200000000000000)
		AND (E.TZ_LOCK < 300000000000000 OR E.TZ_LOCK >= 400000000000000)  
	)
INNER JOIN MONEDAS AS M WITH (nolock) ON
	M.C6399 = O.MONEDA
	AND ((M.TZ_LOCK < 100000000000000 OR M.TZ_LOCK >= 200000000000000)
		AND (M.TZ_LOCK < 300000000000000 OR M.TZ_LOCK >= 400000000000000)  
	)
INNER JOIN OPCIONES AS OE WITH (nolock) ON
	OE.NUMERODECAMPO = 44613
	AND OE.IDIOMA = ''E''
	AND OE.OPCIONINTERNA = O.ESTADO
LEFT JOIN CLI_BANCOSPLAZA AS B WITH (nolock) ON
	CONVERT(VARCHAR, B.CODIGOBC) = LEFT(O.CBU, 3)
	AND B.SUCURSAL = 0
	AND ((B.TZ_LOCK < 100000000000000 OR B.TZ_LOCK >= 200000000000000)
		AND (B.TZ_LOCK < 300000000000000 OR B.TZ_LOCK >= 400000000000000)  
	)
WHERE
	O.TIPO_ORDEN = ''DEBREC''
	AND O.TZ_LOCK = 0
')
EXECUTE('
----
CREATE VIEW VW_SNP_MSG_ORDENES_NUMERADAS
/*VISTA CON NUMERADOR ÚNICO PARA JOINEAR EN SOLICITUDES MAPPING*/
AS
SELECT
	ROW_NUMBER() OVER(ORDER BY
						O.CUIT_EO,
						O.ID_ARCHIVO,
						O.NRO_ARCHIVO,
						O.CORRELATIVO) 
	AS ID_ORDEN,	
	O.CUIT_EO,
	O.ID_ARCHIVO,
	O.NRO_ARCHIVO,
	O.CORRELATIVO,
	O.PRESTACION
FROM SNP_MSG_ORDENES AS O WITH (nolock)
')
EXECUTE('
----
CREATE VIEW VW_DEBITOS_DIRECTOS_A_RENDIR
AS
WITH TOTALES AS (
	SELECT
		PE.ID_CONVENIO,
		O.MONEDA AS MONEDA,
		COUNT(O.IMPORTE) AS CANTIDAD_ORDENES,
		SUM(O.IMPORTE * 
			CASE ISNULL(O.ID_ARCHIVO_REVERSADO, '''')
				WHEN '''' THEN 1
				ELSE -1 /*VALOR EN ID_ARCHIVO_REVERSADO SIGNIFICA QUE ES UNA REVERSA*/
			END
		) AS TOTAL_IMPORTE
	FROM SNP_MSG_ORDENES AS O WITH (nolock)
	INNER JOIN SNP_PRESTACIONES_EMPRESAS AS PE WITH (nolock) ON
		PE.CUIT_EO = O.CUIT_EO
		AND PE.PRESTACION = O.PRESTACION
		AND ((PE.TZ_LOCK < 100000000000000 OR PE.TZ_LOCK >= 200000000000000)
			AND (PE.TZ_LOCK < 300000000000000 OR PE.TZ_LOCK >= 400000000000000)  
		)
	WHERE 
		O.TIPO_ORDEN = ''DEBREC''
		AND O.ESTADO = ''PR''
		AND O.FECHA_COMPENSACION <= (SELECT FECHAPROCESO FROM PARAMETROS WITH (nolock))
		AND O.RENDIDA <> ''S''
		AND O.TZ_LOCK = 0
	GROUP BY
		PE.ID_CONVENIO,
		O.MONEDA
)

SELECT
	C.Id_ConvRec AS ID_CONVENIO,
	C.NomConvRec AS NOMBRE_CONVENIO,
	C.Cuit AS CUIT_EMPRESA,
	C.Cliente AS CLIENTE,
	CLI.NOMBRECLIENTE,
	T.MONEDA,
	M.C6400 AS NOMBRE_MONEDA,
	CAST(T.CANTIDAD_ORDENES AS NUMERIC(10)) AS CANTIDAD_ORDENES,
	CAST(T.TOTAL_IMPORTE AS NUMERIC(15, 2)) AS TOTAL_IMPORTE,
	C.FecAlta AS FECHA_ALTA,
	C.FecVto AS FECHA_VENCIMIENTO
FROM CONV_CONVENIOS_REC AS C WITH (nolock)
INNER JOIN CLI_CLIENTES AS CLI WITH (nolock) ON
	CLI.CODIGOCLIENTE = C.Cliente
	AND ((CLI.TZ_LOCK < 100000000000000 OR CLI.TZ_LOCK >= 200000000000000)
		AND (CLI.TZ_LOCK < 300000000000000 OR CLI.TZ_LOCK >= 400000000000000)  
	)
INNER JOIN TOTALES AS T WITH (nolock) ON
	T.ID_CONVENIO = C.Id_ConvRec
INNER JOIN MONEDAS AS M WITH (nolock) ON
	M.C6399 = T.MONEDA
	AND ((M.TZ_LOCK < 100000000000000 OR M.TZ_LOCK >= 200000000000000)
		AND (M.TZ_LOCK < 300000000000000 OR M.TZ_LOCK >= 400000000000000)  
	)	
WHERE
	C.TZ_LOCK = 0
	AND C.ESTADO = ''A''
	AND C.Id_TpoConv IN (	
		SELECT T.Id_TpoConv
		FROM CONV_TIPOS AS T WITH (nolock)
		WHERE 
			T.TpoContrato = 1
			AND ((T.TZ_LOCK < 100000000000000 OR T.TZ_LOCK >= 200000000000000)
				AND (T.TZ_LOCK < 300000000000000 OR T.TZ_LOCK >= 400000000000000)
			)
	)
')
EXECUTE('
----
CREATE VIEW VW_DEBITOS_DIRECTOS_RENDIDOS
AS
WITH TOTALES AS (
	SELECT
		PE.ID_CONVENIO,
		O.MONEDA AS MONEDA,
		COUNT(O.IMPORTE) AS CANTIDAD_ORDENES,
		SUM(O.IMPORTE * 
			CASE ISNULL(O.ID_ARCHIVO_REVERSADO, '''')
				WHEN '''' THEN 1
				ELSE -1 /*VALOR EN ID_ARCHIVO_REVERSADO SIGNIFICA QUE ES UNA REVERSA*/
			END
		) AS TOTAL_IMPORTE
	FROM SNP_MSG_ORDENES AS O WITH (nolock)
	INNER JOIN SNP_PRESTACIONES_EMPRESAS AS PE WITH (nolock) ON
		PE.CUIT_EO = O.CUIT_EO
		AND PE.PRESTACION = O.PRESTACION
		AND ((PE.TZ_LOCK < 100000000000000 OR PE.TZ_LOCK >= 200000000000000)
			AND (PE.TZ_LOCK < 300000000000000 OR PE.TZ_LOCK >= 400000000000000)  
		)
	WHERE 
		O.TIPO_ORDEN = ''DEBREC''
		AND O.ESTADO = ''PR''
		AND O.RENDIDA = ''S''
		AND O.FECHA_RENDIDA = (SELECT FECHAPROCESO FROM PARAMETROS WITH (nolock))
		AND O.TZ_LOCK = 0
	GROUP BY
		PE.ID_CONVENIO,
		O.MONEDA
)

SELECT
	C.Id_ConvRec AS ID_CONVENIO,
	C.NomConvRec AS NOMBRE_CONVENIO,
	C.Cuit AS CUIT_EMPRESA,
	C.Cliente AS CLIENTE,
	CLI.NOMBRECLIENTE,
	T.MONEDA,
	M.C6400 AS NOMBRE_MONEDA,
	CAST(T.CANTIDAD_ORDENES AS NUMERIC(10)) AS CANTIDAD_ORDENES,
	CAST(T.TOTAL_IMPORTE AS NUMERIC(15, 2)) AS TOTAL_IMPORTE,
	C.FecAlta AS FECHA_ALTA,
	C.FecVto AS FECHA_VENCIMIENTO
FROM CONV_CONVENIOS_REC AS C WITH (nolock)
INNER JOIN CLI_CLIENTES AS CLI WITH (nolock) ON
	CLI.CODIGOCLIENTE = C.Cliente
	AND ((CLI.TZ_LOCK < 100000000000000 OR CLI.TZ_LOCK >= 200000000000000)
		AND (CLI.TZ_LOCK < 300000000000000 OR CLI.TZ_LOCK >= 400000000000000)  
	)
INNER JOIN TOTALES AS T WITH (nolock) ON
	T.ID_CONVENIO = C.Id_ConvRec
INNER JOIN MONEDAS AS M WITH (nolock) ON
	M.C6399 = T.MONEDA
	AND ((M.TZ_LOCK < 100000000000000 OR M.TZ_LOCK >= 200000000000000)
		AND (M.TZ_LOCK < 300000000000000 OR M.TZ_LOCK >= 400000000000000)  
	)	
WHERE
	C.TZ_LOCK = 0
	AND C.ESTADO = ''A''
	AND C.Id_TpoConv IN (	
		SELECT T.Id_TpoConv
		FROM CONV_TIPOS AS T WITH (nolock)
		WHERE 
			T.TpoContrato = 1
			AND ((T.TZ_LOCK < 100000000000000 OR T.TZ_LOCK >= 200000000000000)
				AND (T.TZ_LOCK < 300000000000000 OR T.TZ_LOCK >= 400000000000000)
			)
	)
----
')