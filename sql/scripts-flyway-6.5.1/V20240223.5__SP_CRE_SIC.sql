EXECUTE('
ALTER PROCEDURE SP_CRE_SIC
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS
   BEGIN
    
SET @P_RET_PROCESO = NULL
SET @P_MSG_PROCESO = NULL 


---TABLA TEMPORAL CON CLIENTE Y FECHA (FECHA PROCESO), DEFINIR VARIABLE FECHAPROCESO, CON EL SELECT
DECLARE @FECHAPROCESO DATETIME
DECLARE @FECHAPROCESOANTERIOR DATETIME
DECLARE @CLIENTES TABLE (CLIENTE NUMERIC(12), NUEVO VARCHAR(1))
--VARIABLES CANTIDAD DE REGISTROS
DECLARE @CANTIDAD_REGISTROS NUMERIC(10) 

SET @FECHAPROCESO = (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))

-- Set clientes a tratar. Verificar si el cliente es nuevo en la entidad, es decir se dio de alta dentro del mes.
BEGIN TRY 
	INSERT INTO @CLIENTES SELECT CODIGOCLIENTE, 
	CASE WHEN MONTH(CLI.FECHAAPERTURA)= MONTH(@FECHAPROCESO) AND YEAR(CLI.FECHAAPERTURA)= YEAR(@FECHAPROCESO) THEN ''S'' 
	ELSE ''N''
	END AS CLIENTE_NUEVO
	FROM CLI_CLIENTES CLI WITH(NOLOCK) 
	WHERE CLI.CATEGORIA_COMERCIAL IN (''M'',''S'') AND CLI.TZ_LOCK=0

--Cantidad Registros
SET @CANTIDAD_REGISTROS = (SELECT COUNT(1) FROM @CLIENTES)

	
-- Realizar el truncate eliminando los registros anteriores a la fecha proporcionada
   DELETE FROM CRE_SIC_BITACORA_CAB
   WHERE FECHA = @FECHAPROCESO
        
   DELETE FROM CRE_SIC_BITACORA_DET
   WHERE FECHA = @FECHAPROCESO

SET @FECHAPROCESOANTERIOR = (SELECT MAX(FECHA) FROM CRE_SIC_BITACORA_CAB WITH(NOLOCK))
       
--Realizo INSERT para el cliente y con la fecha de proceso
   INSERT INTO CRE_SIC_BITACORA_CAB (CLIENTE,FECHA,SEGMENTO_ANTERIOR, PUNTOS, NUEVO)
   (SELECT C.CLIENTE,@FECHAPROCESO, B.SEGMENTO_NUEVO,0,C.NUEVO
   FROM @CLIENTES C 
   LEFT JOIN CRE_SIC_BITACORA_CAB B WITH(NOLOCK) ON B.CLIENTE=C.CLIENTE AND B.FECHA=@FECHAPROCESOANTERIOR AND B.TZ_LOCK=0)
----------------------------------------------------------------------------------------------------------------------------------


--NOSIS - TIPO 0
-- Cliente Nuevo: si es cliente nuevo en el mes, solo se analiza scoring de nosis
   INSERT INTO dbo.CRE_SIC_BITACORA_DET (CLIENTE, FECHA, TIPO, PUNTOS_SIN_POND, PUNTOS_CON_POND, PONDERACION)
	   SELECT G.CLIENTE,@FECHAPROCESO,P.TIPO_SIC,
	   CASE WHEN G.NUEVO=''S'' THEN NOS.PUNT_CLI_NUEVO ELSE NOS.PUNTAJE END AS PUNTOS_SIN_POND , 
	   CASE WHEN G.NUEVO=''S'' THEN ROUND(NOS.PUNT_CLI_NUEVO*P.PONDERACION_CLI_NUEVO/100,0) ELSE ROUND(NOS.PUNTAJE*P.PONDERACION/100,0) END AS PUNTOS_SIN_POND ,
	   P.PONDERACION
	   FROM (
			SELECT B.CLIENTE,B.NUEVO,NU.VALOR
			FROM @CLIENTES B 
			INNER JOIN VW_CLI_X_DOC CD ON CD.CODIGOCLIENTE=B.CLIENTE 
			INNER JOIN SL_NOSIS_DATOS ND WITH(NOLOCK) ON ND.TIPO_DOC=cd.TIPODOC AND ND.DOC=cd.NUMERODOC
			INNER JOIN SL_NOSIS_CALCULOCDA NU WITH(NOLOCK) ON ND.DOC=NU.CUIT
			WHERE NU.CLAVE=''Valor.SCO''
				  AND NU.FECHA_PROCESO >= DATEADD(DAY, -(SELECT DIASINMOVILIZADA FROM CRE_PARAMETROS WHERE CODIGO=65),@FECHAPROCESO)
				  AND ND.TZ_LOCK=0 AND NU.TZ_LOCK=0 
		  ) G
		  INNER JOIN CRE_SIC_NOSIS NOS WITH(NOLOCK) ON CONVERT(NUMERIC(5), G.VALOR) BETWEEN NOS.RANGO_DESDE AND NOS.RANGO_HASTA AND NOS.TZ_LOCK=0
		  INNER JOIN CRE_SIC_PONDERACION P ON P.TIPO_SIC=0 AND P.TZ_LOCK=0

----------------------------------------------------------------------------------------------------------------------------------

--CHEQUES RECHAZADOS - TIPO 1
   INSERT INTO dbo.CRE_SIC_BITACORA_DET (CLIENTE, FECHA, TIPO, PUNTOS_SIN_POND, PUNTOS_CON_POND, PONDERACION)
SELECT G.CLIENTE,@FECHAPROCESO,P.TIPO_SIC,
	   CASE WHEN G.NUEVO=''S'' THEN CHE.PUNT_CLI_NUEVO ELSE CHE.PUNTAJE END AS PUNTOS_SIN_POND , 
	   CASE WHEN G.NUEVO=''S'' THEN ROUND(CHE.PUNT_CLI_NUEVO*P.PONDERACION_CLI_NUEVO/100,0) ELSE ROUND(CHE.PUNTAJE*P.PONDERACION/100,0) END AS PUNTOS_SIN_POND ,
	   P.PONDERACION
	   FROM (
		   SELECT B.CLIENTE,B.NUEVO,ISNULL(COUNT(CH.NUMEROCHEQUE),0) AS CANTIDAD 
		   FROM @CLIENTES B
		   LEFT JOIN SALDOS AS S with (nolock) ON B.CLIENTE=S.C1803 AND S.TZ_LOCK = 0
		   LEFT JOIN CHE_CHEQUES CH WITH(NOLOCK)  ON CH.SUCURSAL=S.SUCURSAL 
																	AND CH.PRODUCTO=S.PRODUCTO 
																	AND CH.CUENTA=S.CUENTA 
																	AND CH.MONEDA=S.MONEDA 
																	AND CH.OPERACION=S.OPERACION 
																	AND CH.ORDINAL=S.ORDINAL 																	
		   		AND CH.ESTADO=''R''  AND CH.FECHAINGRESO >= DATEADD(MONTH, -12,@FECHAPROCESO)
		   		AND CH.TZ_LOCK=0
		   GROUP BY B.CLIENTE,B.NUEVO	   
		   ) G
	   INNER JOIN CRE_SIC_CHEQUES CHE WITH(NOLOCK) ON CANTIDAD BETWEEN CHE.RANGO_DESDE AND CHE.RANGO_HASTA AND CHE.TZ_LOCK=0
	   INNER JOIN CRE_SIC_PONDERACION P WITH(NOLOCK) ON P.TIPO_SIC=1 AND P.TZ_LOCK=0

---------------------------------------------------------------------------------------------------------------------------------


-- CC - TIPO 2
-- Clientes con cuentas
   	INSERT INTO dbo.CRE_SIC_BITACORA_DET (CLIENTE, FECHA, TIPO, PUNTOS_SIN_POND, PUNTOS_CON_POND, PONDERACION)
	   SELECT G.CLIENTE,@FECHAPROCESO,P.TIPO_SIC,
	   CASE WHEN G.NUEVO=''S'' THEN CC.PUNT_CLI_NUEVO ELSE CC.PUNTAJE END AS PUNTOS_SIN_POND , 
	   CASE WHEN G.NUEVO=''S'' THEN ROUND(CC.PUNT_CLI_NUEVO*P.PONDERACION_CLI_NUEVO/100,0) ELSE ROUND(CC.PUNTAJE*P.PONDERACION/100,0) END AS PUNTOS_SIN_POND ,
	   P.PONDERACION
	   FROM (
			SELECT C.CLIENTE,C.NUEVO,
			CASE WHEN SUM(GRL.SALDO_AJUSTADO)<0 AND SUM(GRL.CUPO_SOBREGIRO)=0 THEN 0
			  	 WHEN SUM(GRL.SALDO_AJUSTADO)<0 AND SUM(GRL.CUPO_SOBREGIRO)>0 THEN 1
			  	 WHEN SUM(GRL.SALDO_AJUSTADO)>=0 THEN 2
			END AS TIPO_SOBREGIRO 	 
				   FROM @CLIENTES C
				   INNER JOIN SALDOS S WITH(NOLOCK)  ON S.C1803=C.CLIENTE
				   INNER JOIN GRL_SALDOS_DIARIOS GRL WITH(NOLOCK) ON GRL.SALDOS_JTS_OID=S.JTS_OID AND GRL.FECHA=@FECHAPROCESO
				   WHERE S.C1785 IN (2,3) AND GRL.TZ_LOCK=0 AND S.TZ_LOCK=0
			GROUP BY C.CLIENTE,C.NUEVO
	   ) G  
		INNER JOIN CRE_SIC_CC CC WITH(NOLOCK) ON CC.TIPO_SOBREGIRO=G.TIPO_SOBREGIRO AND CC.TZ_LOCK=0
		INNER JOIN CRE_SIC_PONDERACION P WITH(NOLOCK) ON P.TIPO_SIC=2 AND P.TZ_LOCK=0
	     
-- Clientes sin cuentas
	INSERT INTO dbo.CRE_SIC_BITACORA_DET (CLIENTE, FECHA, TIPO, PUNTOS_SIN_POND, PUNTOS_CON_POND, PONDERACION)
	   SELECT C.CLIENTE,@FECHAPROCESO,P.TIPO_SIC,
	   CASE WHEN C.NUEVO=''S'' THEN CC.PUNT_CLI_NUEVO ELSE CC.PUNTAJE END AS PUNTOS_SIN_POND , 
	   CASE WHEN C.NUEVO=''S'' THEN ROUND(CC.PUNT_CLI_NUEVO*P.PONDERACION_CLI_NUEVO/100,0) ELSE ROUND(CC.PUNTAJE*P.PONDERACION/100,0) END AS PUNTOS_SIN_POND ,
	   P.PONDERACION
	   FROM @CLIENTES C
	   INNER JOIN CRE_SIC_CC CC WITH(NOLOCK) ON CC.TIPO_SOBREGIRO=3 AND CC.TZ_LOCK=0
	   INNER JOIN CRE_SIC_PONDERACION P WITH(NOLOCK) ON P.TIPO_SIC=2 AND P.TZ_LOCK=0
	   WHERE NOT EXISTS (SELECT 1 FROM CRE_SIC_BITACORA_DET WITH(NOLOCK) WHERE CLIENTE=C.CLIENTE AND FECHA=@FECHAPROCESO
	   AND TIPO=2 AND TZ_LOCK=0)      
----------------------------------------------------------------------------------------------------------------------------------


--MORA - TIPO 3
-- Actualizamos registros que tienen puntaje
	INSERT INTO dbo.CRE_SIC_BITACORA_DET (CLIENTE, FECHA, TIPO, PUNTOS_SIN_POND, PUNTOS_CON_POND, PONDERACION)
	   SELECT G.CLIENTE,@FECHAPROCESO,P.TIPO_SIC,
	   CASE WHEN G.NUEVO=''S'' THEN MOR.PUNT_CLI_NUEVO ELSE MOR.PUNTAJE END AS PUNTOS_SIN_POND , 
	   CASE WHEN G.NUEVO=''S'' THEN ROUND(MOR.PUNT_CLI_NUEVO*P.PONDERACION_CLI_NUEVO/100,0) ELSE ROUND(MOR.PUNTAJE*P.PONDERACION/100,0) END AS PUNTOS_SIN_POND ,
	   P.PONDERACION
			   FROM (
				SELECT CLIENTE, NUEVO,SUM(CANTIDAD) AS CANTIDAD FROM (
					SELECT  S.C1803 AS CLIENTE,NUEVO, MONTH(H.FECHA) AS FECHA, YEAR(H.FECHA) AS ANIO,1 AS CANTIDAD
					FROM HISTORICO_CALIF_X_SALDO H WITH(NOLOCK)
					INNER JOIN SALDOS S WITH(NOLOCK) ON H.JTS_PRESTAMO=S.JTS_OID
					INNER JOIN @CLIENTES C ON C.CLIENTE=S.C1803			
					WHERE H.FECHA BETWEEN DATEADD(MONTH, -12,@FECHAPROCESO) AND @FECHAPROCESO
					AND H.DIAS_ATRASO>31
					GROUP BY S.C1803, C.NUEVO,YEAR(H.FECHA),MONTH(H.FECHA)
				) T
				GROUP BY CLIENTE,NUEVO) G
			INNER JOIN CRE_SIC_MORA MOR WITH(NOLOCK) ON CANTIDAD BETWEEN MOR.RANGO_DESDE AND MOR.RANGO_HASTA AND MOR.TZ_LOCK=0
	   	    INNER JOIN CRE_SIC_PONDERACION P WITH(NOLOCK) ON P.TIPO_SIC=3 AND P.TZ_LOCK=0


-- Si no tuvo en los ultimos 12 meses mora mayor a 30 dias
	INSERT INTO dbo.CRE_SIC_BITACORA_DET (CLIENTE, FECHA, TIPO, PUNTOS_SIN_POND, PUNTOS_CON_POND, PONDERACION)
	   SELECT C.CLIENTE,@FECHAPROCESO,P.TIPO_SIC,
	   CASE WHEN C.NUEVO=''S'' THEN MOR.PUNT_CLI_NUEVO ELSE MOR.PUNTAJE END AS PUNTOS_SIN_POND , 
	   CASE WHEN C.NUEVO=''S'' THEN ROUND(MOR.PUNT_CLI_NUEVO*P.PONDERACION_CLI_NUEVO/100,0) ELSE ROUND(MOR.PUNTAJE*P.PONDERACION/100,0) END AS PUNTOS_SIN_POND ,
	   P.PONDERACION
	   FROM @CLIENTES C 
	   INNER JOIN CRE_SIC_MORA MOR WITH(NOLOCK) ON 0 BETWEEN MOR.RANGO_DESDE AND MOR.RANGO_HASTA AND MOR.TZ_LOCK=0
	   INNER JOIN CRE_SIC_PONDERACION P WITH(NOLOCK) ON P.TIPO_SIC=3 AND P.TZ_LOCK=0
	   WHERE NOT EXISTS (SELECT 1 FROM CRE_SIC_BITACORA_DET WITH(NOLOCK) WHERE CLIENTE=C.CLIENTE AND FECHA=@FECHAPROCESO
	   AND TIPO=2 AND TZ_LOCK=0)




----------------------------------------------------------------------------------------------------------------------------------
--Actualizamos Bitacora - Segmento
UPDATE B SET B.SEGMENTO_NUEVO=S.SEGMENTO, B.PUNTOS=T.PUNTOS
FROM CRE_SIC_BITACORA_CAB  B  WITH(NOLOCK)  
INNER JOIN 
	(SELECT D.CLIENTE,D.FECHA, SUM(D.PUNTOS_CON_POND) AS PUNTOS
	FROM CRE_SIC_BITACORA_DET D  WITH(NOLOCK)  
	WHERE D.FECHA= @FECHAPROCESO AND D.TZ_LOCK=0
	GROUP BY D.CLIENTE, D.FECHA
	) T 
ON B.CLIENTE=T.CLIENTE AND B.FECHA=T.FECHA
INNER JOIN CRE_SIC_SEGMENTACION S WITH(NOLOCK) ON T.PUNTOS BETWEEN S.RANGO_DESDE AND S.RANGO_HASTA AND S.TZ_LOCK=0

-- Actualizar CLI_CLIENTES con resultado de la segmentacion
UPDATE C SET C.SIC_SEGMENTO=B.SEGMENTO_NUEVO, C.SIC_PUNTOS=B.PUNTOS
FROM CLI_CLIENTES C WITH(NOLOCK) 
INNER JOIN CRE_SIC_BITACORA_CAB B WITH(NOLOCK)  ON B.CLIENTE=C.CODIGOCLIENTE AND B.FECHA=@FECHAPROCESO
WHERE C.TZ_LOCK=0




----Mensajes. Se ejecuto correctamente o con errores
BEGIN
			
			            SET @P_RET_PROCESO = 1
			
			            SET @P_MSG_PROCESO = ''Las tablas han sido cargadas correctamente''
			
			            DECLARE
			               @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$5 varchar(8000)
			               
			               SET @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$5 = ''I''
			
			            EXECUTE PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
			               @P_ID_PROCESO = @P_ID_PROCESO, 
			               @P_FCH_PROCESO = @P_DT_PROCESO, 
			               @P_NOM_PACKAGE = ''SP_CRE_SIC'', 
			               @P_COD_ERROR = @P_RET_PROCESO, 
			               @P_MSG_ERROR = @P_MSG_PROCESO, 
			               @P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$5
END

BEGIN 

    SET @P_MSG_PROCESO = ''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros''     
           
    SET @P_RET_PROCESO = 1
      
    DECLARE @p_tipo_error varchar(80)
    SET @p_tipo_error=''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros'' 


EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
				@P_ID_PROCESO,
		    	@P_DT_PROCESO,
		    	''SP_CRE_SIC'',
		    	@P_RET_PROCESO,
		    	@P_MSG_PROCESO,
		    	@p_tipo_error  

END
END TRY 

        BEGIN CATCH
              	BEGIN	 
         
				  SET @P_RET_PROCESO = 3
					
				  SET @P_MSG_PROCESO = ''Ingreso Finalizo con Errores:'' + ERROR_MESSAGE()
					         
				  DECLARE
					@PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$4 varchar(8000)
					
					SET @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$4 = ''E''
							
				  EXECUTE dbo.PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
					@P_ID_PROCESO = @P_ID_PROCESO, 
					@P_FCH_PROCESO = @P_DT_PROCESO, 
					@P_NOM_PACKAGE = ''SP_CRE_SIC - Error'', 
					@P_COD_ERROR = @P_RET_PROCESO, 
					@P_MSG_ERROR = @P_MSG_PROCESO, 
					@P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$4
					
				END
              END CATCH  
END
')
