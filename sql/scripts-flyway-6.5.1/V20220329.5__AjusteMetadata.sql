EXECUTE('
ALTER PROCEDURE [dbo].[SP_ACTUALIZA_SITUACION_RESULTANTE]
	@p_id_proceso FLOAT(53),     /* Identificador de proceso */
	@p_dt_proceso DATETIME,   /* Fecha de proceso */
	@p_ret_proceso FLOAT OUT, /* Estado de ejecucion SQL(0:Correcto, 2: Error) */
	@p_msg_proceso VARCHAR(MAX) OUT
AS
BEGIN
	DECLARE 
	------- Campos para el LOG --------
	@c_log_tipo_error varchar(30),
	@c_log_tipo_informacion VARCHAR(30),
	-----------------------------------	
	@contador NUMERIC(10)
	SET @contador = 0;
	------- Campos para el LOG --------
	SET @c_log_tipo_error = ''E'';
	SET @c_log_tipo_informacion = ''I'';
	-----------------------------------	

	BEGIN TRY
        	  
		SET @contador =	(SELECT count(1) FROM CLI_CLIENTES WHERE NIVEL_APERTURA = 3 AND TZ_LOCK = 0)				
		
		IF @contador > 0
		BEGIN
			UPDATE c
			SET c.CATEGORIARESULTANTE = a.CALIFICACION
			FROM CLI_CLIENTES c WITH (NOLOCK)
			INNER JOIN (
			SELECT CASE WHEN CATEGORIASUBJETIVA <> '' '' AND CATEGORIASUBJETIVA IS NOT NULL THEN CATEGORIASUBJETIVA 
			WHEN Sit_MorExEnt <> '' '' AND Sit_MorExEnt IS NOT NULL THEN Sit_MorExEnt 
			WHEN SITUACION_JUDICIAL <> '' '' AND SITUACION_JUDICIAL IS NOT NULL THEN SITUACION_JUDICIAL
			WHEN DISCREPANCIA <> '' '' AND DISCREPANCIA IS NOT NULL THEN DISCREPANCIA
			WHEN (SELECT PONDERACION FROM CLI_CLASUBJETIVA WITH (NOLOCK) WHERE CATEGORIASUB = isnull(OBJETIVA_REFINANCIADO, '' '')) >= (SELECT PONDERACION FROM CLI_CLASUBJETIVA WITH (NOLOCK) WHERE CATEGORIASUB = isnull(CATEGORIAOBJETIVA,'' '')) THEN OBJETIVA_REFINANCIADO			
			ELSE CATEGORIAOBJETIVA END AS CALIFICACION,
			CODIGOCLIENTE 
			FROM CLI_CLIENTES WITH (NOLOCK) WHERE NIVEL_APERTURA = 3 AND TZ_LOCK = 0) a
			ON a.CODIGOCLIENTE = c.CODIGOCLIENTE
			
			DELETE HISTORICO_CALIF_X_CLIENTE WHERE CLIENTE IN (SELECT CODIGOCLIENTE FROM CLI_CLIENTES WITH (NOLOCK) WHERE NIVEL_APERTURA = 3 AND TZ_LOCK = 0) AND FECHA = (SELECT FECHAPROCESO FROM PARAMETROS)
			
			INSERT INTO dbo.HISTORICO_CALIF_X_CLIENTE (CLIENTE, FECHA, CALIFICACION_OBJETIVA, CALIFICACION_REESTRUCTURADA, CALIFICACION_SUBJETIVA, CALIFICACION_SF, CALIFICACION_RESULTANTE, TIPO_RIESGO, DIAS_ATRASO, TZ_LOCK, SITUACION_JUDICIAL, Sit_MorExEnt, DISCREPANCIA, TIPO_CALIFICACION)
			SELECT CODIGOCLIENTE, (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK)), CATEGORIAOBJETIVA, REESTRUCTURA, CATEGORIASUBJETIVA, CATEGORIA_OFICIAL, 
			CASE WHEN CATEGORIASUBJETIVA <> '' '' AND CATEGORIASUBJETIVA IS NOT NULL THEN CATEGORIASUBJETIVA 
			WHEN Sit_MorExEnt <> '' '' AND Sit_MorExEnt IS NOT NULL THEN Sit_MorExEnt 
			WHEN SITUACION_JUDICIAL <> '' '' AND SITUACION_JUDICIAL IS NOT NULL THEN SITUACION_JUDICIAL
			WHEN DISCREPANCIA <> '' '' AND DISCREPANCIA IS NOT NULL THEN DISCREPANCIA
			WHEN (SELECT PONDERACION FROM CLI_CLASUBJETIVA WITH (NOLOCK) WHERE CATEGORIASUB = isnull(OBJETIVA_REFINANCIADO, '' '')) >= (SELECT PONDERACION FROM CLI_CLASUBJETIVA WITH (NOLOCK) WHERE CATEGORIASUB = isnull(CATEGORIAOBJETIVA,'' '')) THEN OBJETIVA_REFINANCIADO			
			ELSE CATEGORIAOBJETIVA END AS CALIFICACION_RESULTANTE,
			CATEGORIA_COMERCIAL, 0, 0, SITUACION_JUDICIAL, Sit_MorExEnt, DISCREPANCIA,
			CASE WHEN CATEGORIASUBJETIVA <> '' '' AND CATEGORIASUBJETIVA IS NOT NULL THEN 1 
			WHEN Sit_MorExEnt <> '' '' AND Sit_MorExEnt IS NOT NULL THEN 2 
			WHEN SITUACION_JUDICIAL <> '' '' AND SITUACION_JUDICIAL IS NOT NULL THEN 3
			WHEN DISCREPANCIA <> '' '' AND DISCREPANCIA IS NOT NULL THEN 4
			WHEN (SELECT PONDERACION FROM CLI_CLASUBJETIVA WITH (NOLOCK) WHERE CATEGORIASUB = isnull(OBJETIVA_REFINANCIADO, '' '')) >= (SELECT PONDERACION FROM CLI_CLASUBJETIVA WITH (NOLOCK) WHERE CATEGORIASUB = isnull(CATEGORIAOBJETIVA,'' '')) THEN 5			
			ELSE 6 END AS TIPO_CALIFICACION
			FROM CLI_CLIENTES WITH (NOLOCK) WHERE NIVEL_APERTURA = 3 AND TZ_LOCK = 0	
			
			UPDATE hist
			SET hist.FECHA_SITUACION = b.FECHA_SITUACION
			FROM HISTORICO_CALIF_X_CLIENTE hist WITH (NOLOCK)
			INNER JOIN (
				SELECT CASE WHEN a.CALIFICACION_RESULTANTE IS NULL THEN (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))
				WHEN a.CALIFICACION_RESULTANTE <> h.CALIFICACION_RESULTANTE THEN (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))
				ELSE a.FECHA_SITUACION END AS FECHA_SITUACION, h.CLIENTE, h.FECHA
				FROM HISTORICO_CALIF_X_CLIENTE h WITH (NOLOCK)
				LEFT JOIN (SELECT CLIENTE, CALIFICACION_RESULTANTE, FECHA_SITUACION,
							ROW_NUMBER() OVER(PARTITION BY CLIENTE ORDER BY FECHA DESC) AS CANTIDAD
							FROM HISTORICO_CALIF_X_CLIENTE WITH (NOLOCK)
							WHERE FECHA <> (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))) a ON a.CLIENTE = h.CLIENTE AND a.CANTIDAD = 1
				WHERE h.FECHA = (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK)) AND h.TZ_LOCK = 0) b 
			ON hist.CLIENTE = b.CLIENTE AND hist.FECHA = b.FECHA			
				
		END
		  
		    SET @p_msg_proceso = ''El Proceso de Actualizaci贸n de Situacion Resultante ha finalizado correctamente. Registros procesados: ''+ CONVERT(VARCHAR(10), @contador)
			SET @p_ret_proceso = 1 		
			
			-- Logueo de informaci贸n
			EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
				@p_id_proceso,
		    	@p_dt_proceso,
		    	''SP_ACTUALIZA_SITUACION_RESULTANTE'',
		    	@p_cod_error = @p_ret_proceso, 
				@p_msg_error = @p_msg_proceso, 
				@p_tipo_error = @c_log_tipo_informacion
		END TRY
							             
		BEGIN CATCH
	
	        SET @p_ret_proceso = ERROR_NUMBER()
	        SET @p_msg_proceso = ''Ocurri贸 un error en el Proceso de Actualizaci贸n de Situacion Resultante: '' + ERROR_MESSAGE()
	
			EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
	        	@p_id_proceso = @p_id_proceso, 
	        	@p_fch_proceso = @p_dt_proceso, 
	        	@p_nom_package = ''SP_ACTUALIZA_SITUACION_RESULTANTE'', 
	        	@p_cod_error = @p_ret_proceso, 
	        	@p_msg_error = @p_msg_proceso, 
	       		@p_tipo_error = @c_log_tipo_informacion
		END CATCH
END
')

