EXECUTE('
CREATE OR ALTER   PROCEDURE [dbo].[SP_ITF_SOS_VINCULACION]
	@Fecha VARCHAR(8)
AS
BEGIN

--Limpiamos por si hay reproceso
DELETE FROM SOS_VINCULACION WHERE convert(VARCHAR,FECHADEINFORMACION) = @Fecha;

SELECT DISTINCT A.EMPRESA,
    A.CLASEDECUENTA, 
	A.NUMERODECUENTA, 
	A.TIPODECUENTAUOPERACION,
	A.SUCURSALSISCEN,
	A.CODCLIENTE AS CODCLIENTE,
	A.SALDO_JTS_OID
  INTO #TMP_CLIENTE
FROM SOS_MOVS_HISTORICOS A (NOLOCK)
WHERE A.FECHADEINFORMACION = @Fecha

INSERT INTO SOS_VINCULACION
SELECT DISTINCT B.EMPRESA, 
	@Fecha AS FECHADEINFORMACION, 
	B.CLASEDECUENTA, 
	B.NUMERODECUENTA, 
	B.TIPODECUENTAUOPERACION, 
	'''' AS NUMERODEOPERACION,
	B.SUCURSALSISCEN,
	''11'' AS IDENTTRIBUTARIATIPO, 
	CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS IDENTTRIBUTARIANUMERO,
	1 AS CONDICION,
	ROW_NUMBER() OVER (PARTITION BY B.CLASEDECUENTA, B.NUMERODECUENTA, B.TIPODECUENTAUOPERACION, 
	  B.SUCURSALSISCEN, B.CODCLIENTE ORDER BY TITULARIDAD desc) AS ORDENRELACION,
	'''' AS FECHAALTA,
	B.CODCLIENTE,
	NAT.NUMEROPERSONAFISICA
--SELECT B.*
FROM #TMP_CLIENTE B
  INNER JOIN CLI_ClientePersona D (NOLOCK) ON D.CODIGOCLIENTE = B.CODCLIENTE AND D.TZ_LOCK = 0
  INNER JOIN CLI_PERSONASFISICAS nat (NOLOCK) ON nat.NUMEROPERSONAFISICA = d.NUMEROPERSONA
  INNER JOIN CLI_DocumentosPFPJ doc (NOLOCK) ON doc.NUMEROPERSONAFJ = D.NUMEROPERSONA AND doc.TZ_LOCK = 0

INSERT INTO SOS_VINCULACION
SELECT DISTINCT B.EMPRESA, 
	@Fecha AS FECHADEINFORMACION, 
	B.CLASEDECUENTA, 
	B.NUMERODECUENTA, 
	B.TIPODECUENTAUOPERACION, 
	'''' AS NUMERODEOPERACION,
	B.SUCURSALSISCEN,
	(CASE WHEN jur.TIPOSOCIEDAD IN (66,29) THEN jur.TIPOSOCIEDAD ELSE 11 END) AS IDENTTRIBUTARIATIPO, 
	CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS IDENTTRIBUTARIANUMERO,
	1 AS CONDICION,
	1 AS ORDENRELACION,
	'''' AS FECHAALTA,
	B.CODCLIENTE,
	jur.NUMEROPERSONAJURIDICA
FROM #TMP_CLIENTE B
  INNER JOIN CLI_ClientePersona D (NOLOCK) ON D.CODIGOCLIENTE = B.CODCLIENTE AND D.TZ_LOCK = 0
  INNER JOIN CLI_PERSONASJURIDICAS jur (NOLOCK) ON jur.NUMEROPERSONAJURIDICA = d.NUMEROPERSONA
  INNER JOIN CLI_DocumentosPFPJ doc (NOLOCK) ON doc.NUMEROPERSONAFJ = D.NUMEROPERSONA AND doc.TZ_LOCK = 0
UNION ALL
SELECT DISTINCT B.EMPRESA, 
	@Fecha AS FECHADEINFORMACION, 
	B.CLASEDECUENTA, 
	B.NUMERODECUENTA, 
	B.TIPODECUENTAUOPERACION, 
	'''' AS NUMERODEOPERACION,
	B.SUCURSALSISCEN,
	11 AS IDENTTRIBUTARIATIPO, 
	CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS IDENTTRIBUTARIANUMERO,
	3 AS CONDICION,
	ROW_NUMBER() OVER (PARTITION BY B.CLASEDECUENTA, B.NUMERODECUENTA, B.TIPODECUENTAUOPERACION, 
	  B.SUCURSALSISCEN, B.CODCLIENTE ORDER BY TITULARIDAD desc) AS ORDENRELACION,
	'''' AS FECHAALTA,
	B.CODCLIENTE,
	I.NUMEROPERSONAFISICA
FROM #TMP_CLIENTE B
  INNER JOIN CLI_ClientePersona D (NOLOCK) ON D.CODIGOCLIENTE = B.CODCLIENTE AND D.TZ_LOCK = 0
  INNER JOIN CLI_PERSONASJURIDICAS jur (NOLOCK) ON jur.NUMEROPERSONAJURIDICA = d.NUMEROPERSONA
  INNER JOIN CLI_INTEGRANTESPJ I (NOLOCK) ON I.NUMEROPERSONAJURIDICA = D.NUMEROPERSONA AND I.TZ_LOCK = 0 AND I.CODIGOCARGO = ''REP''
  INNER JOIN PYF_APODERADOS AP (NOLOCK) ON AP.ID_PERSONA = I.NUMEROPERSONAFISICA AND AP.ID_ENTIDAD = B.SALDO_JTS_OID AND AP.TZ_LOCK = 0
    AND AP.TIPO_ENTIDAD = 2
  INNER JOIN CLI_DocumentosPFPJ doc (NOLOCK) ON doc.NUMEROPERSONAFJ = I.NUMEROPERSONAFISICA AND doc.TZ_LOCK = 0

END
')