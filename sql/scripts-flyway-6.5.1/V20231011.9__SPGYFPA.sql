EXECUTE('
ALTER PROCEDURE SP_PA_GRADUACION_FRACCIONAMIENTO
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS
BEGIN
DECLARE @CANTIDAD_REGISTROS INT 
DECLARE @CLIENTES TABLE (CLIENTE NUMERIC(12), NUMEROPERSONA NUMERIC(12), NROREGISTRO BIGINT)
DECLARE @PROCESANDO INT
DECLARE @CLIENTE NUMERIC(12)
DECLARE @PERSONA NUMERIC(12)
DECLARE @IMPORTE_SOLICITUD NUMERIC(15,2)
DECLARE @GRADUACION VARCHAR(1)
DECLARE @CON_GTIA VARCHAR(1)
DECLARE @fechaproceso DATETIME
DECLARE @sucursal NUMERIC(5)
--- Retornos de sp

DECLARE @TOTAL_DEUDA NUMERIC (20, 2)
DECLARE @TRAMO_SIN_G NUMERIC (20, 2)
DECLARE @TRAMO_CON_G NUMERIC (20, 2)
DECLARE @TRAMO_SIN_G_B NUMERIC (20, 2)
DECLARE @TRAMO_CON_G_B NUMERIC (20, 2)
DECLARE @RPC_BANCO NUMERIC (20, 2)
DECLARE @EXCLUSIONES NUMERIC (20, 2)
DECLARE @TOT_CONTROL_GRAD NUMERIC (20, 2)
DECLARE @RPC_CLIENTE NUMERIC (20, 2)
DECLARE @RPC_CLIENTE_MAX NUMERIC (20, 2)
DECLARE @RPC_NETO_BANCO NUMERIC (20, 2)
DECLARE @MARGEN_RESGUAR NUMERIC (20, 2)
DECLARE @LIMITE_GRAD NUMERIC (20, 2)
DECLARE @RESULTADO_GRADUACION VARCHAR (200)
DECLARE @RESULTADO_FRACCIONAMIENTO VARCHAR (200)
DECLARE @IMPORTE_SING_GRUPO NUMERIC (20, 2)
DECLARE @IMPORTE_CONG_GRUPO NUMERIC (20, 2)
DECLARE @PERIODO VARCHAR (10)
DECLARE @CN1_BANCO NUMERIC (20, 2)
DECLARE @MARGEN_BASICO NUMERIC (5, 2)
DECLARE @RPC_CLIENTE_O NUMERIC (5, 2)
DECLARE @RPC_BANCO_O NUMERIC (5, 2)
DECLARE @RPC_CLIENTE_SGR_FGP NUMERIC (5, 2)
DECLARE @RPC_BANCO_SGR_FGP NUMERIC (5, 2)
DECLARE @PORC_TRAMO_SING NUMERIC (5, 2)
DECLARE @PORC_TRAMO_CONG NUMERIC (5, 2)
DECLARE @MARGEN_RESGUARDO NUMERIC (5, 2)
DECLARE @RPC_BANCO_IMP NUMERIC (15, 2)
DECLARE @VINCULO VARCHAR (80)
DECLARE @DESCRIPCION_GRUPO VARCHAR (60)
DECLARE @MENSAJE_VINCULADOS VARCHAR (200)
DECLARE @EXCEDE_GRADUACION_O VARCHAR(1)
DECLARE @EXCEDE_FRACCIONAMIENTO_O VARCHAR(1)

    SET @P_RET_PROCESO = NULL
    SET @P_MSG_PROCESO = NULL 
    
    
    SET @GRADUACION = ''N'';
    SET @CON_GTIA = ''N'';
    SET @IMPORTE_SOLICITUD = 0;
    
    SET @fechaproceso = (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
    
    SET @sucursal = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO = 21)
      
	INSERT INTO @CLIENTES
	SELECT VF.CLIENTE, MAX(VCD.NUMEROPERSONA) AS NUMEROPERSONA,
	ROW_NUMBER() OVER (ORDER BY VF.CLIENTE)
	FROM VW_FAMILIAS_LIMITE VF WITH(NOLOCK)
	INNER JOIN VW_CLI_X_DOC VCD WITH(NOLOCK) ON VF.CLIENTE = VCD.CODIGOCLIENTE
	GROUP BY VF.CLIENTE
	
	SET @CANTIDAD_REGISTROS = (SELECT COUNT(1) FROM @CLIENTES)
	SET @PROCESANDO = 1
	
	DELETE FROM CRE_GRAD_FRACC_BITACORA WHERE TIPO = ''B'' AND FECHAPROCESO = @fechaproceso

	WHILE(@PROCESANDO <= @CANTIDAD_REGISTROS)
	BEGIN
		SELECT @CLIENTE = CLIENTE, @PERSONA = NUMEROPERSONA FROM @CLIENTES
		WHERE NROREGISTRO = @PROCESANDO;
		
		--- Ejecuta sp
		
		
		EXECUTE dbo.SP_CALCULA_GRADUACION @CLIENTE, @PERSONA, @IMPORTE_SOLICITUD, @GRADUACION, @CON_GTIA, @TOTAL_DEUDA OUT, @TRAMO_SIN_G OUT, @TRAMO_CON_G OUT, @TRAMO_SIN_G_B OUT, @TRAMO_CON_G_B OUT, @RPC_BANCO OUT, @EXCLUSIONES OUT, @TOT_CONTROL_GRAD OUT, @RPC_CLIENTE OUT, @RPC_CLIENTE_MAX OUT, @RPC_NETO_BANCO OUT, @MARGEN_RESGUAR OUT, @LIMITE_GRAD OUT, @RESULTADO_GRADUACION OUT, @RESULTADO_FRACCIONAMIENTO OUT, @IMPORTE_SING_GRUPO OUT, @IMPORTE_CONG_GRUPO OUT, @PERIODO OUT, @CN1_BANCO OUT, @MARGEN_BASICO OUT, @RPC_CLIENTE_O OUT, @RPC_BANCO_O OUT, @RPC_CLIENTE_SGR_FGP OUT, @RPC_BANCO_SGR_FGP OUT, @PORC_TRAMO_SING OUT, @PORC_TRAMO_CONG OUT, @MARGEN_RESGUARDO OUT, @RPC_BANCO_IMP OUT, @VINCULO OUT, @DESCRIPCION_GRUPO OUT, @MENSAJE_VINCULADOS OUT, @EXCEDE_GRADUACION_O OUT, @EXCEDE_FRACCIONAMIENTO_O OUT
	
		--- Registra en tabla bitacora
		
		INSERT INTO dbo.CRE_GRAD_FRACC_BITACORA (TZ_LOCK, CODIGOCLIENTE, ASIENTO, FECHAPROCESO, SUCURSAL, TIPO, 
		CN1_BANCO, PORC_TRAMO_SIN_G, TRAMO_SIN_GARANTIA, PORC_TRAMO_CON_G, TRAMO_CON_GARANTIA, 
		DEUDA_SIN_GARANTIA, DEUDA_CON_GARANTIA, DEUDA_CON_GARANTIA_GRUPO, DEUDA_SIN_GARANTIA_GRUPO, 
		RPC_BANCO, EXCLUSIONES, RPC_CLIENTE, PORCENTAJE_RPC_CLIENTE, MAXIMO_RPC_CLIENTE, PORC_RPC_NETA_BANCO, 
		RPC_NETA_BANCO, PORC_MARGE_RES, MARGEN_REGUARDO, LIMITE_GRADUACION, IMPORTE_SOLICITADO, EXCLUIDO, 
		CON_GTIA, DEUDA_TOTAL, PERIODO, RESULTADO_GRAD, RESULTADO_FRACC)
	    VALUES (0, @CLIENTE, 0, @fechaproceso, @sucursal, ''B'', @CN1_BANCO, 
	    @PORC_TRAMO_SING, @TRAMO_SIN_G_B, @PORC_TRAMO_CONG, @TRAMO_CON_G_B, @TRAMO_SIN_G, 
	    @TRAMO_CON_G, @IMPORTE_CONG_GRUPO, @IMPORTE_SING_GRUPO, @RPC_BANCO, @EXCLUSIONES, 
	    @RPC_CLIENTE, @RPC_CLIENTE_O, @RPC_CLIENTE_MAX, @RPC_BANCO_O, @RPC_NETO_BANCO, 
	    @MARGEN_RESGUARDO, @MARGEN_RESGUAR, @LIMITE_GRAD, @IMPORTE_SOLICITUD, @GRADUACION, @CON_GTIA, 
	    @TOTAL_DEUDA, @PERIODO, @RESULTADO_GRADUACION, @RESULTADO_FRACCIONAMIENTO)
	
		SET @PROCESANDO += 1;
	END
      
    SET @P_MSG_PROCESO = ''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros''     
           
    SET @P_RET_PROCESO = 1
      
    DECLARE @p_tipo_error varchar(80)
    SET @p_tipo_error=''Se procesaron ''+convert(VARCHAR,@CANTIDAD_REGISTROS)+'' registros'' 

EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
				@P_ID_PROCESO,
		    	@P_DT_PROCESO,
		    	''SP_PA_GRADUACION_FRACCIONAMIENTO'',
		    	@P_RET_PROCESO,
		    	@P_MSG_PROCESO,
		    	@p_tipo_error
		    	
		    	
END
')

