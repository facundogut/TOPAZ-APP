EXECUTE('
ALTER PROCEDURE dbo.SP_CONTROL_GYF_GRUPO
@GRUPO NUMERIC(12),
@MONTO_SOLICITUD NUMERIC(15,2),
@EXCLUSION VARCHAR(1),
@CON_GTIA VARCHAR(1),
@CLIENTE NUMERIC(12,0),
@EXCLUIDO VARCHAR (1),
@LIMITE_GRAD NUMERIC(15,2),
@TRAMO_SIN_G_B NUMERIC(15,2),
@TRAMO_CON_G_B NUMERIC(15,2),
@EXCEDE_GRADUACION VARCHAR(1) OUTPUT,
@EXCEDE_FRACCIONAMIENTO VARCHAR(1) OUTPUT,
@IMPORTE_SING_GRUPO NUMERIC (15,2) OUTPUT,
@IMPORTE_CONG_GRUPO NUMERIC (15,2) OUTPUT,
@TOTAL_DEUDA_GRUPO NUMERIC (15,2) OUTPUT,
@EXCLUSIONES_GRUPALES_GRADUACION NUMERIC (15,2) OUTPUT,
@IMPORTE_A_EVALUAR NUMERIC (15,2) OUTPUT,
@RESULTADO_GRADUACION VARCHAR(200) OUTPUT,
@RESULTADO_FRACCIONAMIENTO VARCHAR(200) OUTPUT
AS 
BEGIN
--EXCLUSIONES CLIENTE GRUPO
DECLARE @EXCLUSION_CLI_GRUPO_G NUMERIC (15,2);
DECLARE @EXCLUSION_CLI_GRUPO_F_CONG NUMERIC (15,2);
DECLARE @EXCLUSION_CLI_GRUPO_F_SING NUMERIC (15,2); 
--EXLUSIONES ASISTENCIA GRUPO
DECLARE @EXCLUSION_ASIST_GRUPO_G NUMERIC (15,2); 
DECLARE @EXCLUSION_ASIST_GRUPO_F_CONG  NUMERIC (15,2); 
DECLARE @EXCLUSION_ASIST_GRUPO_F_SING NUMERIC (15,2); 
--EXCLUSIONES PRODUCTO GRUPO
DECLARE @EXCLUSION_PROD_GRUPO_G NUMERIC (15,2); 
DECLARE @EXCLUSION_PROD_GRUPO_F_CONG NUMERIC (15,2); 
DECLARE @EXCLUSION_PROD_GRUPO_F_SING NUMERIC (15,2); 
--VARIABLES QUE SUMAN EXCLUSIONES DEL GRUPO
DECLARE @EXC_GRUPO_CON_G NUMERIC (15,2); 
DECLARE @EXC_GRUPO_SIN_G NUMERIC (15,2);
--EXCLUSIONES DEL GRUPO GRAL
DECLARE @EXCLUSION_GRUPOCLIENTE_G NUMERIC (15,2);
DECLARE @EXCLUSION_GRUPOASIST_G NUMERIC (15,2);
DECLARE @EXCLUSION_GRUPOPROD_G NUMERIC (15,2);
DECLARE @TOTAL_DEUDA_GRUPO_F NUMERIC (15,2);
--- Tabla auxiliar de deudas
DECLARE @TABLA_ASISTENCIAS TABLE (CLIENTE NUMERIC(12), JTS_ASISTENCIA NUMERIC(10),
IMPORTE_DEUDA NUMERIC(15,2), TIENE_GARANTIA VARCHAR(1), TIPO_GARANTIA NUMERIC(2),
PRODUCTO NUMERIC(5), FAMILIA NUMERIC(10))
---LECTURA Y GRABADO EN TABLA TEMPORAL CLIENTE X CLIENTE

BEGIN
DECLARE @TBL_AUX TABLE (
     CLIENTE NUMERIC(12),
     DEUDA_TOTAL NUMERIC(20,2),
     DEUDA_CON_G NUMERIC(20,2),
     DEUDA_SIN_G NUMERIC(20,2),
     EXCLUSION_CLI_F_CONG NUMERIC (20,2),
     EXCLUSION_ASIST_F_CONG NUMERIC (20,2),
     EXCLUSION_PROD_F_CONG NUMERIC (20,2),
     EXCLUSION_GAR_F_CONG NUMERIC (20,2),
     EXCLUSION_CLI_F_SING NUMERIC (20,2),
     EXCLUSION_ASIST_F_SING NUMERIC (20,2),
     EXCLUSION_PROD_F_SING NUMERIC (20,2),
     EXCLUSION_CLI_GRAD NUMERIC (20,2),
     EXCLUSION_ASIST_GRAD NUMERIC (20,2),
     EXCLUSION_PROD_GRAD NUMERIC (20,2),
     EXCLUSION_GAR_GRAD NUMERIC (20,2),
     TOT_CONTROL_GRAD NUMERIC (20,2),
     TRAMO_SIN_G NUMERIC (20,2),
     TRAMO_CON_G NUMERIC (20,2),
     EXCEDIDO_GRAD VARCHAR(1),
     EXCEDIDO_FRACC VARCHAR (1)
    )
    

	INSERT INTO @TABLA_ASISTENCIAS
	SELECT 
	AD.CLIENTE,
	AD.JTS_OID,
	SUM(AD.SALDO_DEUDA),
	CASE 
	WHEN CG.JTSOID_SALDO IS NULL THEN ''N''
	ELSE ''S''
	END AS GARANTIA,
	ISNULL(CTG.TIPO_GARANTIA,0),
	p.C6250, 
	f.FAMILIAPROD
	FROM VW_DEUDA_CLIENTES AD WITH(NOLOCK)
	INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = AD.JTS_OID
	INNER JOIN PRODUCTOS p WITH(NOLOCK) ON s.PRODUCTO = p.C6250 
	AND ( (p.tz_lock < 300000000000000 OR p.tz_lock >= 400000000000000) 
	AND (p.tz_lock < 100000000000000 OR p.tz_lock >= 200000000000000)  )
	INNER JOIN CRE_FAMILIAS f ON p.C6283 = f.FAMILIAPROD 
	AND ( (f.tz_lock < 300000000000000 OR f.tz_lock >= 400000000000000) 
	AND (f.tz_lock < 100000000000000 OR f.tz_lock >= 200000000000000)  )	
	LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID
	LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA
	LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND
	CTG.TIPO_BCRA IN (1,2)
	WHERE AD.SALDO_DEUDA <> 0 AND S.C1785 IN (1,5,6)
	AND AD.CLIENTE IN (SELECT A.CODIGOCLIENTE FROM dbo.CLI_GRUPOSECONOMICOSCLIENTE A WITH(NOLOCK)
	INNER JOIN  dbo.CLI_CLIENTES B WITH(NOLOCK) ON A.CODIGOCLIENTE = B.CODIGOCLIENTE 
    AND B.TZ_LOCK = 0 WHERE A.TZ_LOCK = 0 AND A.CODIGOGRUPOECONOMICO=@GRUPO)
	GROUP BY AD.JTS_OID, CG.JTSOID_SALDO, CTG.TIPO_GARANTIA, p.C6250, f.FAMILIAPROD, AD.CLIENTE
	
INSERT INTO @TBL_AUX (CLIENTE, DEUDA_TOTAL, DEUDA_CON_G, DEUDA_SIN_G)
    SELECT A.CLIENTE,
    SUM(A.IMPORTE_DEUDA) AS DEUDA_TOTAL,
    ISNULL(SUM(CASE WHEN TIENE_GARANTIA =''S'' THEN A.IMPORTE_DEUDA ELSE 0 END),0),
    ISNULL(SUM(CASE WHEN TIENE_GARANTIA =''N'' THEN A.IMPORTE_DEUDA ELSE 0 END),0)
    FROM  @TABLA_ASISTENCIAS A 
    GROUP BY CLIENTE
   

---UPDATE DE CAMPOS EXCLUSIONES FRACCIONAMIENTO CON GARANTIA
    UPDATE @TBL_AUX
    SET EXCLUSION_CLI_F_CONG = ISNULL((SELECT SUM(AD.IMPORTE_DEUDA) 
                               FROM @TABLA_ASISTENCIAS AD 
                               WHERE AD.CLIENTE=T.CLIENTE AND
	AD.CLIENTE IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE 
	FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
    AND AD.TIENE_GARANTIA = ''S''),0)
    FROM @TBL_AUX T
   
   

	UPDATE @TBL_AUX
    SET EXCLUSION_ASIST_F_CONG = ISNULL((SELECT SUM(AD.IMPORTE_DEUDA)
                                 FROM @TABLA_ASISTENCIAS AD 
                                 WHERE T.CLIENTE=AD.CLIENTE AND
	AD.CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE FRACCIONAMIENTO=''S'' 
	AND TZ_LOCK=0)
    AND AD.JTS_ASISTENCIA IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
    WITH(NOLOCK) WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0) AND AD.TIENE_GARANTIA = ''S''),0)
    FROM @TBL_AUX T
   
    
	UPDATE @TBL_AUX
    SET EXCLUSION_PROD_F_CONG = ISNULL((SELECT SUM(AD.IMPORTE_DEUDA)
                                FROM @TABLA_ASISTENCIAS AD
                                WHERE T.CLIENTE=AD.CLIENTE  
                                AND AD.CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
                                WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
   AND AD.JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
   WITH(NOLOCK) WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0)
   AND (AD.PRODUCTO IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''P'' 
   AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0))
   OR (AD.FAMILIA IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''F'' 
   AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0)) AND AD.TIENE_GARANTIA = ''S''),0) 
   FROM @TBL_AUX T
   
   	UPDATE @TBL_AUX
    SET EXCLUSION_GAR_F_CONG = ISNULL((SELECT SUM(AD.IMPORTE_DEUDA)
                                FROM @TABLA_ASISTENCIAS AD
                                WHERE T.CLIENTE=AD.CLIENTE  
                                AND AD.CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
                                WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
   AND AD.JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
   WITH(NOLOCK) WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0)
   AND (AD.PRODUCTO NOT IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''P'' 
   AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0))
   OR (AD.FAMILIA NOT IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''F'' 
   AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0)) AND TIPO_GARANTIA IN
   (SELECT TIPO_GARANTIA FROM CRE_EXCLUSIONES_TIPOSGARANTIAS WITH(NOLOCK) WHERE FRACCIONAMIENTO=''S'')),0) 
   FROM @TBL_AUX T
   
   

---UPDATE DE CAMPOS EXCLUSIONES FRACCIONAMIENTO SIN GARANTIA
	UPDATE @TBL_AUX
    SET EXCLUSION_CLI_F_SING = ISNULL((SELECT SUM(AD.IMPORTE_DEUDA) 
                               FROM @TABLA_ASISTENCIAS AD 
                               WHERE AD.CLIENTE=T.CLIENTE AND
	AD.CLIENTE IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE 
	FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
    AND AD.TIENE_GARANTIA = ''N''),0)
    FROM @TBL_AUX T
   
   
	UPDATE @TBL_AUX
    SET EXCLUSION_ASIST_F_SING = ISNULL((SELECT SUM(AD.IMPORTE_DEUDA)
                                 FROM @TABLA_ASISTENCIAS AD 
                                 WHERE T.CLIENTE=AD.CLIENTE AND
	 AD.CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE FRACCIONAMIENTO=''S'' 
	 AND TZ_LOCK=0)
     AND AD.JTS_ASISTENCIA IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
     WITH(NOLOCK) WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0) AND AD.TIENE_GARANTIA = ''N''),0)
     FROM @TBL_AUX T
   
	UPDATE @TBL_AUX
    SET EXCLUSION_PROD_F_SING = ISNULL((SELECT SUM(AD.IMPORTE_DEUDA)
                                FROM @TABLA_ASISTENCIAS AD
                                WHERE T.CLIENTE=AD.CLIENTE  
                                AND AD.CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
                                WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
    AND AD.JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
    WITH(NOLOCK) WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0)
    AND (AD.PRODUCTO IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''P'' 
    AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0))
    OR (AD.FAMILIA IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''F'' 
    AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK = 0)) AND AD.TIENE_GARANTIA = ''N''),0) 
    FROM @TBL_AUX T
    

	---- Exclusiones graduacion

	UPDATE @TBL_AUX
    SET EXCLUSION_CLI_GRAD=ISNULL((SELECT SUM(AD.IMPORTE_DEUDA) 
                               FROM @TABLA_ASISTENCIAS AD 
                               WHERE AD.CLIENTE=T.CLIENTE AND
	AD.CLIENTE IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE 
	GRADUACION=''S'' AND TZ_LOCK=0)),0)
    FROM @TBL_AUX T
  
   
	UPDATE @TBL_AUX
    SET EXCLUSION_ASIST_GRAD=ISNULL((SELECT SUM(AD.IMPORTE_DEUDA)
                                 FROM @TABLA_ASISTENCIAS AD 
                                 WHERE T.CLIENTE=AD.CLIENTE AND
	 AD.CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE GRADUACION=''S'' 
	 AND TZ_LOCK=0)
     AND AD.JTS_ASISTENCIA IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
     WITH(NOLOCK) WHERE GRADUACION = ''S'' AND TZ_LOCK=0)),0)
     FROM @TBL_AUX T
     
 
	UPDATE @TBL_AUX
    SET EXCLUSION_PROD_GRAD=ISNULL((SELECT SUM(AD.IMPORTE_DEUDA)
                                FROM @TABLA_ASISTENCIAS AD
                                WHERE T.CLIENTE=AD.CLIENTE  
                                AND AD.CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
                                WHERE GRADUACION=''S'' AND TZ_LOCK=0)
    AND AD.JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
    WITH(NOLOCK) WHERE GRADUACION = ''S'' AND TZ_LOCK = 0)
    AND (AD.PRODUCTO IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''P'' 
    AND GRADUACION = ''S'' AND TZ_LOCK = 0))
    OR (AD.FAMILIA IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''F'' 
    AND GRADUACION = ''S'' AND TZ_LOCK = 0))),0) 
    FROM @TBL_AUX T
    
    UPDATE @TBL_AUX
    SET EXCLUSION_GAR_GRAD = ISNULL((SELECT SUM(AD.IMPORTE_DEUDA)
                                FROM @TABLA_ASISTENCIAS AD
                                WHERE T.CLIENTE=AD.CLIENTE  
                                AND AD.CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
                                WHERE GRADUACION=''S'' AND TZ_LOCK=0)
   AND AD.JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
   WITH(NOLOCK) WHERE GRADUACION = ''S'' AND TZ_LOCK = 0)
   AND (AD.PRODUCTO NOT IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''P'' 
   AND GRADUACION = ''S'' AND TZ_LOCK = 0))
   OR (AD.FAMILIA NOT IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) WHERE TIPO=''F'' 
   AND GRADUACION = ''S'' AND TZ_LOCK = 0)) AND TIPO_GARANTIA IN
   (SELECT TIPO_GARANTIA FROM CRE_EXCLUSIONES_TIPOSGARANTIAS WITH(NOLOCK) WHERE GRADUACION=''S'')),0) 
   FROM @TBL_AUX T
   
  
	UPDATE @TBL_AUX
    SET TOT_CONTROL_GRAD=T.DEUDA_TOTAL-(EXCLUSION_CLI_GRAD+EXCLUSION_ASIST_GRAD+EXCLUSION_PROD_GRAD+EXCLUSION_GAR_GRAD)
    FROM @TBL_AUX T


	UPDATE @TBL_AUX
    SET TRAMO_SIN_G=T.DEUDA_SIN_G-(EXCLUSION_CLI_F_SING+EXCLUSION_ASIST_F_SING+EXCLUSION_PROD_F_SING)
    FROM @TBL_AUX T


	UPDATE @TBL_AUX
    SET TRAMO_CON_G=T.DEUDA_CON_G-(EXCLUSION_CLI_F_CONG+EXCLUSION_ASIST_F_CONG+EXCLUSION_PROD_F_CONG+EXCLUSION_GAR_F_CONG)
    FROM @TBL_AUX T

---COMPARACIÓN CLIENTE X CLIENTE PARA VERIFICAR SI SUPERA LIMITE GRADUACION, FRACC CON GARANTIA Y SIN GARANTIA 
UPDATE @TBL_AUX
SET EXCEDIDO_GRAD = CASE WHEN @LIMITE_GRAD>=TOT_CONTROL_GRAD  THEN ''N'' ELSE ''S'' END;

UPDATE @TBL_AUX
SET EXCEDIDO_FRACC = CASE WHEN @TRAMO_SIN_G_B >= TRAMO_SIN_G AND @TRAMO_CON_G_B >= TRAMO_CON_G
                          THEN ''N'' ELSE ''S'' END;

--CUENTA SI LA CANTIDAD DE CLIENTES QUE EXCEDEN GRADUACIÓN/FRACCIONAMIENTO ES >=1

IF (SELECT COUNT(*) FROM @TBL_AUX WHERE EXCEDIDO_GRAD = ''S'')>= 1
    BEGIN
        SET @EXCEDE_GRADUACION = ''S'';
        SET @RESULTADO_GRADUACION = ''El cliente es parte de un grupo economico y como integrante, el CUIT '' +
        (SELECT TOP 1 NUMERODOC FROM VW_CLI_X_DOC WITH(NOLOCK) WHERE CODIGOCLIENTE IN (SELECT TOP 1 
        CLIENTE FROM @TBL_AUX WHERE EXCEDIDO_GRAD=''S'' ORDER BY CLIENTE)) + '', tiene exceso de graduación.''
    END
        ELSE
    
    BEGIN
        SET @EXCEDE_GRADUACION = ''N'';
        SET @RESULTADO_GRADUACION = NULL;
    END
    
IF (SELECT COUNT(*) FROM @TBL_AUX WHERE EXCEDIDO_FRACC = ''S'')>= 1
    BEGIN
        SET @EXCEDE_FRACCIONAMIENTO = ''S'';
        SET @RESULTADO_FRACCIONAMIENTO = ''El cliente es parte de un grupo economico y como integrante, el CUIT '' +
        (SELECT NUMERODOC FROM VW_CLI_X_DOC WITH(NOLOCK) WHERE CODIGOCLIENTE IN (SELECT TOP 1 
        CLIENTE FROM @TBL_AUX WHERE EXCEDIDO_FRACC=''S'' ORDER BY CLIENTE)) + '', tiene exceso de fraccionamiento.''
    END
        ELSE
    
    BEGIN
        SET @EXCEDE_FRACCIONAMIENTO = ''N'';
        SET @RESULTADO_GRADUACION =  NULL;
    END
       

END
     ---ANALISIS GRUPO EXCLUYENDO @CLIENTE
		
		--EXCLUSION CLIENTES GRUPO
		SET @EXCLUSION_CLI_GRUPO_G =(SELECT SUM(EXCLUSION_CLI_GRAD) FROM @TBL_AUX 
		                                      WHERE CLIENTE<>@CLIENTE )
	
		SET @EXCLUSION_CLI_GRUPO_F_CONG = (SELECT SUM(EXCLUSION_CLI_F_CONG) FROM @TBL_AUX
		                                           WHERE CLIENTE<>@CLIENTE)
	
		SET @EXCLUSION_CLI_GRUPO_F_SING = (SELECT SUM(EXCLUSION_CLI_F_SING) FROM @TBL_AUX
		                                           WHERE CLIENTE<>@CLIENTE)
		
		IF(@EXCLUSION_CLI_GRUPO_F_SING>@EXCLUSION_CLI_GRUPO_F_CONG)
			SET @EXCLUSION_CLI_GRUPO_F_SING = @EXCLUSION_CLI_GRUPO_F_SING-@EXCLUSION_CLI_GRUPO_F_CONG;
		ELSE 
			SET @EXCLUSION_CLI_GRUPO_F_SING = @EXCLUSION_CLI_GRUPO_F_CONG-@EXCLUSION_CLI_GRUPO_F_SING;
		
		
		--EXCLUSION ASISTENCIA GRUPO
		
		SET @EXCLUSION_ASIST_GRUPO_G = (SELECT SUM(EXCLUSION_ASIST_GRAD)FROM @TBL_AUX
		                                        WHERE CLIENTE<>@CLIENTE)
	
		SET @EXCLUSION_ASIST_GRUPO_F_CONG = (SELECT SUM(EXCLUSION_ASIST_F_CONG) FROM @TBL_AUX
		                                            WHERE CLIENTE<>@CLIENTE)
		
		SET @EXCLUSION_ASIST_GRUPO_F_SING = (SELECT SUM(EXCLUSION_ASIST_F_SING) FROM @TBL_AUX 
		                                            WHERE CLIENTE<>@CLIENTE)
		
		IF(@EXCLUSION_ASIST_GRUPO_F_SING>@EXCLUSION_ASIST_GRUPO_F_CONG)
			SET @EXCLUSION_ASIST_GRUPO_F_SING = @EXCLUSION_ASIST_GRUPO_F_SING-@EXCLUSION_ASIST_GRUPO_F_CONG;
		ELSE 
			SET @EXCLUSION_ASIST_GRUPO_F_SING = @EXCLUSION_ASIST_GRUPO_F_CONG-@EXCLUSION_ASIST_GRUPO_F_SING;
		 
		--EXCLUSION PRODUCTO GRUPO
		SET @EXCLUSION_PROD_GRUPO_G = (SELECT SUM(EXCLUSION_PROD_GRAD) FROM @TBL_AUX 
		                                      WHERE CLIENTE<>@CLIENTE)
	
		SET @EXCLUSION_PROD_GRUPO_F_CONG = (SELECT SUM(EXCLUSION_PROD_F_CONG) FROM @TBL_AUX
		                                           WHERE CLIENTE<>@CLIENTE) 
	
		SET @EXCLUSION_PROD_GRUPO_F_SING = (SELECT SUM(EXCLUSION_PROD_F_SING) FROM @TBL_AUX
		                                           WHERE CLIENTE<>@CLIENTE )  
		
		IF(@EXCLUSION_PROD_GRUPO_F_SING>@EXCLUSION_PROD_GRUPO_F_CONG)
			SET @EXCLUSION_PROD_GRUPO_F_SING = @EXCLUSION_PROD_GRUPO_F_SING-@EXCLUSION_PROD_GRUPO_F_CONG;
		ELSE 
			SET @EXCLUSION_PROD_GRUPO_F_SING = @EXCLUSION_PROD_GRUPO_F_CONG-@EXCLUSION_PROD_GRUPO_F_SING;
	   
	   --VARIABLES EXLUSIONES CLIENTE,ASISTENCIA Y PRODUCTO PARA EL GRUPO
	   	SET @EXC_GRUPO_CON_G=(@EXCLUSION_PROD_GRUPO_F_CONG+@EXCLUSION_ASIST_GRUPO_F_CONG+@EXCLUSION_CLI_GRUPO_F_CONG);
	   	
		SET @EXC_GRUPO_SIN_G=(@EXCLUSION_PROD_GRUPO_F_SING+@EXCLUSION_ASIST_GRUPO_F_SING+@EXCLUSION_CLI_GRUPO_F_SING);
	   
	   
	  --EXCLUSIONES GRUPO GRADUACION EN GENERAL
	  
		--EXCLUSIONES GRADUACIÓN CLIENTE +CLIENTE
		SET @EXCLUSION_GRUPOCLIENTE_G =(SELECT SUM(EXCLUSION_CLI_GRAD) FROM @TBL_AUX 
		                                      WHERE CLIENTE<>@CLIENTE ) 
		
		
		
		--EXCLUSIONES GRADUACION ASISTENCIAS+CLIENTE
		SET @EXCLUSION_GRUPOASIST_G =(SELECT SUM(EXCLUSION_ASIST_GRAD)FROM @TBL_AUX
		                                     WHERE CLIENTE<>@CLIENTE)
	    
	    --EXCLUSION GRADUACION PRODUCTO+GRUPO
	    SET @EXCLUSION_GRUPOPROD_G =(SELECT SUM(EXCLUSION_PROD_GRAD) FROM @TBL_AUX 
		                                      WHERE CLIENTE<>@CLIENTE)
		
		
		SET @EXCLUSIONES_GRUPALES_GRADUACION=(@EXCLUSION_GRUPOCLIENTE_G+@EXCLUSION_GRUPOASIST_G+@EXCLUSION_GRUPOPROD_G);
		
	  
---CALCULOS PARA GRUPO EN GENERAL
	IF(@EXCLUIDO=''N'')
		BEGIN 
		--
		--DEUDA TOTAL DEL GRUPO
		SET @TOTAL_DEUDA_GRUPO=(SELECT SUM(DEUDA_TOTAL) FROM @TBL_AUX) +@MONTO_SOLICITUD 
	  
		SET @IMPORTE_A_EVALUAR=@TOTAL_DEUDA_GRUPO-@EXCLUSIONES_GRUPALES_GRADUACION; 
	   
     END
       
	    
	 ELSE
	   BEGIN 
	   	SET @TOTAL_DEUDA_GRUPO=(SELECT SUM(DEUDA_TOTAL) FROM @TBL_AUX)
	  
	  
	    SET @TOTAL_DEUDA_GRUPO=@TOTAL_DEUDA_GRUPO
	    SET @IMPORTE_A_EVALUAR=@TOTAL_DEUDA_GRUPO-@EXCLUSIONES_GRUPALES_GRADUACION; 
	   
	 END 
	 
	 	SET @TOTAL_DEUDA_GRUPO_F=(SELECT SUM(DEUDA_TOTAL) FROM @TBL_AUX 
	 	                                 WHERE CLIENTE<>@CLIENTE)
	  
  --CALCULO IMPORTE CON G Y SIN G FRACCIONAMIENTO PARA EL GRUPO EN GENERAL
  --GRUPO CON GARANTIA
  SET @IMPORTE_CONG_GRUPO = (SELECT SUM(DEUDA_CON_G) FROM @TBL_AUX 
                                   WHERE CLIENTE<>@CLIENTE)-@EXC_GRUPO_CON_G
		
   --GRUPO SIN GARANTIA
   SET @IMPORTE_SING_GRUPO=(SELECT SUM(DEUDA_SIN_G) FROM @TBL_AUX WHERE CLIENTE<>@CLIENTE)-@EXC_GRUPO_SIN_G		
	  
 END
')

