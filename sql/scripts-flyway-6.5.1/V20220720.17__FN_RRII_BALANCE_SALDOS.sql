EXECUTE('
CREATE OR ALTER FUNCTION FN_RRII_BALANCE_SALDOS (@fch_proceso DATETIME) 
RETURNS TABLE 
AS 
RETURN
SELECT DISTINCT
	LEFT(CONVERT(VARCHAR,CBR.CODIGO_INTERNO) + REPLICATE(''0'',6), 6) AS CUENTA,	
	CASE 
		WHEN M.C6403=''N'' AND H.TIPO_CAMBIO_OFICIAL <> NULL  
			THEN ROUND(ROUND(SUM(CBR.SALDOFINMESMO),0) * H.TIPO_CAMBIO_OFICIAL,0)*-1
		ELSE ROUND(ROUND(SUM(CBR.SALDOFINMESMO),0) * (SELECT TOP 1 H.TIPO_CAMBIO_OFICIAL FROM HISTORICOTIPOSCAMBIO H WHERE H.FECHA_COTIZACION<=CBR.FECHA AND H.MONEDA=CBR.MONEDA),0)*-1 
	END IMPORTE,	
 	@fch_proceso AS FECHA  	
	FROM CO_BALANCE_RESULTADOS CBR WITH (NOLOCK)
	LEFT JOIN HISTORICOTIPOSCAMBIO H WITH (NOLOCK) ON CBR.MONEDA=H.MONEDA 
								AND CBR.FECHA=H.FECHA_COTIZACION	
	JOIN MONEDAS M WITH (NOLOCK) ON CBR.MONEDA = M.C6399
	WHERE CBR.ID_BCE = 2
	AND CBR.FECHA = @fch_proceso
	GROUP BY CBR.SALDOFINMESMO,
			CBR.CODIGO_INTERNO,
			CBR.MONEDA,
			CBR.FECHA,
			H.FECHA_COTIZACION,
			H.MONEDA, 
			H.TIPO_CAMBIO_OFICIAL, 
			M.C6403
;
')