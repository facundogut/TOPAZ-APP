EXECUTE('
CREATE OR ALTER          PROCEDURE [dbo].[SP_ITF_SOS_VINCULACION]
	@Fecha VARCHAR(8)
AS
BEGIN

--Limpiamos por si hay reproceso
DELETE FROM SOS_VINCULACION WHERE convert(VARCHAR,FECHADEINFORMACION) = @Fecha;

SELECT DISTINCT A.EMPRESA AS EMPRESA, 
	A.FECHADEINFORMACION, 
	A.CLASEDECUENTA, 
	A.NUMERODECUENTA, 
	A.TIPODECUENTAUOPERACION, 
	A.NUMERODEOPERACION,
	A.SUCURSALSISCEN,
	A.CUENTACLIENTE AS CODCLIENTE
  INTO #TMP_CLIENTE
FROM SOS_MOVS_HISTORICOS A
WHERE A.FECHADEINFORMACION = @Fecha

INSERT INTO SOS_VINCULACION
SELECT B.EMPRESA, 
	B.FECHADEINFORMACION, 
	B.CLASEDECUENTA, 
	B.NUMERODECUENTA, 
	B.TIPODECUENTAUOPERACION, 
	B.NUMERODEOPERACION,
	B.SUCURSALSISCEN,
	ISNULL((SELECT CONVERT(NUMERIC,ALFA_2) FROM ITF_MASTER_PARAMETROS
		WHERE FUNCIONALIDAD = ''SOSDOCIDENTIFICA''
		  AND ALFA_1 = ''N''
		  AND ALFA_3 = doc.TIPODOCUMENTO),0) AS IDENTTRIBUTARIATIPO, 
	CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS IDENTTRIBUTARIANUMERO,
	1 AS CONDICION,
	ROW_NUMBER() OVER (PARTITION BY B.CLASEDECUENTA, B.NUMERODECUENTA, B.TIPODECUENTAUOPERACION, 
	B.NUMERODEOPERACION, B.SUCURSALSISCEN, B.CODCLIENTE ORDER BY TITULARIDAD desc) AS ORDENRELACION,
	''00000000'' AS FECHAALTA
--SELECT B.*
FROM #TMP_CLIENTE B
  INNER JOIN CLI_ClientePersona D ON D.CODIGOCLIENTE = B.CODCLIENTE AND D.TZ_LOCK = 0
  INNER JOIN CLI_PERSONASFISICAS nat (NOLOCK) ON nat.NUMEROPERSONAFISICA = d.NUMEROPERSONA AND nat.SECTOR NOT IN (6,7)
  INNER JOIN CLI_DocumentosPFPJ doc (NOLOCK) ON doc.NUMEROPERSONAFJ = D.NUMEROPERSONA AND doc.TZ_LOCK = 0

INSERT INTO SOS_VINCULACION
SELECT B.EMPRESA, 
	B.FECHADEINFORMACION, 
	B.CLASEDECUENTA, 
	B.NUMERODECUENTA, 
	B.TIPODECUENTAUOPERACION, 
	B.NUMERODEOPERACION,
	B.SUCURSALSISCEN,
	ISNULL((SELECT CONVERT(NUMERIC,ALFA_2) FROM ITF_MASTER_PARAMETROS
		WHERE FUNCIONALIDAD = ''SOSDOCIDENTIFICA''
		  AND ALFA_1 = ''J''
		  AND ALFA_3 = doc.TIPODOCUMENTO),0) AS IDENTTRIBUTARIATIPO, 
	CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS IDENTTRIBUTARIANUMERO,
	1 AS CONDICION,
	1 AS ORDENRELACION,
	''00000000'' AS FECHAALTA
FROM #TMP_CLIENTE B
  INNER JOIN CLI_ClientePersona D ON D.CODIGOCLIENTE = B.CODCLIENTE AND D.TZ_LOCK = 0
  INNER JOIN CLI_PERSONASJURIDICAS jur (NOLOCK) ON jur.NUMEROPERSONAJURIDICA = d.NUMEROPERSONA AND jur.SECTOR NOT IN (6,7)
  INNER JOIN CLI_DocumentosPFPJ doc (NOLOCK) ON doc.NUMEROPERSONAFJ = D.NUMEROPERSONA AND doc.TZ_LOCK = 0
UNION ALL
SELECT B.EMPRESA, 
	B.FECHADEINFORMACION, 
	B.CLASEDECUENTA, 
	B.NUMERODECUENTA, 
	B.TIPODECUENTAUOPERACION, 
	B.NUMERODEOPERACION,
	B.SUCURSALSISCEN,
	ISNULL((SELECT CONVERT(NUMERIC,ALFA_2) FROM ITF_MASTER_PARAMETROS
		WHERE FUNCIONALIDAD = ''SOSDOCIDENTIFICA''
		  AND ALFA_1 = ''N''
		  AND ALFA_3 = doc.TIPODOCUMENTO),0) AS IDENTTRIBUTARIATIPO, 
	CONVERT(NUMERIC,doc.NUMERODOCUMENTO) AS IDENTTRIBUTARIANUMERO,
	3 AS CONDICION,
	1 AS ORDENRELACION,
	''00000000'' AS FECHAALTA
FROM #TMP_CLIENTE B
  INNER JOIN CLI_ClientePersona D ON D.CODIGOCLIENTE = B.CODCLIENTE AND D.TZ_LOCK = 0
  INNER JOIN CLI_PERSONASJURIDICAS jur (NOLOCK) ON jur.NUMEROPERSONAJURIDICA = d.NUMEROPERSONA AND jur.SECTOR NOT IN (6,7)
  INNER JOIN CLI_INTEGRANTESPJ I ON I.NUMEROPERSONAJURIDICA = D.NUMEROPERSONA AND I.TZ_LOCK = 0 AND I.CODIGOCARGO = ''REP''
  INNER JOIN CLI_DocumentosPFPJ doc (NOLOCK) ON doc.NUMEROPERSONAFJ = I.NUMEROPERSONAFISICA AND doc.TZ_LOCK = 0

END
')