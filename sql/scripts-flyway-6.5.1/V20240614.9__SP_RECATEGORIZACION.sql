EXECUTE('
ALTER PROCEDURE dbo.SP_RECATEGORIZACION
@p_id_proceso FLOAT(53),     /* Identificador de proceso */
@p_dt_proceso DATETIME,   /* Fecha de proceso */
@p_ret_proceso FLOAT OUT, /* Estado de ejecucion del PL/SQL(0:Correcto, 2: Error) */
@p_msg_proceso VARCHAR(MAX) OUT
AS
BEGIN
	DECLARE 
	------- Campos para el LOG --------
	@c_log_tipo_error varchar(30),
	@c_log_tipo_informacion VARCHAR(30),
	-----------------------------------
	@contador NUMERIC(10),
	@f_proceso DATE;
	
	DECLARE @TBL_AUX TABLE (CLIENTE NUMERIC(12), NROSOLICITUD NUMERIC(12), EXTRAORDINARIO_AUTORIZADO VARCHAR(1),
	NRO_AUTORIZACION NUMERIC(6), CATEGORIA VARCHAR(1), ID_LIMITE NUMERIC(12))
	
	SET @contador = 0;
	------- Campos para el LOG --------
	SET @c_log_tipo_error = ''E'';
	SET @c_log_tipo_informacion = ''I'';
	-----------------------------------	
	SET @f_proceso= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
	
	DELETE FROM CRE_RECATEGORIZACION_COMERCIAL_BITACORA WHERE FECHAPROCESO = @f_proceso;
	
	INSERT INTO @TBL_AUX	
	SELECT CSC.CLIENTE,CSC.NROSOLICITUD, 
	CSC.EXTRAORDINARIO_AUTORIZADO, 
	VS.NRO_AUTORIZACION,
	CASE WHEN CSC.EXTRAORDINARIO_AUTORIZADO=''S'' THEN VS.CATEGORIA_COMERCIAL
	ELSE CLC.CATEGORIA_COMERCIAL END AS CATEGORIA,
	CLC.IDLIMITE
	FROM CRE_SOLLICCLIENTE CSC WITH(NOLOCK)
	INNER JOIN CRE_LIMITECLIENTE CLC WITH(NOLOCK) ON CSC.CLIENTE = CLC.CLIENTE AND CSC.NROSOLICITUD = CLC.NRO_LIMITE_ANTERIOR
	LEFT JOIN VTA_SOBREGIROS VS WITH(NOLOCK) ON VS.FECHA_ALTA = @f_proceso AND VS.ESTADO=1 AND 
	VS.JTS_OID_SALDO IN (SELECT JTS_OID FROM SALDOS WITH(NOLOCK) WHERE C1803 = CLC.CLIENTE AND C1785 = 2) AND VS.TZ_LOCK = 0
	WHERE CSC.ESTADO=8 AND CSC.FECHA_SOLICITUD=@f_proceso AND CSC.EXTRAORDINARIO=''S'' AND CSC.TZ_LOCK = 0 AND CLC.TZ_LOCK = 0
	ORDER BY CSC.NROSOLICITUD, CSC.CLIENTE
	
	
	SET @contador = (SELECT COUNT(DISTINCT CLIENTE) FROM @TBL_AUX)
	
	--- Actualizo VTA_SOBREGIROS
	
	INSERT INTO CRE_RECATEGORIZACION_COMERCIAL_BITACORA 
	SELECT T.CLIENTE,
	CASE WHEN T.EXTRAORDINARIO_AUTORIZADO = ''S'' THEN ''ET'' ELSE ''AE'' END,
	''S'', --- Tipo sobregiro
	VS.NRO_AUTORIZACION,
	VS.CATEGORIA_COMERCIAL,
	T.CATEGORIA,
	@f_proceso
	FROM @TBL_AUX T
	INNER JOIN VTA_SOBREGIROS VS WITH(NOLOCK) ON VS.JTS_OID_SALDO IN (SELECT JTS_OID FROM SALDOS WITH(NOLOCK)
	WHERE C1803 = T.CLIENTE)
	AND VS.FECHA_VENCIMIENTO >= @f_proceso

	
	UPDATE VTA_SOBREGIROS
	SET CATEGORIA_COMERCIAL = T.CATEGORIA
	FROM VTA_SOBREGIROS VS
	INNER JOIN @TBL_AUX T ON T.CLIENTE IN (SELECT C1803 FROM SALDOS WITH(NOLOCK)
	WHERE JTS_OID = VS.JTS_OID_SALDO)
	WHERE T.EXTRAORDINARIO_AUTORIZADO = ''N''
	AND VS.FECHA_VENCIMIENTO >= @f_proceso
	
	--- Actualizo CRE_SALDOS
	
	INSERT INTO CRE_RECATEGORIZACION_COMERCIAL_BITACORA 
	SELECT T.CLIENTE,
	CASE WHEN T.EXTRAORDINARIO_AUTORIZADO = ''S'' THEN ''ET'' ELSE ''AE'' END,
	''A'', --- Tipo Asistencia
	CR.SALDOS_JTS_OID,
	CR.CATEGORIA_COMERCIAL,
	T.CATEGORIA,
	@f_proceso
	FROM @TBL_AUX T
	INNER JOIN CRE_SALDOS CR WITH(NOLOCK) ON CR.SALDOS_JTS_OID IN (SELECT JTS_OID FROM SALDOS WITH(NOLOCK)
	WHERE C1803 = T.CLIENTE) 
	INNER JOIN VW_ASISTENCIAS_DEUDA D WITH(NOLOCK) ON CR.SALDOS_JTS_OID = D.JTS_OID
	WHERE D.SALDO_DEUDA <> 0 
	
	UPDATE CRE_SALDOS
	SET CATEGORIA_COMERCIAL = T.CATEGORIA
	FROM CRE_SALDOS CS
	INNER JOIN @TBL_AUX T ON T.CLIENTE IN (SELECT C1803 FROM SALDOS WITH(NOLOCK)
	WHERE JTS_OID = CS.SALDOS_JTS_OID)
	INNER JOIN VW_ASISTENCIAS_DEUDA D WITH(NOLOCK) ON CS.SALDOS_JTS_OID = D.JTS_OID
	WHERE D.SALDO_DEUDA <> 0
	
	SET @p_msg_proceso = ''El Proceso de recategorizacion ha finalizado correctamente. Registros procesados: ''+ CONVERT(VARCHAR(10), @contador)
	SET @p_ret_proceso = 1 		
			
	-- Logueo de información
	EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
	@p_id_proceso,
	@p_dt_proceso,
	''SP_RECATEGORIZACION'',
	@p_cod_error = @p_ret_proceso, 
	@p_msg_error = @p_msg_proceso, 
    @p_tipo_error = @c_log_tipo_informacion
	
	
END
')
