EXECUTE('
IF OBJECT_ID (''dbo.VBS_ESTADO_CUENTA_CLIENTE'') IS NOT NULL
	DROP VIEW dbo.VBS_ESTADO_CUENTA_CLIENTE
')

EXECUTE('
CREATE VIEW dbo.VBS_ESTADO_CUENTA_CLIENTE
AS
SELECT DISTINCT 
    PP.SALDO_JTS_OID,
	PP.C2300 AS NCUOTA,
	-- Si la fecha de vencimiento del plan de pagos es mayor a la del plan de pagos original mostramos esta porque tuvo un evento de
	-- cambio de vencimiento, caso contrario evaluamos mostrar la del orginal sino tuvo eventos o la del plan de pagos actual si
	-- tuvo algun evento de adelanto de cuotas
	CASE WHEN PP.C2302 > PPO.FECHA_FIN THEN PP.C2302 ELSE
	CASE WHEN PPO.FECHA_FIN IS NULL THEN PP.C2302 ELSE PPO.FECHA_FIN END
	END  AS VENCIMIENTOCUOTA,	
	CASE WHEN PPO.CAPITAL IS NULL THEN pp.C2309 ELSE ISNULL(PPO.CAPITAL,0) END AS CAPITAL,
	ISNULL(PP.C2305,0) AS INTERES, 
	DATEDIFF ( dd , PP.C2301 , PP.C2302 ) AS DIASCUOTA,
	/*DATEDIFF( dd , PP.C2301 , (SELECT FECHAPROCESO FROM PARAMETROS) ) DIASDEVENGADO,
	CASE WHEN PP.C2302 <= (SELECT FECHAPROCESO FROM PARAMETROS) AND PP.C2305>0 THEN PP.C2305
	     WHEN (SELECT FECHAPROCESO FROM PARAMETROS) BETWEEN PP.C2301 AND PP.C2302 AND PP.C2305 > 0 THEN ROUND((PP.C2305 / DATEDIFF( dd , PP.C2301 , PP.C2302 ))  ,2) * DATEDIFF( dd , PP.C2301 , (SELECT FECHAPROCESO FROM PARAMETROS) ) 
	     ELSE 0
	END AS INTERESDEVENGADO,*/
	PP.C2309 AS SALDO_CAPITAL,
	PP.C2310 AS SALDO_INTERES,  	 
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE PP.IVAINTERES 
	END  AS PP_IVAINTERES,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE PP.IVAPERCEPCIONINTERES 
	END AS PP_IVAPERCEPCIONINTERES,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE PP.C2311
	END AS PP_MORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE PP.IVAMORA 
	END AS PP_IVAMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE PP.IVAPERCEPCIONMORA 
    END AS PP_IVAPERCEPCIONMORA,
    CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE PP.ICMORA_DEV
	END AS PP_INTCOMPMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE PP.IVAINTCOMPMORA 
	END AS PP_IVAINTCOMPMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE PP.IVAPERCEPCIONINTCOMPMORA 
	END AS PP_IVAPERCEPCIONINTCOMPMORA,	
    PP.DIAS_ATRASO_CANCELACION  AS DIASATRASO,
    CASE WHEN ((PP.C2309+PP.C2310) <> (PP.C2304+PP.C2305)) OR PP.TZ_LOCK <> 0  THEN PP.C2313 END AS FECHAVALOR,  
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 ELSE
		  isnull((SELECT sum(SALDO_GASTO) FROM GASTOS_POR_CUOTA WITH (NOLOCK) WHERE SALDOS_JTS_OID=PP.SALDO_JTS_OID AND NUMERO_CUOTA=PP.C2300 AND TZ_LOCK=0),0)	 		  
	END AS PP_GASTOS,
	CASE 
 		 WHEN (PP.C2309+PP.C2310) <> (PP.C2304+PP.C2305) AND (PP.C2309+PP.C2310) >0
			THEN ''Pago Parcial''
		 WHEN PP.TZ_LOCK <> 0 THEN ''Pago Adelantada'' 
		 WHEN (PP.C2309+PP.C2310) = 0 THEN ''Pago''	
		 ELSE ''Pendiente'' 
	END AS PAGOPARCIAL	
FROM PLANPAGOS PP WITH (NOLOCK) 
LEFT JOIN PLANPAGOS_ORIGINAL PPO WITH (NOLOCK)
	ON PPO.SALDO_JTS_OID=PP.SALDO_JTS_OID AND PPO.NUMERO_CUOTA=PP.C2300 AND PPO.TZ_LOCK=0
INNER JOIN SALDOS S WITH (NOLOCK) 
	ON PP.SALDO_JTS_OID=S.JTS_OID AND S.TZ_LOCK=0
INNER JOIN PRODUCTOS pr WITH (NOLOCK) ON pr.C6250=s.PRODUCTO AND pr.TZ_LOCK=0
')

