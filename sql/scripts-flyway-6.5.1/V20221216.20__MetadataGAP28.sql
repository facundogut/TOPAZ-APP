EXECUTE('
IF OBJECT_ID (''dbo.VW_RRII_ANEXO_12_RENGLON6Y7'') IS NOT NULL
	DROP VIEW dbo.VW_RRII_ANEXO_12_RENGLON6Y7
')
EXECUTE('
CREATE   VIEW [dbo].[VW_RRII_ANEXO_12_RENGLON6Y7] 
AS

SELECT 
	
	CP.NUMEROPERSONA AS PERSONAS,
	
	G.FECHA AS FECHA,
	
	G.SALDOS_JTS_OID AS JTS_OID,
	
	S.C1785 AS Producto,
	
	CP.CODIGOCLIENTE AS CLIENTE,
								
	(SELECT NUM1 FROM RRI_PARAMETROS_INF WHERE CODIGO=1 AND ID1 = G.MONEDA) AS MONEDA,

	ISNULL (DBO.convertirAMonNac((((SELECT TOP 1 SALDO_AJUSTADO 
				FROM GRL_SALDOS_DIARIOS WITH (NOLOCK)
				WHERE SALDOS_JTS_OID = G.SALDOS_JTS_OID 
				AND MONEDA = G.MONEDA
				AND FECHA = G.FECHA
				AND TZ_LOCK = G.TZ_LOCK)/
	   		(SELECT COUNT(NUMEROPERSONA) 
	   		FROM CLI_ClientePersona WITH (NOLOCK)
	   		WHERE CODIGOCLIENTE = CP.CODIGOCLIENTE 
	   		AND TZ_LOCK = CP.TZ_LOCK))),G.MONEDA,G.FECHA),0) AS MONTODEPOSITO

FROM CLI_ClientePersona CP

	INNER JOIN SALDOS S WITH (NOLOCK)
		ON CP.CODIGOCLIENTE = S.C1803
		AND CP.TZ_LOCK = S.TZ_LOCK

		INNER JOIN GRL_SALDOS_DIARIOS G WITH (NOLOCK)
		ON G.SALDOS_JTS_OID = S.JTS_OID
		AND G.MONEDA = S.MONEDA
		AND G.TZ_LOCK = S.TZ_LOCK
		
WHERE S.C1785 = 4
	AND S.TZ_LOCK = 0
	AND G.TZ_LOCK = 0
    AND G.SALDO_AJUSTADO!=0

GROUP BY
	S.C1785,
	G.FECHA,
	G.MONEDA,
	G.SALDOS_JTS_OID,
	G.TZ_LOCK,
	CP.CODIGOCLIENTE,
	CP.TZ_LOCK,
	CP.NUMEROPERSONA
	
UNION ALL
SELECT

	CP.NUMEROPERSONA AS PERSONAS,
	
	CONVERT(DATETIME,G.FECHA,103) AS FECHA,
	
	G.SALDOS_JTS_OID AS JTS_OID,
	
	S.C1785 AS Producto,
	
	CP.CODIGOCLIENTE AS CLIENTE,
											
	(SELECT NUM1 FROM RRI_PARAMETROS_INF WHERE CODIGO=1 AND ID1 = G.MONEDA) AS MONEDA,
	
	ISNULL (DBO.convertirAMonNac((((SELECT TOP 1 SALDO_AJUSTADO 
				FROM GRL_SALDOS_DIARIOS WITH (NOLOCK)
				WHERE SALDOS_JTS_OID = G.SALDOS_JTS_OID 
				AND MONEDA = G.MONEDA
				AND FECHA = G.FECHA
				AND TZ_LOCK = G.TZ_LOCK)/
	   		(SELECT COUNT(NUMEROPERSONA) 
	   		FROM CLI_ClientePersona WITH (NOLOCK)
	   		WHERE CODIGOCLIENTE = CP.CODIGOCLIENTE 
	   		AND TZ_LOCK = CP.TZ_LOCK))),G.MONEDA,G.FECHA),0) AS MONTODEPOSITO

    FROM GRL_SALDOS_DIARIOS G WITH (NOLOCK)
		
    INNER JOIN SALDOS S WITH (NOLOCK)
        ON G.MONEDA = S.MONEDA
        AND G.SALDOS_JTS_OID = S.JTS_OID
        AND G.TZ_LOCK = S.TZ_LOCK
        
    INNER JOIN CLI_ClientePersona CP WITH(NOLOCK) ON
		CP.CODIGOCLIENTE=S.C1803 AND
		CP.TZ_LOCK = G.TZ_LOCK
    
    WHERE 
	G.TZ_LOCK = 0 AND 
	S.C1785 IN (2,3) AND 
	G.SALDO_AJUSTADO!=0

	
GROUP BY 
	G.MONEDA,
	CP.CODIGOCLIENTE,
	G.FECHA,
	G.SALDOS_JTS_OID,
	S.C1785,
	CP.NUMEROPERSONA,
	G.TZ_LOCK,
	CP.TZ_LOCK
')