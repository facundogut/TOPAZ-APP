EXECUTE('
CREATE OR ALTER PROCEDURE SP_ASOCI_INTE_JUZG
   @P_NUM_JUZG  float(12),
   @P_NUM_SOLIC float(12),
   @P_NUM_PER float(12),
   @P_ASIENTO float(10),
   @P_OPERACION VARCHAR(4),
   @P_USUARIO VARCHAR(10),
   @P_HORA VARCHAR(8),
   @P_FECHA_VENCIMIENTO DATE,
   
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
      
AS 

   BEGIN

      SET @P_RET_PROCESO = NULL
      SET @P_MSG_PROCESO = NULL
      
      DECLARE

         @FECHA DATETIME,
         @FECHA_ANTERIOR DATETIME,
         @CANT NUMERIC(5),
         @row_number NUMERIC(6),
         @v_constante VARCHAR(1),
         @v_numerador NUMERIC,
         @v_correlativo NUMERIC(10),
         
         --DECLARO VARIABLES TEMPORALES PARA RECORER TABLA AUXILIAR--
		 @NRO_SOLICITUDTemp NUMERIC (12, 0),
   		 @ID_PERSONATemp NUMERIC (12, 0),
   		 @NRO_JUZGADOTemp  NUMERIC (12, 0), 
   		 @JTS_OID_CUENTATemp NUMERIC (10, 0),
   		 @NRO_CAUSATemp NUMERIC (12, 0),
      	 @ACTORTemp VARCHAR(3),
      	 @FECHA_INTEGRACIONTemp DATETIME,
      	 @FECHA_CESETemp DATETIME,
      	 @ACTIVOTemp VARCHAR(1),
      	 @ESTADOTemp VARCHAR(1),
      	 @FECHA_ESTADOTemp DATETIME,
      	 @SUCURSALTemp NUMERIC (5, 0),
      	 @TIPO_ENTIDADTemp NUMERIC (5, 0),
   		 @TIPO_PODERTemp NUMERIC (5, 0)
      	 
      	 
      --SET @CANT = 0
      SELECT @FECHA = FECHAPROCESO FROM PARAMETROS
      SELECT @FECHA_ANTERIOR = FECHAPROCESOANTERIOR FROM PARAMETROS
      
      --DECLARO TABLA AUXILIAR--
	  DECLARE @Tabla_ASOCI_INTE_JUZG TABLE(
		NRO_SOLICITUD NUMERIC (12, 0), 
      	ID_PERSONA NUMERIC (12, 0), 
      	NRO_JUZGADO NUMERIC (12, 0), 
      	JTS_OID_CUENTA NUMERIC (10, 0),
      	NRO_CAUSA NUMERIC (12, 0),
      	ACTOR VARCHAR(3),
      	FECHA_INTEGRACION DATETIME,
      	FECHA_CESE DATETIME,
      	ACTIVO VARCHAR(1),
      	ESTADO VARCHAR(1),
      	FECHA_ESTADO DATETIME,
      	SUCURSAL NUMERIC (5, 0),
      	TIPO_ENTIDAD NUMERIC (5, 0), 
      	TIPO_PODER NUMERIC (5, 0),
      	FILAS BIGINT,
      	ESTADO_DJ_CAUSA VARCHAR(1)
	  )
	  
	  --DECLARO TABLA AUXILIAR DE REGISTROS EXISTENTES EN PYF_APODERADOS--
	  DECLARE @Tabla_PYF_APODERADOS TABLE(
	  	ID_ENTIDAD NUMERIC (10, 0),
	  	TIPO_ENTIDAD NUMERIC (5, 0),
	  	TIPO_PODER NUMERIC (5, 0),
      	ID_PERSONA NUMERIC (12, 0)
	  )
	  
	  --DECLARO TABLA AUXILIAR DE REGISTROS EXISTENTES EN PYF_APODERADOS--
	  DECLARE @Tabla_DJ_INTEGRANTES_CAUSAS TABLE(
	  	NRO_CAUSA NUMERIC (12, 0),
      	ID_PERSONA NUMERIC (12, 0)
	  )
	  
	  --DECLARO TABLA AUXILIAR DE REGISTROS EXISTENTES EN PYF_APODERADOS--
	  DECLARE @Tabla_DJ_INTEGRANTES_JUZGADOS TABLE(
	  	NRO_JUZGADO NUMERIC (12, 0),
      	ID_PERSONA NUMERIC (12, 0)
	  )
	  
	 
	 
      --COMPLETO TABLA AUXILIAR--
	  INSERT INTO 
		@Tabla_ASOCI_INTE_JUZG
      SELECT s.NRO_SOLICITUD, 
      	     s.ID_PERSONA, 
      	     s.NRO_JUZGADO, 
      	     cc.JTS_OID_CUENTA,
      	     cc.NRO_CAUSA,
      	     s.ACTOR,
      	     s.FECHA_INTEGRACION,
      	     s.FECHA_CESE,
      	     s.ACTIVO,
      	     s.ESTADO,
      	     s.FECHA_ESTADO,
      	     s.SUCURSAL,
      	     tt.TIPO_ENTIDAD,
      	     tt.TIPO_PODER,
      	     row_number() OVER(ORDER BY s.NRO_SOLICITUD) AS filas,
      	     c.ESTADO
	  FROM DJ_SOLICITUD_AD_INTEG_JUZ s WITH (NOLOCK)
	  INNER JOIN DJ_CAUSAS c WITH (NOLOCK) ON c.JUZGADO=s.NRO_JUZGADO 
	  	AND c.TZ_LOCK = 0
	  INNER JOIN DJ_CAUSA_CUENTA cc WITH (NOLOCK) ON c.NRO_CAUSA=cc.NRO_CAUSA
	  	AND (cc.TZ_LOCK < 300000000000000 OR cc.TZ_LOCK >= 400000000000000)
	  ,PYF_TIPOPODER_X_TIPOENTIDAD tt WITH (NOLOCK)
	  WHERE s.NRO_JUZGADO  = @P_NUM_JUZG
	  	AND s.NRO_SOLICITUD = @P_NUM_SOLIC
	  	AND s.ID_PERSONA = @P_NUM_PER
	  	AND s.TZ_LOCK = 0
		AND s.ESTADO = ''I''  
		AND c.ESTADO NOT IN (''T'')
		AND cc.JTS_OID_CUENTA NOT IN (SELECT b.JTS_OID_CUENTA FROM DJ_BENEFICIARIOS b WHERE (b.TZ_LOCK < 300000000000000 OR b.TZ_LOCK >= 400000000000000))
		AND tt.TIPO_ENTIDAD = 2 AND tt.TZ_LOCK = 0
      
      
     --COMPLETO TABLA AUXILIAR DE REGISTROS EXISTENTES EN DJ_INTEGRANTES_CAUSAS --
	 INSERT INTO 
		@Tabla_DJ_INTEGRANTES_CAUSAS 
	 SELECT DJ.NRO_CAUSA,
	 		DJ.ID_PERSONA 
	 FROM DJ_INTEGRANTES_CAUSAS  DJ WITH (NOLOCK) 
	 INNER JOIN @Tabla_ASOCI_INTE_JUZG TA 
	 	ON TA.NRO_CAUSA = DJ.NRO_CAUSA
		AND TA.ID_PERSONA = DJ.ID_PERSONA
		
		
	--COMPLETO TABLA AUXILIAR DE REGISTROS EXISTENTES EN DJ_INTEGRANTES_JUZGADOS --
	 INSERT INTO 
		@Tabla_DJ_INTEGRANTES_JUZGADOS  
	 SELECT DJ.NRO_JUZGADO,
	 		DJ.ID_PERSONA 
	 FROM DJ_INTEGRANTES_JUZGADOS  DJ WITH (NOLOCK) 
	 INNER JOIN @Tabla_ASOCI_INTE_JUZG TA 
	 	ON TA.NRO_JUZGADO = DJ.NRO_JUZGADO
		AND TA.ID_PERSONA = DJ.ID_PERSONA

	
	--COMPLETO TABLA AUXILIAR DE REGISTROS EXISTENTES EN PYF_APODERADOS--
	 INSERT INTO 
		@Tabla_PYF_APODERADOS
	 SELECT pa.ID_ENTIDAD, 
	 		pa.TIPO_PODER, 
	 		pa.TIPO_ENTIDAD, 
	 		pa.ID_PERSONA 
	 FROM PYF_APODERADOS PA WITH (NOLOCK) 
	 INNER JOIN @Tabla_ASOCI_INTE_JUZG TA 
	 	ON TA.JTS_OID_CUENTA = TRY_CAST(PA.ID_ENTIDAD AS DECIMAL(10,0))
		AND TA.TIPO_PODER = PA.TIPO_PODER
		AND TA.TIPO_ENTIDAD = PA.TIPO_ENTIDAD
		AND TA.ID_PERSONA = PA.ID_PERSONA
      
    
      BEGIN TRANSACTION	
      
       BEGIN TRY
	       	  	
				/*SE DAN DE ALTA LOS PODERES ACTIVOS*/
	      		INSERT INTO PYF_APODERADOS
				SELECT 
					0,
					TA.JTS_OID_CUENTA,--@JTS_OID_CUENTATemp,
					TA.TIPO_PODER,--@TIPO_PODERTemp,
					TA.TIPO_ENTIDAD,--@TIPO_ENTIDADTemp,
					TA.ID_PERSONA,--@ID_PERSONATemp,
					'''',
					1,
					0,
					1,
					0,
					@P_FECHA_VENCIMIENTO,
					@FECHA,
					NULL,
					NULL,
					NULL,
					''''
				FROM @Tabla_ASOCI_INTE_JUZG  AS TA
				WHERE TA.ESTADO_DJ_CAUSA = ''A''
				AND TA.JTS_OID_CUENTA NOT IN (SELECT TRY_CAST(PA.ID_ENTIDAD AS DECIMAL(10,0)) FROM @Tabla_PYF_APODERADOS AS PA)
				AND TA.TIPO_PODER NOT IN (SELECT PA.TIPO_PODER FROM @Tabla_PYF_APODERADOS AS PA)
				AND TA.TIPO_ENTIDAD NOT IN (SELECT PA.TIPO_ENTIDAD FROM @Tabla_PYF_APODERADOS AS PA)
				AND TA.ID_PERSONA NOT IN (SELECT PA.ID_PERSONA FROM @Tabla_PYF_APODERADOS AS PA)
				
				
				/*SE DAN DE ALTA LOS PODERES INACTIVOS*/
	      		INSERT INTO PYF_APODERADOS
				SELECT 
					0,
					TA.JTS_OID_CUENTA,--@JTS_OID_CUENTATemp,
					TA.TIPO_PODER,--@TIPO_PODERTemp,
					TA.TIPO_ENTIDAD,--@TIPO_ENTIDADTemp,
					TA.ID_PERSONA,--@ID_PERSONATemp,
					'''',
					1,
					0,
					1,
					0,
					@FECHA_ANTERIOR,
					@FECHA,
					@P_FECHA_VENCIMIENTO,
					NULL,
					NULL,
					TA.JTS_OID_CUENTA
				FROM @Tabla_ASOCI_INTE_JUZG  AS TA
				WHERE TA.ESTADO_DJ_CAUSA = ''I''
				AND TA.JTS_OID_CUENTA NOT IN (SELECT TRY_CAST(PA.ID_ENTIDAD AS DECIMAL(10,0)) FROM @Tabla_PYF_APODERADOS AS PA)
				AND TA.TIPO_PODER NOT IN (SELECT PA.TIPO_PODER FROM @Tabla_PYF_APODERADOS AS PA)
				AND TA.TIPO_ENTIDAD NOT IN (SELECT PA.TIPO_ENTIDAD FROM @Tabla_PYF_APODERADOS AS PA)
				AND TA.ID_PERSONA NOT IN (SELECT PA.ID_PERSONA FROM @Tabla_PYF_APODERADOS AS PA)
				
				
				/*SE ACTUALIZAN PODERES EXISTENTES*/
				UPDATE PA
				SET 
					PA.FECHA_VENCIMIENTO = @P_FECHA_VENCIMIENTO,
					PA.FECHA_INI_SUSPENSION = NULL, --@P_FECHA_VENCIMIENTO,
					PA.FECHA_INI_VIGENCIA = @FECHA, --@FECHA,
					PA.ID_CLIENTE_SALDO = 0
				FROM
					PYF_APODERADOS AS PA WITH (NOLOCK)
				INNER JOIN @Tabla_PYF_APODERADOS AS T ON
					PA.ID_PERSONA = T.ID_PERSONA
					AND PA.TIPO_ENTIDAD = T.TIPO_ENTIDAD 
					AND TRY_CAST(PA.ID_ENTIDAD AS DECIMAL(10,0)) = TRY_CAST(T.ID_ENTIDAD AS DECIMAL(10,0))
					AND PA.TIPO_PODER = T.TIPO_PODER
				
			 	
				/*SE DA DE ALTA LA BITACORA PODERES ACTIVOS*/
				INSERT INTO BITACORA_APODERADOS 
				SELECT 
					@FECHA,
					TA.SUCURSAL,--@SUCURSALTemp,
					@P_ASIENTO,
					TA.FILAS,
					''A'',
					@P_OPERACION,
					@P_USUARIO,
					@P_HORA,
					TA.JTS_OID_CUENTA,--@JTS_OID_CUENTATemp,
					TA.TIPO_ENTIDAD,--@TIPO_ENTIDADTemp,
					TA.TIPO_PODER,--@TIPO_PODERTemp,
					TA.ID_PERSONA,--@ID_PERSONATemp,
					'''',
					1,
					0,
					1,
					0,
					@P_FECHA_VENCIMIENTO,
					@FECHA,
					NULL,
					NULL,
					0,
					0
				FROM @Tabla_ASOCI_INTE_JUZG AS TA
				WHERE TA.ESTADO_DJ_CAUSA = ''A''
				
				
				/*SE DA DE ALTA LA BITACORA PODERES INACTIVO*/
				INSERT INTO BITACORA_APODERADOS 
				SELECT 
					@FECHA,
					TA.SUCURSAL,--@SUCURSALTemp,
					@P_ASIENTO,
					TA.FILAS,
					''A'',
					@P_OPERACION,
					@P_USUARIO,
					@P_HORA,
					TA.JTS_OID_CUENTA,--@JTS_OID_CUENTATemp,
					TA.TIPO_ENTIDAD,--@TIPO_ENTIDADTemp,
					TA.TIPO_PODER,--@TIPO_PODERTemp,
					TA.ID_PERSONA,--@ID_PERSONATemp,
					'''',
					1,
					0,
					1,
					0,
					@FECHA_ANTERIOR,
					@FECHA,
					@P_FECHA_VENCIMIENTO,
					NULL,
					0,
					TA.JTS_OID_CUENTA
				FROM @Tabla_ASOCI_INTE_JUZG AS TA
				WHERE TA.ESTADO_DJ_CAUSA = ''I''
				
			
					/*SE DA DE ALTA CAUSAS DEL INTEGRANTE*/
					INSERT INTO DJ_INTEGRANTES_CAUSAS
					SELECT
						c.NRO_CAUSA,
						s.ACTOR,
						s.ID_PERSONA,
						@FECHA,
						NULL,
						0,
						''S''
					FROM DJ_SOLICITUD_AD_INTEG_JUZ s WITH (NOLOCK)
					INNER JOIN DJ_CAUSAS c WITH (NOLOCK) ON c.JUZGADO=s.NRO_JUZGADO 
						AND c.TZ_LOCK = 0
					WHERE s.NRO_JUZGADO = @P_NUM_JUZG
	  				AND s.NRO_SOLICITUD = @P_NUM_SOLIC
	  			    AND s.ID_PERSONA = @P_NUM_PER
	  			    AND c.NRO_CAUSA NOT IN (SELECT DJ.NRO_CAUSA FROM @Tabla_DJ_INTEGRANTES_CAUSAS AS DJ)
					AND s.ID_PERSONA NOT IN (SELECT DJ.ID_PERSONA FROM @Tabla_DJ_INTEGRANTES_CAUSAS AS DJ)
	  			    
	  			    
	  			/*SE ACTUALIZAN CAUSAS DEL INTEGRANTE*/
				UPDATE P
				SET 
					P.FECHA_INTEGRACION = @FECHA,
					P.ACTIVO = ''S'',
					P.FECHA_CESE = NULL
				FROM DJ_INTEGRANTES_CAUSAS AS P WITH (NOLOCK)
				INNER JOIN @Tabla_DJ_INTEGRANTES_CAUSAS AS T ON
			    P.NRO_CAUSA = T.NRO_CAUSA
			    AND P.ID_PERSONA = T.ID_PERSONA
			    
			    
			    /*SE DA DE ALTA EL INTEGRANTE EN EL JUZGADO*/
					INSERT INTO DJ_INTEGRANTES_JUZGADOS
					SELECT
						s.NRO_JUZGADO,
						s.ACTOR,
						s.ID_PERSONA,
						@FECHA,
						NULL,
						''S'',
						0
					FROM DJ_SOLICITUD_AD_INTEG_JUZ s WITH (NOLOCK)
					INNER JOIN DJ_CAUSAS c WITH (NOLOCK) ON c.JUZGADO=s.NRO_JUZGADO 
						AND c.TZ_LOCK = 0
					WHERE s.NRO_JUZGADO = @P_NUM_JUZG
	  				AND s.NRO_SOLICITUD = @P_NUM_SOLIC
	  			    AND s.ID_PERSONA = @P_NUM_PER
	  			    AND s.NRO_JUZGADO NOT IN (SELECT DJ.NRO_JUZGADO FROM @Tabla_DJ_INTEGRANTES_JUZGADOS AS DJ)
					AND s.ID_PERSONA NOT IN (SELECT DJ.ID_PERSONA FROM @Tabla_DJ_INTEGRANTES_JUZGADOS AS DJ)
			    
			    
			    /*SE ACTUALIZA EL INTEGRANTE EN EL JUZGADO*/
				UPDATE P
				SET 
					P.FECHA_INTEGRACION = @FECHA,
					P.ACTIVO = ''S'',
					P.FECHA_CESE = NULL
				FROM DJ_INTEGRANTES_JUZGADOS AS P WITH (NOLOCK)
				INNER JOIN @Tabla_DJ_INTEGRANTES_JUZGADOS AS T ON
			    P.NRO_JUZGADO = T.NRO_JUZGADO 
			    AND P.ID_PERSONA = T.ID_PERSONA
	  					
   
			COMMIT TRANSACTION;
			
			SET @P_RET_PROCESO = 1
		    SET @P_MSG_PROCESO = ''Se asocio nuevo integrante correctamente.''
			 
		END TRY     
		
		BEGIN CATCH
			ROLLBACK TRANSACTION
			SET @P_RET_PROCESO = ERROR_NUMBER()
			SET @P_MSG_PROCESO = ERROR_MESSAGE()
			EXECUTE dbo.pkg_constantes$VarcharConstantes ''C_LOG_TIPO_ERROR'', @v_constante OUTPUT;
		END CATCH
		 	      
 END
')