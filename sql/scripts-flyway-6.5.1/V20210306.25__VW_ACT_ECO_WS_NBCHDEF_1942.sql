
EXECUTE('
ALTER VIEW [dbo].[VW_ACT_ECO_WS] AS
SELECT 
		X.ORDEN_AFIP AS ''ORDEN_AFIP'', 
		X.ORDINAL AS ''ORDINAL'',       
		X.COD_ACTIVIDAD,
		DESCRIPCION AS ''DESCRIPCION'',
		PERIODO_ACTIVIDAD AS ''PERIODO_ACTIVIDAD'',
		TIPO_ACTIVIDAD AS ''TIPO_ACTIVIDAD'',
		VERIFICADO_AFIP AS ''VERIFICADO_AFIP'',
		FECHA_VERIFICADO AS ''FECHA_VERIFICADO'',
		CODIGO_PERSONA AS ''CODIGO_PERSONA'',
		TIPO_DOCUMENTO AS ''TIPO_DOCUMENTO'',
		X.NUMERO_DOCUMENTO AS ''NUMERO_DOCUMENTO'',
		J.REGISTRO_POR AS ''REGISTRO_POR'',
		ESTADO
FROM
		(     

		SELECT 
				i.COD_ACTIVIDAD,
				a.DESCRIPCION,
				(RIGHT(i.PERIODO,2)+LEFT(i.PERIODO,4)) AS PERIODO_ACTIVIDAD,
				(CASE i.ORDEN
							WHEN 1 THEN ''Primaria''
							ELSE ''Secundaria''
							END) AS TIPO_ACTIVIDAD,
				''S'' AS VERIFICADO_AFIP,
				(SELECT FECHAPROCESO 
				 FROM PARAMETROS) AS FECHA_VERIFICADO,
				d.NUMEROPERSONAFJ AS CODIGO_PERSONA,
				d.TIPODOCUMENTO AS TIPO_DOCUMENTO,
				i.CUIL AS NUMERO_DOCUMENTO,
				CASE 
					WHEN e.ORDINAL_ACTIVIDAD IS NULL THEN 99 
					ELSE e.ORDINAL_ACTIVIDAD
					END AS ORDINAL,
				''2_AFIP'' AS REGISTRO_POR,
				i.ORDEN AS ORDEN_AFIP,
				'' '' AS ESTADO
		FROM ITF_AFIP_ACT_ECONOMICA i WITH (NOLOCK)
		LEFT JOIN CLI_DocumentosPFPJ d WITH (NOLOCK) ON i.CUIL=d.NUMERODOCUMENTO
		INNER JOIN CLI_Cod_Act_AFIP a WITH (NOLOCK) ON i.COD_ACTIVIDAD=a.CODIGO_ACT_AFIP 
		LEFT JOIN CLI_ACTIVIDAD_ECONOMICA e WITH (NOLOCK) ON d.NUMEROPERSONAFJ=e.CODIGO_PERSONA_CLIENTE
					AND e.CODIGO_ACTIVIDAD=i.COD_ACTIVIDAD 
					AND e.ORDEN_AFIP=i.ORDEN 
					AND ((e.TZ_LOCK < 300000000000000 OR e.TZ_LOCK >= 400000000000000) 
					AND (e.TZ_LOCK < 100000000000000 OR e.TZ_LOCK >= 200000000000000))
		WHERE ((i.TZ_LOCK < 300000000000000 OR i.TZ_LOCK >= 400000000000000) 
				AND (i.TZ_LOCK < 100000000000000 OR i.TZ_LOCK >= 200000000000000))
				AND ((d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000) 
				AND (d.TZ_LOCK < 100000000000000 OR d.TZ_LOCK >= 200000000000000))


UNION

		SELECT
				c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
				a.DESCRIPCION,
				c.INICIO_ACTIVIDAD AS PERIODO_ACTIVIDAD,
				(CASE 
					WHEN c.ORDEN_AFIP=1 THEN ''Primaria''
					WHEN ((SELECT COUNT(*) FROM ITF_AFIP_ACT_ECONOMICA WITH (NOLOCK) WHERE CUIL=d.NUMERODOCUMENTO)=0 AND (SELECT MIN(u.ORDINAL_ACTIVIDAD) FROM CLI_ACTIVIDAD_ECONOMICA u  WITH (NOLOCK) WHERE u.TZ_LOCK=0 AND u.CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE AND ((u.TZ_LOCK < 300000000000000 OR u.TZ_LOCK >= 400000000000000) AND (u.TZ_LOCK < 100000000000000 OR u.TZ_LOCK >= 200000000000000)))=c.ORDINAL_ACTIVIDAD AND (SELECT COUNT(*) FROM CLI_ACTIVIDAD_ECONOMICA u WITH (NOLOCK) WHERE u.ORDEN_AFIP=1 AND u.CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE AND ((u.TZ_LOCK < 300000000000000 OR u.TZ_LOCK >= 400000000000000) AND (u.TZ_LOCK < 100000000000000 OR u.TZ_LOCK >= 200000000000000)))=0) THEN ''Primaria''
					ELSE ''Secundaria''
				END
				) AS TIPO_ACTIVIDAD,
				c.VERIFICADO_AFIP AS VERIFICADO_AFIP,
				c.FECHA_VERIFICADO,
				c.CODIGO_PERSONA_CLIENTE AS CODIGO_PERSONA,
				d.TIPODOCUMENTO AS TIPO_DOCUMENTO,
				d.NUMERODOCUMENTO AS NUMERO_DOCUMENTO,
				c.ORDINAL_ACTIVIDAD AS ORDINAL,
				''1_TOPAZ'' AS REGISTRO_POR,
				c.ORDEN_AFIP,
				'' '' AS ESTADO
		FROM CLI_ACTIVIDAD_ECONOMICA c WITH (NOLOCK)
			INNER JOIN CLI_Cod_Act_AFIP a WITH (NOLOCK) ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP 
			LEFT JOIN CLI_DocumentosPFPJ d WITH (NOLOCK) ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE
		WHERE ((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) 
				AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
				AND ((d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000) 
				AND (d.TZ_LOCK < 100000000000000 OR d.TZ_LOCK >= 200000000000000))

UNION

		SELECT
				c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
				a.DESCRIPCION,
				c.INICIO_ACTIVIDAD AS PERIODO_ACTIVIDAD,
				(
				CASE 
				WHEN c.ORDEN_AFIP=1 THEN ''Primaria''
				WHEN (SELECT COUNT(*) 
					  FROM ITF_AFIP_ACT_ECONOMICA WITH (NOLOCK) 
					  WHERE CUIL=c.CUIL)=0 AND
							(SELECT COUNT(*) 
						  	FROM TEMP_CLI_ACTIVIDAD_ECONOMICA WITH (NOLOCK) 
						  	WHERE CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE AND ORDEN_AFIP=1 
							AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) 
						    AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000))) = 0	AND
								((SELECT MIN(u.ORDINAL_ACTIVIDAD) 
								  FROM CLI_ACTIVIDAD_ECONOMICA u WITH (NOLOCK)
								  WHERE u.TZ_LOCK=0 
										AND u.CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE 
										AND ((u.TZ_LOCK < 300000000000000 OR u.TZ_LOCK >= 400000000000000) 
										AND (u.TZ_LOCK < 100000000000000 OR u.TZ_LOCK >= 200000000000000)))=c.ORDINAL_ACTIVIDAD 
										OR ( (SELECT MIN(u.ORDINAL_ACTIVIDAD) 
											  FROM CLI_ACTIVIDAD_ECONOMICA u WITH (NOLOCK)
											  WHERE u.TZ_LOCK=0 
											        AND u.CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE 
													AND ((u.TZ_LOCK < 300000000000000 OR u.TZ_LOCK >= 400000000000000) 
													AND (u.TZ_LOCK < 100000000000000 OR u.TZ_LOCK >= 200000000000000)))IS NULL 
													AND 
														(
														SELECT MIN(t.ORDINAL_ACTIVIDAD) 
														FROM TEMP_CLI_ACTIVIDAD_ECONOMICA t WITH (NOLOCK)
														WHERE t.TZ_LOCK=0 
																AND t.CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE 
																AND ((t.TZ_LOCK < 300000000000000 OR t.TZ_LOCK >= 400000000000000) 
																AND (t.TZ_LOCK < 100000000000000 OR t.TZ_LOCK >= 200000000000000)))=c.ORDINAL_ACTIVIDAD)) 
				THEN ''Primaria''
				ELSE ''Secundaria''
				END) AS TIPO_ACTIVIDAD,
				c.VERIFICADO_AFIP AS VERIFICADO_AFIP,
				c.FECHA_VERIFICADO,
				c.CODIGO_PERSONA_CLIENTE AS CODIGO_PERSONA,
				d.TIPODOCUMENTO AS TIPO_DOCUMENTO,
				c.CUIL AS NUMERO_DOCUMENTO,
				c.ORDINAL_ACTIVIDAD AS ORDINAL,
				''3_TEMP'' AS REGISTRO_POR,
				c.ORDEN_AFIP,
				c.ESTADO_REGISTRO AS ESTADO
				FROM TEMP_CLI_ACTIVIDAD_ECONOMICA c WITH (NOLOCK)
					INNER JOIN  CLI_Cod_Act_AFIP a WITH (NOLOCK) ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP --c.ESTADO_REGISTRO<>''B'' AND 
					LEFT JOIN CLI_DocumentosPFPJ d WITH (NOLOCK) ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE
				WHERE ((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) 
						AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))

) X 
INNER JOIN
(
--- Se agrupa para luego diferenciar que registro vino de AFIP, cual de TOPAZ y de los temporales.
	SELECT 
		COD_ACTIVIDAD,
		NUMERO_DOCUMENTO AS ''NUMERO_DOCUMENTO'',
		MAX(REGISTRO_POR) AS ''REGISTRO_POR''
	FROM
	(     
		SELECT 
				i.COD_ACTIVIDAD,
				i.CUIL AS NUMERO_DOCUMENTO,
				''2_AFIP'' AS REGISTRO_POR
		FROM ITF_AFIP_ACT_ECONOMICA i 
			LEFT JOIN CLI_DocumentosPFPJ d ON i.CUIL=d.NUMERODOCUMENTO 
			INNER JOIN CLI_Cod_Act_AFIP a ON i.COD_ACTIVIDAD=a.CODIGO_ACT_AFIP 
		WHERE ((i.TZ_LOCK < 300000000000000 OR i.TZ_LOCK >= 400000000000000) 
				AND (i.TZ_LOCK < 100000000000000 OR i.TZ_LOCK >= 200000000000000))
				AND ((d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000) 
				AND (d.TZ_LOCK < 100000000000000 OR d.TZ_LOCK >= 200000000000000))
	
	UNION
	/*
	---Union entre temporales y Topaz
	SELECT 
	COD_ACTIVIDAD,
	NUMERO_DOCUMENTO AS ''NUMERO_DOCUMENTO'',
	MAX(REGISTRO_POR) AS ''REGISTRO_POR''
	FROM
	( */
	---Se une los datos en la temporal con los ya grabados en Topaz
	---En caso de estar repetido se muestra solo el de topaz
	SELECT
			c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
			d.NUMERODOCUMENTO AS NUMERO_DOCUMENTO,
			''1_TOPAZ'' AS REGISTRO_POR
	FROM CLI_ACTIVIDAD_ECONOMICA c 
		INNER JOIN CLI_Cod_Act_AFIP a ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP
		LEFT JOIN CLI_DocumentosPFPJ d ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE
	WHERE ((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) 
		AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
		AND ((d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000) 
		AND (d.TZ_LOCK < 100000000000000 OR d.TZ_LOCK >= 200000000000000))
	
	UNION
	
	
	SELECT
			c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
			c.CUIL AS NUMERO_DOCUMENTO,
			''3_TEMP'' AS REGISTRO_POR
	FROM TEMP_CLI_ACTIVIDAD_ECONOMICA c 
		INNER JOIN CLI_Cod_Act_AFIP a ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP  --c.ESTADO_REGISTRO<>''B'' AND
		LEFT JOIN CLI_DocumentosPFPJ d ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE
	WHERE ((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) 
		AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
	
	
	)  Y GROUP BY Y.NUMERO_DOCUMENTO , Y.COD_ACTIVIDAD
) J ON J.NUMERO_DOCUMENTO=X.NUMERO_DOCUMENTO AND J.COD_ACTIVIDAD=X.COD_ACTIVIDAD AND J.REGISTRO_POR=X.REGISTRO_POR AND X.ORDINAL<>0 AND X.ESTADO<>''B''
ORDER BY  ORDEN_AFIP, ORDINAL OFFSET 0 ROWS



')

