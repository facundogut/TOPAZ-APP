/****** Object:  View [dbo].[VW_ASIENTOS]    Script Date: 24/02/2021 12:21:33 ******/
DROP VIEW [dbo].[VW_ASIENTOS]
GO

/****** Object:  View [dbo].[VW_ASIENTOS]    Script Date: 24/02/2021 12:21:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [dbo].[VW_ASIENTOS]
AS

SELECT
		DISTINCT A.ASIENTO AS ASIENTO,
		A.DESCRIPCION AS DESCRIPCION, 
		A.FECHAPROCESO AS FECHAPROCESO,
		CAST(CONVERT(date, A.HORAFIN) AS datetime) AS FECHA_FIN,
		CAST(CONVERT(time, A.HORAFIN) AS VARCHAR(8)) AS HORA_FIN,
		A.SUCURSAL AS SUCURSAL, 
		M.SALDO_JTS_OID AS JTS_OID,
		S.C1785 AS TIPO_PRODUCTO
FROM ASIENTOS A WITH (nolock)
		INNER JOIN MOVIMIENTOS_CONTABLES M WITH(nolock) ON A.ASIENTO = M.ASIENTO 
															AND A.FECHAPROCESO = M.FECHAPROCESO 
															AND A.SUCURSAL = M.SUCURSAL
		INNER JOIN SALDOS S WITH(nolock) ON M.SALDO_JTS_OID = S.JTS_OID

WHERE 
	A.ESTADO = 77
	AND A.EXTORNO = 0
	AND NOT EXISTS (SELECT * 
					FROM ASIENTOS_EXTORNADOS AE WITH(nolock) 
					WHERE AE.SUCURSAL = A.SUCURSAL 
						AND AE.FECHA_PROCESO = A.FECHAPROCESO 
						AND AE.ASIENTO = A.ASIENTO
					)
	AND A.FECHAPROCESO >=
		(SELECT TOP 1 AA.FECHAPROCESO
			FROM ASIENTOS AA WITH(nolock) 
				INNER JOIN MOVIMIENTOS_CONTABLES MM WITH(nolock)ON AA.ASIENTO = MM.ASIENTO
																	AND AA.FECHAPROCESO = MM.FECHAPROCESO
																	AND AA.SUCURSAL = MM.SUCURSAL
			WHERE  
				AA.ESTADO = 77 
				AND MM.SALDO_JTS_OID = M.SALDO_JTS_OID
			ORDER BY AA.FECHAPROCESO DESC
		)	
	
GO


