EXECUTE('
ALTER   PROCEDURE SP_CALCULA_GRADUACION
    @CLIENTE NUMERIC(12,0), 
    @PERSONA NUMERIC(12,0), 
    @IMPORTE_SOLICITUD NUMERIC(15,2),
    @EXCLUIDO VARCHAR(1),
    @CON_GTIA VARCHAR(1),
    @TOTAL_DEUDA    NUMERIC(20,2) OUTPUT,
    @TRAMO_SIN_G   NUMERIC(20,2) OUTPUT, 
    @TRAMO_CON_G  NUMERIC(20,2) OUTPUT,
    @TRAMO_SIN_G_B   NUMERIC(20,2) OUTPUT, 
    @TRAMO_CON_G_B  NUMERIC(20,2) OUTPUT,
    @RPC_BANCO NUMERIC(20,2)OUTPUT,
    @EXCLUSIONES NUMERIC(20,2)OUTPUT,
    @TOT_CONTROL_GRAD NUMERIC(20,2)OUTPUT,
    @RPC_CLIENTE NUMERIC(20,2)OUTPUT,
    @RPC_CLIENTE_MAX NUMERIC(20,2)OUTPUT,
    @RPC_NETO_BANCO NUMERIC(20,2)OUTPUT,
    @MARGEN_RESGUAR NUMERIC(20,2)OUTPUT,
    @LIMITE_GRAD NUMERIC(20,2)OUTPUT,
    @RESULTADO_GRADUACION VARCHAR(200) OUTPUT,
    @RESULTADO_FRACCIONAMIENTO VARCHAR(200) OUTPUT,
    @IMPORTE_SING_GRUPO NUMERIC(20,2) OUTPUT,
    @IMPORTE_CONG_GRUPO NUMERIC(20,2) OUTPUT,
    @PERIODO VARCHAR(10) OUTPUT,
    --- Parametros
    @CN1_BANCO NUMERIC(20,2) OUTPUT, ---600
    @MARGEN_BASICO NUMERIC(5,2) OUTPUT, ---601
    @RPC_CLIENTE_O NUMERIC(5,2) OUTPUT, ---602
    @RPC_BANCO_O NUMERIC(5,2) OUTPUT, ---603
    @RPC_CLIENTE_SGR_FGP NUMERIC(5,2) OUTPUT, ---604
    @RPC_BANCO_SGR_FGP NUMERIC(5,2) OUTPUT, ---605
    @PORC_TRAMO_SING NUMERIC(5,2) OUTPUT, ---606
    @PORC_TRAMO_CONG NUMERIC(5,2) OUTPUT, ---607
    @MARGEN_RESGUARDO NUMERIC(5,2) OUTPUT, ---608
    @RPC_BANCO_IMP NUMERIC(15,2) OUTPUT, ---609
    --- Descripciones
    @VINCULO VARCHAR(80) OUTPUT,
    @DESCRIPCION_GRUPO VARCHAR(60) OUTPUT,
    --- Deuda tope vinculado
    @MENSAJE_VINCULADOS VARCHAR(200) OUTPUT,
    --- Para operaciones
    @EXCEDE_GRADUACION_O VARCHAR(1) OUTPUT,
    @EXCEDE_FRACCIONAMIENTO_O VARCHAR(1) OUTPUT
AS
BEGIN

	DECLARE @MENOR_MARGEN NUMERIC(20,2);
	DECLARE @TIENE_GRUPO NUMERIC(5);
	DECLARE @GRUPO NUMERIC(12);
	DECLARE @DEUDA_CLIENTE NUMERIC(20,2);
	DECLARE @EXCLUSION_CLIENTE_G NUMERIC(20,2);
	DECLARE @EXCLUSION_ASISTENCIA_G NUMERIC(20,2);
	DECLARE @EXCLUSION_PRODUCTO_G NUMERIC(20,2);
	DECLARE @EXCLUSION_GARANTIA_G NUMERIC(20,2);
	DECLARE @EXCLUSION_CLIENTE_F_CONG NUMERIC(20,2);
	DECLARE @EXCLUSION_CLIENTE_F_SING NUMERIC(20,2);
	DECLARE @EXCLUSION_ASISTENCIA_F_CONG NUMERIC(20,2);
	DECLARE @EXCLUSION_ASISTENCIA_F_SING NUMERIC(20,2);
	DECLARE @EXCLUSION_PRODUCTO_F_CONG NUMERIC(20,2);
	DECLARE @EXCLUSION_PRODUCTO_F_SING NUMERIC(20,2);
	DECLARE @EXCLUSION_GARANTIA_F_SING NUMERIC(20,2);
	DECLARE @EXCLUSION_GARANTIA_F_CONG NUMERIC(20,2);
	DECLARE @CLIENTE_EXCLUIDO_GRAD NUMERIC (12,0);
	DECLARE @CLIENTE_EXCLUIDO_FRACC NUMERIC (12,0);
	DECLARE @EXCEDE_GRADUACION VARCHAR(1);
	DECLARE @EXCEDE_FRACCIONAMIENTO VARCHAR(1);
	DECLARE @TOTAL_DEUDA_GRUPO NUMERIC (20,2);
	DECLARE @EXCLUSIONES_GRUPALES_GRADUACION NUMERIC (20,2);
	DECLARE @IMPORTE_A_EVALUAR NUMERIC (20,2);
	DECLARE @TABLA_ASISTENCIAS TABLE (CLIENTE NUMERIC(12), JTS_ASISTENCIA NUMERIC(10),
	IMPORTE_DEUDA NUMERIC(15,2), TIENE_GARANTIA VARCHAR(1), TIPO_GARANTIA NUMERIC(2),
	PRODUCTO NUMERIC(5), FAMILIA NUMERIC(10))
	DECLARE @ES_VINCULADO NUMERIC(2)
	DECLARE @TOPE_ANALISIS NUMERIC(18,2)
	DECLARE @TIPO_VINCULO NUMERIC(3)
	DECLARE @RESULTADO_GRAD_GRUPO VARCHAR(200)
	DECLARE @RESULTADO_FRACC_GRUPO VARCHAR(200)
	DECLARE @EXCEDE_GRAD_VINC VARCHAR(1)
	DECLARE @RESULTADO_IND_VINC VARCHAR(200)
	DECLARE @RESULTADO_GRUP_VINC VARCHAR(200)


	--- Busca porcentajes si es vinculado
	
	SET @ES_VINCULADO = (SELECT COUNT(1) FROM CLI_VINCULACIONES WITH(NOLOCK) WHERE TZ_LOCK=0
	AND REGISTRO = ''C'' AND PERSONA_VINCULADA IN (SELECT NUMEROPERSONA FROM CLI_ClientePersona WITH(NOLOCK) WHERE 
	TZ_LOCK = 0 AND CODIGOCLIENTE = @CLIENTE) AND (FECHA_FIN IS NULL OR 
	DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),FECHA_FIN) 
	>= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))))
	
	---Seteo valores de CRE_PARAMETROS
	SET @CN1_BANCO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=600);
	SET @MARGEN_BASICO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=601);
	
	IF(@ES_VINCULADO = 0 OR @ES_VINCULADO IS NULL)
	BEGIN
	SET @RPC_CLIENTE_O = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=602);
	END
	ELSE
	BEGIN
	SET @RPC_CLIENTE_O = 0;
	END
	
	IF(@ES_VINCULADO = 0 OR @ES_VINCULADO IS NULL)
	BEGIN
	SET @RPC_BANCO_O = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=603);
	END
	ELSE
	BEGIN
	SET @RPC_BANCO_O = 0;
	END
	
	SET @RPC_CLIENTE_SGR_FGP = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=604);
	SET @RPC_BANCO_SGR_FGP = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=605);
	SET @PORC_TRAMO_SING = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=606);
	SET @PORC_TRAMO_CONG = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=607);
	
	
	IF(@ES_VINCULADO = 0 OR @ES_VINCULADO IS NULL)
	BEGIN
	SET @MARGEN_RESGUARDO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=608);
	END
	ELSE
	BEGIN
	SET @MARGEN_RESGUARDO = 0;
	END
	
	
	SET @RPC_BANCO_IMP = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=609);
   
    IF(@ES_VINCULADO=0)
    BEGIN
    	---Setea tramo sin garantía para banco
		SET @TRAMO_SIN_G_B = (@CN1_BANCO * (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=606))/100;
		---Setea tramo con garantía para banco
		SET @TRAMO_CON_G_B = (@CN1_BANCO * (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=607))/100;
    END
    ELSE
    BEGIN
    	--- Busco tipo de vinculación
    	SET @TIPO_VINCULO = (SELECT TOP 1 VINCULO_PRIMARIO FROM CLI_VINCULOS WITH(NOLOCK)
    	WHERE ID IN (SELECT VINCULO FROM CLI_VINCULACIONES WITH(NOLOCK) WHERE TZ_LOCK = 0
    	AND REGISTRO = ''C'' AND PERSONA_VINCULADA IN (SELECT NUMEROPERSONA FROM CLI_ClientePersona WITH(NOLOCK) WHERE 
		TZ_LOCK = 0 AND CODIGOCLIENTE = @CLIENTE) AND VINCULO_PRIMARIO IN (SELECT ID FROM CLI_VINCULOS_PRIMARIOS WITH(NOLOCK)
		WHERE TIPO IN (''D'',''I''))) ORDER BY VINCULO_PRIMARIO DESC)
    	
    	SET @VINCULO = (SELECT DESCRIPCION FROM CLI_VINCULOS_PRIMARIOS WITH(NOLOCK) WHERE ID = @TIPO_VINCULO)
    	--- Busco si tiene tramo parametrizado
    	
    	
    	SET @TRAMO_SIN_G_B = (@CN1_BANCO*(SELECT TOPE_FRACCIONAMIENTO_SING FROM CRE_VINCULADOS_GYF WITH(NOLOCK)
    	WHERE TZ_LOCK = 0 AND TIPO_VINCULACION = ''P'' AND ID = @TIPO_VINCULO))/100;
    	
    	SET @TRAMO_CON_G_B = (@CN1_BANCO*(SELECT TOPE_FRACCIONAMIENTO_CONG FROM CRE_VINCULADOS_GYF WITH(NOLOCK)
    	WHERE TZ_LOCK = 0 AND TIPO_VINCULACION = ''P'' AND ID = @TIPO_VINCULO))/100;
    	
    	IF(@TRAMO_SIN_G_B IS NULL)
    	BEGIN
    	    SET @PORC_TRAMO_SING = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=606);
    		SET @TRAMO_SIN_G_B = (@CN1_BANCO * (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=606))/100;
    	END
    	ELSE
    	BEGIN
    		SET @PORC_TRAMO_SING = (SELECT TOPE_FRACCIONAMIENTO_SING FROM CRE_VINCULADOS_GYF WITH(NOLOCK)
    		WHERE TZ_LOCK = 0 AND TIPO_VINCULACION = ''P'' AND ID = @TIPO_VINCULO);
    	END
    	
    	IF(@TRAMO_CON_G_B IS NULL)
    	BEGIN
    		SET @PORC_TRAMO_CONG = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=607);
    		SET @TRAMO_CON_G_B = (@CN1_BANCO * (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=607))/100;
    	END
    	ELSE
    	BEGIN
    		SET @PORC_TRAMO_CONG = (SELECT TOPE_FRACCIONAMIENTO_CONG FROM CRE_VINCULADOS_GYF WITH(NOLOCK)
    		WHERE TZ_LOCK = 0 AND TIPO_VINCULACION = ''P'' AND ID = @TIPO_VINCULO);
    	END
    	
    END
    
    
	---Setea RPC Banco
	IF(@ES_VINCULADO = 0 OR @ES_VINCULADO IS NULL)
	BEGIN
	SET @RPC_BANCO = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=609);
	END
	ELSE
	BEGIN
	SET @RPC_BANCO = 0;
	END
	---Busca deudas con y sin garantia cliente
	
	---Busca RPC Cliente
	IF(@ES_VINCULADO = 0 OR @ES_VINCULADO IS NULL)
	BEGIN
	SET @RPC_CLIENTE = ISNULL((SELECT TOP 1 RPC FROM CRE_TAM_EMP_BALANCE WITH(NOLOCK) WHERE ID_PERSONA = @PERSONA AND F_FINAL >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) ORDER BY F_FINAL ASC),0)
	END
	ELSE
	BEGIN
	SET @RPC_CLIENTE = 0;
	END
	
	---Calcula RPC máximo cliente
	SET @RPC_CLIENTE_MAX = (@RPC_CLIENTE * @RPC_CLIENTE_O)/100;
	---Calcula RPC Neto banco
	SET @RPC_NETO_BANCO = (@RPC_BANCO * (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 603))/100;
	---Calcula margen resguardo
	SET @MARGEN_RESGUAR = ((@RPC_CLIENTE + @RPC_NETO_BANCO)*(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 608))/100; 
	---Busca menor margen para calcular límite de graduación
	SET @MENOR_MARGEN = (SELECT CASE WHEN @RPC_CLIENTE_MAX < @RPC_NETO_BANCO THEN @RPC_CLIENTE_MAX ELSE @RPC_NETO_BANCO END);
	---Calcula límite de graduación
	SET @LIMITE_GRAD = 	(@RPC_CLIENTE+@MENOR_MARGEN)-@MARGEN_RESGUAR;  
	--Busca cliente
	SET @CLIENTE_EXCLUIDO_GRAD =(SELECT COUNT(*) FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE CODIGOCLIENTE=@CLIENTE AND GRADUACION=''S'' AND TZ_LOCK = 0);  
	SET @CLIENTE_EXCLUIDO_FRACC =(SELECT COUNT(*) FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE CODIGOCLIENTE=@CLIENTE AND FRACCIONAMIENTO=''S'' AND TZ_LOCK = 0);  
    
	
    SET @TOPE_ANALISIS = ((SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=614) *
	(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=615)) / 100;
	
	
	SET @PERIODO = SUBSTRING(CONVERT(VARCHAR(10),DATEADD(month, -2 , (SELECT fechaproceso FROM PARAMETROS WITH(nolock))), 112),1,6);
	
	
	INSERT INTO @TABLA_ASISTENCIAS
	SELECT 
	@CLIENTE,
	AD.JTS_OID,
	SUM(AD.SALDO_DEUDA),
	CASE 
	WHEN CG.JTSOID_SALDO IS NULL THEN ''N''
	ELSE ''S''
	END AS GARANTIA,
	ISNULL(CTG.TIPO_GARANTIA,0),
	p.C6250, 
	f.FAMILIAPROD
	FROM VW_DEUDA_CLIENTES AD WITH(NOLOCK)
	INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = AD.JTS_OID
	INNER JOIN PRODUCTOS p WITH(NOLOCK) ON s.PRODUCTO = p.C6250 
	AND ( (p.tz_lock < 300000000000000 OR p.tz_lock >= 400000000000000) 
	AND (p.tz_lock < 100000000000000 OR p.tz_lock >= 200000000000000)  )
	INNER JOIN CRE_FAMILIAS f ON p.C6283 = f.FAMILIAPROD 
	AND ( (f.tz_lock < 300000000000000 OR f.tz_lock >= 400000000000000) 
	AND (f.tz_lock < 100000000000000 OR f.tz_lock >= 200000000000000)  )	
	LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID
	LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA
	LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND
	CTG.TIPO_BCRA IN (1,2)
	WHERE AD.SALDO_DEUDA <> 0 AND S.C1785 IN (1,5,6)
	AND AD.CLIENTE = @CLIENTE
	GROUP BY AD.JTS_OID, CG.JTSOID_SALDO, CTG.TIPO_GARANTIA, p.C6250, f.FAMILIAPROD

	---Seteo deuda total cliente
	SET @DEUDA_CLIENTE=ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS  
	WHERE CLIENTE = @CLIENTE),0);
	
	---Busca si tiene grupo
	SELECT @TIENE_GRUPO=COUNT(1), @GRUPO=A.CODIGOGRUPOECONOMICO FROM dbo.CLI_GRUPOSECONOMICOSCLIENTE A WITH(NOLOCK)
	INNER JOIN  dbo.CLI_CLIENTES B WITH(NOLOCK) ON A.CODIGOCLIENTE = B.CODIGOCLIENTE AND B.CODIGOCLIENTE = @CLIENTE 
	AND B.TZ_LOCK = 0 WHERE A.TZ_LOCK = 0 GROUP BY A.CODIGOGRUPOECONOMICO
   
   					
   --SI NO TIENE GRUPO ENTRA
    SET @IMPORTE_CONG_GRUPO = 0;
	SET @IMPORTE_SING_GRUPO = 0;
	
   --- Exclusiones cliente	
	SET @EXCLUSION_CLIENTE_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE 
	AND CLIENTE IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE GRADUACION=''S'' AND TZ_LOCK=0)),0);
		
	SET @EXCLUSION_CLIENTE_F_CONG = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE AND TIENE_GARANTIA = ''S''
	AND CLIENTE IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)),0);
		
	SET @EXCLUSION_CLIENTE_F_SING = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE AND TIENE_GARANTIA = ''N''
	AND CLIENTE IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)),0);
		
	--- Exlusiones asistencias
	SET @EXCLUSION_ASISTENCIA_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE 
	AND CLIENTE NOT IN (SELECT CODIGOCLIENTE 
	FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) WHERE GRADUACION=''S'' AND TZ_LOCK=0)
	AND JTS_ASISTENCIA IN (SELECT ASISTENCIA_JTS_OID 
	FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) WHERE GRADUACION = ''S'' AND TZ_LOCK=0)),0);
		
	SET @EXCLUSION_ASISTENCIA_F_CONG = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE AND TIENE_GARANTIA = ''S''
	AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
	AND JTS_ASISTENCIA IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
	WITH(NOLOCK) WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)),0);
		
	SET @EXCLUSION_ASISTENCIA_F_SING = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE AND TIENE_GARANTIA = ''N''
	AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
	AND JTS_ASISTENCIA IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS 
	WITH(NOLOCK) WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)),0);

	--- Exclusiones producto-familia
	SET @EXCLUSION_PRODUCTO_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE
	AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE GRADUACION=''S'' AND TZ_LOCK=0)
	AND JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) 
	WHERE GRADUACION = ''S'' AND TZ_LOCK=0)
	AND (PRODUCTO IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''P'' AND GRADUACION = ''S'' AND TZ_LOCK=0)
	OR (FAMILIA IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''F'' AND GRADUACION = ''S'' AND TZ_LOCK=0)))),0);
		
		
	SET @EXCLUSION_PRODUCTO_F_CONG = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE AND TIENE_GARANTIA = ''S''
	AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
	AND JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)
	AND (PRODUCTO IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''P'' AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)
	OR (FAMILIA IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''F'' AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)))),0);
		
		
	SET @EXCLUSION_PRODUCTO_F_SING = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE AND TIENE_GARANTIA = ''N''
	AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
	AND JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)
	AND (PRODUCTO IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''P'' AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)
	OR (FAMILIA IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''F'' AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)))),0);
	
	--- Exlusiones garantia
	SET @EXCLUSION_GARANTIA_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE
	AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE GRADUACION=''S'' AND TZ_LOCK=0)
	AND JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) 
	WHERE GRADUACION = ''S'' AND TZ_LOCK=0)
	AND PRODUCTO NOT IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''P'' AND GRADUACION = ''S'' AND TZ_LOCK=0)
	AND FAMILIA NOT IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''F'' AND GRADUACION = ''S'' AND TZ_LOCK=0) AND TIPO_GARANTIA IN (SELECT TIPO_GARANTIA
	FROM CRE_EXCLUSIONES_TIPOSGARANTIAS WITH(NOLOCK) WHERE TZ_LOCK = 0 AND GRADUACION = ''S'')),0);
		
	SET @EXCLUSION_GARANTIA_F_CONG = ISNULL((SELECT SUM(IMPORTE_DEUDA) 
	FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE AND TIENE_GARANTIA = ''S''
	AND CLIENTE NOT IN (SELECT CODIGOCLIENTE FROM CRE_EXCLUSIONES_CLIENTES WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO=''S'' AND TZ_LOCK=0)
	AND JTS_ASISTENCIA NOT IN (SELECT ASISTENCIA_JTS_OID FROM CRE_EXCLUSIONES_ASISTENCIAS WITH(NOLOCK) 
	WHERE FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)
	AND (PRODUCTO IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''P'' AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0)
	AND (FAMILIA IN (SELECT ITEM FROM CRE_EXCLUSIONES_PRODUCTOS WITH(NOLOCK) 
	WHERE TIPO=''F'' AND FRACCIONAMIENTO = ''S'' AND TZ_LOCK=0))) AND TIPO_GARANTIA IN (SELECT TIPO_GARANTIA
	FROM CRE_EXCLUSIONES_TIPOSGARANTIAS WITH(NOLOCK) WHERE TZ_LOCK = 0 AND FRACCIONAMIENTO = ''S'')),0);
		
		
	SET @EXCLUSION_GARANTIA_F_SING = 0;
	
	 IF(@EXCLUIDO = ''S'')
	 BEGIN
		SET @TOTAL_DEUDA=ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS 
		WHERE CLIENTE = @CLIENTE),0);
	 END
	 ELSE
	 BEGIN
		SET @TOTAL_DEUDA=ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS
		WHERE CLIENTE = @CLIENTE),0)+@IMPORTE_SOLICITUD;
	 END
    
    ---Setea exclusiones
	SET @EXCLUSIONES = @EXCLUSION_CLIENTE_G+@EXCLUSION_ASISTENCIA_G+@EXCLUSION_PRODUCTO_G+@EXCLUSION_GARANTIA_G;
    ---Setea importe a analizar para graduación
	SET @TOT_CONTROL_GRAD = @TOTAL_DEUDA - @EXCLUSIONES;
		
	   
	IF(@TIENE_GRUPO > 0) 
	BEGIN 
	
	--LLAMADO A SP NUEVO, CALCULA IMPORTE GRUPOS EXCLUYENDO @CLIENTE
	EXECUTE SP_CONTROL_GYF_GRUPO @GRUPO,
	@IMPORTE_SOLICITUD,
	@EXCLUIDO,
	@CON_GTIA,
	@CLIENTE,
	@EXCLUIDO,
	@LIMITE_GRAD,
    @TRAMO_SIN_G_B,
    @TRAMO_CON_G_B,
	@EXCEDE_GRADUACION OUTPUT,
	@EXCEDE_FRACCIONAMIENTO OUTPUT,
	@IMPORTE_SING_GRUPO OUTPUT,
    @IMPORTE_CONG_GRUPO OUTPUT,
    @TOTAL_DEUDA_GRUPO OUTPUT,
    @EXCLUSIONES_GRUPALES_GRADUACION OUTPUT,
    @IMPORTE_A_EVALUAR OUTPUT,
    @RESULTADO_GRAD_GRUPO OUTPUT,
    @RESULTADO_FRACC_GRUPO OUTPUT; 
	
	---PARA FRACCIONAMIENTO, IGUALAR CON TRAMO SIN G GRUPO CON TRAMO CON G GRUPO   
	SET @IMPORTE_SING_GRUPO=@IMPORTE_SING_GRUPO;
	--SELECT @IMPORTE_SING_GRUPO;
	SET @IMPORTE_CONG_GRUPO=@IMPORTE_CONG_GRUPO; 
	   
	---SET @TOTAL_DEUDA= @TOTAL_DEUDA_GRUPO;
	--SELECT @TOTAL_DEUDA 
	---SET @EXCLUSIONES=@EXCLUSIONES_GRUPALES_GRADUACION;
	---SET @TOT_CONTROL_GRAD=@IMPORTE_A_EVALUAR;
	   --TERMINA ANALISIS GRUPO EN GENERAL - CLIENTE  
	   
	--- Seteo descripcion del grupo
	
	SET @DESCRIPCION_GRUPO = (SELECT NOMBRE FROM CLI_GRUPOSECONOMICOS WITH(NOLOCK) 
	WHERE CODIGOGRUPOECONOMICO = @GRUPO)
	
	END	
	
	IF(@ES_VINCULADO > 0 AND @TIPO_VINCULO <> 1)
	BEGIN
	EXECUTE dbo.SP_CONTROL_GYF_VINCULADOS @CLIENTE, @TIPO_VINCULO, @IMPORTE_SOLICITUD, @EXCEDE_GRAD_VINC OUT, @RESULTADO_IND_VINC OUT, @RESULTADO_GRUP_VINC OUT
	SET @MENSAJE_VINCULADOS = @RESULTADO_GRUP_VINC;
	END
	
	
   
	
	IF(@CON_GTIA = ''S'')
	
		BEGIN
		SET @TRAMO_CON_G = ISNULL((ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS  
		WHERE CLIENTE=@CLIENTE AND TIENE_GARANTIA = ''S''),0)+@IMPORTE_SOLICITUD)-(@EXCLUSION_CLIENTE_F_CONG+@EXCLUSION_ASISTENCIA_F_CONG+@EXCLUSION_PRODUCTO_F_CONG+@EXCLUSION_GARANTIA_F_CONG),0);
	
	---Busca deudas sin garantia cliente
		SET @TRAMO_SIN_G = ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS 
		WHERE CLIENTE=@CLIENTE AND TIENE_GARANTIA = ''N''),0)-(@EXCLUSION_CLIENTE_F_SING+@EXCLUSION_ASISTENCIA_F_SING+@EXCLUSION_PRODUCTO_F_SING);
		END
	ELSE
	--Si garantía es NO, no se suma importeSolicitud
		BEGIN
		SET @TRAMO_CON_G = ISNULL(ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS
		WHERE CLIENTE=@CLIENTE AND TIENE_GARANTIA = ''S''),0)-(@EXCLUSION_CLIENTE_F_CONG+@EXCLUSION_ASISTENCIA_F_CONG+@EXCLUSION_PRODUCTO_F_CONG+@EXCLUSION_GARANTIA_F_CONG),0);
	---Busca deudas sin garantia cliente
		SET @TRAMO_SIN_G = (ISNULL((SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS 
		WHERE CLIENTE=@CLIENTE AND TIENE_GARANTIA = ''N''),0)+@IMPORTE_SOLICITUD)-(@EXCLUSION_CLIENTE_F_SING+@EXCLUSION_ASISTENCIA_F_SING+@EXCLUSION_PRODUCTO_F_SING);
		
		END
	
	---Setea exclusiones
	---SET @EXCLUSIONES = @EXCLUSION_CLIENTE_G+@EXCLUSION_ASISTENCIA_G+@EXCLUSION_PRODUCTO_G;
    ---Setea importe a analizar para graduación
	---SET @TOT_CONTROL_GRAD = @TOTAL_DEUDA - @EXCLUSIONES;
   
	---Prepara mensaje
	IF(@TIENE_GRUPO>0 AND @EXCEDE_GRADUACION=''S'')
	BEGIN
	SET @RESULTADO_GRADUACION=@RESULTADO_GRAD_GRUPO;
	SET @EXCEDE_GRADUACION_O = ''S'';
	END
	ELSE
	BEGIN  
	SET @RESULTADO_GRADUACION = ''Encuadrado'';
	SET @EXCEDE_GRADUACION_O = ''N'';
	END
	
	IF(@TIENE_GRUPO>0 AND @EXCEDE_FRACCIONAMIENTO=''S'')
	BEGIN 
    SET @RESULTADO_FRACCIONAMIENTO=@RESULTADO_FRACC_GRUPO;
    SET @EXCEDE_FRACCIONAMIENTO_O = ''S'';
	END
	ELSE
	BEGIN 
	SET @RESULTADO_FRACCIONAMIENTO = ''Encuadrado'';
	SET @EXCEDE_FRACCIONAMIENTO_O = ''N'';
	END
	
	IF(@TIENE_GRUPO=0 OR @TIENE_GRUPO IS NULL)
	BEGIN 
    IF(@LIMITE_GRAD>=@TOT_CONTROL_GRAD)
    BEGIN
	IF(@CLIENTE_EXCLUIDO_GRAD>0)
	BEGIN
	 SET @RESULTADO_GRADUACION = ''Encuadrado (Cliente excluido)''
	 SET @EXCEDE_GRADUACION_O = ''N'';
	END
	 ELSE
	 BEGIN
	 SET @RESULTADO_GRADUACION = ''Encuadrado''
	 SET @EXCEDE_GRADUACION_O = ''N''
	 END
	END
	ELSE
	BEGIN
	SET @RESULTADO_GRADUACION = ''Alerta por exceso de graduación. Deuda total=''+CONVERT(VARCHAR(17),FORMAT(@TOT_CONTROL_GRAD, ''C'', ''es-ar''))+'' Límite graduación=''+CONVERT(VARCHAR(17),FORMAT(@LIMITE_GRAD, ''C'', ''es-ar''));
	SET @EXCEDE_GRADUACION_O = ''S''
	END
	
	IF(@TRAMO_SIN_G_B>=@TRAMO_SIN_G AND @TRAMO_CON_G_B>=@TRAMO_CON_G )
	BEGIN
	IF(@CLIENTE_EXCLUIDO_FRACC>0)
	BEGIN
	SET @RESULTADO_FRACCIONAMIENTO = ''Encuadrado (Cliente excluido)''
	SET @EXCEDE_FRACCIONAMIENTO_O = ''N'';
	END
	ELSE
	BEGIN
	SET @RESULTADO_FRACCIONAMIENTO = ''Encuadrado''
	SET @EXCEDE_FRACCIONAMIENTO_O = ''N'';
	END
	END
	ELSE
	BEGIN
	SET @RESULTADO_FRACCIONAMIENTO = ''Alerta por exceso de fraccionamiento. Deuda total=''+CONVERT(VARCHAR(17),FORMAT(@TRAMO_SIN_G, ''C'', ''es-ar''))+'' Tope permitido=''+CONVERT(VARCHAR(17),FORMAT(@TRAMO_SIN_G_B, ''C'', ''es-ar''));
 	SET @EXCEDE_FRACCIONAMIENTO_O = ''S'';
 	END
 END
 
   IF(@ES_VINCULADO > 0)
   BEGIN
   	IF(@EXCEDE_GRAD_VINC = ''S'')
   	BEGIN
    	SET @RESULTADO_FRACCIONAMIENTO = @RESULTADO_IND_VINC;
    	SET @RESULTADO_GRADUACION = @RESULTADO_GRUP_VINC;
    	SET @EXCEDE_GRADUACION_O = ''S'';
    	SET @EXCEDE_FRACCIONAMIENTO_O = ''S'';
    END
    ELSE
   	BEGIN
       SET @RESULTADO_GRADUACION = ''Encuadrado'';
       SET @EXCEDE_GRADUACION_O = ''N'';
   	END
   END

 END
')
