EXECUTE('
ALTER PROCEDURE SP_OBTENER_CARGO_ESPECIFICO
	@ID_LIQUIDACION NUMERIC(15),
	@NRO_FACTURA_CAJA NUMERIC(8),
	@TOTAL_CARGO_ESPECIFICO NUMERIC(15,2) OUTPUT,
	@ESTADO_PADRON VARCHAR(1) OUTPUT
AS 
BEGIN
	
	DECLARE 
		@ID_CABEZAL NUMERIC(15),
		@COD_ENTE NUMERIC(11),
		@ID_CONVENIO NUMERIC(15),
		@ID_CONVENIO_PADRE NUMERIC(15),
		@COD_ENTE_SAMEEP NUMERIC(6),
		@COD_ENTE_SECHEEP NUMERIC(6)
		
	SELECT @COD_ENTE_SAMEEP = NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO = 306;
	SELECT @COD_ENTE_SECHEEP = NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO = 307;	
			
	/* Obtener cargo especifico para CANALES */
	IF(@ID_LIQUIDACION != 0)
	
	BEGIN	
		DECLARE @TablaAuxNroFactura TABLE(
			NRO_FACTURA NUMERIC(12),
			TIPO_COMPROBANTE NUMERIC(2),
			LETRA VARCHAR(1),
			PUNTO_VENTA NUMERIC(4)
		)
		
		
		SELECT @ID_CABEZAL = ID FROM REC_CAB_RECAUDOS_CANAL WHERE ID_LIQUIDACION = @ID_LIQUIDACION AND TZ_LOCK = 0;
		
		--SELECT @ID_CONVENIO_PADRE = CONVENIO_PADRE FROM REC_LIQUIDACION WHERE ID_LIQUIDACION = @ID_LIQUIDACION AND TZ_LOCK = 0;
		SELECT @ID_CONVENIO_PADRE = CASE WHEN CONVENIO_PADRE = 0 THEN CONVENIO ELSE CONVENIO_PADRE END FROM REC_LIQUIDACION WHERE ID_LIQUIDACION = @ID_LIQUIDACION AND TZ_LOCK = 0;
		SELECT @ID_CONVENIO = CONVENIO FROM REC_CAB_RECAUDOS_CANAL WHERE ID = @ID_CABEZAL AND TZ_LOCK = 0;
		
		SELECT @COD_ENTE = COD_ENTE FROM CONV_REL_ENTECONV WHERE ID_CONVREC = @ID_CONVENIO_PADRE AND TZ_LOCK = 0
		
		/* SAMEEP */
		IF(@COD_ENTE = @COD_ENTE_SAMEEP)
		BEGIN
		
			INSERT INTO @TablaAuxNroFactura 
			SELECT SUBSTRING(CODIGO_BARRAS,9,8), 	/* NRO FACTURA/COMPROBANTE */
			0, 	/* TIPO COMPROBANTE */
			CASE WHEN SUBSTRING(CODIGO_BARRAS,4,4) = 0 THEN ''B'' 
				 WHEN SUBSTRING(CODIGO_BARRAS,4,4) = 1 THEN ''A''
				ELSE ''Y'' END,	 /* LETRA */
			SUBSTRING(CODIGO_BARRAS,5,4) 	/*PUNTO VENTA */
			FROM REC_DET_RECAUDOS_CANAL WHERE ID_CABEZAL = @ID_CABEZAL AND TZ_LOCK = 0;
			
		   
			SELECT @TOTAL_CARGO_ESPECIFICO = SUM(TOTAL_CARGO_ESPECIFICO) FROM CONV_PADRONES P JOIN @TablaAuxNroFactura A
																		ON P.NRO_COMPROBANTE_CLIENTE = A.NRO_FACTURA
																		WHERE P.TZ_LOCK = 0 
																		AND P.CONVENIO = @COD_ENTE AND P.TIPO_COMPROBANTE = A.TIPO_COMPROBANTE
																		AND P.LETRA = A.LETRA AND P.PUNTO_VENTA = A.PUNTO_VENTA
			RETURN @TOTAL_CARGO_ESPECIFICO;
		END
		
		/* SECHEEP */
		IF(@COD_ENTE = @COD_ENTE_SECHEEP)
		BEGIN
			INSERT INTO @TablaAuxNroFactura 
			SELECT SUBSTRING(CODIGO_BARRAS,11,8), 	/*NRO FACTURA/COMPROBANTE */
			SUBSTRING(CODIGO_BARRAS,4,2), 	/* TIPO COMPROBANTE */
			CASE WHEN SUBSTRING(CODIGO_BARRAS,6,1) = 0 THEN ''B'' 
				 ELSE ''A'' END, 	/* LETRA */
			SUBSTRING(CODIGO_BARRAS,7,4) 	/* PUNTO VENTA */
			FROM REC_DET_RECAUDOS_CANAL WHERE ID_CABEZAL = @ID_CABEZAL AND TZ_LOCK = 0;
			
			
			SELECT @TOTAL_CARGO_ESPECIFICO = SUM(TOTAL_CARGO_ESPECIFICO) FROM CONV_PADRONES P JOIN @TablaAuxNroFactura A
																		ON P.NRO_COMPROBANTE_CLIENTE = A.NRO_FACTURA
																		WHERE P.TZ_LOCK = 0
																		AND P.CONVENIO = @COD_ENTE AND P.TIPO_COMPROBANTE = A.TIPO_COMPROBANTE
																		AND P.LETRA = A.LETRA AND P.PUNTO_VENTA = A.PUNTO_VENTA
			RETURN @TOTAL_CARGO_ESPECIFICO;
		END
	END		
	ELSE
		BEGIN
			/* Obtener cargo especifico para Cobros por Caja (ope 2644) */
	
			SELECT @TOTAL_CARGO_ESPECIFICO = TOTAL_CARGO_ESPECIFICO, @ESTADO_PADRON = ESTADO FROM CONV_PADRONES WHERE
															NRO_COMPROBANTE_CLIENTE = @NRO_FACTURA_CAJA
															AND TZ_LOCK = 0
			RETURN @TOTAL_CARGO_ESPECIFICO;
		END

END
')

