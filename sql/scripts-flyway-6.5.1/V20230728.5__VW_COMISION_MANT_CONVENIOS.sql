
EXECUTE('
IF OBJECT_ID (''dbo.VW_COMISION_MANT_CONVENIOS'') IS NOT NULL
	DROP VIEW dbo.VW_COMISION_MANT_CONVENIOS
')

EXECUTE('
CREATE VIEW VW_COMISION_MANT_CONVENIOS (
		ID_CONVENIO,
		ID_TPO_CONVENIO,
		CLASE_CONVENIO,
		CODIGO_CLIENTE,
		JTS_OID_COBRO,
		SEGMENTO,
		MONEDA,
		USF,
		INMOVILIZADO,
		IVA,
		CREDEB_Condicion	,
		CREDEB_MULTA,
		CV_Remunerada)
AS
   SELECT DISTINCT * FROM (    
	SELECT distinct
		C.Id_ConvRec AS ID_CONVENIO,
		C.Id_TpoConv AS ID_TPO_CONVENIO,
		''RECAUDACIONES'' AS CLASE_CONVENIO,
		S.C1803 AS COD_CLIENTE,
		S.JTS_OID AS JTS_OID_COBRO,
		C.TpoConvSegM AS SEGMENTO,
		S.MONEDA AS MONEDA,
		L.USF AS USF,
		S.C1728 AS INMOVILIZADO,
		L.IVA AS IVA,
		S.CREDEB_Condicion AS CREDEB_Condicion,
		''N'' AS CREDEB_MULTA,
		CCR.ES_REMUNERADA AS CV_Remunerada 
	FROM CONV_CONVENIOS_REC AS C WITH (nolock)
	INNER JOIN SALDOS AS S WITH (nolock) ON
		C.CuentaCom = S.JTS_OID
	INNER JOIN CLI_CLIENTES AS L WITH (nolock) ON
		S.C1803 = L.CODIGOCLIENTE
		AND L.TZ_LOCK = 0
		
    INNER JOIN CON_CV_REMUNERADA AS CCR WITH (nolock) ON
        s.JTS_OID = ccr.JTS_OID_SALDOS
        AND CCR.TZ_LOCK = 0
	WHERE
		C.TZ_LOCK = 0
		AND c.Estado =''A''
	   	AND (SELECT FECHAPROCESO FROM PARAMETROS) = 
	   		(SELECT dbo.ULTIMODIAHABIL((SELECT FECHAPROCESO FROM PARAMETROS)))
	
	UNION ALL
	
	SELECT distinct
		C.ID_ConvPago AS ID_CONVENIO,
		C.Id_TpoConv AS ID_TPO_CONVENIO,
		''PAGOS'' AS CLASE_CONVENIO,
		S.C1803 AS COD_CLIENTE,
		S.JTS_OID AS JTS_OID_COBRO,
		C.SegmentoMen AS SEGMENTO,
		S.MONEDA AS MONEDA,
		L.USF AS USF,
		S.C1728 AS INMOVILIZADO,
		L.IVA AS IVA,
		S.CREDEB_Condicion AS CREDEB_Condicion,
		''N'' AS CREDEB_MULTA,
		CCR.ES_REMUNERADA AS CV_Remunerada		
	FROM CONV_CONVENIOS_PAG AS C WITH (nolock)
	INNER JOIN SALDOS AS S WITH (nolock) ON
		C.CuentaDeb = S.JTS_OID
	INNER JOIN CLI_CLIENTES AS L WITH (nolock) ON
		S.C1803 = L.CODIGOCLIENTE
		AND L.TZ_LOCK = 0
		
    INNER JOIN CON_CV_REMUNERADA AS CCR WITH (nolock) ON
        s.JTS_OID = ccr.JTS_OID_SALDOS
        AND CCR.TZ_LOCK = 0
	WHERE
		C.TZ_LOCK = 0
		AND c.Estado =''A''
	   	AND (SELECT FECHAPROCESO FROM PARAMETROS) = 
		  	(SELECT dbo.ULTIMODIAHABIL((SELECT FECHAPROCESO FROM PARAMETROS)))
    )X
')
