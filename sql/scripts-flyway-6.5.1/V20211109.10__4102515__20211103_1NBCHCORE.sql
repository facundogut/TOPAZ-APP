


-- Patch_NUNBCHACO_814

-- SQL - Crear PROCEDURE SP_ITF_ACTUALIZAR_RES_SALDOS
-- HM begin sentence 
CREATE PROCEDURE SP_ITF_ACTUALIZAR_RES_SALDOS  
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO smallint  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS 
   BEGIN

      DECLARE
         @V_CANTREGTOTAL numeric(12)

      BEGIN TRY

         SET @P_RET_PROCESO = NULL

         SET @P_MSG_PROCESO = NULL

         SET @P_RET_PROCESO = 1

         SELECT @V_CANTREGTOTAL = count_big(*)
         FROM dbo.ASIENTOS_A_PROCESAR  AS A, dbo.MOVIMIENTOS_CONTABLES  AS M
         WHERE 
            A.SUCURSAL = M.SUCURSAL AND 
            A.ASIENTO = M.ASIENTO AND 
            A.FECHAPROCESO = M.FECHAPROCESO AND 
            A.STATUS = 0 AND 
            (A.TZ_LOCK < 300000000000000 OR A.TZ_LOCK >= 400000000000000)

         IF @V_CANTREGTOTAL > 0
            UPDATE dbo.SALDOS
               SET 
                  SAL_MARCA_ACTUALIZAR = '1'
            WHERE 
               EXISTS 
                  (
                     SELECT *
                     FROM 
                        (
                           SELECT 
                              M.SUCURSAL, 
                              M.PRODUCTO, 
                              M.CUENTA, 
                              M.MONEDA, 
                              A.OPERACION, 
                              M.ORDINAL
                           FROM dbo.ASIENTOS_A_PROCESAR  AS A, dbo.MOVIMIENTOS_CONTABLES  AS M
                           WHERE 
                              A.SUCURSAL = M.SUCURSAL AND 
                              A.ASIENTO = M.ASIENTO AND 
                              A.FECHAPROCESO = M.FECHAPROCESO AND 
                              A.STATUS = 0 AND 
                              (A.TZ_LOCK < 300000000000000 OR A.TZ_LOCK >= 400000000000000)
                        )  AS il(
                        ilc, 
                        ilc2, 
                        ilc3, 
                        ilc4, 
                        ilc5, 
                        ilc6)
                     WHERE 
                        (il.ilc = ( SALDOS.SUCURSAL )) AND 
                        (il.ilc2 = ( SALDOS.PRODUCTO )) AND 
                        (il.ilc3 = ( SALDOS.CUENTA )) AND 
                        (il.ilc4 = ( SALDOS.MONEDA )) AND 
                        (il.ilc5 = ( SALDOS.OPERACION )) AND 
                        (il.ilc6 = ( SALDOS.ORDINAL ))
                  )
         SET @P_MSG_PROCESO = 'Resultado del Proceso:'

         SET @P_MSG_PROCESO = ISNULL(@P_MSG_PROCESO, '') + ISNULL(char(10), '') + 'Cantidad de Registros actualizados: ' + ISNULL(CAST(@V_CANTREGTOTAL AS varchar(max)), '')

         IF @@TRANCOUNT > 0
            COMMIT WORK 

      END TRY

      BEGIN CATCH

         DECLARE
            @errornumber int

         SET @errornumber = ERROR_NUMBER()

         DECLARE
            @errormessage nvarchar(4000)

         SET @errormessage = ERROR_MESSAGE()

         DECLARE
            @exceptionidentifier nvarchar(4000)

         SELECT @exceptionidentifier = 
            ssma_oracle.db_error_get_oracle_exception_id(@errormessage, @errornumber)

         BEGIN
            BEGIN

               DECLARE
                  @ERROR_CODE numeric(4) = 
                     ssma_oracle.db_error_sqlcode(@exceptionidentifier, @errornumber), 
                  @ERROR_MSG varchar(300) = 
                     ssma_oracle.db_error_sqlerrm_0(@exceptionidentifier, @errornumber), 
                  @BIGERRMSG varchar(4000)

               SET @BIGERRMSG = ISNULL(CONCAT(
                  ERROR_NUMBER(), 
                  ': at "', 
                  ERROR_PROCEDURE(), 
                  '", line ', 
                  ERROR_LINE()), '') + ISNULL(
                  ssma_oracle.db_error_sqlerrm_0(@exceptionidentifier, @errornumber), '')

               SET @P_RET_PROCESO = 2

               SET @P_MSG_PROCESO = ISNULL(CAST(@ERROR_CODE AS varchar(max)), '') + ISNULL(@ERROR_MSG, '') + ISNULL(@BIGERRMSG, '')

               EXECUTE dbo.PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
                  @P_ID_PROCESO = @P_ID_PROCESO, 
                  @P_FCH_PROCESO = @P_DT_PROCESO, 
                  @P_NOM_PACKAGE = 'SP_ITF_ACTUALIZAR_RES_SALDOS', 
                  @P_COD_ERROR = @P_RET_PROCESO, 
                  @P_MSG_ERROR = @P_MSG_PROCESO, 
                  @P_TIPO_ERROR = 'E'

               IF @@TRANCOUNT > 0
                  ROLLBACK WORK 
            END
         END

      END CATCH

   END
-- HM end sentence;




INSERT INTO BITACORA_HM (ACTUALIZACION,FECHA_APLICADO,TIPO_ACTUALIZACION,ESTADO,SCRIPT_SQL,SCRIPT_SQL_UNDO,ULT_SENTENCIA_OK)  VALUES ('20211103_1NBCH',NULL,'MANUAL','NO_DEFINIDO','CgoNCi0tIFBhdGNoX05VTkJDSEFDT184MTQKDQotLSBTUUwgLSBDcmVhciBQUk9DRURVUkUgU1Bf
SVRGX0FDVFVBTElaQVJfUkVTX1NBTERPUw0KLS0gSE0gYmVnaW4gc2VudGVuY2UgCkNSRUFURSBQ
Uk9DRURVUkUgU1BfSVRGX0FDVFVBTElaQVJfUkVTX1NBTERPUyAgCiAgIEBQX0lEX1BST0NFU08g
ZmxvYXQoNTMpLAogICBAUF9EVF9QUk9DRVNPIGRhdGV0aW1lMigwKSwKICAgQFBfUkVUX1BST0NF
U08gc21hbGxpbnQgIE9VVFBVVCwKICAgQFBfTVNHX1BST0NFU08gdmFyY2hhcihtYXgpICBPVVRQ
VVQKQVMgCiAgIEJFR0lOCgogICAgICBERUNMQVJFCiAgICAgICAgIEBWX0NBTlRSRUdUT1RBTCBu
dW1lcmljKDEyKQoKICAgICAgQkVHSU4gVFJZCgogICAgICAgICBTRVQgQFBfUkVUX1BST0NFU08g
PSBOVUxMCgogICAgICAgICBTRVQgQFBfTVNHX1BST0NFU08gPSBOVUxMCgogICAgICAgICBTRVQg
QFBfUkVUX1BST0NFU08gPSAxCgogICAgICAgICBTRUxFQ1QgQFZfQ0FOVFJFR1RPVEFMID0gY291
bnRfYmlnKCopCiAgICAgICAgIEZST00gZGJvLkFTSUVOVE9TX0FfUFJPQ0VTQVIgIEFTIEEsIGRi
by5NT1ZJTUlFTlRPU19DT05UQUJMRVMgIEFTIE0KICAgICAgICAgV0hFUkUgCiAgICAgICAgICAg
IEEuU1VDVVJTQUwgPSBNLlNVQ1VSU0FMIEFORCAKICAgICAgICAgICAgQS5BU0lFTlRPID0gTS5B
U0lFTlRPIEFORCAKICAgICAgICAgICAgQS5GRUNIQVBST0NFU08gPSBNLkZFQ0hBUFJPQ0VTTyBB
TkQgCiAgICAgICAgICAgIEEuU1RBVFVTID0gMCBBTkQgCiAgICAgICAgICAgIChBLlRaX0xPQ0sg
PCAzMDAwMDAwMDAwMDAwMDAgT1IgQS5UWl9MT0NLID49IDQwMDAwMDAwMDAwMDAwMCkKCiAgICAg
ICAgIElGIEBWX0NBTlRSRUdUT1RBTCA+IDAKICAgICAgICAgICAgVVBEQVRFIGRiby5TQUxET1MK
ICAgICAgICAgICAgICAgU0VUIAogICAgICAgICAgICAgICAgICBTQUxfTUFSQ0FfQUNUVUFMSVpB
UiA9ICcxJwogICAgICAgICAgICBXSEVSRSAKICAgICAgICAgICAgICAgRVhJU1RTIAogICAgICAg
ICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgIFNFTEVDVCAqCiAgICAgICAgICAgICAg
ICAgICAgIEZST00gCiAgICAgICAgICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAg
ICAgICAgICAgU0VMRUNUIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNLlNVQ1VSU0FM
LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTS5QUk9EVUNUTywgCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIE0uQ1VFTlRBLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgTS5NT05FREEsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBLk9QRVJBQ0lPTiwg
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE0uT1JESU5BTAogICAgICAgICAgICAgICAg
ICAgICAgICAgICBGUk9NIGRiby5BU0lFTlRPU19BX1BST0NFU0FSICBBUyBBLCBkYm8uTU9WSU1J
RU5UT1NfQ09OVEFCTEVTICBBUyBNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIFdIRVJFIAog
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBLlNVQ1VSU0FMID0gTS5TVUNVUlNBTCBBTkQg
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEEuQVNJRU5UTyA9IE0uQVNJRU5UTyBBTkQg
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEEuRkVDSEFQUk9DRVNPID0gTS5GRUNIQVBS
T0NFU08gQU5EIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBLlNUQVRVUyA9IDAgQU5E
IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoQS5UWl9MT0NLIDwgMzAwMDAwMDAwMDAw
MDAwIE9SIEEuVFpfTE9DSyA+PSA0MDAwMDAwMDAwMDAwMDApCiAgICAgICAgICAgICAgICAgICAg
ICAgICkgIEFTIGlsKAogICAgICAgICAgICAgICAgICAgICAgICBpbGMsIAogICAgICAgICAgICAg
ICAgICAgICAgICBpbGMyLCAKICAgICAgICAgICAgICAgICAgICAgICAgaWxjMywgCiAgICAgICAg
ICAgICAgICAgICAgICAgIGlsYzQsIAogICAgICAgICAgICAgICAgICAgICAgICBpbGM1LCAKICAg
ICAgICAgICAgICAgICAgICAgICAgaWxjNikKICAgICAgICAgICAgICAgICAgICAgV0hFUkUgCiAg
ICAgICAgICAgICAgICAgICAgICAgIChpbC5pbGMgPSAoIFNBTERPUy5TVUNVUlNBTCApKSBBTkQg
CiAgICAgICAgICAgICAgICAgICAgICAgIChpbC5pbGMyID0gKCBTQUxET1MuUFJPRFVDVE8gKSkg
QU5EIAogICAgICAgICAgICAgICAgICAgICAgICAoaWwuaWxjMyA9ICggU0FMRE9TLkNVRU5UQSAp
KSBBTkQgCiAgICAgICAgICAgICAgICAgICAgICAgIChpbC5pbGM0ID0gKCBTQUxET1MuTU9ORURB
ICkpIEFORCAKICAgICAgICAgICAgICAgICAgICAgICAgKGlsLmlsYzUgPSAoIFNBTERPUy5PUEVS
QUNJT04gKSkgQU5EIAogICAgICAgICAgICAgICAgICAgICAgICAoaWwuaWxjNiA9ICggU0FMRE9T
Lk9SRElOQUwgKSkKICAgICAgICAgICAgICAgICAgKQogICAgICAgICBTRVQgQFBfTVNHX1BST0NF
U08gPSAnUmVzdWx0YWRvIGRlbCBQcm9jZXNvOicKCiAgICAgICAgIFNFVCBAUF9NU0dfUFJPQ0VT
TyA9IElTTlVMTChAUF9NU0dfUFJPQ0VTTywgJycpICsgSVNOVUxMKGNoYXIoMTApLCAnJykgKyAn
Q2FudGlkYWQgZGUgUmVnaXN0cm9zIGFjdHVhbGl6YWRvczogJyArIElTTlVMTChDQVNUKEBWX0NB
TlRSRUdUT1RBTCBBUyB2YXJjaGFyKG1heCkpLCAnJykKCiAgICAgICAgIElGIEBAVFJBTkNPVU5U
ID4gMAogICAgICAgICAgICBDT01NSVQgV09SSyAKCiAgICAgIEVORCBUUlkKCiAgICAgIEJFR0lO
IENBVENICgogICAgICAgICBERUNMQVJFCiAgICAgICAgICAgIEBlcnJvcm51bWJlciBpbnQKCiAg
ICAgICAgIFNFVCBAZXJyb3JudW1iZXIgPSBFUlJPUl9OVU1CRVIoKQoKICAgICAgICAgREVDTEFS
RQogICAgICAgICAgICBAZXJyb3JtZXNzYWdlIG52YXJjaGFyKDQwMDApCgogICAgICAgICBTRVQg
QGVycm9ybWVzc2FnZSA9IEVSUk9SX01FU1NBR0UoKQoKICAgICAgICAgREVDTEFSRQogICAgICAg
ICAgICBAZXhjZXB0aW9uaWRlbnRpZmllciBudmFyY2hhcig0MDAwKQoKICAgICAgICAgU0VMRUNU
IEBleGNlcHRpb25pZGVudGlmaWVyID0gCiAgICAgICAgICAgIHNzbWFfb3JhY2xlLmRiX2Vycm9y
X2dldF9vcmFjbGVfZXhjZXB0aW9uX2lkKEBlcnJvcm1lc3NhZ2UsIEBlcnJvcm51bWJlcikKCiAg
ICAgICAgIEJFR0lOCiAgICAgICAgICAgIEJFR0lOCgogICAgICAgICAgICAgICBERUNMQVJFCiAg
ICAgICAgICAgICAgICAgIEBFUlJPUl9DT0RFIG51bWVyaWMoNCkgPSAKICAgICAgICAgICAgICAg
ICAgICAgc3NtYV9vcmFjbGUuZGJfZXJyb3Jfc3FsY29kZShAZXhjZXB0aW9uaWRlbnRpZmllciwg
QGVycm9ybnVtYmVyKSwgCiAgICAgICAgICAgICAgICAgIEBFUlJPUl9NU0cgdmFyY2hhcigzMDAp
ID0gCiAgICAgICAgICAgICAgICAgICAgIHNzbWFfb3JhY2xlLmRiX2Vycm9yX3NxbGVycm1fMChA
ZXhjZXB0aW9uaWRlbnRpZmllciwgQGVycm9ybnVtYmVyKSwgCiAgICAgICAgICAgICAgICAgIEBC
SUdFUlJNU0cgdmFyY2hhcig0MDAwKQoKICAgICAgICAgICAgICAgU0VUIEBCSUdFUlJNU0cgPSBJ
U05VTEwoQ09OQ0FUKAogICAgICAgICAgICAgICAgICBFUlJPUl9OVU1CRVIoKSwgCiAgICAgICAg
ICAgICAgICAgICc6IGF0ICInLCAKICAgICAgICAgICAgICAgICAgRVJST1JfUFJPQ0VEVVJFKCks
IAogICAgICAgICAgICAgICAgICAnIiwgbGluZSAnLCAKICAgICAgICAgICAgICAgICAgRVJST1Jf
TElORSgpKSwgJycpICsgSVNOVUxMKAogICAgICAgICAgICAgICAgICBzc21hX29yYWNsZS5kYl9l
cnJvcl9zcWxlcnJtXzAoQGV4Y2VwdGlvbmlkZW50aWZpZXIsIEBlcnJvcm51bWJlciksICcnKQoK
ICAgICAgICAgICAgICAgU0VUIEBQX1JFVF9QUk9DRVNPID0gMgoKICAgICAgICAgICAgICAgU0VU
IEBQX01TR19QUk9DRVNPID0gSVNOVUxMKENBU1QoQEVSUk9SX0NPREUgQVMgdmFyY2hhcihtYXgp
KSwgJycpICsgSVNOVUxMKEBFUlJPUl9NU0csICcnKSArIElTTlVMTChAQklHRVJSTVNHLCAnJykK
CiAgICAgICAgICAgICAgIEVYRUNVVEUgZGJvLlBLR19MT0dfUFJPQ0VTTyRQUk9DX0lOU19MT0df
UFJPQ0VTTyAKICAgICAgICAgICAgICAgICAgQFBfSURfUFJPQ0VTTyA9IEBQX0lEX1BST0NFU08s
IAogICAgICAgICAgICAgICAgICBAUF9GQ0hfUFJPQ0VTTyA9IEBQX0RUX1BST0NFU08sIAogICAg
ICAgICAgICAgICAgICBAUF9OT01fUEFDS0FHRSA9ICdTUF9JVEZfQUNUVUFMSVpBUl9SRVNfU0FM
RE9TJywgCiAgICAgICAgICAgICAgICAgIEBQX0NPRF9FUlJPUiA9IEBQX1JFVF9QUk9DRVNPLCAK
ICAgICAgICAgICAgICAgICAgQFBfTVNHX0VSUk9SID0gQFBfTVNHX1BST0NFU08sIAogICAgICAg
ICAgICAgICAgICBAUF9USVBPX0VSUk9SID0gJ0UnCgogICAgICAgICAgICAgICBJRiBAQFRSQU5D
T1VOVCA+IDAKICAgICAgICAgICAgICAgICAgUk9MTEJBQ0sgV09SSyAKICAgICAgICAgICAgRU5E
CiAgICAgICAgIEVORAoKICAgICAgRU5EIENBVENICgogICBFTkQKLS0gSE0gZW5kIHNlbnRlbmNl
OwoNCgoKDQo=', NULL, 0);
