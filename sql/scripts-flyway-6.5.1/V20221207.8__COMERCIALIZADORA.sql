EXECUTE('
IF OBJECT_ID (''dbo.VW_SOL_COMERCIALIZADORAS'') IS NOT NULL
	DROP VIEW dbo.VW_SOL_COMERCIALIZADORAS
')

EXECUTE('
CREATE VIEW dbo.VW_SOL_COMERCIALIZADORAS AS (
SELECT ''P'' AS TIPO, sol.SUCURSAL, suc.NOMBRESUCURSAL, sol.NROSOLICITUD, sol.FECHASOLIC, sol.TIPODOCUM, sol.NRODOCUM,
0 AS NUMEROCUOTAS, 0 AS MONTO_APROB,sol.FECHASOLIC AS FECHALIQ, sol.USU_INGRESA, 
ISNULL(pag.ID_ConvPago,0) AS ID_COMERCIALIZADORA,
ISNULL(pag.NomConvPago, ''Sin Comercializadora'') AS COMERCIALIZADORA,
CONVERT(VARCHAR(5),prod.C6252) + '' - '' + op.DESCRIPCION AS TIPOPRODUCTO, prod.C6800 + '' - '' + op2.DESCRIPCION 
AS CLASIFICACION, prod.C6800 AS ID_CLASIFICACION,
prod.C6283 AS FAMILIA,
sol.PRODUCTO, prod.C6251 AS DESC_PROD,
sol.CLIENTE
FROM SOLICAPERTCTAVISTA sol WITH(NOLOCK)
INNER JOIN PRODUCTOS prod WITH(NOLOCK) ON sol.PRODUCTO = prod.C6250
INNER JOIN SUCURSALES suc WITH(NOLOCK) ON suc.SUCURSAL = sol.SUCURSAL
INNER JOIN VW_GRUPO_USUARIOS gru WITH(NOLOCK) ON sol.USU_INGRESA = gru.USUARIO
INNER JOIN CONV_CONVENIOS_PAG pag WITH(NOLOCK) ON pag.Grupo_Seguridad = gru.GRUPO AND pag.Id_TpoConv = 6
LEFT JOIN OPCIONES op WITH(NOLOCK) ON op.IDIOMA=''E'' AND op.OPCIONINTERNA = prod.C6252 AND op.NUMERODECAMPO = 6252
LEFT JOIN OPCIONES op2 WITH(NOLOCK) ON op2.IDIOMA=''E'' AND op2.OPCIONINTERNA = prod.C6800 AND op2.NUMERODECAMPO = 6800
WHERE sol.ESTADO = ''A''
GROUP BY sol.SUCURSAL, sol.NROSOLICITUD, sol.FECHASOLIC, sol.TIPODOCUM, sol.NRODOCUM,
sol.USU_INGRESA, pag.NomConvPago, prod.C6252, prod.C6800, prod.C6283, sol.PRODUCTO, op.DESCRIPCION, op2.DESCRIPCION,
pag.ID_ConvPago, sol.CLIENTE,suc.NOMBRESUCURSAL, prod.C6251
UNION ALL
SELECT ''A'' AS TIPO, sol.CODIGOSUCURSAL, suc.NOMBRESUCURSAL, sol.NUMEROSOLICITUD, sol.FECHARECEPCIONSOLICITUD,
sol.TIPODOCUMENTO, sol.NUMERODOCUMENTO, sol.NROCUOTASAPROBADAS,
sol.MONTOAPROBADO, sol.FECHADESEMBOLSO, sol.USUARIOINGRESOSOLICITUD,
ISNULL(pag.ID_ConvPago,0) AS ID_COMERCIALIZADORA,
ISNULL(pag.NomConvPago, ''Sin Comercializadora'') AS COMERCIALIZADORA,
CONVERT(VARCHAR(5),prod.C6252) + '' - '' + op.DESCRIPCION AS TIPOPRODUCTO, prod.C6800 + '' - '' + op2.DESCRIPCION 
AS CLASIFICACION, prod.C6800 AS ID_CLASIFICACION,
prod.C6283 AS FAMILIA,
sol.CODPRODUCTOSOLICITADO AS PRODUCTO, prod.C6251 AS DESC_PROD,
sol.CLIENTE
FROM CRE_SOLICITUDCREDITO sol WITH(NOLOCK)
INNER JOIN PRODUCTOS prod WITH(NOLOCK) ON prod.C6250 = sol.CODPRODUCTOSOLICITADO
INNER JOIN SUCURSALES suc WITH(NOLOCK) ON suc.SUCURSAL = sol.CODIGOSUCURSAL
INNER JOIN VW_GRUPO_USUARIOS gru WITH(NOLOCK) ON sol.USUARIOINGRESOSOLICITUD = gru.USUARIO
INNER JOIN CONV_CONVENIOS_PAG pag WITH(NOLOCK) ON pag.Grupo_Seguridad = gru.GRUPO AND pag.Id_TpoConv = 6
LEFT JOIN OPCIONES op WITH(NOLOCK) ON op.IDIOMA=''E'' AND op.OPCIONINTERNA = prod.C6252 AND op.NUMERODECAMPO = 6252
LEFT JOIN OPCIONES op2 WITH(NOLOCK) ON op2.IDIOMA=''E'' AND op2.OPCIONINTERNA = prod.C6800 AND op2.NUMERODECAMPO = 6800
WHERE sol.ESTADOSOLICITUD IN (22,23)
GROUP BY sol.CODIGOSUCURSAL, sol.NUMEROSOLICITUD, sol.FECHARECEPCIONSOLICITUD,
sol.TIPODOCUMENTO, sol.NUMERODOCUMENTO, sol.NROCUOTASAPROBADAS,
sol.MONTOAPROBADO, sol.FECHADESEMBOLSO, sol.USUARIOINGRESOSOLICITUD, pag.NomConvPago,
prod.C6252, prod.C6800, prod.C6283, sol.CODPRODUCTOSOLICITADO, op.DESCRIPCION, op2.DESCRIPCION,
pag.ID_ConvPago, sol.CLIENTE, suc.NOMBRESUCURSAL, prod.C6251
)
')

