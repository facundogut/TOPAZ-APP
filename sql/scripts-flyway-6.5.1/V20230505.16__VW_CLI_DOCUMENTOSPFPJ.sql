EXECUTE('IF OBJECT_ID (''VW_CLI_DOCUMENTOSPFPJ'') IS NOT NULL
	DROP VIEW VW_CLI_DOCUMENTOSPFPJ')

EXECUTE('
CREATE     VIEW [VW_CLI_DOCUMENTOSPFPJ] (
												TZ_LOCK, 
												NUMEROPERSONAFJ, 
												TIPODOCUMENTO, 
												NUMERODOCUMENTO, 
												PAISDOCUMENTO, 
												FECHAPRESENTACION, 
												FECHAVENCIMIENTO, 
												REPORTAAORGANISMOCONTROL, 
												TIPOPERSONA)
AS 
   SELECT 
      CLI_DOCUMENTOSPFPJ.TZ_LOCK, 
      CLI_DOCUMENTOSPFPJ.NUMEROPERSONAFJ, 
      CLI_DOCUMENTOSPFPJ.TIPODOCUMENTO, 
      CLI_DOCUMENTOSPFPJ.NUMERODOCUMENTO, 
      CLI_DOCUMENTOSPFPJ.PAISDOCUMENTO, 
      CLI_DOCUMENTOSPFPJ.FECHAPRESENTACION, 
      CLI_DOCUMENTOSPFPJ.FECHAVENCIMIENTO, 
      CLI_DOCUMENTOSPFPJ.REPORTAAORGANISMOCONTROL, 
      CLI_DOCUMENTOSPFPJ.TIPOPERSONA
   FROM CLI_DOCUMENTOSPFPJ WITH(NOLOCK)
   WHERE 
      (		(CLI_DOCUMENTOSPFPJ.TZ_LOCK < 300000000000000 OR CLI_DOCUMENTOSPFPJ.TZ_LOCK >= 400000000000000) 
	  AND	(CLI_DOCUMENTOSPFPJ.TZ_LOCK < 100000000000000 OR CLI_DOCUMENTOSPFPJ.TZ_LOCK >= 200000000000000)) AND 
      CLI_DOCUMENTOSPFPJ.TIPOPERSONA = ''F'' AND 
      CLI_DOCUMENTOSPFPJ.TIPODOCUMENTO = ''IDE''
    UNION ALL
   SELECT 
      CLI_DOCUMENTOSPFPJ.TZ_LOCK, 
      CLI_DOCUMENTOSPFPJ.NUMEROPERSONAFJ, 
      CLI_DOCUMENTOSPFPJ.TIPODOCUMENTO, 
      CLI_DOCUMENTOSPFPJ.NUMERODOCUMENTO, 
      CLI_DOCUMENTOSPFPJ.PAISDOCUMENTO, 
      CLI_DOCUMENTOSPFPJ.FECHAPRESENTACION, 
      CLI_DOCUMENTOSPFPJ.FECHAVENCIMIENTO, 
      CLI_DOCUMENTOSPFPJ.REPORTAAORGANISMOCONTROL, 
      CLI_DOCUMENTOSPFPJ.TIPOPERSONA
   FROM CLI_DOCUMENTOSPFPJ  WITH(NOLOCK)
   WHERE 
      (		(CLI_DOCUMENTOSPFPJ.TZ_LOCK < 300000000000000 OR CLI_DOCUMENTOSPFPJ.TZ_LOCK >= 400000000000000) 
		AND (CLI_DOCUMENTOSPFPJ.TZ_LOCK < 100000000000000 OR CLI_DOCUMENTOSPFPJ.TZ_LOCK >= 200000000000000)) AND 
      CLI_DOCUMENTOSPFPJ.TIPOPERSONA = ''J'' AND 
      CLI_DOCUMENTOSPFPJ.TIPODOCUMENTO = ''RUC''
    UNION ALL
   SELECT 
      D0.TZ_LOCK, 
      D0.NUMEROPERSONAFJ, 
      D0.TIPODOCUMENTO, 
      D0.NUMERODOCUMENTO, 
      D0.PAISDOCUMENTO, 
      D0.FECHAPRESENTACION, 
      D0.FECHAVENCIMIENTO, 
      D0.REPORTAAORGANISMOCONTROL, 
      D0.TIPOPERSONA
   FROM CLI_DOCUMENTOSPFPJ  AS D0  WITH(NOLOCK)
   WHERE EXISTS 
      (
         SELECT fci.NUMEROPERSONAFJ1, fci.TIPODOCUMENTO1
         FROM 
            (
               SELECT	D.NUMEROPERSONAFJ AS NUMEROPERSONAFJ1, 
						max(D.TIPODOCUMENTO) AS TIPODOCUMENTO1
               FROM CLI_DOCUMENTOSPFPJ  AS D  WITH(NOLOCK)
               WHERE 
                  (		(D.TZ_LOCK < 300000000000000 OR D.TZ_LOCK >= 400000000000000) 
					AND (D.TZ_LOCK < 100000000000000 OR D.TZ_LOCK >= 200000000000000)) AND 
                  D.TIPOPERSONA = ''F'' AND 
                  NOT EXISTS 
                  (
                     SELECT 
                        D1.TZ_LOCK, 
                        D1.NUMEROPERSONAFJ, 
                        D1.TIPODOCUMENTO, 
                        D1.NUMERODOCUMENTO, 
                        D1.PAISDOCUMENTO, 
                        D1.FECHAPRESENTACION, 
                        D1.FECHAVENCIMIENTO, 
                        D1.REPORTAAORGANISMOCONTROL, 
                        D1.TIPOPERSONA
                     FROM CLI_DOCUMENTOSPFPJ  AS D1  WITH(NOLOCK)
                     WHERE 
                        (		(D1.TZ_LOCK < 300000000000000 OR D1.TZ_LOCK >= 400000000000000) 
							AND (D1.TZ_LOCK < 100000000000000 OR D1.TZ_LOCK >= 200000000000000)) AND 
                        D1.TIPOPERSONA = ''F'' AND 
                        D1.TIPODOCUMENTO = ''IDE'' AND 
                        D.NUMEROPERSONAFJ = D1.NUMEROPERSONAFJ
                  )
               GROUP BY D.NUMEROPERSONAFJ
            )  AS fci
         WHERE D0.TIPODOCUMENTO = fci.TIPODOCUMENTO1 
			AND D0.NUMEROPERSONAFJ = fci.NUMEROPERSONAFJ1
      )
    UNION ALL
   SELECT 
      D0.TZ_LOCK, 
      D0.NUMEROPERSONAFJ, 
      D0.TIPODOCUMENTO, 
      D0.NUMERODOCUMENTO, 
      D0.PAISDOCUMENTO, 
      D0.FECHAPRESENTACION, 
      D0.FECHAVENCIMIENTO, 
      D0.REPORTAAORGANISMOCONTROL, 
      D0.TIPOPERSONA
   FROM CLI_DOCUMENTOSPFPJ  AS D0  WITH(NOLOCK)
   WHERE EXISTS 
      (
         SELECT fci.NUMEROPERSONAFJ1, fci.TIPODOCUMENTO1
         FROM 
            (
               SELECT D.NUMEROPERSONAFJ AS NUMEROPERSONAFJ1, 
					max(D.TIPODOCUMENTO) AS TIPODOCUMENTO1
               FROM CLI_DOCUMENTOSPFPJ  AS D  WITH(NOLOCK)
               WHERE 
                  (		(D.TZ_LOCK < 300000000000000 OR D.TZ_LOCK >= 400000000000000) 
					AND (D.TZ_LOCK < 100000000000000 OR D.TZ_LOCK >= 200000000000000)) AND 
                  D.TIPOPERSONA = ''J'' AND 
                  NOT EXISTS 
                  (
                     SELECT 
                        D1.TZ_LOCK, 
                        D1.NUMEROPERSONAFJ, 
                        D1.TIPODOCUMENTO, 
                        D1.NUMERODOCUMENTO, 
                        D1.PAISDOCUMENTO, 
                        D1.FECHAPRESENTACION, 
                        D1.FECHAVENCIMIENTO, 
                        D1.REPORTAAORGANISMOCONTROL, 
                        D1.TIPOPERSONA
                     FROM CLI_DOCUMENTOSPFPJ  AS D1  WITH(NOLOCK)
                     WHERE 
                        (	(D1.TZ_LOCK < 300000000000000 OR D1.TZ_LOCK >= 400000000000000) 
						AND (D1.TZ_LOCK < 100000000000000 OR D1.TZ_LOCK >= 200000000000000)) AND 
                        D1.TIPOPERSONA = ''J'' AND 
                        D1.TIPODOCUMENTO = ''RUC'' AND 
                        D.NUMEROPERSONAFJ = D1.NUMEROPERSONAFJ
                  )
               GROUP BY D.NUMEROPERSONAFJ
            )  AS fci
         WHERE D0.TIPODOCUMENTO = fci.TIPODOCUMENTO1 
			AND D0.NUMEROPERSONAFJ = fci.NUMEROPERSONAFJ1
      ) ')





