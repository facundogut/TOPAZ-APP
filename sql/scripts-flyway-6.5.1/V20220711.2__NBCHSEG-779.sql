Execute('

ALTER PROCEDURE [dbo].[SP_LINK_MOV_CONFORMADOS] 
	@fch_chr AS VARCHAR(10)
AS
BEGIN
	DECLARE @fch_proceso DATETIME;
	
	TRUNCATE TABLE ITF_LINK_MOVCONFORMADOS;
	
	SET @fch_proceso  = (CASE WHEN CONVERT(datetime, @fch_chr, 101)=CONVERT(datetime, ''1800-01-01'', 101) THEN (SELECT FECHAPROCESOANTERIOR FROM PARAMETROS WITH(NOLOCK)) WHEN TRY_CONVERT(DATETIME, @fch_chr) IS NOT NULL THEN CONVERT(datetime, @fch_chr, 101) ELSE (SELECT FECHAPROCESOANTERIOR FROM PARAMETROS WITH(NOLOCK)) END); -- 18000101 20240828
	
	INSERT INTO ITF_LINK_MOVCONFORMADOS (tipo_registro, banco, tipo_cuenta, moneda, cuenta, cbu, fecha_mov, fecha_valor, deb_cred, monto, secuencia, referencia, fecha_proceso, depositante, jts_oid, secuencia_gral,horafin, cant_registros) 
	
	SELECT  
		LEFT(''CONFOR'', 6) AS ''Tipo_registro'' ,
		LEFT((SELECT NUMERICO FROM PARAMETROSGENERALES WITH (NOLOCK) WHERE [CODIGO] = 2), 3) AS ''Banco'',
		
		ISNULL((SELECT TOP 1 CAST(IMPORTE_1 AS NUMERIC) FROM ITF_MASTER_PARAMETROS WITH(NOLOCK) WHERE CODIGO_INTERFACE = 10 AND (NUMERICO_1 IS NULL OR NUMERICO_1 = s.PRODUCTO) AND NUMERICO_2 = s.MONEDA), 
		CASE WHEN s.MONEDA = 1 THEN ''1''
			WHEN ''I'' = (SELECT C6403 FROM MONEDAS WHERE C6399=s.MONEDA AND TZ_LOCK=0) THEN ''1'' ELSE ''2'' END) AS ''Tipo_cuenta'',
		 
	    (CASE WHEN s.MONEDA = 1 THEN ''00'' 
	    	  WHEN s.MONEDA = 988 THEN ''00'' 
	    	  WHEN s.MONEDA = 999 THEN ''00'' 
	    	  WHEN s.MONEDA = 2 THEN ''01'' END) AS ''MONEDA'',

		RIGHT(concat(REPLICATE(''0'', 19), CAST(vt.CTA_REDLINK AS VARCHAR(19))), 19) AS ''cuenta'',
		
		RIGHT(concat(REPLICATE('' '', 22), vt.CTA_CBU), 22) AS ''cbu'', 
		
	    LEFT(convert(varchar, hv.FECHA_PROCESADO, 112), 8) AS ''Fecha-mov'',
	    
		LEFT(convert(varchar, hv.FECHA_VALOR, 112), 8) AS ''Fecha-valor'',
		
		LEFT(hv.DEBITO_CREDITO, 1) AS ''Tipo de operaci√≥n'',
		
		RIGHT(concat(REPLICATE(''0'', 17), CAST(floor((hv.MONTO*100)) AS VARCHAR(17))), 17) AS ''Monto'',
		
		RIGHT(concat(REPLICATE(''0'', 4), ROW_NUMBER() OVER (PARTITION BY  s.JTS_OID ORDER BY s.JTS_OID ASC, ai.HORAFIN ASC, hv.MOV_JTS_OID ASC)), 4) AS ''secuencia'',
		
	    RIGHT(concat(REPLICATE(''0'', 13), CAST(hv.ASIENTO AS VARCHAR(13))), 13) AS  ''referencia'',
	    
	    @fch_chr AS ''fecha_proceso'',
		
	    RIGHT((CASE 
	    	WHEN hv.DEBITO_CREDITO = ''C'' AND 0<(SELECT COUNT(*) FROM CON_ASIENTOS_EXTORNADOS ax WHERE ax.asiento=hv.ASIENTO AND ax.sucursal=hv.SUCURSAL AND ax.fechaproceso=hv.FECHA_PROCESADO ) THEN concat(''EXTORNO- CRED.TRANSF.ID '', vc.NUMERODOC, '' '', ISNULL(vc.NOMBRE, '''')) 
	  		WHEN hv.DEBITO_CREDITO = ''D'' AND 0<(SELECT COUNT(*) FROM CON_ASIENTOS_EXTORNADOS ax WHERE ax.asiento=hv.ASIENTO AND ax.sucursal=hv.SUCURSAL AND ax.fechaproceso=hv.FECHA_PROCESADO ) THEN CONCAT(''EXTORNO- '',hv.CONCEPTO)
			WHEN hv.DEBITO_CREDITO = ''C'' THEN concat(''CRED.TRANSF.ID '', vc.NUMERODOC, '' '', ISNULL(vc.NOMBRE, '''')) 
	  		WHEN hv.DEBITO_CREDITO = ''D'' THEN hv.CONCEPTO
	  		END), 150)  AS ''depositante'',
	  	 
	  	 s.JTS_OID AS ''jts_oid'',
	  	 
	  	 ROW_NUMBER() OVER (ORDER BY s.CUENTA) AS ''secuencia_gral'',
	  	 
	  	 ai.HORAFIN,
	  	 
	  	 (SELECT COUNT(*) FROM ITF_LINK_MOVCONFORMADOS) AS ''cant_registros''
	  
		FROM HISTORIA_VISTA hv WITH (NOLOCK)
		--LEFT JOIN ( SELECT * FROM ASIENTOS_EXTORNADOS AE WHERE TZ_LOCK=0) AS AE ON hv.ASIENTO = AE.ASIENTO

		JOIN SALDOS s WITH (NOLOCK) ON s.JTS_OID = hv.SALDO_JTS_OID AND s.C1785 IN (2, 3) AND s.C1651 <> 1 AND s.MONEDA IN (1, 2, 988, 999) AND s.TZ_LOCK = 0 
		
		JOIN ASIENTOS ai WITH (NOLOCK) ON hv.ASIENTO=ai.ASIENTO AND hv.SUCURSAL=ai.SUCURSAL AND hv.FECHA_PROCESADO=ai.FECHAPROCESO
		
		JOIN PRODUCTOS p WITH(NOLOCK) ON p.C6250 = s.PRODUCTO AND p.TZ_LOCK = 0
		
		JOIN PROD_RELCANALES pr WITH (NOLOCK) ON pr.PRODUCTO = s.PRODUCTO AND pr.MONEDA = s.MONEDA AND pr.CANAL = 3 AND pr.HABILITADO = ''S'' AND pr.TZ_LOCK = 0
		
		JOIN VW_CLIENTES_PERSONAS vc WITH (NOLOCK) ON vc.CODIGOCLIENTE = s.C1803 AND vc.TITULARIDAD = ''T''
	
		JOIN CLI_CLIENTES c WITH (NOLOCK) ON c.CODIGOCLIENTE = s.C1803 AND c.SUBDIVISION1 <> ''02'' AND c.TZ_LOCK = 0
		
		JOIN VTA_SALDOS vt WITH (NOLOCK) ON vt.JTS_OID_SALDO = s.JTS_OID AND vt.TZ_LOCK = 0
		
		WHERE hv.FECHA_PROCESADO = (CASE WHEN @fch_proceso IS NULL THEN (SELECT FECHAPROCESOANTERIOR FROM PARAMETROS) ELSE @fch_proceso END) AND
		EXISTS (SELECT TOP 1 * FROM VW_ASIENTOS_SIN_EXTORNO_DIA ad WITH (NOLOCK) WHERE hv.ASIENTO=ad.ASIENTO AND hv.SUCURSAL=ad.SUCURSAL AND hv.FECHA_PROCESADO=ad.FECHAPROCESO) 
		--AE.ASIENTO IS NULL
		ORDER BY  s.SUCURSAL ASC,s.CUENTA ASC, s.JTS_OID ASC, ai.HORAFIN ASC, secuencia ASC
END

')


