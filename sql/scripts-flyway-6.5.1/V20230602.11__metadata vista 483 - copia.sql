EXECUTE('
IF OBJECT_ID (''VW_CAJ_CAJAS_NRO_CAJA_0'') IS NOT NULL
	DROP VIEW VW_CAJ_CAJAS_NRO_CAJA_0
')

EXECUTE('
CREATE    VIEW [VW_CAJ_CAJAS_NRO_CAJA_0] 
AS
SELECT 
	u.NRODECAJA ''NRO_CAJA'', 
	u.CLAVE ''USUARIO'',
	u.INICIALES ''INICIALES'',
	u.NOMBRE ''NOMBRE'', 
	(CASE 
		WHEN c.ESTADO = ''A'' THEN ''Abierta''
		ELSE ''Cerrada''
	END) AS ESTADO,
	c.SUCURSAL,
	(CASE WHEN cc.Mini_Filial IS NULL THEN ''0''
	ELSE CONVERT(varchar(3),cc.Mini_Filial)
	END) AS ''MINIFILIAL'',
	CASE WHEN c.nro_Caja<>999 THEN cc.Descripcion ELSE c.descripcion END AS ''DESCRIPCION''
FROM TABLA_CAJAS c WITH(NOLOCK)
INNER JOIN USUARIOS u WITH(NOLOCK) ON (c.NRO_CAJA = u.NRODECAJA OR u.NRODECAJA = 0)
						AND c.SUCURSAL=u.NROSUCURSAL 
						AND
							(	(c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) 	
							AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000)) 
						AND(	(u.TZ_LOCK < 300000000000000 OR u.TZ_LOCK >= 400000000000000) 	
						AND		(u.TZ_LOCK < 100000000000000 OR u.TZ_LOCK >= 200000000000000))
LEFT JOIN CAJ_MiniFiliales cc WITH(NOLOCK) ON cc.SUCURSAL = c.SUCURSAL 
								AND cc.Mini_Filial IN(	SELECT cm.Mini_Filial 
														from CAJ_Cajas_MiniFiliales cm WITH(NOLOCK)
														WHERE cm.Mini_Filial = cc.Mini_Filial 
															AND cm.NRO_CAJA = c.NRO_CAJA 
															AND (	(cm.TZ_LOCK < 300000000000000 OR cm.TZ_LOCK >= 400000000000000) 
																AND (cm.TZ_LOCK < 100000000000000 OR cm.TZ_LOCK >= 200000000000000))
														)
')