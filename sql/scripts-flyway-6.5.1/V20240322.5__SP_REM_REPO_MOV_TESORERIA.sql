EXECUTE('
CREATE OR ALTER PROCEDURE SP_REM_REPO_MOV_TESORERIA
   @P_FECHA_SALDO DATETIME,
   
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
      
AS 

   BEGIN

      SET @P_RET_PROCESO = NULL
      SET @P_MSG_PROCESO = NULL
      
      DECLARE

         @FECHA DATETIME,
         @FECHA_ANTERIOR DATETIME,
         @CANT NUMERIC(5),
         @row_number NUMERIC(6),
         @v_constante VARCHAR(1),
         @v_numerador NUMERIC,
         @v_correlativo NUMERIC(10)
         
      
      --DECLARO TABLA AUXILIAR--
	  DECLARE @Tabla_SP_REM_REPO_MOV_TESORERIA  TABLE(
	  	NRO_SOLICITUD NUMERIC (6, 0),
		TIPOORIGEN NUMERIC (3, 0), 
      	ORIGEN VARCHAR(255), 
      	SUCURSAL_ORIGEN VARCHAR(50), 
      	TIPODESTINO NUMERIC (3, 0),
      	DESTINO VARCHAR(254),
      	SUCURSAL_DESTINO VARCHAR(50),
      	DEBE NUMERIC (14, 2),
      	HABER NUMERIC (14, 2),
      	MONEDA NUMERIC (4, 0),
      	DESCR_MONEDA VARCHAR(20),
      	FECHA_CONFIRMACION DATETIME,
      	FECHA_EJECUCION DATETIME,
      	ESTADO VARCHAR(1),
      	SALDOCAJA NUMERIC (17, 2),
      	MONEDACAJA VARCHAR(20),
      	DEBE_HABER NUMERIC (2, 0)
	  )
	  
	  	INSERT INTO 
			@Tabla_SP_REM_REPO_MOV_TESORERIA
		 	
		--Remesas 8151 fecha distinta ejecucion anterior
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ORIGEN = 97	--REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.DESTINO = 97	--REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ORIGEN = 97	--REM.ESTADO = ''L''
				THEN 1
			   WHEN	REM.DESTINO = 97	--REM.ESTADO = ''E''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 7)
		AND REM.ESTADO IN (''L'')
		AND (REM.DESTINO= 97 OR REM.ORIGEN = 97)
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		
		UNION
		
		--Remesas 8151
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ORIGEN = 97	--REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.DESTINO = 97	--REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ORIGEN = 97	--REM.ESTADO = ''L''
				THEN 1
			   WHEN	REM.DESTINO = 97	--REM.ESTADO = ''E''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 7)
		AND REM.ESTADO IN (''E'',''L'')
		AND (REM.DESTINO= 97 OR REM.ORIGEN = 97)
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		
		UNION
		
		--Remesas 8191
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.DESCRIPCION AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRE AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E'' OR REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''E'' OR REM.ESTADO = ''P''
				THEN 1
			   WHEN	REM.ESTADO = ''L''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN TABLA_CAJAS  S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.NRO_CAJA = 999 AND S.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S2 ON CAST(REM.DESTINO AS INTEGER) = S2.CODIGOBC AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (TIPOORIGEN = 3 AND TIPODESTINO IN (4, 12))
		AND REM.ESTADO IN (''P'',''E'',''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		UNION
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRE AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.DESCRIPCION AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN 1
			   WHEN	REM.ESTADO = ''L''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN TABLA_CAJAS  S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.NRO_CAJA = 999 AND S2.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S ON CAST(REM.ORIGEN AS INTEGER) = S.CODIGOBC AND S.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (TIPOORIGEN IN (4,12) AND TIPODESTINO = 3)
		AND REM.ESTADO IN (''E'',''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		
		UNION
		
		--Remesas 8191 fecha distinta
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.DESCRIPCION AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRE AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E'' OR REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''E'' OR REM.ESTADO = ''P''
				THEN 1
			   WHEN	REM.ESTADO = ''L''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN TABLA_CAJAS  S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.NRO_CAJA = 999 AND S.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S2 ON CAST(REM.DESTINO AS INTEGER) = S2.CODIGOBC AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (TIPOORIGEN = 3 AND TIPODESTINO IN (4, 12))
		AND REM.ESTADO IN (''P'',''E'',''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		UNION
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRE AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.DESCRIPCION AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN 1
			   WHEN	REM.ESTADO = ''L''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN TABLA_CAJAS  S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.NRO_CAJA = 999 AND S2.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S ON CAST(REM.ORIGEN AS INTEGER) = S.CODIGOBC AND S.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (TIPOORIGEN IN (4,12) AND TIPODESTINO = 3)
		AND REM.ESTADO IN (''E'',''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		
	
		UNION
		
		--Remesas 8253
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRE_CLI AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL  AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN 1
			   WHEN	REM.ESTADO = ''L''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS S ON CAST(REM.ORIGEN AS INTEGER) = S.NRO_CLIENTE AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES  S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 8 AND REM.TIPODESTINO = 7)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		AND REM.DESTINO = 97
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		UNION
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRE_CLI AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN 1
			   WHEN	REM.ESTADO = ''P''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS S2 ON CAST(REM.DESTINO AS INTEGER) = S2.NRO_CLIENTE AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 8)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		AND REM.ORIGEN = 97
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		
		UNION
		
		--Remesas 8253 fecha distitna
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRE_CLI AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL  AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN 1
			   WHEN	REM.ESTADO = ''L''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS S ON CAST(REM.ORIGEN AS INTEGER) = S.NRO_CLIENTE AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES  S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 8 AND REM.TIPODESTINO = 7)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND REM.DESTINO = 97
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		UNION
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRE_CLI AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN 1
			   WHEN	REM.ESTADO = ''P''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS S2 ON CAST(REM.DESTINO AS INTEGER) = S2.NRO_CLIENTE AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 8)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND REM.ORIGEN = 97
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.TZ_LOCK = 0
		ORDER BY REM.NRO_SOLICITUD, REM.MONEDA, REM.FECHA_CONFIRMACION, REM.ORIGEN, REM.DESTINO
	   
	  	
		--Tabla temporal de duplicados por haber
		DECLARE @Tabla_SP_REM_REPO_MOV_TESORERIA_DOBLE  TABLE(
		  	NRO_SOLICITUD NUMERIC (6, 0),
			TIPOORIGEN NUMERIC (3, 0), 
	      	ORIGEN VARCHAR(255), 
	      	SUCURSAL_ORIGEN VARCHAR(50), 
	      	TIPODESTINO NUMERIC (3, 0),
	      	DESTINO VARCHAR(254),
	      	SUCURSAL_DESTINO VARCHAR(50),
	      	DEBE NUMERIC (14, 2),
	      	HABER NUMERIC (14, 2),
	      	MONEDA NUMERIC (4, 0),
	      	DESCR_MONEDA VARCHAR(20),
	      	FECHA_CONFIRMACION DATETIME,
	      	FECHA_EJECUCION DATETIME,
	      	ESTADO VARCHAR(1),
	      	SALDOCAJA NUMERIC (17, 2),
	      	MONEDACAJA VARCHAR(20),
	      	DEBE_HABER NUMERIC (2, 0)
	    )
	    
	    INSERT INTO 
			@Tabla_SP_REM_REPO_MOV_TESORERIA_DOBLE
		--Remesas 8151 fecha distinta nonfirmacion posterior
		/*SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN 1
			   WHEN	REM.ESTADO = ''E''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 7)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA	
		
		UNION
				
		--Remesas 8151
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN 1
			   WHEN	REM.ESTADO = ''L''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 7)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA*/
		
		--UNION
		
	    --Ingreso de Tesoro a Caja y Caja a Tesorero
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			C.SALDOINICIAL AS "SaldoCaja",
			M1.C6400 AS "MonedaCaja",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN 1
			   WHEN	REM.ESTADO = ''L''
			    THEN 2
			END AS "Debe/Haber"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0,
		SALDOSCAJA C
		JOIN MONEDAS M1 ON M1.C6399 = C.MONEDA AND M1.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 3 AND REM.TIPODESTINO = 2)
		AND REM.ESTADO IN (''L'')
		AND C.SUCURSAL = 97 AND C.NROCAJA = 999 AND C.MONEDA = REM.MONEDA
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		AND REM.TZ_LOCK = 0
		--AND REM.FECHA_CONFIRMACION = ''20371209''
		ORDER BY REM.NRO_SOLICITUD, REM.MONEDA, REM.FECHA_CONFIRMACION, REM.ORIGEN, REM.DESTINO
      	
    
      BEGIN TRANSACTION	
      
        BEGIN TRY
        
        	DELETE 
        	FROM REM_REPO_MOV_TESORERIA
	    
	    	INSERT INTO REM_REPO_MOV_TESORERIA
			SELECT 
				TC.NRO_SOLICITUD,
				TC.TIPOORIGEN, 
		      	TC.ORIGEN, 
		      	TC.SUCURSAL_ORIGEN, 
		      	TC.TIPODESTINO,
		      	TC.DESTINO,
		      	TC.SUCURSAL_DESTINO,
		      	TC.DEBE,
		      	TC.HABER,
		      	TC.MONEDA,
		      	TC.DESCR_MONEDA,
		      	TC.FECHA_CONFIRMACION,
		      	TC.FECHA_EJECUCION,
		      	TC.ESTADO,
		      	TC.SALDOCAJA,
		      	TC.MONEDACAJA,
		      	1,
		      	TC.DEBE_HABER		
			FROM @Tabla_SP_REM_REPO_MOV_TESORERIA AS TC
		   
		   
			 
			INSERT INTO REM_REPO_MOV_TESORERIA
			SELECT 
				TC.NRO_SOLICITUD,
				TC.TIPOORIGEN, 
		      	TC.ORIGEN, 
		      	TC.SUCURSAL_ORIGEN, 
		      	TC.TIPODESTINO,
		      	TC.DESTINO,
		      	TC.SUCURSAL_DESTINO,
		      	TC.DEBE,
		      	TC.HABER,
		      	TC.MONEDA,
		      	TC.DESCR_MONEDA,
		      	TC.FECHA_CONFIRMACION,
		      	TC.FECHA_EJECUCION,
		      	TC.ESTADO,
		      	TC.SALDOCAJA,
		      	TC.MONEDACAJA,
		      	2,
		      	TC.DEBE_HABER		
			FROM @Tabla_SP_REM_REPO_MOV_TESORERIA_DOBLE AS TC	
			
				
			COMMIT TRANSACTION;
			
			SET @P_RET_PROCESO = 1
		    SET @P_MSG_PROCESO = ''Se generaron datos del reporte exitosamente.''
			 
				
		END TRY     
		
		BEGIN CATCH
			ROLLBACK TRANSACTION
			SET @P_RET_PROCESO = ERROR_NUMBER()
			SET @P_MSG_PROCESO = ERROR_MESSAGE()
			EXECUTE dbo.pkg_constantes$VarcharConstantes ''C_LOG_TIPO_ERROR'', @v_constante OUTPUT;
		END CATCH
		 	      
 END
')

