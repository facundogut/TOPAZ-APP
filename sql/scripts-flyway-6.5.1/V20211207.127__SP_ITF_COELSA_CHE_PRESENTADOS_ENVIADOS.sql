EXECUTE('DROP PROCEDURE IF EXISTS dbo.SP_ITF_COELSA_CHE_PRESENTADOS_ENVIADOS;')
EXECUTE('
CREATE PROC  dbo.SP_ITF_COELSA_CHE_PRESENTADOS_ENVIADOS

AS 
BEGIN TRY
	SET NOCOUNT ON;

	--limpio tabla auxiliar (DROP AND CRATE)
	IF OBJECT_ID (''dbo.ITF_CHEQUES_SALIDA_AUX'') IS NOT NULL
	DROP TABLE dbo.ITF_CHEQUES_SALIDA_AUX


	CREATE TABLE dbo.ITF_CHEQUES_SALIDA_AUX
	(
	ID INT IDENTITY(0,1),  
	LINEA VARCHAR (200)
	
	)

--variables CLE_CHEQUES_ENVIADOS
DECLARE @T_COD_BANCO NUMERIC(12,0);
DECLARE @T_SUCURSAL NUMERIC(5,0);
DECLARE @T_SERIE_DEL_CHEQUE VARCHAR(6);
DECLARE @T_NUMERO_DEL_CHEQUE NUMERIC(12,0);
DECLARE @T_MONEDA NUMERIC(4,0);
DECLARE @T_IMPORTE NUMERIC(15,2);
DECLARE @T_FECHA_DEL_CHEQUE DATETIME;
DECLARE @T_FECHA_VALOR DATETIME;
DECLARE @T_CODIGO_BANCO_CAMARA NUMERIC(4,0);
DECLARE @T_TIPO_DOCUMENTO NUMERIC(4,0);
DECLARE @T_CODIGO_PLAZA NUMERIC(4,0);
DECLARE @T_CODIGO_CAMARA NUMERIC(4,0);
DECLARE @T_NUMERO_CUENTA_GIRADORA NUMERIC(12,0);
DECLARE @T_TIPO_MONEDA VARCHAR(1);
DECLARE @T_SUCURSAL_DE_INGRESO NUMERIC(5,0);

--variables Cabecera Archivo (CA)
DECLARE @CA_ID_REG VARCHAR(1) = ''1'';
DECLARE @CA_CODIGO_PRIORIDAD VARCHAR (2)= ''01'';
DECLARE @CA_DESTINO_INMEDIATO VARCHAR (10)= '' 000000010'';
DECLARE @CA_ORIGEN_INMEDIATO VARCHAR(10) = '' 031100970''; 
DECLARE @CA_FECHA_PRESENTACION VARCHAR(6)= convert(VARCHAR,(SELECT FECHAPROCESO FROM PARAMETROS), 12); 
DECLARE @CA_HORA_PRESENTACION VARCHAR(4)= concat (SUBSTRING((SELECT CONVERT (VARCHAR(8), SYSDATETIME(),24)),1,2), SUBSTRING((SELECT CONVERT (VARCHAR(8), SYSDATETIME(),24)),4,5));
DECLARE @CA_IDENTIFICADOR_ARCHIVO VARCHAR(1) = ''A''; 
DECLARE @CA_TAMANNO_REGISTRO VARCHAR(3)= ''094'';
DECLARE @CA_FACTOR_BLOQUE VARCHAR(2)= ''10'';
DECLARE @CA_CODIGO_FORMATO VARCHAR(1)= ''1'';
DECLARE @CA_NOMBRE_DEST_INMEDIATO VARCHAR(6)= ''COELSA'';
DECLARE @CA_NOMBRE_ORIG_INMEDIATO VARCHAR(23)=''NUEVO BANCO DEL CHACO S'';
DECLARE @CA_CODIGO_REFERENCIA VARCHAR(8)= ''        ''; --Se conforma con espacios vacÃ­os.
DECLARE @CA_CABECERA VARCHAR(200);
-- conformacion de cabecera archivo
SET @CA_CABECERA = @CA_ID_REG + @CA_CODIGO_PRIORIDAD + @CA_DESTINO_INMEDIATO + @CA_ORIGEN_INMEDIATO + @CA_FECHA_PRESENTACION
                  + @CA_HORA_PRESENTACION + @CA_IDENTIFICADOR_ARCHIVO + @CA_TAMANNO_REGISTRO + @CA_FACTOR_BLOQUE 
                  + @CA_CODIGO_FORMATO + @CA_NOMBRE_DEST_INMEDIATO + ''                 '' + @CA_NOMBRE_ORIG_INMEDIATO + @CA_CODIGO_REFERENCIA;


--variables cabecera lote (CL)
DECLARE @CL_ID_REG VARCHAR(1) = ''5''; 
DECLARE @CL_CODIGO_CLASE_TRANSAC VARCHAR(3) = ''200''; 
DECLARE @CL_RESERVADO VARCHAR(46) = ''                                              '';  
DECLARE @CL_TIPO_REGISTRO VARCHAR(3) = ''TRC''; 
DECLARE @CL_DESCRIP_TRANSAC VARCHAR(10) = ''CHEQUESPRE'' ; 
DECLARE @CL_FECHA_PRESENTACION VARCHAR(6) = convert(VARCHAR,(SELECT FECHAPROCESO FROM PARAMETROS), 12);
DECLARE @CL_FECHA_VENCIMIENTO VARCHAR(6) = convert(VARCHAR,(SELECT FECHAPROCESO FROM PARAMETROS), 12); 
DECLARE @CL_RESERVADO_CL VARCHAR(3) = ''000''; 
DECLARE @CL_CODIGO_ORIGEN VARCHAR(1) = ''1''; 
DECLARE @CL_ID_ENTIDAD_ORIGEN VARCHAR(8); 
DECLARE @CL_NUMERO_LOTE VARCHAR(7) = 0; 
DECLARE @CL_CONT_LOTE INT = 0;  -- VAR AUXILIAR
DECLARE @CL_CABECERA_LOTE VARCHAR(200);
DECLARE @CL_CABECERA VARCHAR(200);
SET @CL_CABECERA_LOTE = @CL_ID_REG + @CL_CODIGO_CLASE_TRANSAC + @CL_RESERVADO + @CL_TIPO_REGISTRO + @CL_DESCRIP_TRANSAC
                         + @CL_FECHA_PRESENTACION + @CL_FECHA_VENCIMIENTO + @CL_RESERVADO_CL + @CL_CODIGO_ORIGEN; 

--variables registro individual ( RI)
DECLARE @RI_ID_REG VARCHAR(1) = ''6'';  
DECLARE @RI_CODIGO_TRANSAC VARCHAR(2) = ''27'';
DECLARE @RI_ENTIDAD_DEBITAR VARCHAR(8);
DECLARE @RI_RESERVADO VARCHAR(1) = ''0''; 
DECLARE @RI_CUENTA_DEBITAR VARCHAR(17); 
DECLARE @RI_IMPORTE VARCHAR(11); 
DECLARE @RI_NUMERO_CHEQUE VARCHAR(15);
DECLARE @RI_CODIGO_POSTAL VARCHAR(6); 
DECLARE @RI_PUNTO_INTERCAMBIO VARCHAR(16);
DECLARE @RI_INFO_ADICIONAL VARCHAR(2);
DECLARE @RI_REGISTRO_ADICIONAL VARCHAR(1); 
DECLARE @RI_CONTADOR_REGISTRO VARCHAR(15); 								
DECLARE @RI_REGISTRO_INDIVIDUAL VARCHAR (200);
DECLARE @CMC7 VARCHAR(30);

---variables fin de lote FL
DECLARE @FL_ID_REG VARCHAR(1) = ''8'';  
DECLARE @FL_CODIGO_CLASE_TRANSAC VARCHAR(3) = ''200''; 
DECLARE @FL_CANT_REG_INDIVIDUAL_ADICIONAL VARCHAR(6) = 0;
DECLARE @FL_TOTALES_DE_CONTROL VARCHAR(10) = 0;
DECLARE @FL_SUMA_TOTAL_DEBITO_LOTE NUMERIC(12,2)=0; 
DECLARE @FL_SUMA_TOTAL_CREDITO_LOTE NUMERIC(12,2)=0; 
DECLARE @FL_RESERVADO1 VARCHAR(1) = '' '';
DECLARE @FL_RESERVADO2 VARCHAR(1) = '' '';
DECLARE @FL_RESERVADO3 VARCHAR(1) = '' '';
DECLARE @FL_REG_ENTIDAD_ORIGEN VARCHAR(8) = ''03110030''; 
DECLARE @FL_NUMERO_LOTE VARCHAR(7); 
DECLARE @FL_FIN_LOTE VARCHAR(200);

--variables fin de Archivo FA
DECLARE @FA_ID_REG VARCHAR(1) = ''9'';  
DECLARE @FA_CANT_LOTES VARCHAR(6);-- ver detalles en doc pdf
DECLARE @FA_NUMERO_BLOQUES VARCHAR(6);-- ver detalles en doc pdf
DECLARE @FA_CANT_REG_INDIVIDUAL_ADICIONAL VARCHAR(8);
DECLARE @FA_TOTALES_DE_CONTROL VARCHAR(10); -- ver detalles en doc pdf
DECLARE @FA_SUMA_TOTAL_DEBITOS VARCHAR(12);-- ver detalles en doc pdf
DECLARE @FA_SUMA_TOTAL_CREDITOS VARCHAR(12);-- ver detalles en doc pdf
DECLARE @FA_RESERVADO  VARCHAR(100) = ''                              ''; --ESPACIO EN BLANCO PARA COMPLETAR 
DECLARE @FA_FIN_ARCHIVO VARCHAR (200);

--variable de cursorUno
DECLARE @BANCO NUMERIC(4,0);

--Variables generales
DECLARE @CONT_REGISTROS VARCHAR(7)=0;
DECLARE @CONT_REGISTROS_RI INT =0;
DECLARE @CANT_LINES INT = 0;

DECLARE @SUM_ENTIDAD INT =0;
DECLARE @SUM_SUCURSAL INT =0;
DECLARE @SUM_ENT VARCHAR (10);
DECLARE @SUM_SUC VARCHAR (10);


--Insert cabecera en tabla auxiliar
INSERT INTO dbo.ITF_CHEQUES_SALIDA_AUX (LINEA) VALUES (@CA_CABECERA);


DECLARE CursorUno CURSOR FOR --Declarar el cursorUno

SELECT COD_BANCO FROM dbo.CLE_CHEQUES_ENVIADOS  WHERE TZ_LOCK=0 GROUP BY COD_BANCO 

---*****---
 --CURSOR1
---*****---
OPEN CursorUno --Abrir el CURSOR
    FETCH NEXT FROM CursorUno INTO @BANCO

    WHILE @@FETCH_STATUS = 0 
    	BEGIN

    		SET @CL_CONT_LOTE =  @CL_CONT_LOTE +1;
    		SET @CL_NUMERO_LOTE = RIGHT(concat(''0000000'', @CL_CONT_LOTE), 7);
			
			/*
    		DECLARE @TEMP2 VARCHAR(4)= (SELECT RIGHT(REPLICATE(''0'', 4)+ CAST(SUCURSAL AS VARCHAR(4)), 4) AS SUCURSAL 
    						            FROM dbo.CLE_CHEQUES_ENVIADOS 
    									WHERE COD_BANCO = @BANCO GROUP BY SUCURSAL)
    									
    		DECLARE @TEMP1 VARCHAR(4)= (SELECT RIGHT(REPLICATE(''0'', 4)+ CAST(COD_BANCO AS VARCHAR(4)), 4) AS COD_BANCO 
    									FROM dbo.CLE_CHEQUES_ENVIADOS 
    									WHERE COD_BANCO = @BANCO GROUP BY COD_BANCO)
  			 */ 
  			    
  									
			-- concateno cabecera lote e inserto
    		SET @CL_ID_ENTIDAD_ORIGEN  = ''03110097''; ---@TEMP1 + @TEMP2 	
    		SET @CL_CABECERA = @CL_CABECERA_LOTE + @CL_ID_ENTIDAD_ORIGEN + @CL_NUMERO_LOTE;    
    				
			INSERT INTO dbo.ITF_CHEQUES_SALIDA_AUX (LINEA) VALUES (@CL_CABECERA);
		   
		    ---*****---
		    --CURSOR2
			---*****---
			DECLARE CursorDos CURSOR FOR --Declarar el CURSOR dos
			
				SELECT  COD_BANCO, SUCURSAL, SERIE_DEL_CHEQUE, NUMERO_DEL_CHEQUE, MONEDA, IMPORTE, FECHA_DEL_CHEQUE,
	   					FECHA_VALOR, CODIGO_BANCO_CAMARA, TIPO_DOCUMENTO, CODIGO_PLAZA, CODIGO_CAMARA, NUMERO_CUENTA_GIRADORA,
	   					TIPO_MONEDA, SUCURSAL_DE_INGRESO
				        FROM CLE_CHEQUES_ENVIADOS
				        		
    	   	OPEN CursorDos --Abrir el CURSOR dos
    			FETCH NEXT FROM CursorDos INTO @T_COD_BANCO, @T_SUCURSAL, @T_SERIE_DEL_CHEQUE, @T_NUMERO_DEL_CHEQUE,@T_MONEDA,@T_IMPORTE,
    							   	           @T_FECHA_DEL_CHEQUE, @T_FECHA_VALOR, @T_CODIGO_BANCO_CAMARA, @T_TIPO_DOCUMENTO,@T_CODIGO_PLAZA, 
    							   	           @T_CODIGO_CAMARA, @T_NUMERO_CUENTA_GIRADORA, @T_TIPO_MONEDA, @T_SUCURSAL_DE_INGRESO
									            
    	   		WHILE @@FETCH_STATUS = 0 
    				BEGIN
    					 -- el if condiciona para solo insertar los RI del lote que esta siendo analizado
    					IF @T_COD_BANCO = @BANCO
    					BEGIN
    					
    					  
    					   --Varibles para conformar @RI_ENTIDAD_DEBITAR
    						DECLARE @ENTIDAD VARCHAR(4) = (SELECT RIGHT(REPLICATE(''0'', 4)+ CAST(COD_BANCO AS VARCHAR(4)), 4) AS Entidad_destino
    											 FROM CLE_CHEQUES_ENVIADOS
    											 WHERE NUMERO_DEL_CHEQUE = @T_NUMERO_DEL_CHEQUE AND COD_BANCO = @BANCO);
    											 
				 			DECLARE @SUCURSAL VARCHAR(4) = (SELECT RIGHT(REPLICATE(''0'', 4)+ CAST(SUCURSAL AS VARCHAR(4)), 4) AS SUCURSAL
    											 FROM CLE_CHEQUES_ENVIADOS
    											 WHERE NUMERO_DEL_CHEQUE = @T_NUMERO_DEL_CHEQUE AND COD_BANCO = @BANCO);
    						--ENTIDAD DEBITAR					 
    						SET @RI_ENTIDAD_DEBITAR = @ENTIDAD + @SUCURSAL;
				 		
				 			--CUENTA DEBITAR  
				 			SET @CMC7 = (SELECT s.CMC7 FROM CLE_CHEQUES_SALIENTE s 
						 		JOIN	CLE_CHEQUES_ENVIADOS e ON e.COD_BANCO=s.BANCO_GIRADO AND e.NUMERO_DEL_CHEQUE=s.NUMERO_CHEQUE
						 		WHERE e.COD_BANCO = @BANCO  AND e.NUMERO_DEL_CHEQUE = @T_NUMERO_DEL_CHEQUE);					   				 
    				       	SET @RI_CUENTA_DEBITAR = RIGHT(concat(''00000000000000000'', substring(@CMC7,19,10)), 17);
				 			
	 
    					    --IMPORTE
    						SET @RI_IMPORTE = (SELECT RIGHT(REPLICATE(''0'', 11)+ CAST(IMPORTE AS VARCHAR(11)), 11) AS IMPORTE
    											 FROM CLE_CHEQUES_ENVIADOS
    											 WHERE NUMERO_DEL_CHEQUE = @T_NUMERO_DEL_CHEQUE AND COD_BANCO = @BANCO);
    					
    				   		SET @RI_IMPORTE=  concat (SUBSTRING(@RI_IMPORTE,1,8), SUBSTRING(@RI_IMPORTE,10,11));
    				   
    				  	
    				  		--NUEMERO CHEQUE			 
    				 		SET @RI_NUMERO_CHEQUE = ''00'' + (SELECT RIGHT(REPLICATE(''0'', 13)+ CAST(NUMERO_DEL_CHEQUE AS VARCHAR(13)), 13) AS NUMERO_DEL_CHEQUE 
    						            		 FROM CLE_CHEQUES_ENVIADOS 
    											 WHERE NUMERO_DEL_CHEQUE = @T_NUMERO_DEL_CHEQUE AND COD_BANCO = @BANCO);
    					
    				 	 	--CODIGO POSTAL  
    				 	 	SET @CMC7 = (SELECT s.CMC7 FROM CLE_CHEQUES_SALIENTE s 
						 		JOIN	CLE_CHEQUES_ENVIADOS e ON e.COD_BANCO=s.BANCO_GIRADO AND e.NUMERO_DEL_CHEQUE=s.NUMERO_CHEQUE
						 		WHERE e.COD_BANCO = @BANCO  AND e.NUMERO_DEL_CHEQUE = @T_NUMERO_DEL_CHEQUE);					   				 
    				       	SET @RI_CODIGO_POSTAL =  ''00'' +  substring(@CMC7,7,4);
    				    	
    				    	SET @RI_PUNTO_INTERCAMBIO = ''0000            '';
    				    	SET @RI_INFO_ADICIONAL = ''00'';
    				   		SET @RI_REGISTRO_ADICIONAL = ''0'';
    				    
    				    	--CONTADOR DE REGISTRO RI
    				    	SET @CONT_REGISTROS_RI =  @CONT_REGISTROS_RI +1;
    				    	SET @RI_CONTADOR_REGISTRO = RIGHT(concat(''0000000'', @CONT_REGISTROS_RI), 7);
    				    	SET @RI_CONTADOR_REGISTRO = ''03110097'' + @RI_CONTADOR_REGISTRO;
    			 
    			       		 -- Concateno registro individual
    				    	SET @RI_REGISTRO_INDIVIDUAL = @RI_ID_REG + @RI_CODIGO_TRANSAC + @RI_ENTIDAD_DEBITAR + @RI_RESERVADO 
    				    				            + @RI_CUENTA_DEBITAR +  @RI_IMPORTE + @RI_NUMERO_CHEQUE  + @RI_CODIGO_POSTAL 
    				    						    + @RI_PUNTO_INTERCAMBIO + @RI_INFO_ADICIONAL + @RI_REGISTRO_ADICIONAL 
    				    						   	+ @RI_CONTADOR_REGISTRO;
    			   
    						INSERT INTO dbo.ITF_CHEQUES_SALIDA_AUX (LINEA) VALUES (@RI_REGISTRO_INDIVIDUAL);
    						
    						SET @FL_CANT_REG_INDIVIDUAL_ADICIONAL = @FL_CANT_REG_INDIVIDUAL_ADICIONAL + 1;
    						
    						
    						INSERT INTO ITF_COELSA_CHEQUES_TERCEROS(FECHAPROCESO, CODIGO_TRANSACCION, ENTIDAD_DEBITAR, CUENTA_DEBITAR, IMPORTE, CODIGO_POSTAL, FECHA_PRESENTADO, FECHA_VENCIMIENTO, NRO_CHEQUE, PUNTO_INTERCAMBIO, TRACE_NUMBER, ESTADO, TIPO)
							VALUES((SELECT FECHAPROCESO FROM PARAMETROS), 27, CAST(@RI_ENTIDAD_DEBITAR AS NUMERIC), CAST(@RI_CUENTA_DEBITAR AS NUMERIC), CAST(@RI_IMPORTE AS NUMERIC(15,2)), @RI_CODIGO_POSTAL, @T_FECHA_DEL_CHEQUE, @T_FECHA_VALOR, CAST (@RI_NUMERO_CHEQUE AS NUMERIC), @RI_PUNTO_INTERCAMBIO, @RI_CONTADOR_REGISTRO, ''P'', (CASE WHEN CAST(@RI_CUENTA_DEBITAR AS NUMERIC) = 88888888888 THEN ''A'' WHEN CAST(@RI_CUENTA_DEBITAR AS NUMERIC) = 77777777777 THEN ''D'' ELSE ''C'' END));
    						     						
   							--****************** FL			
    				   		--- vars para la suma de control
    						SET @SUM_ENTIDAD = @SUM_ENTIDAD + @T_COD_BANCO;
    				 	   	SET @SUM_ENT = RIGHT(concat(''0000000'',  CAST (@SUM_ENTIDAD AS VARCHAR(10)) ), 7);
    					
							SET @SUM_SUCURSAL = @SUM_SUCURSAL + @T_SUCURSAL;
					   		SET @SUM_SUC = RIGHT(concat(''0000000'',  CAST (@SUM_SUCURSAL AS VARCHAR(7)) ), 7);
					   		
					   		--****************** SUMA TOTAL DEBITO/CREDITO FL			
    				   		--- suma Debito
					   		SET @FL_SUMA_TOTAL_DEBITO_LOTE = @FL_SUMA_TOTAL_DEBITO_LOTE + @T_IMPORTE;
					   	 	DECLARE @TMPDEB1 VARCHAR(13)= RIGHT(concat(''0000000000000'',  CAST (@FL_SUMA_TOTAL_DEBITO_LOTE AS VARCHAR(13)) ), 13);
					   	 	DECLARE @TMPDEB2 VARCHAR(10) = SUBSTRING(@TMPDEB1,1,10);
					   	   	DECLARE @TMPDEB3 VARCHAR(2) = SUBSTRING(@TMPDEB1,12,13);
					   	   	DECLARE @FL_SUMA_TOTAL_DEBITO_LOTE_FINAL VARCHAR(12) = CONCAT(@TMPDEB2,@TMPDEB3);
					   		
					   		--- suma Credito
					   		SET @FL_SUMA_TOTAL_CREDITO_LOTE = @FL_SUMA_TOTAL_CREDITO_LOTE + @T_IMPORTE;
					   	 	DECLARE @TMPCRED1 VARCHAR(13)= RIGHT(concat(''0000000000000'',  CAST (@FL_SUMA_TOTAL_CREDITO_LOTE AS VARCHAR(13)) ), 13);
					   	 	DECLARE @TMPCRED2 VARCHAR(10) = SUBSTRING(@TMPCRED1,1,10);
					   	   	DECLARE @TMPCRED3 VARCHAR(2) = SUBSTRING(@TMPCRED1,12,13);
					   	   	DECLARE @FL_SUMA_TOTAL_CREDITO_LOTE_FINAL VARCHAR(12) = CONCAT(@TMPCRED2,@TMPCRED3);
					   	
					   	   --****************** SUMA TOTAL DEBITO/CREDITO FA
					   	   
					   	   SET @FA_SUMA_TOTAL_DEBITOS=@FL_SUMA_TOTAL_DEBITO_LOTE_FINAL
					   	   SET @FA_SUMA_TOTAL_CREDITOS=@FL_SUMA_TOTAL_CREDITO_LOTE_FINAL
					   	   
					   	   	
	
    					END  
    	       				
    				FETCH NEXT FROM CursorDos INTO @T_COD_BANCO, @T_SUCURSAL, @T_SERIE_DEL_CHEQUE, @T_NUMERO_DEL_CHEQUE,@T_MONEDA,@T_IMPORTE,
    							   	               @T_FECHA_DEL_CHEQUE, @T_FECHA_VALOR, @T_CODIGO_BANCO_CAMARA, @T_TIPO_DOCUMENTO,@T_CODIGO_PLAZA, 
    							   	               @T_CODIGO_CAMARA, @T_NUMERO_CUENTA_GIRADORA, @T_TIPO_MONEDA, @T_SUCURSAL_DE_INGRESO
					               
    				END 
    				CLOSE CursorDos --Cerrar el CURSOR
					DEALLOCATE CursorDos --Liberar recursos
				    
					--- linea fin lote 
					
						   		
					--Totales de control
					DECLARE @LEN_SUM_SUC INT;
					DECLARE @CANT_DESV INT;
					DECLARE @SUM_SUC_SIN_DESVORD VARCHAR(10);
					DECLARE @DESVORDE VARCHAR(10);
					DECLARE @TEMP INT;
					DECLARE @SUM_ENTTEMP INT;
					
					IF @SUM_SUCURSAL > 9999
						BEGIN  
							SET @LEN_SUM_SUC = LEN (@SUM_SUCURSAL)	;
						   	SET @CANT_DESV =   @LEN_SUM_SUC - 4 ;   	
						   	SET @SUM_SUC = CAST (@SUM_SUCURSAL AS VARCHAR(7)) ;	  				   				
							SET @SUM_SUC_SIN_DESVORD = SUBSTRING(@SUM_SUC,@CANT_DESV+1,4);   
							SET @DESVORDE = SUBSTRING(@SUM_SUC,1,@CANT_DESV);   							
						   	SET @TEMP = CAST (@DESVORDE AS INT);
						   	SET @SUM_ENTTEMP = CAST((@SUM_ENTIDAD + @TEMP) AS VARCHAR(7));
						   	
						   	SET @FL_TOTALES_DE_CONTROL = CONCAT(@SUM_ENTTEMP,@SUM_SUC_SIN_DESVORD) ;	
							SET @FL_TOTALES_DE_CONTROL = RIGHT(concat(''0000000000'', @FL_TOTALES_DE_CONTROL ), 10);
						END
				   	ELSE
						BEGIN
							SET @FL_TOTALES_DE_CONTROL = CONCAT(@SUM_ENTIDAD,@SUM_SUCURSAL) ;	
						   	SET @FL_TOTALES_DE_CONTROL = RIGHT(concat(''0000000000'', @FL_TOTALES_DE_CONTROL ), 10);
						END
						
							
					SET @FL_CANT_REG_INDIVIDUAL_ADICIONAL =  RIGHT(concat(''000000'', @FL_CANT_REG_INDIVIDUAL_ADICIONAL), 6) ;
					SET @FL_RESERVADO1 = ''          '';
					SET @FL_RESERVADO2 = ''          '';
					SET @FL_RESERVADO3 = ''               '';
					SET @FL_NUMERO_LOTE = @CL_NUMERO_LOTE;
                    
					
				   	SET @FL_FIN_LOTE = @FL_ID_REG + @FL_CODIGO_CLASE_TRANSAC + @FL_CANT_REG_INDIVIDUAL_ADICIONAL + @FL_TOTALES_DE_CONTROL 
					              + @FL_SUMA_TOTAL_DEBITO_LOTE_FINAL + @FL_SUMA_TOTAL_CREDITO_LOTE_FINAL + ''                                   ''
					              + @FL_REG_ENTIDAD_ORIGEN + @FL_NUMERO_LOTE 
					              
					         
					
					INSERT INTO dbo.ITF_CHEQUES_SALIDA_AUX (LINEA) VALUES (@FL_FIN_LOTE);
					
					--FA totales de control
					SET @FA_TOTALES_DE_CONTROL = @FL_TOTALES_DE_CONTROL;
					
					--limpio FL totales de contrl para proximo bloque
					SET @FL_TOTALES_DE_CONTROL=0;
					
					--cant de RI
					SET @FL_CANT_REG_INDIVIDUAL_ADICIONAL = 0;
					
					--limpio FL totales de debito/credito para proximo bloque
					SET @FL_SUMA_TOTAL_DEBITO_LOTE = 0;
					SET @FL_SUMA_TOTAL_CREDITO_LOTE = 0;
					
					
        FETCH NEXT FROM CursorUno INTO @BANCO
        END --Fin del WHILE
        
        --- fin archivo linea
        --cantidad Lotes
        SET @FA_CANT_LOTES = RIGHT(concat(''000000'', @CL_NUMERO_LOTE), 6);
        
        --Calculo de cantidad de Bloques
        SET @CANT_LINES = (@CL_CONT_LOTE * 2) + @CONT_REGISTROS_RI + 2;
        DECLARE @FA_AUX1 INT = @CANT_LINES/10;
        DECLARE @FA_AUX2 INT = @CANT_LINES%10;
        
        
	  	
		IF @FA_AUX2 = 0
			BEGIN
				SET @FA_NUMERO_BLOQUES = @FA_AUX1;
			END 
		ELSE 
			BEGIN
				
				SET @FA_NUMERO_BLOQUES = @FA_AUX1 + 1;
			END
			
		SET @FA_NUMERO_BLOQUES = RIGHT(concat(''000000'',  CAST (@FA_AUX1 AS VARCHAR(6)) ), 6);   
		
		--Cantidad de RI
		SET @FA_CANT_REG_INDIVIDUAL_ADICIONAL = RIGHT(concat(''00000000'', @CONT_REGISTROS_RI), 8); 
			
        --concateno la linea fin de archivo e inserto
        SET @FA_FIN_ARCHIVO = @FA_ID_REG + @FA_CANT_LOTES +  @FA_NUMERO_BLOQUES + @FA_CANT_REG_INDIVIDUAL_ADICIONAL 
                            + @FA_TOTALES_DE_CONTROL  + @FA_SUMA_TOTAL_DEBITOS + @FA_SUMA_TOTAL_CREDITOS + @FA_RESERVADO



    	INSERT INTO dbo.ITF_CHEQUES_SALIDA_AUX (LINEA) VALUES (@FA_FIN_ARCHIVO);
    	
CLOSE CursorUno --Cerrar el CURSOR
DEALLOCATE CursorUno --Liberar recursos
 
END TRY 

BEGIN CATCH
	Print error_message()
END CATCH;')