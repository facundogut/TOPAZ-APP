EXECUTE('
ALTER   PROCEDURE SP_CO_REPO_HIS_AJUSTE_X_INFLACION
   @P_FECHA_SALDO DATETIME,
   @P_RET_PROCESO float(53) OUTPUT,
   @P_MSG_PROCESO varchar(max) OUTPUT
AS
BEGIN

	SET @P_RET_PROCESO = NULL
	SET @P_MSG_PROCESO = NULL
	
	DECLARE
		@FECHA DATETIME,
		@FECHA_ANTERIOR DATETIME,
		@CANT NUMERIC(5),
		@row_number NUMERIC(6),
		@v_constante VARCHAR(1),
		@v_numerador NUMERIC,
		@v_correlativo NUMERIC(10)
	
	--DECLARO TABLA AUXILIAR--
	DECLARE @Tabla_CO_REPO_HIS_AJUSTE_X_INFLACION  TABLE(
		FECHA_DEL_SALDO DATE,
		FECHA DATETIME,
		MONEDA_ORIGEN VARCHAR(20),
		RUBROCONTABLE NUMERIC (15, 0),
		DESCRIPCION_CUENTA VARCHAR(70),
		ELEMENTO_PATRIMONIAL VARCHAR(40),
		MONETARIO VARCHAR(20),
		TASA NUMERIC (16, 4),
		SALDO_AJUSTADO NUMERIC (38, 2),
		AJUSTE_NM NUMERIC (38, 2),
		COMPROBACION_MONETARIAS NUMERIC (38, 2),
		SALDO NUMERIC (38, 2)
	)
	
	INSERT INTO
		@Tabla_CO_REPO_HIS_AJUSTE_X_INFLACION
	SELECT DISTINCT
	    TRY_CAST(H.ULTIMA_FECHA_AJUSTE AS DATE) AS FECHA_DEL_SALDO,
	    H.FECHA,
	    M.C6400 AS MONEDA_ORIGEN,
	    S.RUBROCONTABLE,
	    P.C6300 AS DESCRIPCION_CUENTA,
	    OP.DESCRIPCION AS ELEMENTO_PATRIMONIAL,
	    CASE H.MONETARIO
	        WHEN ''S'' THEN ''Monetaria''
	        ELSE ''No Monetaria''
	    END AS MONETARIO,
	    (H.INDICE_ACTUAL / H.INDICE_ANTERIOR) AS TASA,
	    CASE s.MONEDA
	        WHEN 1 THEN (sum(H.SALDO) + sum(H.MONTO_AJUSTE))
	        WHEN 2 THEN (sum(H.SALDO_MN) + sum(H.MONTO_AJUSTE))
	        WHEN 5 THEN (sum(H.SALDO_MN) + sum(H.MONTO_AJUSTE))
	        WHEN 6 THEN (sum(H.SALDO_MN) + sum(H.MONTO_AJUSTE))
	        WHEN 998 THEN (sum(H.SALDO_MN) + sum(H.MONTO_AJUSTE))
	        WHEN 999 THEN (sum(H.SALDO_MN) + sum(H.MONTO_AJUSTE))
	    END AS SALDO_AJUSTADO,
	    CASE H.MONETARIO
	        WHEN ''S'' THEN 0
	        ELSE sum(H.MONTO_AJUSTE)
	    END AS AJUSTE_NM,
	    CASE H.MONETARIO
	        WHEN ''S'' THEN sum(H.MONTO_AJUSTE)
	        ELSE 0
	    END AS COMPROBACION_MONETARIAS,
	    CASE s.MONEDA
	        WHEN 1 THEN sum(H.SALDO)
	        ELSE
	       CASE s.MONEDA
	          WHEN 2 THEN
	               (sum(H.SALDO_MN))
	          WHEN 5 THEN
	               (sum(H.SALDO_MN))
	          WHEN 6 THEN
	               (sum(H.SALDO_MN))
	          WHEN 988 THEN
	               (sum(H.SALDO_MN))
	          WHEN 999 THEN
	               (sum(H.SALDO_MN))
	          END        
	    END AS SALDO
	FROM
	    CO_HIS_AJUSTE_X_INFLACION AS H WITH (nolock)
	INNER JOIN GRL_SALDOS_DIARIOS AS S WITH (nolock) ON
	    H.SALDO_JTS_OID = S.SALDOS_JTS_OID
	    AND S.TZ_LOCK = 0
	INNER JOIN PLANCTAS AS P WITH (nolock) ON
	    S.RUBROCONTABLE = P.C6326
	    AND P.TZ_LOCK = 0
	INNER JOIN MONEDAS M WITH (nolock) ON
	    M.C6399 = S.MONEDA
	INNER JOIN OPCIONES AS OP WITH (nolock) ON
		OP.OPCIONINTERNA = P.C6304
	    AND OP.IDIOMA = ''E''
	    AND OP.NUMERODECAMPO = 6304
	WHERE
	    H.FECHA = @P_FECHA_SALDO
	AND S.FECHA= (SELECT dbo.ultimodiahabil(DATEADD(MONTH,-1, @P_FECHA_SALDO)))
	GROUP BY
	    S.RUBROCONTABLE,H.FECHA, H.ULTIMA_FECHA_AJUSTE,M.C6400,P.C6300,OP.DESCRIPCION, H.MONETARIO, H.INDICE_ACTUAL, H.INDICE_ANTERIOR, S.MONEDA
	ORDER BY
	    S.RUBROCONTABLE
	
	BEGIN TRANSACTION
	
		BEGIN TRY
		
	    	DELETE CR
	    	FROM CO_REPO_HIS_AJUSTE_X_INFLACION AS CR WITH (NOLOCK)
	    	INNER JOIN @Tabla_CO_REPO_HIS_AJUSTE_X_INFLACION AS TC ON
				TC.FECHA = CR.FECHA
				AND TC.RUBROCONTABLE = CR.RUBROCONTABLE
				AND TC.MONEDA_ORIGEN = CR.MONEDA_ORIGEN
			
	    	INSERT INTO CO_REPO_HIS_AJUSTE_X_INFLACION
			SELECT
				TC.FECHA_DEL_SALDO,
		      	TC.FECHA,
		      	TC.RUBROCONTABLE,
		      	TC.DESCRIPCION_CUENTA,
		      	TC.ELEMENTO_PATRIMONIAL,
		      	TC.MONETARIO,
		      	TC.TASA,
		      	TC.SALDO_AJUSTADO,
		      	TC.AJUSTE_NM,
		      	TC.COMPROBACION_MONETARIAS,
		      	TC.SALDO,
		      	TC.MONEDA_ORIGEN
			FROM @Tabla_CO_REPO_HIS_AJUSTE_X_INFLACION AS TC
			--WHERE TC.FECHA NOT IN (SELECT FECHA FROM CO_REPO_HIS_AJUSTE_X_INFLACION)
			--AND TC.RUBROCONTABLE NOT IN (SELECT RUBROCONTABLE FROM CO_REPO_HIS_AJUSTE_X_INFLACION)
			--AND TC.MONEDA_ORIGEN NOT IN (SELECT MONEDA_ORIGEN FROM CO_REPO_HIS_AJUSTE_X_INFLACION)
			
			/*UPDATE CR
			SET 
			   	CR.FECHA_DEL_SALDO = TC.FECHA_DEL_SALDO, 
		      	CR.FECHA = TC.FECHA, 
		      	CR.MONEDA_ORIGEN = TC.MONEDA_ORIGEN, 
		      	CR.RUBROCONTABLE = TC.RUBROCONTABLE,
		      	CR.DESCRIPCION_CUENTA = TC.DESCRIPCION_CUENTA,
		      	CR.ELEMENTO_PATRIMONIAL = TC.ELEMENTO_PATRIMONIAL,
		      	CR.MONETARIO = TC.MONETARIO,
		      	CR.TASA = TC.TASA,
		      	CR.SALDO_AJUSTADO = TC.SALDO_AJUSTADO,
		      	CR.AJUSTE_NM = TC.AJUSTE_NM,
		      	CR.COMPROBACION_MONETARIA = TC.COMPROBACION_MONETARIAS,
		      	CR.SALDO = TC.SALDO
			FROM
				CO_REPO_HIS_AJUSTE_X_INFLACION AS CR WITH (NOLOCK)
			INNER JOIN @Tabla_CO_REPO_HIS_AJUSTE_X_INFLACION AS TC ON
				TC.FECHA = CR.FECHA
				AND TC.RUBROCONTABLE = CR.RUBROCONTABLE 
				AND TC.MONEDA_ORIGEN = CR.MONEDA_ORIGEN
			*/
			
			COMMIT TRANSACTION;
			
			SET @P_RET_PROCESO = 1
		    SET @P_MSG_PROCESO = ''Se generaron datos del reporte exitosamente.''
		
		END TRY
		
		BEGIN CATCH
			ROLLBACK TRANSACTION
			SET @P_RET_PROCESO = ERROR_NUMBER()
			SET @P_MSG_PROCESO = ERROR_MESSAGE()
			EXECUTE dbo.pkg_constantes$VarcharConstantes ''C_LOG_TIPO_ERROR'', @v_constante OUTPUT;
		END CATCH
		
END
')

