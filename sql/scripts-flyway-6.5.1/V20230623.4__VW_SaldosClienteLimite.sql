EXECUTE ('
IF OBJECT_ID (''dbo.VW_SaldosClienteLimite'') IS NOT NULL
	DROP VIEW dbo.VW_SaldosClienteLimite
')

EXECUTE ('
CREATE   VIEW [dbo].[VW_SaldosClienteLimite] 
AS 
select	s.C1803 AS cliente, 
			CASE WHEN C1785=6 THEN ((C1604*-1)+C1608)
				ELSE 
			(CASE			
			WHEN (C1604+C1605) < 0 THEN
				(C1604+C1605) * -1
			WHEN s.C1785=6 THEN ((C1604*-1)+C1608)
			ELSE
				(C1604+C1605)
			END) END  
		 AS IMPORTE,
		CASE WHEN s.C1785=6 THEN s.C1600 ELSE s.C1601 END AS CAPITAL_ORIGINAL,
		s.c1608 AS INTERESES,
		s.moneda as MONEDA,
		s.jts_oid AS SALDO_JTS_OID,
		p.c6283 as FAMILIAPROD,
		s.PRODUCTO,
		s.c1612 as CUOTA_APROBADA,
		s.MATRICULA_LIMITE,
		CASE WHEN C1785=5 THEN ad.SALDO_DEUDA 
			 WHEN C1785=6 THEN ((C1604*-1)+C1608)
				ELSE 
			 	(CASE			
					WHEN (C1604+C1605) < 0 THEN
						(C1604+C1605) * -1
					WHEN s.C1785=6 THEN ((C1604*-1)+C1608)
					ELSE
						(C1604+C1605)
				END) 
		END AS SALDO_DEUDA
from saldos s WITH (NOLOCK)
INNER JOIN productos p WITH (NOLOCK)ON s.producto = p.C6250
									and p.tz_lock = 0
									and (p.EVALUA_DEUDA = ''S'') 	
INNER JOIN planctas pc WITH (NOLOCK) ON pc.C6326 = s.C1730
									and pc.tz_lock = 0
INNER JOIN VW_ASISTENCIAS_DEUDA ad WITH (NOLOCK) ON ad.JTS_OID=s.JTS_OID									
WHERE S.C1604 < 0 AND (s.tz_lock = 0 	OR (s.TZ_LOCK > 099999999999999 AND s.TZ_LOCK < 199999999999999 ))
UNION												
SELECT	s.C1803 AS CLIENTE, 
		v.IMPORTE AS IMPORTE, 
		v.IMPORTE AS  CAPITAL_ORIGINAL, 
		0 AS INTERES,
		s.MONEDA AS MONEDA,
		s.JTS_OID AS SALDO_JTS_OID, 
		p.C6283 as FAMILIAPROD, 
		v.NROLINEA AS PRODUCTO,
		0 AS CUOTA_APROBADA , 
		'' '' AS MATRICULA_LIMITE,
		0 AS SALDO_DEUDA
FROM VTA_SOBREGIROS v WITH(NOLOCK)
INNER JOIN SALDOS s WITH(NOLOCK) ON v.JTS_OID_SALDO = s.JTS_OID AND s.TZ_LOCK = 0
INNER JOIN PRODUCTOS p WITH(NOLOCK) ON v.NROLINEA = p.C6250 
									AND p.TZ_LOCK = 0
									AND  p.EVALUA_DEUDA = ''S''
INNER JOIN MONEDAS m WITH(NOLOCK) ON s.MONEDA = m.C6399 AND m.TZ_LOCK = 0
INNER JOIN SUCURSALES suc WITH(NOLOCK) ON v.SUCURSAL_ACUERDO = suc.SUCURSAL 
										AND suc.TZ_LOCK = 0
										AND v.ESTADO = 1 
										AND v.TZ_LOCK =0
')