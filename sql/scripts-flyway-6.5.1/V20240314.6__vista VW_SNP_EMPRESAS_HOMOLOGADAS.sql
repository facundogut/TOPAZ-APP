EXECUTE('
IF OBJECT_ID (''dbo.VW_SNP_EMPRESAS_HOMOLOGADAS'') IS NOT NULL
	DROP VIEW dbo.VW_SNP_EMPRESAS_HOMOLOGADAS
')
EXECUTE('
CREATE VIEW VW_SNP_EMPRESAS_HOMOLOGADAS
AS
SELECT
	DISTINCT
		PE.CUIT_EO,
		(	
			SELECT TOP 1 NOMBRE_EMPRESA
			FROM SNP_PRESTACIONES_EMPRESAS
			WHERE 
				CUIT_EO = PE.CUIT_EO
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  )
		) AS NOMBRE_EMPRESA,
		SUBSTRING(CONVERT(VARCHAR, PE.ENTIDAD), 1, LEN(PE.ENTIDAD)-4) AS ENTIDAD,
	   	(
			SELECT TOP 1 ENTIDAD
			FROM SNP_PRESTACIONES_EMPRESAS
			WHERE
				CUIT_EO = PE.CUIT_EO
				AND SUBSTRING(CONVERT(VARCHAR, ENTIDAD), 1, LEN(ENTIDAD)-4) =
					SUBSTRING(CONVERT(VARCHAR, PE.ENTIDAD), 1, LEN(PE.ENTIDAD)-4)
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  )
		) AS ENTIDAD_ORIGINANTE,
		(	
			SELECT TOP 1 NOMENTIDAD
			FROM SNP_PRESTACIONES_EMPRESAS
			WHERE
				SUBSTRING(CONVERT(VARCHAR, ENTIDAD), 1, LEN(ENTIDAD)-4) =
					SUBSTRING(CONVERT(VARCHAR, PE.ENTIDAD), 1, LEN(PE.ENTIDAD)-4)
				AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
					AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)  )
		) AS NOMBRE_ENTIDAD
FROM SNP_PRESTACIONES_EMPRESAS AS PE WITH (nolock)
WHERE
	((PE.TZ_LOCK < 100000000000000 OR PE.TZ_LOCK >= 200000000000000)
		AND (PE.TZ_LOCK < 300000000000000 OR PE.TZ_LOCK >= 400000000000000)  )
')
