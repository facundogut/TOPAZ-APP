CREATE OR ALTER PROCEDURE [dbo].[PKG_NUM_GETVALUES]
(  
	@NUMERATORNUMBER  	NUMERIC ,
	@POSTINGNUMBER    	NUMERIC ,
	@SUCURSAL         	NUMERIC ,
	@FECHA            	DATETIME,
	@MSGLOG           	VARCHAR(400) OUTPUT, 
	@RETORNO      		NUMERIC OUTPUT
)
	------------------------------------------------------
	-- PKG_NUM_GETVALUES
	-- CREADO POR : JIC		
	-- CREADO : 02-12-2014
	-- Dado un numerador, devuelve su próximo valor.
	-- @NUMERATORNUMBER numerador del que se desea obtener su próximo valor.
	-- @POSTINGNUMBER Nro. de Asiento.
	-- @SUCURSAL Nro. de Sucursal.
	-- @FECHA Fecha.
	-- @MSGLOG Retorna mensaje.
	-- @RETORNO Próximo valor del numerador.
	------------------------------------------------------

AS
	-- Variables
	DECLARE @DIA  		NUMERIC (38, 10) = CAST(CONVERT(varchar(2), @FECHA, 106) AS numeric(38, 10)),
	 		@MES  		NUMERIC (38, 10) = CAST(CONVERT(varchar(2), @FECHA, 101) AS numeric(38, 10)),
			@ANIO 		NUMERIC (38, 10) = CAST(CONVERT(varchar(4), @FECHA, 102) AS numeric(38, 10)),
			@MAXIMO     	NUMERIC (10),
	 		@INCREMENTO 	NUMERIC (10),
			@INIVAL     	NUMERIC (10),
			@NEXTVALUE  	NUMERIC (10),
		 	@POSTING_NUMBER_NUMERATOR		NUMERIC =9999999,
	 		@NUMERATOR_RESERVED     		VARCHAR(1) = 'R',
	 		@NUMERATOR_USED       			VARCHAR(1) = 'U',
	 		@NUMERATOR_CANCELED     		VARCHAR(1) = 'C',
	 		@INICIALIZACION_DIARIA    		VARCHAR(1) = 'D',
	 		@INICIALIZACION_MENSUAL   		VARCHAR(1) = 'M',
	 		@INICIALIZACION_ANUAL     		VARCHAR(1) = 'A',
	 		@SIN_INICIALIZACION       		VARCHAR(1) = ' ',
	 		@NUMERATORNUMBERNEXT 			NUMERIC=0,
			@POSTINGNUMBER_AUX   			NUMERIC,
			@SUCURSALAUX         			NUMERIC,
			@V_VALOR             			NUMERIC,
    		@V_REUTILIZAR 					INT = 0,
    		@ETAPA							INT = 0
	
	--PRAGMA AUTONOMOUS_TRANSACTION;
	
	-- Variables tipo  NUMERATORDEFINITION TABLE 
	DECLARE
		@TY_NUMERATORDEFINITION$NUMERO       NUMERIC (10) ,
		@TY_NUMERATORDEFINITION$INIVAL       NUMERIC (10) ,
		@TY_NUMERATORDEFINITION$INCREMENTO   NUMERIC (10) ,
		@TY_NUMERATORDEFINITION$PERIODO      VARCHAR (1) ,
		@TY_NUMERATORDEFINITION$ULTIMAINIC   DATETIME ,
		@TY_NUMERATORDEFINITION$REUTILIZABLE NUMERIC (5) ,
		@TY_NUMERATORDEFINITION$MAXIMO       NUMERIC (10) ,
		@TY_NUMERATORDEFINITION$CENTRALIZADO NUMERIC (5) 

  	-- Variables tipo  NUMERATORVALUES TABLE 
	DECLARE
		@TY_NUMERATORVALUES$Dia      INT ,
		@TY_NUMERATORVALUES$Mes      INT ,
		@TY_NUMERATORVALUES$Anio     INT ,
		@TY_NUMERATORVALUES$Sucursal INT ,
		@TY_NUMERATORVALUES$Numero   INT ,
		@TY_NUMERATORVALUES$Valor    INT ,
		@TY_NUMERATORVALUES$OID      INT   

	-- Variables tipo  NUMERATORASIGNED TABLE 
	DECLARE
		@TY_NUMERATORASIGNED$OID          NUMERIC (10) ,
		@TY_NUMERATORASIGNED$VALOR        NUMERIC (10) ,
		@TY_NUMERATORASIGNED$FECHAPROCESO DATETIME ,
		@TY_NUMERATORASIGNED$SUCURSAL     NUMERIC (10) ,
		@TY_NUMERATORASIGNED$ESTADO       VARCHAR (1) ,
		@TY_NUMERATORASIGNED$ASIENTO      NUMERIC (10) 

  	--**************************************************************
	--INICIO -------------------------------------------------------
	BEGIN TRY
	BEGIN TRANSACTION
   		-- Se obtiene de NUMERATORDEFINITION la definición del Numerador
		SELECT 	   @TY_NUMERATORDEFINITION$NUMERO=NUMERO,
				   @TY_NUMERATORDEFINITION$INIVAL=INIVAL,
				   @TY_NUMERATORDEFINITION$INCREMENTO=INCREMENTO,
				   @TY_NUMERATORDEFINITION$PERIODO=PERIODO,
				   @TY_NUMERATORDEFINITION$ULTIMAINIC=ULTIMAINIC,
				   @TY_NUMERATORDEFINITION$REUTILIZABLE=REUTILIZABLE,
				   @TY_NUMERATORDEFINITION$MAXIMO=MAXIMO,
				   @TY_NUMERATORDEFINITION$CENTRALIZADO=CENTRALIZADO 
		FROM   NUMERATORDEFINITION WITH(NOLOCK)
		WHERE  NUMERATORDEFINITION.NUMERO = @NUMERATORNUMBER
		
		IF @@ROWCOUNT = 0
			BEGIN
			-- Si no existe el numerador se inicializa  
					SET @TY_NUMERATORDEFINITION$NUMERO       = @NUMERATORNUMBER
					SET @TY_NUMERATORDEFINITION$INIVAL       = 1
					SET @TY_NUMERATORDEFINITION$INCREMENTO   = 1
					SET @TY_NUMERATORDEFINITION$MAXIMO       = 0
					SET @TY_NUMERATORDEFINITION$ULTIMAINIC   = NULL	 
					SET @TY_NUMERATORDEFINITION$PERIODO      = @INICIALIZACION_DIARIA
					SET @TY_NUMERATORDEFINITION$REUTILIZABLE = 1
					SET @TY_NUMERATORDEFINITION$CENTRALIZADO = 0
			           
					SET @ETAPA=1
					
					INSERT NUMERATORDEFINITION(
												NUMERO, 
												INIVAL, 
												INCREMENTO, 
												PERIODO, 
												ULTIMAINIC, 
												REUTILIZABLE, 
												MAXIMO, 
												CENTRALIZADO)
					VALUES (
							@TY_NUMERATORDEFINITION$NUMERO, 
							@TY_NUMERATORDEFINITION$INIVAL, 
							@TY_NUMERATORDEFINITION$INCREMENTO, 
							@TY_NUMERATORDEFINITION$PERIODO, 
							@TY_NUMERATORDEFINITION$ULTIMAINIC, 
							@TY_NUMERATORDEFINITION$REUTILIZABLE, 
							@TY_NUMERATORDEFINITION$MAXIMO, 
							@TY_NUMERATORDEFINITION$CENTRALIZADO)
			END			
		
		-- Se cargan datos de inicialización para el Numerador (NUMERATORVALUES)
		IF (@INICIALIZACION_DIARIA = @TY_NUMERATORDEFINITION$PERIODO) 
			BEGIN
			  --PRINT '@INICIALIZACION_DIARIA = @TY_NUMERATORDEFINITION$PERIODO'	
			  SET @TY_NUMERATORVALUES$ANIO = @ANIO
			  SET @TY_NUMERATORVALUES$MES  = @MES
			  SET @TY_NUMERATORVALUES$DIA  = @DIA
			END
		ELSE 
			BEGIN  
				IF @INICIALIZACION_MENSUAL = @TY_NUMERATORDEFINITION$PERIODO 
					BEGIN
						--PRINT '@INICIALIZACION_MENSUAL = @TY_NUMERATORDEFINITION$PERIODO'
						SET @TY_NUMERATORVALUES$ANIO = @ANIO
						SET @TY_NUMERATORVALUES$MES  = @MES
						SET @TY_NUMERATORVALUES$DIA  = 0
					END
			    ELSE 
					BEGIN
						IF @INICIALIZACION_ANUAL = @TY_NUMERATORDEFINITION$PERIODO 
							BEGIN
							  --PRINT '@INICIALIZACION_ANUAL = @TY_NUMERATORDEFINITION$PERIODO'	
							  SET @TY_NUMERATORVALUES$ANIO = @ANIO
							  SET @TY_NUMERATORVALUES$MES  = 0
							  SET @TY_NUMERATORVALUES$DIA  = 0
							END
						ELSE
							BEGIN
							  --PRINT 'SIN INICIALIZACION'	
							  SET @TY_NUMERATORVALUES$ANIO = 0
							  SET @TY_NUMERATORVALUES$MES  = 0
							  SET @TY_NUMERATORVALUES$DIA  = 0
							END  
					END
			END
	
		-- Si el numerador es centralizado se busca en la tabla NUMERADORVALUES el registro con sucursal = 0
		-- En la tabla NUMERATORASIGNED el campo sucursal se llena con la sucursal que pidio el numerador 
		-- independientemente si el numerador era centralizado o no.
		SET @SUCURSALAUX = @SUCURSAL;
		IF  (@TY_NUMERATORDEFINITION$CENTRALIZADO = 1)
			BEGIN
				SET @SUCURSALAUX = 0;
			END;
			
		SET @TY_NUMERATORVALUES$SUCURSAL = @SUCURSALAUX
		SET @TY_NUMERATORVALUES$NUMERO   = @NUMERATORNUMBER

		SELECT 
			@TY_NUMERATORVALUES$DIA = NUMERATORVALUES.DIA, 
			@TY_NUMERATORVALUES$MES = NUMERATORVALUES.MES, 
			@TY_NUMERATORVALUES$ANIO = NUMERATORVALUES.ANIO, 
			@TY_NUMERATORVALUES$SUCURSAL = NUMERATORVALUES.SUCURSAL, 
			@TY_NUMERATORVALUES$NUMERO = NUMERATORVALUES.NUMERO, 
			@TY_NUMERATORVALUES$VALOR = NUMERATORVALUES.VALOR, 
			@TY_NUMERATORVALUES$OID = NUMERATORVALUES.OID
		FROM dbo.NUMERATORVALUES WITH (UPDLOCK)
		WHERE 
			NUMERATORVALUES.SUCURSAL = @TY_NUMERATORVALUES$SUCURSAL	AND 
			NUMERATORVALUES.NUMERO =   @TY_NUMERATORVALUES$NUMERO	AND 
			NUMERATORVALUES.ANIO = 	   @TY_NUMERATORVALUES$ANIO 	AND 
			NUMERATORVALUES.MES = 	   @TY_NUMERATORVALUES$MES  	AND 
			NUMERATORVALUES.DIA = 	   @TY_NUMERATORVALUES$DIA
		
    	IF (@@ROWCOUNT = 0)
    	-- Si no existe valor para el númerador se inicializa 
	        BEGIN
	    	-- Valor inicial
			SET @TY_NUMERATORVALUES$VALOR = @TY_NUMERATORDEFINITION$INIVAL
			
			SET @ETAPA=2
			INSERT NUMERATORVALUES(
									DIA, 
									MES, 
									ANIO, 
									SUCURSAL, 
									NUMERO, 
									VALOR 
									)
			VALUES (
					@TY_NUMERATORVALUES$DIA, 
					@TY_NUMERATORVALUES$MES, 
					@TY_NUMERATORVALUES$ANIO, 
					@TY_NUMERATORVALUES$SUCURSAL, 
					@TY_NUMERATORVALUES$NUMERO, 
					@TY_NUMERATORVALUES$VALOR
					)
					
			-- [Obtengo] OID Asignado
			SELECT	@TY_NUMERATORVALUES$OID = @@IDENTITY
			FROM 	NUMERATORVALUES WITH(NOLOCK)
			WHERE 
					SUCURSAL = @TY_NUMERATORVALUES$SUCURSAL AND 
					NUMERO = @TY_NUMERATORVALUES$NUMERO AND 
					ANIO = @TY_NUMERATORVALUES$ANIO AND 
					MES = @TY_NUMERATORVALUES$MES AND 
					DIA = @TY_NUMERATORVALUES$DIA
		   END				
		-- Si el numerador es reutilizable
		IF (@TY_NUMERATORDEFINITION$REUTILIZABLE = 1) 
		-- Se averigua si hay algún valor para reutilizar    	
			BEGIN 
				-- [Obtengo] valor para reutilizar
				SELECT 
						@TY_NUMERATORASIGNED$OID = NUMERATORASIGNED.OID, 
						@TY_NUMERATORASIGNED$VALOR = NUMERATORASIGNED.VALOR, 
						@TY_NUMERATORASIGNED$FECHAPROCESO = NUMERATORASIGNED.FECHAPROCESO, 
						@TY_NUMERATORASIGNED$SUCURSAL = NUMERATORASIGNED.SUCURSAL, 
						@TY_NUMERATORASIGNED$ESTADO = NUMERATORASIGNED.ESTADO, 
						@TY_NUMERATORASIGNED$ASIENTO = NUMERATORASIGNED.ASIENTO
				FROM   	NUMERATORASIGNED WITH(NOLOCK)
				WHERE  	NUMERATORASIGNED.OID = @TY_NUMERATORVALUES$OID AND
				     	NUMERATORASIGNED.ESTADO = @NUMERATOR_CANCELED AND
				     	VALOR =
								(SELECT MIN(NUMERATORASIGNED.VALOR)
								FROM   NUMERATORASIGNED WITH(NOLOCK)
								WHERE  NUMERATORASIGNED.OID = @TY_NUMERATORVALUES$OID AND
								NUMERATORASIGNED.ESTADO = @NUMERATOR_CANCELED)
		        IF (@@ROWCOUNT = 0)
		        -- No hay valor para reutilizar
					BEGIN
						SET @V_REUTILIZAR = 0
					END
				ELSE
				-- Hay valor para reutilizar
					BEGIN
						SET @V_REUTILIZAR = 1
					END	
			END
		-- Si hay valor para reutilizar	 
		IF (@V_REUTILIZAR=1) 
			BEGIN
				SET @V_VALOR = @TY_NUMERATORASIGNED$VALOR
				-- Si se está pidiendo un numerador de asientos
				IF @POSTINGNUMBER = @POSTING_NUMBER_NUMERATOR 
					BEGIN
						SET   @POSTINGNUMBER_AUX = @NUMERATORNUMBER + @V_VALOR
					END
				ELSE
					BEGIN
						SET @POSTINGNUMBER_AUX = @POSTINGNUMBER
					END;
		      
		        SET @TY_NUMERATORASIGNED$ESTADO = @NUMERATOR_RESERVED
		        SET @TY_NUMERATORASIGNED$ASIENTO = @POSTINGNUMBER_AUX
		        SET @TY_NUMERATORASIGNED$FECHAPROCESO = @FECHA
		        SET @TY_NUMERATORASIGNED$SUCURSAL = @SUCURSAL
		      
		        SET @ETAPA=3
				UPDATE 	NUMERATORASIGNED
				SET		ESTADO 		 = @TY_NUMERATORASIGNED$ESTADO,
						ASIENTO      = @TY_NUMERATORASIGNED$ASIENTO,
						FECHAPROCESO = @TY_NUMERATORASIGNED$FECHAPROCESO,
						SUCURSAL     = @TY_NUMERATORASIGNED$SUCURSAL
				WHERE	VALOR 		 = @TY_NUMERATORASIGNED$VALOR AND
						OID 		 = @TY_NUMERATORVALUES$OID AND
						ESTADO 		 = @NUMERATOR_CANCELED;
	         END        
		-- Obtenemos el próximo valor del numerador
	    SET @V_VALOR    = @TY_NUMERATORVALUES$VALOR
		SET @MAXIMO     = @TY_NUMERATORDEFINITION$MAXIMO
		SET @INCREMENTO = @TY_NUMERATORDEFINITION$INCREMENTO
		SET @INIVAL     = @TY_NUMERATORDEFINITION$INIVAL
	    
	    -- Incrementamos el próximo valor del numerador
	    IF (@MAXIMO = 0 OR (@V_VALOR + @INCREMENTO) < @MAXIMO)
			BEGIN
				SET @NEXTVALUE = @V_VALOR + @INCREMENTO
			END
		-- Si el numerador no tiene máximo o aún no lo sobrepasó lo incrementamos según lo que indiquen los datos del numerador
		ELSE
			BEGIN
				SET @NEXTVALUE = @INIVAL
			END
	    -- Actualizamos el próximo valor del numerador
	    SET @TY_NUMERATORVALUES$VALOR = @NEXTVALUE
		
		SET @ETAPA=4
		UPDATE 	NUMERATORVALUES
		SET    	VALOR = @TY_NUMERATORVALUES$VALOR
		WHERE  	DIA =   @TY_NUMERATORVALUES$DIA AND
				MES =   @TY_NUMERATORVALUES$MES AND
				ANIO =  @TY_NUMERATORVALUES$ANIO AND
				SUCURSAL = @TY_NUMERATORVALUES$SUCURSAL AND
				NUMERO = @TY_NUMERATORVALUES$NUMERO AND
				OID = @TY_NUMERATORVALUES$OID;
	    
	    -- Si se está pidiendo un numerador de asientos
		IF (@POSTINGNUMBER =@POSTING_NUMBER_NUMERATOR) 
			BEGIN
				SET @POSTINGNUMBER_AUX = @NUMERATORNUMBER + @V_VALOR
			END
		ELSE
			BEGIN
				SET @POSTINGNUMBER_AUX =  @POSTINGNUMBER
			END;
	    
		-- Registramos el valor que se está retornando en la tabla NumAsignados
		-- debido a que el numerador pudo haber llegado a su maximo el valor del numerador, ya puede haber sido
		-- asignado en otro momento, lo que implica que no puedo hacer directamente un insert, por eso primero [hago] un load
		-- si no existe lo inserto, si existe lo actualizo  
		SET @TY_NUMERATORASIGNED$OID   = @TY_NUMERATORVALUES$OID
		SET @TY_NUMERATORASIGNED$VALOR = @V_VALOR
	    
	   	-- SELECCIONO NUMERO ASIGNADO
		SELECT 
			@TY_NUMERATORASIGNED$OID = OID, 
			@TY_NUMERATORASIGNED$VALOR = VALOR, 
			@TY_NUMERATORASIGNED$FECHAPROCESO = FECHAPROCESO, 
			@TY_NUMERATORASIGNED$SUCURSAL = SUCURSAL, 
			@TY_NUMERATORASIGNED$ESTADO = ESTADO, 
			@TY_NUMERATORASIGNED$ASIENTO = ASIENTO
		FROM NUMERATORASIGNED WITH ( UPDLOCK )
		WHERE OID = @TY_NUMERATORASIGNED$OID 
		AND VALOR = @TY_NUMERATORASIGNED$VALOR
		
		-- Si no existe valor se inserta	
		IF (@@ROWCOUNT = 0)
			BEGIN	
				SET @TY_NUMERATORASIGNED$VALOR        = @V_VALOR
				SET @TY_NUMERATORASIGNED$ASIENTO      = @POSTINGNUMBER_AUX
				SET @TY_NUMERATORASIGNED$ESTADO       = @NUMERATOR_RESERVED
				SET @TY_NUMERATORASIGNED$FECHAPROCESO = @FECHA
				SET @TY_NUMERATORASIGNED$SUCURSAL     = @SUCURSAL
		      
		      	SET @ETAPA=5
				INSERT NUMERATORASIGNED(
										OID, 
										VALOR, 
										FECHAPROCESO, 
										SUCURSAL, 
										ESTADO, 
										ASIENTO)
				VALUES (
										@TY_NUMERATORASIGNED$OID, 
										@TY_NUMERATORASIGNED$VALOR, 
										@TY_NUMERATORASIGNED$FECHAPROCESO, 
										@TY_NUMERATORASIGNED$SUCURSAL, 
										@TY_NUMERATORASIGNED$ESTADO, 
										@TY_NUMERATORASIGNED$ASIENTO)
		    END
	    	
	    -- El valor del numerador ya habia sido dado previamente(se [llego] al maximo), se actualiza sucursal, asiento, fecha, etc.
     	UPDATE NUMERATORASIGNED
        SET    FECHAPROCESO = @TY_NUMERATORASIGNED$FECHAPROCESO,
               SUCURSAL     = @TY_NUMERATORASIGNED$SUCURSAL,
               ESTADO       = @TY_NUMERATORASIGNED$ESTADO,
               ASIENTO      = @TY_NUMERATORASIGNED$ASIENTO
        WHERE  OID = @TY_NUMERATORASIGNED$OID AND
               VALOR = @TY_NUMERATORASIGNED$VALOR
		        
	    -- COMMIT AL FINAL
		IF (@@TRANCOUNT > 0)
			SET @RETORNO=@V_VALOR
			SET @MSGLOG = 'OK Se obtuvo el proximo valor del numerador: ' 
							+ STR(@NUMERATORNUMBER) 
							+ '. Sucursal: '+ STR(@SUCURSAL) 
							+ '. Fecha: '+ CONVERT(varchar(10), @FECHA,103)
							+ '. Valor: '+ STR(@V_VALOR)
							+ '. Error: '+ STR(@@ERROR)
								
			COMMIT TRANSACTION
			RETURN 1
	END TRY
	BEGIN CATCH
		-- SEGUN EL ERROR
		IF (@@TRANCOUNT > 0)
			BEGIN
				IF @ETAPA=1
					SET @MSGLOG ='1 Error al insertar en NUMERATORDEFINITION, numerador ' 
									+ STR(@NUMERATORNUMBER) + '. Error: ' + STR(@@ERROR)
							
			    ELSE IF @ETAPA=2
					SET @MSGLOG ='2 Error al insertar en NUMERATORVALUES, numerador: ' 
									+ STR(@NUMERATORNUMBER) + '. Error: ' + STR(@@ERROR)
								
				ELSE IF @ETAPA=3
					SET @MSGLOG ='3 Error al insertar en NUMERATORASIGNED, OID: ' 
									+ STR(@TY_NUMERATORVALUES$OID)+ '. Error: ' +STR(@@ERROR)
			  	ELSE IF @ETAPA=4  				
					SET @MSGLOG ='4 Error al insertar en NUMERATORASIGNED, OID: ' 
									+ STR(@TY_NUMERATORASIGNED$OID)+ '. Error: ' +STR(@@ERROR)
				ELSE IF @ETAPA=5
					SET @MSGLOG ='5 No se puede obtener el proximo valor del numerador: ' 
								   	+ STR(@NUMERATORNUMBER) 
								   	+ '. Sucursal: '+ STR(@SUCURSAL)  
									+ '. Fecha: '+ CONVERT(varchar(10), @FECHA,103)
								    + '. Error: '+ STR(@@ERROR)
										
			END
		-- ROLLBACK SI HAY ERROR	
		SET @RETORNO=NULL		
		ROLLBACK TRANSACTION
		RETURN 0
	END CATCH;


