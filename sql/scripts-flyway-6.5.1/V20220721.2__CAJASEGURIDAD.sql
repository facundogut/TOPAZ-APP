EXECUTE('
IF OBJECT_ID (''dbo.VW_PODERES_PERSONAS_COFRES'') IS NOT NULL
	DROP VIEW dbo.VW_PODERES_PERSONAS_COFRES
')

EXECUTE('
CREATE   VIEW [dbo].[VW_PODERES_PERSONAS_COFRES] (
													   NUMERO_CONTRATO, 
													   TIPODOC, 
													   NUMERODOC, 
													   NUMEROPERSONA, 
													   TITULARIDAD, 
													   TIPOPERSONA, 
													   NOMBRE, 
													   PODER, 
													   ESTADO, 
													   DEPENDENCIA)
AS 
   SELECT 
      --SUBSTRING(CAST(w.NROCUENTA AS VARCHAR),2,LEN(w.NROCUENTA)-1) AS numero_contrato, 
      x.[CODIGO] AS numero_contrato,
      v.TIPODOCUMENTO AS tipodoc, 
      v.NUMERODOCUMENTO AS numerodoc, 
      v.NUMEROPERSONAFJ AS numeropersona, 
      CASE w.CATEGORIA
         WHEN ''A'' THEN ''TITULAR''
         WHEN ''B'' THEN ''TITULAR''
         ELSE ''AUTORIZADO''
      END AS titularidad, 
      v.TIPOPERSONA, 
      ISNULL(u.PRIMERNOMBRE, '''') + '' '' + ISNULL(u.APELLIDOPATERNO, '''') + '' '' + ISNULL(u.APELLIDOMATERNO, '''') AS NOMBRE, 
      w.TIPO_PODER, 
      x.ESTADO, 
      y.DEPENDENCIA
   FROM 
      dbo.CLI_PERSONASFISICAS  AS u WITH (NOLOCK)
      INNER JOIN dbo.CLI_DOCUMENTOSPFPJ  AS v WITH (NOLOCK)ON u.NUMEROPERSONAFISICA = v.NUMEROPERSONAFJ AND v.TZ_LOCK = 0
      INNER JOIN dbo.PYF_APODERADOS  AS w WITH (NOLOCK) ON w.ID_PERSONA = u.NUMEROPERSONAFISICA  AND w.TIPO_PODER IN (10,11)AND w.TZ_LOCK = 0
      INNER JOIN dbo.COF_COFRES_CONTRATOS  AS x WITH (NOLOCK) ON w.ID_ENTIDAD = x.CODIGO_COFRE AND x.TZ_LOCK = 0
      INNER JOIN dbo.COF_COFRES  AS y WITH (NOLOCK) ON x.CODIGO_COFRE = y.CODIGO AND y.TZ_LOCK = 0
   WHERE  u.TZ_LOCK = 0

  UNION ALL
   SELECT 
      --SUBSTRING(CAST(w.NROCUENTA AS VARCHAR),2,LEN(w.NROCUENTA)-1) AS numero_contrato, 
      x.[CODIGO],
      v.TIPODOCUMENTO AS tipodoc, 
      v.NUMERODOCUMENTO AS numerodoc, 
      v.NUMEROPERSONAFJ AS numeropersona, 
      CASE w.CATEGORIA
         WHEN ''A'' THEN ''TITULAR''
         WHEN ''B'' THEN ''TITULAR''
         ELSE ''AUTORIZADO''
      END AS titularidad, 
      v.TIPOPERSONA, 
      s.RAZONSOCIAL AS NOMBRE, 
      w.TIPO_PODER, 
      x.ESTADO, 
      y.DEPENDENCIA
   FROM 
      dbo.CLI_PERSONASJURIDICAS  AS s WITH (NOLOCK) 
      INNER JOIN dbo.CLI_DOCUMENTOSPFPJ  AS v WITH (NOLOCK) ON s.NUMEROPERSONAJURIDICA = v.NUMEROPERSONAFJ  AND v.TZ_LOCK = 0 
      INNER JOIN dbo.PYF_APODERADOS  AS w WITH (NOLOCK)ON  w.ID_PERSONA = s.NUMEROPERSONAJURIDICA AND w.TZ_LOCK = 0  AND w.TIPO_PODER IN (10,11) 
      INNER JOIN dbo.COF_COFRES_CONTRATOS  AS x WITH (NOLOCK) ON w.ID_ENTIDAD = x.CODIGO_COFRE AND x.TZ_LOCK = 0
      INNER JOIN dbo.COF_COFRES  AS y WITH (NOLOCK) ON x.CODIGO_COFRE = y.CODIGO AND y.TZ_LOCK = 0
   WHERE s.TZ_LOCK = 0 
')

EXECUTE('
IF OBJECT_ID (''dbo.VW_COFRES_VISITAS'') IS NOT NULL
	DROP VIEW dbo.VW_COFRES_VISITAS
')

EXECUTE('
CREATE VIEW [dbo].[VW_COFRES_VISITAS] (
											   [CODIGO_CONTRATO], 
											   [CODIGO_EVENTO], 
											   PAIS_DOCUMENTO, 
											   TIPO_DOCUMENTO, 
											   NUMERO_DOCUMENTO, 
											   NUMERO_PERSONA, 
											   TIPO_PERSONA, 
											   NOMBRE_PERSONA, 
											   TITULARIDAD,  
											   FECHA_EVENTO,
											   ESTADO_CONTRATO,
											   ESTADO_EVENTO,
											   DEPENDENCIA)
AS 
SELECT
		C.[CODIGO_CONTRATO], 
		E.[CODIGO_EVENTO], 
		D.PAISDOCUMENTO AS PAIS_DOCUMENTO, 
		D.TIPODOCUMENTO AS TIPO_DOCUMENTO, 
		D.NUMERODOCUMENTO AS NUMERO_DOCUMENTO, 
		E.NUMERO_PERSONA, 
		D.TIPOPERSONA AS TIPO_PERSONA, 
		(ISNULL(F.PRIMERNOMBRE, '''') + '' '' + ISNULL(F.APELLIDOPATERNO, '''')) AS NOMBRE_PERSONA, 
		CASE W.[CATEGORIA]
			WHEN ''A'' THEN ''TITULAR''
			WHEN ''B'' THEN ''TITULAR''
			ELSE ''AUTORIZADO''
		END AS TITULARIDAD, 
		C.FECHA_EVENTO,
		X.ESTADO,
		OE.DESCRIPCION,
		Y.DEPENDENCIA
FROM 
	COF_COFRES_DETALLE_EVENTOS AS E
INNER JOIN COF_COFRES_EVENTOS AS C WITH (nolock) ON 
	C.NUMERO_EVENTO = E.[CODIGO_EVENTO] 
	AND C.TIPO_EVENTO = ''V''
	AND C.TZ_LOCK = 0
INNER JOIN CLI_PERSONASFISICAS AS F WITH (nolock) ON 
	E.NUMERO_PERSONA = F.NUMEROPERSONAFISICA 
	AND F.TZ_LOCK = 0
INNER JOIN CLI_DOCUMENTOSPFPJ AS D WITH (nolock) ON 
	E.NUMERO_PERSONA = D.NUMEROPERSONAFJ
	AND D.TZ_LOCK = 0
INNER JOIN PYF_APODERADOS AS W WITH (nolock) ON 
	W.ID_PERSONA = F.NUMEROPERSONAFISICA 
	AND W.TIPO_PODER = 10
	AND W.TIPO_ENTIDAD = 3
	AND W.TZ_LOCK = 0
INNER JOIN COF_COFRES_CONTRATOS AS X WITH (nolock) 
	ON X.[CODIGO_COFRE] = W.ID_ENTIDAD
	AND X.[CODIGO] = C.[CODIGO_CONTRATO]
	AND X.TZ_LOCK = 0
INNER JOIN COF_COFRES AS Y WITH (nolock) ON 
	Y.[CODIGO] = X.[CODIGO_COFRE]
	AND Y.TZ_LOCK = 0
LEFT JOIN OPCIONES AS OE WITH (nolock) ON
	OE.NUMERODECAMPO = 8987
	AND OE.OPCIONINTERNA = C.ESTADO
	AND OE.IDIOMA = ''E''
WHERE E.TZ_LOCK = 0
----------------------
')

EXECUTE('
DELETE FROM dbo.PYF_TIPOENTIDAD
WHERE TIPO_ENTIDAD = 3

INSERT INTO dbo.PYF_TIPOENTIDAD (TZ_LOCK, TIPO_ENTIDAD, DESCRIPCION)
VALUES (0, 3, ''Caja de seguridad'')

INSERT INTO dbo.PYF_TIPOPODER_X_TIPOENTIDAD (TZ_LOCK, TIPO_ENTIDAD, TIPO_PODER, DESCRIPCION)
VALUES (0, 3, 10, '''')

INSERT INTO dbo.PYF_TIPOPODER_X_TIPOENTIDAD (TZ_LOCK, TIPO_ENTIDAD, TIPO_PODER, DESCRIPCION)
VALUES (0, 3, 11, '''')

DELETE FROM dbo.PYF_TIPOPODER_X_TIPOENTIDAD
WHERE TIPO_ENTIDAD = 2 AND TIPO_PODER = 10

DELETE FROM dbo.PYF_TIPOPODER_X_TIPOENTIDAD
WHERE TIPO_ENTIDAD = 2 AND TIPO_PODER = 11
')





