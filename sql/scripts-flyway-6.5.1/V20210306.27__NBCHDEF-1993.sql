EXECUTE('
ALTER PROCEDURE SP_AE_PRIMARIA_SECUNDARIA 
@COD_PERSONA  NUMERIC(12,0),
@COD_ACTIVIDAD  varchar(12),
@RESULTADO VARCHAR(12) OUTPUT
AS
BEGIN
	SET @RESULTADO = NULL;
   	SELECT @RESULTADO = TIPO_ACTIVIDAD FROM VW_ACT_ECO_WS WHERE CODIGO_PERSONA= @COD_PERSONA AND COD_ACTIVIDAD= @COD_ACTIVIDAD;
   	--- BUSCO SI LA ACTIVIDAD ESTA DADA DE BAJA EN LA TEMP_CLI_ACTIVIDAD_ECONOMICA
   	IF(@RESULTADO IS NULL)
   	  BEGIN
   	  SET @RESULTADO = ( SELECT TOP 1 TIPO_ACTIVIDAD FROM 
   		
   		(SELECT
   				c.CODIGO_ACTIVIDAD AS COD_ACTIVIDAD,
   				c.CODIGO_PERSONA_CLIENTE AS CODIGO_PERSONA,
				(
				CASE 
				WHEN c.ORDEN_AFIP=1 THEN ''Primaria''
				WHEN (SELECT COUNT(*) 
					  FROM ITF_AFIP_ACT_ECONOMICA WITH (NOLOCK) 
					  WHERE CUIL=c.CUIL)=0 AND
							(SELECT COUNT(*) 
						  	FROM TEMP_CLI_ACTIVIDAD_ECONOMICA WITH (NOLOCK) 
						  	WHERE CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE AND ORDEN_AFIP=1 
							AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) 
						    AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000))) = 0	AND
								((SELECT MIN(u.ORDINAL_ACTIVIDAD) 
								  FROM CLI_ACTIVIDAD_ECONOMICA u WITH (NOLOCK)
								  WHERE u.TZ_LOCK=0 
										AND u.CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE 
										AND ((u.TZ_LOCK < 300000000000000 OR u.TZ_LOCK >= 400000000000000) 
										AND (u.TZ_LOCK < 100000000000000 OR u.TZ_LOCK >= 200000000000000)))=c.ORDINAL_ACTIVIDAD 
										OR ( (SELECT MIN(u.ORDINAL_ACTIVIDAD) 
											  FROM CLI_ACTIVIDAD_ECONOMICA u WITH (NOLOCK)
											  WHERE u.TZ_LOCK=0 
											        AND u.CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE 
													AND ((u.TZ_LOCK < 300000000000000 OR u.TZ_LOCK >= 400000000000000) 
													AND (u.TZ_LOCK < 100000000000000 OR u.TZ_LOCK >= 200000000000000)))IS NULL 
													AND 
														(
														SELECT MIN(t.ORDINAL_ACTIVIDAD) 
														FROM TEMP_CLI_ACTIVIDAD_ECONOMICA t WITH (NOLOCK)
														WHERE t.TZ_LOCK=0 
																AND t.CODIGO_PERSONA_CLIENTE=c.CODIGO_PERSONA_CLIENTE 
																AND ((t.TZ_LOCK < 300000000000000 OR t.TZ_LOCK >= 400000000000000) 
																AND (t.TZ_LOCK < 100000000000000 OR t.TZ_LOCK >= 200000000000000)))=c.ORDINAL_ACTIVIDAD)) 
				THEN ''Primaria''
				ELSE ''Secundaria''
				END) AS TIPO_ACTIVIDAD
				FROM TEMP_CLI_ACTIVIDAD_ECONOMICA c WITH (NOLOCK)
					INNER JOIN  CLI_Cod_Act_AFIP a WITH (NOLOCK) ON c.CODIGO_ACTIVIDAD=a.CODIGO_ACT_AFIP
					LEFT JOIN CLI_DocumentosPFPJ d WITH (NOLOCK) ON d.NUMEROPERSONAFJ=c.CODIGO_PERSONA_CLIENTE
				WHERE ((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) 
						AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
				
				) X WHERE X.CODIGO_PERSONA=@COD_PERSONA AND X.COD_ACTIVIDAD=@COD_ACTIVIDAD)
				
			END

   	
END

')

