EXECUTE('
IF OBJECT_ID (''dbo.VBS_ESTADO_CUENTA_LEASING'') IS NOT NULL
	DROP VIEW dbo.VBS_ESTADO_CUENTA_LEASING

')

EXECUTE('
CREATE VIEW dbo.VBS_ESTADO_CUENTA_LEASING
AS

SELECT 
	ROW_NUMBER() OVER(PARTITION BY PP.SALDO_JTS_OID,PP.C2300 ORDER BY PP.C2300 ASC) AS NUMERADOR,
	ROW_NUMBER() OVER(PARTITION BY PP.SALDO_JTS_OID, PP.C2300, P.HP_JTS_OID ORDER BY pp.C2300, P.HP_JTS_OID ASC) AS NUMERADOR_HP,	
	PP.SALDO_JTS_OID,
	PP.C2300 AS NCUOTA,
	PP.C2302 AS VENCIMIENTOCUOTA,
	ISNULL(PPO.CAPITAL,0) AS CAPITAL,
	ISNULL(PPO.INTERES,0) AS INTERES, 
	PP.C2309 AS SALDO_CAPITAL,
	PP.C2310 AS SALDO_INTERES,  	 
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAINTERES END  AS PP_IVAINTERES,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAPERCEPCIONINTERES END AS PP_IVAPERCEPCIONINTERES,
	PP.C2311 AS PP_MORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAMORA END AS PP_IVAMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAPERCEPCIONMORA END AS PP_IVAPERCEPCIONMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.ICMORA_DEV END AS PP_INTCOMPMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAINTCOMPMORA END AS PP_IVAINTCOMPMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAPERCEPCIONINTCOMPMORA END AS PP_IVAPERCEPCIONINTCOMPMORA,	
    P.HP_JTS_OID,
    P.CUOTA AS CUOTA,
    CASE WHEN DATEDIFF(d,P.VENCIMIENTOCUOTA,P.FECHAVALOR)<=0 THEN NULL 
    ELSE  DATEDIFF(d,P.VENCIMIENTOCUOTA,P.FECHAVALOR) END  AS DIASATRASO,
    P.NROASIENTOMOV,
    P.FECHAPROCESOMOV,
    P.FECHAVALOR,
    ISNULL(P.CAPITALPAGADO,0) AS CAPITALPAGADO,
    ISNULL(P.CAPITALPAGADO,0) + ISNULL(P.CAPITALADELANTADO,0) AS TOTAL_CAPITALPAGADO,
    ISNULL(P.INTERESPAGADO,0) AS INTERESPAGADO ,
    ISNULL(I.IVAINTERES,0) AS IVAINTERES , 
    ISNULL(I.IVAINTERESPERCEPCION,0)AS IVAINTERESPERCEPCION ,       
    ISNULL(P.CAPITALADELANTADO,0) AS CAPITALADELANTADO,
    ISNULL(P.MORAPAGADA,0) AS MORAPAGADA,
    ISNULL(I.IVAMORA,0) AS IVAMORA,
    ISNULL(I.IVAMORAPERCEPCION,0) AS IVAMORAPERCEPCION ,    
    ISNULL(P.BONIFICACION,0) AS BONIFICACION,
    ISNULL(INTERES_COMP_MORA,0) AS INTERES_COMP_MORA,
    ISNULL(I.IVAICMORA,0) AS IVA_INTERES_COMP_MORA,
    ISNULL(C.TOTAL_PAGADO,0) AS GASTOS,
    ISNULL(P.CAPITALPAGADO,0)+ISNULL(P.CAPITALADELANTADO,0)+ISNULL(P.MORAPAGADA,0)+ISNULL(P.INTERES_COMP_MORA,0)+ISNULL(I.IVAMORA,0)+ISNULL(I.IVAMORAPERCEPCION,0)+ISNULL(P.INTERESPAGADO,0)+ISNULL(I.IVAINTERES,0)+ISNULL(I.IVAINTERESPERCEPCION,0)+ISNULL(C.TOTAL_PAGADO,0) AS TOTALPAGADO,   
    PP.REMANENTE_CAPITAL-PP.C2304 AS SALDOCAPITAL ,
	g.CARGO_ID, IMPUESTO_ID, ISNULL(IMPORTE_GASTO,0) AS PP_GASTOS,
	CASE WHEN C.SALDO_CARGO IS NULL THEN g.SALDO_GASTO ELSE C.SALDO_CARGO END AS SALDO_GASTO,  
	CODIGO, DESCRIPCION AS CARGO,g.TIPO AS TIPO_GASTO,CATEGORIA  
FROM PLANPAGOS PP WITH (NOLOCK) 
LEFT JOIN PLANPAGOS_ORIGINAL PPO WITH (NOLOCK)
	ON PPO.SALDO_JTS_OID=PP.SALDO_JTS_OID AND PPO.NUMERO_CUOTA=PP.C2300
INNER JOIN SALDOS S WITH (NOLOCK) 
	ON PP.SALDO_JTS_OID=S.JTS_OID AND S.TZ_LOCK=0
INNER JOIN PRODUCTOS pr WITH (NOLOCK) ON pr.C6250=s.PRODUCTO AND pr.C6800= ''L''
LEFT JOIN (SELECT DISTINCT gs.SALDOS_JTS_OID,gs.NUMERO_CUOTA, gs.CARGO_ID, gs.IMPUESTO_ID, gs.IMPORTE_GASTO, gs.SALDO_GASTO,
ttl.CODIGO, ttl.DESCRIPCION,op1.DESCRIPCION AS TIPO,op2.DESCRIPCION AS CATEGORIA
FROM GASTOS_POR_CUOTA gs WITH (nolock)
INNER JOIN CRE_GASTOS_LEASING gl WITH (nolock) ON gl.SALDOS_JTS_OID=gs.SALDOS_JTS_OID AND gl.TZ_LOCK=0
INNER JOIN CRE_TIPO_TRAMITE_LEASING ttl WITH (nolock) ON ttl.ID_CARGO=gs.CARGO_ID AND ttl.CODIGO=gl.CODIGO_TRAMITE AND ttl.TZ_LOCK=0
INNER JOIN opciones  op1 WITH (nolock) ON op1.NUMERODECAMPO=43371 AND op1.OPCIONINTERNA= ttl.TIPO 
INNER JOIN opciones  op2 WITH (nolock) ON op2.NUMERODECAMPO=43374 AND op2.OPCIONINTERNA=ttl.CATEGORIA 
WHERE gs.TZ_LOCK=0 
GROUP BY gs.SALDOS_JTS_OID,gs.NUMERO_CUOTA, gs.CARGO_ID, gs.IMPUESTO_ID, gs.IMPORTE_GASTO, gs.SALDO_GASTO,
ttl.CODIGO, ttl.DESCRIPCION,op1.DESCRIPCION,op2.DESCRIPCION) g ON g.SALDOS_JTS_OID=s.JTS_OID AND g.NUMERO_CUOTA=PP.C2300
LEFT JOIN BS_PAYS_DETAIL P WITH (NOLOCK)	
	ON P.SALDOS_JTS_OID=S.JTS_OID
	AND P.CUOTA=PP.C2300 
	AND ((P.CAPITALPAGADO + P.CAPITALADELANTADO)<>0 OR INTERESPAGADO<>0 OR  MORAPAGADA<>0 OR P.INTERES_COMP_MORA<>0) 
	AND (TIPOAJUSTEHP<>''C'' OR TIPOAJUSTEHP IS NULL)
LEFT JOIN BS_CHARGE_DETAIL C WITH (NOLOCK) 
	ON  P.SALDOS_JTS_OID = C.SALDOS_JTS_OID 
	AND P.HP_JTS_OID = C.HP_JTS_OID 
	AND P.CUOTA = C.CUOTA 
	AND C.CARGO_ID=G.CARGO_ID
	AND C.TOTAL_PAGADO<>0 
	AND P.TZ_LOCK=0
LEFT JOIN BS_PAYS_DETAIL_IVA I WITH (NOLOCK) 	
	ON P.SALDOS_JTS_OID = I.SALDOS_JTS_OID 
	AND P.HP_JTS_OID = I.HP_JTS_OID 
	AND P.CUOTA = I.CUOTA
')