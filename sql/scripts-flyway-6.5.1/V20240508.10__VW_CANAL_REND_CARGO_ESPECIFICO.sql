EXECUTE('
IF OBJECT_ID (''dbo.VW_CANAL_REND_CARGO_ESPECIFICO'') IS NOT NULL
	DROP VIEW dbo.VW_CANAL_REND_CARGO_ESPECIFICO
')
EXECUTE('
CREATE VIEW VW_CANAL_REND_CARGO_ESPECIFICO
				(ID_CABEZAL,
				ID_LINEA,
				NRO_COMPROBANTE_CLIENTE,
				LETRA,
				PUNTO_VENTA,
				TOTAL_CARGO_ESPECIFICO,
				ESTADO)
AS


SELECT DISTINCT
    c.ID,
    d.ID_LINEA,
    cc2.NRO_COMPROBANTE_CLIENTE,
    cc2.LETRA,
    cc2.PUNTO_VENTA,
    cc2.TOTAL_CARGO_ESPECIFICO,
    cc2.ESTADO
FROM REC_CAB_RECAUDOS_CANAL AS c WITH (NOLOCK)
INNER JOIN REC_DET_RECAUDOS_CANAL AS d WITH (NOLOCK)
    ON c.ID = d.ID_CABEZAL
    AND d.TZ_LOCK = 0
INNER JOIN CONV_PADRONES AS cc2 WITH (NOLOCK)
    ON cc2.CONVENIO = (
        SELECT TOP 1 COD_ENTE
        FROM CONV_REL_ENTECONV
        WHERE ID_CONVREC = (
            SELECT CASE WHEN l.CONVENIO_PADRE = 0 THEN l.CONVENIO ELSE l.CONVENIO_PADRE END
            FROM REC_LIQUIDACION AS l
            INNER JOIN REC_CAB_RECAUDOS_CANAL AS c2 ON l.ID_LIQUIDACION = c2.ID_LIQUIDACION
            WHERE c2.ID = c.ID
            AND l.TZ_LOCK = 0
            AND c2.TZ_LOCK = 0
        )
        AND TZ_LOCK = 0
    )
    AND cc2.TZ_LOCK = 0
    AND cc2.TOTAL_CARGO_ESPECIFICO != 0
    AND cc2.TOTAL_CARGO_ESPECIFICO IS NOT NULL
    AND (
        
        (
        RIGHT(''00000000'' + CAST(cc2.NRO_COMPROBANTE_CLIENTE AS varchar), 8) = SUBSTRING(d.CODIGO_BARRAS, 9, 8)
        AND cc2.LETRA = CASE WHEN SUBSTRING(d.CODIGO_BARRAS, 4, 1) = 0 THEN ''B'' 
                        WHEN SUBSTRING(D.CODIGO_BARRAS,4,1) = 1 THEN ''A'' ELSE ''Y'' END
        AND cc2.PUNTO_VENTA = SUBSTRING(d.CODIGO_BARRAS, 5, 4))
        OR
        (
        RIGHT(''00000000'' + CAST(cc2.NRO_COMPROBANTE_CLIENTE AS varchar), 8) = SUBSTRING(d.CODIGO_BARRAS, 11, 8)
        AND cc2.TIPO_COMPROBANTE = SUBSTRING(d.CODIGO_BARRAS, 4, 2)
        AND cc2.LETRA = CASE WHEN SUBSTRING(d.CODIGO_BARRAS, 6, 1) = 0 THEN ''B'' ELSE ''A'' END
        AND cc2.PUNTO_VENTA = SUBSTRING(d.CODIGO_BARRAS, 7, 4))
    )
WHERE c.TZ_LOCK = 0
')