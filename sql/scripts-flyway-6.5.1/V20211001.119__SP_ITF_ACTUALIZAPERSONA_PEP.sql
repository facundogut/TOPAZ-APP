EXECUTE('DROP PROCEDURE IF EXISTS dbo.SP_ITF_ACTUALIZAPERSONA_PEP;')
EXECUTE('
CREATE PROCEDURE [dbo].[SP_ITF_ACTUALIZAPERSONA_PEP] 

@P_TIPO_PERSONA VARCHAR(1),
@P_NUMPER NUMERIC(12,0),
@P_INCL_PEP VARCHAR(1),
@P_TICKET NUMERIC(12),
@P_FECHA DATETIME,
@P_CUIT VARCHAR(11),
@P_NOMBRE VARCHAR(50),
@P_ASIENTO NUMERIC(10)

AS 
   /*Generated by SQL Server Migration Assistant for Oracle version 7.9.0.*/
   BEGIN
   
   DECLARE @flag INT;
   DECLARE @accion VARCHAR(10);
   DECLARE @mensaje VARCHAR(50);
   DECLARE @P_LOCK NUMERIC(15);
   DECLARE @P_ESTADO NUMERIC(1);
   
   SET @accion = (CASE WHEN @P_INCL_PEP = ''N'' THEN ''DESMARCADO'' WHEN @P_INCL_PEP = ''S'' THEN ''MARCADO'' ELSE ''NINGUNA'' END);
	  
      IF @P_TIPO_PERSONA = ''F''
      	BEGIN
      		SET @flag = (SELECT COUNT(NUMEROPERSONAFISICA) FROM CLI_PERSONASFISICAS WITH (NOLOCK) WHERE NUMEROPERSONAFISICA = @P_NUMPER AND ESTADO = 0 AND TZ_LOCK = 0);
      	   
      		IF @flag = 1
      			BEGIN
      				UPDATE CLI_PERSONASFISICAS SET INCLUIDO_PEP = @P_INCL_PEP
      				WHERE NUMEROPERSONAFISICA = @P_NUMPER
      				
      				INSERT INTO ITF_HIST_PEP (FECHA, ID_TICKET, CUIT, DESCR, ACCION, NOMBRE, ID_PERSONA) VALUES (@P_FECHA, @P_TICKET, @P_CUIT, @accion, @P_INCL_PEP, @P_NOMBRE, @P_NUMPER);
      				
      				/* Dependiendo del tipo de persona grabo Tabla BITACORA_PERSONAS_FISICAS o BITACORA_PERSONAS_JURIDICAS */
	      			EXEC dbo.SP_ITF_GRABO_BITACORA_PERSONAS @P_NUMPER, @P_TIPO_PERSONA, @P_ASIENTO;
      			END
      		ELSE
      			BEGIN
      				
   					SET @P_LOCK = (SELECT TZ_LOCK FROM CLI_PERSONASFISICAS WITH(NOLOCK) WHERE NUMEROPERSONAFISICA = @P_NUMPER);;
   					SET @P_ESTADO = (SELECT ESTADO FROM CLI_PERSONASFISICAS WITH(NOLOCK) WHERE NUMEROPERSONAFISICA = @P_NUMPER);;
   					SET @mensaje = (CASE WHEN @P_LOCK = 0 AND @P_ESTADO = 1 THEN ''Persona inhabilitada. Cambio no realizado.'' ELSE ''Persona bloqueada. Cambio no realizado'' END);
   					
      				INSERT INTO ITF_HIST_PEP (FECHA, ID_TICKET, CUIT, DESCR, ACCION, NOMBRE, ID_PERSONA) VALUES (@P_FECHA, @P_TICKET, @P_CUIT, @mensaje, @P_INCL_PEP, @P_NOMBRE, @P_NUMPER);
      			END
      	END
      	
      ELSE
      	BEGIN
      		SET @flag = (SELECT COUNT(NUMEROPERSONAJURIDICA) FROM CLI_PERSONASJURIDICAS WITH (NOLOCK) WHERE NUMEROPERSONAJURIDICA = @P_NUMPER AND ESTADO = 0 AND TZ_LOCK = 0);
      		
      		IF @flag = 1
      			BEGIN
      				UPDATE CLI_PERSONASJURIDICAS SET INCL_PEPS = @P_INCL_PEP  
      				WHERE NUMEROPERSONAJURIDICA = @P_NUMPER;
      				
      				INSERT INTO ITF_HIST_PEP (FECHA, ID_TICKET, CUIT, DESCR, ACCION, NOMBRE, ID_PERSONA) 
					VALUES (@P_FECHA, @P_TICKET, @P_CUIT, @accion, @P_INCL_PEP, @P_NOMBRE, @P_NUMPER);
      				
      				/* Dependiendo del tipo de persona grabo Tabla BITACORA_PERSONAS_FISICAS o BITACORA_PERSONAS_JURIDICAS */
	      			EXEC dbo.SP_ITF_GRABO_BITACORA_PERSONAS @P_NUMPER, @P_TIPO_PERSONA, @P_ASIENTO;
      			END
      		ELSE
      			BEGIN
      				SET @P_LOCK = (SELECT TZ_LOCK FROM CLI_PERSONASFISICAS WITH(NOLOCK) WHERE NUMEROPERSONAFISICA = @P_NUMPER);;
   					SET @P_ESTADO = (SELECT ESTADO FROM CLI_PERSONASFISICAS WITH(NOLOCK) WHERE NUMEROPERSONAFISICA = @P_NUMPER);;
   					SET @mensaje = (CASE WHEN @P_LOCK = 0 AND @P_ESTADO = 1 THEN ''Persona inhabilitada. Cambio no realizado.'' ELSE ''Persona bloqueada. Cambio no realizado'' END);
   					
      				INSERT INTO ITF_HIST_PEP (FECHA, ID_TICKET, CUIT, DESCR, ACCION, NOMBRE, ID_PERSONA) 
					VALUES (@P_FECHA, @P_TICKET, @P_CUIT, @mensaje, @P_INCL_PEP, @P_NOMBRE, @P_NUMPER);
      			END
      		
			    	
      	END      	
   END;')