EXECUTE('
IF OBJECT_ID (''dbo.VBS_DETALLE_CUOTAS_PAGADAS'') IS NOT NULL
	DROP VIEW dbo.VBS_DETALLE_CUOTAS_PAGADAS
')

EXECUTE('
CREATE VIEW dbo.VBS_DETALLE_CUOTAS_PAGADAS
AS
SELECT NUMERADOR,
NUMERADOR_HP,
NUMERADOR_HP_SUB,
SALDO_JTS_OID, 
VENCIMIENTOCUOTA,
NCUOTA,
CAPITAL,
INTERES, 
SALDO_CAPITAL,
SALDO_INTERES, 
DIASATRASO,
TASAINTERES,
PAGOPARCIAL,
SUM(PP_IVAINTERES) AS PP_IVAINTERES,
SUM(PP_IVAPERCEPCIONINTERES) AS PP_IVAPERCEPCIONINTERES ,
SUM(PP_MORA) AS PP_MORA,
SUM(PP_IVAMORA)AS PP_IVAMORA,
SUM(PP_IVAPERCEPCIONMORA) AS PP_IVAPERCEPCIONMORA ,
SUM(PP_INTCOMPMORA) AS PP_INTCOMPMORA ,
SUM(PP_IVAINTCOMPMORA) AS PP_IVAINTCOMPMORA,
SUM(PP_IVAPERCEPCIONINTCOMPMORA) AS PP_IVAPERCEPCIONINTCOMPMORA,
SUM(PP_GASTOS) AS PP_GASTOS,
SUM(SUBSIDIO) AS SUBSIDIO,
FECHAVALOR
 FROM (
SELECT 
	ROW_NUMBER() OVER(PARTITION BY PP.SALDO_JTS_OID,PP.C2300 ORDER BY PP.C2300 ASC) AS NUMERADOR,
	ROW_NUMBER() OVER(PARTITION BY PP.SALDO_JTS_OID, PP.C2300, P.HP_JTS_OID ORDER BY pp.C2300, P.HP_JTS_OID ASC) AS NUMERADOR_HP, 
	ROW_NUMBER() OVER(PARTITION BY PP.SALDO_JTS_OID, P.HP_JTS_OID ORDER BY P.HP_JTS_OID ASC) AS NUMERADOR_HP_SUB,	
	PP.SALDO_JTS_OID,
	PP.C2300 AS NCUOTA,
	PPO.FECHA_FIN AS VENCIMIENTOCUOTA,	
	CASE WHEN PP.TZ_LOCK <> 0 THEN ISNULL(PPO.CAPITAL,0)
		 WHEN P.HP_JTS_OID IS NOT NULL AND ISNULL(P.CAPITALPAGADO,0) <> 0 THEN ISNULL(P.CAPITALPAGADO,0) 
		 WHEN P.HP_JTS_OID IS NOT NULL AND ISNULL((P.CAPITALPAGADO+P.CAPITALADELANTADO),0) = 0 THEN 0 
		 ELSE ISNULL(PPO.CAPITAL,0) END AS CAPITAL,
	--ISNULL(PPO.CAPITAL,0)  AS CAPITAL,
	ISNULL(P.INTERESPAGADO,0) AS INTERES,
	BH.TASAINTERES AS TASAINTERES,  	 
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN I.HP_JTS_OID IS NOT NULL THEN I.IVAINTERES
		 ELSE PP.IVAINTERES 
	END  AS PP_IVAINTERES,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN I.HP_JTS_OID IS NOT NULL THEN I.IVAINTERESPERCEPCION
		 ELSE PP.IVAPERCEPCIONINTERES 
	END AS PP_IVAPERCEPCIONINTERES,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN P.HP_JTS_OID IS NOT NULL THEN P.MORAPAGADA
		 ELSE PP.C2311
	END AS PP_MORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN I.HP_JTS_OID IS NOT NULL THEN I.IVAMORA
		 ELSE PP.IVAMORA 
	END AS PP_IVAMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN I.HP_JTS_OID IS NOT NULL THEN I.IVAMORAPERCEPCION
		 ELSE PP.IVAPERCEPCIONMORA 
    END AS PP_IVAPERCEPCIONMORA,
    CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN P.HP_JTS_OID IS NOT NULL THEN P.INTERES_COMP_MORA
		 ELSE PP.ICMORA_DEV
	END AS PP_INTCOMPMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN I.HP_JTS_OID IS NOT NULL THEN I.IVAICMORA
		 ELSE PP.IVAINTCOMPMORA 
	END AS PP_IVAINTCOMPMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN I.HP_JTS_OID IS NOT NULL THEN I.IVAICMORAPERCEPCION 
		 ELSE PP.IVAPERCEPCIONINTCOMPMORA 
	END AS PP_IVAPERCEPCIONINTCOMPMORA,		
    P.HP_JTS_OID,
    P.CUOTA AS CUOTA,
    PP.DIAS_ATRASO_CANCELACION  AS DIASATRASO,
    PP.C2309 AS SALDO_CAPITAL,
	PP.C2310 AS SALDO_INTERES, 
    CASE WHEN PP.TZ_LOCK<>0 THEN PP.C2313 ELSE P.FECHAVALOR END AS FECHAVALOR ,  
    CASE WHEN PP.TZ_LOCK <> 0 THEN 0 
		 WHEN P.HP_JTS_OID IS NOT NULL 
		 	THEN isnull((SELECT sum(TOTAL_PAGADO) FROM BS_CHARGE_DETAIL WITH (NOLOCK) WHERE SALDOS_JTS_OID=PP.SALDO_JTS_OID AND HP_JTS_OID=p.HP_JTS_OID 
		 		  AND CUOTA=p.CUOTA),0)	 		  
		 ELSE (SELECT sum(IMPORTE_GASTO) FROM GASTOS_POR_CUOTA WITH (NOLOCK) WHERE SALDOS_JTS_OID=PP.SALDO_JTS_OID AND NUMERO_CUOTA=PP.C2300)		 
	END AS PP_GASTOS,	
	CASE WHEN P.NROASIENTOMOV IS NOT NULL AND (ROW_NUMBER() OVER(PARTITION BY PP.SALDO_JTS_OID, P.HP_JTS_OID ORDER BY P.HP_JTS_OID ASC)) = 1
	THEN ISNULL((SELECT SUM(CAPITALREALIZADO) FROM MOVIMIENTOS_CONTABLES WITH (NOLOCK) WHERE FECHAPROCESO=BH.FECHAPROCESOMOV AND ASIENTO=BH.NROASIENTOMOV 
	AND SUCURSAL=BH.SUCURSALMOV AND COD_TRANSACCION=3030),0) ELSE 0 END AS SUBSIDIO,
	CASE 
 		 WHEN (PP.C2309+PP.C2310) <> (PP.C2304+PP.C2305) AND (PP.C2309+PP.C2310) >0
			THEN ''Pago Parcial''
		 WHEN PP.TZ_LOCK <> 0 THEN ''Pago Adelantada'' 
		 WHEN (PP.C2309+PP.C2310) = 0 THEN ''Pago''	
		 ELSE '''' 
	END AS PAGOPARCIAL	
FROM PLANPAGOS PP WITH (NOLOCK) 
INNER JOIN PLANPAGOS_ORIGINAL PPO WITH (NOLOCK)
	ON PPO.SALDO_JTS_OID=PP.SALDO_JTS_OID AND PPO.NUMERO_CUOTA=PP.C2300
INNER JOIN SALDOS S WITH (NOLOCK) 
	ON PP.SALDO_JTS_OID=S.JTS_OID AND S.TZ_LOCK=0
INNER JOIN PRODUCTOS pr WITH (NOLOCK) ON pr.C6250=s.PRODUCTO
INNER JOIN BS_HISTORIA_PLAZO BH WITH (NOLOCK) ON BH.SALDOS_JTS_OID=s.JTS_OID AND BH.TIPOMOV=''P'' AND BH.TZ_LOCK=0	
INNER JOIN BS_PAYS_DETAIL P WITH (NOLOCK)	
	ON P.SALDOS_JTS_OID=S.JTS_OID
 	AND P.HP_JTS_OID = BH.JTS_OID
	AND P.CUOTA=PP.C2300 
	-- AND ((P.CAPITALPAGADO + P.CAPITALADELANTADO) <>0 OR 	AND (P.INTERESPAGADO<>0 OR  P.MORAPAGADA<>0 OR P.INTERES_COMP_MORA<>0 )
	-- AND (TIPOAJUSTEHP<>''C'' OR TIPOAJUSTEHP IS NULL)
LEFT JOIN BS_PAYS_DETAIL_IVA I WITH (NOLOCK) 	
	ON P.SALDOS_JTS_OID = I.SALDOS_JTS_OID 
	AND P.HP_JTS_OID = I.HP_JTS_OID 
	AND P.CUOTA = I.CUOTA
WHERE (((PP.C2309+PP.C2310)=0) OR (PP.TZ_LOCK<>0))
) t
WHERE (CAPITAL+INTERES+PP_IVAINTERES+PP_IVAPERCEPCIONINTERES+PP_MORA+PP_IVAMORA+PP_IVAPERCEPCIONMORA+PP_INTCOMPMORA+PP_IVAINTCOMPMORA+
PP_IVAPERCEPCIONINTCOMPMORA+PP_GASTOS) > 0 
GROUP BY 
NUMERADOR,
NUMERADOR_HP,
NUMERADOR_HP_SUB,
SALDO_JTS_OID, VENCIMIENTOCUOTA,NCUOTA,CAPITAL,INTERES, SALDO_CAPITAL,
SALDO_INTERES,DIASATRASO,FECHAVALOR,TASAINTERES,PAGOPARCIAL
')

