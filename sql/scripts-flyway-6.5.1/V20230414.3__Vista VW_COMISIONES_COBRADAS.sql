EXECUTE('
----
IF OBJECT_ID (''dbo.VW_COMISIONES_COBRADAS'') IS NOT NULL
	DROP VIEW dbo.VW_COMISIONES_COBRADAS
----
')
EXECUTE('
----
CREATE     VIEW [dbo].[VW_COMISIONES_COBRADAS] 
AS
SELECT
	FL.CONCEPTO_COBRO AS Concepto_Cobro,
	isnull(FL.[ID_CARGO],0) AS [Identificador_Cargo],
	FL.FECHA_PROCESO_ASIENTO AS Fecha_Proceso_Asiento, 
	FL.ASIENTO AS Asiento, 
	FL.SUCURSAL_ASIENTO AS Sucursal_Asiento,
	--FL.ORDINAL AS Ordinal,
	SAL.CUENTA AS Cuenta,
	SAL.C1803 AS Cliente,
	FL.MONTO_IMPONIBLE AS Monto_Imponible,
	FL.MONTO_FACTURABLE AS Monto_Facturable,
	--isnull(FL.ID_IMPUESTO,0)ID_IMPUESTO,
	--HIST.JTS_OID,
	SAL.JTS_OID AS Identificador
FROM CI_FACTURA_LINEA AS FL WITH (nolock)
INNER JOIN HISTORIA_VISTA AS HIST WITH (nolock) ON
	HIST.ASIENTO = FL.ASIENTO
	AND HIST.FECHA_PROCESADO = FL.FECHA_PROCESO_ASIENTO
	AND HIST.SUCURSAL = FL.SUCURSAL_ASIENTO
	AND HIST.JTS_OID = (SELECT MIN(JTS_OID) 
						FROM HISTORIA_VISTA WITH (nolock)
						WHERE ASIENTO = HIST.ASIENTO 
						AND FECHA_PROCESADO = HIST.FECHA_PROCESADO
						AND SUCURSAL = HIST.SUCURSAL
						)
INNER JOIN SALDOS AS SAL WITH (nolock) ON
	SAL.JTS_OID = HIST.SALDO_JTS_OID
	AND ((SAL.TZ_LOCK < 300000000000000 OR SAL.TZ_LOCK >= 400000000000000) 
		AND (SAL.TZ_LOCK < 100000000000000 OR SAL.TZ_LOCK >= 200000000000000)
	)
INNER JOIN CI_CARGOS AS CR WITH (nolock) ON
	CR.ID_CARGO = FL.ID_CARGO
	AND (CR.TIPO_CARGO_IMPOSITIVO = 0 
		OR CR.TIPO_CARGO_IMPOSITIVO IS NULL)
	AND ((CR.TZ_LOCK < 300000000000000 OR CR.TZ_LOCK >= 400000000000000) 
		AND (CR.TZ_LOCK < 100000000000000 OR CR.TZ_LOCK >= 200000000000000)
	)
WHERE
	FL.ID_IMPUESTO IS NULL
	AND ((FL.TZ_LOCK < 300000000000000 OR FL.TZ_LOCK >= 400000000000000) 
		AND (FL.TZ_LOCK < 100000000000000 OR FL.TZ_LOCK >= 200000000000000)
	)
GROUP BY
	SAL.CUENTA,
	SAL.C1803,
	FL.MONTO_IMPONIBLE,
	FL.MONTO_FACTURABLE,
	FL.[ID_CARGO],
    FL.ID_IMPUESTO,
	FL.CONCEPTO_COBRO,
	FL.FECHA_PROCESO_ASIENTO, 
	FL.ASIENTO, 
	FL.SUCURSAL_ASIENTO, 
	FL.ORDINAL,
	HIST.JTS_OID,
	SAL.JTS_OID,
	CR.DESCRIPCION;
----
')