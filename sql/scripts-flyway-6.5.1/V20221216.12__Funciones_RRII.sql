EXECUTE('
CREATE OR ALTER FUNCTION convertirAMonNac (@montoIni DECIMAL (38,2) , @moneda INT, @fechaParametro DATE) RETURNS DECIMAL (38,2) 
AS
--- Devuelve el Monto ingresado convertido a moneda nacional

BEGIN
	DECLARE @montoFinal DECIMAL (38,2)
	
	SELECT @montoFinal = 
		CASE WHEN @moneda = (SELECT MONNAC FROM PARAMETROS WITH(NOLOCK))  THEN
			CAST(@montoIni AS DECIMAL (38,2)) 
		WHEN @moneda IN (988,999,2) THEN
			ISNULL(CAST(@montoIni *
									(SELECT CAST(H.TIPO_CAMBIO_OFICIAL AS DECIMAL (38,2))
									FROM HISTORICOTIPOSCAMBIO H WITH (NOLOCK)
									WHERE 
											H.MONEDA = @moneda AND
											H.FECHA_COTIZACION = (SELECT MAX(HTC.FECHA_COTIZACION) 
																FROM HISTORICOTIPOSCAMBIO HTC WITH (NOLOCK) 																
																WHERE HTC.MONEDA=@moneda AND
																HTC.FECHA_COTIZACION <= CONVERT(DATETIME,@fechaParametro,103)))

		AS DECIMAL (38,2)),0)
		ELSE
			ISNULL(ROUND(CAST(@montoIni AS DECIMAL (38,2))*

		(SELECT H.ARBITRAJE_COMPRA
		FROM HISTORICOTIPOSCAMBIO H WITH (NOLOCK)
		WHERE 
			H.MONEDA= @moneda AND
			H.FECHA_COTIZACION = (SELECT MAX(HTC.FECHA_COTIZACION) 
								FROM HISTORICOTIPOSCAMBIO HTC WITH (NOLOCK)
								WHERE HTC.MONEDA=@moneda AND
								HTC.FECHA_COTIZACION <= CONVERT(DATETIME,@fechaParametro,103))) *

		(SELECT TOP 1 H.TIPO_CAMBIO_OFICIAL
		FROM HISTORICOTIPOSCAMBIO H WITH (NOLOCK)
		WHERE 
			H.MONEDA = 2  AND
			H.FECHA_COTIZACION = (SELECT MAX(HTC.FECHA_COTIZACION) 
								FROM HISTORICOTIPOSCAMBIO HTC WITH (NOLOCK)
								WHERE HTC.MONEDA=2 AND
								HTC.FECHA_COTIZACION <= CONVERT(DATETIME,@fechaParametro,103)))
		,2),0)
END
	RETURN CAST(@montoFinal AS DECIMAL (38,2))

END;
')