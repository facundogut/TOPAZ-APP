EXECUTE('
CREATE PROCEDURE SP_DPF_PRECANCELACION
(
  @PCliente NUMERIC(12),
  @PProducto NUMERIC(5),
  @PMoneda	NUMERIC(5),
  @POperacion NUMERIC(10),
  @PFechaVenc VARCHAR(6),
  @IntPrecancelacion NUMERIC(15,2), 
  @PImportePlazo NUMERIC(15,2),
  @Resultado126   VARCHAR(400) OUTPUT,
  @Resultado125	  VARCHAR(400) OUTPUT
)

AS
DECLARE @TARIFA NUMERIC(5)
DECLARE @CANAL NUMERIC(5)
DECLARE @DESC_PRODUCTO VARCHAR(50)
DECLARE @CABECERA125 VARCHAR(50)
----CAMPO 125
DECLARE @LINEA1 VARCHAR(36)
DECLARE @LINEA2 VARCHAR(36)
DECLARE @LINEA3 VARCHAR(36)
DECLARE @NOMBRECLIENTE VARCHAR(36)
DECLARE @CAPITAL VARCHAR(36)
DECLARE @INTERES VARCHAR(36)
DECLARE @MONTO VARCHAR(36)
DECLARE @PLAZO VARCHAR(36)
DECLARE @ALTA VARCHAR(36)
DECLARE @TNA VARCHAR(36)
DECLARE @TEM VARCHAR(36)
DECLARE @SIMBOLOMONEDA VARCHAR(5)
DECLARE @OPERACION NUMERIC(12)
DECLARE @TASA_PRECANCELA VARCHAR(36)
DECLARE @COTIZACIONUVA VARCHAR(36)
DECLARE @UVAADQUERIDAS VARCHAR(36)
DECLARE @FECHAALTA DATETIME

SET @CABECERA125 = ''1P''+ SUBSTRING(CONVERT(VARCHAR,(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)),112),3,6) + ''1036'';  


SET @CANAL = (SELECT NUMERICO FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO = 219);
	
	SELECT @NOMBRECLIENTE = SUBSTRING(C.NOMBRECLIENTE,1,36), @CAPITAL=FORMAT(C1604*M.C6440, ''C'', ''es-ar''), 
		@SIMBOLOMONEDA = M.C6401, @INTERES = REPLACE(FORMAT(@IntPrecancelacion, ''C'', ''es-ar''),''$'',''''),
		@MONTO = REPLACE(FORMAT(C1600, ''C'', ''es-ar''),''$'',M.C6401), 
		@PLAZO = DATEDIFF(dd,c1621,c1627), 
		@ALTA = CONVERT(VARCHAR,C1621,103), --VER FORMATO CON 4 DIGITOS. 
		@FECHAALTA=S.C1621,
		@TNA = CASE 
		WHEN PR.C6253 = ''E'' --TASA EFECTIVA
		THEN (PR.C6255/ (	SELECT AVG(DATEDIFF(DD,C2301,C2302)) 
		FROM PLANPAGOS WHERE SALDO_JTS_OID = S.JTS_OID AND TZ_LOCK = 0 )) *
		(POWER((1+(S.C1632/100)), (1/(PR.C6255/ (	SELECT AVG(DATEDIFF(DD,C2301,C2302)) 
		FROM PLANPAGOS 
		WHERE SALDO_JTS_OID = S.JTS_OID AND TZ_LOCK = 0)))) - 1) * 100			
		--CONVERSIÓN SEGÚN CONVENCIÓN BCRA
		WHEN PR.C6253 = ''M'' --TASA EFECTIVA MENSUAL
			THEN S.C1632 * 365 / 30.41666
		--TASA YA EXPRESADA COMO NOMINAL
		WHEN PR.C6253 = ''N'' --TASA NOMINAL
			THEN S.C1632
		END,
		@TEM=CASE
		WHEN PR.C6253 = ''E'' --TASA EFECTIVA
			THEN CONVERT(NUMERIC(11,7),S.C1632/12)
		-- TASA
		WHEN PR.C6253 = ''M'' --TASA EFECTIVA MENSUAL
			THEN S.C1632			
		--CONVENCIÓN DEL BCRA
		WHEN PR.C6253 = ''N'' --TASA NOMINAL
			THEN CONVERT(NUMERIC(11,7),(S.C1632 * 30.41666 / 365)/12)
		END,
	    @PProducto = S.PRODUCTO,
		@COTIZACIONUVA=FORMAT(M.C6440, ''C'', ''es-ar''), --DECLARAR VARIABLE NUEVA 15,9
		@UVAADQUERIDAS=S.C1604
		FROM SALDOS S WITH(NOLOCK) 
		INNER JOIN CLI_CLIENTES C WITH(NOLOCK) ON S.C1803 = C.CODIGOCLIENTE 
		INNER JOIN MONEDAS M WITH(NOLOCK) ON S.MONEDA = M.C6399
		INNER JOIN PRODUCTOS PR WITH(NOLOCK) ON PR.C6250 = S.PRODUCTO
		WHERE S.C1800 = @CANAL AND S.C1803 = @PCliente AND S.C1785 = 4 
		AND S.C1604 <> 0 AND S.C1627 >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) 
		AND S.OPERACION = @POperacion 
		SELECT @DESC_PRODUCTO=C6251 FROM PRODUCTOS WITH(NOLOCK) WHERE C6250 = @PProducto 
		
		SET @LINEA1 = @DESC_PRODUCTO + REPLICATE('' '',36-LEN(@DESC_PRODUCTO));
		SET @LINEA2 = ''DEPOSITO NRO.''
		SET @LINEA2 = @LINEA2 + REPLICATE('' '', 36-(LEN(@LINEA2)+LEN(@POperacion))) + CONVERT(VARCHAR,@POperacion)
		SET @CAPITAL = ''CAPITAL''+REPLICATE('' '',36-(LEN(''CAPITAL'')+LEN(@CAPITAL)))+@CAPITAL
		SET @INTERES = ''INTERES PRECANC:''+REPLICATE('' '',36-(LEN(''INTERES PRECANC:'')+LEN(@INTERES)))+@INTERES
		SET @MONTO = ''MONTO''+REPLICATE('' '',36-(LEN(''MONTO'')+LEN(@MONTO)))+@MONTO
		SET @PLAZO = ''PLAZO ''+@PLAZO;
		SET @ALTA = ''ALTA ''+@ALTA;
		SET @TNA = ''TNA ''+@TNA;
		SET @TEM = ''TEM ''+@TEM;
	    SET @COTIZACIONUVA =''COTIZACION UVA''+REPLICATE('' '',36-(LEN(''COTIZACION UVA'')+LEN(@COTIZACIONUVA)))+@COTIZACIONUVA;
        SET @UVAADQUERIDAS =''UVA ADQUIRIDAS''+REPLICATE('' '',36-(LEN(''UVA ADQUIRIDAS'')+LEN(@UVAADQUERIDAS)))+@UVAADQUERIDAS;
		IF(LEN(@NOMBRECLIENTE)<36)
		BEGIN 
		SET @NOMBRECLIENTE = @NOMBRECLIENTE + REPLICATE('' '',36-LEN(@NOMBRECLIENTE))
		END
		
		SELECT TOP 1 @TASA_PRECANCELA=CONVERT(NUMERIC (5,2),VALOR)
		FROM TASAS_PRECANCELACION WITH(NOLOCK) 
		WHERE FECHA_VIGENCIA <= @FECHAALTA
		ORDER BY FECHA_VIGENCIA DESC
	   
		SET @TASA_PRECANCELA= ''TASA FIJA DE PRECANCELACION'' +REPLICATE('' '',35-(LEN(''TASA FIJA DE PRECANCELACION'')+LEN(@TASA_PRECANCELA)))+@TASA_PRECANCELA+''%'';
	   
	    SET @Resultado125 = @CABECERA125 + @LINEA1 + @LINEA2 + @NOMBRECLIENTE + @CAPITAL 
		+ @COTIZACIONUVA + @UVAADQUERIDAS + @PLAZO 
		+ REPLICATE('' '',36-(LEN(@PLAZO)+LEN(@ALTA))) + @ALTA +@INTERES
	    + @TNA+ REPLICATE('' '',36-(LEN(@TNA)+LEN(@TEM))) + @TEM + @TASA_PRECANCELA ;
		
		SET @Resultado126 = ''0001 '';


')