EXECUTE ('
IF OBJECT_ID (''dbo.VW_CASTIGOCARTERA'') IS NOT NULL
	DROP VIEW dbo.VW_CASTIGOCARTERA
')

EXECUTE ('
CREATE  VIEW dbo.VW_CASTIGOCARTERA (
TipoDocumento, 
Documento,
Nombre,
TipoPersona, 
Cliente)
AS 
SELECT DISTINCT cli.TIPODOC AS TipoDocumento, 
		cli.NUMERODOC AS Documento, 
		cli.NOMBRECLIENTE AS Nombre, 
		cli.TIPOPERSONA AS TipoPersona, 
		cli.CODIGOCLIENTE AS Cliente
FROM VW_CLI_X_DOC cli WITH(NOLOCK)
JOIN (SELECT h.CLIENTE
	FROM VW_CLI_X_DOC cli WITH(NOLOCK)
	INNER JOIN HISTORICO_CALIF_X_CLIENTE h WITH(NOLOCK) ON cli.CODIGOCLIENTE = h.CLIENTE AND h.TZ_LOCK = 0
	AND h.FECHA_SITUACION < DATEADD(MM, -(SELECT DIASINMOVILIZADA FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 160), (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))) 
	GROUP BY h.CLIENTE
	HAVING max(h.FECHA_SITUACION) IN (SELECT FECHA_SITUACION 
									FROM HISTORICO_CALIF_X_CLIENTE h2 WITH(NOLOCK) 
									INNER JOIN CLI_CLASUBJETIVA c WITH(NOLOCK) ON h2.CALIFICACION_RESULTANTE = c.CATEGORIASUB 
									AND c.PONDERACION >= (SELECT PONDERACION FROM CLI_CLASUBJETIVA WITH(NOLOCK) WHERE CATEGORIASUB = (SELECT PARAMETRO_ALFA FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 161)) AND c.TZ_LOCK = 0
									WHERE h2.CLIENTE = h.CLIENTE AND h2.TZ_LOCK = 0)) a2 
	ON cli.CODIGOCLIENTE = a2.CLIENTE
WHERE 

cli.CODIGOCLIENTE NOT IN (SELECT cli.CODIGOCLIENTE
								FROM VW_CLI_X_DOC cli WITH(NOLOCK)
								INNER JOIN HISTORICO_CALIF_X_CLIENTE h WITH(NOLOCK) ON cli.CODIGOCLIENTE = h.CLIENTE AND h.TZ_LOCK = 0
								AND h.FECHA_SITUACION >= DATEADD(MM, -(SELECT DIASINMOVILIZADA FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 160), (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))) AND h.FECHA_SITUACION <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) 
								INNER JOIN CLI_CLASUBJETIVA c WITH(NOLOCK) ON h.CALIFICACION_RESULTANTE = c.CATEGORIASUB 
								AND c.PONDERACION < (SELECT PONDERACION FROM CLI_CLASUBJETIVA WITH(NOLOCK) WHERE CATEGORIASUB = (SELECT PARAMETRO_ALFA FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 161)) AND c.TZ_LOCK = 0
								GROUP BY cli.CODIGOCLIENTE
								HAVING count(*) > 0)
AND cli.CODIGOCLIENTE IN (
SELECT CLIENTE FROM VW_ASISTENCIAS WITH(nolock) WHERE SALDO <> 0
AND CLIENTE NOT IN (SELECT C1803 FROM SALDOS WHERE JTS_OID IN
(SELECT SALDO_JTS_OID FROM CRE_HISTORICO_DEUDA_GARANTIAS h1 WITH(nolock)                                                    
                INNER JOIN PARAMETROS p WITH(nolock)
                ON p.FECHAPROCESOANTERIOR = h1.FECHA_PROCESO
                GROUP BY h1.SALDO_JTS_OID
                HAVING Isnull(Sum(h1.PORCENTAJE_PREVISION), 0) < 1))
AND JTS_OID IN (SELECT h1.SALDO_JTS_OID FROM  CRE_HISTORICO_DEUDA_GARANTIAS h1 WITH(nolock)                                                    
                INNER JOIN PARAMETROS p WITH(nolock)
                ON p.FECHAPROCESOANTERIOR = h1.FECHA_PROCESO
                GROUP BY h1.SALDO_JTS_OID
                HAVING Isnull(Sum(h1.PORCENTAJE_PREVISION), 0) >= 1
                )
GROUP BY CLIENTE
)
')