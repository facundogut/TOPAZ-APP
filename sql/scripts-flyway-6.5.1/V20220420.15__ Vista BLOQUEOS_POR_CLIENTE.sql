EXECUTE('
----
IF OBJECT_ID (''dbo.VW_BLOQUEOS_POR_CLIENTE'') IS NOT NULL
	DROP VIEW dbo.VW_BLOQUEOS_POR_CLIENTE
----
')
EXECUTE('
----
CREATE VIEW VW_BLOQUEOS_POR_CLIENTE
				(CODIGO_CLIENTE,
				SALDO_JTS_OID,
				CODIGO_BLOQUEO,
				ORDINAL_BLOQUEO,
				DESCRIPCION_BLOQUEO,
				ESTADO_BLOQUEO,
				DESCRIPCION_ESTADO,
				FECHA_VIGENCIA,
				FECHA_VENCIMIENTO,
				VIGENCIA)
AS
SELECT 
	S.C1803 AS CODIGO_CLIENTE,
	B.SALDO_JTS_OID,
	B.COD_BLOQUEO,
	B.ORDINAL_BLOQUEO,
	D.DESCRIPCION AS DESCRIPCION_BLOQUEO,
	B.ESTADO,
	OE.DESCRIPCION AS DESCRIPCION_ESTADO,
	B.FECHA_VIGENCIA,
	B.FECHA_VENCIMIENTO,
	CASE
		WHEN B.FECHA_VIGENCIA > (SELECT FECHAPROCESO FROM PARAMETROS)
			THEN ''No vigente''
		WHEN B.FECHA_VIGENCIA <= (SELECT FECHAPROCESO FROM PARAMETROS)
			AND B.FECHA_VENCIMIENTO <= (SELECT FECHAPROCESO FROM PARAMETROS)
			THEN ''Vencido''
		ELSE
			''Vigente''
	END AS VIGENCIA
FROM GRL_BLOQUEOS AS B WITH (nolock)
INNER JOIN GRL_COD_BLOQUEOS AS D WITH (nolock) ON
	D.COD_BLOQUEO = B.COD_BLOQUEO
	AND D.TZ_LOCK = 0
INNER JOIN OPCIONES AS OE WITH (nolock) ON
	OE.NUMERODECAMPO = 25093
	AND OE.OPCIONINTERNA = B.ESTADO
	AND OE.IDIOMA = ''E''	
INNER JOIN SALDOS AS S WITH (nolock) ON
	S.JTS_OID = B.SALDO_JTS_OID
	AND S.TZ_LOCK = 0
WHERE (		(B.TZ_LOCK < 300000000000000 OR B.TZ_LOCK >= 4000000000000000) 
		AND (B.TZ_LOCK < 1000000000000000 OR B.TZ_LOCK >= 2000000000000000))
----
')

