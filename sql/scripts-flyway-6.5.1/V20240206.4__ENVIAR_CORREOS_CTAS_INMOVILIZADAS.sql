EXECUTE('
ALTER PROCEDURE [ENVIAR_CORREOS_CTAS_INMOVILIZADAS] (
	@dataCorreo VARCHAR(max),
	@JTS_OID NUMERIC(10)
) 
AS 
BEGIN 
	
	--DECLARO TABLA AUXILIAR--
	DECLARE @TablaAuxiliar TABLE(
		ORDINAL INT IDENTITY(1,1) NOT NULL,
		MAIL_TO VARCHAR(128),
		MAIL_FROM VARCHAR(128),
		DATA VARCHAR(2048),
		INTENTOS NUMERIC(1,0),
		SUBJECT VARCHAR(255),
		FECHA_INGRESO DATETIME,
		TZ_LOCK NUMERIC(15,0)
	)
		
	--COMPLETO TABLA AUXILIAR--
	INSERT INTO 
		@TablaAuxiliar
	SELECT
		CE.EMAIL AS MAIL_TO,
		(SELECT ALFA FROM PARAMETROSGENERALES WHERE CODIGO = 205) AS MAIL_FROM,
		@dataCorreo  AS DATA,
		0 AS INTENTOS,
		''Notificación de cuenta inmovilizada'' AS SUBJECT,
		(SELECT FECHAPROCESO FROM PARAMETROS) AS FECHA_INGRESO,
		0 AS TZ_LOCK
	FROM VTA_HISTORICO_INMOVILIZADAS HI with (nolock)
	INNER JOIN GRL_ESTADOS_DE_CUENTA GE with (nolock) ON
		HI.JTS_OID_SALDO = GE.JTSOID
		AND ((GE.TZ_LOCK < 100000000000000 OR GE.TZ_LOCK >= 200000000000000)
			AND (GE.TZ_LOCK < 300000000000000 OR GE.TZ_LOCK >= 400000000000000)  
		)
	INNER JOIN CLI_CLIENTEPERSONA CC with (nolock) ON
		GE.CLIENTE = CC.CODIGOCLIENTE
		AND CC.TITULARIDAD = ''T''
		AND ((CC.TZ_LOCK < 100000000000000 OR CC.TZ_LOCK >= 200000000000000)
			AND (CC.TZ_LOCK < 300000000000000 OR CC.TZ_LOCK >= 400000000000000)  
		)
	INNER JOIN CLI_EMAILS CE with (nolock) ON
		CE.ID = CC.NUMEROPERSONA
		AND CE.TIPO = GE.TIPO_MAIL 
		AND CE.FORMATO = GE.FORMATO_MAIL 
		AND CE.ORDINAL = GE.ORDINAL_MAIL
		AND ((CE.TZ_LOCK < 100000000000000 OR CE.TZ_LOCK >= 200000000000000)
			AND (CE.TZ_LOCK < 300000000000000 OR CE.TZ_LOCK >= 400000000000000)  
		)
	WHERE
		HI.ESTADO_CTA IN (''I'',''C'')
		AND HI.FECHA_NOTIFICACION IS NULL
		AND HI.MOTIVO_INMOVILIZACION = ''D''
		AND (HI.JTS_OID_SALDO = @JTS_OID OR ISNULL(@JTS_OID, 0) = 0)
		AND DATEDIFF(day, HI.FECHA_INMOVILIZACION, (SELECT FECHAPROCESO FROM PARAMETROS WITH (nolock))) = 0 
		AND ((HI.TZ_LOCK < 100000000000000 OR HI.TZ_LOCK >= 200000000000000)
			AND (HI.TZ_LOCK < 300000000000000 OR HI.TZ_LOCK >= 400000000000000)  
		) 
		AND NOT EXISTS (
			SELECT C.ORDINAL
			FROM CORREOS_A_ENVIAR AS C WITH (nolock)
			WHERE C.MAIL_TO = CE.EMAIL
				AND C.MAIL_FROM = (SELECT ALFA FROM PARAMETROSGENERALES WHERE CODIGO = 205)
				AND C.DATA = @dataCorreo
				AND C.INTENTOS = 0
				AND C.SUBJECT = ''Notificación de cuenta inmovilizada''
				AND C.FECHA_INGRESO = (SELECT FECHAPROCESO FROM PARAMETROS)
				AND C.TZ_LOCK = 0
			)
	
	--INSERTO EN CORREOS_A_ENVIAR--
	INSERT INTO
		CORREOS_A_ENVIAR
	SELECT
		T.ORDINAL + ident_current(''SEQUENCE_CORREOS_A_ENVIAR''),
		T.MAIL_TO,
		T.MAIL_FROM,
		T.DATA,
		T.INTENTOS,
		T.SUBJECT,
		T.FECHA_INGRESO,
		T.TZ_LOCK
	FROM @TablaAuxiliar AS T
	
	--INSERT EN SEQUENCE_CORREOS_A_ENVIAR--
		--PARA ACTUALIZAR NUMERADOR--
	INSERT INTO
		SEQUENCE_CORREOS_A_ENVIAR
	SELECT 0
	FROM @TablaAuxiliar
	
	DELETE FROM SEQUENCE_CORREOS_A_ENVIAR

END
')

