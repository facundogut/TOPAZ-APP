EXECUTE('
IF OBJECT_ID (''dbo.VW_RRII_ANEXO_12_RENGLON2'') IS NOT NULL
	DROP VIEW dbo.VW_RRII_ANEXO_12_RENGLON2
')
EXECUTE('
CREATE   VIEW [dbo].[VW_RRII_ANEXO_12_RENGLON2] 
AS

SELECT 
	
	CP.NUMEROPERSONA AS PERSONAS,
	
	G.FECHA AS FECHA,
	
	G.SALDOS_JTS_OID AS JTS_OID,
	
	S.C1785 AS Producto,
	
	CP.CODIGOCLIENTE AS CLIENTE,
	
	ROUND((SELECT (MONTO_MAX)
			FROM TASASFONDOGARANTIA 
			WHERE TZ_LOCK = 0 
				AND FECHA_VIGENCIA = (SELECT MAX(TF.FECHA_VIGENCIA) 
										FROM TASASFONDOGARANTIA TF 
										WHERE TF.FECHA_VIGENCIA <= CONVERT(DATETIME,G.FECHA,103)
											AND TF.TZ_LOCK = 0)),2) AS FDO_GTIA,
								
	G.MONEDA AS MONEDA,

	ISNULL (((SELECT TOP 1 SALDO_AJUSTADO 
				FROM GRL_SALDOS_DIARIOS WITH (NOLOCK)
				WHERE SALDOS_JTS_OID = G.SALDOS_JTS_OID 
				AND MONEDA = G.MONEDA
				AND FECHA = G.FECHA
				AND TZ_LOCK = G.TZ_LOCK)/
	   		(SELECT COUNT(NUMEROPERSONA) 
	   		FROM CLI_ClientePersona WITH (NOLOCK)
	   		WHERE CODIGOCLIENTE = CP.CODIGOCLIENTE 
	   		AND TZ_LOCK = CP.TZ_LOCK)),0) AS MONTODEPOSITO

FROM
	GRL_SALDOS_DIARIOS G WITH (NOLOCK)
	
INNER JOIN SALDOS S WITH(NOLOCK) ON
	G.SALDOS_JTS_OID=S.JTS_OID AND
	G.MONEDA=S.MONEDA AND 
	G.TZ_LOCK=S.TZ_LOCK
INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON
	CP.TZ_LOCK=G.TZ_LOCK AND
	CP.CODIGOCLIENTE = S.C1803
INNER JOIN VTA_SALDOS VS WITH(NOLOCK)ON
	VS.TZ_LOCK = G.TZ_LOCK AND
	S.JTS_OID = VS.JTS_OID_SALDO
WHERE
	S.C1785 IN (2, 3, 4) AND 
	G.TZ_LOCK=0 AND
	VS.FONDOGARANTIA=''S'' AND 
	G.SALDO_AJUSTADO!=0  
GROUP BY
	G.MONEDA,
	CP.NUMEROPERSONA,
	S.C1785,
	G.FECHA,
	G.SALDOS_JTS_OID,
	G.TZ_LOCK,
	CP.CODIGOCLIENTE,
	CP.TZ_LOCK
	
UNION ALL

SELECT

	CP.NUMEROPERSONA AS PERSONAS,
	
	CONVERT(DATETIME,G.FECHA,103) AS FECHA,
	
	G.SALDOS_JTS_OID AS JTS_OID,
	
	S.C1785 AS Producto,
	
	CP.CODIGOCLIENTE AS CLIENTE,
	
	ROUND((SELECT (MONTO_MAX)
			FROM TASASFONDOGARANTIA 
			WHERE TZ_LOCK = 0 
				AND FECHA_VIGENCIA = (SELECT MAX(TF.FECHA_VIGENCIA) 
										FROM TASASFONDOGARANTIA TF 
										WHERE TF.FECHA_VIGENCIA <= CONVERT(DATETIME,G.FECHA,103)
											AND TF.TZ_LOCK = 0)),2) AS FDO_GTIA,
											
	G.MONEDA AS MONEDA,
	
	ISNULL (((SELECT TOP 1 SALDO_AJUSTADO 
				FROM GRL_SALDOS_DIARIOS WITH (NOLOCK)
				WHERE SALDOS_JTS_OID = G.SALDOS_JTS_OID 
				AND MONEDA = G.MONEDA
				AND FECHA = G.FECHA
				AND TZ_LOCK = G.TZ_LOCK)/
	   		(SELECT COUNT(NUMEROPERSONA) 
	   		FROM CLI_ClientePersona WITH (NOLOCK)
	   		WHERE CODIGOCLIENTE = CP.CODIGOCLIENTE 
	   		AND TZ_LOCK = CP.TZ_LOCK)),0) AS MONTODEPOSITO

FROM
	GRL_SALDOS_DIARIOS G WITH (NOLOCK)
	
INNER JOIN SALDOS S WITH(NOLOCK) ON
	G.SALDOS_JTS_OID=S.JTS_OID AND
	G.MONEDA=S.MONEDA AND 
	G.TZ_LOCK=S.TZ_LOCK
INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON
	CP.TZ_LOCK=G.TZ_LOCK AND
	CP.CODIGOCLIENTE = S.C1803
INNER JOIN PZO_SALDOS PS  WITH(NOLOCK)ON
	S.JTS_OID = PS.JTS_OID_SALDO AND
	PS.TZ_LOCK=G.TZ_LOCK
WHERE 
	S.C1785 IN (2, 3, 4) AND
	G.TZ_LOCK=0 AND 
	PS.FONDOGARANTIA=''S'' AND
	G.SALDO_AJUSTADO!=0 
GROUP BY
	G.MONEDA,
	CP.NUMEROPERSONA,
	S.C1785,
	G.FECHA,
	G.SALDOS_JTS_OID,
	G.TZ_LOCK,
	CP.CODIGOCLIENTE,
	CP.TZ_LOCK;
')