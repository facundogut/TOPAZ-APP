EXECUTE('
ALTER PROCEDURE dbo.SP_CONTROL_GYF_VINCULADOS
@CLIENTE NUMERIC(12),
@PERSONA NUMERIC(12),
@TIPO_VINCULACION NUMERIC(3),
@IMPORTE_ANALISIS NUMERIC(15,2),
@EXCEDE_GRAD VARCHAR(1) OUTPUT,
@MENSAJE_INDIVIDUAL VARCHAR(200) OUTPUT,
@MENSAJE_GRUPO VARCHAR(200) OUTPUT
AS
BEGIN
DECLARE @TABLA_VINCULADOS TABLE (CLIENTE NUMERIC(10), DEUDA_TOTAL NUMERIC(15,2), 
SITUACION VARCHAR(3), VINCULACION NUMERIC(3), PORC_SIN_G NUMERIC(5,2),
PORC_CON_G NUMERIC(5,2))
DECLARE @SIT_MAYOR NUMERIC(3)
DECLARE @TOPE_SUELDO NUMERIC(18,2)
DECLARE @DEUDA_TOTAL NUMERIC(18,2)
DECLARE @DEUDA_TOPE NUMERIC(20,2)
DECLARE @DEUDA_GRUPO NUMERIC(20,2)
DECLARE @PORCENTAJE_SING NUMERIC(5,2)
DECLARE @PORCENTAJE_CONG NUMERIC(5,2)
DECLARE @VINCULANTE_DIR NUMERIC(5)
DECLARE @DIRECTORES NUMERIC(5)
--- Tabla auxiliar de deudas
DECLARE @TABLA_ASISTENCIAS TABLE (CLIENTE NUMERIC(12), JTS_ASISTENCIA NUMERIC(10),
IMPORTE_DEUDA NUMERIC(15,2), TIENE_GARANTIA VARCHAR(1), TIPO_GARANTIA NUMERIC(2),
PRODUCTO NUMERIC(5), FAMILIA NUMERIC(10))

INSERT INTO @TABLA_VINCULADOS
SELECT V.[Cliente Vinculado], V.[Deuda Total], V.Situacion, V.[Tipo de vinculo],
ISNULL(VR.PORC_GRANDES_EXP_SING,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=606)),
ISNULL(VR.PORC_GRANDES_EXP_CNG,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO=607))
FROM VW_VINCULACIONES_DEUDAS V WITH(NOLOCK) 
LEFT JOIN CRE_VINCULACIONES G WITH(NOLOCK) ON V.[ID Vinculo] = G.ID_VINCULO AND
G.TZ_LOCK = 0
LEFT JOIN CRE_VINCULOS_RELACIONES VR WITH(NOLOCK) ON VR.TIPO_RELACION = G.TIPO_RELACION AND VR.ID_VINCULO = G.TIPO_VINCULO AND VR.TZ_LOCK = 0
WHERE [Cliente Vinculante] = @CLIENTE

	INSERT INTO @TABLA_ASISTENCIAS
	SELECT 
	AD.CLIENTE,
	AD.JTS_OID,
	SUM(AD.SALDO_DEUDA),
	CASE 
	WHEN CG.JTSOID_SALDO IS NULL THEN ''N''
	ELSE ''S''
	END AS GARANTIA,
	ISNULL(CTG.TIPO_GARANTIA,0),
	p.C6250, 
	f.FAMILIAPROD
	FROM VW_DEUDA_CLIENTES AD WITH(NOLOCK)
	INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = AD.JTS_OID
	INNER JOIN PRODUCTOS p WITH(NOLOCK) ON s.PRODUCTO = p.C6250 
	AND ( (p.tz_lock < 300000000000000 OR p.tz_lock >= 400000000000000) 
	AND (p.tz_lock < 100000000000000 OR p.tz_lock >= 200000000000000)  )
	INNER JOIN CRE_FAMILIAS f ON p.C6283 = f.FAMILIAPROD 
	AND ( (f.tz_lock < 300000000000000 OR f.tz_lock >= 400000000000000) 
	AND (f.tz_lock < 100000000000000 OR f.tz_lock >= 200000000000000)  )	
	LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID
	LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA
	LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND
	CTG.TIPO_BCRA IN (1,2)
	WHERE AD.SALDO_DEUDA <> 0 AND S.C1785 IN (1,5,6)
	AND AD.CLIENTE IN (SELECT CLIENTE FROM @TABLA_VINCULADOS) AND AD.CLIENTE = @CLIENTE
	GROUP BY AD.JTS_OID, CG.JTSOID_SALDO, CTG.TIPO_GARANTIA, p.C6250, f.FAMILIAPROD, AD.CLIENTE
	


SET @DIRECTORES = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 620)

SET @DEUDA_GRUPO = (SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS)

SET @SIT_MAYOR = (SELECT COUNT(1) FROM @TABLA_VINCULADOS WHERE SITUACION > 1)

SET @VINCULANTE_DIR = (SELECT COUNT(1) FROM CRE_VINCULACIONES WITH(NOLOCK) WHERE ID_PERSONA_VINCULADA = @PERSONA 
AND TIPO_VINCULO IN (SELECT ID_VINCULO FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK) WHERE EVALUA_MAYOR_DEUDA = ''S'') 
AND ID_PERSONA_VINCULANTE IN (SELECT ID_PERSONA_VINCULADA FROM CRE_VINCULACIONES WITH(NOLOCK) WHERE TIPO_VINCULO = @DIRECTORES 
AND FECHA_INICIO <= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
AND (FECHA_FIN >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) OR FECHA_FIN IS NULL)))


IF(@VINCULANTE_DIR > 0)
BEGIN
SET @PORCENTAJE_SING = 0

SET @PORCENTAJE_CONG = 0
END
ELSE
BEGIN
SET @PORCENTAJE_SING = (SELECT PORC_GRANDES_EXP_SING FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK) WHERE ID_VINCULO = @TIPO_VINCULACION)

SET @PORCENTAJE_CONG = (SELECT PORC_GRANDES_EXP_CNG FROM CRE_VINCULOS_RELACIONES WITH(NOLOCK) WHERE ID_VINCULO = @TIPO_VINCULACION)
END

IF(@PORCENTAJE_SING = 0 AND @PORCENTAJE_CONG = 0)
 BEGIN
  SET @DEUDA_TOTAL = (SELECT MAYOR_DEUDA_12M_PREV FROM CRE_VINCULACIONES WITH(NOLOCK) WHERE ID_PERSONA_VINCULADA = @PERSONA AND TIPO_VINCULO = @TIPO_VINCULACION AND TZ_LOCK = 0)
  
  SET @TOPE_SUELDO = ((SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 611) * 
  					 (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 612))
  IF(@DEUDA_TOTAL>@TOPE_SUELDO)
   BEGIN
    SET @TOPE_SUELDO = @DEUDA_TOTAL; 
   END
   SET @DEUDA_TOPE = @TOPE_SUELDO;
 END
 ELSE
 BEGIN
    SET @DEUDA_TOTAL = (SELECT SUM(IMPORTE_DEUDA) FROM @TABLA_ASISTENCIAS WHERE CLIENTE = @CLIENTE)
    
 	SET @DEUDA_TOPE = ((SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 609)*@PORCENTAJE_SING)/100;
 	
 	/*(((SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 617)*
 	(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 618))*
 	(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 616))/100;*/
 END
 
 IF((@DEUDA_TOTAL+@IMPORTE_ANALISIS)>@DEUDA_TOPE)
 BEGIN
 SET @EXCEDE_GRAD = ''S'';
 SET @MENSAJE_INDIVIDUAL = ''Exceso en Grandes Exposiciones: ''+CONVERT(VARCHAR(17),FORMAT(ROUND((@DEUDA_TOTAL+@IMPORTE_ANALISIS)-@DEUDA_TOPE,0), ''C'', ''es-ar''))+''.'';
 END
 ELSE 
 BEGIN
 SET @MENSAJE_INDIVIDUAL = ''Encuadrado'';
 SET @EXCEDE_GRAD = ''N'';
 END
 
 IF(@DEUDA_GRUPO>@DEUDA_TOPE)
 BEGIN
 SET @MENSAJE_GRUPO = ''Exceso en Graduación: ''+CONVERT(VARCHAR(17),FORMAT(ROUND(@DEUDA_GRUPO-@DEUDA_TOPE,0), ''C'', ''es-ar''))+''.''; ---''Tope deuda = '' + CONVERT(VARCHAR, @DEUDA_TOPE) + '' Deuda grupo = ''+@DEUDA_GRUPO;
 END
 ELSE 
 SET @MENSAJE_GRUPO = ''Encuadrado'';

/*IF(@SIT_MAYOR > 0 AND @EXCEDE_GRAD = ''N'')
BEGIN
 SET @EXCEDE_GRAD = ''S'';
 SET @MENSAJE_INDIVIDUAL = ''Exceso en Graduación. Hay integrantes con una situación mayor a 1'';
 SET @MENSAJE_GRUPO = ''Exceso en Graduación. Hay integrantes con una situación mayor a 1'';
END*/

END
')
