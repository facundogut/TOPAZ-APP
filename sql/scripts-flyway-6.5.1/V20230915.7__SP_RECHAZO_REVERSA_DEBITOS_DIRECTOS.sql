EXECUTE('
CREATE OR ALTER PROCEDURE SP_RECHAZO_REVERSA_TRANSFERENCIAS
/*ESTE PROCEDIMIENTO RECHAZARÁ LOS REGISTROS DE TRANSFERENCIAS POR MOTIVO
R93 - DÍA FERIADO NO LABORABLE, O REVERSARÁ ESE RECHAZO SEGÚN FUNCIONALIDAD SELECCIONADA*/
	
	@P_ID_PROCESO FLOAT(53), /* Identificador de proceso */
	@P_DT_PROCESO DATETIME,	/* Fecha de proceso */
	@P_SUCURSAL NUMERIC(5), /* Sucursal para donde se buscará las ordenes recibidas */
	@P_FUNCIONALIDAD VARCHAR(1), /* R: Rechazo, P: Reversa del Rechazo */
	@P_RET_PROCESO FLOAT(53) OUTPUT, /* Estado de ejecucion del PL/SQL(1:Correcto, 2: Error) */
	@P_CANTIDAD NUMERIC(12) OUTPUT,
	@P_MSG_PROCESO VARCHAR(6) OUTPUT

AS 
BEGIN

	DECLARE
		@FECHA_ESTADO DATETIME,
		@MOTIVO_RECHAZO NUMERIC (3)

	DECLARE @TMPSaldosSucursal AS TABLE (
			JTS_OID NUMERIC (10, 0)
		)
	
	SELECT @FECHA_ESTADO = FECHAPROCESO FROM PARAMETROS WITH (nolock)
	SET @MOTIVO_RECHAZO = 25 --PARAMETRIZADO EN SNP_MOTIVOS_RECHAZO

	BEGIN TRY

		INSERT INTO @TMPSaldosSucursal
			SELECT
				JTS_OID
			FROM SALDOS WITH (nolock)
			WHERE
				SUCURSAL = @P_SUCURSAL
				AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) 
					AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
				)

		IF @P_FUNCIONALIDAD = ''R'' 
		BEGIN

			SELECT @P_CANTIDAD = count(*) FROM VTA_TRANSFERENCIAS
			WHERE 
				ESTADO = ''PP''
				AND OP_CLASE_TRANS = ''R''
				AND BEN_JTS_OID_CUENTA IN (SELECT JTS_OID FROM @TMPSaldosSucursal)
				AND TZ_LOCK = 0;

			UPDATE VTA_TRANSFERENCIAS
			SET ESTADO = ''RC'',
				FECHA_ESTADO = @FECHA_ESTADO,
				MOTIVO_RECHAZO = @MOTIVO_RECHAZO
			WHERE 
				ESTADO = ''PP''
				AND OP_CLASE_TRANS = ''R''
				AND BEN_JTS_OID_CUENTA IN (SELECT JTS_OID FROM @TMPSaldosSucursal)
				AND TZ_LOCK = 0;

			SET @P_MSG_PROCESO =''A''

		END

		IF @P_FUNCIONALIDAD = ''P'' 
		BEGIN

			SELECT @P_CANTIDAD = count(*) FROM VTA_TRANSFERENCIAS
			WHERE 
				ESTADO = ''RC''
				AND OP_CLASE_TRANS = ''R''
				AND BEN_JTS_OID_CUENTA IN (SELECT JTS_OID FROM @TMPSaldosSucursal)
				AND FECHA_ESTADO = @FECHA_ESTADO
				AND MOTIVO_RECHAZO = @MOTIVO_RECHAZO
				AND TZ_LOCK = 0;

			UPDATE VTA_TRANSFERENCIAS
			SET ESTADO = ''PP'',
				FECHA_ESTADO = NULL,
				MOTIVO_RECHAZO = NULL
			WHERE 
				ESTADO = ''RC''
				AND OP_CLASE_TRANS = ''R''
				AND BEN_JTS_OID_CUENTA IN (SELECT JTS_OID FROM @TMPSaldosSucursal)
				AND FECHA_ESTADO = @FECHA_ESTADO
				AND MOTIVO_RECHAZO = @MOTIVO_RECHAZO
				AND TZ_LOCK = 0;
			
			SET @P_MSG_PROCESO =''B''

		END

		SET @P_RET_PROCESO = 1

	END TRY

	BEGIN CATCH
		DECLARE
			@errornumber int
		SET @errornumber = ERROR_NUMBER()
		DECLARE
			@errormessage nvarchar(4000)
		SET @errormessage = ERROR_MESSAGE()
		BEGIN
			SET @P_RET_PROCESO = ERROR_NUMBER()
			IF @P_FUNCIONALIDAD = ''R''
				BEGIN
					SET @P_MSG_PROCESO = ''Error en rechazo de transferencias por sucursal''
				END
			ELSE
				BEGIN
					SET @P_MSG_PROCESO = ''Error en reversa de rechazo de transferencias por sucursal''
				END

			DECLARE
				@PKG_CONSTANTES$C_LOG_TIPO_ERROR varchar(30)
			SET @PKG_CONSTANTES$C_LOG_TIPO_ERROR = ''E''
			EXECUTE dbo.PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
				@P_ID_PROCESO = @P_ID_PROCESO, 
				@P_FCH_PROCESO = @P_DT_PROCESO, 
				@P_NOM_PACKAGE = ''SP_RECHAZO_REVERSA_TRANSFERENCIAS'', 
				@P_COD_ERROR = @P_RET_PROCESO, 
				@P_MSG_ERROR = @P_MSG_PROCESO, 
				@P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_ERROR
		END
	END CATCH

END
')

