EXECUTE('
IF OBJECT_ID (''dbo.VW_POSICION_CLIENTES_DETALLE'') IS NOT NULL
	DROP VIEW dbo.VW_POSICION_CLIENTES_DETALLE

')

EXECUTE('
CREATE VIEW [dbo].[VW_POSICION_CLIENTES_DETALLE] AS 
SELECT 	CLIENTE AS ''Cliente'', 
		CLASIFICACION AS ''Clasificacion'',
		T.SUCURSAL AS ''Sucursal'',
		T.NOMBRESUCURSAL AS ''Nombre Sucursal'',
		T.PRODUCTO AS ''Producto'',
		T.NOMBREPRODUCTO AS ''Nombre Producto'', 
		T.CUENTA AS ''Cuenta'',
		T.MONEDA AS ''Moneda'',
		T.OPERACION AS ''Operacion'',
		T.ORDINAL AS ''Desglose'',
		DEUDA_EXIGIBLE AS ''Deuda Exigible'',
		DEUDA_NO_EXIGIBLE AS ''Deuda no Exigible'',
		DEUDA_TOTAL ''Deuda Total'',
		DEUDA_CONTINGENTE ''Deuda Contingente'',
CASE WHEN DEUDA_TOTAL < DEUDA_CONTINGENTE THEN DEUDA_CONTINGENTE
	ELSE DEUDA_TOTAL END AS ''Riesgo Total'',
		T.MONTOORIGEN AS ''Monto Origen'',
		T.SALDO AS ''Saldo Capital'',
		T.VENCIMIENTO AS ''Vencimiento'',
		T.ESTADO AS ''Estado'',
		T.JTS_OID
FROM ( 
SELECT 	vw.CLIENTE, 
		s.SUCURSAL,
		VA.NOMBRESUCURSAL,
		s.PRODUCTO,
		VA.NOMBREPRODUCTO,
		s.CUENTA,
		s.MONEDA,
		s.OPERACION,
		s.ORDINAL,
		VA.MONTOORIGEN,
		VA.SALDO,
		VA.VENCIMIENTO,
		VA.ESTADO,
	 CASE WHEN vw.CLASIFICACION=''L'' THEN ''Leasing''
	 WHEN vw.CLASIFICACION IN (''A'',''O'') THEN ''CC''
	 WHEN vw.CLASIFICACION=''D'' THEN ''Descuento Bancario''
	 WHEN vw.CLASIFICACION=''T'' THEN ''Tarjeta de Crédito''
	 -- WHEN CLASIFICACION=''GO'' THEN ''Garantías Otorgadas''
	 ELSE ''Prestamos'' END AS CLASIFICACION,
	 CASE WHEN vw.CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))> 0 THEN sum(S.C1685)
	 	  ELSE sum(SALDO_DEUDA) END AS DEUDA_EXIGIBLE,
	 SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0)) AS DEUDA_NO_EXIGIBLE,
	 sum(SALDO_DEUDA)+ SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0)) AS DEUDA_TOTAL,
	 CASE WHEN vw.CLASIFICACION=''A'' THEN sum(vw.MONTOORIGEN)
	      WHEN vw.CLASIFICACION=''T'' THEN sum(S.C1806)
	      ELSE 0 END AS DEUDA_CONTINGENTE,
s.JTS_OID 	      
FROM VW_DEUDA_CLIENTES vw
INNER JOIN SALDOS S ON S.JTS_OID=vw.JTS_OID
INNER JOIN VW_ASISTENCIAS VA WITH(NOLOCK) ON S.JTS_OID = VA.JTS_OID 
LEFT JOIN VW_ASISTENCIAS_DEUDA_NO_EXIGIBLE A ON A.SALDO_JTS_OID=vw.JTS_OID
WHERE vw.SALDO>0 
GROUP BY vw.CLIENTE, vw.CLASIFICACION, s.JTS_OID,s.SUCURSAL,s.PRODUCTO,s.CUENTA,s.MONEDA,s.OPERACION,VA.NOMBRESUCURSAL,VA.NOMBREPRODUCTO,
s.ORDINAL,VA.MONTOORIGEN,VA.SALDO,VA.VENCIMIENTO,VA.ESTADO
) T 

')