Execute('CREATE OR ALTER PROCEDURE SP_VALIDA_DEBITOSAUTOMATICOS @ID_CABEZAL NUMERIC(15),  @P_RET_PROCESO float(53)  OUTPUT,  @P_MSG_PROCESO varchar(max)  OUTPUT

AS

DECLARE @Cant_Cta_Cerradas NUMERIC(15);
DECLARE @Cant_Validas NUMERIC(15);
DECLARE @Cant_StopeD NUMERIC(15);
DECLARE @Cant_Bloqueadas NUMERIC(15);
DECLARE @Cant_MonedaNoPesos NUMERIC(15);
DECLARE @Cant_Cta_Inexistente NUMERIC(15);
DECLARE @Cant_TitNoValido NUMERIC(15);
DECLARE @fecha_proceso DATETIME;
DECLARE @ConError NUMERIC(15);
DECLARE @TotalReg NUMERIC(15);

SELECT @fecha_proceso = FECHAPROCESO  FROM PARAMETROS WITH (NOLOCK);
SELECT @TotalReg = count(*) from REC_det_DEBITOSAUTOMATICOS WHERE ID_CABEZAL = @ID_CABEZAL;

UPDATE REC_det_DEBITOSAUTOMATICOS SET ESTADO = ''E'', DETALLE_ESTADO = ''Cuenta inexistente''
FROM REC_det_DEBITOSAUTOMATICOS WHERE ID_CABEZAL = @ID_CABEZAL and not exists(select * from Saldos where CUENTA = NRO_CUENTA
AND SUCURSAL_CTA = SUCURSAL AND MONEDA = 1 AND C1785 = (Case When TIPO_CTA = ''AC'' Then 3 Else 2 END)) AND ESTADO = ''I'';
SET @Cant_Cta_Inexistente = @@ROWCOUNT

UPDATE REC_det_DEBITOSAUTOMATICOS SET ESTADO = ''V'', DETALLE_ESTADO = ''Cuenta bloqueada''
FROM REC_det_DEBITOSAUTOMATICOS WHERE ID_CABEZAL = @ID_CABEZAL and exists(select * from Saldos where CUENTA = NRO_CUENTA
AND SUCURSAL_CTA = SUCURSAL AND MONEDA = 1 AND C1785 = (Case When TIPO_CTA = ''AC'' Then 3 Else 2 END) AND C1679 = ''1'') AND ESTADO = ''I'';
SET @Cant_Bloqueadas = @@ROWCOUNT

UPDATE REC_det_DEBITOSAUTOMATICOS SET ESTADO = ''E'', DETALLE_ESTADO = ''Cuenta no valida''
FROM REC_det_DEBITOSAUTOMATICOS WHERE Moneda <> 1 AND ID_CABEZAL = @ID_CABEZAL AND ESTADO = ''I'';
SET @Cant_MonedaNoPesos = @@ROWCOUNT

UPDATE REC_det_DEBITOSAUTOMATICOS SET ESTADO = ''V'', DETALLE_ESTADO = ''Rechazo por STOP DEBIT'', TIENE_STOP_DEBIT = ''S''
FROM REC_det_DEBITOSAUTOMATICOS WHERE ID_CABEZAL = @ID_CABEZAL And exists (select * from Saldos s JOIN SNP_STOP_DEBIT sd ON  sd.CLIENTE_ADHERIDO = s.C1803  AND sd.TZ_LOCK = 0
where CUENTA = NRO_CUENTA AND SUCURSAL_CTA = SUCURSAL AND s.MONEDA = 1 AND C1785 = (Case When TIPO_CTA = ''AC'' Then 3 Else 2 END) AND sd.FECHA_DESDE <= @fecha_proceso 
AND @fecha_proceso < sd.FECHA_HASTA AND sd.DEBITO_DIRECTO = ''N'' AND sd.ESTADO = ''AC'') and ESTADO = ''I'';
SET @Cant_StopeD = @@ROWCOUNT

UPDATE REC_det_DEBITOSAUTOMATICOS SET ESTADO = ''E'', DETALLE_ESTADO = ''Cuenta cancelada''
FROM REC_det_DEBITOSAUTOMATICOS WHERE ID_CABEZAL = @ID_CABEZAL and exists(select * from Saldos where CUENTA = NRO_CUENTA
AND SUCURSAL_CTA = SUCURSAL AND MONEDA = 1 AND C1785 = (Case When TIPO_CTA = ''AC'' Then 3 Else 2 END) AND C1651 = ''2'') AND ESTADO = ''I'';
SET @Cant_Cta_Cerradas = @@ROWCOUNT

UPDATE REC_det_DEBITOSAUTOMATICOS SET ESTADO = ''E'', DETALLE_ESTADO = ''Titular no Asoc con Cta indicada''
FROM REC_det_DEBITOSAUTOMATICOS WHERE ID_CABEZAL = @ID_CABEZAL and NRO_CUENTA NOT IN (SELECT CUENTA FROM SALDOS
JOIN VW_CLI_X_DOC ON CODIGOCLIENTE = C1803 AND C1785 = (Case When TIPO_CTA = ''AC'' Then 3 Else 2 END) 
WHERE NUMERODOC = NRO_DOC) AND ESTADO = ''I'';
SET @Cant_TitNoValido = @@ROWCOUNT

UPDATE REC_det_DEBITOSAUTOMATICOS SET ESTADO = ''V'', DETALLE_ESTADO = ''Validado''
FROM REC_det_DEBITOSAUTOMATICOS WHERE ID_CABEZAL = @ID_CABEZAL and ESTADO = ''I'';
SET @Cant_Validas = @@ROWCOUNT

SET @ConError = (SELECT count(*) FROM REC_det_DEBITOSAUTOMATICOS WHERE ID_CABEZAL = @ID_CABEZAL and ESTADO = ''E'');

IF @Cant_Validas = @TotalReg OR @ConError < @TotalReg
	BEGIN
		UPDATE REC_CAB_DEBITOSAUTOMATICOS  SET ESTADO = ''V''  WHERE ID = @ID_CABEZAL
	END
ELSE
	BEGIN
		UPDATE REC_CAB_DEBITOSAUTOMATICOS  SET ESTADO = ''E''  WHERE ID = @ID_CABEZAL
	END
	
	SET @P_MSG_PROCESO = CONCAT('' Proceso finalizado correctamente, se procesaron ('',@TotalReg,'') registros, válidos ('',@Cant_Validas,''), con error ('',@Cant_Cta_Cerradas + @Cant_StopeD + @Cant_MonedaNoPesos + @Cant_Bloqueadas + @Cant_Cta_Inexistente + @Cant_TitNoValido ,'') - Cabezal '',@ID_CABEZAL)


truncate table dbo.BITACORA_TJC_MAESTRO_USUARIO ; 

alter table dbo.BITACORA_TJC_MAESTRO_USUARIO add FyH_REAL datetime not null default getdate() ; ')