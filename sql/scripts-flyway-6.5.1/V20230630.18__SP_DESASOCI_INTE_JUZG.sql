EXECUTE('
CREATE OR ALTER PROCEDURE SP_DESASOCI_INTE_JUZG
   @P_NUM_JUZG  float(12),
   @P_NUM_SOLIC float(12),
   @P_NUM_PER float(12),
   @P_ASIENTO float(10),
   @P_OPERACION VARCHAR(4),
   @P_USUARIO VARCHAR(10),
   @P_HORA VARCHAR(8),
   @P_FECHA_VENCIMIENTO DATE,
   
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
      
AS 

   BEGIN

      SET @P_RET_PROCESO = NULL
      SET @P_MSG_PROCESO = NULL
      
      DECLARE

         @FECHA DATETIME,
         @FECHA_ANTERIOR DATETIME,
         @CANT NUMERIC(5),
         @row_number NUMERIC(6),
         @v_constante VARCHAR(1),
         @v_numerador NUMERIC,
         @v_correlativo NUMERIC(10),
         
         --DECLARO VARIABLES TEMPORALES PARA RECORER TABLA AUXILIAR--
		 @NRO_SOLICITUDTemp NUMERIC (12, 0),
   		 @ID_PERSONATemp NUMERIC (12, 0),
   		 @NRO_JUZGADOTemp  NUMERIC (12, 0), 
   		 @JTS_OID_CUENTATemp NUMERIC (10, 0),
   		 @NRO_CAUSATemp NUMERIC (12, 0),
      	 @ACTORTemp VARCHAR(3),
      	 @FECHA_INTEGRACIONTemp DATETIME,
      	 @FECHA_CESETemp DATETIME,
      	 @ACTIVOTemp VARCHAR(1),
      	 @ESTADOTemp VARCHAR(1),
      	 @FECHA_ESTADOTemp DATETIME,
      	 @SUCURSALTemp NUMERIC (5, 0),
      	 @TIPO_ENTIDADTemp NUMERIC (5, 0),
   		 @TIPO_PODERTemp NUMERIC (5, 0)
      	 
      	 
      --SET @CANT = 0
      SELECT @FECHA = FECHAPROCESO FROM PARAMETROS
      SELECT @FECHA_ANTERIOR = FECHAPROCESOANTERIOR FROM PARAMETROS
      
      --DECLARO TABLA AUXILIAR--
	  DECLARE @Tabla_ASOCI_INTE_JUZG TABLE(
		NRO_SOLICITUD NUMERIC (12, 0), 
      	ID_PERSONA NUMERIC (12, 0), 
      	NRO_JUZGADO NUMERIC (12, 0), 
      	JTS_OID_CUENTA NUMERIC (10, 0),
      	NRO_CAUSA NUMERIC (12, 0),
      	ACTOR VARCHAR(3),
      	FECHA_INTEGRACION DATETIME,
      	FECHA_CESE DATETIME,
      	ACTIVO VARCHAR(1),
      	ESTADO VARCHAR(1),
      	FECHA_ESTADO DATETIME,
      	SUCURSAL NUMERIC (5, 0),
      	TIPO_ENTIDAD NUMERIC (5, 0), 
      	TIPO_PODER NUMERIC (5, 0),
      	FILAS BIGINT 
	  )
	  
	 
	 
      --COMPLETO TABLA AUXILIAR--
	  INSERT INTO 
		@Tabla_ASOCI_INTE_JUZG
      SELECT s.NRO_SOLICITUD, 
      	     s.ID_PERSONA, 
      	     s.NRO_JUZGADO, 
      	     cc.JTS_OID_CUENTA,
      	     c.NRO_CAUSA,
      	     s.ACTOR,
      	     s.FECHA_INTEGRACION,
      	     s.FECHA_CESE,
      	     s.ACTIVO,
      	     s.ESTADO,
      	     s.FECHA_ESTADO,
      	     s.SUCURSAL,
      	     tt.TIPO_ENTIDAD,
      	     tt.TIPO_PODER,
      	     row_number() OVER(ORDER BY s.NRO_SOLICITUD) AS filas
	  FROM DJ_SOLICITUD_AD_INTEG_JUZ s WITH (NOLOCK)
	  INNER JOIN DJ_CAUSAS c WITH (NOLOCK) ON c.JUZGADO=s.NRO_JUZGADO 
	  	AND c.TZ_LOCK = 0
	  INNER JOIN DJ_CAUSA_CUENTA cc WITH (NOLOCK) ON cc.NRO_CAUSA=c.NRO_CAUSA 
	  	AND (cc.TZ_LOCK < 300000000000000 OR cc.TZ_LOCK >= 400000000000000),
	  PYF_APODERADOS tt WITH (NOLOCK)
	  WHERE s.NRO_JUZGADO = @P_NUM_JUZG
	  	AND s.NRO_SOLICITUD = @P_NUM_SOLIC
	  	AND s.ID_PERSONA = @P_NUM_PER
	  	AND s.TZ_LOCK = 0
		AND s.ESTADO = ''I''  
		AND c.ESTADO NOT IN (''T'')
		AND cc.JTS_OID_CUENTA NOT IN (SELECT b.JTS_OID_CUENTA FROM DJ_BENEFICIARIOS b WHERE (b.TZ_LOCK < 300000000000000 OR b.TZ_LOCK >= 400000000000000))
		AND TRY_CAST(tt.ID_ENTIDAD AS DECIMAL(10,0)) = cc.JTS_OID_CUENTA 
		AND tt.ID_PERSONA = @P_NUM_PER
      
    
      BEGIN TRANSACTION	
      
       BEGIN TRY
	       	  	
	       	  	/*SE QUITAN PODERES*/
				UPDATE P
				SET 
					P.FECHA_VENCIMIENTO = @FECHA_ANTERIOR,
					P.FECHA_INI_SUSPENSION = P.FECHA_VENCIMIENTO, --@P_FECHA_VENCIMIENTO,
					--P.FECHA_INI_VIGENCIA = P.FECHA_VENCIMIENTO, --@FECHA,
					P.ID_CLIENTE_SALDO = T.JTS_OID_CUENTA
				FROM
					PYF_APODERADOS AS P
				INNER JOIN @Tabla_ASOCI_INTE_JUZG AS T ON
					P.ID_PERSONA = T.ID_PERSONA
					AND TRY_CAST(P.ID_ENTIDAD AS DECIMAL(10,0)) = T.JTS_OID_CUENTA
					AND P.TIPO_PODER = T.TIPO_PODER
					
					
		
		
				/*SE QUITA EL ITEGRANTE*/
				UPDATE P
				SET 
					P.FECHA_CESE = @FECHA,
					P.ACTIVO = ''N''
				FROM DJ_INTEGRANTES_CAUSAS AS P
				INNER JOIN @Tabla_ASOCI_INTE_JUZG AS T ON
			    P.NRO_CAUSA = T.NRO_CAUSA
			    AND P.ID_PERSONA = @P_NUM_PER
	  					
   
			COMMIT TRANSACTION;
			
			SET @P_RET_PROCESO = 1
		    SET @P_MSG_PROCESO = ''Se desasocio integrante correctamente.''
			 
		END TRY     
		
		BEGIN CATCH
			ROLLBACK TRANSACTION
			SET @P_RET_PROCESO = ERROR_NUMBER()
			SET @P_MSG_PROCESO = ERROR_MESSAGE()
			EXECUTE dbo.pkg_constantes$VarcharConstantes ''C_LOG_TIPO_ERROR'', @v_constante OUTPUT;
		END CATCH
		 	      
 END
')

