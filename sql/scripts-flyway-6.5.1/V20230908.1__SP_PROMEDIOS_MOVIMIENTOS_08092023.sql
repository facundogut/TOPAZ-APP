EXECUTE('
CREATE OR ALTER PROCEDURE dbo.[SP_PROMEDIOS_MOVIMIENTOS]
   --Juan Pedrozo
	@cuit NUMERIC(15) --prueba desa: ''20115128095''	
	
AS
BEGIN
 
 	--limpio tabla aux
 	TRUNCATE TABLE ITF_PROMEDIOS_MOVIMIENTOS;

	--cargar tabla aux con valores en cero y rango de fecha
	DECLARE @i INT = 1;
	DECLARE @fechita DATETIME = ((SELECT FECHAPROCESO FROM PARAMETROS));
	INSERT INTO ITF_PROMEDIOS_MOVIMIENTOS (FECHA, ANIO, MES) VALUES (@fechita, year(@fechita), MONTH(@fechita))
	
	WHILE @i <= 30
	BEGIN
		INSERT INTO ITF_PROMEDIOS_MOVIMIENTOS (FECHA, ANIO, MES) VALUES (dateadd(MONTH,-@i,@fechita), year(dateadd(MONTH,-@i,@fechita)), MONTH(dateadd(MONTH,-@i,@fechita)))
		SET @i += 1;
	END		
	
	--acumulo movimientos mensuales y update a la tabla aux
	DECLARE @C_ANIO NUMERIC(4), @C_MES NUMERIC(2), @C_MOVIMIENTOS_MENSUALES NUMERIC(15,2);
	DECLARE mov_cursor CURSOR FOR 		
		SELECT mov.ANIO, mov.MES, sum(mov.IMPORTE_MOVIMIENTOS) AS IMPORTE_MOVIMIENTOS
			FROM --GRL_CONT_DIARIO_MOV d JOIN 
		 	   	GRL_CONTADOR_MOVIMIENTOS  mov JOIN SALDOS s ON mov.SALDOS_JTS_OID = s.JTS_OID --d.SALDOS_JTS_OID 
		 	   	--SALDOS s ON d.SALDOS_JTS_OID = s.JTS_OID JOIN
				JOIN VW_CLI_X_DOC doc ON s.c1803 = doc.CODIGOCLIENTE 
			WHERE s.TZ_LOCK = 0 and  
				s.C1785 in (2,3) and		   
				--d.CODIGO_TRANSACCION IN 
				mov.CODIGO_TRANSACCION IN 
					(SELECT CODIGO_TRANSACCION FROM TTR_CODIGO_TRANSACCION_DEF WHERE UTILIZA_CONTADOR_MOVIM=''S'' AND TZ_LOCK=0 )	
			   and	doc.NUMERODOC = @cuit
			GROUP BY mov.ANIO, mov.MES, doc.NUMERODOC 
	OPEN mov_cursor
	FETCH NEXT FROM mov_cursor INTO @C_ANIO, @C_MES, @C_MOVIMIENTOS_MENSUALES
	
	WHILE @@FETCH_STATUS = 0
	BEGIN		
		UPDATE ITF_PROMEDIOS_MOVIMIENTOS SET MOVIMIENTOS_MENSUALES = @C_MOVIMIENTOS_MENSUALES WHERE ANIO =  @C_ANIO AND MES =  @C_MES;
		FETCH NEXT FROM mov_cursor INTO @C_ANIO, @C_MES, @C_MOVIMIENTOS_MENSUALES;
	END
	CLOSE mov_cursor
	DEALLOCATE mov_cursor
	
	
	--recorro tabla aux y calculo los promedios anuales
	DECLARE @promedio NUMERIC (15,2);
	DECLARE @j INT = 1;
	WHILE @j <= 30--18
	BEGIN	
		SET @promedio = (SELECT sum(MOVIMIENTOS_MENSUALES)/13 FROM ITF_PROMEDIOS_MOVIMIENTOS  WHERE fecha BETWEEN dateadd(MONTH,-12,@fechita) AND @fechita)
		UPDATE  ITF_PROMEDIOS_MOVIMIENTOS SET PROMEDIO_ANUAL = @promedio WHERE FECHA = @fechita;
		SET @fechita = dateadd(MONTH,-1,@fechita);
		SET @j += 1;	
	END 


	--muestro resultado
	SELECT TOP 18 LEFT(CONVERT(VARCHAR(6),FECHA,112), 6) AS fecha, PROMEDIO_ANUAL AS promedio FROM ITF_PROMEDIOS_MOVIMIENTOS WHERE ID > 1 ORDER BY ANIO DESC, MES DESC;
	COMMIT
	
END
')
