EXECUTE('
----
ALTER PROCEDURE [dbo].[SP_MAILS_MODIFICACION_COMISIONES] 
@Cargo NUMERIC(4,0),
@Tasa NUMERIC(11,6),
@Importe NUMERIC(15,2),
@Segmento VARCHAR (150)
AS
BEGIN
	SET NOCOUNT ON;

	--DECLARO TABLA AUXILIAR--
	DECLARE @TablaAuxiliar TABLE(
		ORDINAL INT IDENTITY(1,1) NOT NULL,
		MAIL_TO VARCHAR(128),
		MAIL_FROM VARCHAR(128),
		DATA VARCHAR(2048),
		INTENTOS NUMERIC(1,0),
		SUBJECT VARCHAR(255),
		FECHA_INGRESO DATETIME,
		TZ_LOCK NUMERIC(15,0)
	)
		
	--COMPLETO TABLA AUXILIAR--
	INSERT INTO 
		@TablaAuxiliar
	SELECT
		DISTINCT E.EMAIL AS CORREO_DESTINO,
		(SELECT ALFA FROM PARAMETROSGENERALES with (nolock) WHERE [CODIGO] = 205),
		concat(''Html=ModificaciónCargos.html;Variables=DescripcionCargo::'',
				(SELECT DESCRIPCION FROM CI_CARGOS with (nolock) WHERE ID_CARGO = @Cargo),
				'';Variables=Fecha::'', CONVERT(VARCHAR, GETDATE(), 103),
				'';Variables=Tasa::'', @Tasa, '';Variables=Importe::'', @Importe,
				'';Variables=Segmento::'', @Segmento) AS DATA,
		0 AS INTENTOS,
		''NOTIFICACIÓN POR MODIFICACIÓN DE COMISIONES'' AS SUBJECT,
		(SELECT FECHAPROCESO FROM PARAMETROS with (nolock)) AS FECHA_INGRESO,
		0 AS TZ_LOCK
	FROM SALDOS AS S WITH (nolock)
	INNER JOIN CI_RELPRODEVENTO AS R WITH (nolock) ON
		R.PRODUCTO = S.PRODUCTO
		AND R.NOTIFICA = ''S''
		AND R.TZ_LOCK = 0
	INNER JOIN CI_CARGOS_X_EVENTO AS V with (nolock) ON
		V.ID_EVENTO = R.EVENTO
		AND V.ID_CARGO = @Cargo
		AND V.TZ_LOCK = 0
	INNER JOIN GRL_ESTADOS_DE_CUENTA AS G with (nolock) ON
		G.JTSOID = S.JTS_OID
		AND G.TZ_LOCK = 0
	INNER JOIN CLI_ClientePersona AS T with (nolock) ON
		T.CODIGOCLIENTE = G.CLIENTE
		AND T.TITULARIDAD = ''T''
		AND T.TZ_LOCK = 0
	INNER JOIN CLI_EMAILS AS E with (nolock) ON
		E.ID = T.NUMEROPERSONA
		AND E.TZ_LOCK = 0
	WHERE 
		S.C1651 <> 1
		AND S.TZ_LOCK = 0

	--INSERTO EN CORREOS_A_ENVIAR--
	INSERT INTO
		CORREOS_A_ENVIAR
	SELECT
		T.ORDINAL + ident_current(''SEQUENCE_CORREOS_A_ENVIAR''),
		T.MAIL_TO,
		T.MAIL_FROM,
		T.DATA,
		T.INTENTOS,
		T.SUBJECT,
		T.FECHA_INGRESO,
		T.TZ_LOCK
	FROM @TablaAuxiliar AS T
	
	--INSERT EN SEQUENCE_CORREOS_A_ENVIAR--
		--PARA ACTUALIZAR NUMERADOR--
	INSERT INTO
		SEQUENCE_CORREOS_A_ENVIAR
	SELECT 0
	FROM @TablaAuxiliar
	
	DELETE FROM SEQUENCE_CORREOS_A_ENVIAR
END
----
')