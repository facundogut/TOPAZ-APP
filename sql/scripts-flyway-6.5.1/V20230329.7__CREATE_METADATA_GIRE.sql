Execute('
CREATE TABLE dbo.ITF_GIRELEC_AUX
	(
	ORDEN    	INT IDENTITY NOT NULL,
	CAMPO 	 	VARCHAR (300),
	ID_CABEZAL	INT,
	TIPO		NUMERIC(1)
	)
')

Execute('
CREATE OR ALTER PROCEDURE dbo.[SP_GIRELEC_ORDEN_REGISTROS] 
--Created: Juan Pedrozo: 28/03/23

--parametros de prueba: convenio=7, fecha_rendicion = ''20241028''

--cod_error = 1 es porque no hay suficientes registros para armar el documento

--en ITF_GIRELEC_AUX, el campo TIPO es 1:CANAL - 2:CAJA - 3:PIE

@convenio NUMERIC(5), 
@fecha_rendicion VARCHAR(8),
@cod_error VARCHAR(1) OUT

AS
BEGIN

	TRUNCATE TABLE ITF_GIRELEC_AUX;	
	
--cab	
	--CANAL
	INSERT INTO ITF_GIRELEC_AUX (ID_CABEZAL, CAMPO, TIPO) 
		SELECT CAB.ID AS idCabezal, Concat(''C'',dbo.NCADENAS(REL.SUCURSAL,4,''0'',''P''), 
		convert(VARCHAR,CAB.FECHACARGA,12),dbo.NCADENAS(CAB.TOTALREGISTROS,10,''0'',''P''), --preguntar si es la cantidad de detalles que corresponden a este cab
		dbo.NCADENAS(CAST(Round(CAB.TOTALIMPORTE*100,0) AS NUMERIC(12)),12,''0'',''P''),REPLICATE('' '',107)) as Registro, 1
		FROM REC_RENDICION REN
		JOIN CONV_CONVENIOS_REC CONV ON CONV.Id_ConvRec = ren.CONVENIO
		JOIN RelConvenioSucursalRendicion REL ON REL.TipoConvenio = CONV.Id_TpoConv AND REL.CANAL = CONV.Canal
		JOIN REC_LIQUIDACION LIQ ON liq.CONVENIO = CONV.Id_ConvRec
		JOIN REC_CAB_RECAUDOS_CANAL CAB ON cab.CONVENIO = liq.CONVENIO
		WHERE LIQ.ESTADO = ''R'' AND REN.CONVENIO = @convenio AND REN.FECHA = CAST(@fecha_rendicion AS DATE) AND CAB.TOTALREGISTROS > 0
		GROUP BY REL.SUCURSAL,CAB.FECHACARGA, CAB.ID, CAB.TOTALREGISTROS, CAB.TOTALIMPORTE
		
	--CAJA	
	INSERT INTO ITF_GIRELEC_AUX (ID_CABEZAL, CAMPO, TIPO) 	
		SELECT CAB.ID AS idCabezal, Concat(''C'',dbo.NCADENAS(DET.SUCURSAL_COBRANZA,4,''0'',''P''),
		convert(VARCHAR,CAB.FECHACARGA,12),dbo.NCADENAS(CAB.TOTALREGISTROS,10,''0'',''P''),
		dbo.NCADENAS(CAST(Round(CAB.TOTALIMPORTE*100,0) AS NUMERIC(12)),12,''0'',''P''),REPLICATE('' '',107)) as Registro, 2
		FROM REC_RENDICION REN
		JOIN CONV_CONVENIOS_REC CONV ON CONV.Id_ConvRec = ren.CONVENIO
		JOIN REC_LIQUIDACION LIQ ON liq.CONVENIO = CONV.Id_ConvRec
		JOIN REC_CAB_RECAUDOS_CAJA CAB ON CAB.CONVENIO = LIQ.CONVENIO
		JOIN REC_DET_RECAUDOS_CAJA DET ON CAB.ID = DET.ID_CABEZAL
		WHERE LIQ.ESTADO = ''R'' AND REN.CONVENIO = @convenio AND REN.FECHA = CAST(@fecha_rendicion AS DATE) AND CAB.TOTALREGISTROS > 0
		GROUP BY DET.SUCURSAL_COBRANZA,CAB.FECHACARGA, CAB.ID, CAB.TOTALREGISTROS, CAB.TOTALIMPORTE
	
	
--det	
	--CANAL
	INSERT INTO ITF_GIRELEC_AUX (ID_CABEZAL, CAMPO, TIPO) 
		SELECT CAB.ID AS idCabezal, Concat(''T'',dbo.NCADENAS(isnull(DET.CODIGO_BARRAS,'' ''),100,'' '',''F''),
		CASE WHEN DET.CODIGO_BARRAS IS NOT NULL THEN ''0'' ELSE ''5'' END,
		dbo.NCADENAS(CAST(Round(DET.IMPORTE*100,0) AS NUMERIC(12)),12,''0'',''P''),	REPLICATE('' '',26)) as Registro, 1
		FROM REC_RENDICION REN
		JOIN REC_LIQUIDACION LIQ ON REN.CONVENIO = liq.CONVENIO
		JOIN REC_CAB_RECAUDOS_CANAL CAB ON cab.CONVENIO = liq.CONVENIO
		JOIN REC_DET_RECAUDOS_CANAL DET ON CAB.ID = DET.ID_CABEZAL
		WHERE LIQ.ESTADO = ''R'' AND REN.CONVENIO = @convenio AND REN.FECHA = CAST(@fecha_rendicion AS DATE) 
		GROUP BY DET.CODIGO_BARRAS,REN.SUCURSAL_RENDICION, cab.ID,DET.IMPORTE
		
	--CAJA
	INSERT INTO ITF_GIRELEC_AUX (ID_CABEZAL, CAMPO, TIPO)
		SELECT CAB.ID AS idCabezal, Concat(''T'',dbo.NCADENAS(isnull(DET.CODIGO_BARRAS,'' ''),100,'' '',''F''),
		CASE WHEN DET.CODIGO_BARRAS IS NOT NULL THEN ''0'' ELSE ''5'' END,
		dbo.NCADENAS(CAST(Round(DET.IMPORTE*100,0) AS NUMERIC(12)),12,''0'',''P''),REPLICATE('' '',26)) as Registro, 2
		FROM REC_RENDICION REN
		JOIN REC_LIQUIDACION LIQ ON REN.convenio = LIQ.CONVENIO
		JOIN REC_CAB_RECAUDOS_CAJA CAB ON LIQ.CONVENIO = CAB.CONVENIO
		JOIN REC_DET_RECAUDOS_CAJA DET ON CAB.ID = DET.ID_CABEZAL
		WHERE LIQ.ESTADO = ''R'' AND REN.CONVENIO = @convenio AND REN.FECHA = CAST(@fecha_rendicion AS DATE)
		GROUP BY DET.CODIGO_BARRAS,REN.SUCURSAL_RENDICION, CAB.ID,DET.IMPORTE
	
	
--pie
	INSERT INTO ITF_GIRELEC_AUX (ID_CABEZAL, CAMPO, TIPO) 
		SELECT (SELECT max(ID_CABEZAL)+1 FROM ITF_GIRELEC_AUX) AS idCabezal,
			Concat(''P'',
			dbo.NCADENAS(''311'',5,''0'',''P''),
			trim(dbo.NCADENAS((SELECT numerico FROM PARAMETROSGENERALES WHERE CODIGO = 2),5,''0'',''P'')),
			dbo.ncadenas(totalTalones,20,''0'',''P''),		
			dbo.ncadenas(totalImporteTalones,22,''0'',''P''),
			REPLICATE('' '',87)) AS REGISTRO, 3 
			FROM 
			(
			SELECT count(*) as totalTalones, sum(CAST(substring(CAMPO, 105,12) AS NUMERIC)) as totalImporteTalones
				FROM ITF_GIRELEC_AUX WHERE CAMPO LIKE ''T%''
				) AS datos;
	
	

	--set cod error
	 SET @cod_error = (SELECT CASE WHEN COUNT(*) >= 3 THEN 0 ELSE 1 END FROM ITF_GIRELEC_AUX);	 
	 IF (@cod_error = 0)
	 BEGIN
	 	DECLARE @cantCabezales NUMERIC(20) = (SELECT COUNT(*) FROM ITF_GIRELEC_AUX WHERE CAMPO LIKE ''C%'');
	   	DECLARE @cantTalones NUMERIC(20) = (SELECT COUNT(*) FROM ITF_GIRELEC_AUX WHERE CAMPO LIKE ''T%'');
	    DECLARE @cantPie NUMERIC(20) = (SELECT COUNT(*) FROM ITF_GIRELEC_AUX WHERE CAMPO LIKE ''P%'');
	    
		IF(
			@cantCabezales  = 0 OR 
			@cantCabezales > @cantTalones OR
			@cantTalones = 0 OR 
			@cantPie <> 1
		) SET @cod_error = 1;
		
	 END					 
END;
')
