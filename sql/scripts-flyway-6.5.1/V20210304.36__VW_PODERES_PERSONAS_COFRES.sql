/****** Object:  View [dbo].[VW_PODERES_PERSONAS_COFRES]    Script Date: 24/02/2021 11:57:49 ******/
DROP VIEW [dbo].[VW_PODERES_PERSONAS_COFRES]
GO

/****** Object:  View [dbo].[VW_PODERES_PERSONAS_COFRES]    Script Date: 24/02/2021 11:57:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[VW_PODERES_PERSONAS_COFRES] (
   NUMERO_CONTRATO, 
   TIPODOC, 
   NUMERODOC, 
   NUMEROPERSONA, 
   TITULARIDAD, 
   TIPOPERSONA, 
   NOMBRE, 
   PODER, 
   ESTADO, 
   DEPENDENCIA)
AS 
   SELECT 
      --SUBSTRING(CAST(w.NROCUENTA AS VARCHAR),2,LEN(w.NROCUENTA)-1) AS numero_contrato, 
      x.[CODIGO] AS numero_contrato,
      v.TIPODOCUMENTO AS tipodoc, 
      v.NUMERODOCUMENTO AS numerodoc, 
      v.NUMEROPERSONAFJ AS numeropersona, 
      CASE w.CATEGORIA
         WHEN 'A' THEN 'TITULAR'
         WHEN 'B' THEN 'TITULAR'
         ELSE 'AUTORIZADO'
      END AS titularidad, 
      v.TIPOPERSONA, 
      ISNULL(u.PRIMERNOMBRE, '') + ' ' + ISNULL(u.APELLIDOPATERNO, '') + ' ' + ISNULL(u.APELLIDOMATERNO, '') AS NOMBRE, 
      w.TIPO_PODER, 
      x.ESTADO, 
      y.DEPENDENCIA
   FROM 
      dbo.CLI_PERSONASFISICAS  AS u WITH (NOLOCK)
      INNER JOIN dbo.CLI_DOCUMENTOSPFPJ  AS v WITH (NOLOCK)ON u.NUMEROPERSONAFISICA = v.NUMEROPERSONAFJ
      INNER JOIN dbo.PYF_APODERADOS  AS w WITH (NOLOCK) ON w.ID_PERSONA = u.NUMEROPERSONAFISICA  
      INNER JOIN dbo.COF_COFRES_CONTRATOS  AS x WITH (NOLOCK) ON w.ID_ENTIDAD = x.JTS_OID_DEBITO 
      INNER JOIN dbo.COF_COFRES  AS y WITH (NOLOCK) ON x.[CODIGO_COFRE] = y.[CODIGO] 
   WHERE 
    w.TIPO_PODER IN (10,11) AND 
	u.TZ_LOCK = 0 AND 
	v.TZ_LOCK = 0 AND 
	w.TZ_LOCK = 0 AND 
	x.TZ_LOCK = 0 AND 
	y.TZ_LOCK = 0
  UNION ALL
   SELECT 
      --SUBSTRING(CAST(w.NROCUENTA AS VARCHAR),2,LEN(w.NROCUENTA)-1) AS numero_contrato, 
      x.[CODIGO],
      v.TIPODOCUMENTO AS tipodoc, 
      v.NUMERODOCUMENTO AS numerodoc, 
      v.NUMEROPERSONAFJ AS numeropersona, 
      CASE w.CATEGORIA
         WHEN 'A' THEN 'TITULAR'
         WHEN 'B' THEN 'TITULAR'
         ELSE 'AUTORIZADO'
      END AS titularidad, 
      v.TIPOPERSONA, 
      s.RAZONSOCIAL AS NOMBRE, 
      w.TIPO_PODER, 
      x.ESTADO, 
      y.DEPENDENCIA
   FROM 
      dbo.CLI_PERSONASJURIDICAS  AS s WITH (NOLOCK) 
      INNER JOIN dbo.CLI_DOCUMENTOSPFPJ  AS v WITH (NOLOCK) ON s.NUMEROPERSONAJURIDICA = v.NUMEROPERSONAFJ 
      INNER JOIN dbo.PYF_APODERADOS  AS w WITH (NOLOCK)ON  w.ID_PERSONA = s.NUMEROPERSONAJURIDICA
      INNER JOIN dbo.COF_COFRES_CONTRATOS  AS x WITH (NOLOCK) ON w.ID_ENTIDAD = x.JTS_OID_DEBITO
      INNER JOIN dbo.COF_COFRES  AS y WITH (NOLOCK) ON x.[CODIGO_COFRE] = y.[CODIGO]
   WHERE 
      w.TIPO_PODER IN (10,11) 
	  AND s.TZ_LOCK = 0 
	  AND v.TZ_LOCK = 0 
	  AND w.TZ_LOCK = 0 
	  AND x.TZ_LOCK = 0 
	  AND y.TZ_LOCK = 0
GO


