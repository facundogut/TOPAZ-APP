Execute('CREATE  OR ALTER  PROCEDURE [dbo].[SP_ITF_BCRA_MULTAS]  
											   @P_COD_ENTIDAD VARCHAR(5),
											   @P_SUCURSAL VARCHAR(3),
											   @P_CTA_CORRIENTE VARCHAR(11),
											   @P_FCH_ARCHIVO VARCHAR(8),
											   @P_NRO_CHEQUE VARCHAR(8),
											   @P_MONTO_CHEQUE VARCHAR(15),
											   @P_FCH_PAGO_CHEQUE VARCHAR(8),
											   @P_FCH_PAGO_MULTA VARCHAR(8),
											   @P_PORCENTAJE VARCHAR(5),
											   @P_MONTO_MULTA VARCHAR(11),
											   @P_FCH_INF_MULTA VARCHAR(8),
											   @P_DIAS_ATRASO VARCHAR(5),
											   @P_TASA_APLICADA VARCHAR(11),
											   @P_INTERESES VARCHAR(11),
											   @P_ID_TICKET INT
AS 
   DECLARE @V_COD_ENTIDAD NUMERIC(5,0);
   DECLARE @V_SUCURSAL NUMERIC(3,0);
   DECLARE @V_CTA_CORRIENTE NUMERIC(11,0);
   DECLARE @V_NRO_CHEQUE NUMERIC(8,0);
   DECLARE @V_MONTO decimal(15,2);
   DECLARE @V_FCH_PAGO_CHEQUE DATE;
   DECLARE @V_FCH_PAGO_MULTA DATE;
   DECLARE @V_PORCENTAJE decimal(3,2);
   DECLARE @V_MONTO_MULTA decimal(15,2);
   DECLARE @V_FCH_INF_MULTA DATE;
   DECLARE @V_DIAS_ATRASO NUMERIC(5,0);
   DECLARE @V_TASA_APLICADA decimal(7,4);
   DECLARE @V_INTERESES decimal(15,2);
   DECLARE @V_ID_TICKET NUMERIC(16,0);
   
   DECLARE @V_TIPO VARCHAR(1);
   DECLARE @V_ESTADO VARCHAR(1);
   
   DECLARE @cant NUMERIC(5,0) = 0;
   DECLARE @cant_sucursal NUMERIC(5,0) = 0;
   DECLARE @cant_saldos NUMERIC(5,0) = 0;
   DECLARE @cant_cheques NUMERIC(5,0) = 0;
   DECLARE @error_log VARCHAR(60);
   DECLARE @importe NUMERIC(15,2);
   DECLARE @cant_historial NUMERIC(5,0) = 0;
   
   BEGIN
   
   	SET @V_COD_ENTIDAD = CAST(@P_COD_ENTIDAD AS NUMERIC(5,0));
   	SET @V_SUCURSAL = CAST(@P_SUCURSAL AS NUMERIC(3,0));
   	SET @V_CTA_CORRIENTE = CAST(@P_CTA_CORRIENTE AS NUMERIC(11,0));
   	SET @V_NRO_CHEQUE = CAST(@P_NRO_CHEQUE AS NUMERIC(8,0));
   	SET @V_MONTO = CAST(@P_MONTO_CHEQUE AS NUMERIC(15,0))/100;   	   	     -- 2 decimales
   	SET @V_FCH_PAGO_CHEQUE = CAST(@P_FCH_PAGO_CHEQUE AS DATE);   	
   	SET @V_FCH_PAGO_MULTA = CAST(@P_FCH_PAGO_MULTA AS DATE);
   	SET @V_PORCENTAJE = CAST(@P_PORCENTAJE AS NUMERIC(5,0))/100;     -- 2 decimales 	
   	SET @V_MONTO_MULTA = CAST(@P_MONTO_MULTA AS NUMERIC(11,0))/100;  -- 2 decimales
   	SET @V_FCH_INF_MULTA = CAST(@P_FCH_INF_MULTA AS DATE);
   	SET @V_DIAS_ATRASO = CAST(@P_DIAS_ATRASO AS NUMERIC(5,0));
   	SET @V_TASA_APLICADA = CAST(@P_TASA_APLICADA AS NUMERIC(11,0))/10000; -- 4 decimales
   	SET @V_INTERESES = CAST(@P_INTERESES AS NUMERIC(11,0))/100;  -- 2 decimales
   	SET @V_ID_TICKET = CAST(@P_ID_TICKET AS NUMERIC(16,0));
   	
   	SET @cant_sucursal = (	SELECT count(*) 
							FROM SUCURSALES WITH (NOLOCK) 
							WHERE SUCURSAL = @V_SUCURSAL 
								AND TZ_LOCK=0);
   	
   	IF @cant_sucursal = 0  -- Si la sucursal del TXT no existe grabo la tabla ITF_BCRA_MULTAS_HISTORIAL
   		BEGIN
   			SET @error_log = ''Nro de Sucursal no existe'';
   			SET @V_TIPO = ''M'';
   			SET @V_ESTADO = ''E'';
   			
   			SET @cant_historial = (	SELECT max(CORRELATIVO) 
									FROM ITF_BCRA_MULTAS_HISTORIAL WITH (NOLOCK)
									WHERE NRO_CHEQUE=@V_NRO_CHEQUE 
										AND NRO_CTA_CORRIENTE=@V_CTA_CORRIENTE);
   			
   			IF @cant_historial IS NULL
   				SET @cant_historial = 0;
   				
   			SET @cant_historial = @cant_historial + 1;
   				
   			INSERT INTO dbo.ITF_BCRA_MULTAS_HISTORIAL (NRO_CHEQUE, COD_ENTIDAD, SUCURSAL, NRO_CTA_CORRIENTE, FCH_ARCHIVO, MONTO_CHEQUE, FCH_PAGO_CHEQUE, FCH_PAGO_MULTA, PORC_APLICADO, MONTO_MULTA, FCH_INF_PAGO_MULTA, DIAS_ATRASO, TASA_APLICADA, INTERESES, TZ_LOCK, CORRELATIVO, TIPO, ESTADO, OBSERVACIONES, ID_TICKET)
			VALUES (@V_NRO_CHEQUE, @V_COD_ENTIDAD, @V_SUCURSAL, @V_CTA_CORRIENTE, @P_FCH_ARCHIVO, @V_MONTO, @V_FCH_PAGO_CHEQUE, @V_FCH_PAGO_MULTA, @V_PORCENTAJE, @V_MONTO_MULTA, @V_FCH_INF_MULTA, @V_DIAS_ATRASO, @V_TASA_APLICADA, @V_INTERESES, 0, @cant_historial, @V_TIPO, @V_ESTADO, @error_log, @V_ID_TICKET);
   		END   	
   	
	SET @cant_saldos = (SELECT count(*) 
						FROM SALDOS  WITH (NOLOCK)
						WHERE C1785=2 
							AND tz_lock=0 
							AND CUENTA=@V_CTA_CORRIENTE);
	
	IF @cant_saldos = 0
		BEGIN
			SET @error_log = ''Nro Cta corriente no existe en SALDOS'';
			SET @V_TIPO = ''M'';
			SET @V_ESTADO = ''E'';
		
			SET @cant_historial = (	SELECT max(CORRELATIVO) 
									FROM ITF_BCRA_MULTAS_HISTORIAL  WITH (NOLOCK)
									WHERE NRO_CHEQUE=@V_NRO_CHEQUE 
										AND NRO_CTA_CORRIENTE=@V_CTA_CORRIENTE);
		
			IF @cant_historial IS NULL
				SET @cant_historial = 0;
		
			SET @cant_historial = @cant_historial + 1;
	
			INSERT INTO dbo.ITF_BCRA_MULTAS_HISTORIAL (NRO_CHEQUE, COD_ENTIDAD, SUCURSAL, NRO_CTA_CORRIENTE, FCH_ARCHIVO, MONTO_CHEQUE, FCH_PAGO_CHEQUE, FCH_PAGO_MULTA, PORC_APLICADO, MONTO_MULTA, FCH_INF_PAGO_MULTA, DIAS_ATRASO, TASA_APLICADA, INTERESES, TZ_LOCK, CORRELATIVO, TIPO, ESTADO, OBSERVACIONES, ID_TICKET)
			VALUES (@V_NRO_CHEQUE, @V_COD_ENTIDAD, @V_SUCURSAL, @V_CTA_CORRIENTE, @P_FCH_ARCHIVO, @V_MONTO, @V_FCH_PAGO_CHEQUE, @V_FCH_PAGO_MULTA, @V_PORCENTAJE, @V_MONTO_MULTA, @V_FCH_INF_MULTA, @V_DIAS_ATRASO, @V_TASA_APLICADA, @V_INTERESES, 0, @cant_historial, @V_TIPO, @V_ESTADO, @error_log, @V_ID_TICKET);
	
		END   			   		   		
   		
   	SET @cant_cheques = (	SELECT count(*) 
							FROM CHE_CHEQUES  WITH (NOLOCK)
							WHERE CUENTA=@V_CTA_CORRIENTE 
								AND NUMEROCHEQUE=@V_NRO_CHEQUE  
								and TZ_LOCK=0);
   	
   	IF @cant_cheques = 0
   		BEGIN
   			SET @error_log = ''Nro Cheque no existe en CHE_CHEQUES'';
   			SET @V_TIPO = ''M'';
   			SET @V_ESTADO = ''E'';
   			
   			SET @cant_historial = (	SELECT max(CORRELATIVO) 
									FROM ITF_BCRA_MULTAS_HISTORIAL  WITH (NOLOCK)
									WHERE NRO_CHEQUE=@V_NRO_CHEQUE 
										AND NRO_CTA_CORRIENTE=@V_CTA_CORRIENTE);
   			
   			IF @cant_historial IS NULL
   				SET @cant_historial = 0;
   			
   			SET @cant_historial = @cant_historial + 1;
   			
   			INSERT INTO dbo.ITF_BCRA_MULTAS_HISTORIAL (NRO_CHEQUE, COD_ENTIDAD, SUCURSAL, NRO_CTA_CORRIENTE, FCH_ARCHIVO, MONTO_CHEQUE, FCH_PAGO_CHEQUE, FCH_PAGO_MULTA, PORC_APLICADO, MONTO_MULTA, FCH_INF_PAGO_MULTA, DIAS_ATRASO, TASA_APLICADA, INTERESES, TZ_LOCK, CORRELATIVO, TIPO, ESTADO, OBSERVACIONES, ID_TICKET)
   			VALUES (@V_NRO_CHEQUE, @V_COD_ENTIDAD, @V_SUCURSAL, @V_CTA_CORRIENTE, @P_FCH_ARCHIVO, @V_MONTO, @V_FCH_PAGO_CHEQUE, @V_FCH_PAGO_MULTA, @V_PORCENTAJE, @V_MONTO_MULTA, @V_FCH_INF_MULTA, @V_DIAS_ATRASO, @V_TASA_APLICADA, @V_INTERESES, 0, @cant_historial, @V_TIPO, @V_ESTADO, @error_log, @V_ID_TICKET);
   		END  
   		
   		
 	SET @importe = (	SELECT IMPORTE
							FROM CHE_CHEQUES  WITH (NOLOCK)
							WHERE CUENTA=@V_CTA_CORRIENTE 
								AND NUMEROCHEQUE=@V_NRO_CHEQUE  
								and TZ_LOCK=0);
   	
   	IF NOT @importe = @V_MONTO
   		BEGIN
   			SET @error_log = ''Monto no corresponde al cheque'';
   			SET @V_TIPO = ''M'';
   			SET @V_ESTADO = ''E'';
   			
   			SET @cant_historial = (	SELECT max(CORRELATIVO) 
									FROM ITF_BCRA_MULTAS_HISTORIAL  WITH (NOLOCK)
									WHERE NRO_CHEQUE=@V_NRO_CHEQUE 
										AND NRO_CTA_CORRIENTE=@V_CTA_CORRIENTE);
   			
   			IF @cant_historial IS NULL
   				SET @cant_historial = 0;
   			
   			SET @cant_historial = @cant_historial + 1;
   			
   			INSERT INTO dbo.ITF_BCRA_MULTAS_HISTORIAL (NRO_CHEQUE, COD_ENTIDAD, SUCURSAL, NRO_CTA_CORRIENTE, FCH_ARCHIVO, MONTO_CHEQUE, FCH_PAGO_CHEQUE, FCH_PAGO_MULTA, PORC_APLICADO, MONTO_MULTA, FCH_INF_PAGO_MULTA, DIAS_ATRASO, TASA_APLICADA, INTERESES, TZ_LOCK, CORRELATIVO, TIPO, ESTADO, OBSERVACIONES, ID_TICKET)
   			VALUES (@V_NRO_CHEQUE, @V_COD_ENTIDAD, @V_SUCURSAL, @V_CTA_CORRIENTE, @P_FCH_ARCHIVO, @V_MONTO, @V_FCH_PAGO_CHEQUE, @V_FCH_PAGO_MULTA, @V_PORCENTAJE, @V_MONTO_MULTA, @V_FCH_INF_MULTA, @V_DIAS_ATRASO, @V_TASA_APLICADA, @V_INTERESES, 0, @cant_historial, @V_TIPO, @V_ESTADO, @error_log, @V_ID_TICKET);
   		END   		 		
   	
   	IF @cant_sucursal <> 0 AND @cant_saldos <> 0 AND @cant_cheques <> 0 AND @importe=@V_MONTO -- Si la SUCURSAL y el SALDO y el CHEQUE existe grabo la tabla ITF_BCRA_MULTAS
	   	BEGIN
	   		SET @cant = (	SELECT max(CORRELATIVO) 
							FROM ITF_BCRA_MULTAS  WITH (NOLOCK)
							WHERE NRO_CHEQUE=@V_NRO_CHEQUE 
								AND NRO_CTA_CORRIENTE=@V_CTA_CORRIENTE
								AND MONTO_CHEQUE=@V_MONTO);
	   	
	   		IF @cant IS NULL 
	   			SET @cant = 0;
	   		
	   		SET @cant = @cant + 1;
	   	
	   		INSERT INTO dbo.ITF_BCRA_MULTAS (NRO_CHEQUE, COD_ENTIDAD, SUCURSAL, NRO_CTA_CORRIENTE, FCH_ARCHIVO, MONTO_CHEQUE, FCH_PAGO_CHEQUE, FCH_PAGO_MULTA, PORC_APLICADO, MONTO_MULTA, FCH_INF_PAGO_MULTA, DIAS_ATRASO, TASA_APLICADA, INTERESES, TZ_LOCK, CORRELATIVO)
			VALUES (@V_NRO_CHEQUE, @V_COD_ENTIDAD, @V_SUCURSAL, @V_CTA_CORRIENTE, @P_FCH_ARCHIVO, @V_MONTO, @V_FCH_PAGO_CHEQUE, @V_FCH_PAGO_MULTA, @V_PORCENTAJE, @V_MONTO_MULTA, @V_FCH_INF_MULTA, @V_DIAS_ATRASO, @V_TASA_APLICADA, @V_INTERESES, 0, @cant);			
			
			SET @error_log = '''';
   			SET @V_TIPO = ''M'';
   			SET @V_ESTADO = ''I'';
   			
   			SET @cant_historial = (	SELECT max(CORRELATIVO) 
									FROM ITF_BCRA_MULTAS_HISTORIAL  WITH (NOLOCK)
									WHERE NRO_CHEQUE=@V_NRO_CHEQUE 
										AND NRO_CTA_CORRIENTE=@V_CTA_CORRIENTE);
   			
   			IF @cant_historial IS NULL
   				SET @cant_historial = 0;
   			
   			SET @cant_historial = @cant_historial + 1;
   			
   			INSERT INTO dbo.ITF_BCRA_MULTAS_HISTORIAL (NRO_CHEQUE, COD_ENTIDAD, SUCURSAL, NRO_CTA_CORRIENTE, FCH_ARCHIVO, MONTO_CHEQUE, FCH_PAGO_CHEQUE, FCH_PAGO_MULTA, PORC_APLICADO, MONTO_MULTA, FCH_INF_PAGO_MULTA, DIAS_ATRASO, TASA_APLICADA, INTERESES, TZ_LOCK, CORRELATIVO, TIPO, ESTADO, OBSERVACIONES, ID_TICKET)
   			VALUES (@V_NRO_CHEQUE, @V_COD_ENTIDAD, @V_SUCURSAL, @V_CTA_CORRIENTE, @P_FCH_ARCHIVO, @V_MONTO, @V_FCH_PAGO_CHEQUE, @V_FCH_PAGO_MULTA, @V_PORCENTAJE, @V_MONTO_MULTA, @V_FCH_INF_MULTA, @V_DIAS_ATRASO, @V_TASA_APLICADA, @V_INTERESES, 0, @cant_historial, @V_TIPO, @V_ESTADO, @error_log, @V_ID_TICKET);
   		
		END
	
   END')
Execute('
INSERT INTO dbo.DESCRIPTORES (TITULO, IDENTIFICACION, TIPODEARCHIVO, DESCRIPCION, GRUPODELMAPA, NOMBREFISICO, TIPODEDBMS, LARGODELREGISTRO, INICIALIZACIONDELREGISTRO, BASE, SELECCION, ACEPTA_MOVS_DIFERIDO)
VALUES (930, 847, NULL,''ITF_BCRA_CUENTAS_INHABILITADAS'', 0, ''ITF_BCRA_CUENTAS_INHABILITADAS'', ''D'', NULL, NULL, ''Top/Clientes'', NULL, ''N'')

INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (41267, '' '', 0, ''CUIT'', ''CUIT '', 11, ''N'', 0, NULL, 0, 0, 0, 0, 0, 0, 0, 847, ''CUIT '', 0, NULL)


INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (41268, '' '', 0, ''CODIGO_CLIENTE'', ''CODIGO_CLIENTE'', 11, ''N'', 0, NULL, 0, 0, 0, 0, 0, 0, 0, 847, ''CODIGO_CLIENTE '', 0, NULL)


INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (41269, '' '', 0, ''FECHA_INHABILITADA'', ''FECHA_INHABILITADA'', 8, ''F'', 0, ''F'', 0, 0, 0, 0, 0, 0, 0, 847, ''FECHA_INHABILITADA'', 0, NULL)


INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (41270, '' '', 0, ''FECHA_LEVANTAMIENTO'', ''FECHA_LEVANTAMIENTO'', 8, ''F'', 0, ''F'', 0, 0, 0, 0, 0, 0, 0, 847, ''FECHA_LEVANTAMIENTO'', 0, NULL)


INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (41271, '' '', 0, ''SALDO_JTS'', ''SALDO_JTS'', 11, ''N'', 0, NULL, 0, 0, 0, 0, 0, 0, 0, 847, ''SALDO_JTS'', 0, NULL)


INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (41272, '' '', 0, ''ESTADO'', ''ESTADO'', 1, ''N'', 0, NULL, 0, 0, 0, 0, 0, 0, 0, 847, ''ESTADO'', 0, NULL)

INSERT INTO dbo.INDICES (NUMERODEARCHIVO, NUMERODEINDICE, DESCRIPCION, CLAVESREPETIDAS, CAMPO1, CAMPO2, CAMPO3, CAMPO4, CAMPO5, CAMPO6, CAMPO7, CAMPO8, CAMPO9, CAMPO10, CAMPO11, CAMPO12, CAMPO13, CAMPO14, CAMPO15, CAMPO16, CAMPO17, CAMPO18, CAMPO19, CAMPO20)
VALUES (847, 1, ''INDICE PRIMARIO'', 0, 41267, 41271, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL)
')