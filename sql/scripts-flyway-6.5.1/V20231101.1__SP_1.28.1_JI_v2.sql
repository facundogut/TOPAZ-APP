execute('
ALTER    PROCEDURE [dbo].[SP_IB_CBU]
	@PROCESADOS INT OUTPUT,
	@CAMBIOS INT OUTPUT
AS 
BEGIN
------------ Limpieza de tabla auxiliar --------------------
TRUNCATE TABLE dbo.ITF_IB_CBU_AUX;
------------------------------------------------------------

--- Variables Cabecera Archivo (CA)

DECLARE @CA_CABECERA VARCHAR(218);

SET @CA_CABECERA = ''HRCBU0001.00000311                                                                                                                                                                                                         ''


		---------------- Grabar Cabecera Archivo ---------------------------
		INSERT INTO dbo.ITF_IB_CBU_AUX (LINEA) 
		VALUES (@CA_CABECERA);
		--------------------------------------------------------------------


------ Variables registro individual ( RI) ------------

DECLARE @FECHAPROCESO DATETIME = (SELECT TOP 1 FECHAPROCESO 
								  FROM PARAMETROS (nolock));

	  





CREATE TABLE #TmpI_ib_cbu	(
    RN 			 NUMERIC(10),
	JTS_OID      NUMERIC (10) DEFAULT ((0)) NOT NULL,
	CBU          VARCHAR (22) DEFAULT ('''') NOT NULL,
	ACCION       VARCHAR (1) DEFAULT (''''),
	MODIFICACION VARCHAR (1) DEFAULT (''''),	
	TIPO_CUENTA  VARCHAR (2) DEFAULT (''''),
	CUENTA_PBF   VARCHAR (19) DEFAULT (''''),
	CUENTA       VARCHAR (10) DEFAULT (''''),
	ESTADO       VARCHAR (1) DEFAULT (''''),
	TIPO_PERSONA VARCHAR (1) DEFAULT (''''),
	CUIT1        VARCHAR (11) DEFAULT (''''),
	NOMBRE1      VARCHAR (40) DEFAULT (''''),
	CUIT2        VARCHAR (11) DEFAULT (''''),
	NOMBRE2      VARCHAR (40) DEFAULT (''''),
	CUIT3        VARCHAR (11) DEFAULT (''''),
	NOMBRE3      VARCHAR (40) DEFAULT (''''),
	)


--- Variables fin de Archivo FA
DECLARE @FA_ID_REG VARCHAR(5) = ''TRCBU''; -- fijo  
DECLARE @FA_CANT_REG VARCHAR(9);
DECLARE @FA_FILTER VARCHAR(104) = replicate('' '', 104); -- fijo

DECLARE @FA_FIN_ARCHIVO VARCHAR (218);


CREATE TABLE #ClientesTmp2 (
	ID INT IDENTITY,
    CTA_CBU varchar(22),
    JTS_OID_SALDO NUMERIC(10,0)
)
-- Código de la sección

INSERT INTO #ClientesTmp2 (cta_cbu,jts_oid_saldo) 
SELECT  DISTINCT CTA_CBU, JTS_OID_SALDO
FROM VTA_SALDOS (nolock)
WHERE JTS_OID_SALDO IN (
						SELECT s.JTS_OID 
						FROM SALDOS s WITH (nolock) INNER JOIN PRODUCTOS p WITH (nolock) ON p.C6250=s.PRODUCTO
						WHERE s.C1785 IN (2,3) )
AND cta_cbu<>''''




INSERT INTO dbo.#TmpI_ib_cbu (JTS_OID, 
							  CBU, 
							  ACCION, 
							  MODIFICACION,
							  CUENTA_PBF,
							  CUENTA,
							  TIPO_PERSONA,  
							  TIPO_CUENTA,						  
							  ESTADO, 						   
							  CUIT1, 
							  NOMBRE1, 
							  CUIT2, 
							  NOMBRE2, 
							  CUIT3, 
							  NOMBRE3,
							  RN)



	--Obtencion de datos a grabar
	SELECT
			TMP2.JTS_OID_SALDO AS JTS_OID, 	--1
			TMP2.CTA_CBU AS CBU, 			--2
			(CASE 
				WHEN(1=(SELECT  TOP 1 REPROCESO 
   		        		FROM ITF_IB_CBU (nolock) 
   	        			WHERE JTS_OID=TMP2.JTS_OID_SALDO))
   				THEN  	 
   	 				(SELECT  TOP 1 ACCION  
   	 	 			 FROM ITF_IB_CBU (nolock) 
   	 	 			 WHERE JTS_OID=TMP2.JTS_OID_SALDO)
				WHEN 0 < (
						SELECT COUNT(1) 
						FROM ITF_IB_CBU (nolock) 
						WHERE JTS_OID = TMP2.JTS_OID_SALDO 
						AND CUIT1 = LEFT(CONCAT(d.NUMERODOCUMENTO, REPLICATE('' '',11)),11) 
						AND ESTADO = (
										CASE 
										WHEN 0 < (
												SELECT COUNT(1) 
												FROM ITF_MASTER_PARAMETROS (nolock) 
												WHERE CODIGO_INTERFACE = 1281 
												AND NUMERICO_1 = s.PRODUCTO
												) OR 0 < (
														SELECT COUNT(1) 
														FROM GRL_BLOQUEOS (nolock) 
														WHERE SALDO_JTS_OID = s.JTS_OID 
														AND TZ_LOCK = 0 
														AND COD_BLOQUEO IN (
																			SELECT COD_BLOQUEO 
																			FROM GRL_COD_BLOQUEOS (nolock) 
																			WHERE ACCIONES_CREDITO = 3 
																			AND TZ_LOCK = 0
																			)
													) 
										THEN ''1''
										ELSE ''0''
										END
										) 
						AND CUENTA = RIGHT(CONCAT(REPLICATE(''0'',10), CUENTA), 10) 
						AND CUENTA_PBF = RIGHT(CONCAT(REPLICATE('' '',19), (SELECT  TOP 1 CUENTA_PBF 
																		  FROM TJD_REL_TARJETA_CUENTA (nolock) 
																		  WHERE SALDO_JTS_OID = s.JTS_OID)), 19) 
						AND CBU = RIGHT(CONCAT(REPLICATE(''0'',22), TMP2.CTA_CBU), 22) 
						AND TIPO_CUENTA = (
											CASE
												WHEN s.C1785 = 2 AND s.MONEDA = (SELECT TOP 1 C6399 FROM MONEDAS (nolock) WHERE C6403 = ''N'') THEN ''01'' 
												WHEN s.C1785 = 2 AND s.MONEDA = (SELECT TOP 1 C6399 FROM MONEDAS (nolock) WHERE C6403 = ''D'') THEN ''07'' 
												WHEN s.C1785 = 3 AND s.MONEDA = (SELECT TOP 1 C6399 FROM MONEDAS (nolock) WHERE C6403 = ''N'') AND (s.PRODUCTO = 9 OR s.PRODUCTO = 10) THEN ''20''
												WHEN s.C1785 = 3 AND s.MONEDA = (SELECT TOP 1 C6399 FROM MONEDAS (nolock) WHERE C6403 = ''N'') AND (s.PRODUCTO <> 9 AND s.PRODUCTO <> 10) THEN ''11''
												WHEN s.C1785 = 3 AND s.MONEDA = (SELECT TOP 1 C6399 FROM MONEDAS (nolock) WHERE C6403 = ''D'') AND (s.PRODUCTO <> 9 AND s.PRODUCTO <> 10) THEN ''15''
												WHEN s.C1785 = 3 AND s.MONEDA = (SELECT TOP 1 C6399 FROM MONEDAS (nolock) WHERE C6403 = ''D'') AND (s.PRODUCTO = 9 OR s.PRODUCTO = 10) THEN ''21''
												ELSE ''00''
											END
											) 
						AND CUIT2 = (
									SELECT TOP 1 LEFT(CONCAT(j.NUMERODOCUMENTO, REPLICATE('' '',11)), 11)  
									FROM CLI_ClientePersona p (nolock) 
									INNER JOIN CLI_DocumentosPFPJ j (nolock) ON p.NUMEROPERSONA = j.NUMEROPERSONAFJ 
									WHERE p.CODIGOCLIENTE = c.CODIGOCLIENTE
									AND p.TITULARIDAD = ''C'' 
									AND p.TZ_LOCK = 0 
									AND j.TZ_LOCK = 0 
									ORDER BY FECHAALTARELACION
									)
							) 
				THEN ''M''	
	
   				WHEN 0< (SELECT COUNT(1) 
   		  				 FROM SALDOS (nolock) 
   		         		 WHERE JTS_OID=TMP2.JTS_OID_SALDO 
   		  				 AND (C1620 = (SELECT FECHAPROCESO FROM PARAMETROS) OR C1817=(SELECT FECHAPROCESO FROM PARAMETROS)) 
   		  				 AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) 
   		  				 AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)))
   			    THEN ''A''

   				WHEN (0< (SELECT COUNT(1) 
   						  FROM CV_CANCELACION_CUENTAS (nolock) 
   		  				  WHERE SALDO_JTS_OID=TMP2.JTS_OID_SALDO 
   		  			  	  AND FECHA_CANCELACION=@FECHAPROCESO 
   		  				  AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) 
   		  				  AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000))) 
   		  				  AND 0= (SELECT COUNT(1) 
   		  						  FROM SALDOS (nolock) 
   		  						  WHERE JTS_OID=TMP2.JTS_OID_SALDO 
   		  						  AND (C1620 = (SELECT TOP 1 FECHAPROCESO FROM PARAMETROS) OR C1817=(SELECT TOP 1 FECHAPROCESO FROM PARAMETROS)) 
   		  						  AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) 
   		  						  AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000))))	
				THEN ''B''
	
	
				ELSE ''''
			END) AS ACCION, 																								--3

	(CASE 

   		WHEN (0< (SELECT COUNT(1) FROM CV_CANCELACION_CUENTAS (nolock) 
   		  		  WHERE SALDO_JTS_OID=TMP2.JTS_OID_SALDO 
   		  		  AND FECHA_CANCELACION=@FECHAPROCESO 
   		  		  AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) 
   		  		  AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000))) 
   		  		  AND 0= (SELECT COUNT(1) 
   		  				  FROM SALDOS (nolock) 
   		  				  WHERE JTS_OID=TMP2.JTS_OID_SALDO 
   		  				  AND (C1620 = (SELECT TOP 1 FECHAPROCESO FROM PARAMETROS) OR C1817=(SELECT TOP 1 FECHAPROCESO FROM PARAMETROS)) 
   		  				  AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) 
   		  				  AND (TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000))))	
	    THEN ''S''
	    WHEN (TMP2.JTS_OID_SALDO NOT IN (SELECT JTS_OID
   		 								 FROM ITF_IB_CBU (nolock)) 
   		 								 )
   		THEN ''''
		ELSE ''S''

					 END) AS MODIFICACION, 
	RIGHT(CONCAT(REPLICATE('' '',19),(SELECT  TOP 1 CUENTA_PBF 
											   FROM TJD_REL_TARJETA_CUENTA (nolock) 
											   WHERE SALDO_JTS_OID=s.JTS_OID)),19) AS NRO_PBF,
	RIGHT(CONCAT(REPLICATE(''0'',10),CUENTA),10) AS NRO_CUENTA,
	(CASE 
						WHEN d.TIPOPERSONA=''J'' THEN ''J''
						ELSE ''F''
					 END) AS TIPO_PERSONA,
	(CASE
					WHEN s.C1785=2 AND s.MONEDA=(SELECT C6399 FROM MONEDAS (nolock) WHERE C6403=''N'') THEN ''01'' 
					WHEN s.C1785=2 AND s.MONEDA=(SELECT C6399 FROM MONEDAS (nolock) WHERE C6403=''D'') THEN ''07'' 
					WHEN s.C1785=3 AND s.MONEDA=(SELECT C6399 FROM MONEDAS (nolock) WHERE C6403=''N'') AND (s.PRODUCTO=9 OR s.PRODUCTO=10) THEN ''20''
					WHEN s.C1785=3 AND s.MONEDA=(SELECT C6399 FROM MONEDAS (nolock) WHERE C6403=''N'') AND (s.PRODUCTO<>9 AND s.PRODUCTO<>10) THEN ''11''
					WHEN s.C1785=3 AND s.MONEDA=(SELECT C6399 FROM MONEDAS (nolock) WHERE C6403=''D'') AND (s.PRODUCTO<>9 AND s.PRODUCTO<>10) THEN ''15''
					WHEN s.C1785=3 AND s.MONEDA=(SELECT C6399 FROM MONEDAS (nolock) WHERE C6403=''D'') AND (s.PRODUCTO=9 OR s.PRODUCTO=10)  THEN ''21''
				 	ELSE ''00''
				end) AS TIPO_CTA,
	(CASE
					WHEN 0<(SELECT COUNT(1) 
							FROM ITF_MASTER_PARAMETROS (nolock) 
							WHERE CODIGO_INTERFACE=1281 
							AND NUMERICO_1=s.PRODUCTO) OR 0<(SELECT COUNT(1) 
															 FROM GRL_BLOQUEOS (nolock) 
															 WHERE SALDO_JTS_OID=s.JTS_OID 
															 AND TZ_LOCK=0 
															 AND COD_BLOQUEO IN (SELECT COD_BLOQUEO 
															 					 FROM GRL_COD_BLOQUEOS (nolock) 
															 					 WHERE ACCIONES_CREDITO=3 
															 					 AND TZ_LOCK=0)) THEN ''1''
					ELSE ''0''
			   END) AS ESTADO,
	LEFT(CONCAT(d.NUMERODOCUMENTO,REPLICATE('' '',11)),11) AS CUIT1,
	LEFT(CONCAT((SELECT  TOP 1 NOMBRE 
						  FROM VW_PFPJ_DOCUMENTOS (nolock) 
						  WHERE NUMEROPERSONA=d.NUMEROPERSONAFJ 
						  AND ESTADO=''HABILITADO''),REPLICATE('' '',40)),40) AS NOMBRE1,
	
	(SELECT TOP 1 LEFT(CONCAT(j.NUMERODOCUMENTO,REPLICATE('' '',11)),11)  
	FROM CLI_ClientePersona p (nolock) INNER JOIN CLI_DocumentosPFPJ j (nolock) ON p.NUMEROPERSONA=j.NUMEROPERSONAFJ 
	WHERE p.CODIGOCLIENTE= c.CODIGOCLIENTE
	AND p.TITULARIDAD=''C'' 
	AND p.TZ_LOCK=0 
	AND j.TZ_LOCK=0 
	ORDER BY FECHAALTARELACION) AS CUIT2,
	(SELECT  TOP 1 LEFT(CONCAT(X.NOMBRE,REPLICATE('' '',40)),40) 
	 FROM VW_PFPJ_DOCUMENTOS X (nolock) 
	 WHERE X.NUMERODOC=(SELECT TOP 1 LEFT(CONCAT(j.NUMERODOCUMENTO,REPLICATE('' '',11)),11)  
					    FROM CLI_ClientePersona p (nolock) INNER JOIN CLI_DocumentosPFPJ j (nolock) ON p.NUMEROPERSONA=j.NUMEROPERSONAFJ 
				   	    WHERE p.CODIGOCLIENTE= c.CODIGOCLIENTE
					    AND p.TITULARIDAD=''C'' 
					    AND p.TZ_LOCK=0 
					    AND j.TZ_LOCK=0 
					    ORDER BY FECHAALTARELACION)) AS NOMBRE2,
	(SELECT  TOP 1 LEFT(CONCAT(NUMERODOCUMENTO,REPLICATE('' '',11)),11)
	 FROM(
		 SELECT j.NUMERODOCUMENTO, ROW_NUMBER() OVER (ORDER BY FECHAALTARELACION) AS row_num 
		 FROM CLI_ClientePersona p (nolock) INNER JOIN CLI_DocumentosPFPJ j (nolock) ON p.NUMEROPERSONA=j.NUMEROPERSONAFJ 
		 WHERE p.CODIGOCLIENTE=c.CODIGOCLIENTE 
		 AND p.TITULARIDAD=''C'' 
		 AND p.TZ_LOCK=0 
		 AND j.TZ_LOCK=0
		) AS p_with_rownum
	 WHERE row_num = 2) AS CUIT3,
	(SELECT LEFT(CONCAT(XX.NOMBRE,REPLICATE('' '',40)),40) 
	 FROM VW_PFPJ_DOCUMENTOS XX(nolock) 
	 WHERE XX.NUMERODOC=(SELECT  TOP 1 LEFT(CONCAT(NUMERODOCUMENTO,REPLICATE('' '',11)),11)
	 					 FROM(
		 					 SELECT j.NUMERODOCUMENTO, ROW_NUMBER() OVER (ORDER BY FECHAALTARELACION) AS row_num 
		 					 FROM CLI_ClientePersona p (nolock) INNER JOIN CLI_DocumentosPFPJ j (nolock) ON p.NUMEROPERSONA=j.NUMEROPERSONAFJ 
		 					 WHERE p.CODIGOCLIENTE=c.CODIGOCLIENTE 
		 					 AND p.TITULARIDAD=''C'' 
		 					 AND p.TZ_LOCK=0 
		 					 AND j.TZ_LOCK=0
							 ) AS p_with_rownum
	 					 WHERE row_num = 2)) AS NOMBRE3,
	ROW_NUMBER() OVER (PARTITION BY TMP2.cta_CBU, TMP2.JTS_OID_saldo ORDER BY (SELECT NULL))
	
	FROM SALDOS s (nolock) INNER JOIN CLI_ClientePersona  c (nolock) ON s.C1803=c.CODIGOCLIENTE AND c.TITULARIDAD=''T'' 
	INNER JOIN CLI_DocumentosPFPJ d  (nolock) ON c.NUMEROPERSONA=d.NUMEROPERSONAFJ 
	INNER JOIN #ClientesTmp2 TMP2 ON s.JTS_OID=TMP2.JTS_OID_SALDO
	AND ((c.TZ_LOCK < 300000000000000 OR c.TZ_LOCK >= 400000000000000) 
	AND (c.TZ_LOCK < 100000000000000 OR c.TZ_LOCK >= 200000000000000))
	AND s.TZ_LOCK=0 
	AND ((d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000)     
	AND (d.TZ_LOCK < 100000000000000 OR d.TZ_LOCK >= 200000000000000))
	


INSERT INTO ITF_IB_CBU_AUX (LINEA)
SELECT CONCAT(T.ACCION,T.CBU,T.TIPO_CUENTA,T.CUENTA_PBF,T.CUENTA,T.ESTADO,T.TIPO_PERSONA,T.CUIT1,T.NOMBRE1,T.CUIT2,T.NOMBRE2,T.CUIT3,T.NOMBRE3)
FROM #TmpI_ib_cbu T
WHERE T.ACCION<>''''
   
   
   
UPDATE ITF_IB_CBU 
SET ACCION = TT.ACCION
		, TIPO_CUENTA = TT.TIPO_CUENTA
		, CUENTA_PBF = TT.CUENTA_PBF
		, CUENTA = TT.CUENTA
		, ESTADO = TT.ESTADO
		, TIPO_PERSONA = TT.TIPO_PERSONA
		, CUIT1 = TT.CUIT1
		, NOMBRE1 = TT.NOMBRE1
		, CUIT2 = TT.CUIT2
		, NOMBRE2 = TT.NOMBRE2
		, CUIT3 = TT.CUIT3
		, NOMBRE3 = TT.NOMBRE3
		, CBU = TT.CBU
FROM #TmpI_ib_cbu TT,ITF_IB_CBU IB
WHERE TT.JTS_OID=IB.JTS_OID
AND TT.MODIFICACION=''S''
AND TT.ACCION<>''''


	INSERT INTO dbo.ITF_IB_CBU (ACCION,CBU,JTS_OID,TIPO_CUENTA,CUENTA_PBF,CUENTA,ESTADO,TIPO_PERSONA,CUIT1,NOMBRE1,CUIT2,NOMBRE2,CUIT3,NOMBRE3,REPROCESO)
    SELECT I.ACCION,I.CBU,I.JTS_OID,I.TIPO_CUENTA,I.CUENTA_PBF,I.CUENTA,I.ESTADO,I.TIPO_PERSONA,I.CUIT1,I.NOMBRE1,I.CUIT2,I.NOMBRE2,I.CUIT3,I.NOMBRE3,0
	FROM #TmpI_ib_cbu I
	WHERE I.MODIFICACION=''''
	AND i.RN=1
	AND I.ACCION<>''''



	INSERT INTO dbo.ITF_IB_CBU_HIST (ACCION,CBU,JTS_OID,TIPO_CUENTA,CUENTA_PBF,CUENTA,ESTADO,TIPO_PERSONA,CUIT1,NOMBRE1,CUIT2,NOMBRE2,CUIT3,NOMBRE3,REPROCESO,FECHA_ALTA,HORA_ALTA)
	SELECT I.ACCION,I.CBU,I.JTS_OID,I.TIPO_CUENTA,I.CUENTA_PBF,I.CUENTA,I.ESTADO,I.TIPO_PERSONA,I.CUIT1,I.NOMBRE1,I.CUIT2,I.NOMBRE2,I.CUIT3,I.NOMBRE3,0,CAST(GETDATE() AS DATE),CONVERT(TIME, GETDATE())
	FROM #TmpI_ib_cbu I	  
	WHERE I.MODIFICACION=''''
	AND i.RN=1 
	AND I.ACCION<>''''			

SET @FA_CANT_REG = RIGHT(CONCAT(''00000000'',(SELECT COUNT(1) FROM ITF_IB_CBU_AUX (nolock))-1),9);

SET @FA_FIN_ARCHIVO = CONCAT(@FA_ID_REG,@FA_CANT_REG,@FA_FILTER);

INSERT INTO dbo.ITF_IB_CBU_AUX (LINEA) VALUES (@FA_FIN_ARCHIVO);

SELECT @PROCESADOS=count(*)
FROM #TmpI_ib_cbu 

SELECT @CAMBIOS=count(*)
FROM #TmpI_ib_cbu 
WHERE MODIFICACION=''S''	

DROP TABLE #TmpI_ib_cbu
DROP TABLE #ClientesTmp2;


END


');
