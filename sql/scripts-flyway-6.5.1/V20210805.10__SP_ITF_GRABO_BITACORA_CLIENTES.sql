/****** Object:  StoredProcedure [dbo].[SP_ITF_GRABO_BITACORA_CLIENTES]    Script Date: 31/05/2021 13:55:30 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_ITF_GRABO_BITACORA_CLIENTES]
	@P_COD_CLI NUMERIC(12,0),
	@P_ASIENTO NUMERIC(10,0)
AS

	BEGIN
		DECLARE @V_TZ_LOCK NUMERIC(15,0);
		DECLARE @V_CODIGOCLIENTE NUMERIC(12,0);
		DECLARE @V_NOMBRECLIENTE VARCHAR(70);		
		DECLARE	@V_COMPLEMENTONOMBRE VARCHAR(35);
		DECLARE @V_NOMBREREDUCIDO VARCHAR(35);
		DECLARE @V_SUCURSALVINCULADA NUMERIC(5,0);		
		DECLARE @V_SUBSEGMENTOCLIENTE NUMERIC(3,0);
		DECLARE @V_APERTURAMANUAL VARCHAR(1);
		DECLARE @V_USOFONDOS VARCHAR(1);
		DECLARE @V_GRUPOAFINIDAD NUMERIC(12,0);
		DECLARE @V_CATEGORIASUBJETIVA VARCHAR(3);		
		DECLARE @V_CATEGORIAOBJETIVA VARCHAR(3);
		DECLARE @V_CATEGORIAANTERIOR VARCHAR(3);
		DECLARE @V_CATEGORIARESULTANTE VARCHAR(3);
		DECLARE @V_FECHACAMBIOCATEGORIA DATETIME;		
		DECLARE @V_ENTIDADCALIFICADORA VARCHAR(3);
		DECLARE @V_COMENTARIOS VARCHAR(35);
		DECLARE @V_CODIGOBLOQUEO VARCHAR(1);
		DECLARE @V_FECHAAPERTURA DATETIME;
		DECLARE @V_FECHACIERRE DATETIME;		
		DECLARE @V_REVISIONGENERAL DATETIME;
		DECLARE @V_INTERMEDIACIONFINANCIERA VARCHAR(2);
		DECLARE @V_CODIGORESIDENCIA VARCHAR(1);
		DECLARE @V_SUBDIVISION1 VARCHAR(2);
		DECLARE @V_SUBDIVISION2 VARCHAR(2);
		DECLARE @V_SUBDIVISION3 VARCHAR(2);		
		DECLARE @V_PERFILRIESGO VARCHAR(1);
		DECLARE @V_ESTADO NUMERIC(1,0);
		DECLARE @V_CODIGOPAQUETE VARCHAR(5);
		DECLARE @V_TIPO VARCHAR(1);
		DECLARE @V_CATEG_TASAS NUMERIC(1,0);		
		DECLARE @V_LEVANTASECRETOBANCARIO VARCHAR(1);
		DECLARE @V_CODDIRECCIONENVIO VARCHAR(1);
		DECLARE @V_TIPOAPERTURA VARCHAR(1);
		DECLARE @V_CODACTIVIDADBANCOCENTRAL NUMERIC(5,0);
		DECLARE @V_SEGMENTOCLIENTE NUMERIC(3,0);		
		DECLARE @V_CHEQUEOINFORMACION NUMERIC(3,0);
		DECLARE @V_FORMALLEGADA NUMERIC(3,0);
		DECLARE @V_REFERENCIASOBSERVACIONES VARCHAR(60);
		DECLARE @V_MOTIVOCIERRE VARCHAR(60);
		DECLARE @V_FECHA_IDENTIFICACION DATETIME;
		DECLARE @V_FECHA_GESTION DATETIME;		
		DECLARE @V_FECHA_RIESGOS DATETIME;
		DECLARE @V_ORIGENFONDOS VARCHAR(1);
		DECLARE @V_GRUPOECONOFICIAL NUMERIC(5,0);
		DECLARE @V_EJECUTIVORIESGO VARCHAR(4);
		DECLARE @V_CLASIFCONTABLE VARCHAR(1);
		DECLARE @V_GRUPOECONOMICO NUMERIC(5,0);
		DECLARE @V_EJECUTIVOCLIENTE VARCHAR(4);
		DECLARE @V_EJECUTIVOGESTION VARCHAR(4);
		DECLARE @V_NIVEL_APERTURA NUMERIC(1,0);
		DECLARE @V_CALIFICACION_EXTERNA VARCHAR(4);
		DECLARE @V_CODIGOSWIFT VARCHAR(15);
		DECLARE @V_TIPO_DEUDOR NUMERIC(1,0);
		DECLARE @V_ASUME_DIR_TITULAR VARCHAR(1);
		DECLARE @V_RECUPERO NUMERIC(1,0);
		DECLARE @V_CATEGORIA_OFICIAL VARCHAR(3);
		DECLARE @V_DEUDOR_IMPORTES_MENORES VARCHAR(3);
		DECLARE @V_REESTRUCTURA VARCHAR(3);
		DECLARE @V_ATRASO_INFORMACION VARCHAR(3);
		DECLARE @V_ADMINISTRA_FONDOS VARCHAR(1);
		DECLARE @V_REVISION CHAR(1);
		DECLARE @V_VINCULACION NUMERIC(1,0);
		DECLARE @V_FECHA_ASIGNACION DATETIME;
		DECLARE @V_TIPO_GESTOR VARCHAR(1);
		DECLARE @V_ESTADO_GESTION VARCHAR(2);
		DECLARE @V_NIVEL_RIESGO VARCHAR(1);
		DECLARE @V_EJECUTIVO_INVERSION VARCHAR(4);
		DECLARE @V_EXCEPCIONA_REPORTESTT NUMERIC(1,0);
		DECLARE @V_CALIDADCLIENTE NUMERIC(3,0);
		DECLARE @V_UNIDAD_NEGOCIO NUMERIC(5,0);
		DECLARE @V_SEGMENTOCLIENTE_FINAN NUMERIC(5,0);
		DECLARE @V_USF VARCHAR(1);
		DECLARE @V_CATEGORIA_COMERCIAL VARCHAR(1);
		DECLARE @V_IVA VARCHAR(2);
		DECLARE @V_IGA VARCHAR(2);
		DECLARE @V_MONOTRIBUTO VARCHAR(2);
		DECLARE @V_SIRCREB VARCHAR(2);
		DECLARE @V_IVA_CONVENIOS VARCHAR(1);
		DECLARE @V_MOTIVO_VINC NUMERIC(1,0);
		DECLARE @V_IIBB_CHACO_RET VARCHAR(2);
		DECLARE @V_IIBB_CABA_PERC VARCHAR(2);
		DECLARE @V_IIBB_CORRIENTES_RECAUD VARCHAR(2);
		DECLARE @V_IIBB_CABA_ALI NUMERIC(11,7);
		DECLARE @V_IIBB_CORRIENTES_ALI NUMERIC(11,7);
		
		DECLARE @V_FECHAPROCESO DATETIME;
		DECLARE @V_SUCURSAL NUMERIC(1,0) = 1;
		DECLARE @V_ORDINAL NUMERIC(6,0);
		DECLARE @V_HORA VARCHAR(8);
		
		SELECT @V_FECHAPROCESO= FECHAPROCESO FROM PARAMETROS WITH (NOLOCK);
		IF @V_FECHAPROCESO IS NULL SET @V_FECHAPROCESO = getdate();
		
		SET @V_HORA = (select convert(varchar(8), getdate(), 108));				
		
		SET @V_ORDINAL = (SELECT TOP 1 ORDINAL 
							FROM BITACORA_CLIENTES WITH (NOLOCK) 
							WHERE FECHA=@V_FECHAPROCESO 
								AND SUCURSAL=@V_SUCURSAL
								AND ASIENTO = @P_ASIENTO 
							ORDER BY ORDINAL DESC);
		
		IF @V_ORDINAL IS NULL OR @V_ORDINAL = 0  SET @V_ORDINAL = 1;
		ELSE SET @V_ORDINAL = @V_ORDINAL + 1;								
		
		SELECT @V_TZ_LOCK = TZ_LOCK, @V_CODIGOCLIENTE = CODIGOCLIENTE, @V_NOMBRECLIENTE = NOMBRECLIENTE , 
			@V_COMPLEMENTONOMBRE = COMPLEMENTONOMBRE, @V_NOMBREREDUCIDO = NOMBREREDUCIDO, @V_SUCURSALVINCULADA = SUCURSALVINCULADA, 
			@V_SUBSEGMENTOCLIENTE = SUBSEGMENTOCLIENTE, @V_APERTURAMANUAL = APERTURAMANUAL, @V_USOFONDOS = USOFONDOS, 
			@V_GRUPOAFINIDAD = GRUPOAFINIDAD, @V_CATEGORIASUBJETIVA = CATEGORIASUBJETIVA, @V_CATEGORIAOBJETIVA = CATEGORIAOBJETIVA, 
			@V_CATEGORIAANTERIOR = CATEGORIAANTERIOR, @V_CATEGORIARESULTANTE = CATEGORIARESULTANTE, 
			@V_FECHACAMBIOCATEGORIA = FECHACAMBIOCATEGORIA, @V_ENTIDADCALIFICADORA = ENTIDADCALIFICADORA, 
			@V_COMENTARIOS = COMENTARIOS, @V_CODIGOBLOQUEO = CODIGOBLOQUEO, @V_FECHAAPERTURA = FECHAAPERTURA, 
			@V_FECHACIERRE = FECHACIERRE, @V_REVISIONGENERAL = REVISIONGENERAL, @V_INTERMEDIACIONFINANCIERA = INTERMEDIACIONFINANCIERA, 
			@V_CODIGORESIDENCIA = CODIGORESIDENCIA, @V_SUBDIVISION1 = SUBDIVISION1, @V_SUBDIVISION2 = SUBDIVISION2, 
			@V_SUBDIVISION3 = SUBDIVISION3, @V_PERFILRIESGO = PERFILRIESGO, @V_ESTADO = ESTADO, @V_CODIGOPAQUETE = CODIGOPAQUETE, 
			@V_TIPO = TIPO, @V_CATEG_TASAS = CATEG_TASAS, @V_LEVANTASECRETOBANCARIO = LEVANTASECRETOBANCARIO, 
			@V_CODDIRECCIONENVIO = CODDIRECCIONENVIO, @V_TIPOAPERTURA = TIPOAPERTURA, @V_CODACTIVIDADBANCOCENTRAL = CODACTIVIDADBANCOCENTRAL, 
			@V_SEGMENTOCLIENTE = SEGMENTOCLIENTE, @V_CHEQUEOINFORMACION = CHEQUEOINFORMACION, @V_FORMALLEGADA = FORMALLEGADA, 
			@V_REFERENCIASOBSERVACIONES = REFERENCIASOBSERVACIONES, @V_MOTIVOCIERRE = MOTIVOCIERRE, 
			@V_FECHA_IDENTIFICACION = FECHA_IDENTIFICACION, @V_FECHA_GESTION = FECHA_GESTION, 
			@V_FECHA_RIESGOS = FECHA_RIESGOS, @V_ORIGENFONDOS = ORIGENFONDOS, @V_GRUPOECONOFICIAL = GRUPOECONOFICIAL, 
			@V_EJECUTIVORIESGO = EJECUTIVORIESGO, @V_CLASIFCONTABLE = CLASIFCONTABLE, @V_GRUPOECONOMICO = GRUPOECONOMICO, 
			@V_EJECUTIVOCLIENTE = EJECUTIVOCLIENTE, @V_EJECUTIVOGESTION = EJECUTIVOGESTION, @V_NIVEL_APERTURA = NIVEL_APERTURA, 
			@V_CALIFICACION_EXTERNA = CALIFICACION_EXTERNA, 
			@V_CODIGOSWIFT = CODIGOSWIFT, @V_TIPO_DEUDOR = TIPO_DEUDOR, @V_ASUME_DIR_TITULAR = ASUME_DIR_TITULAR, 
			@V_RECUPERO = RECUPERO, @V_CATEGORIA_OFICIAL = CATEGORIA_OFICIAL, @V_DEUDOR_IMPORTES_MENORES = DEUDOR_IMPORTES_MENORES, 
			@V_REESTRUCTURA = REESTRUCTURA, @V_ATRASO_INFORMACION = ATRASO_INFORMACION, @V_ADMINISTRA_FONDOS = ADMINISTRA_FONDOS, 
			@V_REVISION = REVISION, 
			@V_VINCULACION = VINCULACION, @V_FECHA_ASIGNACION = FECHA_ASIGNACION, @V_TIPO_GESTOR = TIPO_GESTOR, 
			@V_ESTADO_GESTION = ESTADO_GESTION, @V_NIVEL_RIESGO = NIVEL_RIESGO, @V_EJECUTIVO_INVERSION = EJECUTIVO_INVERSION, 
			@V_EXCEPCIONA_REPORTESTT = EXCEPCIONA_REPORTESTT, @V_CALIDADCLIENTE = CALIDADCLIENTE, 
			@V_UNIDAD_NEGOCIO = UNIDAD_NEGOCIO, @V_SEGMENTOCLIENTE_FINAN = SEGMENTOCLIENTE_FINAN, @V_USF = USF, 
			@V_CATEGORIA_COMERCIAL = CATEGORIA_COMERCIAL, @V_IVA = IVA, @V_IGA = IGA, @V_MONOTRIBUTO = MONOTRIBUTO,
			@V_SIRCREB = SIRCREB, @V_IVA_CONVENIOS = IVA_CONVENIOS, @V_MOTIVO_VINC = MOTIVO_VINC, 
			@V_IIBB_CHACO_RET = IIBB_CHACO_RET, @V_IIBB_CABA_PERC = IIBB_CABA_PERC, 
			@V_IIBB_CORRIENTES_RECAUD = IIBB_CORRIENTES_RECAUD, 
			@V_IIBB_CABA_ALI = IIBB_CABA_ALI, @V_IIBB_CORRIENTES_ALI = IIBB_CORRIENTES_ALI
		FROM CLI_CLIENTES with (nolock)
		WHERE CODIGOCLIENTE=@P_COD_CLI;
		
		INSERT INTO dbo.BITACORA_CLIENTES (FECHA, SUCURSAL, ASIENTO, ORDINAL, TIPO_TRAZA, OPERACION, USUARIO, HORA, 
			CODIGOCLIENTE, NOMBRECLIENTE, COMPLEMENTONOMBRE, NOMBREREDUCIDO, SUCURSALVINCULADA, 
			SUBSEGMENTOCLIENTE, APERTURAMANUAL, USOFONDOS, EJECUTIVOCLIENTE, EJECUTIVOGESTION, 
			GRUPOAFINIDAD, CLASIFCONTABLE, GRUPOECONOMICO, CATEGORIASUBJETIVA, CATEGORIAOBJETIVA, CATEGORIAANTERIOR, 
			CATEGORIARESULTANTE, FECHACAMBIOCATEGORIA, ENTIDADCALIFICADORA, COMENTARIOS, CODIGOBLOQUEO, FECHAAPERTURA, 
			FECHACIERRE, REVISIONGENERAL, INTERMEDIACIONFINANCIERA, CODIGORESIDENCIA, SUBDIVISION1, SUBDIVISION2, SUBDIVISION3, 
			CODACTIVIDACIIU, PERFILRIESGO, IDENT_NNRR, IGA, ESTADO, CODIGOPAQUETE, TIPO, CATEG_TASAS, LEVANTASECRETOBANCARIO, 
			CODDIRECCIONENVIO, TIPOAPERTURA, CODACTIVIDADBANCOCENTRAL, SEGMENTOCLIENTE, CHEQUEOINFORMACION, 
			REFERENCIASOBSERVACIONES, MOTIVOCIERRE, IVA, EJECUTIVO_INVERSION, FECHA_IDENTIFICACION, FECHA_GESTION, FECHA_RIESGOS, 
			ORIGENFONDOS, GRUPOECONOFICIAL, NIVEL_APERTURA, ASUME_DIR_TITULAR, CALIFICACION_EXTERNA, CODIGOSWIFT, 
			EJECUTIVORIESGO, TIPO_DEUDOR, CATEGORIA_OFICIAL, DEUDOR_IMPORTES_MENORES, REESTRUCTURA, ATRASO_INFORMACION, 
			UNIDAD_NEGOCIO, NIVEL_RIESGO, ADMINISTRA_FONDOS, EXCEPCIONA_REPORTESTT, RECUPERO, 
			CalidadCliente, VINCULACION, FECHA_ASIGNACION, TIPO_GESTOR, ESTADO_GESTION, USF, IVA_CONVENIOS, 
			IIBB_CHACO_RET, IIBB_CABA_PERC, IIBB_CORRIENTES_RECAUD, IIBB_CABA_ALI, IIBB_CORRIENTES_ALI, 
			MONOTRIBUTO, SIRCREB, TZ_LOCK)
		VALUES (@V_FECHAPROCESO, @V_SUCURSAL, @P_ASIENTO, @V_ORDINAL, 'M', 999, 'TOP', @V_HORA, 
			@P_COD_CLI, @V_NOMBRECLIENTE, @V_COMPLEMENTONOMBRE, @V_NOMBREREDUCIDO, @V_SUCURSALVINCULADA, 
			@V_SUBSEGMENTOCLIENTE, @V_APERTURAMANUAL, @V_USOFONDOS, @V_EJECUTIVOCLIENTE, @V_EJECUTIVOGESTION, 
			@V_GRUPOAFINIDAD,@V_CLASIFCONTABLE, @V_GRUPOECONOMICO, @V_CATEGORIASUBJETIVA, @V_CATEGORIAOBJETIVA, 
			@V_CATEGORIAANTERIOR,@V_CATEGORIARESULTANTE, @V_FECHACAMBIOCATEGORIA, @V_ENTIDADCALIFICADORA, @V_COMENTARIOS, 
			@V_CODIGOBLOQUEO, @V_FECHAAPERTURA, @V_FECHACIERRE, @V_REVISIONGENERAL, @V_INTERMEDIACIONFINANCIERA, 
			@V_CODIGORESIDENCIA, @V_SUBDIVISION1, @V_SUBDIVISION2, @V_SUBDIVISION3, 0, @V_PERFILRIESGO, 
			' ', @V_IGA, @V_ESTADO, @V_CODIGOPAQUETE, @V_TIPO, @V_CATEG_TASAS, @V_LEVANTASECRETOBANCARIO, @V_CODDIRECCIONENVIO, 
			@V_TIPOAPERTURA, @V_CODACTIVIDADBANCOCENTRAL, @V_SEGMENTOCLIENTE, @V_CHEQUEOINFORMACION, @V_REFERENCIASOBSERVACIONES, 
			@V_MOTIVOCIERRE, @V_IVA, @V_EJECUTIVO_INVERSION, @V_FECHA_IDENTIFICACION, @V_FECHA_GESTION, @V_FECHA_RIESGOS, 
			@V_ORIGENFONDOS, @V_GRUPOECONOFICIAL, @V_NIVEL_APERTURA, @V_ASUME_DIR_TITULAR, @V_CALIFICACION_EXTERNA, 
			@V_CODIGOSWIFT,@V_EJECUTIVORIESGO, @V_TIPO_DEUDOR, @V_CATEGORIA_OFICIAL, @V_DEUDOR_IMPORTES_MENORES, 
			@V_REESTRUCTURA, @V_ATRASO_INFORMACION, @V_UNIDAD_NEGOCIO, @V_NIVEL_RIESGO, @V_ADMINISTRA_FONDOS, 
			@V_EXCEPCIONA_REPORTESTT, @V_RECUPERO, @V_CALIDADCLIENTE, @V_VINCULACION, @V_FECHA_ASIGNACION, @V_TIPO_GESTOR, 
			@V_ESTADO_GESTION, @V_USF, @V_IVA_CONVENIOS, @V_IIBB_CHACO_RET, @V_IIBB_CABA_PERC, 
			@V_IIBB_CORRIENTES_RECAUD, 
			@V_IIBB_CABA_ALI, 
			@V_IIBB_CORRIENTES_ALI, 
			@V_MONOTRIBUTO, 
			@V_SIRCREB, 
			@V_TZ_LOCK);
	END