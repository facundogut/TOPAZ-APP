EXECUTE('
IF OBJECT_ID (''dbo.VW_HIS_MOV'') IS NOT NULL
	DROP VIEW dbo.VW_HIS_MOV
');
EXECUTE('
CREATE VIEW VW_HIS_MOV
(
SUCURSAL,
NROCUENTA,
MODULO,
CODIGO_MONEDA,
FECHA_MOVIMIENTO,
FECHA_VALOR,
FECHA_ALTA,
ACCION_MOVIMIENTO,
CONFORMADO_DIFERIDO,
IMPORTE,
NUMERO_COMPROBANTE,
SUCURSAL_ORIGEN_MOV,
IDENTIFICACION_DEPOSITANTE,
CONCEPTO,
CUIT_ORIGINANTE,
NUMERO_EXTRACTO,
FECHA_EXTRACTO,
ID_ASIENTO,
ASIENTO_EXTORNADO,
CODIGO_TRANSACCION
) AS
SELECT
    hv.SUCURSAL,
    CONVERT(NUMERIC(12), s.CUENTA) AS NROCUENTA,
    (CASE WHEN S.C1785 = 2 THEN ''CC'' WHEN S.C1785 = 3 THEN ''CA'' END) AS MODULO,
    CONVERT(NUMERIC(4), S.MONEDA) AS CODIGO_MONEDA,
    CONVERT(NUMERIC(8), CONVERT(VARCHAR, M.FECHAPROCESO, 112)) AS FECHA_MOVIMIENTO,
    CONVERT(NUMERIC(8), CONVERT(VARCHAR, M.FECHAVALOR, 112)) AS FECHA_VALOR,
    CONVERT(NUMERIC(8), CONVERT(VARCHAR, M.FECHACONTABLE, 112)) AS FECHA_ALTA,
    CONVERT(CHAR(1), M.DEBITOCREDITO) AS ACCION_MOVIMIENTO,
    (CASE WHEN asiento.ESTADO = 77 THEN ''C'' WHEN asiento.ESTADO = 68 THEN ''D'' END) AS CONFORMADO_DIFERIDO,
    hv.MONTO AS IMPORTE,
    hv.ASIENTO AS NUMERO_COMPROBANTE,
    m.SUCURSAL AS SUCURSAL_ORIGEN_MOV,
    CAST(CONCAT(VTA.Tipo_Doc_M, '': '', VTA.Nro_Doc_M, '' - '', VTA.NOMBRE_M, '' '', VTA.APELLIDO_M) AS CHAR(40)) AS IDENTIFICACION_DEPOSITANTE,
    hv.CONCEPTO AS CONCEPTO,
    VTA.NRO_DOC_M AS CUIT_ORIGINANTE,
    CONVERT(NUMERIC(10), grl.IDCAB) AS NUMERO_EXTRACTO,
    CONVERT(NUMERIC(8), CONVERT(VARCHAR, GRL.FechaEmision, 112)) AS FECHA_EXTRACTO,
    hv.ASIENTO AS ID_ASIENTO,
	ISNULL(e.ASIENTO,0) AS ASIENTO_EXTORNADO,
    HV.CODIGO_TRANSACCION AS CODIGO_TRANSACCION
FROM SALDOS s
INNER JOIN HISTORIA_VISTA (NOLOCK) HV ON HV.SALDO_JTS_OID = S.JTS_OID  
INNER JOIN MOVIMIENTOS_CONTABLES (NOLOCK) M ON M.JTS_OID = HV.MOV_JTS_OID
INNER JOIN VTA_CUMPLIMIENTO (NOLOCK) VTA ON VTA.SUCURSAL = M.SUCURSAL AND VTA.FECHA_PROCESO = M.FECHAPROCESO AND VTA.ASIENTO = M.ASIENTO
INNER JOIN GRL_CAB_ENVIO_ESTCTA (nolock) GRL ON GRL.cuenta = S.CUENTA AND S.SUCURSAL = GRL.SUCURSAL
INNER JOIN ASIENTOS asiento ON asiento.ASIENTO=m.ASIENTO AND asiento.SUCURSAL = m.sucursal AND ASIENTO.FECHAPROCESO = M.FECHAPROCESO
LEFT JOIN CON_ASIENTOS_EXTORNADOS E ON asiento.ASIENTO=e.ASIENTO_ORIGINAL
WHERE S.C1785 IN (2, 3)
AND m.FECHAPROCESO < (SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK))
');