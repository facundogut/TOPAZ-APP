EXECUTE('

IF OBJECT_ID (''dbo.VW_LIMITE_CLIENTE'') IS NOT NULL
	DROP VIEW dbo.VW_LIMITE_CLIENTE
')

EXECUTE('
CREATE     VIEW [dbo].[VW_LIMITE_CLIENTE] (
													CLIENTE, 
													NIVEL, 
													TIPO,
													IDLIMITE, 
													RIESGO, 
													NOMBRERIESGO, 
													FAMILIA, 
													PRODUCTO, 
													MONEDA, 
													MONTO_LIMITE, 
													DISP_LIMITE,
													ESTADO)
AS 

SELECT TOP 9223372036854775807 WITH TIES CLIENTE, 
		NIVEL, 
		TIPO,
		IDLIMITE, 
		RIESGO, 
		NOMBRERIESGO, 
		FAMILIA, 
		PRODUCTO, 
		MONEDA, 
		MONTO_LIMITE, 
		DISP_LIMITE,
		ESTADO
FROM(			
	SELECT	l.CLIENTE, 
			''1 - Cliente'' AS NIVEL, 
			1 AS TIPO,
			l.IDLIMITE AS IDLIMITE, 
			0 AS RIESGO, '''' AS NOMBRERIESGO, 
			0 AS FAMILIA, 
			0 AS PRODUCTO, 
			m.C6399 AS MONEDA, 
			l.MONTO AS MONTO_LIMITE, 
			l.PLAZO AS VENCIMIENTO,
			l.ESTADO,
			ISNULL(l.MONTO-sum(LCF.UTILIZADO),0) AS DISP_LIMITE
	FROM CRE_LIMITECLIENTE l WITH(NOLOCK)
	INNER JOIN MONEDAS m WITH(NOLOCK) ON l.MONEDA_LIMITE = m.C6399 
									AND m.TZ_LOCK = 0
									AND l.TZ_LOCK = 0 
	LEFT JOIN VW_LIMITE_CLIENTE_PRODUCTO lcf ON lcf.IDLIMITE=l.IDLIMITE
	GROUP BY l.CLIENTE,  
			l.IDLIMITE, 
			m.C6399, 
			l.MONTO, 
			l.PLAZO,
			l.MONTO,
			l.ESTADO									
	UNION
	SELECT	l.CLIENTE, 
			''2 - Riesgo'' AS NIVEL, 
			2 AS TIPO,
			r.IDLIMITE AS IDLIMITE, 
			r.CODIGO_RIESGO AS RIESGO, 
			t.DESCRIPCION AS NOMBRERIESGO, 
			0 AS FAMILIA, 
			0 AS PRODUCTO, 
			m.C6399 AS MONEDA, 
			r.MONTO AS MONTO_LIMITE, 
			r.FECHA_VENCIMIENTO AS VENCIMIENTO,
			l.ESTADO,
			ISNULL(r.MONTO-sum(LCF.UTILIZADO),0) AS DISP_LIMITE
	FROM CRE_LIMITECLIENTE l  WITH(NOLOCK)
	INNER JOIN MONEDAS m  WITH(NOLOCK)ON l.MONEDA_LIMITE = m.C6399 
										AND m.TZ_LOCK = 0
										AND l.TZ_LOCK = 0
	INNER JOIN CRE_RIESGOLIC r  WITH(NOLOCK)ON l.IDLIMITE = r.IDLIMITE 
											AND r.TZ_LOCK = 0
	INNER JOIN CRE_TIPOS_RIESGOS t WITH(NOLOCK) ON r.CODIGO_RIESGO = t.CODIGO_RIESGO 
											AND t.TZ_LOCK = 0  
	LEFT JOIN VW_LIMITE_CLIENTE_PRODUCTO lcf ON lcf.IDLIMITE=l.IDLIMITE AND lcf.RIESGO=r.CODIGO_RIESGO	
	GROUP BY l.CLIENTE,  
			r.IDLIMITE, 
			r.CODIGO_RIESGO, 
			t.DESCRIPCION, 
			m.C6399, 
			r.MONTO, 
			r.FECHA_VENCIMIENTO,
			r.MONTO,
			l.ESTADO									
	UNION
	SELECT	l.CLIENTE, 
			''3 - Familia'' AS NIVEL, 
			3 AS TIPO,
			f.IDLIMITE AS IDLIMITE, 
			r.CODIGO_RIESGO AS RIESGO, 
			t.DESCRIPCION AS NOMBRERIESGO, 
			f.FAMILIA AS FAMILIA, 
			0 AS PRODUCTO, 
			m.C6399 AS MONEDA, 
			f.MONTO AS MONTO_LIMITE, 
			f.FECHA_VENCIMIENTO AS VENCIMIENTO,
			l.ESTADO,
			ISNULL(f.MONTO-sum(LCF.UTILIZADO),0) AS DISP_LIMITE
	FROM CRE_LIMITECLIENTE l  WITH(NOLOCK)
	INNER JOIN MONEDAS m  WITH(NOLOCK) ON l.MONEDA_LIMITE = m.C6399 
										AND m.TZ_LOCK = 0
										AND l.TZ_LOCK = 0 
	INNER JOIN CRE_RIESGOLIC r  WITH(NOLOCK) ON l.IDLIMITE = r.IDLIMITE 
										AND r.TZ_LOCK = 0
	INNER JOIN CRE_TIPOS_RIESGOS t  WITH(NOLOCK) ON r.CODIGO_RIESGO = t.CODIGO_RIESGO 
												AND t.TZ_LOCK = 0
	INNER JOIN CRE_FAMILIALIC f  WITH(NOLOCK) ON r.IDLIMITE = f.IDLIMITE 
											AND r.CODIGO_RIESGO = f.CODIGO_RIESGO 
											AND f.TZ_LOCK = 0 
	LEFT JOIN VW_LIMITE_CLIENTE_PRODUCTO lcf ON lcf.IDLIMITE=l.IDLIMITE AND lcf.FAMILIA=F.FAMILIA AND lcf.RIESGO=r.CODIGO_RIESGO 
	GROUP BY l.CLIENTE, 
			f.IDLIMITE , 
			r.CODIGO_RIESGO, 
			t.DESCRIPCION, 
			f.FAMILIA,  
			m.C6399, 
			f.MONTO, 
			f.FECHA_VENCIMIENTO,
			l.ESTADO,
			f.MONTO,
			l.ESTADO									
	UNION
	SELECT	l.CLIENTE, 
			''4 - Producto'' AS NIVEL, 
			4 AS TIPO,
			p.IDLIMITE AS IDLIMITE, 
			r.CODIGO_RIESGO AS RIESGO, 
			t.DESCRIPCION AS NOMBRERIESGO, 
			f.FAMILIA AS FAMILIA, 
			p.PRODUCTO AS PRODUCTO, 
			m.C6399 AS MONEDA, 
			p.MONTO AS MONTO_LIMITE, 
			p.FECHA_VENCIMIENTO AS VENCIMIENTO,
			l.ESTADO,
			ISNULL(p.MONTO-LCF.UTILIZADO,0) AS DISP_LIMITE
	FROM CRE_LIMITECLIENTE l WITH(NOLOCK)
	INNER JOIN MONEDAS m  WITH(NOLOCK) ON l.MONEDA_LIMITE = m.C6399 
										AND m.TZ_LOCK = 0
										AND l.TZ_LOCK = 0 
	INNER JOIN CRE_RIESGOLIC r  WITH(NOLOCK) ON l.IDLIMITE = r.IDLIMITE 
											AND r.TZ_LOCK = 0
	INNER JOIN CRE_TIPOS_RIESGOS t  WITH(NOLOCK) ON r.CODIGO_RIESGO = t.CODIGO_RIESGO 
												AND t.TZ_LOCK = 0
	INNER JOIN CRE_FAMILIALIC f  WITH(NOLOCK) ON r.IDLIMITE = f.IDLIMITE 
											AND r.CODIGO_RIESGO = f.CODIGO_RIESGO 
											AND f.TZ_LOCK = 0
	INNER JOIN CRE_PRODUCTOLIC p  WITH(NOLOCK) ON f.IDLIMITE = p.IDLIMITE 
											AND f.CODIGO_RIESGO = p.CODIGO_RIESGO 
											AND f.FAMILIA = p.FAMILIA 
											AND p.TZ_LOCK = 0											
	LEFT JOIN VW_LIMITE_CLIENTE_PRODUCTO lcf ON lcf.IDLIMITE=l.IDLIMITE AND lcf.FAMILIA=F.FAMILIA AND lcf.PRODUCTO=P.PRODUCTO AND
	lcf.RIESGO=r.CODIGO_RIESGO										
											) o
ORDER BY	CLIENTE, 
			IDLIMITE, 
			RIESGO, 
			FAMILIA, 
			PRODUCTO

')
