execute('ALTER PROCEDURE SP_OBTENER_CARGO_ESPECIFICO
	@ID_LIQUIDACION NUMERIC(15),
	@NRO_FACTURA_CAJA NUMERIC(8),
	@TOTAL_CARGO_ESPECIFICO NUMERIC(15,2) OUTPUT
AS 
BEGIN
	
	DECLARE 
		@ID_CABEZAL NUMERIC(15),
		@COD_ENTE NUMERIC(11),
		@ID_CONVENIO NUMERIC(15)
	
	/* Obtener cargo especifico para CANALES */
	IF(@ID_LIQUIDACION != 0)
	
	BEGIN	
		DECLARE @TablaAuxNroFactura TABLE(
			NRO_FACTURA NUMERIC(12),
			TIPO_COMPROBANTE NUMERIC(2),
			LETRA VARCHAR(1),
			PUNTO_VENTA NUMERIC(4)
		)
			
		SELECT @ID_CABEZAL = ID FROM REC_CAB_RECAUDOS_CANAL WHERE ID_LIQUIDACION = @ID_LIQUIDACION AND TZ_LOCK = 0;
		SELECT @ID_CONVENIO = CONVENIO FROM REC_CAB_RECAUDOS_CANAL WHERE ID = @ID_CABEZAL AND TZ_LOCK = 0;
		SELECT @COD_ENTE = COD_ENTE FROM CONV_REL_ENTECONV WHERE ID_CONVREC = @ID_CONVENIO AND TZ_LOCK = 0
		
		/* SAMEEP */
		IF(@COD_ENTE = 406)
		BEGIN
		
			INSERT INTO @TablaAuxNroFactura 
			SELECT SUBSTRING(CODIGO_BARRAS,9,8), 	/* NRO FACTURA/COMPROBANTE */
			0, 	/* TIPO COMPROBANTE */
			CASE WHEN SUBSTRING(CODIGO_BARRAS,4,4) = 0 THEN ''A'' ELSE ''B'' END,	 /* LETRA */
			SUBSTRING(CODIGO_BARRAS,5,3) 	/*PUNTO VENTA */
			FROM REC_DET_RECAUDOS_CANAL WHERE ID_CABEZAL = @ID_CABEZAL AND TZ_LOCK = 0;
			
		   
			SELECT @TOTAL_CARGO_ESPECIFICO = SUM(TOTAL_CARGO_ESPECIFICO) FROM CONV_PADRONES P JOIN @TablaAuxNroFactura A
																		ON P.NRO_COMPROBANTE_CLIENTE = A.NRO_FACTURA
																		WHERE P.TZ_LOCK = 0 AND P.ESTADO = ''P''
																		AND P.CONVENIO = @COD_ENTE AND P.TIPO_COMPROBANTE = A.TIPO_COMPROBANTE
																		AND P.LETRA = A.LETRA AND P.PUNTO_VENTA = A.PUNTO_VENTA
			RETURN @TOTAL_CARGO_ESPECIFICO;
		END
		
		/* SECHEEP */
		IF(@COD_ENTE = 265)
		BEGIN
			INSERT INTO @TablaAuxNroFactura 
			SELECT SUBSTRING(CODIGO_BARRAS,11,8), 	/*NRO FACTURA/COMPROBANTE */
			SUBSTRING(CODIGO_BARRAS,4,2), 	/* TIPO COMPROBANTE */
			CASE WHEN SUBSTRING(CODIGO_BARRAS,6,1) = 0 THEN ''A'' ELSE ''B'' END, 	/* LETRA */
			SUBSTRING(CODIGO_BARRAS,7,4) 	/* PUNTO VENTA */
			FROM REC_DET_RECAUDOS_CANAL WHERE ID_CABEZAL = @ID_CABEZAL AND TZ_LOCK = 0;
			
			
			SELECT @TOTAL_CARGO_ESPECIFICO = SUM(TOTAL_CARGO_ESPECIFICO) FROM CONV_PADRONES P JOIN @TablaAuxNroFactura A
																		ON P.NRO_COMPROBANTE_CLIENTE = A.NRO_FACTURA
																		WHERE P.TZ_LOCK = 0 AND P.ESTADO = ''P''
																		AND P.CONVENIO = @COD_ENTE AND P.TIPO_COMPROBANTE = A.TIPO_COMPROBANTE
																		AND P.LETRA = A.LETRA AND P.PUNTO_VENTA = A.PUNTO_VENTA
			RETURN @TOTAL_CARGO_ESPECIFICO;
		END
	END		
	ELSE
		BEGIN
			/* Obtener cargo especifico para Cobros por Caja (ope 2644) */
	
			SELECT @TOTAL_CARGO_ESPECIFICO = TOTAL_CARGO_ESPECIFICO FROM CONV_PADRONES WHERE ESTADO = ''P''
															AND NRO_COMPROBANTE_CLIENTE = @NRO_FACTURA_CAJA
															AND TZ_LOCK = 0
			RETURN @TOTAL_CARGO_ESPECIFICO;
		END

END
')
