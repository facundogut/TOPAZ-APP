/****** Object:  View [dbo].[VW_ASIENTOS_DPF]    Script Date: 25/02/2021 9:42:56 ******/
DROP VIEW [dbo].[VW_ASIENTOS_DPF]
GO

/****** Object:  View [dbo].[VW_ASIENTOS_DPF]    Script Date: 25/02/2021 9:42:56 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[VW_ASIENTOS_DPF]
									(ASIENTO,
									DESCRIPCION,
									FECHAPROCESO,
									SUCURSAL,
									JTS_OID)
AS
			SELECT
					DISTINCT A.ASIENTO AS ASIENTO,
					A.DESCRIPCION AS DESCRIPCION, 
					A.FECHAPROCESO AS FECHAPROCESO,
					A.SUCURSAL AS SUCURSAL, 
					M.SALDO_JTS_OID AS JTS_OID
			FROM ASIENTOS A with (nolock)
			INNER JOIN MOVIMIENTOS_CONTABLES M with (nolock) ON A.ASIENTO = M.ASIENTO 
						AND A.FECHAPROCESO = M.FECHAPROCESO 
						AND A.SUCURSAL = M.SUCURSAL
			WHERE 
				A.ESTADO = 77 
				AND A.EXTORNO = 0
				AND A.FECHAPROCESO >=
									(SELECT TOP 1 AA.FECHAPROCESO
									FROM ASIENTOS AA with (nolock), 
										MOVIMIENTOS_CONTABLES MM with (nolock)
									WHERE AA.ASIENTO = MM.ASIENTO 
											AND AA.SUCURSAL = MM.SUCURSAL 
											AND AA.FECHAPROCESO = MM.FECHAPROCESO 
											AND AA.ESTADO = 77 
											AND MM.SALDO_JTS_OID = M.SALDO_JTS_OID 
											AND AA.OPERACION = 8620
									ORDER BY AA.FECHAPROCESO DESC
									)
				AND NOT EXISTS (SELECT * 
								FROM ASIENTOS_EXTORNADOS AE with (nolock)
								WHERE AE.SUCURSAL = A.SUCURSAL 
										AND AE.FECHA_PROCESO = A.FECHAPROCESO 
										AND AE.ASIENTO = A.ASIENTO
								);
GO


