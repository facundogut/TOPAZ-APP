EXECUTE('
ALTER TABLE CRE_SUBSIDIOS  ADD Plazo NUMERIC (5,0) NULL
')

EXECUTE('
IF OBJECT_ID (''dbo.VW_SaldosClienteLimite'') IS NOT NULL
	DROP VIEW dbo.VW_SaldosClienteLimite
')

EXECUTE('
CREATE   VIEW [dbo].[VW_SaldosClienteLimite] 
AS 
select	s.C1803 AS cliente,
		(CASE
		WHEN (C1604+C1605) <0 THEN
			(C1604+C1605) * -1
		ELSE
			(C1604+C1605)
		END) AS IMPORTE,
			s.C1601 AS CAPITAL_ORIGINAL,
		s.c1608 AS INTERESES,
		s.moneda as MONEDA,
		s.jts_oid AS SALDO_JTS_OID,
		p.c6283 as FAMILIAPROD,
		s.PRODUCTO,
		s.c1612 as CUOTA_APROBADA,
		s.MATRICULA_LIMITE	
from saldos s WITH (NOLOCK)
INNER JOIN productos p WITH (NOLOCK)ON s.producto = p.C6250
									and p.tz_lock = 0
									and (p.EVALUA_DEUDA = ''S'') 	
INNER JOIN planctas pc WITH (NOLOCK)ON pc.C6326 = s.C1730
									and pc.tz_lock = 0
WHERE S.C1604 < 0 AND (s.tz_lock = 0 	OR (s.TZ_LOCK > 099999999999999 AND s.TZ_LOCK < 199999999999999 ))
UNION												
SELECT	s.C1803 AS CLIENTE, 
		v.IMPORTE AS IMPORTE, 
		v.IMPORTE AS  CAPITAL_ORIGINAL, 
		0 AS INTERES,
		s.MONEDA AS MONEDA,
		s.JTS_OID AS SALDO_JTS_OID, 
		p.C6283 as FAMILIAPROD, 
		v.NROLINEA AS PRODUCTO,
		0 AS CUOTA_APROBADA , 
		'' '' AS MATRICULA_LIMITE
FROM VTA_SOBREGIROS v WITH(NOLOCK)
INNER JOIN SALDOS s WITH(NOLOCK) ON v.JTS_OID_SALDO = s.JTS_OID AND s.TZ_LOCK = 0
INNER JOIN PRODUCTOS p WITH(NOLOCK) ON v.NROLINEA = p.C6250 
									AND p.TZ_LOCK = 0
									AND  p.EVALUA_DEUDA = ''S''
INNER JOIN MONEDAS m WITH(NOLOCK) ON s.MONEDA = m.C6399 AND m.TZ_LOCK = 0
INNER JOIN SUCURSALES suc WITH(NOLOCK) ON v.SUCURSAL_ACUERDO = suc.SUCURSAL 
										AND suc.TZ_LOCK = 0
										AND v.ESTADO = 1 
										AND v.TZ_LOCK =0


')

EXECUTE('
IF OBJECT_ID (''dbo.PA_SUB_RENOVACION'') IS NOT NULL
	DROP PROCEDURE dbo.PA_SUB_RENOVACION
')


EXECUTE('
CREATE PROCEDURE PA_SUB_RENOVACION 
	@p_id_proceso FLOAT(53),   
	@p_dt_proceso DATETIME,   
	@p_ret_proceso FLOAT OUT, 
	@p_msg_proceso VARCHAR(MAX) OUT
AS
BEGIN

	DECLARE 
	------- Campos para el LOG --------
	@c_log_tipo_error varchar(30),
	@c_log_tipo_informacion VARCHAR(30),
	-----------------------------------	
	@contador NUMERIC(10)
	SET @contador = 0;
	------- Campos para el LOG --------
	SET @c_log_tipo_error = ''E'';
	SET @c_log_tipo_informacion = ''I'';
	-----------------------------------	
	
BEGIN TRY
        	  
		SET @contador =	(SELECT count(*)
		FROM CRE_SUBSIDIOS, PARAMETROS WITH (NOLOCK)
                WHERE CRE_SUBSIDIOS.FechaFin <= PARAMETROS.FECHAPROCESO
                AND CRE_SUBSIDIOS.RenuevaAutomaticamente=''S'' AND TZ_LOCK=0)		
		
		IF @contador > 0
		BEGIN
                 UPDATE CRE_SUBSIDIOS 
                 SET CRE_SUBSIDIOS.FechaFin= CRE_SUBSIDIOS.FechaFin+CRE_SUBSIDIOS.Plazo
                 WHERE CRE_SUBSIDIOS.FechaFin <= (SELECT FECHAPROCESO FROM PARAMETROS)
                 AND CRE_SUBSIDIOS.RenuevaAutomaticamente=''S'' AND TZ_LOCK=0
                
                 
         END        
SET @p_msg_proceso = ''El Proceso de Renovaci贸n de SUBSIDIOS ha finalizado correctamente. Registros procesados: ''
+ CONVERT(VARCHAR(10), @contador)
	 SET @p_ret_proceso = 1 		
			
			-- Logueo de informaci贸n
			EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
				@p_id_proceso,
		    	@p_dt_proceso,
		    	''PA_SUB_RENOVACION '',
		    	@p_cod_error = @p_ret_proceso, 
				@p_msg_error = @p_msg_proceso, 
				@p_tipo_error = @c_log_tipo_informacion
		END TRY
							             
		BEGIN CATCH
	
	        SET @p_ret_proceso = ERROR_NUMBER()
	        SET @p_msg_proceso = ''Ocurri贸 un error en el Proceso de Renovaci贸n de SUBSIDIOS: '' + ERROR_MESSAGE()
	
			EXECUTE PKG_LOG_PROCESO$proc_ins_log_proceso 
	        	@p_id_proceso = @p_id_proceso, 
	        	@p_fch_proceso = @p_dt_proceso, 
	        	@p_nom_package = ''PA_SUB_RENOVACION '', 
	        	@p_cod_error = @p_ret_proceso, 
	        	@p_msg_error = @p_msg_proceso, 
	       		@p_tipo_error = @c_log_tipo_informacion
		END CATCH
END
')


EXECUTE('
IF OBJECT_ID (''dbo.VBS_ESTADO_CUENTA'') IS NOT NULL
	DROP VIEW dbo.VBS_ESTADO_CUENTA
')

EXECUTE('
CREATE VIEW dbo.VBS_ESTADO_CUENTA
AS
SELECT 
	ROW_NUMBER() OVER(PARTITION BY PP.SALDO_JTS_OID,PP.C2300 ORDER BY PP.C2300 ASC) AS NUMERADOR,
	PP.SALDO_JTS_OID,
	PP.C2300 AS NCUOTA,
	PP.C2302 AS VENCIMIENTOCUOTA,
	PPO.CAPITAL AS CAPITAL,
	PPO.INTERES AS INTERES, 
	PP.C2309 AS SALDO_CAPITAL,
	PP.C2310 AS SALDO_INTERES,  	 
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAINTERES END  AS PP_IVAINTERES,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAPERCEPCIONINTERES END AS PP_IVAPERCEPCIONINTERES,
	PP.C2311 AS PP_MORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAMORA END AS PP_IVAMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAPERCEPCIONMORA END AS PP_IVAPERCEPCIONMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.ICMORA_DEV END AS PP_INTCOMPMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAINTCOMPMORA END AS PP_IVAINTCOMPMORA,
	CASE WHEN PP.TZ_LOCK <> 0 THEN 0 ELSE PP.IVAPERCEPCIONINTCOMPMORA END AS PP_IVAPERCEPCIONINTCOMPMORA,	
	ISNULL((SELECT SUM(SALDO_GASTO) FROM GASTOS_POR_CUOTA WITH (NOLOCK) WHERE SALDOS_JTS_OID=S.JTS_OID AND NUMERO_CUOTA=PPO.NUMERO_CUOTA),0) AS PP_GASTOS,
    P.HP_JTS_OID,
    P.CUOTA AS CUOTA,
    CASE WHEN DATEDIFF(d,P.VENCIMIENTOCUOTA,P.FECHAVALOR)<=0 THEN NULL 
    ELSE  DATEDIFF(d,P.VENCIMIENTOCUOTA,P.FECHAVALOR) END  AS DIASATRASO,
    P.NROASIENTOMOV,
    P.FECHAPROCESOMOV,
    P.FECHAVALOR,
    ISNULL(P.CAPITALPAGADO,0) AS CAPITALPAGADO,
    ISNULL(P.CAPITALPAGADO,0) + ISNULL(P.CAPITALADELANTADO,0) AS TOTAL_CAPITALPAGADO,
    ISNULL(P.INTERESPAGADO,0) AS INTERESPAGADO ,
    ISNULL(I.IVAINTERES,0) AS IVAINTERES , 
    ISNULL(I.IVAINTERESPERCEPCION,0)AS IVAINTERESPERCEPCION ,       
    ISNULL(P.CAPITALADELANTADO,0) AS CAPITALADELANTADO,
    ISNULL(P.MORAPAGADA,0) AS MORAPAGADA,
    ISNULL(I.IVAMORA,0) AS IVAMORA,
    ISNULL(I.IVAMORAPERCEPCION,0) AS IVAMORAPERCEPCION ,    
    ISNULL(P.BONIFICACION,0) AS BONIFICACION,
    ISNULL(INTERES_COMP_MORA,0) AS INTERES_COMP_MORA,
    ISNULL(C.TOTAL_PAGADO,0) AS GASTOS,
    ISNULL(P.CAPITALPAGADO,0)+ISNULL(P.CAPITALADELANTADO,0)+ISNULL(P.MORAPAGADA,0)+ISNULL(P.INTERES_COMP_MORA,0)+ISNULL(I.IVAMORA,0)+ISNULL(I.IVAMORAPERCEPCION,0)+ISNULL(P.INTERESPAGADO,0)+ISNULL(I.IVAINTERES,0)+ISNULL(I.IVAINTERESPERCEPCION,0)+ISNULL(C.TOTAL_PAGADO,0) AS TOTALPAGADO,
   
    PP.REMANENTE_CAPITAL-PP.C2304 AS SALDOCAPITAL 
FROM PLANPAGOS PP WITH (NOLOCK) 
INNER JOIN PLANPAGOS_ORIGINAL PPO WITH (NOLOCK) 
	ON PPO.SALDO_JTS_OID=PP.SALDO_JTS_OID AND PPO.NUMERO_CUOTA=PP.C2300
INNER JOIN SALDOS S WITH (NOLOCK) 
	ON PP.SALDO_JTS_OID=S.JTS_OID AND S.TZ_LOCK=0
LEFT JOIN BS_PAYS_DETAIL P WITH (NOLOCK)	
	ON P.SALDOS_JTS_OID=S.JTS_OID
	AND P.CUOTA=PP.C2300 
	AND ((P.CAPITALPAGADO + P.CAPITALADELANTADO)<>0 OR INTERESPAGADO<>0 OR  MORAPAGADA<>0 OR P.INTERES_COMP_MORA<>0) 
	AND (TIPOAJUSTEHP<>''C'' OR TIPOAJUSTEHP IS NULL)
LEFT JOIN BS_CHARGE_DETAIL C WITH (NOLOCK) 
	ON  P.SALDOS_JTS_OID = C.SALDOS_JTS_OID 
	AND P.HP_JTS_OID = C.HP_JTS_OID 
	AND P.CUOTA = C.CUOTA 
	AND C.TOTAL_PAGADO<>0 
	AND P.TZ_LOCK=0
LEFT JOIN BS_PAYS_DETAIL_IVA I WITH (NOLOCK) 	
	ON P.SALDOS_JTS_OID = I.SALDOS_JTS_OID 
	AND P.HP_JTS_OID = I.HP_JTS_OID 
	AND P.CUOTA = I.CUOTA
')
