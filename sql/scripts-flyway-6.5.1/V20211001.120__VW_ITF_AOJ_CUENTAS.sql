EXECUTE('DROP VIEW IF EXISTS [dbo].[VW_ITF_AOJ_CUENTAS];')

EXECUTE('
CREATE VIEW [dbo].[VW_ITF_AOJ_CUENTAS] 
AS

SELECT DISTINCT
		RIGHT(REPLICATE(''0'', 50)+ CAST(CP.NUMEROPERSONA AS VARCHAR(50)), 50) AS ID_CLIENTE, 
		dbo.NCADENAS(concat(
							RIGHT(REPLICATE(''0'', 4)+ CAST(S.SUCURSAL AS VARCHAR(5)), 4), 
							''-'',
							RIGHT(REPLICATE(''0'', 5)+ CAST(S.PRODUCTO AS VARCHAR(5)), 5), 
							''-'',
							RIGHT(REPLICATE(''0'', 9)+ CAST(S.CUENTA AS VARCHAR(12)), 9), 
							''-'',
							RIGHT(REPLICATE(''0'', 4)+ CAST(S.MONEDA AS VARCHAR(4)), 4) ,  
							''-'',
							RIGHT(REPLICATE(''0'', 8)+ CAST(S.OPERACION AS VARCHAR(12)), 8), 
							''-'',
							RIGHT(REPLICATE(''0'', 6)+ CAST(S.ORDINAL AS VARCHAR(6)), 6)
					),50,''0'',''P'') AS NUMERO_CUENTA,
		RIGHT(concat(''00000'',  (SELECT CAST(IMPORTE_1 AS  NUMERIC(15)) 
								FROM ITF_MASTER_PARAMETROS WITH (NOLOCK)
								WHERE [CODIGO_INTERFACE] = 7 
									AND NUMERICO_1 = S.PRODUCTO 
									AND NUMERICO_2 = S.MONEDA AND TZ_LOCK = 0)), 5) AS ''Tipo de Cuenta'',
		RIGHT(concat(''000000'', S.SUCURSAL), 6) AS ''Codigo Sucursal'',
		LEFT(concat((''Producto ''+ CAST(P.C6250 AS VARCHAR(7))+'': ''+ P.C6251), replicate('' '', 200)), 200) AS ''Observacion'',
		(CASE
			WHEN p.C6252 = 1 OR p.C6252 = 2 OR p.C6252 = 3 AND s.C1651=1 THEN ''C''
			WHEN p.C6252 = 2 OR p.C6252 = 3 AND s.C1651<>1 THEN ''V''
			WHEN p.C6252 = 4 OR p.C6252 = 5 AND s.C1604=0 THEN ''C''
			WHEN p.C6252 = 4 OR p.C6252 = 5 AND s.C1604<>0 THEN ''V''
			ELSE ''V''
		END) AS EST_PRODUCTO,
		REPLACE(concat(''#{Top.Output}AOJ/ofjudiciales_cuentas_'',CONVERT(CHAR(8),FECHAPROCESO,112)) , ''#{'', ''${'') AS NOM_ARCHIVO
FROM PARAMETROS, CLI_CLIENTES c WITH (NOLOCK)
JOIN CLI_ClientePersona cp  WITH (NOLOCK)ON cp.[CODIGOCLIENTE]=c.[CODIGOCLIENTE]
JOIN SALDOS s  WITH (NOLOCK)ON c.[CODIGOCLIENTE]=s.C1803
JOIN PRODUCTOS p  WITH (NOLOCK)ON p.C6250 = s.PRODUCTO
WHERE ((C.TZ_LOCK < 300000000000000 OR C.TZ_LOCK >= 400000000000000) AND (C.TZ_LOCK < 100000000000000 OR C.TZ_LOCK >= 200000000000000)) AND 
      ((CP.TZ_LOCK < 300000000000000 OR CP.TZ_LOCK >= 400000000000000) AND (CP.TZ_LOCK < 100000000000000 OR CP.TZ_LOCK >= 200000000000000)) AND 
      ((P.TZ_LOCK < 300000000000000 OR P.TZ_LOCK >= 400000000000000) AND (P.TZ_LOCK < 100000000000000 OR P.TZ_LOCK >= 200000000000000)) AND 
      ((S.TZ_LOCK < 300000000000000 OR S.TZ_LOCK >= 400000000000000) AND (S.TZ_LOCK < 100000000000000 OR S.TZ_LOCK >= 200000000000000))
UNION ALL
SELECT 
	RIGHT(REPLICATE(''0'', 50)+ CAST(CP.NUMEROPERSONA AS VARCHAR(50)), 50) AS ID_CLIENTE,
	dbo.NCADENAS(cc.[CODIGO_COFRE],50,''0'',''P'') AS NUMERO_CUENTA,
	''00008'' AS ''Tipo de Cuenta'',
	dbo.NCADENAS(cc.SUCURSAL_DEBITO,6,''0'',''P'') AS ''Codigo Sucursal'',
	''Caja de Seguridad'' AS ''Observacion'',
	''V'' AS EST_PRODUCTO,
	REPLACE(concat(''#{Top.Output}AOJ/ofjudiciales_cuentas_'',CONVERT(CHAR(8),(	SELECT FECHAPROCESO 
																				FROM PARAMETROS WITH(NOLOCK)),112)) , ''#{'', ''${'') AS NOM_ARCHIVO
FROM COF_COFRES_CONTRATOS cc  WITH (NOLOCK)  
INNER JOIN CLI_CLIENTES c  WITH (NOLOCK)ON cc.CLIENTE=c.[CODIGOCLIENTE]
										AND cc.TZ_LOCK=0
INNER JOIN CLI_ClientePersona cp WITH (NOLOCK) ON cp.[CODIGOCLIENTE]=c.[CODIGOCLIENTE] 
												AND cp.TITULARIDAD=''T'';')

