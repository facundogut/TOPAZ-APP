EXECUTE('
IF OBJECT_ID (''VW_COFRES_VISITAS'') IS NOT NULL
	DROP VIEW VW_COFRES_VISITAS
')


EXECUTE('
CREATE VIEW [VW_COFRES_VISITAS] (
											   [CODIGO_CONTRATO], 
											   [CODIGO_EVENTO], 
											   PAIS_DOCUMENTO, 
											   TIPO_DOCUMENTO, 
											   NUMERO_DOCUMENTO, 
											   NUMERO_PERSONA, 
											   TIPO_PERSONA, 
											   NOMBRE_PERSONA, 
											   TITULARIDAD,  
											   FECHA_EVENTO,
											   ESTADO_CONTRATO,
											   ESTADO_EVENTO,
											   DEPENDENCIA)
AS 
SELECT
		C.[CODIGO_CONTRATO], 
		E.[CODIGO_EVENTO], 
		D.PAISDOCUMENTO AS PAIS_DOCUMENTO, 
		D.TIPODOCUMENTO AS TIPO_DOCUMENTO, 
		D.NUMERODOCUMENTO AS NUMERO_DOCUMENTO, 
		E.NUMERO_PERSONA, 
		D.TIPOPERSONA AS TIPO_PERSONA, 
		(ISNULL(F.PRIMERNOMBRE, '''') + '' '' + ISNULL(F.APELLIDOPATERNO, '''')) AS NOMBRE_PERSONA, 
		CASE W.[CATEGORIA]
			WHEN ''A'' THEN ''TITULAR''
			WHEN ''B'' THEN ''TITULAR''
			ELSE ''AUTORIZADO''
		END AS TITULARIDAD, 
		C.FECHA_EVENTO,
		X.ESTADO,
		OE.DESCRIPCION,
		Y.DEPENDENCIA
FROM 
	COF_COFRES_DETALLE_EVENTOS AS E
INNER JOIN COF_COFRES_EVENTOS AS C WITH (nolock) ON 
	C.NUMERO_EVENTO = E.[CODIGO_EVENTO] 
	AND C.TIPO_EVENTO = ''V''
	AND C.TZ_LOCK = 0
INNER JOIN CLI_PERSONASFISICAS AS F WITH (nolock) ON 
	E.NUMERO_PERSONA = F.NUMEROPERSONAFISICA 
	AND F.TZ_LOCK = 0
INNER JOIN CLI_DOCUMENTOSPFPJ AS D WITH (nolock) ON 
	E.NUMERO_PERSONA = D.NUMEROPERSONAFJ
	AND D.TZ_LOCK = 0
	AND D.TIPODOCUMENTO IN (    SELECT
                                TOP 1 TIPODOCUMENTO
                            FROM
                                CLI_DOCUMENTOSPFPJ
                            WHERE
                                NUMEROPERSONAFJ = D.NUMEROPERSONAFJ
                                AND TZ_LOCK = 0
                            )       
    AND D.NUMERODOCUMENTO IN (    SELECT
                                TOP 1 NUMERODOCUMENTO
                            FROM
                                CLI_DOCUMENTOSPFPJ
                            WHERE
                                NUMEROPERSONAFJ = D.NUMEROPERSONAFJ
                                AND TIPODOCUMENTO = D.TIPODOCUMENTO
                                AND TZ_LOCK = 0
                            )
INNER JOIN COF_COFRES_CONTRATOS AS X WITH (nolock) ON
	X.[CODIGO] = C.[CODIGO_CONTRATO]
	AND X.TZ_LOCK = 0
INNER JOIN COF_COFRES AS Y WITH (nolock) ON 
	Y.[CODIGO] = X.[CODIGO_COFRE]
	AND Y.TZ_LOCK = 0
LEFT JOIN PYF_APODERADOS AS W WITH (nolock) ON 
	W.ID_PERSONA = F.NUMEROPERSONAFISICA 
	AND W.TIPO_PODER = 10
	AND W.TIPO_ENTIDAD = 3
	AND W.TZ_LOCK = 0
LEFT JOIN OPCIONES AS OE WITH (nolock) ON
	OE.NUMERODECAMPO = 8987
	AND OE.OPCIONINTERNA = C.ESTADO
	AND OE.IDIOMA = ''E''
WHERE E.TZ_LOCK = 0
')