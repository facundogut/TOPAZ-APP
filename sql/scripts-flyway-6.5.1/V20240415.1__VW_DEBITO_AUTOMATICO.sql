EXECUTE('
IF OBJECT_ID (''dbo.VW_DEBITO_AUTOMATICO'') IS NOT NULL
	DROP VIEW dbo.VW_DEBITO_AUTOMATICO
')

EXECUTE('
CREATE   VIEW [dbo].[VW_DEBITO_AUTOMATICO]
AS


SELECT DISTINCT TOP 100 PERCENT
    --ROW_NUMBER() OVER(ORDER BY l.ID_LIQUIDACION ASC) AS ''ID_LIQUIDACION'',
    ISNULL(L.ID_LIQUIDACION, RC.ID) AS ''ID_LIQUIDACION'',
    ISNULL(L.ESTADO, RC.ESTADO) AS ''ESTADO'',
    ISNULL(L.CONVENIO, RC.CONVENIO) AS ''CONVENIO'',
    C.NomConvRec AS ''NOMBRE_CONVENIO'',
    ISNULL(L.CONVENIO_PADRE, c.Id_ConvPadre) AS ''CONVENIO_PADRE'',
    C.Cuit AS ''CUIT'',
    ISNULL(L.FECHA, RC.FECHACORTE) AS ''FECHA_LIQUIDACION'',
    C.Acreditacion AS ''PLAZO_ACRED'',
    ISNULL(L.MONEDA, RC.MONEDA) AS ''MONEDA'',
    ISNULL(L.TOTALREGISTROS, RC.TOTALREGISTROS) AS ''TOTAL_REGISTROS'',
    ISNULL(L.TOTALIMPORTE, RC.TOTALIMPORTE) AS ''TOTAL_IMPORTE'',
    ISNULL(L.COMISION_LIQUIDADA, ''0'') AS ''COMISION_LIQUIDADA'',
    ISNULL(L.IMPORTE_COMISION, 0) AS ''IMPORTE_COMISION'',
    ISNULL(L.TOTAL_CARGO_ESPECIFICO, 0) AS ''TOTAL_CARGO_ESPECIFICO''
FROM REC_CAB_DEBITOSAUTOMATICOS RC WITH (NOLOCK)
LEFT JOIN REC_LIQUIDACION L WITH (NOLOCK) ON RC.CONVENIO = L.CONVENIO  
      AND L.ID_LIQUIDACION <= CASE WHEN RC.ESTADO IN (''V'',''Z'') 
      
      AND RC.FECHACORTE = (SELECT FECHAPROCESO FROM PARAMETROS) THEN 0 ELSE RC.ID_LIQUIDACION END
      AND (L.tz_lock < 300000000000000 OR L.tz_lock >= 400000000000000)
      AND (L.tz_lock < 100000000000000 OR L.tz_lock >= 200000000000000)
      AND L.ESTADO = ''L''
      
JOIN CONV_CONVENIOS_REC C WITH (NOLOCK) ON (L.CONVENIO = C.Id_ConvRec OR c.id_convPadre = L.CONVENIO OR C.Id_ConvRec = RC.CONVENIO OR c.id_convPadre = RC.CONVENIO)
    AND C.Id_TpoConv IN (2) 
    AND C.ESTADO = ''A''
    AND (L.ESTADO = ''L'' OR RC.ESTADO IN (''V'', ''Z''))
    AND (
    EXISTS (
        SELECT FECHAPROCESO FROM PARAMETROS
        WHERE FECHAPROCESO = 
            CASE 
                WHEN C.Acreditacion = ''24H'' THEN dbo.diaHabil(DATEADD(day, 1, L.FECHA), ''A'')
                WHEN C.Acreditacion = ''48H'' THEN dbo.diaHabil(DATEADD(day, 2, L.FECHA), ''A'')
                WHEN C.Acreditacion = ''DIA'' THEN dbo.diaHabil(DATEADD(day, 0, L.FECHA), ''A'')
                WHEN C.Acreditacion = ''MES'' THEN dbo.ULTIMODIAHABIL(L.FECHA)
            END
    )
    OR EXISTS (
        SELECT FECHAPROCESO FROM PARAMETROS
        WHERE FECHAPROCESO =  CASE 
			                WHEN C.Acreditacion = ''24H'' THEN dbo.diaHabil(DATEADD(day, 1, RC.FECHACORTE), ''A'')
			                WHEN C.Acreditacion = ''48H'' THEN dbo.diaHabil(DATEADD(day, 2, RC.FECHACORTE), ''A'')
			                WHEN C.Acreditacion = ''DIA'' THEN dbo.diaHabil(DATEADD(day, 0, RC.FECHACORTE), ''A'')
			                WHEN C.Acreditacion = ''MES'' THEN dbo.ULTIMODIAHABIL(RC.FECHACORTE)
			            END
    )
)
LEFT JOIN CLI_CLIENTES CLI WITH (NOLOCK) ON C.Cliente = CLI.CODIGOCLIENTE
WHERE 
    (
        C.tz_lock < 300000000000000 OR C.tz_lock >= 400000000000000
    )
    AND (C.tz_lock < 100000000000000 OR C.tz_lock >= 200000000000000)
    AND (CLI.tz_lock < 300000000000000 OR CLI.tz_lock >= 400000000000000)
    AND (CLI.tz_lock < 100000000000000 OR CLI.tz_lock >= 200000000000000)
    AND (RC.tz_lock < 300000000000000 OR RC.tz_lock >= 400000000000000)    
    AND (RC.tz_lock < 100000000000000 OR RC.tz_lock >= 200000000000000)
    
ORDER BY estado asc

')
