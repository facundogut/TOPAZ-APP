
EXECUTE('

ALTER PROCEDURE [dbo].[SP_BCRA_PADFYJ_FULL]  
   @P_TICKET  NUMERIC(12),
   @P_USUARIO VARCHAR(10)
AS 
   BEGIN
   	SET NOCOUNT ON;
   
	TRUNCATE TABLE dbo.ITF_BCRA_PADFYJ;
	TRUNCATE TABLE dbo.ITF_BCRA_PADFYJ_REPORTE;
	DECLARE @V_FECHAPROCESO DATE;
	DECLARE @V_HORA TIME;
	SET @V_FECHAPROCESO = (SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK));
    SET @V_HORA = (SELECT convert(char(8), getdate(), 108));
    
	/*Se hace modifican los registros en fallecidos cuando corresponden*/
	
	UPDATE m
					SET
						 m.NOMBRE = ISNULL(b.NOMBRE,'' '')
						, m.TIPO_MOV = ''A''
						, m.CANAL = ''B''
						, m.TZ_LOCK = 0
						, m.ESTADO = ''I''
						, m.FECHA_ALTA = @V_FECHAPROCESO
						, m.TICKET = @P_TICKET
	FROM dbo.CLI_MAESTRO_FALLECIDOS m WITH (NOLOCK) INNER JOIN dbo.TEMP_BCRA_PADFYJ_FALLECIDOS b WITH (NOLOCK) ON m.CUIL=b.CUIL AND
	b.MARCA_FALLECIDO=1 AND b.CUIL<30000000000 AND b.CUIL>19999999999 AND EXISTS (SELECT 1 FROM CLI_MAESTRO_FALLECIDOS (nolock) WHERE CUIL=b.CUIL AND (ESTADO<>''P'' AND (ESTADO<>''I'' AND TIPO_MOV<>''A''))) AND ISNUMERIC(b.CUIL)=1

	/*Se hace insert de todos los registros nuevos fallecidos*/
	
	INSERT INTO dbo.CLI_MAESTRO_FALLECIDOS (CUIL, NOMBRE, TIPO_MOV, CANAL, TZ_LOCK, ESTADO, FECHA_ALTA, TICKET )
	SELECT b.CUIL, ISNULL(MAX(b.NOMBRE),'' ''), ''A'', ''B'', 0, ''I'', @V_FECHAPROCESO, @P_TICKET
	FROM dbo.TEMP_BCRA_PADFYJ_FALLECIDOS b WITH (NOLOCK) INNER JOIN dbo.CLI_DocumentosPFPJ d WITH (NOLOCK) ON b.CUIL=d.NUMERODOCUMENTO
	WHERE b.MARCA_FALLECIDO=1 AND b.CUIL<30000000000 AND b.CUIL>19999999999 AND NOT EXISTS (SELECT 1 FROM CLI_MAESTRO_FALLECIDOS (nolock) WHERE CUIL=b.CUIL ) AND ISNUMERIC(b.CUIL)=1
	GROUP BY b.CUIL
	
	INSERT INTO dbo.CLI_MAESTRO_FALLECIDOS (CUIL, NOMBRE, TIPO_MOV, CANAL, TZ_LOCK, ESTADO, FECHA_ALTA, TICKET )
	SELECT b.CUIL, ISNULL(MAX(b.NOMBRE),'' ''), ''A'', ''B'', 0, ''P'', @V_FECHAPROCESO, @P_TICKET
	FROM dbo.TEMP_BCRA_PADFYJ_FALLECIDOS b WITH (NOLOCK) 
	WHERE b.MARCA_FALLECIDO=1 AND b.CUIL<30000000000 AND b.CUIL>19999999999 AND NOT EXISTS (SELECT 1 FROM CLI_MAESTRO_FALLECIDOS (nolock) WHERE CUIL=b.CUIL ) AND ISNUMERIC(b.CUIL)=1
	AND NOT EXISTS (SELECT 1 FROM CLI_DocumentosPFPJ d (NOLOCK) WHERE d.NUMERODOCUMENTO=b.CUIL)
	GROUP BY b.CUIL
	
	/*Se hace insert de todos los registros sin problemas ITF_BCRA_PADFYJ*/
	
	INSERT INTO dbo.ITF_BCRA_PADFYJ (CUIT ,APELLIDOS, ACTIVIDAD, MARCA_FALLECIDO, APELLIDOMATERNO, NOMBRES, SEGUNDONOMBRE, TZ_LOCK, NOMBRE_COMPLETO ) 
	SELECT b.CUIL, 
	CASE 
	WHEN (SELECT LEN(ISNULL(MAX(b.NOMBRE),'' '')) - LEN(REPLACE(ISNULL(MAX(b.NOMBRE),'' ''), '' '', '''')))>2 THEN SUBSTRING(ISNULL(MAX(b.NOMBRE),'' ''), 1,(CHARINDEX('' '',SUBSTRING(ISNULL(MAX(b.NOMBRE),'' ''), CHARINDEX ('' '', ISNULL(MAX(b.NOMBRE),'' ''))+1, LEN(ISNULL(MAX(b.NOMBRE),'' '')))))+(CHARINDEX ('' '', ISNULL(MAX(b.NOMBRE),'' ''))))
	WHEN (SELECT LEN(ISNULL(MAX(b.NOMBRE),'' '')) - LEN(REPLACE(ISNULL(MAX(b.NOMBRE),'' ''), '' '', '''')))=0 THEN ISNULL(MAX(b.NOMBRE),'' '')
	ELSE SUBSTRING(ISNULL(MAX(b.NOMBRE),'' ''), 1, CHARINDEX ('' '', ISNULL(MAX(b.NOMBRE),'' ''))-1)
	END, ---Apellidos
	ISNULL(MAX(b.ACTIVIDAD),0),
	MAX(b.MARCA_FALLECIDO),
	'''',
	CASE 
	WHEN (SELECT LEN(ISNULL(MAX(b.NOMBRE),'' '')) - LEN(REPLACE(ISNULL(MAX(b.NOMBRE),'' ''), '' '', '''')))>2 THEN SUBSTRING(ISNULL(MAX(b.NOMBRE),'' ''), (CHARINDEX('' '',SUBSTRING(ISNULL(MAX(b.NOMBRE),'' ''), CHARINDEX ('' '', ISNULL(MAX(b.NOMBRE),'' ''))+1, LEN(ISNULL(MAX(b.NOMBRE),'' '')))))+(CHARINDEX ('' '', ISNULL(MAX(b.NOMBRE),'' '')))+1, LEN(ISNULL(MAX(b.NOMBRE),'' '')))
	WHEN (SELECT LEN(ISNULL(MAX(b.NOMBRE),'' '')) - LEN(REPLACE(ISNULL(MAX(b.NOMBRE),'' ''), '' '', '''')))=0 THEN ISNULL(MAX(b.NOMBRE),'' '')
	ELSE SUBSTRING(ISNULL(MAX(b.NOMBRE),'' ''), CHARINDEX ('' '', ISNULL(MAX(b.NOMBRE),'' ''))+1, LEN(ISNULL(MAX(b.NOMBRE),'' '')))
	END, --- Nombres
	'''', 
	0, 
	ISNULL(MAX(b.NOMBRE),'' '')
	FROM dbo.TEMP_BCRA_PADFYJ_FALLECIDOS b WITH (NOLOCK) 
	WHERE  b.CUIL<40000000000 AND b.CUIL>19999999999 AND ISNUMERIC(b.CUIL)=1
	GROUP BY b.CUIL
   
    /* Se ingresan los registros a informar en el excel */
    INSERT INTO dbo.ITF_BCRA_PADFYJ_REPORTE (FECHA_PROCESO,HORA,USUARIO,ORIGEN,TIPO_DOCUMENTO_IDENTIFICATIVO,NUMERO_DOCUMENTO_IDENTIFICATIVO,NOMBRE_APELLIDO,TIPO_DOCUMENTO_FISICO,NUMERO_DOCUMENTO_FISICO,ACCION,MSG,TICKET)
	SELECT @V_FECHAPROCESO,@V_HORA, @P_USUARIO, ''BCRA'', ''CUIL'', b.CUIL, b.NOMBRE, ''DNI'', (SELECT SUBSTRING(CONVERT(VARCHAR(20),b.CUIL),3,8)), ''Alta'', ''Persona existente en el sistema. Fue ingresada correctamente.'',@P_TICKET 
	FROM dbo.TEMP_BCRA_PADFYJ_FALLECIDOS b WITH (NOLOCK) INNER JOIN CLI_DocumentosPFPJ d WITH (NOLOCK) ON d.NUMERODOCUMENTO=b.CUIL AND ((d.TZ_LOCK < 300000000000000 OR d.TZ_LOCK >= 400000000000000) AND (d.TZ_LOCK < 100000000000000 OR d.TZ_LOCK >= 200000000000000))
	AND b.CUIL<30000000000 AND b.CUIL>19999999999 AND ISNUMERIC(b.CUIL)=1 AND b.MARCA_FALLECIDO=1
	
	
	SET NOCOUNT OFF;	
   END


')


