EXECUTE('
ALTER PROCEDURE [dbo].[SP_GENERA_NRO_AVISO]
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS
BEGIN
DECLARE
@Anio NUMERIC(8)

DECLARE @TablaAuxiliar TABLE(
REGISTRO INT IDENTITY(1,1) NOT NULL,
NRO_CHEQUE NUMERIC(12),
SERIE VARCHAR(3),
SUCURSAL NUMERIC(5),
MONEDA NUMERIC(4),
PRODUCTO NUMERIC(5),
CUENTA NUMERIC(12),
REGISTROXSUC BIGINT
)

INSERT INTO @TablaAuxiliar
SELECT B.NRO_CHEQUE, B.SERIE_CHEQUE, B.SUCURSAL, B.MONEDA, B.PRODUCTO, B.CUENTA,
DENSE_RANK() OVER (PARTITION BY B.SUCURSAL ORDER BY B.NRO_CHEQUE, B.SERIE_CHEQUE, B.CUENTA ASC) AS REGISTROXSUC  
FROM CHE_BCO_RECHAZADOS B
WHERE (B.NRO_AVISO IS NULL OR B.NRO_AVISO = 0) 
		AND B.TZ_LOCK = 0 
		AND B.FECHA_CHEQUE <= 
								(SELECT FECHAPROCESO 
								FROM PARAMETROS) ORDER BY B.SUCURSAL

                  
SELECT @Anio = (DATEPART(YEAR, (SELECT FECHAPROCESO FROM PARAMETROS))%100)*1000000

DECLARE @contador_registros INT
DECLARE @contador_loop INT

SET @contador_loop = ISNULL((SELECT COUNT(*) FROM @TablaAuxiliar),0)
SET @contador_registros = 1

WHILE @contador_loop > 0 AND @contador_registros <= @contador_loop
BEGIN
IF(NOT EXISTS (SELECT VALOR FROM NUMERATORVALUES WHERE DIA = 0 AND MES = 0 AND ANIO = (SELECT YEAR(FECHAPROCESO) 
        FROM PARAMETROS) AND NUMERO = 3000 AND SUCURSAL IN ((SELECT SUCURSAL FROM @TablaAuxiliar WHERE REGISTRO = @contador_registros))))
        BEGIN
INSERT INTO NUMERATORVALUES (DIA,MES,ANIO,SUCURSAL,NUMERO,VALOR) VALUES
(0,0,(SELECT YEAR(FECHAPROCESO) FROM PARAMETROS),(SELECT SUCURSAL FROM @TablaAuxiliar WHERE REGISTRO = @contador_registros), 3000, 0)
END
SET @contador_registros = @contador_registros + 1 
END
                  
UPDATE dbo.CHE_BCO_RECHAZADOS
SET NRO_AVISO = @Anio + (	(SELECT VALOR 
							FROM NUMERATORVALUES 
							WHERE ANIO = (	SELECT YEAR(FECHAPROCESO) 
											FROM PARAMETROS) 
							AND NUMERO = 3000 
							AND SUCURSAL = A.SUCURSAL
							AND DIA = 0 
							AND MES = 0) + A.REGISTROXSUC)
FROM DBO.CHE_BCO_RECHAZADOS R
INNER JOIN @TablaAuxiliar A ON 
							R.SUCURSAL = A.SUCURSAL 
							AND R.SERIE_CHEQUE = A.SERIE
							AND R.NRO_CHEQUE = A.NRO_CHEQUE 
							AND R.MONEDA = A.MONEDA
							AND R.PRODUCTO = A.PRODUCTO
							AND R.CUENTA = A.CUENTA


UPDATE dbo.NUMERATORVALUES
SET VALOR = (SELECT VALOR 
				FROM NUMERATORVALUES 
				WHERE ANIO = (	SELECT YEAR(FECHAPROCESO) 
								FROM PARAMETROS) 
				AND NUMERO = 3000 
				AND SUCURSAL = T.SUCURSAL
				AND DIA = 0 
				AND MES = 0) + (SELECT MAX(REGISTROXSUC) FROM @TablaAuxiliar WHERE SUCURSAL = N.SUCURSAL)
FROM DBO.NUMERATORVALUES N
INNER JOIN @TablaAuxiliar T ON N.SUCURSAL = T.SUCURSAL 
							WHERE
							N.DIA = 0 
							AND N.MES = 0 
							AND N.ANIO = (SELECT YEAR(FECHAPROCESO) 
										FROM PARAMETROS) 
							AND NUMERO = 3000
							


      SET @P_RET_PROCESO = 1
      SET @P_MSG_PROCESO = ''Se agrego el nro de aviso correctamente''  
END


')