EXECUTE('
CREATE PROCEDURE [dbo].[PA_SEGUROSALDODEUDOR]  
   @P_ID_PROCESO float(53), /* Identificador de proceso*/
   @P_DT_PROCESO datetime2(0),  /* Fecha de proceso*/

   @P_RET_PROCESO float(53)  OUTPUT, /* Estado de ejecucion del PL/SQL(1:Correcto, 2: Error)*/
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS 
   BEGIN
      SET @P_RET_PROCESO = NULL
      SET @P_MSG_PROCESO = NULL
      
      
      ---- Dejo en estado procesado si ya cobre lo del mes
      UPDATE dbo.VTA_SEGURO_SALDO_DEUDOR SET ESTADO = ''P'' WHERE SALDO_JTS_OID IN 
      (SELECT SALDO_JTS_OID FROM MOVIMIENTOS_CONTABLES WITH(NOLOCK) WHERE
      OPERACION = 8680 AND COD_TRANSACCION=451 
      AND MONTH((SELECT FECHAPROCESO FROM PARAMETROS)) = MONTH(FECHAPROCESO)
      AND YEAR((SELECT FECHAPROCESO FROM PARAMETROS)) = YEAR((FECHAPROCESO)))
      
      ---- Dejo en estado sin procesar lo que no se pudo cobrar
      UPDATE dbo.VTA_SEGURO_SALDO_DEUDOR SET ESTADO = ''S'' WHERE SALDO_JTS_OID NOT IN 
      (SELECT SALDO_JTS_OID FROM MOVIMIENTOS_CONTABLES WITH(NOLOCK) WHERE
      OPERACION = 8680 AND COD_TRANSACCION=451 
      AND FECHAPROCESO = FECHA)
      AND FECHA < (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
	  
	  
	  --- Inserto en tabla auxiliar los datos a procesar por el PA
      INSERT INTO dbo.VTA_SEGURO_SALDO_DEUDOR (MAX_CUPO, SALDO_JTS_OID, MONEDA, SALDOACTUAL, MONTO_SEGURO, TASA_SEGURO, FECHA, ESTADO)
	  SELECT 
	  D.CUPO_SOBREGIRO AS MAX_CUPO,
	  S.JTS_OID,
      S.MONEDA,
      S.C1604 + S.C1683 + S.C1605 + S.C2627 + S.C50107 AS SALDOACTUAL,
      CASE 
      WHEN ((D.SALDO_CON_FECHA_VALOR_COBRO + D.CUPO_SOBREGIRO)*-1) < SEG.MONTO_MAXIMO THEN 
      ((D.SALDO_CON_FECHA_VALOR_COBRO + D.CUPO_SOBREGIRO)*-1)
      ELSE SEG.MONTO_MAXIMO END AS MONTO_SEGURO,
      C.TASA_SEGURO,
      (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)) AS FECHA,
      ''I'' AS ESTADO
      FROM SALDOS S WITH(NOLOCK)
      INNER JOIN GRL_SALDOS_DIARIOS D WITH(NOLOCK) ON S.JTS_OID = D.SALDOS_JTS_OID
      INNER JOIN CRE_SEGURO_SALDO_DEUDOR C WITH(NOLOCK) ON S.JTS_OID = C.SALDOS_JTS_OID
      INNER JOIN VW_CLI_X_DOC O WITH(NOLOCK) ON S.C1803 = O.CODIGOCLIENTE
      INNER JOIN CLI_PERSONASFISICAS P WITH(NOLOCK) ON O.NUMEROPERSONA = P.NUMEROPERSONAFISICA
      INNER JOIN CRE_PROD_SEGUROS_SALDO_DEUDOR SEG WITH(NOLOCK) ON SEG.TIPO = ''P'' AND SEG.CODIGO = S.PRODUCTO
      AND SEG.ASEGURADORA = C.ASEGURADORA 
      WHERE S.C1785 IN (2,3) 
      AND D.SALDO_CON_FECHA_VALOR_COBRO < 0
      AND (D.SALDO_CON_FECHA_VALOR_COBRO + D.CUPO_SOBREGIRO) < 0
      AND D.FECHA = (SELECT MAX(FECHA) FROM GRL_SALDOS_DIARIOS WITH(NOLOCK) WHERE SALDOS_JTS_OID = S.JTS_OID
      AND MONTH(DATEADD(MM,-1,(SELECT FECHAPROCESO FROM PARAMETROS))) = MONTH(FECHA)
      AND YEAR(DATEADD(MM,-1,(SELECT FECHAPROCESO FROM PARAMETROS))) = YEAR((FECHA)))
      AND S.JTS_OID NOT IN (SELECT SALDO_JTS_OID FROM MOVIMIENTOS_CONTABLES WITH(NOLOCK) WHERE
      OPERACION = 8680 AND COD_TRANSACCION=451 
      AND MONTH((SELECT FECHAPROCESO FROM PARAMETROS)) = MONTH(FECHAPROCESO)
      AND YEAR((SELECT FECHAPROCESO FROM PARAMETROS)) = YEAR((FECHAPROCESO)))
      AND S.JTS_OID NOT IN (SELECT SALDO_JTS_OID FROM VTA_SEGURO_SALDO_DEUDOR WITH(NOLOCK) WHERE FECHA = (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))
      AND DATEDIFF(YEAR,P.FECHANACIMIENTO,(SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))) BETWEEN SEG.EDAD_DESDE AND SEG.EDAD_HASTA
      

      SET @P_RET_PROCESO = 1
      SET @P_MSG_PROCESO = ''Cobro de seguro saldo deudor procesado correctamente''
      DECLARE
         @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION varchar(8000)
      EXECUTE dbo.PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
         @P_ID_PROCESO = @P_ID_PROCESO, 
         @P_FCH_PROCESO = @P_DT_PROCESO, 
        @P_NOM_PACKAGE = ''SEGUROSALDODEUDOR'', 
         @P_COD_ERROR = @P_RET_PROCESO, 
         @P_MSG_ERROR = @P_MSG_PROCESO, 
         @P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION
      SET @P_MSG_PROCESO = ''Se procesador ''+(SELECT CONVERT(VARCHAR(10),COUNT(1)) FROM dbo.VTA_SEGURO_SALDO_DEUDOR WITH(NOLOCK) WHERE ESTADO = ''I'' AND FECHA = (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK)))+'' saldos.''
      DECLARE
         @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$2 varchar(8000)
      EXECUTE dbo.PKG_LOG_PROCESO$PROC_INS_LOG_PROCESO 
         @P_ID_PROCESO = @P_ID_PROCESO, 
         @P_FCH_PROCESO = @P_DT_PROCESO, 
         @P_NOM_PACKAGE = ''SEGUROSALDODEUDOR'', 
         @P_COD_ERROR = @P_RET_PROCESO, 
         @P_MSG_ERROR = @P_MSG_PROCESO, 
         @P_TIPO_ERROR = @PKG_CONSTANTES$C_LOG_TIPO_INFORMACION$2
   END
')