EXECUTE('
IF OBJECT_ID (''dbo.VW_VINCULACIONES_DEUDAS'') IS NOT NULL
	DROP VIEW dbo.VW_VINCULACIONES_DEUDAS
')

EXECUTE('
CREATE VIEW dbo.VW_VINCULACIONES_DEUDAS 
([ID Vinculo], [Cliente Vinculado], [Nombre Vinculado],
[Cliente Vinculante], [Nombre Vinculante], Situacion, [Deuda Total],
[Tipo de relacion], [Descripcion Relacion], [Tipo de vinculo],
[Descripcion Vinculo]) AS
SELECT v.ID_VINCULO, CDV.CODIGOCLIENTE AS CLIENTE_VINCULADO, CDV.NOMBRECLIENTE AS NOMBRE_VINCULADO,
ISNULL(CXD.CODIGOCLIENTE,0) AS CLIENTE_VINCULANTE, ISNULL(CXD.NOMBRECLIENTE,'''') AS NOMBRE_VINCULANTE,
CLI.CATEGORIARESULTANTE AS SITUACION,
SUM(ISNULL(AD.SALDO_DEUDA,0)) AS DEUDA_TOTAL,
CV.TIPO_RELACION, OP.DESCRIPCION, CV.ID_VINCULO, CV.DESCRIPCION_VINCULO
FROM CRE_VINCULACIONES V WITH(NOLOCK)
INNER JOIN CRE_VINCULOS_RELACIONES CV WITH(NOLOCK) ON V.TIPO_RELACION = CV.TIPO_RELACION AND V.TIPO_VINCULO = CV.ID_VINCULO
INNER JOIN VW_CLI_X_DOC CDV WITH(NOLOCK) ON V.ID_PERSONA_VINCULADA = CDV.NUMEROPERSONA
INNER JOIN CLI_CLIENTES CLI WITH(NOLOCK) ON CDV.CODIGOCLIENTE = CLI.CODIGOCLIENTE
LEFT JOIN VW_CLI_X_DOC CXD WITH(NOLOCK) ON V.ID_PERSONA_VINCULANTE = CXD.NUMEROPERSONA
LEFT JOIN VW_DEUDA_CLIENTES AD WITH(NOLOCK) ON AD.CLIENTE = CDV.CODIGOCLIENTE AND AD.JTS_OID IN (SELECT JTS_OID FROM SALDOS WITH(NOLOCK) WHERE C1785 IN (1,5,6) AND TZ_LOCK=0)
LEFT JOIN OPCIONES OP WITH(NOLOCK) ON OP.NUMERODECAMPO = 44360 AND OP.IDIOMA = ''E'' AND OP.OPCIONINTERNA = CV.TIPO_RELACION
WHERE V.TZ_LOCK = 0 AND CV.TZ_LOCK = 0
AND (V.FECHA_FIN IS NULL OR 
CASE WHEN CV.PARAMETRO_613 = ''S'' THEN DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),V.FECHA_FIN)
ELSE V.FECHA_FIN END >= (SELECT FECHAPROCESO FROM PARAMETROS))
GROUP BY v.ID_VINCULO, CDV.CODIGOCLIENTE, CLI.CATEGORIARESULTANTE, CXD.CODIGOCLIENTE,
CV.TIPO_RELACION, CV.ID_VINCULO, CV.DESCRIPCION_VINCULO, OP.DESCRIPCION, CDV.NOMBRECLIENTE, CXD.NOMBRECLIENTE
')

