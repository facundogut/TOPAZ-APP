EXECUTE('
IF OBJECT_ID (''dbo.VW_POSICION_CLIENTES'') IS NOT NULL
	DROP VIEW dbo.VW_POSICION_CLIENTES
')

EXECUTE('
CREATE VIEW [dbo].[VW_POSICION_CLIENTES] AS 
SELECT TIPODOC AS ''Tipo'',NUMERODOC AS ''Nro Doc'', PAISDOCUMENTO AS ''Pais Doc'', NUMEROPERSONA AS ''Persona''
, CLASIFICACION AS ''Clasificacion'',SUM (DEUDA_EXIGIBLE) AS ''Deuda Exigible'',SUM(DEUDA_NO_EXIGIBLE) AS ''Deuda no Exigible'',SUM(DEUDA_TOTAL) ''Deuda Total'',SUM(DEUDA_CONTINGENTE) ''Deuda Contingente'',
CASE WHEN SUM(DEUDA_TOTAL) < SUM(DEUDA_CONTINGENTE) THEN SUM(DEUDA_CONTINGENTE) 
	 ELSE SUM(DEUDA_TOTAL) END AS ''Riesgo Total''
	 
FROM ( 
SELECT CASE WHEN CLASIFICACION=''L'' THEN ''Leasing''
	 WHEN CLASIFICACION IN (''A'',''O'') THEN ''CC''
	 WHEN CLASIFICACION=''D'' THEN ''Descuento Bancario''
	 WHEN CLASIFICACION=''T'' THEN ''Tarjeta de Crédito''
	 -- WHEN CLASIFICACION=''GO'' THEN ''Garantías Otorgadas''
	 ELSE ''Prestamos'' END AS CLASIFICACION,
	 CASE WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))> 0 THEN sum(S.C1685)
	 	  ELSE sum(SALDO_DEUDA) END AS DEUDA_EXIGIBLE,
	 SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0)) AS DEUDA_NO_EXIGIBLE,
	 sum(SALDO_DEUDA)+ SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0)) AS DEUDA_TOTAL,
	 CASE WHEN CLASIFICACION=''A'' THEN sum(vw.MONTOORIGEN)
	      WHEN CLASIFICACION=''T'' THEN sum(S.C1806)
	      ELSE 0 END AS DEUDA_CONTINGENTE,
	  vw.TIPODOC,vw.NUMERODOC, vw.PAISDOCUMENTO, vw.NUMEROPERSONA
FROM VW_DEUDA_CLIENTES vw
INNER JOIN SALDOS S WITH (nolock) ON S.JTS_OID=vw.JTS_OID
LEFT JOIN VW_ASISTENCIAS_DEUDA_NO_EXIGIBLE A ON A.SALDO_JTS_OID=vw.JTS_OID
WHERE vw.SALDO>0 --AND vw.NUMEROPERSONA=25067
GROUP BY vw.TIPODOC,vw.NUMERODOC, vw.PAISDOCUMENTO, vw.NUMEROPERSONA, CLASIFICACION
) T
GROUP BY TIPODOC,NUMERODOC, PAISDOCUMENTO, NUMEROPERSONA,CLASIFICACION
')
