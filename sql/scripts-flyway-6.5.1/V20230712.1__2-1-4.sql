EXECUTE('
IF OBJECT_ID (''dbo.VW_CARGOS_IMPUESTOS_IGARG830'') IS NOT NULL
	DROP VIEW dbo.VW_CARGOS_IMPUESTOS_IGARG830
	
IF OBJECT_ID (''dbo.ITF_AFIP_IGARG830'') IS NOT NULL
	DROP TABLE dbo.ITF_AFIP_IGARG830
	
IF OBJECT_ID (''dbo.SP_ITF_AFIP_IGARG830'') IS NOT NULL
	DROP PROCEDURE dbo.SP_ITF_AFIP_IGARG830
')

EXECUTE('

INSERT INTO dbo.ITF_MASTER (TZ_LOCK, ID, DESCRIPCION, OBJ_KETTLE, P0_MODO, P0_TIPO, P0_CAPTION, P0_CONSTANTE, P1_MODO, P1_TIPO, P1_CAPTION, P1_CONSTANTE, P2_MODO, P2_TIPO, P2_CAPTION, P2_CONSTANTE, P3_MODO, P3_TIPO, P3_CAPTION, P3_CONSTANTE, P4_MODO, P4_TIPO, P4_CAPTION, P4_CONSTANTE, P5_MODO, P5_TIPO, P5_CAPTION, P5_CONSTANTE, P6_MODO, P6_TIPO, P6_CAPTION, P6_CONSTANTE, P7_MODO, P7_TIPO, P7_CAPTION, P7_CONSTANTE, P8_MODO, P8_TIPO, P8_CONSTANTE, P8_CAPTION, P9_MODO, P9_TIPO, P9_CAPTION, P9_CONSTANTE, TIPO_OBJ, COMENTARIO, ID_REPORTE, MODO_EJECUCION)
VALUES (0, 139, ''AFIP IGARG830 2.1.4'', ''ITF_AFIP_IGARG830.kjb'', '''', '''', '''', '' '', '''', '''', '''', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', '' '', ''J'', '' '', 0, ''M'')

')

EXECUTE('
CREATE VIEW dbo.[VW_CARGOS_IMPUESTOS_IGARG830]
AS
SELECT ID_CARGO,descripcion, Moneda, TipoCargo, TASA, segmento FROM CI_CARGOS_TARIFAS CCT
JOIN 
(
  SELECT Id_cargo AS idCargo, DESCRIPCION, MONEDA_IMPORTE,TIPO_CARGO_IMPOSITIVO AS TipoCargo
  FROM CI_CARGOS
  WHERE TIPO_CARGO_IMPOSITIVO = 4
  UNION
  SELECT ID_IMPUESTO AS idCargo, DESCRIPCION, MONEDA_IMPORTE,TIPO_IMPUESTO AS TipoCargo
  FROM CI_IMPUESTOS
  WHERE TIPO_IMPUESTO = 4
) AS CargoImpuesto
ON CCT.Id_Cargo = CargoImpuesto.idCargo
WHERE id_cliente = 0 AND TZ_LOCK = 0
')
EXECUTE('

CREATE TABLE dbo.ITF_AFIP_IGARG830
	(
	ID             INT IDENTITY NOT NULL,
	PERIODO        NUMERIC (6) DEFAULT ((0)),
	CERTIFICADO    NUMERIC (14) DEFAULT ((0)),
	CUIT           NUMERIC (14) DEFAULT ((0)),
	RAZON_SOCIAL   VARCHAR (60) DEFAULT ('' ''),
	PERIODO_FISCAL NUMERIC (4) DEFAULT ((0)),
	PORCENTAJE     NUMERIC (6, 3) DEFAULT ((0)),
	RESOLUCION     VARCHAR (50) DEFAULT ('' ''),
	FECHA_DESDE    DATE,
	FECHA_HASTA    DATE,
	FECHA_PROCESO  DATETIME,
	CONSTRAINT PK_ITF_AFIP_IGARG830 PRIMARY KEY (ID)
	)
')
EXECUTE('
CREATE PROCEDURE dbo.[SP_ITF_AFIP_IGARG830]
--Fabio Menendez: 13/06/2023
	@reproceso VARCHAR(1),
	@periodo NUMERIC(8,0)
AS
BEGIN 

 CREATE TABLE #ClientesTmp2 (
    CODIGOCLIENTE NUMERIC(12),
    NUMEROPERSONA NUMERIC(12)
);   
--Logica de Reproceso
IF @reproceso=''S''
BEGIN

UPDATE c 
SET c.fecha_hasta = (SELECT FECHAPROCESO FROM PARAMETROS)
FROM CI_CARGOS_TARIFAS c 
WHERE  c.ID_CARGO IN (SELECT ID_CARGO FROM VW_CARGOS_IMPUESTOS_IGARG830 (nolock))
AND c.ID_CLIENTE IN (SELECT COD_CLIENTE FROM ITF_LOG_CARGOS_IMPUESTOS (nolock) WHERE FECHA_EJECUCION=@periodo);

DELETE FROM ITF_LOG_CARGOS_IMPUESTOS WHERE FECHA_EJECUCION=@periodo ;

END

--variables clave
DECLARE @cuit VARCHAR(11),@razonSocial VARCHAR(80), @fechaDesde DATETIME, @fechaHasta DATETIME, @porcentaje NUMERIC(7,4), @resGeneral VARCHAR(19), @tipoCertificado VARCHAR(11);

--var de cursor
DECLARE @C_idCargo NUMERIC(10), @C_descripcion VARCHAR (80), @C_tipoCargo NUMERIC(3), @C_tasa NUMERIC (4,4), @C_moneda NUMERIC(1)  ;		

--variables aux
DECLARE @codCli NUMERIC (10), @nroPersona NUMERIC(10), @condIVA VARCHAR(2);
DECLARE @inserts NUMERIC(6), @actualizados NUMERIC(6), @hayTemporales INT, @hayUpdate INT, @faltanCargos INT;
DECLARE @idCount INT = 1;

--recorro padron de entrada
SELECT @cuit = CUIT, @razonSocial = RAZON_SOCIAL, @fechaDesde = FECHA_DESDE, @fechaHasta = FECHA_HASTA, @porcentaje = PORCENTAJE
FROM ITF_AFIP_IGARG830 (nolock) WHERE ID=@idCount;

WHILE @cuit IS NOT NULL 
BEGIN	     	
  		--recorro clientes solo si la persona es titular
	INSERT INTO #ClientesTmp2 (CODIGOCLIENTE,NUMEROPERSONA)
	SELECT DISTINCT
	    cp.CODIGOCLIENTE,
	    cp.NUMEROPERSONA
	FROM CLI_DocumentosPFPJ pfj (nolock)
	JOIN CLI_ClientePersona cp (nolock) ON pfj.NUMEROPERSONAFJ = cp.NUMEROPERSONA
	WHERE cp.TZ_LOCK = 0 AND cp.TITULARIDAD = ''T'' AND pfj.NUMERODOCUMENTO = @cuit;
	
	   WHILE EXISTS (SELECT 1 FROM #ClientesTmp2)
		BEGIN 
		
		-- Obtener el siguiente registro de #ClientesTmp
	    SELECT TOP 1 @codCli = CODIGOCLIENTE, @nroPersona = NUMEROPERSONA FROM #ClientesTmp2;
	     	
			IF 0<(SELECT COUNT(1) FROM CI_CARGOS_TARIFAS c WHERE  c.ID_CLIENTE=@codCli AND c.tz_lock=0 AND c.TASA <> (SELECT (i.TASA-(i.TASA*@porcentaje/100)) FROM VW_CARGOS_IMPUESTOS_IGARG830 i WHERE i.ID_CARGO=c.ID_CARGO AND i.Moneda=c.Moneda AND i.segmento=c.segmento))
			BEGIN
			--grabo en bitacora el tipo de cargo dado de baja 
			INSERT INTO dbo.CON_BITACORA_IMPUESTOS (JTS_NOVEDAD, TIPO_NOVEDAD, FECHA_PROCESO, HORA, ID_CLIENTE, ID_PERSONA,TIPO_ID, CUIT, TIPO_CARGO_IMPOSITIVO, VALOR_EXCLUSION, FECHA_INICIO, FECHA_FIN)
			SELECT ISNULL((SELECT MAX(JTS_NOVEDAD) FROM CON_BITACORA_IMPUESTOS),0)+ (ROW_NUMBER() OVER (ORDER BY c.TIPOCARGO)), ''B'',(SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK)), (select convert(varchar,getdate(),108)), @codCli, @nroPersona, ''C'', @cuit, c.TIPOCARGO, (@porcentaje-(c.TASA*@porcentaje)), @fechaDesde, (SELECT FECHAPROCESO FROM PARAMETROS)
			FROM VW_CARGOS_IMPUESTOS_IGARG830 c INNER JOIN dbo.CI_CARGOS_TARIFAS t ON t.ID_CLIENTE=@codCli AND c.ID_CARGO=t.ID_CARGO
			WHERE t.tz_lock=0 AND t.ID_CLIENTE=@codCli AND
			c.ID_CARGO IN (
			SELECT i.ID_CARGO FROM VW_CARGOS_IMPUESTOS_IGARG830 i WHERE i.segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli) 
			) AND c.segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli)
			GROUP BY c.TIPOCARGO, c.TASA
			END
			
			--doy de baja los cargos vigentes
			UPDATE dbo.CI_CARGOS_TARIFAS
			SET FECHA_HASTA = (SELECT FECHAPROCESO FROM PARAMETROS)
			WHERE ID_CLIENTE=@codCli AND tz_lock=0 AND  
			 ID_CARGO  IN (
			SELECT ID_CARGO VW_CARGOS_IMPUESTOS_IGARG830 WHERE segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli) 
			)
			
			
			--inserto en el log 1 reg 
			INSERT INTO dbo.ITF_LOG_CARGOS_IMPUESTOS (COD_IMPUESTO,PERIODO_DESDE,  PERIODO_HASTA, COD_CLIENTE, ID_PERSONA, FECHA_PROCESO, FECHA_EJECUCION, CONDICION, ALICUOTA)
			SELECT TOP 1 c.TIPOCARGO, CONVERT(VARCHAR(8), @fechaDesde, 112), CONVERT(VARCHAR(8), @fechaHasta, 112),@codCli, @nroPersona, CONVERT(VARCHAR(8), (SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK)), 112), @periodo,'''',(@porcentaje-(c.TASA*@porcentaje))
			FROM VW_CARGOS_IMPUESTOS_IGARG830 c 
			WHERE c.segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli)
			GROUP BY c.TIPOCARGO, c.TASA
			
			
			
			--inserto en bitacora el alta
			INSERT INTO dbo.CON_BITACORA_IMPUESTOS (JTS_NOVEDAD, TIPO_NOVEDAD, FECHA_PROCESO, HORA, ID_CLIENTE, ID_PERSONA,TIPO_ID, CUIT, TIPO_CARGO_IMPOSITIVO, VALOR_EXCLUSION, FECHA_INICIO, FECHA_FIN)
			SELECT ISNULL((SELECT MAX(JTS_NOVEDAD) FROM CON_BITACORA_IMPUESTOS),0)+ (ROW_NUMBER() OVER (ORDER BY c.TIPOCARGO)),''A'', (SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK)), (select convert(varchar,getdate(),108)), @codCli, @nroPersona, ''C'', @cuit, c.TIPOCARGO, (@porcentaje-(c.TASA*@porcentaje)), @fechaDesde, @fechaHasta
			FROM VW_CARGOS_IMPUESTOS_IGARG830 c
			WHERE 
			c.ID_CARGO IN  (
			SELECT ID_CARGO FROM VW_CARGOS_IMPUESTOS_IGARG830 i WHERE i.segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli) 
			) AND c.segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli)
			GROUP BY c.TIPOCARGO, c.TASA 
			
			--update temporales existentes			
			UPDATE c 
			SET c.fecha_hasta = @fechaHasta, c.TASA = (@porcentaje -((SELECT TASA FROM VW_CARGOS_IMPUESTOS_IGARG830 WHERE ID_CARGO=c.ID_CARGO AND MONEDA=c.Moneda AND segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli) )*@porcentaje))
			FROM CI_CARGOS_TARIFAS c
			WHERE c.id_cliente = @codCli AND c.TZ_LOCK = 0 AND c.ID_CARGO IN (
			SELECT ID_CARGO FROM VW_CARGOS_IMPUESTOS_IGARG830 i WHERE i.segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli) 
			)
			
			--inserto los certificados que no tiene				 
			INSERT INTO dbo.CI_CARGOS_TARIFAS (ID_CARGO, MONEDA, ID_CLIENTE, SEGMENTO, FECHA_DESDE, FECHA_HASTA, TASA) 
			SELECT ID_CARGO, MONEDA, @codCli, segmento, @fechaDesde, @fechaHasta, (@porcentaje-(TASA*@porcentaje))
			FROM VW_CARGOS_IMPUESTOS_IGARG830 WHERE ID_CARGO NOT IN (SELECT ID_CARGO FROM  CI_CARGOS_TARIFAS WHERE id_cliente = @codCli  AND TZ_LOCK = 0  AND ID_CARGO IN (
			SELECT ID_CARGO FROM VW_CARGOS_IMPUESTOS_IGARG830 i WHERE i.segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli) 
			)) AND segmento=(SELECT IGA FROM CLI_CLIENTES WHERE TZ_LOCK=0 AND CODIGOCLIENTE=@codCli)
					 		   
		
		-- Eliminar el registro procesado
    	DELETE FROM #ClientesTmp2 WHERE CODIGOCLIENTE = @codCli AND NUMEROPERSONA = @nroPersona;
		END --Fin del WHILE    	
	      
  		
   				   
		SET @idCount = @idCount+1;
		SET @cuit = NULL;
		SELECT @cuit = CUIT, @razonSocial = RAZON_SOCIAL, @fechaDesde = FECHA_DESDE, @fechaHasta = FECHA_HASTA, @porcentaje = PORCENTAJE
		FROM ITF_AFIP_IGARG830 (nolock) WHERE ID=@idCount;

	
END
DROP TABLE #ClientesTmp2;

END



')

