EXECUTE('
UPDATE PRODUCTOS SET C6253=''E'' WHERE C6252=5 AND TZ_LOCK=0
')

EXECUTE('
UPDATE TOPESPRODUCTO SET TIPO_TASA_BASE=''ND'' WHERE CODPRODUCTO IN (SELECT C6250 FROM PRODUCTOS WHERE C6252=6) 
UPDATE TOPESPRODUCTO SET TIPO_TASA_BASE=''BAN'' WHERE CODPRODUCTO IN (SELECT C6250 FROM PRODUCTOS WHERE C6252=1 AND C6800 IN (''A'', ''S'') ) 
')

EXECUTE('
ALTER TABLE TASASBASE ADD TASA_CONVERTIDA NUMERIC(11,7)
ALTER TABLE CRE_SALDOS ADD PUNTOS_CONVERTIDOS NUMERIC(11,7) 
ALTER TABLE CRE_SALDOS ADD TASA_CONVERTIDA NUMERIC(11,7) 
ALTER TABLE VTA_TASAS_BASE_HISTORICO ADD TASA_CONVERTIDA NUMERIC(11,7)
')

EXECUTE('
INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (44353, '' '', 0, ''Tasa Convertida'', ''Tasa Convertida'', 11, ''N'', 7, ''I'', 0, 0, 0, 0, 0, 0, 0, 62, ''TASA_CONVERTIDA'', 0, NULL)

INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (44357, '' '', 0, ''Tasa Convertida'', ''Tasa Convertida'', 11, ''N'', 7, ''I'', 0, 0, 0, 0, 0, 0, 0, 149, ''TASA_CONVERTIDA'', 0, NULL)

INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (44355, '' '', 0, ''Puntos Convertidos'', ''Puntos Convertidos'', 11, ''N'', 7, ''I'', 0, 0, 0, 0, 0, 0, 0, 4311, ''PUNTOS_CONVERTIDOS'', 0, NULL)

INSERT INTO dbo.DICCIONARIO (NUMERODECAMPO, USODELCAMPO, REFERENCIA, DESCRIPCION, PROMPT, LARGO, TIPODECAMPO, DECIMALES, EDICION, CONTABILIZA, CONCEPTO, CALCULO, VALIDACION, TABLADEVALIDACION, TABLADEAYUDA, OPCIONES, TABLA, CAMPO, BASICO, MASCARA)
VALUES (44356, '' '', 0, ''Tasa Convertida'', ''Tasa Convertida'', 11, ''N'', 7, ''I'', 0, 0, 0, 0, 0, 0, 0, 4311, ''TASA_CONVERTIDA'', 0, NULL)

INSERT INTO dbo.REPORTES (TITULO, IDENTIFICACION, DESCRIPCION, TIPO, BIGREPORT, TIPOSALIDA, GENERAREPORTE, GENERAONLINEREPORTE, GRUPO_REIMPRESION, EJ_DE_OPERACION)
VALUES (9000, 7479, ''Ticket comprobante de caja'', ''C'', 0, NULL, 0, 0, 0, ''N'')
')

EXECUTE('
DROP PROCEDURE IF EXISTS SP_CONVERSION_TASA 
')

EXECUTE('
CREATE PROCEDURE SP_CONVERSION_TASA 
	@PERIODO_ASIST NUMERIC(5), 
	@C1632 NUMERIC(11,7),
	@C6253 VARCHAR(1),
	@C6255 NUMERIC(5,0),
    @RESULTADO NUMERIC(11,7) OUTPUT
AS
BEGIN

SELECT @RESULTADO=dbo.CONVERSION_TASA (@PERIODO_ASIST, @C1632, @C6253, @C6255)

END
')

EXECUTE('
DROP FUNCTION IF EXISTS dbo.CONVERSION_TASA
')

EXECUTE('
CREATE FUNCTION dbo.CONVERSION_TASA (@PERIODO_ASIST NUMERIC(10), @C1632 NUMERIC(11,7),
@C6253 VARCHAR(1),@C6255 NUMERIC(5,0))
RETURNS NUMERIC(11,7)
AS
-- Recibe de la tabla Saldos: JTS_OID, TEA y PRODUCTO.
-- Luego obtiene los datos necesarios para realizar el cálculo del TNA.
BEGIN
	
    -- Inicializar TNA = 0 en caso de error
    DECLARE @TASA NUMERIC(11,7);
    SET @TASA = 0;
	
    -- Declaración de variables
	DECLARE @PERIODO NUMERIC(10,5);
    
        -- Obtener el periodo promedio
    SET @PERIODO = round(@C6255/@PERIODO_ASIST,5,1) -- Truncar, NO redondear a 5 decimales

    -- Calcular TNA: Sólo si es tipo efectiva se realiza la conversión a nominal
    IF @PERIODO IS NOT NULL AND @C6253 IS NOT NULL AND @C6255 IS NOT NULL
    BEGIN
        IF @C6253 = ''E''
        BEGIN
            SET @TASA = (CAST(@C6255 AS NUMERIC(11,7)) / @PERIODO) * 
                       (POWER((1 + (@C1632 / 100)), (1 / (CAST(@C6255 AS NUMERIC(11,7)) / @PERIODO))) - 1) * 100;
        END
        ELSE IF @C6253 = ''N''
        BEGIN
            SET @TASA = ROUND(CAST((POWER((1 + CAST((@C1632)AS NUMERIC(11,7)) / (@C6255 *100)*@PERIODO), ((CAST(@C6255 AS NUMERIC(11,7)) / @PERIODO))) - 1) * 100 AS NUMERIC(11,7)),4,1)
            			
        END
    END

    RETURN @TASA;
END;
')