EXECUTE('
---
IF OBJECT_ID (''dbo.VW_TRANSACCIONES_POR_PERSONA'') IS NOT NULL
	DROP VIEW dbo.VW_TRANSACCIONES_POR_PERSONA
---
')
EXECUTE('
CREATE VIEW VW_TRANSACCIONES_POR_PERSONA (
	/*VISTA AUXILIAR QUE NOS AYUDA A CONTAR LAS TRANSACCIONES QUE LA PERSONA SUMARÍA EN LAS OPERACIONES
	300 DE INHABILITACIÓN Y 400 DE REHABILITACIÓN RESPECTIVAMENTE PARA CALCULAR SI SUPERARÍA EL LÍMITE
	ESTABLECIDO DE TRANSACCIONES POR EJECUCIÓN O NO*/
	
	NUMERO_PERSONA,
	TIPO_PERSONA,
	TR_INHABILITACION,
	TR_HABILITACION)
AS
	SELECT 
		NUMEROPERSONA,
		TIPOPERSONA,
		TR_INHABILITACION,
		TR_HABILITACION 
	FROM(
		SELECT 
			P.NUMEROPERSONAFISICA AS NUMEROPERSONA,
			''F'' AS TIPOPERSONA,
			(SELECT
				((1)+
				(1*(count(DISTINCT(PF.NUMEROPERSONAFISICA))))+
				((5*(count(DISTINCT(IPJ.NUMEROPERSONAJURIDICA))))+1)+
				(3*(count(DISTINCT(CP.CODIGOCLIENTE))))+
				((3*(count(DISTINCT(S.JTS_OID))))+1)+
				((5*(count(DISTINCT(CP2.CODIGOCLIENTE))))+1)+
				((3*(count(DISTINCT(S2.JTS_OID))))+1)+
				((3*(SELECT count(*) FROM (
					SELECT DISTINCT ID_ENTIDAD, TIPO_PODER, TIPO_ENTIDAD, ID_PERSONA
					FROM PYF_APODERADOS WITH (nolock)
					WHERE ID_PERSONA = PF.NUMEROPERSONAFISICA
						AND ( (tz_lock < 300000000000000 OR tz_lock >= 400000000000000) )
					) AS R))+1)
				) AS TR_INHAB_PF
			FROM 
				CLI_PERSONASFISICAS AS PF WITH (nolock)
			LEFT JOIN CLI_INTEGRANTESPJ AS IPJ WITH (nolock) ON
				IPJ.NUMEROPERSONAFISICA = PF.NUMEROPERSONAFISICA
				AND ( (IPJ.tz_lock < 300000000000000 OR IPJ.tz_lock >= 400000000000000) )
			LEFT JOIN CLI_CLIENTEPERSONA AS CP WITH (nolock) ON
				CP.NUMEROPERSONA = IPJ.NUMEROPERSONAJURIDICA
				AND ( (CP.tz_lock < 300000000000000 OR CP.tz_lock >= 400000000000000) )
			LEFT JOIN SALDOS AS S WITH (nolock) ON
				S.C1803 = CP.CODIGOCLIENTE
				AND ( (S.tz_lock < 300000000000000 OR S.tz_lock >= 400000000000000) )
			LEFT JOIN CLI_CLIENTEPERSONA AS CP2 WITH (nolock) ON
				CP2.NUMEROPERSONA = PF.NUMEROPERSONAFISICA
				AND ( (CP2.tz_lock < 300000000000000 OR CP2.tz_lock >= 400000000000000) )
			LEFT JOIN SALDOS AS S2 WITH (nolock) ON
				S2.C1803 = CP2.CODIGOCLIENTE
				AND ( (S2.tz_lock < 300000000000000 OR S2.tz_lock >= 400000000000000) )
			WHERE  
				( (PF.tz_lock < 300000000000000 OR PF.tz_lock >= 400000000000000) )
				AND PF.NUMEROPERSONAFISICA = P.NUMEROPERSONAFISICA
			GROUP BY
				PF.NUMEROPERSONAFISICA 
			) AS TR_INHABILITACION,
			(SELECT
				((2)+
				(1*(count(DISTINCT(PF.NUMEROPERSONAFISICA))))+
				((5*(count(DISTINCT(IPJ.NUMEROPERSONAJURIDICA))))+1)+
				((5*(count(DISTINCT(CP.CODIGOCLIENTE))))+1)+
				--+1 SI pj NO TIENE INTEGRANTES INHAB Y CLIENTE NO TIENE TITULARES INHAB
				((4*(count(DISTINCT CONCAT_WS(''-'', B.SALDO_JTS_OID, B.CODIGO_BLOQUEO, B.ORDINAL_BLOQUEO))))+1)+
				--+1 SI EL SALDO NO TIENE OTROS BLOQUEOS ACTIVOS DISTINTO DE CODIGO 48
				((5*(count(DISTINCT(CP2.CODIGOCLIENTE))))+1)+
				--+1 SI EL CLIENTE NO TIENE OTROS TITULARES INHAB
				((4*(count(DISTINCT CONCAT_WS(''-'', B2.SALDO_JTS_OID, B2.CODIGO_BLOQUEO, B2.ORDINAL_BLOQUEO))))+1)+
				--+1 SI EL SALDO NO TIENE OTROS BLOQUEOS ACTIVOS DISTINTO DE CODIGO 48
				--((4*(count(DISTINCT CONCAT_WS(''-'', ID_ENTIDAD, TIPO_PODER, TIPO_ENTIDAD, ID_PERSONA))))+1)
				((4*(SELECT count(*) FROM (
					SELECT DISTINCT ID_ENTIDAD, TIPO_PODER, TIPO_ENTIDAD, ID_PERSONA
					FROM PYF_APODERADOS WITH (nolock)
					WHERE ID_PERSONA = PF.NUMEROPERSONAFISICA
						AND (ID_CLIENTE_SALDO IS NOT NULL AND ID_CLIENTE_SALDO NOT IN ('''', '' ''))
						AND ( (tz_lock < 300000000000000 OR tz_lock >= 400000000000000) )
					) AS R))+1)
				) AS TR_HAB_PF
			FROM 
				CLI_PERSONASFISICAS AS PF WITH (nolock)
			LEFT JOIN CLI_INTEGRANTESPJ AS IPJ WITH (nolock) ON
				IPJ.NUMEROPERSONAFISICA = PF.NUMEROPERSONAFISICA
				AND ( (IPJ.tz_lock < 300000000000000 OR IPJ.tz_lock >= 400000000000000) )
			LEFT JOIN CLI_CLIENTEPERSONA AS CP WITH (nolock) ON
				CP.NUMEROPERSONA = IPJ.NUMEROPERSONAJURIDICA
				AND ( (CP.tz_lock < 300000000000000 OR CP.tz_lock >= 400000000000000) )
			LEFT JOIN VW_BLOQUEOS_POR_CLIENTE AS B WITH (nolock) ON
				B.CODIGO_CLIENTE = CP.CODIGOCLIENTE
				AND B.CODIGO_BLOQUEO = 48
			LEFT JOIN CLI_CLIENTEPERSONA AS CP2 WITH (nolock) ON
				CP2.NUMEROPERSONA = PF.NUMEROPERSONAFISICA
				AND ( (CP2.tz_lock < 300000000000000 OR CP2.tz_lock >= 400000000000000) )
			LEFT JOIN VW_BLOQUEOS_POR_CLIENTE AS B2 WITH (nolock) ON
				B2.CODIGO_CLIENTE = CP2.CODIGOCLIENTE
				AND B2.CODIGO_BLOQUEO = 48
			WHERE  
				( (PF.tz_lock < 300000000000000 OR PF.tz_lock >= 400000000000000) )
				AND PF.NUMEROPERSONAFISICA = P.NUMEROPERSONAFISICA
			GROUP BY
				PF.NUMEROPERSONAFISICA		
			) AS TR_HABILITACION 		
		FROM
			CLI_PERSONASFISICAS AS P WITH (nolock)
		WHERE ( (P.tz_lock < 300000000000000 OR P.tz_lock >= 400000000000000) )
			
		UNION ALL
		
		SELECT 
			P.NUMEROPERSONAJURIDICA AS NUMEROPERSONA,
			''J'' AS TIPOPERSONA,
			(SELECT
				((1)+
				(1*(count(DISTINCT(PJ.NUMEROPERSONAJURIDICA))))+
				((5*(count(DISTINCT(IPJ.NUMEROPERSONAJURIDICA))))+1)+
				(3*(count(DISTINCT(CP.CODIGOCLIENTE))))+
				((3*(count(DISTINCT(S.JTS_OID))))+1)+
				((5*(count(DISTINCT(CP2.CODIGOCLIENTE))))+1)+
				((3*(count(DISTINCT(S2.JTS_OID))))+1)+
				((3*(SELECT count(*) FROM (
					SELECT DISTINCT ID_ENTIDAD, TIPO_PODER, TIPO_ENTIDAD, ID_PERSONA
					FROM PYF_APODERADOS WITH (nolock)
					WHERE ID_PERSONA = PJ.NUMEROPERSONAJURIDICA
						AND ( (tz_lock < 300000000000000 OR tz_lock >= 400000000000000) )
					) AS R))+1)
				) AS TR_INHAB_PJ
			FROM 
				CLI_PERSONASJURIDICAS AS PJ WITH (nolock)
			LEFT JOIN CLI_INTEGRANTESPJ AS IPJ WITH (nolock) ON
				IPJ.NUMEROPERSONAFISICA = PJ.NUMEROPERSONAJURIDICA
				AND ( (IPJ.tz_lock < 300000000000000 OR IPJ.tz_lock >= 400000000000000) )
			LEFT JOIN CLI_CLIENTEPERSONA AS CP WITH (nolock) ON
				CP.NUMEROPERSONA = IPJ.NUMEROPERSONAJURIDICA
				AND ( (CP.tz_lock < 300000000000000 OR CP.tz_lock >= 400000000000000) )
			LEFT JOIN SALDOS AS S WITH (nolock) ON
				S.C1803 = CP.CODIGOCLIENTE
				AND ( (S.tz_lock < 300000000000000 OR S.tz_lock >= 400000000000000) )
			LEFT JOIN CLI_CLIENTEPERSONA AS CP2 WITH (nolock) ON
				CP2.NUMEROPERSONA = PJ.NUMEROPERSONAJURIDICA
				AND ( (CP2.tz_lock < 300000000000000 OR CP2.tz_lock >= 400000000000000) )
			LEFT JOIN SALDOS AS S2 WITH (nolock) ON
				S2.C1803 = CP2.CODIGOCLIENTE
				AND ( (S2.tz_lock < 300000000000000 OR S2.tz_lock >= 400000000000000) )
			WHERE  
				( (PJ.tz_lock < 300000000000000 OR PJ.tz_lock >= 400000000000000) )
				AND PJ.NUMEROPERSONAJURIDICA = P.NUMEROPERSONAJURIDICA
			GROUP BY
				PJ.NUMEROPERSONAJURIDICA 
			) AS TR_INHABILITACION,
			(SELECT 
				((2)+
				((5*(count(DISTINCT(CP.CODIGOCLIENTE))))+1)+
				--+1 SI CLIENTE NO TIENE TITULARES INHAB
				((4*(count(DISTINCT CONCAT_WS(''-'', B.SALDO_JTS_OID, B.CODIGO_BLOQUEO, B.ORDINAL_BLOQUEO))))+1)+
				--+1 SI EL SALDO NO TIENE OTROS BLOQUEOS ACTIVOS DISTINTO DE CODIGO 48
				((4*(SELECT count(*) FROM (
					SELECT DISTINCT ID_ENTIDAD, TIPO_PODER, TIPO_ENTIDAD, ID_PERSONA
					FROM PYF_APODERADOS WITH (nolock)
					WHERE ID_PERSONA = PJ.NUMEROPERSONAJURIDICA
						AND (ID_CLIENTE_SALDO IS NOT NULL AND ID_CLIENTE_SALDO NOT IN ('''', '' ''))
						AND ( (tz_lock < 300000000000000 OR tz_lock >= 400000000000000) )
					) AS R))+1) 
				) AS TR_HAB_PJ
			FROM 
				CLI_PERSONASJURIDICAS AS PJ WITH (nolock)
			LEFT JOIN CLI_CLIENTEPERSONA AS CP WITH (nolock) ON
				CP.NUMEROPERSONA = PJ.NUMEROPERSONAJURIDICA
				AND ( (CP.tz_lock < 300000000000000 OR CP.tz_lock >= 400000000000000) )
			LEFT JOIN VW_BLOQUEOS_POR_CLIENTE AS B WITH (nolock) ON
				B.CODIGO_CLIENTE = CP.CODIGOCLIENTE
				AND B.CODIGO_BLOQUEO = 48
			WHERE  
				( (PJ.tz_lock < 300000000000000 OR PJ.tz_lock >= 400000000000000) )
				AND PJ.NUMEROPERSONAJURIDICA = P.NUMEROPERSONAJURIDICA
			GROUP BY
				PJ.NUMEROPERSONAJURIDICA	
			) AS TR_HABILITACION 		
		FROM
			CLI_PERSONASJURIDICAS AS P WITH (nolock)
		WHERE ( (P.tz_lock < 300000000000000 OR P.tz_lock >= 400000000000000) )
		
		) T
')

