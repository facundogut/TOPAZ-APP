EXECUTE('
----
IF OBJECT_ID (''dbo.VW_CORRIMIENTO_VTO_DPF'') IS NOT NULL
	DROP VIEW dbo.VW_CORRIMIENTO_VTO_DPF
----
')
EXECUTE('
----
CREATE VIEW [dbo].[VW_CORRIMIENTO_VTO_DPF](
	SUCURSAL,
	CUENTA,
	NOMBRE,
	PRODUCTO,
	DESCRIPCIONPRODUCTO,
	MONEDA,
	DESCRIPCIONMONEDA,
	CLIENTE
) 
AS
SELECT
	S.SUCURSAL,
	S.CUENTA,
	CL.NOMBRECLIENTE,
	S.PRODUCTO,
	P.C6251,
	S.MONEDA,
	M.C6400,
	S.C1803
FROM SALDOS AS S WITH (nolock)
INNER JOIN CLI_CLIENTES AS CL WITH (nolock) ON
	CL.CODIGOCLIENTE = S.C1803
	AND CL.TZ_LOCK = 0
INNER JOIN PRODUCTOS AS P WITH (nolock) ON
	P.C6250 = S.PRODUCTO
	AND P.TZ_LOCK = 0
INNER JOIN MONEDAS AS M WITH (nolock) ON
	M.C6399 = S.MONEDA
	AND M.TZ_LOCK = 0
INNER JOIN (
	SELECT 
		DATEPART(DD, P.FECHA) AS DIA,
		DATEPART(MM, P.FECHA) AS MES,
		DATEPART(YY, P.FECHA) AS ANIO, 
		P.SUCURSAL,
		-1 AS REGION,
		''P'' AS TIPO
	FROM PAROS AS P WITH (nolock)
	WHERE
		P.TZ_LOCK = 0

	UNION ALL

	SELECT
		F.DIA,
		F.MES,
		F.ANIO,
		F.SUCURSAL,
		F.REGION,
		CASE F.TIPO
			WHEN ''S'' THEN ''S''
			ELSE ''F''
		END AS TIPO
	FROM FERIADOS AS F WITH (nolock)
	WHERE
		F.TZ_LOCK = 0
		AND (F.PAIS = 0 
				OR F.PAIS = (
							SELECT NUMERICO 
							FROM PARAMETROSGENERALES WITH (nolock)
							WHERE 
								CODIGO = 1 
								AND TZ_LOCK = 0	)
		)
) AS PAROS_FERIADOS ON
	((S.C1659 = ''N'' AND PAROS_FERIADOS.TIPO = ''P'') OR (PAROS_FERIADOS.TIPO <> ''P'')) 
	AND (
		(PAROS_FERIADOS.TIPO IN (''P'',''F'')
		AND	(CONCAT(CAST(ISNULL(NULLIF(PAROS_FERIADOS.ANIO, 0), DATEPART(YY, S.C1627)) AS VARCHAR(4))+''-'',
					dbo.AGREGOCEROS(CAST(ISNULL(NULLIF(PAROS_FERIADOS.MES, 0), DATEPART(MM, S.C1627)) AS VARCHAR(2)), 2)+''-'',
					dbo.AGREGOCEROS(CAST(ISNULL(NULLIF(PAROS_FERIADOS.DIA, 0), DATEPART(DD, S.C1627)) AS VARCHAR(2)), 2)
				) = CONVERT(VARCHAR, S.C1627, 23)
			)
		)
		OR
		(PAROS_FERIADOS.TIPO = ''S''
		AND (((@@datefirst + datepart(weekday, S.C1627) + 1 ) % 7 ) + 1 = PAROS_FERIADOS.DIA)
		)
	)
	AND (PAROS_FERIADOS.SUCURSAL = S.SUCURSAL 
		OR PAROS_FERIADOS.SUCURSAL = -1	)
	AND (PAROS_FERIADOS.REGION = (	SELECT REGION_FERIADOS 
									FROM SUCURSALESSC WITH (nolock)
									WHERE 
										SUCURSAL = S.SUCURSAL
										AND TZ_LOCK = 0	)
		OR PAROS_FERIADOS.REGION = -1	)
WHERE 
	S.C1785 = 4
	AND S.C1604 > 0
	AND S.TZ_LOCK = 0
----
')