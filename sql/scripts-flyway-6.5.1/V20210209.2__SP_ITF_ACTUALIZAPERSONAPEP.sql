EXECUTE('DROP PROCEDURE IF EXISTS dbo.SP_ITF_ACTUALIZAPERSONA_PEP;')
EXECUTE('
CREATE PROCEDURE dbo.SP_ITF_ACTUALIZAPERSONA_PEP 
   @P_TIPO_PERSONA VARCHAR(1),
   @P_NUMPER NUMERIC(12,0),
   @P_INCL_PEP VARCHAR(1),
   @P_TICKET NUMERIC(12),
   @P_FECHA DATETIME,
   @P_CUIT VARCHAR(11),
   @P_NOMBRE VARCHAR(50),
   @P_ASIENTO NUMERIC(10)
AS 
   /*Generated by SQL Server Migration Assistant for Oracle version 7.9.0.*/
   BEGIN
   
   DECLARE @flag INT;
   DECLARE @accion VARCHAR(10);
   SET @accion = (CASE WHEN @P_INCL_PEP = ''N'' THEN ''DESMARCADO'' ELSE ''MARCADO'' END);
	  
      IF @P_TIPO_PERSONA = ''F''
      	BEGIN
      		SET @flag = (SELECT COUNT(*) FROM CLI_PERSONASFISICAS WHERE NUMEROPERSONAFISICA = @P_NUMPER AND ESTADO = 0 AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) AND (TZ_LOCK = 0 OR TZ_LOCK >= 200000000000000)));
      		IF @flag = 1
      			BEGIN
      				UPDATE CLI_PERSONASFISICAS SET INCLUIDO_PEP = @P_INCL_PEP
      				WHERE NUMEROPERSONAFISICA = @P_NUMPER
      				
      				INSERT INTO ITF_HIST_PEP (FECHA, ID_TICKET, CUIT, DESCR, ACCION, NOMBRE) VALUES (@P_FECHA, @P_TICKET, @P_CUIT, @accion, @P_INCL_PEP, @P_NOMBRE);
      				
      				/* Dependiendo del tipo de persona grabo Tabla BITACORA_PERSONAS_FISICAS o BITACORA_PERSONAS_JURIDICAS */
	      			EXEC dbo.SP_ITF_GRABO_BITACORA_PERSONAS @P_NUMPER, @P_TIPO_PERSONA, @P_ASIENTO;
      			END
      		ELSE
      			BEGIN
      				INSERT INTO ITF_HIST_PEP (FECHA, ID_TICKET, CUIT, DESCR, ACCION, NOMBRE) VALUES (@P_FECHA, @P_TICKET, @P_CUIT, ''Persona inhabilitada. Cambio no realizado.'', @P_INCL_PEP, @P_NOMBRE);
      			END
      		
      		
      	END
      	
      ELSE
      	BEGIN
      		SET @flag = (SELECT COUNT(*) FROM CLI_PERSONASJURIDICAS WHERE NUMEROPERSONAJURIDICA = @P_NUMPER AND ESTADO = 0 AND ((TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000) AND (TZ_LOCK = 0 OR TZ_LOCK >= 200000000000000)));
      		
      		IF @flag = 1
      			BEGIN
      				UPDATE CLI_PERSONASJURIDICAS SET INCL_PEPS = @P_INCL_PEP  
      				WHERE NUMEROPERSONAJURIDICA = @P_NUMPER;
      				
      				INSERT INTO ITF_HIST_PEP (FECHA, ID_TICKET, CUIT, DESCR, ACCION, NOMBRE) VALUES (@P_FECHA, @P_TICKET, @P_CUIT, @accion, @P_INCL_PEP, @P_NOMBRE);
      				
      				/* Dependiendo del tipo de persona grabo Tabla BITACORA_PERSONAS_FISICAS o BITACORA_PERSONAS_JURIDICAS */
	      			EXEC dbo.SP_ITF_GRABO_BITACORA_PERSONAS @P_NUMPER, @P_TIPO_PERSONA, @P_ASIENTO;
      			END
      		ELSE
      			BEGIN
      				INSERT INTO ITF_HIST_PEP (FECHA, ID_TICKET, CUIT, DESCR, ACCION, NOMBRE) VALUES (@P_FECHA, @P_TICKET, @P_CUIT, ''Persona inhabilitada. Cambio no realizado.'', @P_INCL_PEP, @P_NOMBRE);
      			END
      		
			    	
      	END      	
   END;')

