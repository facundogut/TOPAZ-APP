Execute('
CREATE OR ALTER PROCEDURE [dbo].[SP_CONTROL_BAJAS_ABMC_2] 
	@campoIN AS VARCHAR(20), 
	@valor AS VARCHAR(20), 
	@campoIN2 AS VARCHAR(20),
	@valor2 AS VARCHAR(20), 
	@resultado AS NUMERIC(10,0) OUTPUT, 
	@tablaOUT AS VARCHAR(30) OUTPUT
AS
BEGIN
	
	--DECLARO Y SETEO VARIABLES NECESARIAS--
	DECLARE @NombreCampo AS VARCHAR (30);
	DECLARE @NombreCampo2 AS VARCHAR (30);
	DECLARE @ConsultaSQL NVARCHAR(500);	
	SET @resultado = 0;
	
	---DECLARO Y SETEO VARIABLE AUXILIAR----
	DECLARE @tabla NUMERIC(5,0) = 0;
	SET @tabla = (SELECT 
				 	TABLA 
				  FROM DICCIONARIO WITH (nolock) 
					WHERE 
						NUMERODECAMPO= @campoIN
						AND TABLA <> 0
				  );
	
	----------TABLA AUXILIAR------------	
	DECLARE @TMPTablasEnUso TABLE(
		NRO_TABLA NUMERIC (5, 0),
		NOMBRE_CAMPO VARCHAR (30), 	
		NOMBRE_TABLA VARCHAR (60)
	);
	
	------CARGO LA TABLA TEMPORAL-------
	INSERT INTO
		@TMPTablasEnUso
	SELECT 
		DI.TABLA,
		DI.CAMPO,
		DE.NOMBREFISICO
	FROM DICCIONARIO AS DI WITH (nolock)
	INNER JOIN DESCRIPTORES AS DE WITH (nolock) ON
		DE.IDENTIFICACION = DI.TABLA
	WHERE DI.TABLA=@tabla AND DI.NUMERODECAMPO=@campoIN
	
	--RECORRO LA TABLA BUSCANDO RESULTADOS DONDE EL VALOR COINCIDA CON EL CAMPO--
	WHILE EXISTS (SELECT * FROM @TMPTablasEnUso) AND @resultado = 0
		BEGIN
			SELECT
				TOP 1
				@NombreCampo=NOMBRE_CAMPO,
				@tablaOUT=NOMBRE_TABLA,
				@ConsultaSQL = ''SELECT @resultado=count(1) FROM ''+NOMBRE_TABLA+  
									'' WHERE TZ_LOCK=0 AND ''+NOMBRE_CAMPO+''=''''''+@valor+''''''AND ID_CAUSAL=''''''+@valor2+'''''';''	
			FROM @TMPTablasEnUso
			ORDER BY 
				NRO_TABLA
			EXEC sp_executesql @ConsultaSQL,
		   		N''@resultado int OUTPUT'',
				@resultado = @resultado OUTPUT
			
			DELETE FROM @TMPTablasEnUso WHERE NOMBRE_CAMPO=@NombreCampo AND NOMBRE_TABLA=@tablaOUT
		END		
END
')

Execute('
IF OBJECT_ID (''SP_IB_CBU'') IS NOT NULL
	drop procedure SP_IB_CBU;
IF OBJECT_ID (''ITF_IB_CBU'') IS NOT NULL
	drop table ITF_IB_CBU;
IF OBJECT_ID (''ITF_IB_CBU_AUX'') IS NOT NULL
	drop table ITF_IB_CBU_AUX
IF OBJECT_ID (''ITF_IB_CBU_HIST'') IS NOT NULL
	drop table ITF_IB_CBU_HIST
IF OBJECT_ID (''ITF_IB_CBU_BASE_MASTER'') IS NOT NULL
	drop table ITF_IB_CBU_BASE_MASTER

create table ITF_IB_CBU_BASE_MASTER 
(
	EVENTO varchar(1) NOT NULL,
	REPROCESO varchar(1) NOT NULL,
	CBU varchar(22) NOT NULL PRIMARY KEY,
	TIPO_CUENTA varchar(2) NOT NULL,
	NUM_CUENTA_PBF varchar(17) NOT NULL,
	NUM_CUENTA_TOPAZ numeric(12,0) NOT NULL,
	ESTADO varchar(1) NOT NULL,
	TIPO_PERSONA_TITULAR varchar(1) NOT NULL,
	CUIT_TITULAR varchar(11) NOT NULL,
	NOMBRE_TITULAR varchar(40) NOT NULL,
	CUIT_COTITULAR1 varchar(11) NULL,
	NOMBRE_COTITULAR1 varchar (40) NULL,
	CUIT_COTITULAR2 varchar(11) NULL,
	NOMBRE_COTITULAR2 varchar (40) NULL
);

IF OBJECT_ID (''ITF_IB_CBU_BASE_HISTORICO'') IS NOT NULL
	drop table ITF_IB_CBU_BASE_HISTORICO
create table ITF_IB_CBU_BASE_HISTORICO
(
	ID bigint IDENTITY(1,1) NOT NULL PRIMARY KEY,
	EVENTO varchar(1) NOT NULL,
	REPROCESO varchar(1) NOT NULL,
	CBU varchar(22) NOT NULL,
	TIPO_CUENTA varchar(2) NOT NULL,
	NUM_CUENTA_PBF varchar(17) NOT NULL,
	NUM_CUENTA_TOPAZ numeric(12,0) NOT NULL,
	ESTADO varchar(1) NOT NULL,
	TIPO_PERSONA_TITULAR varchar(1) NOT NULL,
	CUIT_TITULAR varchar(11) NOT NULL,
	NOMBRE_TITULAR varchar(40) NOT NULL,
	CUIT_COTITULAR1 varchar(11) NULL,
	NOMBRE_COTITULAR1 varchar (40) NULL,
	CUIT_COTITULAR2 varchar(11) NULL,
	NOMBRE_COTITULAR2 varchar (40) NULL,
	FECHA_PROCESO datetime NOT NULL,
	FECHA_RELOJ datetime NOT NULL
);')



Execute('
DELETE FROM dbo.ITF_MASTER_PARAMETROS WHERE CODIGO IN (488,493,489,490,491,492);
insert into ITF_MASTER_PARAMETROS (CODIGO,CODIGO_INTERFACE,FUNCIONALIDAD,ALFA_1,ALFA_2,ALFA_3,NUMERICO_1,NUMERICO_2,FECHA,IMPORTE_1,IMPORTE_2,TZ_LOCK) 
values
	 (488,13,''DPJ REDLINK'',''9'',''20'','' '',3,1,NULL,0.00,0.00,0),
	 (489,13,''DPJ REDLINK'',''10'',''20'','' '',3,1,NULL,0.00,0.00,0),
	 (490,13,''DPJ REDLINK'',''9'',''21'','' '',3,2,NULL,0.00,0.00,0),
	 (491,13,''DPJ REDLINK'',''10'',''21'','' '',3,2,NULL,0.00,0.00,0),
	 (492,9,''Tipos Cuenta REDLINK'','' '',''11'','' '',3,988,NULL,0.00,0.00,0),
	 (493,9,''Tipos Cuenta REDLINK'','' '',''11'','' '',3,999,NULL,0.00,0.00,0);
	  
	 delete from ITF_MASTER_PARAMETROS where CODIGO_INTERFACE = 1281;
	 
DELETE FROM OPERACIONES WHERE IDENTIFICACION = 2452;
DELETE FROM DESCRIPTORES WHERE IDENTIFICACION = 772;
DELETE FROM DICCIONARIO WHERE TABLA = 772;
DELETE FROM AYUDAS WHERE NUMERODEAYUDA = 772;
DELETE FROM INDICES WHERE NUMERODEARCHIVO = 772;
DELETE FROM OPCIONES where NUMERODECAMPO = 8732 or NUMERODECAMPO = 8734;

-- operaciones
INSERT INTO OPERACIONES (TITULO,IDENTIFICACION,NOMBRE,DESCRIPCION,MNEMOTECNICO,AUTORIZACION,FORMULARIOPRINCIPAL,PROXOPERACION,ESTADO,TZ_LOCK,COPIAS,SUBOPERACION,PERMITEBAJA,COMPORTAMIENTOENCIERRE,REQUIERECONTRASENA,PERMITECONCURRENTE,PERMITEESTADODIFERIDO,ICONO_TITULO,ESTILO) 
VALUES (6800,2452,''Reproceso master IB - CBU'',''Reproceso master IB - CBU'',''2452'',''N'',NULL,NULL,''P'',0,NULL,0,''S'',''N'',''N'',''N'',''N'',NULL,0);

-- Descriptor
INSERT INTO DESCRIPTORES (TITULO,IDENTIFICACION,TIPODEARCHIVO,DESCRIPCION,GRUPODELMAPA,NOMBREFISICO,TIPODEDBMS,LARGODELREGISTRO,INICIALIZACIONDELREGISTRO,BASE,SELECCION,ACEPTA_MOVS_DIFERIDO)
VALUES (930,772,NULL,''Interface 1.28.1 IB CBU'',0,''ITF_IB_CBU_BASE_MASTER'',''D'',NULL,NULL,''Top/Clientes'',NULL,''N'');

-- Diccionario
DELETE FROM dbo.DICCIONARIO WHERE NUMERODECAMPO = 8750;
INSERT INTO DICCIONARIO (NUMERODECAMPO,USODELCAMPO,REFERENCIA,DESCRIPCION,PROMPT,LARGO,TIPODECAMPO,DECIMALES,EDICION,CONTABILIZA,CONCEPTO,CALCULO,VALIDACION,TABLADEVALIDACION,TABLADEAYUDA,OPCIONES,TABLA,CAMPO,BASICO,MASCARA)
VALUES
	 (8726,'' '',0,''CBU'',''CBU'',22,''A'',0,NULL,0,0,0,0,0,0,0,772,''CBU'',0,NULL),
	 (8728,'' '',0,''CUIT_TITULAR'',''Documento del titular'',11,''A'',0,NULL,0,0,0,0,0,0,0,772,''CUIT_TITULAR'',0,NULL),
	 (8730,'' '',0,''NOMBRE_TITULAR'',''Nombre del titular'',40,''A'',0,NULL,0,0,0,0,0,0,0,772,''NOMBRE_TITULAR'',0,NULL),
	 (8732,'' '',0,''EVENTO'',''Evento'',1,''A'',0,NULL,0,0,0,0,0,0,1,772,''EVENTO'',0,NULL),
	 (8734,'' '',0,''REPROCESO'',''Reproceso'',1,''A'',0,NULL,0,0,0,0,0,0,1,772,''REPROCESO'',0,NULL),
	 (8750,'' '',0,''Grilla cuentas IB CBU'',''Grilla cuentas IB CBU'',22,''A'',0,NULL,0,0,0,0,0,772,0,0,''C8750'',0,NULL);

	
-- Indice

DELETE FROM dbo.OPCIONES WHERE NUMERODECAMPO IN (8732,8734)
INSERT INTO OPCIONES (NUMERODECAMPO,IDIOMA,DESCRIPCION,OPCIONINTERNA,OPCIONDEPANTALLA) VALUES
	 (8732,''E'',''Alta'',''A'',''A''),
	 (8732,''E'',''Baja'',''B'',''B''),
	 (8732,''E'',''Modificacion'',''M'',''M''),
	 (8734,''E'',''No'',''N'',''N''),
	 (8734,''E'',''Si'',''S'',''S'');
	
-- Ayudas
DELETE FROM dbo.AYUDAS WHERE NUMERODEAYUDA = 772;
INSERT INTO AYUDAS (NUMERODEARCHIVO,NUMERODEAYUDA,DESCRIPCION,FILTRO,MOSTRARTODOS,CAMPOS,CAMPOSVISTA,BASEVISTA,NOMBREVISTA,AYUDAGRANDE) VALUES
	 (772,772,''Buscar cuenta'','''',0,''8726R;8734;8732;8728;8730;'',NULL,NULL,NULL,0);
	
-- Indice
DELETE FROM dbo.INDICES WHERE NUMERODEARCHIVO = 772 AND NUMERODEINDICE = 1

INSERT INTO INDICES (NUMERODEARCHIVO,NUMERODEINDICE,DESCRIPCION,CLAVESREPETIDAS,CAMPO1,CAMPO2,CAMPO3,CAMPO4,CAMPO5,CAMPO6,CAMPO7,CAMPO8,CAMPO9,CAMPO10,CAMPO11,CAMPO12,CAMPO13,CAMPO14,CAMPO15,CAMPO16,CAMPO17,CAMPO18,CAMPO19,CAMPO20) VALUES
	 (772,1,''Indice CBU'',0,8726,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL);')

