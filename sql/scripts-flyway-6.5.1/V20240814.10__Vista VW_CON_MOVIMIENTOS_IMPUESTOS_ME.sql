EXECUTE('
IF OBJECT_ID (''dbo.VW_CON_MOVIMIENTOS_IMPUESTOS_ME'') IS NOT NULL
	DROP VIEW dbo.VW_CON_MOVIMIENTOS_IMPUESTOS_ME
')
EXECUTE('
CREATE   VIEW [dbo].[VW_CON_MOVIMIENTOS_IMPUESTOS_ME] (ID_LIQUIDACION,
                                           FECHAPROCESO,
                                           SUCURSAL,
                                           ASIENTO,
                                           TRREAL,
                                           ORDINAL,
                                           TRVIRTUAL,
                                           TRTIPO,
                                           MONEDA,
                                           IMPORTE,
                                           SUCURSAL_CUENTA,
                                           DEBITOCREDITO,
                                           CUENTA,
                                           ORDINAL_CUENTA,
                                           RUBRO_ORIGEN,
                                           RUBRO_DESTINO,
                                           MARCAAJUSTE,
                                           CONCEPTO,
                                           FECHA_CONTABLE)
AS
SELECT 
	M.JTS_OID AS ID_LIQUIDACION,
	M.FECHAPROCESO, 
	M.SUCURSAL, 
	M.ASIENTO,
	M.TRREAL,
	M.ORDINAL,
	M.TRVIRTUAL,
	M.TRTIPO,
	M.MONEDA,
    M.CAPITALREALIZADO,
    M.SUCURSAL_CUENTA,
    M.DEBITOCREDITO,
    M.CUENTA,
    M.ORDINAL_CUENTA, 
    R.RUBRO_ORIGEN, 
    R.RUBRO_DESTINO,
    M.MARCAAJUSTE, 
    PC.C6300,
    M.FECHACONTABLE
FROM MOVIMIENTOS_CONTABLES AS M WITH (nolock)
JOIN ASIENTOS A ON 
	A.ASIENTO = M.ASIENTO 
	AND A.FECHAPROCESO = M.FECHAPROCESO 
	AND A.SUCURSAL = M.SUCURSAL 
	AND A.ESTADO = 77
	AND A.OPERACION !=2072
JOIN CON_RUBRO_CONTABLE_ORIG_DEST_ME R ON 
	R.RUBRO_ORIGEN = M.RUBROCONTABLE
	AND ((R.TZ_LOCK < 100000000000000 OR R.TZ_LOCK >= 200000000000000)
		AND (R.TZ_LOCK < 300000000000000 OR R.TZ_LOCK >= 400000000000000)
	)	
JOIN PLANCTAS PC ON
    PC.C6326 = R.RUBRO_ORIGEN
	AND ((PC.TZ_LOCK < 100000000000000 OR PC.TZ_LOCK >= 200000000000000)
		AND (PC.TZ_LOCK < 300000000000000 OR PC.TZ_LOCK >= 400000000000000)
	)
WHERE
	M.MONEDA NOT IN (
		SELECT TOP 1 C6399 
		FROM MONEDAS 
		WHERE C6403 = ''N''
			AND ((TZ_LOCK < 100000000000000 OR TZ_LOCK >= 200000000000000)
				AND (TZ_LOCK < 300000000000000 OR TZ_LOCK >= 400000000000000)
			)
		ORDER BY C6399
	)
	AND M.OPERACION <> 9999
    AND CONVERT(VARCHAR(6),LEFT(CONVERT(VARCHAR, M.FECHAPROCESO,112),6)) NOT IN (
		SELECT EB.ANIOMES 
		FROM ESTADO_BALANCE AS EB
		WHERE (
			EB.ABIERTO_CERRADO =''C'' 
			AND EB.TZ_LOCK = 0
			AND CONVERT(VARCHAR(6),LEFT(CONVERT(VARCHAR, EB.ANIOMES,112),6))= 
				CONVERT(VARCHAR(6),LEFT(CONVERT(VARCHAR, M.FECHAPROCESO,112),6))
			AND ((EB.TZ_LOCK < 100000000000000 OR EB.TZ_LOCK >= 200000000000000)
				AND (EB.TZ_LOCK < 300000000000000 OR EB.TZ_LOCK >= 400000000000000)
			)
		)
	)    
	AND NOT EXISTS (
		SELECT * 
		FROM CON_MOVIMIENTOS_IMPUESTOS_ME AS M2 WITH(nolock)
		WHERE
			M2.ASIENTO = M.ASIENTO
			AND M2.FECHAPROCESO = M.FECHAPROCESO
			AND M2.SUCURSAL = M.SUCURSAL
			AND M2.TRREAL = M.TRREAL
			AND M2.ORDINAL = M.ORDINAL
			AND M2.TRVIRTUAL = M.TRVIRTUAL
			AND M2.TRTIPO = M.TRTIPO
			AND M2.RESULTADO_EJECUCION = ''OK''
			AND ((M2.TZ_LOCK < 100000000000000 OR M2.TZ_LOCK >= 200000000000000)
				AND (M2.TZ_LOCK < 300000000000000 OR M2.TZ_LOCK >= 400000000000000)
			)
	)
')