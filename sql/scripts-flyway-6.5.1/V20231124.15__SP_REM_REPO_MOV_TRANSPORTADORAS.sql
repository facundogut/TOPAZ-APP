EXECUTE('
CREATE OR ALTER PROCEDURE SP_REM_REPO_MOV_TRANSPORTADORAS
   @P_FECHA_SALDO DATETIME,
   
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
      
AS 

   BEGIN

      SET @P_RET_PROCESO = NULL
      SET @P_MSG_PROCESO = NULL
      
      DECLARE

         @FECHA DATETIME,
         @FECHA_ANTERIOR DATETIME,
         @CANT NUMERIC(5),
         @row_number NUMERIC(6),
         @v_constante VARCHAR(1),
         @v_numerador NUMERIC,
         @v_correlativo NUMERIC(10)
         
      
      --DECLARO TABLA AUXILIAR--
	  DECLARE @Tabla_SP_REM_REPO_MOV_TRANSPORTADORAS  TABLE(
	  	NRO_SOLICITUD NUMERIC (6, 0),
		TIPOORIGEN NUMERIC (3, 0), 
      	ORIGEN VARCHAR(255), 
      	SUCURSAL_ORIGEN VARCHAR(50), 
      	TIPODESTINO NUMERIC (3, 0),
      	DESTINO VARCHAR(254),
      	SUCURSAL_DESTINO VARCHAR(50),
      	DEBE NUMERIC (14, 2),
      	HABER NUMERIC (14, 2),
      	MONEDA NUMERIC (4, 0),
      	DESCR_MONEDA VARCHAR(20),
      	FECHA_CONFIRMACION DATETIME,
      	FECHA_EJECUCION DATETIME,
      	ESTADO VARCHAR(1),
      	MEDIO_TRANS NUMERIC (12, 0),
      	TRANSPORTADORA VARCHAR(36),
      	CUENTA_TRANS NUMERIC (12, 0)
	  )
	  
	  	INSERT INTO 
			@Tabla_SP_REM_REPO_MOV_TRANSPORTADORAS
		--Remesas Sucursales fecha distinta ejecucion anterior
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 7)
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND REM.ESTADO IN (''L'')
		--AND REM.FECHA_CONFIRMACION = ''20371209''
		--ORDER BY REM.MONEDA, REM.FECHA_INGRESO, REM.ORIGEN, REM.DESTINO 
		
		
		UNION
		
		--Remesas Sucursales
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	(REM.ESTADO = ''L'' AND REM.FECHA_EJECUCION = REM.FECHA_CONFIRMACION)
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	((REM.ESTADO = ''E'') OR (REM.ESTADO = ''L'' AND REM.FECHA_EJECUCION <> REM.FECHA_CONFIRMACION))
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 7)
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		AND REM.ESTADO IN (''E'',''L'')
		--AND REM.FECHA_CONFIRMACION = ''20371209''
		--ORDER BY REM.MONEDA, REM.FECHA_INGRESO, REM.ORIGEN, REM.DESTINO 
		
		
		UNION
		
		--Remesas Minifilial
		SELECT DISTINCT  
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	(REM.ESTADO = ''L'' AND REM.FECHA_EJECUCION = REM.FECHA_CONFIRMACION)
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	((REM.ESTADO = ''E'') OR (REM.ESTADO = ''L'' AND REM.FECHA_EJECUCION <> REM.FECHA_CONFIRMACION))
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 11 AND REM.TIPODESTINO = 11)
		AND REM.ESTADO IN (''E'',''L'')
		--AND REM.FECHA_CONFIRMACION = ''20371209''
		--ORDER BY REM.MONEDA, REM.FECHA_INGRESO, REM.ORIGEN, REM.DESTINO 
		
		
		UNION
		
		--Remesas Externas
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRE "SucursalDestino",
			CASE 
			   WHEN (REM.ESTADO = ''L'' AND REM.FECHA_EJECUCION = REM.FECHA_CONFIRMACION)
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	((REM.ESTADO = ''E'' AND REM.FECHA_EJECUCION = REM.FECHA_CONFIRMACION) OR (REM.ESTADO = ''L'' AND REM.FECHA_EJECUCION <> REM.FECHA_CONFIRMACION))
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S2 ON CAST(REM.DESTINO AS INTEGER) = S2.CODIGOBC AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 3 AND (REM.TIPODESTINO = 10 OR REM.TIPODESTINO = 12 OR REM.TIPODESTINO = 4))
		AND REM.ESTADO IN (''E'',''L'')
		AND REM.FECHA_CONFIRMACION IS NOT NULL
		UNION
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRE AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	(REM.ESTADO = ''L'' AND REM.FECHA_EJECUCION = REM.FECHA_CONFIRMACION)
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	((REM.ESTADO = ''E'' AND REM.FECHA_EJECUCION = REM.FECHA_CONFIRMACION) OR (REM.ESTADO = ''L'' AND REM.FECHA_EJECUCION <> REM.FECHA_CONFIRMACION))
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S ON CAST(REM.ORIGEN AS INTEGER) = S.CODIGOBC AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPODESTINO = 3 AND (REM.TIPOORIGEN = 10 OR REM.TIPOORIGEN = 12 OR REM.TIPOORIGEN = 4))
		AND REM.ESTADO IN (''E'',''L'')
		AND REM.FECHA_CONFIRMACION IS NOT NULL
		
		
		UNION
		
		--Pase a Transportadora
		SELECT DISTINCT
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN, 
			REM.ORIGEN,
			S.NOMBRE_CLI AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
		    S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS  S ON CAST(REM.ORIGEN AS INTEGER) = S.NRO_CLIENTE AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE ((REM.TIPOORIGEN = 8 AND REM.TIPODESTINO = 7))
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		UNION 
		SELECT DISTINCT
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN, 
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
		    S2.NOMBRE_CLI AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS S2 ON CAST(REM.DESTINO AS INTEGER) = S2.NRO_CLIENTE AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE ((REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 8))
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		ORDER BY REM.MONEDA, REM.FECHA_CONFIRMACION, REM.ORIGEN, REM.DESTINO 

	  
		--Tabla temporal de duplicados por haber
		DECLARE @Tabla_SP_REM_REPO_MOV_TRANSPORTADORAS_DOBLE  TABLE(
		  	NRO_SOLICITUD NUMERIC (6, 0),
			TIPOORIGEN NUMERIC (3, 0), 
	      	ORIGEN VARCHAR(255), 
	      	SUCURSAL_ORIGEN VARCHAR(50), 
	      	TIPODESTINO NUMERIC (3, 0),
	      	DESTINO VARCHAR(254),
	      	SUCURSAL_DESTINO VARCHAR(50),
	      	DEBE NUMERIC (14, 2),
	      	HABER NUMERIC (14, 2),
	      	MONEDA NUMERIC (4, 0),
	      	DESCR_MONEDA VARCHAR(20),
	      	FECHA_CONFIRMACION DATETIME,
	      	FECHA_EJECUCION DATETIME,
	      	ESTADO VARCHAR(1),
	      	MEDIO_TRANS NUMERIC (12, 0),
	      	TRANSPORTADORA VARCHAR(36),
	      	CUENTA_TRANS NUMERIC (12, 0)
	    )
	    
	    INSERT INTO 
			@Tabla_SP_REM_REPO_MOV_TRANSPORTADORAS_DOBLE
			
		--Remesas Externas
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRE AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S ON CAST(REM.ORIGEN AS INTEGER) = S.CODIGOBC AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPODESTINO = 3 AND (REM.TIPOORIGEN = 10 OR REM.TIPOORIGEN = 12 OR REM.TIPOORIGEN = 4))
		AND REM.ESTADO IN (''E'',''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND REM.FECHA_CONFIRMACION IS NOT NULL
		UNION
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRE "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S2 ON CAST(REM.DESTINO AS INTEGER) = S2.CODIGOBC AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 3 AND (REM.TIPODESTINO = 10 OR REM.TIPODESTINO = 12 OR REM.TIPODESTINO = 4))
		AND REM.ESTADO IN (''E'',''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND REM.FECHA_CONFIRMACION IS NOT NULL
		UNION
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRE "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S2 ON CAST(REM.DESTINO AS INTEGER) = S2.CODIGOBC AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 3 AND (REM.TIPODESTINO = 10 OR REM.TIPODESTINO = 12 OR REM.TIPODESTINO = 4))
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		UNION
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRE AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN CLI_BANCOSPLAZA S ON CAST(REM.ORIGEN AS INTEGER) = S.CODIGOBC AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPODESTINO = 3 AND (REM.TIPOORIGEN = 10 OR REM.TIPOORIGEN = 12 OR REM.TIPOORIGEN = 4))
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		
		UNION
		
		--Remesas Sucursales fecha distinta ejecucion anterior
		SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 7)
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		AND REM.ESTADO IN (''L'')
		--AND REM.FECHA_CONFIRMACION = ''20371209''
		--ORDER BY REM.MONEDA, REM.FECHA_INGRESO, REM.ORIGEN, REM.DESTINO 
		
		UNION
		
	    SELECT DISTINCT 
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_EJECUCION,
			''E'' AS ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 7)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION = REM.FECHA_EJECUCION
		--AND REM.FECHA_CONFIRMACION = ''20371209''
		--ORDER BY REM.MONEDA, REM.FECHA_INGRESO, REM.ORIGEN, REM.DESTINO 
		
		
		UNION
		
		--Remesas Minifilial
		SELECT DISTINCT  
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			''E'' AS ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 11 AND REM.TIPODESTINO = 11)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_EJECUCION = REM.FECHA_CONFIRMACION
		UNION
		SELECT DISTINCT  
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN,
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
			S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''E''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			''E'' AS ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE (REM.TIPOORIGEN = 11 AND REM.TIPODESTINO = 11)
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_EJECUCION <> REM.FECHA_CONFIRMACION
		
		UNION
		
		--Pase a Transportadora
		SELECT DISTINCT
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN, 
			REM.ORIGEN,
			S.NOMBRE_CLI AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
		    S2.NOMBRESUCURSAL AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS  S ON CAST(REM.ORIGEN AS INTEGER) = S.NRO_CLIENTE AND S.TZ_LOCK = 0
		INNER JOIN SUCURSALES S2 ON CAST(REM.DESTINO AS INTEGER) = S2.SUCURSAL AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE ((REM.TIPOORIGEN = 8 AND REM.TIPODESTINO = 7))
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		UNION 
		SELECT DISTINCT
			REM.NRO_SOLICITUD,
			REM.TIPOORIGEN, 
			REM.ORIGEN,
			S.NOMBRESUCURSAL AS "SucursalOrigen",
			REM.TIPODESTINO,
			REM.DESTINO,
		    S2.NOMBRE_CLI AS "SucursalDestino",
			CASE 
			   WHEN	REM.ESTADO = ''P''
				THEN REM.IMPORTE
			END AS "Debe",
			CASE 
			   WHEN	REM.ESTADO = ''L''
				THEN REM.IMPORTE
			END AS "Haber",
			REM.MONEDA AS "Moneda",
			M.C6400 AS "Descr. Moneda",
			REM.FECHA_CONFIRMACION,
			REM.FECHA_CONFIRMACION,
			REM.ESTADO,
			REM.MEDIO_TRANSP,
			T.NOMBRE_CLI AS "Transportadora",
			T.CUENTA AS "Cuenta transportadora"
		FROM
		REM_SOLICITUDREMESA REM
		JOIN OPCIONES O ON REM.ESTADO = O.OPCIONINTERNA AND O.NUMERODECAMPO =2866 AND O.IDIOMA = ''E''
		JOIN MONEDAS M ON M.C6399 = REM.MONEDA AND M.TZ_LOCK = 0
		INNER JOIN SUCURSALES S ON CAST(REM.ORIGEN AS INTEGER) = S.SUCURSAL AND S.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS S2 ON CAST(REM.DESTINO AS INTEGER) = S2.NRO_CLIENTE AND S2.TZ_LOCK = 0
		INNER JOIN REM_TRANSPORTADORAS T ON CAST(REM.MEDIO_TRANSP AS INTEGER) = T.NRO_CLIENTE AND S2.TZ_LOCK = 0
		WHERE ((REM.TIPOORIGEN = 7 AND REM.TIPODESTINO = 8))
		AND REM.ESTADO IN (''L'')
		AND REM.FECHA_CONFIRMACION <> REM.FECHA_EJECUCION
		--AND REM.FECHA_CONFIRMACION = ''20371209''
		ORDER BY REM.MONEDA, REM.FECHA_CONFIRMACION, REM.ORIGEN, REM.DESTINO 
      
    
      BEGIN TRANSACTION	
      
        BEGIN TRY
        
        	DELETE 
        	FROM REM_REPO_MOV_TRANSPORTADORAS 
	    
	    	INSERT INTO REM_REPO_MOV_TRANSPORTADORAS
			SELECT 
				TC.NRO_SOLICITUD,
				TC.TIPOORIGEN, 
		      	TC.ORIGEN, 
		      	TC.SUCURSAL_ORIGEN, 
		      	TC.TIPODESTINO,
		      	TC.DESTINO,
		      	TC.SUCURSAL_DESTINO,
		      	TC.DEBE,
		      	TC.HABER,
		      	TC.MONEDA,
		      	TC.DESCR_MONEDA,
		      	TC.FECHA_CONFIRMACION,
		      	TC.FECHA_EJECUCION,
		      	TC.ESTADO,
		      	TC.MEDIO_TRANS,
		      	TC.TRANSPORTADORA ,
		      	TC.CUENTA_TRANS,
		      	1		
			FROM @Tabla_SP_REM_REPO_MOV_TRANSPORTADORAS AS TC
		   
			 
			INSERT INTO REM_REPO_MOV_TRANSPORTADORAS
			SELECT 
				TC.NRO_SOLICITUD,
				TC.TIPOORIGEN, 
		      	TC.ORIGEN, 
		      	TC.SUCURSAL_ORIGEN, 
		      	TC.TIPODESTINO,
		      	TC.DESTINO,
		      	TC.SUCURSAL_DESTINO,
		      	TC.DEBE,
		      	TC.HABER,
		      	TC.MONEDA,
		      	TC.DESCR_MONEDA,
		      	TC.FECHA_CONFIRMACION,
		      	TC.FECHA_EJECUCION,
		      	TC.ESTADO,
		      	TC.MEDIO_TRANS,
		      	TC.TRANSPORTADORA ,
		      	TC.CUENTA_TRANS,
		      	2		
			FROM @Tabla_SP_REM_REPO_MOV_TRANSPORTADORAS_DOBLE AS TC	
			
				
			COMMIT TRANSACTION;
			
			SET @P_RET_PROCESO = 1
		    SET @P_MSG_PROCESO = ''Se generaron datos del reporte exitosamente.''
			 
				
		END TRY     
		
		BEGIN CATCH
			ROLLBACK TRANSACTION
			SET @P_RET_PROCESO = ERROR_NUMBER()
			SET @P_MSG_PROCESO = ERROR_MESSAGE()
			EXECUTE dbo.pkg_constantes$VarcharConstantes ''C_LOG_TIPO_ERROR'', @v_constante OUTPUT;
		END CATCH
		 	      
 END
')

