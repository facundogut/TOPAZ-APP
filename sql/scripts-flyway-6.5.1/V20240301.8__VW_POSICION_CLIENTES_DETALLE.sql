EXECUTE('
IF OBJECT_ID (''dbo.VW_POSICION_CLIENTES_DETALLE'') IS NOT NULL
	DROP VIEW dbo.VW_POSICION_CLIENTES_DETALLE

')

EXECUTE('
CREATE VIEW [dbo].[VW_POSICION_CLIENTES_DETALLE] AS 
SELECT 	CLIENTE AS ''Cliente'', CLASIFICACION AS ''Clasificacion'',
		T.SUCURSAL AS ''Sucursal'',T.PRODUCTO AS ''Producto'',T.CUENTA AS ''Cuenta'',
		T.MONEDA AS ''Moneda'',T.OPERACION AS ''Operacion'',
		DEUDA_EXIGIBLE AS ''Deuda Exigible'',DEUDA_NO_EXIGIBLE AS ''Deuda no Exigible'',
		DEUDA_TOTAL ''Deuda Total'',DEUDA_CONTINGENTE ''Deuda Contingente'',
CASE WHEN DEUDA_TOTAL < DEUDA_CONTINGENTE THEN DEUDA_CONTINGENTE
	ELSE DEUDA_TOTAL END AS ''Riesgo Total'',T.JTS_OID
FROM ( 
SELECT CLIENTE,s.SUCURSAL,s.PRODUCTO,s.CUENTA,s.MONEDA,s.OPERACION,
	 CASE WHEN CLASIFICACION=''L'' THEN ''Leasing''
	 WHEN CLASIFICACION IN (''A'',''O'') THEN ''CC''
	 WHEN CLASIFICACION=''D'' THEN ''Descuento Bancario''
	 WHEN CLASIFICACION=''T'' THEN ''Tarjeta de Crédito''
	 -- WHEN CLASIFICACION=''GO'' THEN ''Garantías Otorgadas''
	 ELSE ''Prestamos'' END AS CLASIFICACION,
	 CASE WHEN CLASIFICACION=''T'' AND sum(S.C1685) - (sum(s.C1832)-sum(s.AJUSTEINFLACION))> 0 THEN sum(S.C1685)
	 	  ELSE sum(SALDO_DEUDA) END AS DEUDA_EXIGIBLE,
	 SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0)) AS DEUDA_NO_EXIGIBLE,
	 sum(SALDO_DEUDA)+ SUM(ISNULL(A.TOTAL_NO_EXIGIBLE,0)) AS DEUDA_TOTAL,
	 CASE WHEN CLASIFICACION=''A'' THEN sum(vw.MONTOORIGEN)
	      WHEN CLASIFICACION=''T'' THEN sum(S.C1806)
	      ELSE 0 END AS DEUDA_CONTINGENTE,
s.JTS_OID 	      
FROM VW_DEUDA_CLIENTES vw
INNER JOIN SALDOS S ON S.JTS_OID=vw.JTS_OID
LEFT JOIN VW_ASISTENCIAS_DEUDA_NO_EXIGIBLE A ON A.SALDO_JTS_OID=vw.JTS_OID
WHERE vw.SALDO>0 
GROUP BY CLIENTE, CLASIFICACION, s.JTS_OID,s.SUCURSAL,s.PRODUCTO,s.CUENTA,s.MONEDA,s.OPERACION
) T

')