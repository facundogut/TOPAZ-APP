EXECUTE('
CREATE PROCEDURE [SP_GENERA_NRO_AVISO]
   @P_ID_PROCESO float(53),
   @P_DT_PROCESO datetime2(0),
   @P_RET_PROCESO float(53)  OUTPUT,
   @P_MSG_PROCESO varchar(max)  OUTPUT
AS
BEGIN
DECLARE 
@NroCheque NUMERIC(12),
@Serie VARCHAR(3),
@Sucursal NUMERIC(5),
@Moneda NUMERIC(4),
@Producto NUMERIC(5),
@Cuenta NUMERIC(12),
@Anio NUMERIC(8)
DECLARE cChequesRechazados CURSOR LOCAL FOR 
SELECT B.NRO_CHEQUE, B.SERIE_CHEQUE, B.SUCURSAL, B.MONEDA, B.PRODUCTO, B.CUENTA FROM CHE_BCO_RECHAZADOS B
WHERE (B.NRO_AVISO IS NULL OR B.NRO_AVISO = 0) AND B.TZ_LOCK = 0 AND B.FECHA_CHEQUE <= (SELECT FECHAPROCESO FROM PARAMETROS)
OPEN cChequesRechazados
WHILE 1=1
BEGIN

FETCH cChequesRechazados INTO
@NroCheque,
@Serie,
@Sucursal,
@Moneda,
@Producto,
@Cuenta

IF @@FETCH_STATUS <> 0
                  BREAK
SELECT @Anio = (DATEPART(YEAR, (SELECT FECHAPROCESO FROM PARAMETROS))%100)*1000000

UPDATE dbo.CHE_BCO_RECHAZADOS
SET NRO_AVISO = @Anio + ((SELECT VALOR FROM NUMERATORVALUES WHERE ANIO = (SELECT YEAR(FECHAPROCESO) FROM PARAMETROS) 
AND NUMERO = 3000 AND SUCURSAL = @Sucursal AND DIA = 0 AND MES = 0) + 1)
WHERE SUCURSAL = @Sucursal AND SERIE_CHEQUE = @Serie AND NRO_CHEQUE = @NroCheque AND MONEDA = @Moneda
AND PRODUCTO = @Producto AND CUENTA = @Cuenta

UPDATE dbo.NUMERATORVALUES
SET VALOR = (SELECT VALOR FROM NUMERATORVALUES WHERE ANIO = (SELECT YEAR(FECHAPROCESO) FROM PARAMETROS) 
AND NUMERO = 3000 AND SUCURSAL = @Sucursal AND DIA = 0 AND MES = 0) + 1
WHERE DIA = 0 AND MES = 0 AND ANIO = (SELECT YEAR(FECHAPROCESO) FROM PARAMETROS) AND SUCURSAL = @Sucursal 
AND NUMERO = 3000

                  
END   
CLOSE cChequesRechazados;  
DEALLOCATE cChequesRechazados;  
      SET @P_RET_PROCESO = 1
      SET @P_MSG_PROCESO = ''Actualizacion de Saldos de Paquete Finalizo Correctamente'' 
END

')