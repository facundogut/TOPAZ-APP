
EXECUTE('
IF OBJECT_ID (''dbo.VW_RRII_ANEXO_12_RENGLON1'') IS NOT NULL
	DROP VIEW dbo.VW_RRII_ANEXO_12_RENGLON1
')
EXECUTE('
CREATE       VIEW [dbo].[VW_RRII_ANEXO_12_RENGLON1] 
AS
SELECT 
	S.C1785 AS Producto,
	G.FECHA,
	ISNULL (dbo.convertirAMonNac(((SELECT TOP 1 SALDO_AJUSTADO 
				FROM GRL_SALDOS_DIARIOS WITH (NOLOCK)
				WHERE SALDOS_JTS_OID = G.SALDOS_JTS_OID 
				AND MONEDA = G.MONEDA
				AND FECHA = G.FECHA
				AND TZ_LOCK = G.TZ_LOCK)/
	   		(SELECT COUNT(NUMEROPERSONA) 
	   		FROM CLI_ClientePersona WITH (NOLOCK)
	   		WHERE CODIGOCLIENTE = CP.CODIGOCLIENTE 
	   		AND TZ_LOCK = CP.TZ_LOCK)),G.MONEDA,G.FECHA),0) AS MONTODEPOSITO,
	G.MONEDA,
	CP.NUMEROPERSONA,
	G.SALDOS_JTS_OID
FROM
	GRL_SALDOS_DIARIOS G WITH (NOLOCK)
	
INNER JOIN SALDOS S WITH(NOLOCK) ON
	G.SALDOS_JTS_OID=S.JTS_OID AND
	G.MONEDA=S.MONEDA AND 
	G.TZ_LOCK=S.TZ_LOCK
INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON
	CP.TZ_LOCK=G.TZ_LOCK AND
	CP.CODIGOCLIENTE = S.C1803
INNER JOIN VTA_SALDOS VS WITH(NOLOCK)ON
	VS.TZ_LOCK = G.TZ_LOCK AND
	S.JTS_OID = VS.JTS_OID_SALDO
WHERE
	S.C1785 IN (2, 3, 4) AND 
	G.TZ_LOCK=0 AND
	VS.FONDOGARANTIA=''S'' AND 
	G.SALDO_AJUSTADO!=0 
GROUP BY
	G.MONEDA,
	CP.NUMEROPERSONA,
	S.C1785,
	G.FECHA,
	G.SALDOS_JTS_OID,
	G.TZ_LOCK,
	CP.CODIGOCLIENTE,
	CP.TZ_LOCK
	
UNION ALL
SELECT 
	S.C1785 AS Producto,
	G.FECHA,
	ISNULL (dbo.convertirAMonNac(((SELECT TOP 1 SALDO_AJUSTADO 
				FROM GRL_SALDOS_DIARIOS WITH (NOLOCK)
				WHERE SALDOS_JTS_OID = G.SALDOS_JTS_OID 
				AND MONEDA = G.MONEDA
				AND FECHA = G.FECHA
				AND TZ_LOCK = G.TZ_LOCK)/
	   		(SELECT COUNT(NUMEROPERSONA) 
	   		FROM CLI_ClientePersona WITH (NOLOCK)
	   		WHERE CODIGOCLIENTE = CP.CODIGOCLIENTE 
	   		AND TZ_LOCK = CP.TZ_LOCK)),G.MONEDA,G.FECHA),0) AS MONTODEPOSITO,
	G.MONEDA,
	CP.NUMEROPERSONA,
	G.SALDOS_JTS_OID
FROM
	GRL_SALDOS_DIARIOS G WITH (NOLOCK)
	
INNER JOIN SALDOS S WITH(NOLOCK) ON
	G.SALDOS_JTS_OID=S.JTS_OID AND
	G.MONEDA=S.MONEDA AND 
	G.TZ_LOCK=S.TZ_LOCK
INNER JOIN CLI_CLIENTEPERSONA CP WITH(NOLOCK) ON
	CP.TZ_LOCK=G.TZ_LOCK AND
	CP.CODIGOCLIENTE = S.C1803
INNER JOIN PZO_SALDOS PS  WITH(NOLOCK)ON
	S.JTS_OID = PS.JTS_OID_SALDO AND
	PS.TZ_LOCK=G.TZ_LOCK
WHERE 
	S.C1785 IN (2, 3, 4) AND
	G.TZ_LOCK=0 AND 
	PS.FONDOGARANTIA=''S'' AND
	G.SALDO_AJUSTADO!=0 
GROUP BY
	G.MONEDA,
	CP.NUMEROPERSONA,
	S.C1785,
	G.FECHA,
	G.SALDOS_JTS_OID,
	G.TZ_LOCK,
	CP.CODIGOCLIENTE,
	CP.TZ_LOCK
')


EXECUTE('
IF OBJECT_ID (''dbo.VW_RRII_ANEXO_12_RENGLON2PT2'') IS NOT NULL
	DROP VIEW dbo.VW_RRII_ANEXO_12_RENGLON2PT2
')
EXECUTE('
CREATE   VIEW [dbo].[VW_RRII_ANEXO_12_RENGLON2PT2] 
AS

SELECT 
	CASE WHEN 
		DBO.convertirAMonNac(MONTODEPOSITO,MONEDA,FECHA)>FDO_GTIA THEN
		FDO_GTIA
	ELSE round(DBO.convertirAMonNac(MONTODEPOSITO,MONEDA,FECHA),2)
	END AS MONTO, 
	PERSONAS,
	Producto,
	MONEDA,
	FDO_GTIA,
	JTS_OID,
	FECHA
 	FROM VW_RRII_ANEXO_12_RENGLON2 VW 
	GROUP BY 
		MONTODEPOSITO,
		PERSONAS,
		Producto,
		MONEDA,
		FDO_GTIA,
		FECHA,
		JTS_OID
')
EXECUTE('
IF OBJECT_ID (''dbo.VW_RRII_ANEXO_12_RENGLON3'') IS NOT NULL
	DROP VIEW dbo.VW_RRII_ANEXO_12_RENGLON3
')
EXECUTE('
CREATE   VIEW [dbo].[VW_RRII_ANEXO_12_RENGLON3] 
AS
SELECT 
	CP.NUMEROPERSONA AS PERSONAS,
	
	G.FECHA AS FECHA,
	
	G.SALDOS_JTS_OID AS JTS_OID,
	
	S.C1785 AS Producto,
	
	CP.CODIGOCLIENTE AS CLIENTE,
	
	(SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=738 AND TZ_LOCK=0) AS PrivilegioDeposito,
	
	(SELECT NUM1 FROM RRI_PARAMETROS_INF WHERE CODIGO=1 AND ID1 = G.MONEDA) AS MONEDA,

	ISNULL (ROUND(dbo.convertirAMonNac(((SELECT TOP 1 SALDO_AJUSTADO 
				FROM GRL_SALDOS_DIARIOS WITH (NOLOCK)
				WHERE SALDOS_JTS_OID = G.SALDOS_JTS_OID 
				AND MONEDA = G.MONEDA
				AND FECHA = G.FECHA
				AND TZ_LOCK = G.TZ_LOCK)/
	   		(SELECT COUNT(NUMEROPERSONA) 
	   		FROM CLI_ClientePersona WITH (NOLOCK)
	   		WHERE CODIGOCLIENTE = CP.CODIGOCLIENTE 
	   		AND TZ_LOCK = CP.TZ_LOCK)),G.MONEDA,G.FECHA),2),0) AS MONTODEPOSITO

FROM GRL_SALDOS_DIARIOS G WITH (NOLOCK)

	INNER JOIN SALDOS S WITH (NOLOCK) ON 
		G.SALDOS_JTS_OID=S.JTS_OID AND
		G.MONEDA = S.MONEDA
		AND G.TZ_LOCK = S.TZ_LOCK

	INNER JOIN CLI_CLIENTES C ON 
		S.C1803 = C.CODIGOCLIENTE
		AND G.TZ_LOCK = C.TZ_LOCK

	INNER JOIN CLI_ClientePersona CP ON
		C.CODIGOCLIENTE=CP.CODIGOCLIENTE
		AND CP.TZ_LOCK = G.TZ_LOCK

	INNER JOIN VTA_SALDOS VS WITH(NOLOCK) ON
		S.JTS_OID = VS.JTS_OID_SALDO
		AND G.TZ_LOCK = VS.TZ_LOCK
WHERE 
	G.TZ_LOCK=0 AND
	S.C1785 IN (2, 3, 4) AND 
	VS.FONDOGARANTIA=''N''
	AND G.SALDO_AJUSTADO!=0
GROUP BY 
	G.FECHA,
	CP.NUMEROPERSONA,
	G.SALDOS_JTS_OID,
	S.C1785,
	CP.CODIGOCLIENTE,
	G.MONEDA,
	G.TZ_LOCK,
	CP.TZ_LOCK
	

UNION ALL

SELECT 
	CP.NUMEROPERSONA AS PERSONAS,
	
	G.FECHA AS FECHA,
	
	G.SALDOS_JTS_OID AS JTS_OID,
	
	SD.C1785 AS Producto,
	
	CP.CODIGOCLIENTE AS CLIENTE,
	
	(SELECT IMPORTE FROM PARAMETROSGENERALES WITH(NOLOCK) WHERE CODIGO=738 AND TZ_LOCK=0) AS PrivilegioDeposito,
	
	(SELECT NUM1 FROM RRI_PARAMETROS_INF WHERE CODIGO=1 AND ID1 = G.MONEDA) AS MONEDA,

	ISNULL (ROUND(dbo.convertirAMonNac(((SELECT TOP 1 SALDO_AJUSTADO 
				FROM GRL_SALDOS_DIARIOS WITH (NOLOCK)
				WHERE SALDOS_JTS_OID = G.SALDOS_JTS_OID 
				AND MONEDA = G.MONEDA
				AND FECHA = G.FECHA
				AND TZ_LOCK = G.TZ_LOCK)/
	   		(SELECT COUNT(NUMEROPERSONA) 
	   		FROM CLI_ClientePersona WITH (NOLOCK)
	   		WHERE CODIGOCLIENTE = CP.CODIGOCLIENTE 
	   		AND TZ_LOCK = CP.TZ_LOCK)),G.MONEDA,G.FECHA),2),0) AS MONTODEPOSITO

	
	FROM GRL_SALDOS_DIARIOS G

	INNER JOIN SALDOS SD  ON 
		SD.JTS_OID = G.SALDOS_JTS_OID AND
		G.MONEDA = SD.MONEDA AND
		SD.TZ_LOCK = G.TZ_LOCK
	
	INNER JOIN PZO_SALDOS PS ON 
		PS.JTS_OID_SALDO = SD.JTS_OID AND
		G.TZ_LOCK = PS.TZ_LOCK
		
	INNER JOIN CLI_ClientePersona CP
		ON SD.C1803 = CP.CODIGOCLIENTE AND
		CP.TZ_LOCK = G.TZ_LOCK
		
	WHERE 
		G.TZ_LOCK = 0 
		AND SD.C1785 = 4
		AND PS.FONDOGARANTIA=''N''
		AND G.SALDO_AJUSTADO!=0
		
	GROUP BY 
		G.FECHA,
		CP.NUMEROPERSONA,
		G.SALDOS_JTS_OID,
		SD.C1785,
		CP.CODIGOCLIENTE,
		G.MONEDA,
		G.TZ_LOCK,
		CP.TZ_LOCK
')