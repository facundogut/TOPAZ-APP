EXECUTE('
ALTER TABLE VTA_HIST_RN ALTER COLUMN descripcion VARCHAR(90) NULL
')


EXECUTE('
ALTER PROCEDURE [dbo].[SP_COPIO_RECIBO]  
   @SOLICITUD NUMERIC(12,0),
   @DOCUMENTO VARCHAR(20)
AS 
  
   BEGIN
   
	INSERT INTO dbo.CRE_SOL_RECIBO_SUELDO_DET (SOLICITUD, NUMERO_RECIBO, DOCUMENTO, CONCEPTO, DESCRIPCION, IMPORTE, ACUMULADOR, PORCENTAJE_AFECTACION, HABITUAL, TZ_LOCK, IMPORTE_AFECTADO)
	SELECT @SOLICITUD AS SOLICITUD, d.NUMERO_RECIBO, d.DOCUMENTO, CONCEPTO, DESCRIPCION, IMPORTE, ACUMULADOR, PORCENTAJE_AFECTACION, HABITUAL, TZ_LOCK, 
		CASE WHEN (	SELECT CUOTA_MAXIMA 
					FROM CRE_RECIBOACUMULADOR WITH (NOLOCK)
					WHERE TZ_LOCK = 0 
						AND CODIGO IN (	SELECT COD_ACUMULADOR 
										FROM CRE_RECIBOCONCEPTO WITH (NOLOCK)
										WHERE CODIGO = d.CONCEPTO 
											AND TZ_LOCK = 0)) = ''N'' THEN 0 
		ELSE CASE WHEN HABITUAL = ''N'' THEN 0 ELSE ROUND((IMPORTE*PORCENTAJE_AFECTACION/100),2) END END AS IMPORTE_AFECTADO
	FROM CRE_SOL_RECIBO_SUELDO_DET d WITH (NOLOCK)
	INNER JOIN (
				SELECT t.SOLICITUD, t.NUMERO_RECIBO, t.DOCUMENTO 
				FROM (	select *, 
							row_number() over (partition by ID_BENEFICIO, JURIDICCION, NOMBRE_BENEFICIO order by CAST(SUBSTRING(PERIODO,4,4) AS INT) desc, 
							CAST(SUBSTRING(PERIODO,1,2) AS INT) desc) as rn 
						from CRE_SOL_RECIBO_SUELDO WITH (NOLOCK)
						WHERE DOCUMENTO = @DOCUMENTO AND TZ_LOCK = 0 AND DESCARTADO = ''N'') t
				WHERE t.rn = 1) c
				ON c.SOLICITUD = d.SOLICITUD AND c.NUMERO_RECIBO = d.NUMERO_RECIBO AND c.DOCUMENTO = d.DOCUMENTO
	WHERE d.TZ_LOCK = 0;
	
	INSERT INTO dbo.CRE_SOL_RECIBO_SUELDO (SOLICITUD, NUMERO_RECIBO, DOCUMENTO, PERIODO, CONVENIO, ID_BENEFICIO, JURIDICCION, FECHA_INGRESO, HABERES, DESCUENTOS, DEDUCCIONES, LIQUIDO, SITUACION_REVISTA, NETO, TZ_LOCK, COPIADO, DESCARTADO, NOMBRE_BENEFICIO)
	SELECT @SOLICITUD AS SOLICITUD, NUMERO_RECIBO, DOCUMENTO, PERIODO, CONVENIO, ID_BENEFICIO, JURIDICCION, FECHA_INGRESO, HABERES, DESCUENTOS, DEDUCCIONES, LIQUIDO, SITUACION_REVISTA, NETO, TZ_LOCK, ''S'' AS COPIADO, ''N'' AS DESCARTADO, NOMBRE_BENEFICIO 
	FROM(	select *, 
				row_number() over (partition by ID_BENEFICIO, JURIDICCION, NOMBRE_BENEFICIO order by CAST(SUBSTRING(PERIODO,4,4) AS INT) desc, 
				CAST(SUBSTRING(PERIODO,1,2) AS INT) desc) as rn 
			from CRE_SOL_RECIBO_SUELDO WITH (NOLOCK)
			WHERE DOCUMENTO = @DOCUMENTO 
				AND TZ_LOCK = 0 AND DESCARTADO = ''N'') t
	WHERE t.rn = 1;

   END
')

