EXECUTE('
IF OBJECT_ID (''dbo.VW_CLE_CHEQUES_AJUSTE'') IS NOT NULL
	DROP VIEW dbo.VW_CLE_CHEQUES_AJUSTE
')
EXECUTE('
CREATE VIEW VW_CLE_CHEQUES_AJUSTE (
	ORDINAL,
	BANCO,
	NOMBRE_BANCO,
	FECHA_ALTA,
	ESTADO,
	IMPORTE,
	ENVIADO_RECIBIDO,
	ESTADO_AJUSTE,
	FECHA_ENVIO_CAMARA,
	MONEDA,
	FECHA_ACREDITACION,
	NRO_ASIENTO,
	SUCURSAL_DE_INGRESO)
AS
SELECT
	CA.ORDINAL,
	CASE CA.ENVIADO_RECIBIDO 
		WHEN ''R'' THEN
			CASE CA.MONEDA
				WHEN 2 THEN 
					(REVERSE(SUBSTRING(REVERSE(CA.TRACKNUMBER),12,4)) - 500)
				ELSE 
					(REVERSE(SUBSTRING(REVERSE(CA.TRACKNUMBER),12,4)))
			END
		ELSE 
			CA.BANCO
	END,
	B.NOMBRE,
	CA.FECHA_ALTA,
	OE.DESCRIPCION AS ESTADO,
	CA.IMPORTE,
	OER.DESCRIPCION AS ENVIADO_RECIBIDO,
	OEA.DESCRIPCION AS ESTADO_AJUSTE,
	CA.FECHA_ENVIO_CAMARA,
	CA.MONEDA,
	CA.FECHA_ACREDITACION,
	CA.NRO_ASIENTO,
	CA.SUCURSAL_DE_INGRESO
FROM CLE_CHEQUES_AJUSTE CA WITH (nolock)
LEFT JOIN CLI_BANCOSPLAZA AS B WITH (nolock) ON
	B.SUCURSAL = 0
	AND B.TZ_LOCK = 0
	AND B.CODIGOBC = 
		CASE CA.ENVIADO_RECIBIDO 
			WHEN ''R'' THEN
				CASE CA.MONEDA
					WHEN 2 THEN 
						(REVERSE(SUBSTRING(REVERSE(CA.TRACKNUMBER),12,4)) - 500)
					ELSE 
						(REVERSE(SUBSTRING(REVERSE(CA.TRACKNUMBER),12,4)))
				END
			ELSE 
				CA.BANCO
		END
LEFT JOIN OPCIONES AS OE WITH (nolock) ON
	OE.NUMERODECAMPO = 35559
	AND OE.IDIOMA = ''E''
	AND OE.OPCIONINTERNA = CA.ESTADO
LEFT JOIN OPCIONES AS OER WITH (nolock) ON
	OER.NUMERODECAMPO = 35565
	AND OER.IDIOMA = ''E''
	AND OER.OPCIONINTERNA = CA.ENVIADO_RECIBIDO
LEFT JOIN OPCIONES AS OEA WITH (nolock) ON
	OEA.NUMERODECAMPO = 35567
	AND OEA.IDIOMA = ''E''
	AND OEA.OPCIONINTERNA = CA.ESTADO_AJUSTE
')

