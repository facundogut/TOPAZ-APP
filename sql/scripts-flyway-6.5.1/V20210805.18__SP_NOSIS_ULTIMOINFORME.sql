
/****** Object:  StoredProcedure [dbo].[SP_NOSIS_ULTIMOINFORME]    Script Date: 31/05/2021 16:37:47 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE or ALTER PROCEDURE [dbo].[SP_NOSIS_ULTIMOINFORME]

/*

Desarrollador: Luis Etchebarne

Descripción: Este SP tiene la finalidad de ingresar los datos del UltimoInforme obtenidos desde el ws de NOSIS

*/

@COD_ENTIDAD NUMERIC(3),
@ENT_COD   VARCHAR(20),
@MONTO   NUMERIC(12,5),
@PERIODO   NUMERIC(6),
@PROC_JUD NUMERIC(1),
@LINEA_TOTAL   NUMERIC(15,2),
@COD_LINEA NUMERIC(12),
@ENTIDAD  VARCHAR(50),
@SIT   NUMERIC(1),
@COMPROMISOS_MENSUALES NUMERIC(15,2),
@MONTO_TOTAL NUMERIC(15,2),
@CUIT   VARCHAR(11),
@FECHA_PROCESO DATETIME



AS
BEGIN
	-- Manejo del ordinal de la tabla
	DECLARE @cont INT;
	SET @cont = (SELECT TOP 1 a.* FROM (SELECT (COUNT(*) + 1) AS ORDINAL FROM dbo.SL_NOSIS_ULTIMOINFORME with (nolock) WHERE CUIT = @CUIT AND FECHA_PROCESO = @FECHA_PROCESO UNION ALL SELECT 0 AS ORDINAL) AS a);
	 
	IF @COD_ENTIDAD > 0
    BEGIN
    	
		INSERT INTO dbo.SL_NOSIS_ULTIMOINFORME (COD_ENTIDAD, ENT_COD, MONTO, PERIODO, PROC_JUD, LINEA_TOTAL, COD_LINEA, ENTIDAD, SIT, COMPROMISOS_MENSUALES, CUIT, FECHA_PROCESO, ORDINAL, MONTO_TOTAL)
		VALUES (@COD_ENTIDAD, @ENT_COD, @MONTO, @PERIODO, @PROC_JUD, @LINEA_TOTAL, @COD_LINEA, @ENTIDAD, @SIT, @COMPROMISOS_MENSUALES, @CUIT, @FECHA_PROCESO, @cont, @MONTO_TOTAL);
				
	END
    	  
END