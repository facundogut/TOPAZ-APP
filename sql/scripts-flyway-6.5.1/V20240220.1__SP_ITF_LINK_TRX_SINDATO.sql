EXECUTE('
CREATE OR ALTER     PROCEDURE    SP_ITF_LINK_TRX_SINDATO
	@Error VARCHAR(250) OUTPUT
AS
BEGIN
    SET @Error = '' '';
	
	BEGIN TRY
		
		
		
  		SELECT ID_TARJETA = substring(Linea,731,19),
		   	ESTADO = substring(Linea, 780, 1),
		   	FECHA_ENTREGA = CASE WHEN substring(Linea, 825, 8) <> ''00000000'' THEN CAST(substring(Linea, 825, 8) AS DATETIME) ELSE NULL End,
        	VENCIMIENTO = CAST(DATEFROMPARTS(substring(Linea, 776, 2) + 2000, substring(Linea, 778, 2), 1) AS DATETIME),
        	NOMBRE_TARJETA = Concat(trim(substring(Linea, 548, 14)), '' '', substring(Linea, 563, 15)),
        	ID_TARJETA_TITULAR = substring(Linea, 731, 19),
        	PERMISO = substring(Linea,771,2),
        	LIMITE_CREDITO = substring(Linea,769,2),
        	LIMITE_DEBITO = substring(Linea,767,2),
        	NUM_VERSION = substring(Linea,763,1),
        	DIGITO_VERIFICADOR = substring(Linea,764,1),
        	ID_TARJETA_BASE = substring(Linea, 132, 19),
        	--
        	CODIGO_PRODUCTO = substring(Linea, 178, 4),
        	NUM_DOC_FISICO = CAST(CAST(REPLACE(substring(Linea,539,9),''.'' ,'''') AS NUMERIC) AS VARCHAR(20)),
        	TIPO_DOC_FISICO = substring(Linea,536,3),
        	TITULARIDAD = (CASE WHEN substring(TRX.Linea,750,1) = ''0'' THEN ''T'' ELSE ''C'' END)
       	 INTO #TMP_LINK
	   FROM ITF_LINK_TRK TRX (nolock)
	   WHERE NOT EXISTS(SELECT 1 FROM VTA_SALDOS VS (nolock)
		JOIN SALDOS S (nolock) ON VS.CTA_REDLINK = substring(TRX.Linea, 185, 19) AND VS.JTS_OID_SALDO = S.JTS_OID AND S.C1785 = CASE WHEN substring(TRX.Linea, 183, 2) = ''01'' THEN 2 ELSE 3 END
		JOIN TJD_TIPO_TARJETA TTT (nolock) ON TTT.CODIGO_PRODUCTO = substring(TRX.Linea, 178, 4)
		JOIN CLI_DocumentosPFPJ DPFJ (nolock) ON DPFJ.NUM_DOC_FISICO = CAST(CAST(REPLACE(substring(Linea,539,9),''.'' ,'''') AS NUMERIC) AS VARCHAR(20)) AND DPFJ.TIPO_DOC_FISICO = substring(Linea,536,3)
		--JOIN CLI_ClientePersona CCP (nolock) ON CCP.CODIGOCLIENTE = S.C1803 AND CCP.NUMEROPERSONA = DPFJ.NUMEROPERSONAFJ
			)
		  AND EXISTS(SELECT 1 FROM TJD_TIPOS_NOVEDADES_LINK WHERE CODIGO_LINK = SUBSTRING(Linea, 1, 6)  AND ACTUALIZA_BD = ''S'' AND TZ_LOCK = 0)
		  AND (SUBSTRING(Linea, 731, 19) <> ''                   '' AND SUBSTRING(Linea, 731, 19) <> ''0000000000000000000'');
		  
		SELECT JTS_OID_GTOS,
		  TIPO_TARJETA,
		  ID_TARJETA,
		  NRO_CLIENTE,
		  TITULARIDAD,
		  ESTADO,
		  FECHA_ENTREGA,
		  VENCIMIENTO,
		  NOMBRE_TARJETA,
		  SUCURSAL,
		  ID_TARJETA_TITULAR,
		  NRO_PERSONA,
		  PERMISO,
		  LIMITE_CREDITO,
		  LIMITE_DEBITO,
		  NUM_VERSION,
		  DIGITO_VERIFICADOR,
		  ID_TARJETA_BASE,
		  ESTADO_CUENTA
		  INTO #TMP_TJD_TARJETAS
		FROM(
			SELECT TIPO_CUENTA = TC.TIPO_CUENTA, 
			  NUMERO_CUENTA = TC.NUMERO_CUENTA,
			  JTS_OID_GTOS = S.JTS_OID,
			  NRO_CLIENTE = S.C1803,
			  SUCURSAL = S.SUCURSAL,
			  TIPO_TARJETA = TTT.TIPO_TARJETA,
			  TITULARIDAD = tmp.TITULARIDAD,
			  NRO_PERSONA = DPFJ.NUMEROPERSONAFJ,
			  ESTADO_CUENTA = CASE WHEN Estado_Cuenta IN (''M'', ''R'', ''W'', ''3'') THEN 1
								  WHEN Estado_cuenta NOT IN (''X'',''9'') AND Tipo_Cuenta = 11 THEN 2
								  WHEN Estado_cuenta NOT IN (''X'',''9'') AND Tipo_Cuenta = 11 THEN 2
								  WHEN Estado_Cuenta NOT IN (''X'',''9'') AND Tipo_Cuenta = 1 THEN 3
								  WHEN Estado_CUENTA NOT IN (''X'',''9'') AND Tipo_Cuenta = 15 THEN 4 
								  ELSE 5 END,
			  ID_TARJETA,
			  ESTADO,
			  FECHA_ENTREGA,
			  VENCIMIENTO,
			  NOMBRE_TARJETA,
			  ID_TARJETA_TITULAR,
			  PERMISO,
			  LIMITE_CREDITO,
			  LIMITE_DEBITO,
			  NUM_VERSION,
			  DIGITO_VERIFICADOR,
			  ID_TARJETA_BASE
			FROM TJD_ITF_TARJETAS_CUENTAS TC (nolock)
			  JOIN #TMP_LINK tmp ON tmp.ID_TARJETA  = TC.NroTarjeta
			  JOIN VTA_SALDOS VS (nolock) ON TC.NUMERO_CUENTA = VS.CTA_REDLINK 
			  JOIN SALDOS S (nolock) ON S.JTS_OID = VS.JTS_OID_SALDO AND S.C1785 = (CASE WHEN TC.Tipo_Cuenta = ''01'' THEN 2 ELSE 3 END)
			  JOIN TJD_TIPO_TARJETA TTT (nolock) ON TTT.CODIGO_PRODUCTO = tmp.CODIGO_PRODUCTO
			  JOIN CLI_DocumentosPFPJ DPFJ (nolock) ON CAST(DPFJ.NUM_DOC_FISICO as numeric) = tmp.NUM_DOC_FISICO AND DPFJ.TIPO_DOC_FISICO = tmp.TIPO_DOC_FISICO and ISNUMERIC(DPFJ.NUM_DOC_FISICO)=1
			  --JOIN CLI_ClientePersona CCP (nolock) ON CCP.CODIGOCLIENTE = S.C1803 AND CCP.NUMEROPERSONA = DPFJ.NUMEROPERSONAFJ
	    ) Z
		WHERE Z.ESTADO_CUENTA <> 5 
		--ORDER BY 9 ASC
		
		INSERT INTO TJD_TARJETAS(JTS_OID_GTOS,TIPO_TARJETA,ID_TARJETA,NRO_CLIENTE,TITULARIDAD,ESTADO,FECHA_ENTREGA,VENCIMIENTO,
		        NOMBRE_TARJETA,SUCURSAL,ID_TARJETA_TITULAR,NRO_PERSONA,PERMISO,LIMITE_CREDITO,LIMITE_DEBITO,NUM_VERSION,
		        DIGITO_VERIFICADOR,ID_TARJETA_BASE)
		SELECT JTS_OID_GTOS,TIPO_TARJETA,ID_TARJETA,NRO_CLIENTE,TITULARIDAD,ESTADO,FECHA_ENTREGA,VENCIMIENTO,
		        NOMBRE_TARJETA,SUCURSAL,ID_TARJETA_TITULAR,NRO_PERSONA,PERMISO,LIMITE_CREDITO,LIMITE_DEBITO,NUM_VERSION,
		        DIGITO_VERIFICADOR,ID_TARJETA_BASE 
		FROM (
			SELECT *, ROW_NUMBER() OVER (PARTITION BY ID_TARJETA ORDER BY SUCURSAL DESC) Orden
			FROM #TMP_TJD_TARJETAS
			WHERE ESTADO_CUENTA = 1
		) T
		WHERE Orden=1
		
		INSERT INTO TJD_TARJETAS(JTS_OID_GTOS,TIPO_TARJETA,ID_TARJETA,NRO_CLIENTE,TITULARIDAD,ESTADO,FECHA_ENTREGA,VENCIMIENTO,
		        NOMBRE_TARJETA,SUCURSAL,ID_TARJETA_TITULAR,NRO_PERSONA,PERMISO,LIMITE_CREDITO,LIMITE_DEBITO,NUM_VERSION,
		        DIGITO_VERIFICADOR,ID_TARJETA_BASE)
		SELECT JTS_OID_GTOS,TIPO_TARJETA,ID_TARJETA,NRO_CLIENTE,TITULARIDAD,ESTADO,FECHA_ENTREGA,VENCIMIENTO,
		        NOMBRE_TARJETA,SUCURSAL,ID_TARJETA_TITULAR,NRO_PERSONA,PERMISO,LIMITE_CREDITO,LIMITE_DEBITO,NUM_VERSION,
		        DIGITO_VERIFICADOR,ID_TARJETA_BASE 
		FROM (
			SELECT *, ROW_NUMBER() OVER (PARTITION BY ID_TARJETA ORDER BY SUCURSAL DESC) Orden
			FROM #TMP_TJD_TARJETAS T
			WHERE ESTADO_CUENTA = 2
		  	  AND NOT EXISTS(SELECT 1 FROM TJD_TARJETAS TJD WHERE TJD.ID_TARJETA = T.ID_TARJETA)
		) T
		WHERE Orden=1
		 
		INSERT INTO TJD_TARJETAS(JTS_OID_GTOS,TIPO_TARJETA,ID_TARJETA,NRO_CLIENTE,TITULARIDAD,ESTADO,FECHA_ENTREGA,VENCIMIENTO,
		        NOMBRE_TARJETA,SUCURSAL,ID_TARJETA_TITULAR,NRO_PERSONA,PERMISO,LIMITE_CREDITO,LIMITE_DEBITO,NUM_VERSION,
		        DIGITO_VERIFICADOR,ID_TARJETA_BASE)
		SELECT JTS_OID_GTOS,TIPO_TARJETA,ID_TARJETA,NRO_CLIENTE,TITULARIDAD,ESTADO,FECHA_ENTREGA,VENCIMIENTO,
		        NOMBRE_TARJETA,SUCURSAL,ID_TARJETA_TITULAR,NRO_PERSONA,PERMISO,LIMITE_CREDITO,LIMITE_DEBITO,NUM_VERSION,
		        DIGITO_VERIFICADOR,ID_TARJETA_BASE 
		FROM (
			SELECT *, ROW_NUMBER() OVER (PARTITION BY ID_TARJETA ORDER BY SUCURSAL DESC) Orden
			FROM #TMP_TJD_TARJETAS T
			WHERE ESTADO_CUENTA = 3
		  	  AND NOT EXISTS(SELECT 1 FROM TJD_TARJETAS TJD WHERE TJD.ID_TARJETA = T.ID_TARJETA)
		) T
		WHERE Orden=1
		
		INSERT INTO TJD_TARJETAS(JTS_OID_GTOS,TIPO_TARJETA,ID_TARJETA,NRO_CLIENTE,TITULARIDAD,ESTADO,FECHA_ENTREGA,VENCIMIENTO,
		        NOMBRE_TARJETA,SUCURSAL,ID_TARJETA_TITULAR,NRO_PERSONA,PERMISO,LIMITE_CREDITO,LIMITE_DEBITO,NUM_VERSION,
		        DIGITO_VERIFICADOR,ID_TARJETA_BASE)
		SELECT JTS_OID_GTOS,TIPO_TARJETA,ID_TARJETA,NRO_CLIENTE,TITULARIDAD,ESTADO,FECHA_ENTREGA,VENCIMIENTO,
		        NOMBRE_TARJETA,SUCURSAL,ID_TARJETA_TITULAR,NRO_PERSONA,PERMISO,LIMITE_CREDITO,LIMITE_DEBITO,NUM_VERSION,
		        DIGITO_VERIFICADOR,ID_TARJETA_BASE 
		FROM (
			SELECT *, ROW_NUMBER() OVER (PARTITION BY ID_TARJETA ORDER BY SUCURSAL DESC) Orden
			FROM #TMP_TJD_TARJETAS T
			WHERE ESTADO_CUENTA = 4
		  	  AND NOT EXISTS(SELECT 1 FROM TJD_TARJETAS TJD WHERE TJD.ID_TARJETA = T.ID_TARJETA)
		) T
		WHERE Orden=1
		  
	END TRY

    BEGIN CATCH
         -- Captura la excepcion y almacena el mensaje de error en la variable @Error
         SET @Error = CONCAT(''Linea '',ERROR_LINE(), '' - '' , ERROR_MESSAGE());
    END CATCH;	

END;
')