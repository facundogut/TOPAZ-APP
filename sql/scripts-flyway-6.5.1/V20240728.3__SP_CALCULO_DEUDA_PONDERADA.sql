EXECUTE('
ALTER PROCEDURE dbo.SP_CALCULO_DEUDA_PONDERADA
   @P_CLIENTE NUMERIC(12),
   @P_NUMSOLICITUD NUMERIC(12),
   @P_DEUDA NUMERIC(20,2) OUT
AS 
   BEGIN
   DECLARE @CONSUMO NUMERIC(5)
   DECLARE @COMERCIAL NUMERIC(5)
   DECLARE @PORC_PONDERA NUMERIC(5,2)
   DECLARE @TIENE_LIMITE NUMERIC(2)
   DECLARE @MONTO_LIMITE NUMERIC(15,2)
   DECLARE @PRODUCTO_SOL NUMERIC(5)
   DECLARE @MONTO_SOL NUMERIC(15,2)
   DECLARE @CATEGORIA_SOL VARCHAR(1)
   DECLARE @GARANTIA_PREF NUMERIC(1)
   DECLARE @DEUDA_TOTAL NUMERIC(20,2)
   DECLARE @DEUDA_POND NUMERIC(20,2)
   DECLARE @CUENTA_ACRED NUMERIC(10)
   DECLARE @INGRESO_FIJO VARCHAR(1)
   
   SET @CONSUMO=0;
   SET @COMERCIAL=0;
   SET @TIENE_LIMITE=0;
   
   SELECT @CONSUMO=COUNT(1) FROM CRE_SALDOS WITH(NOLOCK) WHERE SALDOS_JTS_OID IN (SELECT JTS_OID FROM SALDOS
   WITH(NOLOCK) WHERE C1803 = @P_CLIENTE AND C1604 <> 0 AND C1785 IN (1,5,6) AND CATEGORIA_COMERCIAL = ''C'' AND TZ_LOCK=0)
   
   SELECT @COMERCIAL=COUNT(1) FROM CRE_SALDOS WITH(NOLOCK) WHERE SALDOS_JTS_OID IN (SELECT JTS_OID FROM SALDOS
   WITH(NOLOCK) WHERE C1803 = @P_CLIENTE AND C1604 <> 0 AND C1785 IN (1,5,6) AND TZ_LOCK=0 
   AND (CATEGORIA_COMERCIAL = ''M'' OR CATEGORIA_COMERCIAL = ''S''))
   
   SELECT @TIENE_LIMITE=COUNT(1), @MONTO_LIMITE=MONTO FROM CRE_LIMITECLIENTE WITH(NOLOCK) WHERE CLIENTE = @P_CLIENTE
   AND TZ_LOCK = 0 AND ESTADO = ''A'' AND PLAZO >= (SELECT FECHAPROCESO FROM PARAMETROS WITH(NOLOCK))
   GROUP BY MONTO
   
   SET @MONTO_SOL = 0;
   
   SET @INGRESO_FIJO = ''N'';
   
   IF(@P_NUMSOLICITUD <> 0)
   BEGIN
    SELECT @PRODUCTO_SOL = CODPRODUCTOSOLICITADO, 
    @MONTO_SOL = ISNULL(SUM(CASE WHEN P.C6800 = ''L'' THEN ISNULL(S.MONTO_TOTAL_DESGLOSE,0) ELSE S.MONTOSOLICITADO END),0), 
    @CUENTA_ACRED = JTS_CUENTA_ACREDITAR
    FROM CRE_SOLICITUDCREDITO S WITH(NOLOCK)
    INNER JOIN PRODUCTOS P WITH(NOLOCK) ON S.CODPRODUCTOSOLICITADO = P.C6250 
    WHERE NUMEROSOLICITUD = @P_NUMSOLICITUD
    AND S.TZ_LOCK = 0 AND P.TZ_LOCK = 0
    GROUP BY CODPRODUCTOSOLICITADO, JTS_CUENTA_ACREDITAR
    
    SELECT @CATEGORIA_SOL = C6825 FROM PRODUCTOS WITH(NOLOCK) WHERE C6250 = @PRODUCTO_SOL AND TZ_LOCK = 0
    
    SELECT @GARANTIA_PREF = COUNT(1) 
    FROM CRE_REL_SOLICITUDGARANTIA S WITH(NOLOCK)
    INNER JOIN CRE_GARANTIASRECIBIDAS G WITH(NOLOCK) ON S.GARANTIA = G.NUM_GARANTIA
    INNER JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON G.TIPOGARANTIA = CTG.TIPO_GARANTIA AND
    CTG.TIPO_BCRA IN (1,2)
    WHERE S.SOLICITUD = @P_NUMSOLICITUD
    
    SELECT @INGRESO_FIJO = CASE WHEN P.C6826 IN (2,3) THEN ''S'' ELSE ''N'' END
    FROM SALDOS S WITH(NOLOCK)
    INNER JOIN PRODUCTOS P WITH(NOLOCK) ON S.PRODUCTO = P.C6250
    WHERE S.JTS_OID = @CUENTA_ACRED AND S.TZ_LOCK=0
    
   END
   
   IF((@CONSUMO > 0 OR @CATEGORIA_SOL = ''C'') AND (@COMERCIAL > 0 OR @CATEGORIA_SOL = ''M''))
   BEGIN
     SET @PORC_PONDERA = (SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 650)
   END
   ELSE
   BEGIN
     SET @PORC_PONDERA = 0;
   END
   
   IF(@INGRESO_FIJO = ''N'')
   BEGIN
    IF(@TIENE_LIMITE = 0 OR @TIENE_LIMITE IS NULL)
    BEGIN
     SELECT @P_DEUDA=ISNULL(SUM(CASE WHEN AD.CAPITAL_ORIGEN > AD.SALDO_DEUDA AND @PORC_PONDERA = 0
     THEN AD.CAPITAL_ORIGEN 
     WHEN AD.CAPITAL_ORIGEN < AD.SALDO_DEUDA AND @PORC_PONDERA = 0
     THEN AD.SALDO_DEUDA 
     WHEN AD.CAPITAL_ORIGEN > AD.SALDO_DEUDA AND @PORC_PONDERA > 0 AND CTG.TIPO_BCRA IS NOT NULL
     THEN AD.CAPITAL_ORIGEN - ((AD.CAPITAL_ORIGEN*@PORC_PONDERA)/100)
     WHEN AD.CAPITAL_ORIGEN < AD.SALDO_DEUDA AND @PORC_PONDERA > 0 AND CTG.TIPO_BCRA IS NOT NULL
     THEN AD.SALDO_DEUDA - ((AD.SALDO_DEUDA*@PORC_PONDERA)/100)
     WHEN AD.CAPITAL_ORIGEN > AD.SALDO_DEUDA AND @PORC_PONDERA > 0 AND CTG.TIPO_BCRA IS NULL
     THEN AD.CAPITAL_ORIGEN 
     WHEN AD.CAPITAL_ORIGEN < AD.SALDO_DEUDA AND @PORC_PONDERA > 0 AND CTG.TIPO_BCRA IS NULL
     THEN AD.SALDO_DEUDA
     END),0)
     FROM VW_ASISTENCIAS_DEUDA AD WITH(NOLOCK)
     INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = AD.JTS_OID AND S.TZ_LOCK=0
     LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID
     LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA
     LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND
     CTG.TIPO_BCRA IN (1,2)
     WHERE S.C1785 IN (1,5,6)
     AND AD.CLIENTE = @P_CLIENTE AND AD.SALDO_DEUDA <> 0
   
     IF(@PORC_PONDERA > 0 AND @GARANTIA_PREF IS NOT NULL AND @GARANTIA_PREF > 0)
     BEGIN
      SET @MONTO_SOL = (@MONTO_SOL * @PORC_PONDERA)/100
     END 
   
     SET @P_DEUDA = @MONTO_SOL + @P_DEUDA;
   
    END
    
    ELSE
    BEGIN
 
     IF(@P_NUMSOLICITUD = 0 OR @P_NUMSOLICITUD IS NULL)
     BEGIN
      SET @P_DEUDA = @MONTO_LIMITE
     END
     ELSE
     BEGIN
      SELECT @DEUDA_TOTAL=ISNULL(SUM(AD.SALDO_DEUDA),0)
      FROM VW_ASISTENCIAS_DEUDA AD WITH(NOLOCK)
      INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = AD.JTS_OID
      WHERE S.C1785 IN (1,5,6) AND S.TZ_LOCK=0
      AND AD.CLIENTE = @P_CLIENTE AND AD.SALDO_DEUDA <> 0
   
      SELECT @DEUDA_POND=ISNULL(SUM(CASE WHEN @PORC_PONDERA = 0
      THEN AD.SALDO_DEUDA 
      WHEN @PORC_PONDERA > 0 AND CTG.TIPO_BCRA IS NOT NULL
      THEN AD.SALDO_DEUDA - ((AD.SALDO_DEUDA*@PORC_PONDERA)/100)
      WHEN @PORC_PONDERA > 0 AND CTG.TIPO_BCRA IS NULL
      THEN AD.SALDO_DEUDA
      END),0)
      FROM VW_ASISTENCIAS_DEUDA AD WITH(NOLOCK)
      INNER JOIN SALDOS S WITH(NOLOCK) ON S.JTS_OID = AD.JTS_OID AND S.TZ_LOCK=0
      LEFT JOIN CRE_GARANTIACREDITO CG WITH(NOLOCK) ON CG.JTSOID_SALDO = S.JTS_OID
      LEFT JOIN CRE_GARANTIASRECIBIDAS CGR WITH(NOLOCK) ON CGR.NUM_GARANTIA = CG.NUM_GARANTIA
      LEFT JOIN CRE_TIPOSGARANTIAS CTG WITH(NOLOCK) ON CGR.TIPOGARANTIA = CTG.TIPO_GARANTIA AND
      CTG.TIPO_BCRA IN (1,2)
      WHERE S.C1785 IN (1,5,6)
      AND AD.CLIENTE = @P_CLIENTE AND AD.SALDO_DEUDA <> 0
   
      SET @P_DEUDA = (@MONTO_LIMITE - @DEUDA_TOTAL) + @DEUDA_POND + @MONTO_SOL;
   
     END
   
    END
   
   END
   
   ELSE
   BEGIN
    SET @P_DEUDA = 0;
   END
   
   -- Si no tiene deudas de ambos mundos y lo que esta solicitando es una asistencia de consumo, siempre es
   -- consumo, por lo que debemos retornar deuda en 0 para que asigne la categoria del producto.
   IF((@CONSUMO > 0 OR @CATEGORIA_SOL = ''C'') AND (@COMERCIAL = 0 AND @TIENE_LIMITE = 0))
   BEGIN
     SET @P_DEUDA = 0;
   END
   
   END
')

