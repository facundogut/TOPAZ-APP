EXECUTE('
IF OBJECT_ID (''dbo.VW_VINCULACIONES_DEUDAS'') IS NOT NULL
	DROP VIEW dbo.VW_VINCULACIONES_DEUDAS
')

EXECUTE('
CREATE VIEW dbo.VW_VINCULACIONES_DEUDAS 
([ID Vinculo],[Descripcion Vinculo], [Cliente Vinculado], [Nombre Vinculado],
[Cliente Vinculante], [Nombre Vinculante], Situacion, [Deuda Total],
[Vinculo Primario], [Descripcion Vinculo Primario], [Vinculo secundario],
[Descripcion Vinculo Secundario]) AS
SELECT CV.ID, CV.DESCRIPCION, CDV.CODIGOCLIENTE AS CLIENTE_VINCULADO, CDV.NOMBRECLIENTE AS NOMBRE_VINCULADO,
CXD.CODIGOCLIENTE AS CLIENTE_VINCULANTE, CXD.NOMBRECLIENTE AS NOMBRE_VINCULANTE,
CLI.CATEGORIARESULTANTE AS SITUACION,
SUM(ISNULL(AD.SALDO_DEUDA,0)) AS DEUDA_TOTAL,
VP.ID, VP.DESCRIPCION, VS.ID, VS.DESCRIPCION
FROM CLI_VINCULACIONES V WITH(NOLOCK)
INNER JOIN CLI_VINCULOS CV WITH(NOLOCK) ON V.VINCULO = CV.ID
INNER JOIN VW_CLI_X_DOC CDV WITH(NOLOCK) ON V.PERSONA_VINCULADA = CDV.NUMEROPERSONA
INNER JOIN VW_CLI_X_DOC CXD WITH(NOLOCK) ON V.PERSONA_VINCULANTE = CXD.NUMEROPERSONA
INNER JOIN CLI_CLIENTES CLI WITH(NOLOCK) ON CDV.CODIGOCLIENTE = CLI.CODIGOCLIENTE
INNER JOIN CLI_VINCULOS_PRIMARIOS VP WITH(NOLOCK) ON VP.ID = CV.VINCULO_PRIMARIO
INNER JOIN CLI_VINCULOS_SECUNDARIOS VS WITH(NOLOCK) ON VS.ID = CV.VINCULO_SECUNDARIO
LEFT JOIN VW_DEUDA_CLIENTES AD WITH(NOLOCK) ON AD.CLIENTE = CDV.CODIGOCLIENTE AND AD.JTS_OID IN (SELECT JTS_OID FROM SALDOS WITH(NOLOCK) WHERE C1785 IN (1,5,6) AND TZ_LOCK=0)
WHERE V.TZ_LOCK = 0 AND CV.TZ_LOCK = 0
AND (V.FECHA_FIN IS NULL OR DATEADD(yy,(SELECT IMPORTE FROM CRE_PARAMETROS WITH(NOLOCK) WHERE CODIGO = 613),V.FECHA_FIN) >= (SELECT FECHAPROCESO FROM PARAMETROS))
GROUP BY CV.ID, CV.DESCRIPCION, CDV.CODIGOCLIENTE, CLI.CATEGORIARESULTANTE, CXD.CODIGOCLIENTE,
VP.ID, VP.DESCRIPCION, VS.ID, VS.DESCRIPCION, CDV.NOMBRECLIENTE, CXD.NOMBRECLIENTE
')

