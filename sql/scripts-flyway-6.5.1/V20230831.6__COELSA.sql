Execute('drop table dbo.CLE_IMG_CHEQUES_AUX;
drop table dbo.ITF_COELSA_CHEQUES_PROPIOS_AUX;
drop table dbo.ITF_COELSA_IMAGENES_CHEQUES_PROPIOS_AUX;
drop table dbo.ITF_INTERMEDIA_COELSA_CHEQUES;
drop table dbo.ITF_CHEQUES_RECIBIDOS_AUX;
drop table dbo.ITF_CONTROL_IMAGENES_CHEQUES_RECIBIDOS_AUX;
drop procedure dbo.SP_COELSA_CHEQUES_PRESENTADOS_RECIBIDOS;
drop procedure dbo.SP_COELSA_IMAGENES_CHEQUES_PRESENTADOS_RECIBIDOS;
drop procedure [dbo].[SP_LAUNCH_SESION_PRESENTADOS_PROPIOS_ITF];
drop procedure [dbo].[SP_LAUNCH_SESION_PRESENTADOS_PROPIOS_FINAL];')

Execute('
delete from dbo.ITF_MASTER where ID = 150;
insert into dbo.ITF_MASTER (TZ_LOCK,ID,DESCRIPCION,OBJ_KETTLE,P0_MODO,P0_TIPO,P0_CAPTION,P0_CONSTANTE,P1_MODO,P1_TIPO,P1_CAPTION,P1_CONSTANTE,P2_MODO,P2_TIPO,P2_CAPTION,P2_CONSTANTE,P3_MODO,P3_TIPO,P3_CAPTION,P3_CONSTANTE,P4_MODO,P4_TIPO,P4_CAPTION,P4_CONSTANTE,P5_MODO,P5_TIPO,P5_CAPTION,P5_CONSTANTE,P6_MODO,P6_TIPO,P6_CAPTION,P6_CONSTANTE,P7_MODO,P7_TIPO,P7_CAPTION,P7_CONSTANTE,P8_MODO,P8_TIPO,P8_CONSTANTE,P8_CAPTION,P9_MODO,P9_TIPO,P9_CAPTION,P9_CONSTANTE,TIPO_OBJ,COMENTARIO,ID_REPORTE,MODO_EJECUCION) 
values (0,150,''Eliminar Archivo NO Reprocesable'',''ITF_GENERICO_MD5_BORRAR.kjb'',''P'',''S'',''Valor MD5'','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '','' '',''J'',''Borra MD5 de Base de Datos'',0,''M'');')

Execute('create OR ALTER procedure [dbo].[SP_COELSA_IMPORTA_ITF_CHEQUES_AJUSTES_SESION_PRESENTADOS_PROPIOS]
@P_ID_PROCESO float(53),   /* Identificador de proceso */
@P_DT_PROCESO  datetime2(0),  /* Fecha de proceso */
@P_RET_PROCESO float(53)  OUTPUT,  /* Estado de ejecucion SQL( 1:Correcto, 2: Error ) */
@P_MSG_PROCESO varchar(max)  OUTPUT  /*Mensaje de salida*/
as
begin
	--Importa Cheques y Ajustes CP0
	insert into [dbo].[ITF_COELSA_CHEQUES_PROPIOS] (ID_TICKET, ID_PROCESO, FECHAPROCESO, CODIGO_TRANSACCION, ENTIDAD_DEBITAR, CUENTA_DEBITAR, IMPORTE, CODIGO_POSTAL, FECHA_PRESENTADO, FECHA_VENCIMIENTO, NRO_CHEQUE, PUNTO_INTERCAMBIO, TRACE_NUMBER, ESTADO, TIPO, INFO_ADICIONAL)
	select ID_TICKET, ID_PROCESO, FECHAPROCESO, CODIGO_TRANSACCION, ENTIDAD_DEBITAR, CUENTA_DEBITAR, IMPORTE, CODIGO_POSTAL, FECHA_PRESENTADO, FECHA_VENCIMIENTO, NRO_CHEQUE, PUNTO_INTERCAMBIO, TRACE_NUMBER, ESTADO, TIPO, INFO_ADICIONAL
	from [dbo].[ITF_COELSA_CLS_CP0];
	
	--Importa Control de Imagenes para Cheques VCP
	insert into [dbo].[ITF_COELSA_IMAGENES_CHEQUES_PROPIOS] (ID_TICKET, ID_PROCESO, FECHA_PROCESO, ESTADO, ID_REGISTRO, BANCO_DEPOSITARIO, BANCO_GIRADO, SUCURSAL_GIRADA, CODIGO_POSTAL, NRO_CHEQUE, NRO_CUENTA, FECHA_PRESENTACION, FECHA_COMPENSACION, ESTADO_TRAN, NOMBRE_IMAGEN)
	select ID_TICKET, ID_PROCESO, FECHA_PROCESO, ESTADO, ID_REGISTRO, BANCO_DEPOSITARIO, BANCO_GIRADO, SUCURSAL_GIRADA, CODIGO_POSTAL, NRO_CHEQUE, NRO_CUENTA, FECHA_PRESENTACION, FECHA_COMPENSACION, ESTADO_TRAN, NOMBRE_IMAGEN
	from [dbo].[ITF_COELSA_CLS_VCP];
	
	--Importa Imagenes de Cheques VIP
	merge [dbo].[CLE_IMG_CHEQUES] as tgt
	using [dbo].[ITF_COELSA_CLS_VIP] as src
	on (tgt.CMC7 = src.CMC7)
	when matched then
		update set tgt.FECHAALTA = src.FECHAALTA, tgt.TIPO = src.TIPO, tgt.IMGFRENTEDORSO = src.IMGFRENTEDORSO, tgt.IMGIMPORTE = src.IMGIMPORTE, tgt.IMGFECHA = src.IMGFECHA, tgt.IMGORDENANTE = src.IMGORDENANTE, tgt.ASIENTO = src.ASIENTO, tgt.SUCURSAL = src.SUCURSAL, tgt.FECHAPROCESO = src.FECHAPROCESO, tgt.ENPXWDOC = src.ENPXWDOC, tgt.ORIGENIMAGEN = src.ORIGENIMAGEN
	when not matched then
		insert values (src.CMC7, src.FECHAALTA, src.TIPO, src.IMGFRENTEDORSO, src.IMGIMPORTE, src.IMGFECHA, src.IMGORDENANTE, src.ASIENTO, src.SUCURSAL, src.FECHAPROCESO, src.ENPXWDOC, src.ORIGENIMAGEN)
	;
	
	truncate table [dbo].[ITF_COELSA_CLS_CP0];
	truncate table [dbo].[ITF_COELSA_CLS_VCP];
	truncate table [dbo].[ITF_COELSA_CLS_VIP];

	--Salida
	SET @p_msg_proceso = ''Importacion Correcta'';
	SET @p_ret_proceso = 1;

end;')


Execute('create OR ALTER procedure [dbo].[SP_COELSA_IMPORTA_ITF_DPFD_SESION_PRESENTADOS_PROPIOS]
@P_ID_PROCESO float(53),   /* Identificador de proceso */
@P_DT_PROCESO  datetime2(0),  /* Fecha de proceso */
@P_RET_PROCESO float(53)  OUTPUT,  /* Estado de ejecucion SQL( 1:Correcto, 2: Error ) */
@P_MSG_PROCESO varchar(max)  OUTPUT  /*Mensaje de salida*/
as
begin
	--Importa Depositos y Ajustes CP1
	insert into [dbo].[ITF_COELSA_CHEQUES_PROPIOS] (ID_TICKET, ID_PROCESO, FECHAPROCESO, CODIGO_TRANSACCION, ENTIDAD_DEBITAR, CUENTA_DEBITAR, IMPORTE, CODIGO_POSTAL, FECHA_PRESENTADO, FECHA_VENCIMIENTO, NRO_CHEQUE, PUNTO_INTERCAMBIO, TRACE_NUMBER, ESTADO, TIPO, INFO_ADICIONAL)
	select ID_TICKET, ID_PROCESO, FECHAPROCESO, CODIGO_TRANSACCION, ENTIDAD_DEBITAR, CUENTA_DEBITAR, IMPORTE, CODIGO_POSTAL, FECHA_PRESENTADO, FECHA_VENCIMIENTO, NRO_CHEQUE, PUNTO_INTERCAMBIO, TRACE_NUMBER, ESTADO, TIPO, INFO_ADICIONAL
	from [dbo].[ITF_COELSA_CLS_CP1];

	--Importa Control de Imagenes para Cheques VCD
	insert into [dbo].[ITF_COELSA_IMAGENES_CHEQUES_PROPIOS] (ID_TICKET, ID_PROCESO, FECHA_PROCESO, ESTADO, ID_REGISTRO, BANCO_DEPOSITARIO, BANCO_GIRADO, SUCURSAL_GIRADA, CODIGO_POSTAL, NRO_CHEQUE, NRO_CUENTA, FECHA_PRESENTACION, FECHA_COMPENSACION, ESTADO_TRAN, NOMBRE_IMAGEN)
	select ID_TICKET, ID_PROCESO, FECHA_PROCESO, ESTADO, ID_REGISTRO, BANCO_DEPOSITARIO, BANCO_GIRADO, SUCURSAL_GIRADA, CODIGO_POSTAL, NRO_CHEQUE, NRO_CUENTA, FECHA_PRESENTACION, FECHA_COMPENSACION, ESTADO_TRAN, NOMBRE_IMAGEN
	from [dbo].[ITF_COELSA_CLS_VCD];

	--Importa Imagenes de Cheques VID
	merge [dbo].[CLE_IMG_CHEQUES] as tgt
	using [dbo].[ITF_COELSA_CLS_VID] as src
	on (tgt.CMC7 = src.CMC7)
	when matched then
		update set tgt.FECHAALTA = src.FECHAALTA, tgt.TIPO = src.TIPO, tgt.IMGFRENTEDORSO = src.IMGFRENTEDORSO, tgt.IMGIMPORTE = src.IMGIMPORTE, tgt.IMGFECHA = src.IMGFECHA, tgt.IMGORDENANTE = src.IMGORDENANTE, tgt.ASIENTO = src.ASIENTO, tgt.SUCURSAL = src.SUCURSAL, tgt.FECHAPROCESO = src.FECHAPROCESO, tgt.ENPXWDOC = src.ENPXWDOC, tgt.ORIGENIMAGEN = src.ORIGENIMAGEN
	when not matched then
		insert values (src.CMC7, src.FECHAALTA, src.TIPO, src.IMGFRENTEDORSO, src.IMGIMPORTE, src.IMGFECHA, src.IMGORDENANTE, src.ASIENTO, src.SUCURSAL, src.FECHAPROCESO, src.ENPXWDOC, src.ORIGENIMAGEN)
	;
	
	truncate table [dbo].[ITF_COELSA_CLS_CP1];
	truncate table [dbo].[ITF_COELSA_CLS_VCD];
	truncate table [dbo].[ITF_COELSA_CLS_VID];

	--Salida
	SET @p_msg_proceso = ''Importacion Correcta'';
	SET @p_ret_proceso = 1;

end;')

Execute('CREATE TABLE dbo.ITF_COELSA_CLS_VID (
	CMC7 varchar(200) COLLATE Modern_Spanish_CI_AS NOT NULL,
	FECHAALTA datetime NULL,
	TIPO varchar(1) COLLATE Modern_Spanish_CI_AS NOT NULL,
	IMGFRENTEDORSO varbinary(MAX) NULL,
	IMGIMPORTE varbinary(MAX) NULL,
	IMGFECHA varbinary(MAX) NULL,
	IMGORDENANTE varbinary(MAX) NULL,
	ASIENTO numeric(10,0) NULL,
	SUCURSAL numeric(10,0) NULL,
	FECHAPROCESO datetime NULL,
	ENPXWDOC varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	ORIGENIMAGEN varchar(20) COLLATE Modern_Spanish_CI_AS NULL,
	CONSTRAINT PK_ITF_COELSA_CLS_VID PRIMARY KEY (CMC7)
);')

Execute('CREATE TABLE dbo.ITF_COELSA_CLS_VIP (
	CMC7 varchar(200) COLLATE Modern_Spanish_CI_AS NOT NULL,
	FECHAALTA datetime NULL,
	TIPO varchar(1) COLLATE Modern_Spanish_CI_AS NOT NULL,
	IMGFRENTEDORSO varbinary(MAX) NULL,
	IMGIMPORTE varbinary(MAX) NULL,
	IMGFECHA varbinary(MAX) NULL,
	IMGORDENANTE varbinary(MAX) NULL,
	ASIENTO numeric(10,0) NULL,
	SUCURSAL numeric(10,0) NULL,
	FECHAPROCESO datetime NULL,
	ENPXWDOC varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	ORIGENIMAGEN varchar(20) COLLATE Modern_Spanish_CI_AS NULL,
	CONSTRAINT PK_ITF_COELSA_CLS_VIP PRIMARY KEY (CMC7)
);')

Execute('CREATE TABLE dbo.ITF_COELSA_CLS_CP0
(
	ID int IDENTITY(1,1) NOT NULL,
	ID_TICKET numeric(16,0) NULL,
	ID_PROCESO numeric(15,0) NULL,
	FECHAPROCESO date NULL,
	CODIGO_TRANSACCION numeric(2,0) NULL,
	ENTIDAD_DEBITAR numeric(8,0) NULL,
	CUENTA_DEBITAR numeric(17,0) NULL,
	IMPORTE numeric(15,2) NULL,
	CODIGO_POSTAL varchar(6) COLLATE Modern_Spanish_CI_AS NULL,
	FECHA_PRESENTADO date NULL,
	FECHA_VENCIMIENTO date NULL,
	NRO_CHEQUE numeric(15,0) NULL,
	PUNTO_INTERCAMBIO varchar(16) COLLATE Modern_Spanish_CI_AS NULL,
	TRACE_NUMBER numeric(15,0) NULL,
	ESTADO varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	TIPO varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	INFO_ADICIONAL varchar(2) COLLATE Modern_Spanish_CI_AS NULL,
	CONSTRAINT PK__ITF_COELSA_CLS_CP0 PRIMARY KEY (ID)
);')

Execute('CREATE TABLE dbo.ITF_COELSA_CLS_CP1
(
	ID int IDENTITY(1,1) NOT NULL,
	ID_TICKET numeric(16,0) NULL,
	ID_PROCESO numeric(15,0) NULL,
	FECHAPROCESO date NULL,
	CODIGO_TRANSACCION numeric(2,0) NULL,
	ENTIDAD_DEBITAR numeric(8,0) NULL,
	CUENTA_DEBITAR numeric(17,0) NULL,
	IMPORTE numeric(15,2) NULL,
	CODIGO_POSTAL varchar(6) COLLATE Modern_Spanish_CI_AS NULL,
	FECHA_PRESENTADO date NULL,
	FECHA_VENCIMIENTO date NULL,
	NRO_CHEQUE numeric(15,0) NULL,
	PUNTO_INTERCAMBIO varchar(16) COLLATE Modern_Spanish_CI_AS NULL,
	TRACE_NUMBER numeric(15,0) NULL,
	ESTADO varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	TIPO varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	INFO_ADICIONAL varchar(2) COLLATE Modern_Spanish_CI_AS NULL,
	CONSTRAINT PK__ITF_COELSA_CLS_CP1 PRIMARY KEY (ID)
);')

Execute('CREATE TABLE dbo.ITF_COELSA_CLS_VCD 
(
	ID int IDENTITY(1,1) NOT NULL,
	ID_TICKET numeric(16,0) NULL,
	ID_PROCESO numeric(15,0) NULL,
	FECHA_PROCESO date NULL,
	ESTADO varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	ID_REGISTRO numeric(1,0) NULL,
	BANCO_DEPOSITARIO numeric(3,0) NULL,
	BANCO_GIRADO numeric(3,0) NULL,
	SUCURSAL_GIRADA numeric(3,0) NULL,
	CODIGO_POSTAL numeric(4,0) NULL,
	NRO_CHEQUE numeric(8,0) NULL,
	NRO_CUENTA numeric(11,0) NULL,
	FECHA_PRESENTACION date NULL,
	FECHA_COMPENSACION date NULL,
	ESTADO_TRAN varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	NOMBRE_IMAGEN varchar(33) COLLATE Modern_Spanish_CI_AS NULL,
	CONSTRAINT PK_ITF_COELSA_CLS_VCD PRIMARY KEY (ID)
);')

Execute('CREATE TABLE dbo.ITF_COELSA_CLS_VCP 
(
	ID int IDENTITY(1,1) NOT NULL,
	ID_TICKET numeric(16,0) NULL,
	ID_PROCESO numeric(15,0) NULL,
	FECHA_PROCESO date NULL,
	ESTADO varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	ID_REGISTRO numeric(1,0) NULL,
	BANCO_DEPOSITARIO numeric(3,0) NULL,
	BANCO_GIRADO numeric(3,0) NULL,
	SUCURSAL_GIRADA numeric(3,0) NULL,
	CODIGO_POSTAL numeric(4,0) NULL,
	NRO_CHEQUE numeric(8,0) NULL,
	NRO_CUENTA numeric(11,0) NULL,
	FECHA_PRESENTACION date NULL,
	FECHA_COMPENSACION date NULL,
	ESTADO_TRAN varchar(1) COLLATE Modern_Spanish_CI_AS NULL,
	NOMBRE_IMAGEN varchar(33) COLLATE Modern_Spanish_CI_AS NULL,
	CONSTRAINT PK_ITF_COELSA_CLS_VCP PRIMARY KEY (ID)
);')

