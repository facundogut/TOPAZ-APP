EXECUTE('
IF OBJECT_ID (''dbo.VW_CANAL_CARGO_ESPECIFICO_2'') IS NOT NULL
	DROP VIEW dbo.VW_CANAL_CARGO_ESPECIFICO_2
')
EXECUTE('

CREATE VIEW VW_CANAL_CARGO_ESPECIFICO_2
				(ID_CABEZAL,
				ID_LINEA,
				CODIGO_BARRAS,
    			NRO_COMPROBANTE_CLIENTE,
				LETRA,
				PUNTO_VENTA,
				TOTAL_CARGO_ESPECIFICO)
AS



WITH cc2_filtered AS (
    SELECT *
    FROM CONV_PADRONES
    WHERE CONVENIO = (SELECT NUMERICO FROM PARAMETROSGENERALES WHERE CODIGO = 307)
      AND TZ_LOCK = 0
      AND (TOTAL_CARGO_ESPECIFICO > 0 OR TOTAL_CARGO_ESPECIFICO IS NOT NULL)
)
SELECT DISTINCT
    c.ID,
    d.ID_LINEA,
    d.CODIGO_BARRAS,
    cc2.NRO_COMPROBANTE_CLIENTE,
    cc2.LETRA,
    cc2.PUNTO_VENTA,
    cc2.TOTAL_CARGO_ESPECIFICO 
FROM REC_CAB_RECAUDOS_CANAL AS c WITH (NOLOCK)
INNER JOIN REC_DET_RECAUDOS_CANAL AS d WITH (NOLOCK)
    ON c.ID = d.ID_CABEZAL
    AND d.TZ_LOCK = 0
INNER JOIN cc2_filtered AS cc2
    ON (
        (CAST(cc2.NRO_COMPROBANTE_CLIENTE AS varchar) = SUBSTRING(d.CODIGO_BARRAS, 9, 8)
        AND cc2.LETRA = CASE WHEN SUBSTRING(d.CODIGO_BARRAS, 4, 1) = ''0'' THEN ''B'' 
                        WHEN SUBSTRING(D.CODIGO_BARRAS,4,1) = ''1'' THEN ''A'' ELSE ''Y'' END
        AND cc2.PUNTO_VENTA = SUBSTRING(d.CODIGO_BARRAS, 5, 4))
        OR
        (CAST(cc2.NRO_COMPROBANTE_CLIENTE AS varchar) = SUBSTRING(d.CODIGO_BARRAS, 11, 8)
        AND cc2.TIPO_COMPROBANTE = SUBSTRING(d.CODIGO_BARRAS, 4, 2)
        AND cc2.LETRA = CASE WHEN SUBSTRING(d.CODIGO_BARRAS, 6, 1) = ''0'' THEN ''B'' ELSE ''A'' END
        AND cc2.PUNTO_VENTA = SUBSTRING(d.CODIGO_BARRAS, 7, 4))
    )
INNER JOIN CONV_CONVENIOS_REC AS r WITH (NOLOCK)
    ON c.CONVENIO = r.Id_ConvRec
WHERE c.TZ_LOCK = 0
  AND r.Id_TpoConv = 18
  AND r.TZ_LOCK = 0
  AND r.Estado = ''A''
')