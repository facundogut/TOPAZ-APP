EXECUTE('
IF OBJECT_ID (''dbo.VW_ASISTENCIAS_DEUDA_NO_EXIGIBLE'') IS NOT NULL
	DROP VIEW dbo.VW_ASISTENCIAS_DEUDA_NO_EXIGIBLE
')

EXECUTE('
CREATE VIEW VW_ASISTENCIAS_DEUDA_NO_EXIGIBLE
AS
SELECT 
SALDO_JTS_OID,
SUM(CAPITAL_NO_EXIGIBLE) AS CAPITAL_NO_EXIGIBLE,
SUM(GASTOS) AS GASTOS,
ROUND(SUM(CAPITAL_NO_EXIGIBLE)+SUM(GASTOS),2) AS TOTAL_NO_EXIGIBLE
FROM (
SELECT 
		PP.SALDO_JTS_OID,
		PP.C2300 AS CUOTA,
		PP.C2309 AS CAPITAL_NO_EXIGIBLE,
		ISNULL((SELECT SUM(SALDO_GASTO) FROM GASTOS_POR_CUOTA WITH (NOLOCK) WHERE SALDOS_JTS_OID=PP.SALDO_JTS_OID AND NUMERO_CUOTA=PP.C2300
		 AND ( (tz_lock < 300000000000000 OR tz_lock >= 400000000000000) AND (tz_lock < 100000000000000 OR tz_lock >= 200000000000000)  )),0) AS GASTOS
FROM SALDOS S WITH (NOLOCK) 
INNER JOIN PLANPAGOS PP WITH (NOLOCK) ON S.JTS_OID=PP.SALDO_JTS_OID AND S.TZ_LOCK=0
WHERE  S.C1785 = 5 AND S.C1604<>0 
	AND (PP.C2301> (SELECT FECHAPROCESO FROM PARAMETROS WITH (NOLOCK))) 
	AND ((PP.TZ_LOCK < 300000000000000 OR PP.TZ_LOCK >= 400000000000000) AND (PP.TZ_LOCK < 100000000000000 OR PP.TZ_LOCK >= 200000000000000)  )
    AND ( (s.tz_lock < 300000000000000 OR s.tz_lock >= 400000000000000) AND (s.tz_lock < 100000000000000 OR s.tz_lock >= 200000000000000)  )
GROUP BY PP.SALDO_JTS_OID, PP.C2300,PP.C2309
) T
GROUP BY SALDO_JTS_OID
')
