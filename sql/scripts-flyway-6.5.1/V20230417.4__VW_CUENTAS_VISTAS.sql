EXECUTE('
CREATE OR ALTER VIEW VW_CUENTAS_VISTAS
(
CODIGO_SUCURSAL,
NUMERO_CUENTA,
MODULO,
NOMBRE_CUENTA,
CODIGO_MONEDA,
SALDO_CONTABLE,
SALDO_AL_INICIO,
SALDO_DISPONIBLE,
SALDO_INDISPONIBLE,
DISPONIBLE_ACUERDOS,
MARGEN_ACUERDOS,
FECHA_ULTIMO_MOVIMIENTO,
HORA_ULTIMO_MOVIMIENTO,
FECHA_APERTURA_CUENTA,
INTERESES_DEVENGADOS,
TASA_NOMINAL,
TASA_EFECTIVA,
FECHA_PRIMERA_CAPITALIZACION
) AS 



SELECT 
    sal.sucursal AS CODIGO_SUCURSAL,
    sal.CUENTA AS NUMERO_CUENTA,
    CASE WHEN sal.C1785 = 2 THEN ''CA'' ELSE ''CC'' END AS MODULO,
    cli.NOMBRECLIENTE AS NOMBRE_CUENTA,
    sal.MONEDA AS CODIGO_MONEDA,
    sal.C1604 AS SALDO_CONTABLE,
    saldia.SALDO_AL_CORTE AS SALDO_AL_INICIO,
    CAST((sal.C1604 + sal.C1683 + sal.C1605) AS NUMERIC(15,2)) AS SALDO_DISPONIBLE,
    CAST((sal.C1605 + sal.C2627 + sal.C50107) AS NUMERIC(15,2)) AS SALDO_INDISPONIBLE,
    sal.C1683 AS DISPONIBLE_ACUERDOS,
    CAST((CASE WHEN sal.C1604 < 0 THEN (sal.C1683 + sal.C1604) ELSE sal.C1683 END) AS NUMERIC(15,2)) AS MARGEN_ACUERDOS,
    convert(VARCHAR(8),sal.C1625,112)  AS FECHA_ULTIMO_MOVIMIENTO,
    CAST(replace(convert(VARCHAR(8),sal.C1625,108),'':'','''') AS VARCHAR(6))AS HORA_ULTIMO_MOVIMIENTO,
    convert(VARCHAR(8),sal.C1620,112) AS FECHA_APERTURA_CUENTA,
    CAST(sal.C1820 AS NUMERIC(15,2)) AS INTERESES_DEVENGADOS,
    CAST((tb.TASA + rt.DIFERENCIALTASABASE) AS NUMERIC(11,7)) AS TASA_NOMINAL,
    CAST((((POWER((1+((tb.TASA + rt.DIFERENCIALTASABASE) * 30) /  36500),(365/30)))-1)*100) AS NUMERIC(11,7)) AS TASA_EFECTIVA,
	convert(VARCHAR(8),mc.fechaproceso, 112) AS FECHA_PRIMERA_CAPITALIZACION
FROM 
    SALDOS AS sal WITH (nolock)
    INNER JOIN CLI_CLIENTES AS cli WITH (nolock) ON 
        cli.CODIGOCLIENTE = sal.c1803 
    INNER JOIN GRL_SALDOS_DIARIOS saldia WITH (nolock) ON 
        saldia.SALDOS_JTS_OID = sal.JTS_OID
        AND saldia.FECHA = (    SELECT MAX(FECHA) 
                        FROM GRL_SALDOS_DIARIOS 
                        WHERE SALDOS_JTS_OID = saldia.SALDOS_JTS_OID 
                            AND FECHA < = (SELECT FECHAPROCESO FROM PARAMETROS))
    INNER JOIN VTA_DEFINICION_VISTA AS dv WITH (nolock) ON 
        dv.SALDO_JTS_OID = sal.JTS_OID 
        OR (dv.PRODUCTO = sal.PRODUCTO 
            AND dv.MONEDA = sal.MONEDA 
            AND dv.GRUPO = sal.C1772
            AND dv.SALDO_JTS_OID = 0)
    INNER JOIN VTA_DEFINICION_TASAS AS dt WITH (nolock) ON 
        dt.CODIGORANGO = dv.CODIGORANGOPAGO 
        AND dt.FECHADESDE  <= (SELECT FECHAPROCESO FROM PARAMETROS) 
        AND dt.FECHADESDE = (    SELECT max(fechadesde) 
                                FROM VTA_DEFINICION_TASAS 
                                WHERE CODIGORANGO = dt.CODIGORANGO 
                                    AND FECHADESDE <= (SELECT FECHAPROCESO FROM PARAMETROS))
    INNER JOIN TASASBASE AS tb WITH (nolock) ON 
        tb.TIPOTASABASE = dt.CODIGOTASABASE 
        AND (SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK)) BETWEEN tb.VIGENCIADESDE AND tb.VIGENCIAHASTA
    INNER JOIN VTA_RANGOS_TASAS AS rt WITH (nolock) ON 
        rt.CODIGORANGO = dv.CODIGORANGOPAGO 
        AND rt.fechadesde <= (SELECT FECHAPROCESO FROM PARAMETROS (NOLOCK))
    LEFT JOIN MOVIMIENTOS_CONTABLES AS mc WITH (nolock) ON 
        mc.SALDO_JTS_OID = sal.JTS_OID
        AND mc.OPERACION IN (    SELECT VALOR 
                                FROM PARAMETROS_JTS 
                                WHERE FUNCIONALIDAD = ''INTERESESVISTA'' 
                                    AND PARAMETRO = ''OPERACION'')
        AND EXISTS (    SELECT 1 FROM ASIENTOS AS a WITH (nolock)
                        WHERE a.ASIENTO = mc.ASIENTO
                            AND a.SUCURSAL = mc.SUCURSAL
                            AND a.FECHAPROCESO = mc.FECHAPROCESO
                            AND a.ESTADO = 77
					)
	WHERE sal.C1785 IN (2,3);
')